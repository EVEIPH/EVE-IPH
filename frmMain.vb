' Main form for all processing
Imports System.Data.SQLite
Imports System.Globalization
Imports System.Threading
Imports System.IO
Imports System.Net
Imports GoogleAnalyticsClientDotNet

Public Class frmMain
    Inherits System.Windows.Forms.Form

    ' Update Prices Variables
    Private m_ControlsCollection As ControlsCollection
    Private SystemCheckBoxes() As CheckBox
    Private TechCheckBoxes() As CheckBox
    ' For saving the price type that was used in the download
    Private GroupPricesList As New List(Of GroupPriceType)
    Private GroupPriceTypetoFind As New GroupPriceType
    Private Class GroupPriceType
        Public PriceType As String
        Public ItemID As Long

        Public Sub New()
            PriceType = ""
            ItemID = 0
        End Sub
    End Class

    ' Datacores
    Private DCSkillCheckBoxes() As CheckBox
    Private DCSkillLabels() As Label
    Private DCSkillCombos() As ComboBox
    Private DCCorpCheckBoxes() As CheckBox
    Private DCCorpLabels() As Label
    Private DCCorpTextboxes() As TextBox

    ' Mining ore processing skills
    Private MineProcessingCheckBoxes() As CheckBox
    Private MineProcessingLabels() As Label
    Private MineProcessingCombos() As ComboBox

    ' Manufacturing
    Private CalcRelicCheckboxes() As CheckBox
    Private CalcDecryptorCheckBoxes() As CheckBox
    Private TypeIDToFind As Long ' For searching a price list

    ' Manufacturing Column stuff
    Private ColumnPositions(NumManufacturingTabColumns) As String ' For saving the column order
    Private AddingColumns As Boolean
    Private MovedColumn As Integer

    Private DCIPH_COLUMN As Integer ' The number of the DC IPH column for totalling up the price

    Private TechChecked As Boolean
    Private IgnoreRefresh As Boolean = False
    Private RunUpdatePriceList As Boolean = True ' If we want to run the price list update
    Private RefreshList As Boolean = True
    Private UpdateAllTechChecks As Boolean = True ' Whether to update all Tech checks in prices or not
    Private FirstShowMining As Boolean = True ' If we have clicked on the Mining tab yet to load initial data
    Private FirstShowDatacores As Boolean = True ' If we have clicked on the Datacores tab yet or not (only load initial data on first click)

    ' For fixing double-click / check box on listview item box
    Private inhibitAutoCheck As Boolean

    ' Blueprints Variables
    Private cmbBPsLoaded As Boolean

    ' BP List for Previous/Next
    Private BPHistory As New List(Of BPHistoryItem)

    ' For letting manual check/override of build/buy calculations
    Private IgnoreListViewItemChecks As Boolean

    Private BBItems As New List(Of BuildBuyItem) ' Just the list of itemid and preference for check
    Private BBItemtoFind As New Long

    Public Structure BPBBItem
        Dim BPID As Integer
        Dim BBItems As List(Of BuildBuyItem)
    End Structure

    Private Structure BPHistoryItem
        Dim BPID As Long
        Dim BPName As String
        Dim BuildType As String
        Dim Inputs As String
        Dim SentFrom As SentFromLocation
        Dim BuildFacility As IndustryFacility
        Dim ComponentFacility As IndustryFacility
        Dim CapComponentFacility As IndustryFacility
        Dim InventionFacility As IndustryFacility
        Dim CopyFacility As IndustryFacility
        Dim IncludeTaxes As Boolean
        Dim BrokerFeeData As BrokerFeeInfo
        Dim MEValue As String
        Dim TEValue As String
        Dim SentRuns As String
        Dim ManufacturingLines As String
        Dim LabLines As String
        Dim NumBPs As String
        Dim AddlCosts As String
        Dim PPU As Boolean
    End Structure

    Private CurrentBPHistoryIndex As Integer
    Private ResetBPTab As Boolean ' If we recalled the InitBP to enable all the stuff on the screen

    ' BP Combo processing
    Public ComboMenuDown As Boolean
    Public MouseWheelSelection As Boolean
    Public ComboBoxArrowKeys As Boolean
    Public BPSelected As Boolean
    Public BPComboKeyDown As Boolean

    ' Relics
    Private LoadingRelics As Boolean
    Private RelicsLoaded As Boolean

    ' Decryptors
    Private SelectedDecryptor As New Decryptor

    ' Invention
    Private UpdatingInventionChecks As Boolean

    Private LoadingInventionDecryptors As Boolean
    Private LoadingT3Decryptors As Boolean

    Private InventionDecryptorsLoaded As Boolean
    Private T3DecryptorsLoaded As Boolean

    ' If we are loading from history
    Private LoadingBPfromHistory As Boolean
    Private PreviousBPfromHistory As Boolean

    ' Updates for threading
    Public PriceHistoryUpdateCount As Integer
    Public PriceOrdersUpdateCount As Integer

    ' BP stats
    Private OwnedBP As Boolean

    ' For T2 BPOs mainly so we can load the stored ME/TE if it changes
    Private OwnedBPME As String
    Private OwnedBPPE As String

    Private UpdatingCheck As Boolean
    Private UpdatingStructureIDText As Boolean

    ' For checks that are enabled
    Private PriceCheckT1Enabled As Boolean
    Private PriceCheckT2Enabled As Boolean
    Private PriceCheckT3Enabled As Boolean
    Private PriceCheckT4Enabled As Boolean
    Private PriceCheckT5Enabled As Boolean
    Private PriceCheckT6Enabled As Boolean

    ' For updating several checks at once
    Private IgnoreSystemCheckUpdates As Boolean
    Private IgnoreRegionCheckUpdates As Boolean

    Private PriceToggleButtonHit As Boolean

    ' Total isk per hour selected on datacore grid
    Private TotalSelectedIPH As Double

    ' Loading the solar system combo on the price page
    Private FirstPriceShipTypesComboLoad As Boolean
    Private FirstPriceChargeTypesComboLoad As Boolean

    ' For loading the Manufacturing Grid
    Private FirstLoadCalcBPTypes As Boolean
    Private FirstManufacturingGridLoad As Boolean

    Private UserInventedBPs As New List(Of Long)  ' This is a list of all the BPs that the user will invent from owned T1s (Manufacturing Grid)

    ' For ignoring updates to the ship booster combo in mining
    Private UpdatingMiningShips As Boolean

    ' If we refresh the manufacturing data or recalcuate
    Private RefreshCalcData As Boolean

    ' Reload of Regions on Datacore class
    Private DCRegionsLoaded As Boolean

    ' Final list of items for manufacturing (keep form level so we can refresh it if needed)
    Private FinalManufacturingItemList As List(Of ManufacturingItem)
    Private ManufacturingRecordIDToFind As Long ' for Predicate
    Private ManufacturingNameToFind As String ' for Predicate

    ' For column sorting - What column did they click on to sort
    Private ManufacturingColumnClicked As Integer
    Private ManufacturingColumnSortType As SortOrder
    Private UpdatePricesColumnClicked As Integer
    Private UpdatePricesColumnSortType As SortOrder
    Private BPCompColumnClicked As Integer
    Private BPCompColumnSortType As SortOrder
    Private BPRawColumnClicked As Integer
    Private BPRawColumnSortType As SortOrder
    Private DCColumnClicked As Integer
    Private DCColumnSortType As SortOrder
    Private MiningColumnClicked As Integer
    Private MiningColumnSortType As SortOrder
    Private ReactionsColumnClicked As Integer
    Private ReactionsColumnSortType As SortOrder

    Private SelectedBPText As String = ""

    Private ProfitText As String
    Private ProfitPercentText As String

    Private DefaultSettings As New ProgramSettings ' For default constants

    Private ListIDIterator As Integer ' For setting a unique record id in the manufacturing tab
    Private ListRowFormats As New List(Of RowFormat) ' The lists of formats to use in drawing the manufacturing list

    Private SelectedBPTabIndex As Integer ' So we don't move around the different facility/invention/re tabs on the user

    ' Inline grid row update variables
    Private Structure SavedLoc
        Dim X As Integer
        Dim Y As Integer
    End Structure

    Private SavedListClickLoc As SavedLoc
    Private RefreshingGrid As Boolean

    Private CurrentRow As ListViewItem
    Private PreviousRow As ListViewItem
    Private NextRow As ListViewItem

    Private NextCellRow As ListViewItem
    Private PreviousCellRow As ListViewItem

    Private CurrentCell As ListViewItem.ListViewSubItem
    Private PreviousCell As ListViewItem.ListViewSubItem
    Private NextCell As ListViewItem.ListViewSubItem

    Private MEUpdate As Boolean
    Private PriceUpdate As Boolean
    Private DataUpdated As Boolean
    Private DataEntered As Boolean
    Private EnterKeyPressed As Boolean
    Private SelectedGrid As ListView

    Private PriceTypeUpdate As Boolean
    Private PriceSystemUpdate As Boolean
    Private PriceRegionUpdate As Boolean
    Private PriceModifierUpdate As Boolean
    Private PreviousPriceType As String
    Private PreviousRegion As String
    Private PreviousSystem As String
    Private PreviousPriceMod As String
    Private TabPressed As Boolean
    Private UpdatingCombo As Boolean

    Private PPSystemsLoaded As Boolean
    Private PPRegionsLoaded As Boolean
    Private PriceRegionsLoaded As Boolean
    Private PriceSystemsLoaded As Boolean
    Private PreviousPPRegion As String
    Private PreviousPriceRegion As String

    Private IgnoreFocus As Boolean
    Private IgnoreMarketFocus As Boolean

    ' Column width consts - may change depending on Ore, Ice or Gas so change the widths of the columns based on these and use them to add and move
    Private Const MineOreNameColumnWidth As Integer = 114
    Private Const MineRefineYieldColumnWidth As Integer = 70
    Private Const MineCrystalColumnWidth As Integer = 55
    Private Const PriceListHeaderCSV As String = "Group Name,Item Name,Price,Price Type,Raw Material,Type ID"
    Private Const PriceListHeaderTXT As String = "Group Name|Item Name|Price|Price Type|Raw Material|Type ID"
    Private Const PriceListHeaderSSV As String = "Group Name;Item Name;Price;Price Type;Raw Material;Type ID"

    Private Const JitaID As String = "30000142"
    Private Const PerimeterID As String = "30000144"

    Private UpdatePricesDataSource As String

#Region "Initialization Code"

    ' Set default window theme so tabs in invention window display correctly on all systems
    Public Declare Unicode Function SetWindowTheme Lib "uxtheme.dll" (ByVal hWnd As IntPtr,
        ByVal pszSubAppName As String, ByVal pszSubIdList As String) As Integer

    Public Sub New()

        MyBase.New()

        ErrorTracker = ""
        ESIErrorHandler = New ESIErrorProcessor()

        Dim ErrorData As ErrObject = Nothing
        Dim ESIData As New ESI

        ' Set developer flag
        If File.Exists("Developer.txt") Then
            Developer = True
        Else
            Developer = False
        End If

        ' Covert to new ESI registration system to use my registration and PKCE
        ' If they registered before, show a pop-up and require registration. Then delete the registration file
        Dim AppRegistrationFileName As String = Path.ChangeExtension(Path.Combine(DynamicFilePath, "", "AppRegistrationInformation"), ".xml")
        If File.Exists(AppRegistrationFileName) Then
            Dim f1 As New frmAppRegistrationNotice
            f1.ShowDialog()

            ' Now delete the registration file
            File.Delete(AppRegistrationFileName)

        End If

        ' Set test platform
        If File.Exists("Test.txt") Then
            TestingVersion = True
        Else
            TestingVersion = False
        End If

        Call SetProgress("Initializing...")

        Application.DoEvents()

        ' This call is required by the designer.
        InitializeComponent()

        FirstLoad = True

        ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12

        ' See if they've disabled GA tracking
        If Not UserApplicationSettings.DisableGATracking Then
            ' Use google analytics to track number of users using IPH (no user information passed except MAC address for Client ID)
            On Error Resume Next

            Dim GATracker As New AnalyticsService()
            Call GATracker.Initialize("UA-125827521-1", "EVE IPH", "EVE Isk per Hour", My.Application.Info.Version.ToString)

            Dim MACAddress As String = GetMacAddress() ' Use this for the Client ID
            Dim EventData As New ServiceModel.EventParameter

            EventData.Category = "Program Usage"
            EventData.Action = "Open IPH"
            EventData.Label = "Initialized"
            EventData.ClientId = HashSHA(MACAddress) ' Hash the MAC address for security

            Call GATracker.TrackEvent(EventData)

            On Error GoTo 0
        End If

        ' Always use US for now and don't take into account user overrided stuff like the system clock format
        LocalCulture = New CultureInfo("en-US", False)
        ' Sets the CurrentCulture 
        Thread.CurrentThread.CurrentCulture = LocalCulture

        ' Add any initialization after the InitializeComponent() call.

        ' Find out if we are running all in the current folder or with updates and the DB in the appdata folder
        If File.Exists(SQLiteDBFileName) Then
            ' Single folder that we are in, so set the path variables to it for updates
            DynamicFilePath = Path.GetDirectoryName(Application.ExecutablePath)
            DBFilePath = Path.GetDirectoryName(Application.ExecutablePath)
        Else
            ' They ran the installer (or we assume they did) and all the files are updated in the appdata/roaming folder
            ' Set where files will be updated
            DynamicFilePath = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData), DynamicAppDataPath)
            DBFilePath = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData), DynamicAppDataPath)
        End If

        ' Get the user settings then check for updates
        UserApplicationSettings = AllSettings.LoadApplicationSettings

        ' Check for program updates first
        If UserApplicationSettings.CheckforUpdatesonStart Then
            ' Check for program updates
            Application.UseWaitCursor = True
            Me.Activate()
            Call CheckForUpdates(False, Me.Icon)
            Application.UseWaitCursor = False
            Application.DoEvents()
        End If

        ' Initialize stuff
        Call SetProgress("Initializing Database...")
        Application.DoEvents()
        EVEDB = New DBConnection(DBFilePath, SQLiteDBFileName)

        ' For speed on ESI calls
        ServicePointManager.DefaultConnectionLimit = 20
        ServicePointManager.UseNagleAlgorithm = False
        ServicePointManager.Expect100Continue = False

        ' Load the user settings
        Call SetProgress("Loading User Settings...")
        UserBPTabSettings = AllSettings.LoadBPSettings
        UserUpdatePricesTabSettings = AllSettings.LoadUpdatePricesSettings
        UserManufacturingTabSettings = AllSettings.LoadManufacturingSettings
        UserDCTabSettings = AllSettings.LoadDatacoreSettings
        UserMiningTabSettings = AllSettings.LoadMiningSettings
        UserIndustryJobsColumnSettings = AllSettings.LoadIndustryJobsColumnSettings
        UserManufacturingTabColumnSettings = AllSettings.LoadManufacturingTabColumnSettings
        UserShoppingListSettings = AllSettings.LoadShoppingListSettings
        UserMHViewerSettings = AllSettings.LoadMarketHistoryViewerSettingsSettings
        UserBPViewerSettings = AllSettings.LoadBPViewerSettings
        UserUpwellStructureSettings = AllSettings.LoadUpwellStructureViewerSettings
        StructureBonusPopoutViewerSettings = AllSettings.LoadStructureBonusPopoutViewerSettings

        UserIndustryFlipBeltSettings = AllSettings.LoadIndustryFlipBeltColumnSettings
        UserIndustryFlipBeltOreCheckSettings1 = AllSettings.LoadIndustryBeltOreChecksSettings(BeltType.Small)
        UserIndustryFlipBeltOreCheckSettings2 = AllSettings.LoadIndustryBeltOreChecksSettings(BeltType.Medium)
        UserIndustryFlipBeltOreCheckSettings3 = AllSettings.LoadIndustryBeltOreChecksSettings(BeltType.Large)
        UserIndustryFlipBeltOreCheckSettings4 = AllSettings.LoadIndustryBeltOreChecksSettings(BeltType.Enormous)
        UserIndustryFlipBeltOreCheckSettings5 = AllSettings.LoadIndustryBeltOreChecksSettings(BeltType.Colossal)

        UserIceBeltFlipSettings = AllSettings.LoadIceFlipBeltColumnSettings
        UserIceBeltCheckSettings = AllSettings.LoadIceBeltOreChecksSettings

        UserAssetWindowManufacturingTabSettings = AllSettings.LoadAssetWindowSettings(AssetWindow.ManufacturingTab)
        UserAssetWindowShoppingListSettings = AllSettings.LoadAssetWindowSettings(AssetWindow.ShoppingList)
        UserAssetWindowRefinerySettings = AllSettings.LoadAssetWindowSettings(AssetWindow.Refinery)
        UserAssetWindowDefaultSettings = AllSettings.LoadAssetWindowSettings(AssetWindow.DefaultView)

        ' These will be used for all areas in the program - I may make specific to each reprocessing facility if requested, then will move to the manufacturing facility object
        UserConversiontoOreSettings = AllSettings.LoadConversiontoOreSettings()

        frmConversionOptions = New frmConversiontoOreSettings()

        ' Display to the user any issues with ESI endpoints
        Call SetProgress("Checking Status of ESI...")
        Call ESIData.GetESIStatus()
        If Not UserApplicationSettings.SupressESIStatusMessages Then
            Call DisplayESIStatusMessages()
        End If

        ' Load the default character data
        Call SetProgress("Loading Character Data from ESI...")
        Call LoadCharacter(UserApplicationSettings.LoadAssetsonStartup, UserApplicationSettings.LoadBPsonStartup)
        Call LoadCharacterNamesinMenu()

        ' Type of skills loaded
        Call UpdateSkillPanel()

        ' Update System Cost Indicies
        If UserApplicationSettings.LoadESISystemCostIndiciesDataonStartup Then
            Application.UseWaitCursor = True
            Call SetProgress("Updating Industry System Indicies...")
            Application.DoEvents()
            Call ESIData.UpdateIndustrySystemsCostIndex()
            Application.UseWaitCursor = False
            Application.DoEvents()
        End If

        DBCommand = Nothing

        ' ESI Market Data
        If UserApplicationSettings.LoadESIMarketDataonStartup Then
            Application.UseWaitCursor = True
            Application.DoEvents()
            Call SetProgress("Updating Avg/Adj Market Prices...")
            Call ESIData.UpdateAdjAvgMarketPrices()
            Application.UseWaitCursor = False
            Application.DoEvents()
        End If

        ' Refresh Public Structures
        If UserApplicationSettings.LoadESIPublicStructuresonStartup And SelectedCharacter.PublicStructuresAccess Then
            Application.UseWaitCursor = True
            Application.DoEvents()
            Call SetProgress("Updating Public Structures Data...")
            Call ESIData.UpdatePublicStructureswithMarkets()
            Application.UseWaitCursor = False
            Application.DoEvents()
        End If

        If TestingVersion Then
            Me.Text = Me.Text & " - Testing"
        End If

        If Developer Then
            Me.Text = Me.Text & " - Developer"
        Else
            ' Hide all the development stuff
            tabMain.TabPages.Remove(tabPI)
        End If

        ' Load all the forms' facilities
        Call LoadFacilities()

        ' Init Tool tips
        If UserApplicationSettings.ShowToolTips Then
            Me.ttBP = New ToolTip(Me.components)
            Me.ttBP.IsBalloon = True
        End If

        ' Nothing in shopping List
        pnlShoppingList.Text = "No Items in Shopping List"

        Call SetProgress("Finalizing Forms...")

        '****************************************
        '**** Blueprints Tab Initializations ****
        '****************************************
        ' Width is now 556, scrollbar is 21 
        'lstBPComponentMats.Columns.Add("", -2, HorizontalAlignment.Center) ' For check (25 size)
        lstBPComponentMats.Columns.Add("Material", 215, HorizontalAlignment.Left) 'added 25 temp
        lstBPComponentMats.Columns.Add("Quantity", 90, HorizontalAlignment.Right)
        lstBPComponentMats.Columns.Add("ME", 35, HorizontalAlignment.Center)
        lstBPComponentMats.Columns.Add("Cost Per Item", 90, HorizontalAlignment.Right)
        lstBPComponentMats.Columns.Add("Total Cost", 110, HorizontalAlignment.Right)

        ' Width is now 556, scrollbar is 21 
        'lstBPBuiltComponents.Columns.Add("", -2, HorizontalAlignment.Center) ' For check (25 size)
        lstBPBuiltComponents.Columns.Add("Material", 215, HorizontalAlignment.Left) 'added 25 temp
        lstBPBuiltComponents.Columns.Add("Quantity", 90, HorizontalAlignment.Right)
        lstBPBuiltComponents.Columns.Add("ME", 35, HorizontalAlignment.Center)
        lstBPBuiltComponents.Columns.Add("Excess Sell Cost", 90, HorizontalAlignment.Right)
        lstBPBuiltComponents.Columns.Add("Built Cost", 110, HorizontalAlignment.Right)

        ' No check for raw mats since the check will be used to toggle build/buy for each item
        lstBPRawMats.Columns.Add("Material", 215, HorizontalAlignment.Left)
        lstBPRawMats.Columns.Add("Quantity", 90, HorizontalAlignment.Right)
        lstBPRawMats.Columns.Add("ME", 35, HorizontalAlignment.Center)
        lstBPRawMats.Columns.Add("Cost Per Item", 90, HorizontalAlignment.Right)
        lstBPRawMats.Columns.Add("Total Cost", 110, HorizontalAlignment.Right)

        ' We haven't checked any tech levels yet
        TechChecked = False

        Call InitBPTab()

        Call InitInventionTab()

        ' Base Decryptor
        SelectedDecryptor.MEMod = 0
        SelectedDecryptor.TEMod = 0
        SelectedDecryptor.RunMod = 0
        SelectedDecryptor.ProductionMod = 1
        SelectedDecryptor.Name = None

        ' For the disabling of the price update form
        PriceCheckT1Enabled = True
        PriceCheckT2Enabled = True
        PriceCheckT3Enabled = True
        PriceCheckT4Enabled = True
        PriceCheckT5Enabled = True
        PriceCheckT6Enabled = True

        ' Tool Tips
        If UserApplicationSettings.ShowToolTips Then
            ttBP.SetToolTip(lblBPInventionCost, "Invention Cost for Runs entered = (Datacores + Decryptors) / Invented Runs * Runs (based on the probability of success)" & vbCrLf & "Double-Click for material list needed for enough successful BPCs for runs entered")
            ttBP.SetToolTip(lblBPRECost, "Invention Cost for Runs entered = (Datacores + Decryptors + Relics) / Invented Runs * Runs (based on the probability of success)" & vbCrLf & "Double-Click for material list needed for enough successful BPCs for runs entered")
            ttBP.SetToolTip(lblBPCopyCosts, "Total Cost of materials to make enough BPCs for the number of invention jobs needed" & vbCrLf & "Double-Click for material list needed for enough successful BPCs for runs entered")
            ttBP.SetToolTip(lblBPRuns, "Total number of items to produce. I.e. If you have 5 blueprints with 4 runs each, then enter 20")
            ttBP.SetToolTip(lblBPTaxes, "Sales Taxes to set up a sell order at an NPC Station")
            ttBP.SetToolTip(lblBPBrokerFees, "Broker's Fees to set up a sell order at an NPC Station")
            ttBP.SetToolTip(lblBPTotalCompCost, "Total Cost of Component Materials, InventionCosts, Usage, Taxes and Fees - Double Click for list of costs")
            ttBP.SetToolTip(lblBPRawTotalCost, "Total Cost of Raw Materials, InventionCosts, Usage, Taxes and Fees - Double Click for list of costs")
            ttBP.SetToolTip(lblBPPT, "This is the time to build the item (including skill and implant modifiers) from the blueprint after all materials are gathered")
            ttBP.SetToolTip(lblBPCPTPT, "This is the total time to build the item and components and if selected, time to complete invention and copying")
            ttBP.SetToolTip(lblBPCanMakeBP, "Double-Click here to see required skills to make this BP")
            ttBP.SetToolTip(lblBPCanMakeBPAll, "Double-Click here to see required skills to make all the items for this BP")
            ttBP.SetToolTip(lblBPT2InventStatus, "Double-Click here to see required skills to invent this BP")
            ttBP.SetToolTip(lblT3InventStatus, "Double-Click here to see required skills to invent this BP")
            ttBP.SetToolTip(chkBPPricePerUnit, "Show Price per Unit - All price data in this frame will be updated to show the prices for 1 unit")
            ttBP.SetToolTip(lblBPProductionTime, "Total time to build this blueprint with listed components")
            ttBP.SetToolTip(lblBPTotalItemPT, "Total time to build selected build components and this blueprint")
            ttBP.SetToolTip(lblBPComponentMats, "Total list of components, which can be built, and materials to build this blueprint")
            ttBP.SetToolTip(lblBPRawMats, "Total list of materials to build all components and base materials for this blueprint")
            ttBP.SetToolTip(lblBPDecryptorStats, "Selected Decryptor Stats and Runs per BPC")
            ttBP.SetToolTip(lblBPT3Stats, "Selected Decryptor Stats and Runs per BPC")
            ttBP.SetToolTip(lblBPSimpleCopy, "When checked, this will copy the list into a format that will work with Multi-Buy when pressing the Copy button.")
            ttBP.SetToolTip(lblBPRawProfit, "Double-Click to toggle value between Profit and Profit Percent")
            ttBP.SetToolTip(lblBPCompProfit, "Double-Click to toggle value between Profit and Profit Percent")
        End If

        '*******************************************
        '**** Update Prices Tab Initializations ****
        '*******************************************
        ' Create the controls collection class
        m_ControlsCollection = New ControlsCollection(Me)
        ' Get Region check boxes (note index starts at 1)
        TechCheckBoxes = DirectCast(ControlArrayUtils.getControlArray(Me, Me.MyControls, "chkPricesT"), CheckBox())
        SystemCheckBoxes = DirectCast(ControlArrayUtils.getControlArray(Me, Me.MyControls, "chkSystems"), CheckBox())

        ' Columns of Update Prices Listview (width = 639) + 21 for scroll = 660
        lstPricesView.Columns.Add("TypeID", 0, HorizontalAlignment.Left) ' Hidden
        lstPricesView.Columns.Add("Group", 220, HorizontalAlignment.Left)
        lstPricesView.Columns.Add("Item", 319, HorizontalAlignment.Left)
        lstPricesView.Columns.Add("Price", 100, HorizontalAlignment.Right)
        lstPricesView.Columns.Add("Manufacture", 0, HorizontalAlignment.Right) ' Hidden
        lstPricesView.Columns.Add("Market ID", 0, HorizontalAlignment.Right) ' Hidden
        lstPricesView.Columns.Add("Price Type", 0, HorizontalAlignment.Right) ' Hidden

        ' Columns of update prices raw mats in price profiles - width= 443
        lstRawPriceProfile.Columns.Add("Group", 136, HorizontalAlignment.Left)
        lstRawPriceProfile.Columns.Add("Price Type", 74, HorizontalAlignment.Left)
        lstRawPriceProfile.Columns.Add("Region", 92, HorizontalAlignment.Left) ' 119 is to fit all regions
        lstRawPriceProfile.Columns.Add("Solar System", 73, HorizontalAlignment.Left) ' 104 is to fit all systems
        lstRawPriceProfile.Columns.Add("PMod", 41, HorizontalAlignment.Right) 'Hidden

        ' Columns of update prices manufactured mats in price profiles
        lstManufacturedPriceProfile.Columns.Add("Group", 136, HorizontalAlignment.Left)
        lstManufacturedPriceProfile.Columns.Add("Price Type", 74, HorizontalAlignment.Left)
        lstManufacturedPriceProfile.Columns.Add("Region", 92, HorizontalAlignment.Left) ' 119 is to fit all regions
        lstManufacturedPriceProfile.Columns.Add("Solar System", 73, HorizontalAlignment.Left) ' 104 is to fit all systems
        lstManufacturedPriceProfile.Columns.Add("PMod", 41, HorizontalAlignment.Right) ' Hidden

        ' If they don't have access to the correct scopes for structures, then don't enable the structure ID look up option
        If Not SelectedCharacter.StructureMarketsAccess And Not SelectedCharacter.PublicStructuresAccess Then
            btnAddStructureIDs.Enabled = False
            btnViewSavedStructures.Enabled = False
        Else
            btnAddStructureIDs.Enabled = True
            btnViewSavedStructures.Enabled = True
        End If

        ' Tool Tips
        If UserApplicationSettings.ShowToolTips Then
            ttUpdatePrices.SetToolTip(cmbRawMatsSplitPrices, "Buy = Use Buy orders only" & vbCrLf &
                                                            "Sell = Use Sell orders only" & vbCrLf &
                                                            "Buy & Sell = Use All orders" & vbCrLf &
                                                            "Min = Minimum" & vbCrLf &
                                                            "Max = Maximum" & vbCrLf &
                                                            "Avg = Average" & vbCrLf &
                                                            "Med = Median" & vbCrLf &
                                                            "Percentile = 5% of the top prices (Buy) or bottom (Sell, All) ")
            ttUpdatePrices.SetToolTip(cmbItemsSplitPrices, "Buy = Use Buy orders only" & vbCrLf &
                                                            "Sell = Use Sell orders only" & vbCrLf &
                                                            "Buy & Sell = Use All orders" & vbCrLf &
                                                            "Min = Minimum" & vbCrLf &
                                                            "Max = Maximum" & vbCrLf &
                                                            "Avg = Average" & vbCrLf &
                                                            "Med = Median" & vbCrLf &
                                                            "Percentile = 5% of the top prices (Buy) or bottom (Sell, All) ")
            ttUpdatePrices.SetToolTip(btnAddStructureIDs, "Use to add structures you have access to using with markets for downloading prices from structures.")
        End If

        FirstPriceChargeTypesComboLoad = True
        FirstPriceShipTypesComboLoad = True
        IgnoreSystemCheckUpdates = False

        PriceTypeUpdate = False
        PriceSystemUpdate = False
        PriceRegionUpdate = False
        PriceModifierUpdate = False
        PreviousPriceType = ""
        PreviousRegion = ""
        PreviousSystem = ""
        PreviousPriceMod = ""
        TabPressed = False
        UpdatingCombo = False

        PPSystemsLoaded = False
        PPRegionsLoaded = False

        PriceHistoryUpdateCount = 0
        PriceOrdersUpdateCount = 0
        CancelUpdatePrices = False
        CancelManufacturingTabCalc = False
        CancelThreading = False

        Call InitUpdatePricesTab()

        '****************************************
        '**** Manufacturing Tab Initializations ****
        '****************************************
        CalcRelicCheckboxes = DirectCast(ControlArrayUtils.getControlArray(Me, Me.MyControls, "chkCalcRERelic"), CheckBox())
        CalcDecryptorCheckBoxes = DirectCast(ControlArrayUtils.getControlArray(Me, Me.MyControls, "chkCalcDecryptor"), CheckBox())

        ' Add the columns based on settings
        Call RefreshManufacturingTabColumns()

        If UserApplicationSettings.ShowToolTips Then
            ' Decryptor Tool tips
            ttUpdatePrices.SetToolTip(chkCalcDecryptor2, "Augmentation - (PM: 0.6, Runs: +9, ME: -2, TE: +1)")
            ttUpdatePrices.SetToolTip(chkCalcDecryptor3, "Optimized Augmentation - (PM: 0.9, Runs: +7, ME +2 TE: 0)")
            ttUpdatePrices.SetToolTip(chkCalcDecryptor4, "Symmetry - (PM: 1.0, Runs: +2, ME: +1, TE: +4)")
            ttUpdatePrices.SetToolTip(chkCalcDecryptor5, "Process - (PM: 1.1, Runs: 0, ME: +3, TE: +3)")
            ttUpdatePrices.SetToolTip(chkCalcDecryptor6, "Accelerant - (PM: 1.2, Runs: +1, ME: +2, TE: +5)")
            ttUpdatePrices.SetToolTip(chkCalcDecryptor7, "Parity - (PM: 1.5, Runs: +3, ME: +1, TE: -1)")
            ttUpdatePrices.SetToolTip(chkCalcDecryptor8, "Attainment - (PM: 1.8, Runs: +4, ME: -1, TE: +2)")
            ttUpdatePrices.SetToolTip(chkCalcDecryptor9, "Optimized Attainment - (PM: 1.9, Runs: +2, ME: +1, TE: -1)")

            ttUpdatePrices.SetToolTip(txtCalcProdLines, "Will assume Number of BPs is same as Number of Production lines for Calculations")
            ttUpdatePrices.SetToolTip(chkCalcTaxes, "Sales Taxes to set up a sell order at an NPC Station for the Item")
            ttUpdatePrices.SetToolTip(chkCalcFees, "Broker's Fees to set up a sell order at an NPC Station for the Item")

            ttUpdatePrices.SetToolTip(txtCalcProdLines, "Enter the number of Manufacturing Lines you have to build items per day for calculations. Calculations will assume the same number of BPs used." & vbCrLf & "Calculations for components will also use this value. Double-Click to enter max runs for this character.")
            ttUpdatePrices.SetToolTip(txtCalcLabLines, "Enter the number of Laboratory Lines you have to invent per day for calculations. Double-Click to enter max runs for this character.")

            ttUpdatePrices.SetToolTip(txtCalcSVRThreshold, "No results with an SVR lower than the number entered will be returned.")

        End If
        FirstLoadCalcBPTypes = True
        FirstManufacturingGridLoad = True

        ' If there is an error in price updates, only show once
        ShownPriceUpdateError = False

        UpdatingStructureIDText = False

        Call InitManufacturingTab()

        '****************************************
        '**** Datacores Tab Initializations *****
        '****************************************
        DCSkillCheckBoxes = DirectCast(ControlArrayUtils.getControlArray(Me, Me.MyControls, "chkDC"), CheckBox())
        DCSkillLabels = DirectCast(ControlArrayUtils.getControlArray(Me, Me.MyControls, "lblDatacore"), Label())
        DCSkillCombos = DirectCast(ControlArrayUtils.getControlArray(Me, Me.MyControls, "cmbDCSkillLevel"), ComboBox())
        DCCorpCheckBoxes = DirectCast(ControlArrayUtils.getControlArray(Me, Me.MyControls, "chkDCCorp"), CheckBox())
        DCCorpLabels = DirectCast(ControlArrayUtils.getControlArray(Me, Me.MyControls, "lblDCCorp"), Label())
        DCCorpTextboxes = DirectCast(ControlArrayUtils.getControlArray(Me, Me.MyControls, "txtDCStanding"), TextBox())

        FirstShowDatacores = True
        DCRegionsLoaded = False
        rbtnDCUpdatedPrices.Checked = True
        TotalSelectedIPH = 0

        txtDCTotalOptIPH.Text = "0.00"
        txtDCTotalSelectedIPH.Text = "0.00"

        ' Width 1124, 21 for scrollbar, 25 for check
        lstDC.Columns.Add("", -2, HorizontalAlignment.Center) ' For check
        lstDC.Columns.Add("Corporation", 120, HorizontalAlignment.Left)
        lstDC.Columns.Add("Agent", 152, HorizontalAlignment.Left)
        lstDC.Columns.Add("LVL", 40, HorizontalAlignment.Center)
        lstDC.Columns.Add("Standing", 60, HorizontalAlignment.Right)
        lstDC.Columns.Add("Location", 250, HorizontalAlignment.Left) ' System name and security (station name?)
        lstDC.Columns.Add("DataCore Skill", 166, HorizontalAlignment.Left)
        lstDC.Columns.Add("DataCore Price", 88, HorizontalAlignment.Right)
        lstDC.Columns.Add("Price From", 65, HorizontalAlignment.Center) ' Load with system name, region, or multiple
        lstDC.Columns.Add("Core/Day", 62, HorizontalAlignment.Right)
        lstDC.Columns.Add("Isk per Hour", 75, HorizontalAlignment.Right)
        DCIPH_COLUMN = 10 ' For totaling up the price

        If UserApplicationSettings.ShowToolTips Then
            ttDatacores.SetToolTip(rbtnDCSystemPrices, "Max Buy Order from System used for Datacore Price")
            ttDatacores.SetToolTip(rbtnDCRegionPrices, "Max Buy Order from Region used for Datacore Price")
            ttDatacores.SetToolTip(lblDCGreenBackColor, "Green Background: Max IPH Agent")
            ttDatacores.SetToolTip(lblDCBlueText, "Blue Text: Current Research Agents")
            ttDatacores.SetToolTip(lblDCGrayText, "Gray Text: Unavailable Research Agent")
            ttDatacores.SetToolTip(lblDCOrangeText, "Orange Text: Research Agent is in Low Sec")
            ttDatacores.SetToolTip(lblDCRedText, "Red Text: Research Agent is in Null Sec")
        End If

        '****************************************
        '**** Mining Tab Initializations ********
        '****************************************
        ' Width 700, 21 for scrollbar - 679 total space
        lstMineGrid.Columns.Add("Ore ID", 0, HorizontalAlignment.Right) ' Hidden
        lstMineGrid.Columns.Add("Ore Name", MineOreNameColumnWidth, HorizontalAlignment.Left)
        lstMineGrid.Columns.Add("Refine Type", 70, HorizontalAlignment.Left)
        lstMineGrid.Columns.Add("Unit Price", 67, HorizontalAlignment.Right)
        lstMineGrid.Columns.Add("Refine Yield", MineRefineYieldColumnWidth, HorizontalAlignment.Center)
        lstMineGrid.Columns.Add("Crystal", MineCrystalColumnWidth, HorizontalAlignment.Left)
        ' lstMineGrid.Columns.Add("m3/Cycle", 60, HorizontalAlignment.Right)
        lstMineGrid.Columns.Add("RP", 47, HorizontalAlignment.Right)
        lstMineGrid.Columns.Add("RV", 27, HorizontalAlignment.Right)
        lstMineGrid.Columns.Add("Drone yield", 65, HorizontalAlignment.Right)
        lstMineGrid.Columns.Add("Units/Hour", 64, HorizontalAlignment.Right)
        lstMineGrid.Columns.Add("Isk per Hour", 100, HorizontalAlignment.Right)
        lstMineGrid.Columns.Add("CycleTime", 0, HorizontalAlignment.Right) ' Hidden

        MineProcessingCheckBoxes = DirectCast(ControlArrayUtils.getControlArray(Me, Me.MyControls, "chkOreProcessing"), CheckBox())
        MineProcessingLabels = DirectCast(ControlArrayUtils.getControlArray(Me, Me.MyControls, "lblOreProcessing"), Label())
        MineProcessingCombos = DirectCast(ControlArrayUtils.getControlArray(Me, Me.MyControls, "cmbOreProcessing"), ComboBox())

        Call InitMiningTab()

        ' Tool Tips
        If UserApplicationSettings.ShowToolTips Then
            ttMining.SetToolTip(chkMineT2Crystals, "Use T2 Crystals when skills and equipment allow")
            ttMining.SetToolTip(gbMineHauling, "If no hauling, results will take into account Round Trip time to the station based on M3 of Ship and fill times")
            ttMining.SetToolTip(btnMineSaveAllSettings, "Saves all current options on Mining Screen")
            ttMining.SetToolTip(chkMineForemanLaserOpBoost, "Click to cycle through No Booster, T1 or T2")
            ttMining.SetToolTip(chkMineForemanLaserRangeBoost, "Click to cycle through No Booster, T1 or T2")
            ttMining.SetToolTip(cmbMineIndustReconfig, "Select skill level to include Heavy Water costs per hour, set to 0 to ignore")
            ttMining.SetToolTip(chkMineIndyCoreDeployedMode, "To include Heavy Water costs for deployed mode, select Industrial Reconfiguration skill other than 0")
            ttMining.SetToolTip(lblMineExhumers, "For Prospect Mining Frigate, use the Exhumers Combobox to set the Expedition Frigate skill level.")
            ttMining.SetToolTip(chkMineBoosterDroneRig1, "Check again for T2 Links")
            ttMining.SetToolTip(chkMineBoosterDroneRig2, "Check again for T2 Links")
            ttMining.SetToolTip(chkMineBoosterDroneRig3, "Check again for T2 Links")
            ttMining.SetToolTip(chkMineForemanLaserRangeBoost, "Check again For T2 Links")
            ttMining.SetToolTip(chkMineForemanLaserOpBoost, "Check again For T2 Links")
        End If

        '****************************************
        '**** All Tabs **************************
        '****************************************

        ' For indy jobs viewer
        FirstIndustryJobsViewerLoad = True

        ' For handling click events
        UpdatingCheck = False

        ReprocessingPlantOpen = False
        OreBeltFlipOpen = False
        IceBeltFlipOpen = False

        ' All set, we are done loading
        FirstLoad = False

        ' Refresh the refining rates on the mining tab now that it's loaded
        Call RefreshMiningTabRefiningRates()

    End Sub

    Protected Overrides Sub Finalize()
        Application.DoEvents()
        MyBase.Finalize()
        On Error Resume Next
        EVEDB.CloseDB()
        On Error GoTo 0
    End Sub

    Private Sub frmMain_FormClosing(sender As Object, e As FormClosingEventArgs) Handles MyBase.FormClosing
        Application.DoEvents()

        If ShowSupportSplash() Then
            Dim f1 As New frmsupportSplash
            f1.ShowDialog()
        End If
    End Sub

    ' If the text file is there, read the counter in it. Only show the splash on the first run and after every 100 uses
    Private Function ShowSupportSplash() As Boolean
        Dim ReturnValue As Boolean = True

        Try
            Dim FilePath As String = Path.Combine(DynamicFilePath, "SupportCounter.txt")

            If File.Exists(FilePath) Then
                ' See what the count is
                Dim fileReader As String
                fileReader = My.Computer.FileSystem.ReadAllText(FilePath)

                Dim Counter As Integer

                If fileReader <> "" Then
                    Counter = CInt(fileReader) + 1
                Else
                    Counter = 1
                End If

                ' If the counter divides evenly by 100, show the form
                If Counter Mod 100 <> 0 Then
                    ReturnValue = False
                End If

                ' Always increment counter
                Call File.Delete(FilePath)
                Call File.Create(FilePath).Dispose()
                Dim tfile As StreamWriter
                tfile = My.Computer.FileSystem.OpenTextFileWriter(FilePath, True)
                tfile.WriteLine(CStr(Counter))
                tfile.Close()

            Else
                ' Make the file for counting
                Call File.Create(FilePath).Dispose()
                Dim objWriter As New StreamWriter(FilePath)
                objWriter.Write("1")
                objWriter.Close()
            End If

        Catch ex As Exception
            ReturnValue = False
        End Try

        Return ReturnValue

    End Function

    Public ReadOnly Property MyControls() As Collection
        Get
            Return m_ControlsCollection.Controls
        End Get
    End Property

    ' Loads up the facilities for the selected character
    Public Sub LoadFacilities(Optional FacilityLocation As ProgramLocation = Nothing, Optional FacilityType As ProductionType = ProductionType.None)

        ' See what ID we use for the facilities
        Dim CharID As Long = 0
        If UserApplicationSettings.SaveFacilitiesbyChar Then
            ' Use the ID sent
            CharID = SelectedCharacter.ID
        Else
            CharID = CommonLoadBPsID
        End If

        If FacilityType = ProductionType.None Then
            ' Initialize the BP facility
            Call BPTabFacility.InitializeControl(CharID, ProgramLocation.BlueprintTab, ProductionType.Manufacturing, Me)

            ' Load up the Manufacturing tab facilities
            Call CalcBaseFacility.InitializeControl(CharID, ProgramLocation.ManufacturingTab, ProductionType.Manufacturing, Me)
            Call CalcInventionFacility.InitializeControl(CharID, ProgramLocation.ManufacturingTab, ProductionType.Invention, Me)
            Call CalcT3InventionFacility.InitializeControl(CharID, ProgramLocation.ManufacturingTab, ProductionType.T3Invention, Me)
            Call CalcCopyFacility.InitializeControl(CharID, ProgramLocation.ManufacturingTab, ProductionType.Copying, Me)
            Call CalcSupersFacility.InitializeControl(CharID, ProgramLocation.ManufacturingTab, ProductionType.SuperManufacturing, Me)
            Call CalcCapitalsFacility.InitializeControl(CharID, ProgramLocation.ManufacturingTab, ProductionType.CapitalManufacturing, Me)
            Call CalcSubsystemsFacility.InitializeControl(CharID, ProgramLocation.ManufacturingTab, ProductionType.SubsystemManufacturing, Me)
            Call CalcReactionsFacility.InitializeControl(CharID, ProgramLocation.ManufacturingTab, ProductionType.Reactions, Me)
            Call CalcBoostersFacility.InitializeControl(CharID, ProgramLocation.ManufacturingTab, ProductionType.BoosterManufacturing, Me)

            ' Two facilities with check options - load the one they save
            If UserManufacturingTabSettings.CheckCapitalComponentsFacility Then
                Call CalcComponentsFacility.InitializeControl(CharID, ProgramLocation.ManufacturingTab, ProductionType.CapitalComponentManufacturing, Me)
            Else
                Call CalcComponentsFacility.InitializeControl(CharID, ProgramLocation.ManufacturingTab, ProductionType.ComponentManufacturing, Me)
            End If

            If UserManufacturingTabSettings.CheckT3DestroyerFacility Then
                Call CalcT3ShipsFacility.InitializeControl(CharID, ProgramLocation.ManufacturingTab, ProductionType.T3DestroyerManufacturing, Me)
            Else
                Call CalcT3ShipsFacility.InitializeControl(CharID, ProgramLocation.ManufacturingTab, ProductionType.T3CruiserManufacturing, Me)
            End If

            ' Load the mining tab refinery
            Call MineRefineFacility.InitializeControl(CharID, ProgramLocation.MiningTab, ProductionType.Reprocessing, Me)

        Else ' Multi-save
            ' Need to see what facility to reload
            Dim SavedPT As ProductionType

            ' They saved a facility on the manufacturing tab, so init all the facilities on the bp tab and reload the current facility
            If FacilityLocation = ProgramLocation.BlueprintTab Then
                ' Get the current facility that's viewed
                SavedPT = BPTabFacility.GetSelectedFacility.FacilityProductionType
                ' Just reload all the facilities
                Call BPTabFacility.InitializeFacilities(FacilityLocation)
                ' Now reload the one that was shown
                'Call BPTabFacility.InitializeControl(CharID, FacilityLocation, SavedPT, Me)
            ElseIf FacilityLocation = ProgramLocation.MiningTab Then
                ' Load the mining tab refinery
                Call MineRefineFacility.InitializeFacilities(FacilityLocation)
            Else
                ' Init the manufacturing tab facilities
                Select Case FacilityType
                    Case ProductionType.BoosterManufacturing
                        Call CalcBoostersFacility.InitializeFacilities(FacilityLocation)
                    Case ProductionType.CapitalComponentManufacturing
                        Call CalcComponentsFacility.InitializeFacilities(FacilityLocation)
                    Case ProductionType.CapitalManufacturing
                        Call CalcCapitalsFacility.InitializeFacilities(FacilityLocation)
                    Case ProductionType.ComponentManufacturing
                        Call CalcComponentsFacility.InitializeFacilities(FacilityLocation)
                    Case ProductionType.Copying
                        Call CalcCopyFacility.InitializeFacilities(FacilityLocation)
                    Case ProductionType.Invention
                        Call CalcInventionFacility.InitializeFacilities(FacilityLocation)
                    Case ProductionType.Manufacturing
                        Call CalcBaseFacility.InitializeFacilities(FacilityLocation)
                    Case ProductionType.Reactions
                        Call CalcReactionsFacility.InitializeFacilities(FacilityLocation)
                    Case ProductionType.SubsystemManufacturing
                        Call CalcSubsystemsFacility.InitializeFacilities(FacilityLocation)
                    Case ProductionType.SuperManufacturing
                        Call CalcSupersFacility.InitializeFacilities(FacilityLocation)
                    Case ProductionType.T3CruiserManufacturing
                        Call CalcT3ShipsFacility.InitializeFacilities(FacilityLocation)
                    Case ProductionType.T3DestroyerManufacturing
                        Call CalcT3ShipsFacility.InitializeFacilities(FacilityLocation)
                    Case ProductionType.T3Invention
                        Call CalcT3InventionFacility.InitializeFacilities(FacilityLocation)
                End Select
            End If
        End If

    End Sub

    ' Checks the status of ESI since last updated and displays any messageboxes on yellow or red endpoints
    Private Sub DisplayESIStatusMessages()
        Dim SQL As String = ""
        Dim rsStatus As SQLiteDataReader

        Dim CharacterTokenData As SavedTokenData = SelectedCharacter.CharacterTokenData

        SQL = "SELECT scope, status, purpose FROM ESI_STATUS_ITEMS, ESI_ENDPOINT_ROUTE_TO_SCOPE WHERE route = endpoint_route"
        DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
        rsStatus = DBCommand.ExecuteReader

        While rsStatus.Read
            ' Read through each status and show only those that they have scopes for
            With CharacterTokenData.Scopes
                ' Required
                If rsStatus.GetString(0) = ESI.ESICharacterSkillsScope And rsStatus.GetString(1) <> "green" Then
                    Call DisplayESIStatusMessage(rsStatus.GetString(1), rsStatus.GetString(0), rsStatus.GetString(2))
                End If

                ' Personal Scopes
                If .Contains(ESI.ESICharacterIndustryJobsScope) And rsStatus.GetString(0) = ESI.ESICharacterIndustryJobsScope And rsStatus.GetString(1) <> "green" Then
                    Call DisplayESIStatusMessage(rsStatus.GetString(1), rsStatus.GetString(0), rsStatus.GetString(2))
                End If

                If .Contains(ESI.ESICharacterStandingsScope) And rsStatus.GetString(0) = ESI.ESICharacterStandingsScope And rsStatus.GetString(1) <> "green" Then
                    Call DisplayESIStatusMessage(rsStatus.GetString(1), rsStatus.GetString(0), rsStatus.GetString(2))
                End If

                If .Contains(ESI.ESICharacterResearchAgentsScope) And rsStatus.GetString(0) = ESI.ESICharacterResearchAgentsScope And rsStatus.GetString(1) <> "green" Then
                    Call DisplayESIStatusMessage(rsStatus.GetString(1), rsStatus.GetString(0), rsStatus.GetString(2))
                End If

                If .Contains(ESI.ESICharacterBlueprintsScope) And rsStatus.GetString(0) = ESI.ESICharacterBlueprintsScope And rsStatus.GetString(1) <> "green" Then
                    Call DisplayESIStatusMessage(rsStatus.GetString(1), rsStatus.GetString(0), rsStatus.GetString(2))
                End If

                If .Contains(ESI.ESICharacterAssetScope) And rsStatus.GetString(0) = ESI.ESICharacterAssetScope And rsStatus.GetString(1) <> "green" Then
                    Call DisplayESIStatusMessage(rsStatus.GetString(1), rsStatus.GetString(0), rsStatus.GetString(2))
                End If

                ' Corporation scopes
                If .Contains(ESI.ESICorporationMembership) And rsStatus.GetString(0) = ESI.ESICorporationMembership And rsStatus.GetString(1) <> "green" Then
                    Call DisplayESIStatusMessage(rsStatus.GetString(1), rsStatus.GetString(0), rsStatus.GetString(2))
                End If

                If .Contains(ESI.ESICorporationIndustryJobsScope) And rsStatus.GetString(0) = ESI.ESICorporationIndustryJobsScope And rsStatus.GetString(1) <> "green" Then
                    Call DisplayESIStatusMessage(rsStatus.GetString(1), rsStatus.GetString(0), rsStatus.GetString(2))
                End If

                If .Contains(ESI.ESICorporationBlueprintsScope) And rsStatus.GetString(0) = ESI.ESICorporationBlueprintsScope And rsStatus.GetString(1) <> "green" Then
                    Call DisplayESIStatusMessage(rsStatus.GetString(1), rsStatus.GetString(0), rsStatus.GetString(2))
                End If

                If .Contains(ESI.ESICorporationAssetScope) And rsStatus.GetString(0) = ESI.ESICorporationAssetScope And rsStatus.GetString(1) <> "green" Then
                    Call DisplayESIStatusMessage(rsStatus.GetString(1), rsStatus.GetString(0), rsStatus.GetString(2))
                End If

                ' Structures
                If .Contains(ESI.ESIUniverseStructuresScope) And rsStatus.GetString(0) = ESI.ESIUniverseStructuresScope And rsStatus.GetString(1) <> "green" Then
                    Call DisplayESIStatusMessage(rsStatus.GetString(1), rsStatus.GetString(0), rsStatus.GetString(2))
                End If

                If .Contains(ESI.ESIStructureMarketsScope) And rsStatus.GetString(0) = ESI.ESIStructureMarketsScope And rsStatus.GetString(1) <> "green" Then
                    Call DisplayESIStatusMessage(rsStatus.GetString(1), rsStatus.GetString(0), rsStatus.GetString(2))
                End If
            End With

        End While

        rsStatus.Close()

    End Sub

    Private Sub DisplayESIStatusMessage(Status As String, Scope As String, Purpose As String)
        Select Case Status
            Case "yellow"
                MsgBox("ESI Is experincing issues with the " & Scope & " scope " & Purpose & " And you may Not have access to certain data until fixed.")
            Case "red"
                MsgBox("The " & Scope & " ESI scope Is down And will Not be able to " & Purpose & ". You may Not have access to certain data until fixed.")
            Case Else
                Application.DoEvents()
        End Select
    End Sub

#End Region

#Region "Form Functions/Procedures"

#Region "Tool Tip Processing"
    ' Datacore Tab
    Private Sub lblDCGreenBackColor_MouseEnter(sender As System.Object, e As System.EventArgs) Handles lblDCGreenBackColor.MouseEnter
        If UserApplicationSettings.ShowToolTips Then
            ttBP.SetToolTip(lblDCGreenBackColor, "Green Background: Max IPH Agent")
        End If
    End Sub

    Private Sub lblDCBlueText_MouseEnter(sender As System.Object, e As System.EventArgs) Handles lblDCBlueText.MouseEnter
        If UserApplicationSettings.ShowToolTips Then
            ttBP.SetToolTip(lblDCBlueText, "Blue Text: Current Research Agents")
        End If
    End Sub

    Private Sub lblDCGrayText_MouseEnter(sender As System.Object, e As System.EventArgs) Handles lblDCGrayText.MouseEnter
        If UserApplicationSettings.ShowToolTips Then
            ttBP.SetToolTip(lblDCGrayText, "Gray Text: Unavailable Research Agent")
        End If
    End Sub

#Disable Warning IDE1006 ' Naming Styles
    Private Sub lblDCOrangeText_MouseEnter(sender As System.Object, e As System.EventArgs) Handles lblDCOrangeText.MouseEnter
#Enable Warning IDE1006 ' Naming Styles
        If UserApplicationSettings.ShowToolTips Then
            ttBP.SetToolTip(lblDCOrangeText, "Orange Text: Research Agent is in Low Sec")
        End If
    End Sub

    Private Sub lblDCRedText_MouseEnter(sender As System.Object, e As System.EventArgs) Handles lblDCRedText.MouseEnter
        If UserApplicationSettings.ShowToolTips Then
            ttBP.SetToolTip(lblDCRedText, "Red Text: Research Agent is in Null Sec")
        End If
    End Sub

    Private Sub rbtnDCSystemPrices_MouseEnter(sender As System.Object, e As System.EventArgs) Handles rbtnDCSystemPrices.MouseEnter
        If UserApplicationSettings.ShowToolTips Then
            ttBP.SetToolTip(rbtnDCSystemPrices, "Max Buy Order from System used for Datacore Price")
        End If
    End Sub

    Private Sub rbtnDCRegionPrices_MouseEnter(sender As System.Object, e As System.EventArgs) Handles rbtnDCRegionPrices.MouseEnter
        If UserApplicationSettings.ShowToolTips Then
            ttBP.SetToolTip(rbtnDCRegionPrices, "Max Buy Order from Region used for Datacore Price")
        End If
    End Sub

    ' Manufacturing Tab
    Private Sub lblCalcColorCode1_MouseEnter(sender As Object, e As System.EventArgs) Handles lblCalcColorCode1.MouseEnter
        If UserApplicationSettings.ShowToolTips Then
            ttBP.SetToolTip(lblCalcColorCode1, "Beige Background: Owned Blueprint")
        End If
    End Sub

    Private Sub lblCalcColorCode2_MouseEnter(sender As System.Object, e As System.EventArgs) Handles lblCalcColorCode2.MouseEnter
        If UserApplicationSettings.ShowToolTips Then
            ttBP.SetToolTip(lblCalcColorCode2, "Light Blue Background: T2 item with Owned T1 Blueprint (for invention)")
        End If
    End Sub

    Private Sub lblCalcColorCode3_MouseEnter(sender As System.Object, e As System.EventArgs) Handles lblCalcColorCode3.MouseEnter
        If UserApplicationSettings.ShowToolTips Then
            ttBP.SetToolTip(lblCalcColorCode3, "Green Text: Unable to T3 Invent Item")
        End If
    End Sub

    Private Sub lblCalcColorCode4_MouseEnter(sender As System.Object, e As System.EventArgs) Handles lblCalcColorCode4.MouseEnter
        If UserApplicationSettings.ShowToolTips Then
            ttBP.SetToolTip(lblCalcColorCode4, "Orange Text: Unable to Invent Item")
        End If
    End Sub

    Private Sub lblCalcColorCode5_MouseEnter(sender As System.Object, e As System.EventArgs) Handles lblCalcColorCode5.MouseEnter
        If UserApplicationSettings.ShowToolTips Then
            ttBP.SetToolTip(lblCalcColorCode5, "Red Text: Unable to Build Item")
        End If
    End Sub

    Private Sub lblCalcColorCode6_MouseEnter(sender As System.Object, e As System.EventArgs) Handles lblCalcColorCode6.MouseEnter
        If UserApplicationSettings.ShowToolTips Then
            ttBP.SetToolTip(lblCalcColorCode6, "Green Background: Corp Owned Blueprint")
        End If
    End Sub

#End Region

#Region "SVR Functions"

    ' Determine the Sales per Volume Ratio, which will be the amount of items we can build in 24 hours (include fractions) when sent the region, avg days, and production time in seconds to make ItemsProduced (runs * portion size)
    Public Function GetItemSVR(TypeID As Long, RegionID As Long, AvgDays As Integer, ProductionTimeSeconds As Double,
                               ItemsProduced As Long) As String
        Dim SQL As String
        Dim readerAverage As SQLiteDataReader
        Dim ItemsperDay As Double

        ' The amount of items we can build in 24 hours (include fractions) divided by the average volume (volume/avgdays)
        ' The data is stored as a record per day, so just count up the number of records in the time period (days - might not be the same as days shown)
        ' and divide by the sum of the volumes over that time period
        SQL = "SELECT SUM(TOTAL_VOLUME_FILLED)/COUNT(PRICE_HISTORY_DATE) FROM MARKET_HISTORY "
        SQL &= "WHERE TYPE_ID = " & TypeID & " AND REGION_ID = " & RegionID & " "
        SQL &= "AND DATETIME(PRICE_HISTORY_DATE) >= " & " DateTime('" & Format(DateAdd(DateInterval.Day, -(AvgDays + 1), Date.UtcNow.Date), SQLiteDateFormat) & "') "
        SQL &= "AND DATETIME(PRICE_HISTORY_DATE) < " & " DateTime('" & Format(Date.UtcNow.Date, SQLiteDateFormat) & "') "
        SQL &= "AND TOTAL_VOLUME_FILLED IS NOT NULL "

        DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
        readerAverage = DBCommand.ExecuteReader

        readerAverage.Read()

        If Not IsDBNull(readerAverage.GetValue(0)) Then
            If ProductionTimeSeconds <> 0 Then
                ' The number of blueprint runs we can build with the sent production time in a day - Seconds to produce 1, then divide that into seconds per day
                ItemsperDay = (24 * 60 * 60) / (ProductionTimeSeconds / ItemsProduced)
                ' Take the items per day and compare to the avg sales volume per day, if it's greater than one you can't make enough items in a day to meet demand = good item to build
                Return FormatNumber(readerAverage.GetDouble(0) / ItemsperDay, 2)
            Else
                ' Just want the volume for the day
                Return FormatNumber(readerAverage.GetDouble(0), 2)
            End If
        Else
            ' Since 0.00 SVR is possible, return nothing instead
            Return "-"
        End If

        readerAverage.Close()

    End Function

    ' Updates the SVR value and then returns it as a string for the item associated with the Selected BP
    Private Function GetBPItemSVR(ProductionTime As Double) As String
        Dim MH As New MarketPriceInterface(Nothing)

        Application.UseWaitCursor = True
        Application.DoEvents()
        Dim TypeID As New List(Of Long) ' for just one
        Dim RegionID As Long = GetRegionID(UserApplicationSettings.SVRAveragePriceRegion)

        Call TypeID.Add(SelectedBlueprint.GetItemID)
        PriceHistoryUpdateCount = 0
        If Not MH.UpdateESIPriceHistory(TypeID, RegionID) Then
            Call MsgBox("Some prices did not update. Please try again.", vbInformation, Application.ProductName)
        End If

        Dim ReturnValue As String = GetItemSVR(TypeID(0), RegionID, CInt(UserApplicationSettings.SVRAveragePriceDuration), ProductionTime,
                                                SelectedBlueprint.GetTotalUnits)

        Application.UseWaitCursor = False
        Application.DoEvents()

        Return ReturnValue

    End Function

#End Region

    Private Sub mnuViewErrorLog_Click(sender As Object, e As EventArgs) Handles mnuViewErrorLog.Click
        Dim f1 As New frmErrorLog

        f1.Show()

    End Sub

    Public Sub LoadCharacterNamesinMenu()
        ' Default character set, now set the menu name on the panel
        mnuCharacter.Text = "Character Loaded: " & SelectedCharacter.Name
        ' Also, load all characters we have
        Dim rsCharacters As SQLiteDataReader
        Dim SQL As String = "SELECT CHARACTER_NAME, CASE WHEN GENDER IS NULL THEN 'male' ELSE GENDER END AS GENDER "
        SQL &= "FROM ESI_CHARACTER_DATA ORDER BY CHARACTER_NAME"
        DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
        rsCharacters = DBCommand.ExecuteReader

        Dim Counter As Integer = 0

        ' Reset all 
        tsCharacter1.Text = ""
        tsCharacter1.Visible = False
        tsCharacter2.Text = ""
        tsCharacter2.Visible = False
        tsCharacter3.Text = ""
        tsCharacter3.Visible = False
        tsCharacter4.Text = ""
        tsCharacter4.Visible = False
        tsCharacter5.Text = ""
        tsCharacter5.Visible = False
        tsCharacter6.Text = ""
        tsCharacter6.Visible = False
        tsCharacter7.Text = ""
        tsCharacter7.Visible = False
        tsCharacter8.Text = ""
        tsCharacter8.Visible = False
        tsCharacter9.Text = ""
        tsCharacter9.Visible = False
        tsCharacter10.Text = ""
        tsCharacter10.Visible = False
        tsCharacter11.Text = ""
        tsCharacter11.Visible = False
        tsCharacter12.Text = ""
        tsCharacter12.Visible = False
        tsCharacter13.Text = ""
        tsCharacter13.Visible = False
        tsCharacter14.Text = ""
        tsCharacter14.Visible = False
        tsCharacter15.Text = ""
        tsCharacter15.Visible = False
        tsCharacter16.Text = ""
        tsCharacter16.Visible = False
        tsCharacter17.Text = ""
        tsCharacter17.Visible = False
        tsCharacter18.Text = ""
        tsCharacter18.Visible = False
        tsCharacter19.Text = ""
        tsCharacter19.Visible = False
        tsCharacter20.Text = ""
        tsCharacter20.Visible = False

        While rsCharacters.Read
            ' Add all the character names to the list for the number we have - only load 20 characters
            Select Case Counter
                Case 0
                    tsCharacter1.Text = rsCharacters.GetString(0)
                    Call SetCharToolStripImage(tsCharacter1, rsCharacters.GetString(1))
                    tsCharacter1.Visible = True
                Case 1
                    tsCharacter2.Text = rsCharacters.GetString(0)
                    Call SetCharToolStripImage(tsCharacter2, rsCharacters.GetString(1))
                    tsCharacter2.Visible = True
                Case 2
                    tsCharacter3.Text = rsCharacters.GetString(0)
                    Call SetCharToolStripImage(tsCharacter3, rsCharacters.GetString(1))
                    tsCharacter3.Visible = True
                Case 3
                    tsCharacter4.Text = rsCharacters.GetString(0)
                    Call SetCharToolStripImage(tsCharacter4, rsCharacters.GetString(1))
                    tsCharacter4.Visible = True
                Case 4
                    tsCharacter5.Text = rsCharacters.GetString(0)
                    Call SetCharToolStripImage(tsCharacter5, rsCharacters.GetString(1))
                    tsCharacter5.Visible = True
                Case 5
                    tsCharacter6.Text = rsCharacters.GetString(0)
                    Call SetCharToolStripImage(tsCharacter6, rsCharacters.GetString(1))
                    tsCharacter6.Visible = True
                Case 6
                    tsCharacter7.Text = rsCharacters.GetString(0)
                    Call SetCharToolStripImage(tsCharacter7, rsCharacters.GetString(1))
                    tsCharacter7.Visible = True
                Case 7
                    tsCharacter8.Text = rsCharacters.GetString(0)
                    Call SetCharToolStripImage(tsCharacter8, rsCharacters.GetString(1))
                    tsCharacter8.Visible = True
                Case 8
                    tsCharacter9.Text = rsCharacters.GetString(0)
                    Call SetCharToolStripImage(tsCharacter9, rsCharacters.GetString(1))
                    tsCharacter9.Visible = True
                Case 9
                    tsCharacter10.Text = rsCharacters.GetString(0)
                    Call SetCharToolStripImage(tsCharacter10, rsCharacters.GetString(1))
                    tsCharacter10.Visible = True
                Case 10
                    tsCharacter11.Text = rsCharacters.GetString(0)
                    Call SetCharToolStripImage(tsCharacter11, rsCharacters.GetString(1))
                    tsCharacter11.Visible = True
                Case 11
                    tsCharacter12.Text = rsCharacters.GetString(0)
                    Call SetCharToolStripImage(tsCharacter12, rsCharacters.GetString(1))
                    tsCharacter12.Visible = True
                Case 12
                    tsCharacter13.Text = rsCharacters.GetString(0)
                    Call SetCharToolStripImage(tsCharacter13, rsCharacters.GetString(1))
                    tsCharacter13.Visible = True
                Case 13
                    tsCharacter14.Text = rsCharacters.GetString(0)
                    Call SetCharToolStripImage(tsCharacter14, rsCharacters.GetString(1))
                    tsCharacter14.Visible = True
                Case 14
                    tsCharacter15.Text = rsCharacters.GetString(0)
                    Call SetCharToolStripImage(tsCharacter15, rsCharacters.GetString(1))
                    tsCharacter15.Visible = True
                Case 15
                    tsCharacter16.Text = rsCharacters.GetString(0)
                    Call SetCharToolStripImage(tsCharacter16, rsCharacters.GetString(1))
                    tsCharacter16.Visible = True
                Case 16
                    tsCharacter17.Text = rsCharacters.GetString(0)
                    Call SetCharToolStripImage(tsCharacter17, rsCharacters.GetString(1))
                    tsCharacter17.Visible = True
                Case 17
                    tsCharacter18.Text = rsCharacters.GetString(0)
                    Call SetCharToolStripImage(tsCharacter18, rsCharacters.GetString(1))
                    tsCharacter18.Visible = True
                Case 18
                    tsCharacter19.Text = rsCharacters.GetString(0)
                    Call SetCharToolStripImage(tsCharacter19, rsCharacters.GetString(1))
                    tsCharacter19.Visible = True
                Case 19
                    tsCharacter20.Text = rsCharacters.GetString(0)
                    Call SetCharToolStripImage(tsCharacter20, rsCharacters.GetString(1))
                    tsCharacter20.Visible = True
            End Select
            Counter += 1 ' increment
        End While

        rsCharacters.Close()

    End Sub

    Private Sub SetCharToolStripImage(ByRef TS As ToolStripMenuItem, ByVal Gender As String)
        If Gender = Male Then
            TS.Image = My.Resources._46_64_1
        Else
            TS.Image = My.Resources._46_64_2
        End If
        TS.ImageTransparentColor = Color.White
    End Sub

    Private Sub LoadSelectedCharacter(ToolStripText As String)
        Me.Cursor = Cursors.WaitCursor
        Call LoadCharacter(ToolStripText, False)
        Call ResetTabs() ' Reload all tabs
        ' New character so make sure the facilities reflect that
        Call LoadFacilities()
        ' Refresh bp in case the facility was different for that bp
        Call RefreshBP()
        Call PlayNotifySound()
        mnuCharacter.Text = "Character Loaded: " & ToolStripText
    End Sub

    ' Predicate for finding the BuildBuyItem in full list
    Public Function FindBBItem(ByVal Item As BuildBuyItem) As Boolean
        If BBItemtoFind = Item.ItemID Then
            Return True
        Else
            Return False
        End If
    End Function

    Private Sub ProcessT2MatSelection()
        If Not FirstLoad And Not UpdatingCheck Then
            If Not IsNothing(SelectedBlueprint) Then
                Call RefreshBP()
            End If
        End If
    End Sub

    Private Sub frmMain_Activated(sender As Object, e As EventArgs) Handles Me.Activated
        ' If they don't have access to the correct scopes for structures, then don't enable the structure ID look up option
        If Not SelectedCharacter.StructureMarketsAccess And Not SelectedCharacter.PublicStructuresAccess Then
            btnAddStructureIDs.Enabled = False
            btnViewSavedStructures.Enabled = False
        Else
            btnAddStructureIDs.Enabled = True
            btnViewSavedStructures.Enabled = True
        End If

    End Sub

    ' Set all the tool strips for characters since I can't process them if they aren't set at runtime
    Private Sub CharacterNameToolStrip_Click(sender As System.Object, e As System.EventArgs) Handles tsCharacter1.Click, tsCharacter2.Click, tsCharacter3.Click, tsCharacter4.Click, tsCharacter5.Click,
            tsCharacter6.Click, tsCharacter7.Click, tsCharacter8.Click, tsCharacter9.Click, tsCharacter10.Click, tsCharacter11.Click, tsCharacter12.Click, tsCharacter13.Click, tsCharacter14.Click, tsCharacter15.Click,
            tsCharacter16.Click, tsCharacter17.Click, tsCharacter18.Click, tsCharacter19.Click, tsCharacter20.Click
        Call LoadSelectedCharacter(CType(sender, ToolStripMenuItem).Text)
    End Sub

    Private Sub frmMain_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles MyBase.Load

        ' After initializing everything, refresh the tabs so they draw fast on first click
        Dim temptab As TabPage
        For Each temptab In tabMain.TabPages
            tabMain.SelectTab(temptab.Name)
            tabMain.SelectedTab.Refresh()
        Next

        ' Reset to bp tab
        tabMain.SelectTab(0)

        ' Add a mouse down handler for the blueprint tab to enable forward and back loading of bps from mouse
        AddHandler tabBlueprints.MouseDown, AddressOf MouseDownHandling
        MouseDownSetting(tabBlueprints)

        ' Done loading
        Call SetProgress("")

    End Sub

    ' Adds mouse down handlers for all controls of the parent
    Private Sub MouseDownSetting(ByVal parentCtr As Control)
        Dim ctr As Control

        For Each ctr In parentCtr.Controls
            AddHandler ctr.MouseDown, AddressOf MouseDownHandling
            MouseDownSetting(ctr)
        Next

    End Sub

    ' Function to deal with mouse down events to load next or previous blueprint
    Private Sub MouseDownHandling(ByVal sender As Object, ByVal e As System.Windows.Forms.MouseEventArgs)

        ' Pause handler for txtbpruns from losing focus so the num bps are updated correctly
        RemoveHandler txtBPRuns.LostFocus, AddressOf txtBPRuns_LostFocus
        If e.Button = Windows.Forms.MouseButtons.XButton1 Then
            Call LoadPreviousBlueprint()
        ElseIf e.Button = Windows.Forms.MouseButtons.XButton2 Then
            Call LoadNextBlueprint()
        End If
        AddHandler txtBPRuns.LostFocus, AddressOf txtBPRuns_LostFocus

    End Sub

    ' Loads a BP sent from a double click on shopping list or manufacturing list, or loading history
    Public Sub LoadBPfromEvent(BPID As Long, BuildType As String, Inputs As String, SentFrom As SentFromLocation,
                                BuildFacility As IndustryFacility, ComponentFacility As IndustryFacility, CapCompentFacility As IndustryFacility,
                                InventionFacility As IndustryFacility, CopyFacility As IndustryFacility,
                                IncludeTaxes As Boolean, BrokerFeeData As BrokerFeeInfo,
                                MEValue As String, TEValue As String, SentRuns As String,
                                ManufacturingLines As String, LaboratoryLines As String, NumBPs As String,
                                AddlCosts As String, PPUCheck As Boolean,
                                Optional CompareType As String = "", Optional T2T3MatType As BuildMatType = Nothing)
        Dim BPTech As Integer
        Dim DecryptorName As String = None
        Dim BPDecryptor As New Decryptor
        Dim readerBP As SQLiteDataReader
        Dim SQL As String
        Dim AdjustedRuns As Integer = 0

        Dim TempLines As Integer = CInt(ManufacturingLines)

        SQL = "SELECT BLUEPRINT_NAME, TECH_LEVEL, PORTION_SIZE FROM ALL_BLUEPRINTS WHERE BLUEPRINT_ID = " & BPID

        DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
        readerBP = DBCommand.ExecuteReader

        readerBP.Read()
        RemoveHandler cmbBPBlueprintSelection.TextChanged, AddressOf cmbBPBlueprintSelection_TextChanged
        cmbBPBlueprintSelection.Text = readerBP.GetString(0)
        SelectedBPText = readerBP.GetString(0)
        AddHandler cmbBPBlueprintSelection.TextChanged, AddressOf cmbBPBlueprintSelection_TextChanged
        BPTech = readerBP.GetInt32(1)
        If SentFrom = SentFromLocation.BlueprintTab Then
            AdjustedRuns = CInt(Math.Ceiling(CInt(SentRuns) / readerBP.GetInt64(2)))
        Else
            AdjustedRuns = CInt(SentRuns)
        End If

        If BPTech = BPTechLevel.T2 Or BPTech = BPTechLevel.T3 Then
            ' Set the decryptor
            If Inputs <> None Then
                If Not CBool(InStr(Inputs, "No Decryptor")) Then
                    If BPTech = 2 Then
                        DecryptorName = Inputs
                    ElseIf InStr(Inputs, "|") <> 0 Then ' For T3
                        DecryptorName = Inputs.Substring(0, InStr(Inputs, "|") - 1)
                    ElseIf InStr(Inputs, " - ") <> 0 Then
                        DecryptorName = Inputs.Substring(0, InStr(Inputs, "-") - 2)
                    End If
                End If
            End If

            BPDecryptor = SelectDecryptor(DecryptorName)

            If BPTech = 3 Then
                LoadingT3Decryptors = True
                cmbBPT3Decryptor.Text = BPDecryptor.Name
                LoadingT3Decryptors = False

                ' Also load the relic
                LoadingRelics = True
                Dim TempRelic As String = ""
                If InStr(Inputs, "|") <> 0 Then ' For T3
                    TempRelic = Inputs.Substring(InStr(Inputs, "|")) ' Removed the -1 in the substring it was including | in the SQL Query
                ElseIf InStr(Inputs, " - ") <> 0 Then
                    TempRelic = Inputs.Substring(InStr(Inputs, "-") + 1)
                End If

                SQL = "SELECT typeName FROM INVENTORY_TYPES, INDUSTRY_ACTIVITY_PRODUCTS WHERE productTypeID =" & BPID & " "
                SQL &= "And typeID = blueprintTypeID And activityID = 8 And typeName Like '%" & TempRelic & "%'"

                DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
                Dim readerRelic As SQLiteDataReader
                readerRelic = DBCommand.ExecuteReader
                readerRelic.Read()
                cmbBPRelic.Items.Clear()
                cmbBPRelic.Text = readerRelic.GetString(0)
                readerRelic.Close()
                LoadingRelics = False
                RelicsLoaded = False ' Allow reload on drop down

                ' Check the include cost/time
                chkBPIncludeT3Costs.Checked = InventionFacility.IncludeActivityCost
                chkBPIncludeT3Time.Checked = InventionFacility.IncludeActivityTime

            Else ' T2
                ' Check the include cost/time
                If Inputs <> "Unknown" Then ' Unknown inputs is T2 BPO or pre-industry patch
                    LoadingInventionDecryptors = True
                    cmbBPInventionDecryptor.Text = BPDecryptor.Name
                    LoadingInventionDecryptors = False

                    If Not IsNothing(InventionFacility) Then
                        chkBPIncludeInventionCosts.Checked = InventionFacility.IncludeActivityCost
                        chkBPIncludeInventionTime.Checked = InventionFacility.IncludeActivityTime
                    Else
                        chkBPIncludeInventionCosts.Checked = True
                        chkBPIncludeInventionTime.Checked = True
                    End If

                    If Not IsNothing(CopyFacility) Then
                        chkBPIncludeCopyCosts.Checked = CopyFacility.IncludeActivityCost
                        chkBPIncludeCopyTime.Checked = CopyFacility.IncludeActivityTime
                    Else
                        chkBPIncludeCopyCosts.Checked = True
                        chkBPIncludeCopyTime.Checked = True
                    End If

                    chkBPIgnoreInvention.Checked = False
                Else
                    chkBPIgnoreInvention.Checked = True ' mark as t2 bpo or any T2 BPC that wasn't invented
                End If

            End If

            ' Need to calculate the number of bps based on the bp
            If chkCalcAutoCalcT2NumBPs.Checked Then
                txtBPNumBPs.Text = CStr(GetUsedNumBPs(BPID, BPTech, AdjustedRuns, TempLines, CInt(NumBPs), BPDecryptor.RunMod))
            End If
        Else
            ' T1
            txtBPNumBPs.Text = NumBPs
        End If

        ' We need to set each facility individually for later use
        If SentFrom <> SentFromLocation.ShoppingList Then ' shopping list doesn't send facilities so just use what is already loaded on bp tab
            BPTabFacility.UpdateFacility(CType(BuildFacility.Clone, IndustryFacility))
            BPTabFacility.UpdateFacility(CType(ComponentFacility.Clone, IndustryFacility))
            BPTabFacility.UpdateFacility(CType(CapCompentFacility.Clone, IndustryFacility))
            If BPTech = BPTechLevel.T2 Or BPTech = 3 Then
                BPTabFacility.UpdateFacility(CType(InventionFacility.Clone, IndustryFacility))
            End If
            If BPTech = 2 Then
                BPTabFacility.UpdateFacility(CType(CopyFacility.Clone, IndustryFacility))
            End If
        End If

        ' Common to all settings
        If CompareType <> "" Then ' if "" then let the BP tab handle it
            If CompareType = "Components" Then
                rbtnBPComponentCopy.Checked = True
            Else
                rbtnBPRawmatCopy.Checked = True
            End If
        End If

        chkBPTaxes.Checked = IncludeTaxes
        Select Case BrokerFeeData.IncludeFee
            Case BrokerFeeType.SpecialFee
                chkBPBrokerFees.CheckState = CheckState.Indeterminate
                txtBPBrokerFeeRate.Text = FormatPercent(BrokerFeeData.FixedRate, 1)
                txtBPBrokerFeeRate.Visible = True
            Case BrokerFeeType.Fee
                chkBPBrokerFees.Checked = True
            Case BrokerFeeType.NoFee
                chkBPBrokerFees.Checked = False
        End Select

        txtBPLines.Text = ManufacturingLines
        txtBPInventionLines.Text = LaboratoryLines
        txtBPRelicLines.Text = LaboratoryLines
        txtBPRuns.Text = CStr(AdjustedRuns)

        txtBPAddlCosts.Text = AddlCosts
        txtBPME.Text = MEValue
        txtBPTE.Text = TEValue
        UpdatingCheck = True
        chkBPPricePerUnit.Checked = PPUCheck
        UpdatingCheck = False

        ' T2/T3 Mat
        If Not IsNothing(T2T3MatType) Then
            Select Case T2T3MatType
                Case BuildMatType.AdvMaterials
                    rbtnBPAdvT2MatType.Checked = True
                Case BuildMatType.ProcessedMaterials
                    rbtnBPProcT2MatType.Checked = True
                Case BuildMatType.RawMaterials
                    rbtnBPRawT2MatType.Checked = True
            End Select
        End If

        ' Set the optimize check
        UpdatingCheck = True
        If BuildType = "Build/Buy" Then
            chkBPBuildBuy.Checked = True
        Else
            chkBPBuildBuy.Checked = False
        End If
        UpdatingCheck = False

        ' Show the BP tab 
        tabMain.SelectedTab = tabBlueprints
        readerBP.Close()

        ' Finally, load the blueprint with data in the row selected like it was just selected
        Call SelectBlueprint(True, SentFrom, True)

    End Sub

    ' Loads the popup with all the material break down and usage for invention
    Private Sub lblBPInventionCost_DoubleClick(sender As System.Object, e As System.EventArgs) Handles lblBPInventionCost.DoubleClick
        Dim f1 As New frmInventionMats

        Me.Cursor = Cursors.WaitCursor

        If Not IsNothing(SelectedBlueprint) Then
            If SelectedBlueprint.GetTechLevel = BPTechLevel.T2 Then
                f1.MatType = "T2 Invention Materials needed for enough successful BPCs for " & CStr(SelectedBlueprint.GetUserRuns)
                If SelectedBlueprint.GetUserRuns = 1 Then
                    f1.MatType = f1.MatType & " Run"
                Else
                    f1.MatType = f1.MatType & " Runs"
                End If
                f1.MaterialList = SelectedBlueprint.GetInventionMaterials
                f1.TotalInventedRuns = SelectedBlueprint.GetTotalInventedRuns
                f1.UserRuns = SelectedBlueprint.GetUserRuns
                f1.ListType = "Invention"
            End If
            Me.Cursor = Cursors.Default
            f1.Show()
        End If

    End Sub

    ' Loads the popup with all the copy materials and usage for copy jobs
    Private Sub lblBPCopyCosts_DoubleClick(sender As Object, e As System.EventArgs) Handles lblBPCopyCosts.DoubleClick
        Dim f1 As New frmInventionMats

        If Not IsNothing(SelectedBlueprint) Then
            If SelectedBlueprint.GetTechLevel = BPTechLevel.T2 Then
                f1.MatType = "T2 Copy Materials needed for enough successful BPCs for " & CStr(SelectedBlueprint.GetUserRuns)
                If SelectedBlueprint.GetUserRuns = 1 Then
                    f1.MatType = f1.MatType & " Run"
                Else
                    f1.MatType = f1.MatType & " Runs"
                End If
                f1.MaterialList = SelectedBlueprint.GetCopyMaterials
                f1.TotalInventedRuns = SelectedBlueprint.GetInventionJobs
                f1.ListType = "Copying"
            End If
            f1.Show()
        End If

    End Sub

    ' Loads the popup with all the material break down and usage for T3 invention
    Private Sub lblBPRECost_DoubleClick(sender As System.Object, e As System.EventArgs) Handles lblBPRECost.DoubleClick
        Dim f1 As New frmInventionMats

        If Not IsNothing(SelectedBlueprint) Then
            If SelectedBlueprint.GetTechLevel = BPTechLevel.T3 Then
                f1.MatType = "T3 Invention Materials needed for enough successful BPCs for " & CStr(SelectedBlueprint.GetUserRuns)
                If SelectedBlueprint.GetUserRuns = 1 Then
                    f1.MatType = f1.MatType & " Run"
                Else
                    f1.MatType = f1.MatType & " Runs"
                End If
                f1.MaterialList = SelectedBlueprint.GetInventionMaterials
                f1.TotalInventedRuns = SelectedBlueprint.GetTotalInventedRuns
                f1.UserRuns = SelectedBlueprint.GetUserRuns
                f1.ListType = "T3 Invention"
            End If
            f1.Show()
        End If

    End Sub

    ' Loads the popup with all the costs for total raw
    Private Sub lblBPRawTotalCost_DoubleClick(sender As Object, e As System.EventArgs) Handles lblBPRawTotalCost.DoubleClick
        Call ShowCostSplitViewer(SelectedBlueprint.GetRawMaterials.GetTotalMaterialsCost, "Raw")
    End Sub

    ' Loads the popup with all the costs for total components
    Private Sub lblBPTotalCompCost_DoubleClick(sender As Object, e As System.EventArgs) Handles lblBPTotalCompCost.DoubleClick
        Call ShowCostSplitViewer(SelectedBlueprint.GetComponentMaterials.GetTotalMaterialsCost, "Component")
    End Sub

    ' Loads the popup with all the costs for the material cost sent
    Private Sub ShowCostSplitViewer(MaterialsCost As Double, MaterialType As String)
        Dim f1 As New frmCostSplitViewer
        Dim RawCostSplit As CostSplit

        ' Fill up the array to display
        If Not IsNothing(SelectedBlueprint) Then
            f1.CostSplitType = "Total " & MaterialType & " Material Cost Split"
            ' Mat cost
            RawCostSplit.SplitName = MaterialType & " Materials Cost"
            RawCostSplit.SplitValue = MaterialsCost
            f1.CostSplits.Add(RawCostSplit)

            ' Add reaction usage if it's a reaction for main bp
            If ReactionTypes.Contains(SelectedBlueprint.GetItemData.GroupName) Then
                RawCostSplit.SplitName = "Reaction Facility Usage"
                RawCostSplit.SplitValue = SelectedBlueprint.GetReactionFacilityUsage
            Else
                ' Manufacturing Facility usage
                RawCostSplit.SplitName = "Manufacturing Facilities Usage"
                RawCostSplit.SplitValue = SelectedBlueprint.GetManufacturingFacilityUsage
            End If

            f1.CostSplits.Add(RawCostSplit)

            If (SelectedBlueprint.HasComponents And chkBPBuildBuy.Checked = True) Or MaterialType = "Raw" Then
                If ReactionTypes.Contains(SelectedBlueprint.GetItemData.GroupName) Then
                    ' Reactions Facility Usage
                    If SelectedBlueprint.GetTotalReactionFacilityUsage - SelectedBlueprint.GetReactionFacilityUsage > 0 Then
                        RawCostSplit.SplitName = "Component Reaction Facilities Usage"
                        RawCostSplit.SplitValue = SelectedBlueprint.GetTotalReactionFacilityUsage - SelectedBlueprint.GetReactionFacilityUsage
                        f1.CostSplits.Add(RawCostSplit)
                    End If
                    ' Manufacturing Facility usage for fuel blocks
                    RawCostSplit.SplitName = "Manufacturing Facilities Usage"
                    RawCostSplit.SplitValue = SelectedBlueprint.GetManufacturingFacilityUsage
                    f1.CostSplits.Add(RawCostSplit)
                End If

                ' The reaction blueprint won't have components or cap components
                If Not ReactionTypes.Contains(SelectedBlueprint.GetItemData.GroupName) Then
                    ' Component Facility Usage
                    RawCostSplit.SplitName = "Component Facilities Usage"
                    RawCostSplit.SplitValue = SelectedBlueprint.GetComponentFacilityUsage
                    f1.CostSplits.Add(RawCostSplit)

                    ' Capital Component Facility Usage
                    Select Case SelectedBlueprint.GetItemGroupID
                        Case ItemIDs.TitanGroupID, ItemIDs.SupercarrierGroupID, ItemIDs.CarrierGroupID, ItemIDs.DreadnoughtGroupID,
                        ItemIDs.JumpFreighterGroupID, ItemIDs.FreighterGroupID, ItemIDs.IndustrialCommandShipGroupID, ItemIDs.CapitalIndustrialShipGroupID, ItemIDs.FAXGroupID
                            ' Only add cap component usage for ships that use them
                            RawCostSplit.SplitName = "Capital Component Facilities Usage"
                            RawCostSplit.SplitValue = SelectedBlueprint.GetCapComponentFacilityUsage
                            f1.CostSplits.Add(RawCostSplit)
                    End Select
                End If
            End If

            'Reprocessing usage
            If SelectedBlueprint.GetReprocessingFacility.ConvertToOre And SelectedBlueprint.GetReprocessingUsage > 0 Then
                RawCostSplit.SplitName = "Reprocessing Usage"
                RawCostSplit.SplitValue = SelectedBlueprint.GetReprocessingUsage
                f1.CostSplits.Add(RawCostSplit)
            End If

            ' Taxes
            RawCostSplit.SplitName = "Taxes"
            RawCostSplit.SplitValue = SelectedBlueprint.GetSalesTaxes
            f1.CostSplits.Add(RawCostSplit)

            ' Broker fees
            RawCostSplit.SplitName = "Broker Fees"
            RawCostSplit.SplitValue = SelectedBlueprint.GetSalesBrokerFees
            f1.CostSplits.Add(RawCostSplit)

            ' Additional Costs the user added
            If SelectedBlueprint.GetAdditionalCosts <> 0 Then
                RawCostSplit.SplitName = "Additional Costs"
                RawCostSplit.SplitValue = SelectedBlueprint.GetAdditionalCosts
                f1.CostSplits.Add(RawCostSplit)
            End If

            If SelectedBlueprint.GetTechLevel <> BPTechLevel.T1 Then
                ' Total Invention Costs
                RawCostSplit.SplitName = "Invention Costs"
                RawCostSplit.SplitValue = SelectedBlueprint.GetInventionCost
                f1.CostSplits.Add(RawCostSplit)

                RawCostSplit.SplitName = "Invention Usage"
                RawCostSplit.SplitValue = SelectedBlueprint.GetInventionUsage
                f1.CostSplits.Add(RawCostSplit)

                ' Total Copy Costs
                RawCostSplit.SplitName = "Copy Costs"
                RawCostSplit.SplitValue = SelectedBlueprint.GetCopyCost
                f1.CostSplits.Add(RawCostSplit)

                RawCostSplit.SplitName = "Copy Usage"
                RawCostSplit.SplitValue = SelectedBlueprint.GetCopyUsage
                f1.CostSplits.Add(RawCostSplit)
            End If

            ' Show the decrease if any excess items sold
            If chkBPSellExcessItems.Checked Then
                If (Not chkBPBuildBuy.Checked And MaterialType = "Raw") Or chkBPBuildBuy.Checked Then
                    RawCostSplit.SplitName = "Sold Excess Items"
                    RawCostSplit.SplitValue = -1 * SelectedBlueprint.GetSellExcessAmount ' show as negative
                    f1.CostSplits.Add(RawCostSplit)
                End If
            End If

            f1.Show()

        End If

    End Sub

    ' Opens the refinery window from menu
    Private Sub mnuReprocessingPlant_Click(sender As System.Object, e As System.EventArgs) Handles mnuReprocessingPlant.Click
        frmRepoPlant = New frmReprocessingPlant

        Call frmRepoPlant.Show()
        ReprocessingPlantOpen = True

    End Sub

    Private Sub mnuMETECalculator_Click(sender As Object, e As EventArgs) Handles mnuMETECalculator.Click
        frmMETE = New frmMETE

        Call frmMETE.Show()

    End Sub

    ' Clears the BP history (forward / back) functionality
    Private Sub mnuClearBPHistory_Click(sender As System.Object, e As System.EventArgs) Handles mnuClearBPHistory.Click
        BPHistory = New List(Of BPHistoryItem)
        ' Reset the index
        CurrentBPHistoryIndex = -1
        ' Save the current bp we are on
        Call UpdateBPHistory(True)
    End Sub

    ' Menu update to show the patch notes
    Private Sub mnuPatchNotes_Click(sender As System.Object, e As System.EventArgs) Handles mnuPatchNotes.Click
        Dim f1 As New frmPatchNotes

        Application.UseWaitCursor = True
        Application.DoEvents()

        f1.Show()

    End Sub

    Private Sub mnuViewESIStatus_Click(sender As Object, e As EventArgs) Handles mnuViewESIStatus.Click
        Dim f1 As New frmESIStatus

        f1.Show()
    End Sub

    Private Sub mnuAnomalyOreBeltsUpgradeBelts_Click(sender As System.Object, e As System.EventArgs) Handles mnuAnomalyOreBelts.Click
        Dim f1 As New frmIndustryBeltFlip

        f1.Show()
        OreBeltFlipOpen = True
    End Sub

    Private Sub mnuIceBelts_Click(sender As Object, e As EventArgs) Handles mnuIceBelts.Click
        Dim f1 As New frmIceBeltFlip

        f1.Show()
        IceBeltFlipOpen = True
    End Sub

    ' Full reset - will delete all data downloaded, updated, or otherwise set by the user
    Private Sub mnuResetAllData_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles mnuResetAllData.Click
        Dim Response As MsgBoxResult

        Response = MsgBox("This will reset all data for the program including ESI Tokens, Blueprints, Assets, Industry Jobs, and Price data." & Environment.NewLine & "Are you sure you want to do this?", vbYesNo, Application.ProductName)

        If Response = vbYes Then
            Application.UseWaitCursor = True
            Application.DoEvents()

            EVEDB.ExecuteNonQuerySQL("DELETE FROM ESI_CHARACTER_DATA")

            EVEDB.ExecuteNonQuerySQL("DELETE FROM ESI_CORPORATION_DATA")

            EVEDB.ExecuteNonQuerySQL("DELETE FROM CHARACTER_STANDINGS")

            EVEDB.ExecuteNonQuerySQL("DELETE FROM CHARACTER_SKILLS")

            EVEDB.ExecuteNonQuerySQL("DELETE FROM OWNED_BLUEPRINTS")

            EVEDB.ExecuteNonQuerySQL("DELETE FROM ITEM_PRICES_CACHE")

            EVEDB.ExecuteNonQuerySQL("DELETE FROM ASSETS")

            EVEDB.ExecuteNonQuerySQL("DELETE FROM INDUSTRY_JOBS")

            EVEDB.ExecuteNonQuerySQL("DELETE FROM CURRENT_RESEARCH_AGENTS")

            EVEDB.ExecuteNonQuerySQL("UPDATE ITEM_PRICES_FACT SET PRICE = 0")

            EVEDB.ExecuteNonQuerySQL("DELETE FROM MARKET_HISTORY")

            EVEDB.ExecuteNonQuerySQL("DELETE FROM MARKET_HISTORY_UPDATE_CACHE")

            Call EVEDB.ExecuteNonQuerySQL("DELETE FROM SAVED_FACILTIES WHERE CHARACTER_ID <> 0")

            ' Load the dummy char
            Call SelectedCharacter.LoadDummyCharacter(True)

            ' Re-load all the forms' facilities
            Call LoadFacilities()

            ' Reset all the cache dates
            Call ResetESIDates()

            ' Reset ESI data
            Call ResetESIIndustrySystemIndicies()
            Call ResetESIAdjustedMarketPrices()

            FirstLoad = True ' Temporarily just to get screen to show correctly

            Application.UseWaitCursor = False
            Application.DoEvents()

            ' Reset the tabs
            Call ResetTabs()

            FirstLoad = False

            MsgBox("All Data Reset", vbInformation, Application.ProductName)

            ' Need to set a default, open that form
            'Dim f2 = New frmSetCharacterDefault
            'f2.ShowDialog()

            'Call LoadCharacterNamesinMenu()

        End If

    End Sub

    Private Sub mnuResetPriceData_Click(sender As System.Object, e As System.EventArgs) Handles mnuResetPriceData.Click
        Dim Response As MsgBoxResult
        Dim SQL As String

        Response = MsgBox("This will reset all stored price data for this character." & Environment.NewLine & "Are you sure you want to do this?", vbYesNo, Application.ProductName)

        If Response = vbYes Then
            Application.UseWaitCursor = True
            Application.DoEvents()

            SQL = "DELETE FROM ITEM_PRICES_CACHE"
            EVEDB.ExecuteNonQuerySQL(SQL)

            SQL = "DELETE FROM MARKET_HISTORY"
            EVEDB.ExecuteNonQuerySQL(SQL)

            SQL = "DELETE FROM MARKET_HISTORY_UPDATE_CACHE"
            EVEDB.ExecuteNonQuerySQL(SQL)

            SQL = "UPDATE ITEM_PRICES_FACT SET PRICE = 0"
            EVEDB.ExecuteNonQuerySQL(SQL)

            Application.UseWaitCursor = False
            Application.DoEvents()

            MsgBox("Prices reset", vbInformation, Application.ProductName)

        End If

        Call UpdateProgramPrices()

    End Sub

    Private Sub mnuResetESIDates_Click(sender As System.Object, e As System.EventArgs) Handles mnuResetESIDates.Click
        Call ResetESIDates()
    End Sub

    Private Sub ResetESIDates()
        Dim SQL As String

        ' Simple update, just set all the ESI cache dates to null
        SQL = "DELETE FROM ESI_PUBLIC_CACHE_DATES"
        EVEDB.ExecuteNonQuerySQL(SQL)

        MsgBox("ESI cache dates reset", vbInformation, Application.ProductName)

    End Sub

    Private Sub ResetESIIndustrySystemIndicies()

        ' Simple update, just set all the ESI cache dates to null
        Call EVEDB.ExecuteNonQuerySQL("UPDATE ESI_PUBLIC_CACHE_DATES SET INDUSTRY_SYSTEMS_CACHED_UNTIL = NULL")

        MsgBox("ESI Industry System Indicies reset", vbInformation, Application.ProductName)

    End Sub

    Public Sub ResetESIAdjustedMarketPrices()

        ' Simple update, just set all the data back to zero
        Call EVEDB.ExecuteNonQuerySQL("UPDATE ITEM_PRICES_FACT SET ADJUSTED_PRICE = 0, AVERAGE_PRICE = 0")
        Call EVEDB.ExecuteNonQuerySQL("UPDATE ESI_PUBLIC_CACHE_DATES SET MARKET_PRICES_CACHED_UNTIL = NULL")

        MsgBox("ESI Adjusted Market Prices reset", vbInformation, Application.ProductName)

    End Sub

    Private Sub mnuResetESIPublicStructures_Click(sender As Object, e As EventArgs) Handles mnuResetESIPublicStructures.Click
        ' Delete all the public structures
        Call ResetPublicStructureData()
        Call EVEDB.ExecuteNonQuerySQL("UPDATE ESI_PUBLIC_CACHE_DATES SET PUBLIC_STRUCTURES_CACHED_UNTIL = NULL")

        MsgBox("ESI Public Structure data reset", vbInformation, Application.ProductName)

    End Sub

    Private Sub mnuResetSavedFacilities_Click(sender As Object, e As EventArgs) Handles mnuResetSavedFacilities.Click

        Call EVEDB.ExecuteNonQuerySQL("DELETE FROM SAVED_FACILITIES WHERE CHARACTER_ID <> 0")
        Call EVEDB.ExecuteNonQuerySQL("DELETE FROM UPWELL_STRUCTURES_INSTALLED_MODULES")
        ' Re-load all the forms' facilities
        Call LoadFacilities()

        MsgBox("Saved Facility data reset", vbInformation, Application.ProductName)

    End Sub

    Private Sub mnuResetMarketOrders_Click(sender As System.Object, e As System.EventArgs) Handles mnuResetMarketOrders.Click

        Application.UseWaitCursor = True
        Application.DoEvents()

        ' Simple update, just set all the data back to zero
        Call EVEDB.ExecuteNonQuerySQL("DELETE FROM MARKET_ORDERS_UPDATE_CACHE")
        Call EVEDB.ExecuteNonQuerySQL("DELETE FROM MARKET_ORDERS")
        Call EVEDB.ExecuteNonQuerySQL("DELETE FROM STRUCTURE_MARKET_ORDERS_UPDATE_CACHE")
        Call EVEDB.ExecuteNonQuerySQL("DELETE FROM STRUCTURE_MARKET_ORDERS")

        MsgBox("Market Orders reset", vbInformation, Application.ProductName)

        Application.UseWaitCursor = False
        Application.DoEvents()
    End Sub

    Private Sub mnuResetMarketHistory_Click(sender As System.Object, e As System.EventArgs) Handles mnuResetMarketHistory.Click

        Application.UseWaitCursor = True
        Application.DoEvents()

        ' Simple update, just set all the data back to zero
        Call EVEDB.ExecuteNonQuerySQL("DELETE FROM MARKET_HISTORY_UPDATE_CACHE")
        Call EVEDB.ExecuteNonQuerySQL("DELETE FROM MARKET_HISTORY")

        MsgBox("Market History reset", vbInformation, Application.ProductName)

        Application.UseWaitCursor = False
        Application.DoEvents()
    End Sub

    Private Sub mnuResetBlueprintData_Click(sender As System.Object, e As System.EventArgs) Handles mnuResetBlueprintData.Click
        Dim Response As MsgBoxResult

        Response = MsgBox("This will reset all blueprints for this character" & Environment.NewLine & "deleting all scanned data and stored ME/TE values." & Environment.NewLine & Environment.NewLine & "Are you sure you want to do this?", vbYesNo, Application.ProductName)

        If Response = vbYes Then
            Application.UseWaitCursor = True
            Application.DoEvents()

            Call ResetAllBPData()

            Application.UseWaitCursor = False
            Application.DoEvents()

        End If

    End Sub

    Private Sub mnuResetAgents_Click(sender As System.Object, e As System.EventArgs) Handles mnuResetAgents.Click
        Dim Response As MsgBoxResult
        Dim SQL As String

        Response = MsgBox("This will reset all stored Research Agents for this character." & Environment.NewLine & "Are you sure you want to do this?", vbYesNo, Application.ProductName)

        If Response = vbYes Then
            Application.UseWaitCursor = True
            Application.DoEvents()

            SQL = "DELETE FROM CURRENT_RESEARCH_AGENTS WHERE CHARACTER_ID =" & SelectedCharacter.ID
            EVEDB.ExecuteNonQuerySQL(SQL)

            SQL = "UPDATE ESI_CHARACTER_DATA SET RESEARCH_AGENTS_CACHE_DATE = NULL WHERE CHARACTER_ID = " & CStr(SelectedCharacter.ID)
            EVEDB.ExecuteNonQuerySQL(SQL)

            Application.UseWaitCursor = False
            Application.DoEvents()

            MsgBox("Research Agents reset", vbInformation, Application.ProductName)
        End If

    End Sub

    Private Sub mnuResetIndustryJobs_Click(sender As System.Object, e As System.EventArgs) Handles mnuResetIndustryJobs.Click
        Dim Response As MsgBoxResult
        Dim SQL As String

        Response = MsgBox("This will reset all stored Industry Jobs for this character." & Environment.NewLine & "Are you sure you want to do this?", vbYesNo, Application.ProductName)

        If Response = vbYes Then
            Application.UseWaitCursor = True
            Application.DoEvents()

            SQL = "DELETE FROM INDUSTRY_JOBS WHERE InstallerID =" & SelectedCharacter.ID & " AND JobType =" & ScanType.Personal
            EVEDB.ExecuteNonQuerySQL(SQL)

            SQL = "UPDATE ESI_CHARACTER_DATA SET INDUSTRY_JOBS_CACHE_DATE = NULL WHERE CHARACTER_ID =" & CStr(SelectedCharacter.ID)
            EVEDB.ExecuteNonQuerySQL(SQL)

            Application.UseWaitCursor = False
            Application.DoEvents()

            MsgBox("Industry Jobs reset", vbInformation, Application.ProductName)
        End If

    End Sub

    Private Sub mnuResetIgnoredBPs_Click(sender As System.Object, e As System.EventArgs) Handles mnuResetIgnoredBPs.Click
        Dim Response As MsgBoxResult
        Dim SQL As String

        Response = MsgBox("This will reset all blueprints to non-ignored" & Environment.NewLine & "Are you sure you want to do this?", vbYesNo, Application.ProductName)

        If Response = vbYes Then
            Application.UseWaitCursor = True
            Application.DoEvents()

            SQL = "UPDATE ALL_BLUEPRINTS_FACT SET IGNORE = 0"
            EVEDB.ExecuteNonQuerySQL(SQL)

            Application.UseWaitCursor = False
            Application.DoEvents()

            MsgBox("Ignored Blueprints reset", vbInformation, Application.ProductName)
        End If
    End Sub

    Private Sub mnuResetAssets_Click(sender As System.Object, e As System.EventArgs) Handles mnuResetAssets.Click
        Dim Response As MsgBoxResult
        Dim SQL As String

        Response = MsgBox("This will reset all stored Assets for this character." & Environment.NewLine & "Are you sure you want to do this?", vbYesNo, Application.ProductName)

        If Response = vbYes Then
            Application.UseWaitCursor = True
            Application.DoEvents()

            ' Personal
            SQL = "DELETE FROM ASSETS WHERE ID =" & SelectedCharacter.ID
            EVEDB.ExecuteNonQuerySQL(SQL)

            SQL = "UPDATE ESI_CHARACTER_DATA SET ASSETS_CACHE_DATE = NULL WHERE CHARACTER_ID =" & CStr(SelectedCharacter.ID)
            EVEDB.ExecuteNonQuerySQL(SQL)

            ' Corp
            SQL = "DELETE FROM ASSETS WHERE ID =" & SelectedCharacter.CharacterCorporation.CorporationID
            EVEDB.ExecuteNonQuerySQL(SQL)

            SQL = "UPDATE ESI_CORPORATION_DATA SET ASSETS_CACHE_DATE = NULL WHERE CORPORATION_ID =" & CStr(SelectedCharacter.CharacterCorporation.CorporationID)
            EVEDB.ExecuteNonQuerySQL(SQL)

            ' Reload the asset variables for the character, which will load nothing but clear the assets out
            Call SelectedCharacter.GetAssets().LoadAssets(SelectedCharacter.ID, SelectedCharacter.CharacterTokenData, UserApplicationSettings.LoadAssetsonStartup)
            Call SelectedCharacter.CharacterCorporation.GetAssets().LoadAssets(SelectedCharacter.CharacterCorporation.CorporationID, SelectedCharacter.CharacterTokenData, UserApplicationSettings.LoadAssetsonStartup)

            Application.UseWaitCursor = False
            Application.DoEvents()

            MsgBox("Assets reset", vbInformation, Application.ProductName)
        End If

    End Sub

    Private Sub mnuCurrentIndustryJobs_Click(sender As System.Object, e As System.EventArgs) Handles mnuCurrentIndustryJobs.Click
        Dim f1 As New frmIndustryJobsViewer
        f1.Show()
    End Sub

    Private Sub mnuResetESIMarketPrices_Click(sender As System.Object, e As System.EventArgs) Handles mnuResetESIMarketPrices.Click
        Call ResetESIAdjustedMarketPrices()
    End Sub

    Private Sub mnuResetESIIndustryFacilities_Click(sender As System.Object, e As System.EventArgs) Handles mnuResetESIIndustryFacilities.Click
        Call ResetESIIndustrySystemIndicies()
    End Sub

    ' Checks the ME and TE boxes to make sure they are ok and errors if not
    Private Function CorrectMETE(ByVal inME As String, ByVal inTE As String, ByRef METextBox As TextBox, ByRef TETextBox As TextBox) As Boolean

        If Not IsNumeric(inME) Or Trim(inME) = "" Then
            MsgBox("Invalid ME Value", vbExclamation)
            METextBox.SelectAll()
            METextBox.Focus()
            Return False
        End If

        If Not IsNumeric(inTE) Or Trim(inTE) = "" Then
            MsgBox("Invalid TE Value", vbExclamation)
            TETextBox.SelectAll()
            TETextBox.Focus()
            Return False
        End If

        Return True

    End Function

    Private Sub tabMain_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles tabMain.Click
        If tabMain.SelectedTab.Name = "tabDatacores" Then
            If FirstShowDatacores Then
                ' Load up the data first
                Me.Cursor = Cursors.WaitCursor

                ' DC Skills and Levels plus the standings
                Call LoadDatacoreTab()

                Me.Cursor = Cursors.Default
                FirstShowDatacores = False ' Don't run this for successive clicks to this tab
            End If
        ElseIf tabMain.SelectedTab.Name = "tabMining" Then
            If FirstShowMining Then
                ' Load up the data first
                Me.Cursor = Cursors.WaitCursor

                ' DC Skills and Levels plus the standings
                Call LoadMiningTab()

                Me.Cursor = Cursors.Default

                FirstShowMining = False ' Don't run for successive clicks
            End If
        End If
    End Sub

    Private Sub mnuCurrentResearchAgents_Click(sender As System.Object, e As System.EventArgs) Handles mnuCurrentResearchAgents.Click
        Dim f1 As New frmResearchAgents
        f1.Show()
    End Sub

    Private Sub mnuSelectionAddChar_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles mnuSelectionAddChar.Click

        ' Open up the default select box here
        Dim f1 = New frmAddCharacter
        f1.ShowDialog()

        Call LoadCharacterNamesinMenu()

        ' Always reset the selected character id

        ' Reinit form
        Call ResetTabs()

    End Sub

    Private Sub mnuSelectionManageCharacters_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles mnuSelectionManageCharacters.Click
        Dim f1 As New frmManageAccounts

        Call f1.ShowDialog()

        ' Default character set, now set the panel if it changed
        If SelectedCharacter.Name <> mnuCharacter.Text.Substring(mnuCharacter.Text.IndexOf(":") + 2) Then
            ' If we returned, we got a default character set
            Call ResetTabs()
            Call LoadCharacterNamesinMenu()
        End If

    End Sub

    Private Sub mnuChangeDummyCharacterName_Click(sender As Object, e As EventArgs) Handles mnuChangeDummyCharacterName.Click
        Dim f1 As New frmChangeDummyCharacter

        f1.ShowDialog()

        If SelectedCharacter.ID = DummyCharacterID Then
            ' Reload with new information
            SelectedCharacter.LoadDefaultCharacter(False, False, True)
            Call LoadCharacterNamesinMenu()
        End If
    End Sub

    Private Sub mnuItemUpdatePrices_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles mnuItemUpdatePrices.Click
        Dim f1 = New frmManualPriceUpdate
        f1.ShowDialog()
        Call ResetRefresh()
    End Sub

    Private Sub mnuCheckforUpdates_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles mnuCheckforUpdates.Click
        Me.Cursor = Cursors.WaitCursor
        Application.DoEvents()
        Call CheckForUpdates(True, Me.Icon)
        Me.Cursor = Cursors.Default
    End Sub

    Private Sub btnCancelUpdate_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnCancelUpdate.Click
        CancelUpdatePrices = True
    End Sub

    Private Sub btnOpenMarketBrowser_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnOpenMarketBrowser.Click
        'Call Process.Start("https://evetycoon.com/market")
        ' Take them to eve marketer page
        Call Process.Start("https://evemarketer.com/")
    End Sub

    Private Sub mnuSelectionExit_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles mnuSelectionExit.Click
        End
    End Sub

    Private Sub mnuSelectionShoppingList_Click_1(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles mnuSelectionShoppingList.Click
        Call ShowShoppingList()
    End Sub

    Private Sub mnuViewAssets_Click(sender As Object, e As EventArgs) Handles mnuViewAssets.Click
        ' Make sure it's not disposed
        If IsNothing(frmDefaultAssets) Then
            ' Make new form
            frmDefaultAssets = New frmAssetsViewer(AssetWindow.DefaultView)
        Else
            If frmDefaultAssets.IsDisposed Then
                ' Make new form
                frmDefaultAssets = New frmAssetsViewer(AssetWindow.DefaultView)
            End If
        End If

        ' Now open the Asset List
        frmDefaultAssets.Show()
        frmDefaultAssets.Focus()

        Application.DoEvents()
    End Sub

    Private Sub mnuManageBlueprintsToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles mnuManageBlueprintsToolStripMenuItem.Click
        Dim f1 = New frmBlueprintManagement
        f1.Show()
        Call ResetRefresh()
        ' Reload the bp if there is one loaded so we get the most updated bps
        'If Not IsNothing(SelectedBlueprint) Then
        '    Call SelectBlueprint(False)
        'End If
    End Sub

    Private Sub mnuSelectDefaultChar_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles mnuSelectDefaultChar.Click
        Dim f1 = New frmSetCharacterDefault
        Dim PreviousChar As String

        PreviousChar = SelectedCharacter.Name
        f1.ShowDialog()
        ' If we returned, we got a default character set
        Call LoadCharacterNamesinMenu()

        ' If they cancel or choose the same one, don't re load everything
        If PreviousChar <> SelectedCharacter.Name Then
            Call ResetTabs()
            Call ResetRefresh()
        End If
    End Sub

    Private Sub pnlShoppingList_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles pnlShoppingList.Click
        Call ShowShoppingList()
    End Sub

    Private Sub mnuSelectionShoppingList_Click(ByVal sender As System.Object, ByVal e As System.EventArgs)
        Call ShowShoppingList()
    End Sub

    Private Sub mnuSelectionAbout_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles mnuSelectionAbout.Click
        Dim f1 = New frmAbout
        ' Open the Shopping List
        f1.ShowDialog()
    End Sub

    Private Sub mnuCharacterSkills_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles mnuCharacterSkills.Click
        Call OpenCharacterSkills()
    End Sub

    Private Sub pnlSkills_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles pnlSkills.Click
        Call OpenCharacterSkills()
    End Sub

    Private Sub OpenCharacterSkills()
        Dim f1 = New frmCharacterSkills
        ' Open the character screen
        SkillsUpdated = False
        f1.ShowDialog()

        If SkillsUpdated Then
            Call UpdateSkillPanel()
            ' Need to reload screens that have skills displayed on it
            Call InitDatacoreTab()
            Call InitMiningTab()

            ' Refresh the BP Tab if there is a blueprint selected since skills could affect build
            If Not IsNothing(SelectedBlueprint) Then
                Call RefreshBP()
            End If
        End If
    End Sub

    Private Sub mnuCharacterStandings_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles mnuCharacterStandings.Click
        Dim f1 = New frmCharacterStandings
        ' Open the character screen
        f1.ShowDialog()
    End Sub

    Private Sub mnuUserSettings_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles mnuUserSettings.Click
        Dim f1 = New frmSettings
        Dim OldFacilitySaveSetting As Boolean = UserApplicationSettings.SaveFacilitiesbyChar

        ' Open the settings form
        f1.ShowDialog()

        ' Now that we return, see if the facility setting changed and update as necessary
        If UserApplicationSettings.SaveFacilitiesbyChar <> OldFacilitySaveSetting Then
            Call ResetCharacterIDonFacilties()
        End If

    End Sub

    Public Sub ResetCharacterIDonFacilties()
        ' If they change the character ID for saving facilities, we need to update the objects
        If UserApplicationSettings.SaveFacilitiesbyChar Then
            With SelectedCharacter
                Call BPTabFacility.ResetSelectedCharacterID(.ID)

                Call CalcBaseFacility.ResetSelectedCharacterID(.ID)
                Call CalcInventionFacility.ResetSelectedCharacterID(.ID)
                Call CalcT3InventionFacility.ResetSelectedCharacterID(.ID)
                Call CalcCopyFacility.ResetSelectedCharacterID(.ID)
                Call CalcSupersFacility.ResetSelectedCharacterID(.ID)
                Call CalcCapitalsFacility.ResetSelectedCharacterID(.ID)
                Call CalcSubsystemsFacility.ResetSelectedCharacterID(.ID)
                Call CalcReactionsFacility.ResetSelectedCharacterID(.ID)
                Call CalcBoostersFacility.ResetSelectedCharacterID(.ID)
                Call CalcComponentsFacility.ResetSelectedCharacterID(.ID)
                Call CalcT3ShipsFacility.ResetSelectedCharacterID(.ID)

                Call MineRefineFacility.ResetSelectedCharacterID(.ID)
            End With
        Else
            Call BPTabFacility.ResetSelectedCharacterID(CommonSavedFacilitiesID)

            Call CalcBaseFacility.ResetSelectedCharacterID(CommonSavedFacilitiesID)
            Call CalcInventionFacility.ResetSelectedCharacterID(CommonSavedFacilitiesID)
            Call CalcT3InventionFacility.ResetSelectedCharacterID(CommonSavedFacilitiesID)
            Call CalcCopyFacility.ResetSelectedCharacterID(CommonSavedFacilitiesID)
            Call CalcSupersFacility.ResetSelectedCharacterID(CommonSavedFacilitiesID)
            Call CalcCapitalsFacility.ResetSelectedCharacterID(CommonSavedFacilitiesID)
            Call CalcSubsystemsFacility.ResetSelectedCharacterID(CommonSavedFacilitiesID)
            Call CalcReactionsFacility.ResetSelectedCharacterID(CommonSavedFacilitiesID)
            Call CalcBoostersFacility.ResetSelectedCharacterID(CommonSavedFacilitiesID)
            Call CalcComponentsFacility.ResetSelectedCharacterID(CommonSavedFacilitiesID)
            Call CalcT3ShipsFacility.ResetSelectedCharacterID(CommonSavedFacilitiesID)

            Call MineRefineFacility.ResetSelectedCharacterID(CommonSavedFacilitiesID)
        End If

        ' Finally, refresh the bptab facility
        Call BPTabFacility.InitializeFacilities(ProgramLocation.BlueprintTab)

    End Sub

    Private Sub ShowShoppingList()

        ' Make sure it's not disposed
        If frmShop.IsDisposed Then
            ' Make new form
            frmShop = New frmShoppingList
        End If

        ' First refresh the lists
        frmShop.RefreshLists()

        ' Now open the Shopping List
        frmShop.Show()
        frmShop.Focus()

        Application.DoEvents()

    End Sub

    Private Sub UpdateSkillPanel()
        If UserApplicationSettings.AllowSkillOverride Then
            pnlSkills.ForeColor = Color.Red
            pnlSkills.Text = "Skills Overridden"
        Else
            pnlSkills.ForeColor = Color.Black
            pnlSkills.Text = "Skills Loaded"
        End If
    End Sub

    Public Sub ResetTabs(Optional ResetBPTab As Boolean = True)
        Me.Enabled = False
        Application.DoEvents()
        ' Init all forms
        Me.Cursor = Cursors.WaitCursor
        Call InitBPTab(ResetBPTab)
        Call InitDatacoreTab()
        Call InitManufacturingTab()
        Call InitUpdatePricesTab()
        Call InitMiningTab()

        ' Update skill override
        Call UpdateSkillPanel()

        Me.Cursor = Cursors.Default
        Me.Enabled = True
        Application.DoEvents()
    End Sub

    Private Sub mnuRestoreDefaultBP_Click(sender As System.Object, e As System.EventArgs) Handles mnuRestoreDefaultBP.Click
        Call AllSettings.SetDefaultBPSettings()

        ' Also need to reset the shared variables
        UserApplicationSettings.CheckBuildBuy = DefaultSettings.DefaultCheckBuildBuy

        ' Save them
        Call AllSettings.SaveBPSettings(AllSettings.GetBPSettings)
        Call AllSettings.SaveApplicationSettings(UserApplicationSettings)

        ' Load them again
        UserBPTabSettings = AllSettings.LoadBPSettings()
        UserApplicationSettings = AllSettings.LoadApplicationSettings()

        ' Reload the tab
        Call InitBPTab()

        MsgBox("BP Tab Default Settings Restored", vbInformation, Application.ProductName)

    End Sub

    Private Sub mnuRestoreDefaultUpdatePrices_Click(sender As System.Object, e As System.EventArgs) Handles mnuRestoreDefaultUpdatePrices.Click
        Call AllSettings.SetDefaultUpdatePriceSettings()
        ' Save them
        Call AllSettings.SaveUpdatePricesSettings(AllSettings.GetUpdatePricesSettings)
        ' Load them again
        UserUpdatePricesTabSettings = AllSettings.LoadUpdatePricesSettings()

        ' Reload the tab
        Call InitUpdatePricesTab()

        MsgBox("Update Prices Tab Default Settings Restored", vbInformation, Application.ProductName)

    End Sub

    Private Sub mnuRestoreDefaultDatacores_Click(sender As System.Object, e As System.EventArgs) Handles mnuRestoreDefaultDatacores.Click
        Call AllSettings.SetDefaultDatacoreSettings()
        ' Save them
        Call AllSettings.SaveDatacoreSettings(AllSettings.GetDatacoreSettings)
        ' Load them again
        UserDCTabSettings = AllSettings.LoadDatacoreSettings()

        ' Reload the tab
        Call InitDatacoreTab()

        MsgBox("Datacores Tab Default Settings Restored", vbInformation, Application.ProductName)

    End Sub

    Private Sub mnuRestoreDefaultManufacturing_Click(sender As System.Object, e As System.EventArgs) Handles mnuRestoreDefaultManufacturing.Click
        Call AllSettings.SetDefaultManufacturingSettings()

        ' Also need to reset the shared variables
        UserApplicationSettings.DefaultBPME = DefaultSettings.DefaultSettingME
        UserApplicationSettings.DefaultBPTE = DefaultSettings.DefaultSettingTE

        ' Save them
        Call AllSettings.SaveManufacturingSettings(AllSettings.GetManufacturingSettings)
        Call AllSettings.SaveApplicationSettings(UserApplicationSettings)

        ' Load them again
        UserManufacturingTabSettings = AllSettings.LoadManufacturingSettings()
        UserApplicationSettings = AllSettings.LoadApplicationSettings()

        ' Reload the tab
        Call InitManufacturingTab()
        ' Also update these shared form variables
        'cmbBPBuildMod.Text = DefaultSettings.DefaultBuildSlotModifier

        MsgBox("Manufacturing Tab Default Settings Restored", vbInformation, Application.ProductName)

    End Sub

    Private Sub mnuRestoreDefaultMining_Click(sender As System.Object, e As System.EventArgs) Handles mnuRestoreDefaultMining.Click
        Call AllSettings.SetDefaultMiningSettings()
        ' Save them
        Call AllSettings.SaveMiningSettings(AllSettings.GetMiningSettings)
        ' Load them again
        UserMiningTabSettings = AllSettings.LoadMiningSettings()

        ' Reload the tab
        Call InitMiningTab()

        MsgBox("Minings Tab Default Settings Restored", vbInformation, Application.ProductName)
    End Sub

    Private Sub mnuResetBuildBuyManualSelections_Click(sender As Object, e As EventArgs) Handles mnuResetBuildBuyManualSelections.Click
        ' Reset the list
        BBItems = New List(Of BuildBuyItem)
        Call RefreshBP()
        MsgBox("Manual Build/Buy List Reset")
    End Sub

    Private Sub chkBPIncludeCopyTime_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkBPIncludeCopyTime.CheckedChanged
        If Not FirstLoad And Not UpdatingInventionChecks Then
            ' Set the copy time check
            BPTabFacility.GetFacility(ProductionType.Copying).IncludeActivityTime = chkBPIncludeCopyTime.Checked
            If Not IsNothing(SelectedBlueprint) Then
                ' Use the original ME and TE values when they change the meta level
                Call UpdateBPGrids(SelectedBlueprint.GetTypeID, SelectedBlueprint.GetTechLevel, False, SelectedBlueprint.GetItemGroupID, SelectedBlueprint.GetItemCategoryID, SentFromLocation.BlueprintTab)

            End If
        End If
    End Sub

    Private Sub chkBPIncludeCopyCosts_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkBPIncludeCopyCosts.CheckedChanged
        If Not FirstLoad And Not UpdatingInventionChecks Then
            ' Include copy costs
            BPTabFacility.GetFacility(ProductionType.Copying).IncludeActivityCost = chkBPIncludeCopyCosts.Checked
            If Not IsNothing(SelectedBlueprint) Then
                Call UpdateBPGrids(SelectedBlueprint.GetTypeID, SelectedBlueprint.GetTechLevel, False, SelectedBlueprint.GetItemGroupID, SelectedBlueprint.GetItemCategoryID, SentFromLocation.BlueprintTab)
            End If
        End If
    End Sub

    Private Sub chkBPIncludeInventionTime_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkBPIncludeInventionTime.CheckedChanged
        If Not FirstLoad And Not UpdatingInventionChecks Then
            ' Include invention time
            BPTabFacility.GetFacility(ProductionType.Invention).IncludeActivityTime = chkBPIncludeInventionTime.Checked
            If Not IsNothing(SelectedBlueprint) Then
                Call UpdateBPGrids(SelectedBlueprint.GetTypeID, SelectedBlueprint.GetTechLevel, False, SelectedBlueprint.GetItemGroupID, SelectedBlueprint.GetItemCategoryID, SentFromLocation.BlueprintTab)
            End If
        End If
    End Sub

    Private Sub chkBPIncludeInventionCosts_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkBPIncludeInventionCosts.CheckedChanged
        If Not FirstLoad And Not UpdatingInventionChecks Then
            ' Include cost for invention
            BPTabFacility.GetFacility(ProductionType.Invention).IncludeActivityCost = chkBPIncludeInventionCosts.Checked
            ' Use the original ME and TE values when they change the meta level
            If Not IsNothing(SelectedBlueprint) Then
                Call UpdateBPGrids(SelectedBlueprint.GetTypeID, SelectedBlueprint.GetTechLevel, False, SelectedBlueprint.GetItemGroupID, SelectedBlueprint.GetItemCategoryID, SentFromLocation.BlueprintTab)
            End If
        End If
    End Sub

    Private Sub chkBPIncludeT3Time_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkBPIncludeT3Time.CheckedChanged
        If Not FirstLoad And Not UpdatingInventionChecks Then
            ' Set the time for T3 invention
            BPTabFacility.GetFacility(ProductionType.T3Invention).IncludeActivityTime = chkBPIncludeT3Time.Checked
            If Not IsNothing(SelectedBlueprint) Then
                Call UpdateBPGrids(SelectedBlueprint.GetTypeID, SelectedBlueprint.GetTechLevel, False, SelectedBlueprint.GetItemGroupID, SelectedBlueprint.GetItemCategoryID, SentFromLocation.BlueprintTab)
            End If
        End If
    End Sub

    Private Sub chkBPIncludeT3Costs_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkBPIncludeT3Costs.CheckedChanged
        If Not FirstLoad And Not UpdatingInventionChecks Then
            ' Set the usage for T3 invention
            BPTabFacility.GetFacility(ProductionType.T3Invention).IncludeActivityCost = chkBPIncludeT3Costs.Checked
            If Not IsNothing(SelectedBlueprint) Then
                Call UpdateBPGrids(SelectedBlueprint.GetTypeID, SelectedBlueprint.GetTechLevel, False, SelectedBlueprint.GetItemGroupID, SelectedBlueprint.GetItemCategoryID, SentFromLocation.BlueprintTab)
            End If
        End If
    End Sub

    Private Sub UpdateIndustryFacilitiesToolStripMenuItem_Click(sender As System.Object, e As System.EventArgs) Handles mnuUpdateIndustryFacilities.Click
        Dim ESIData As New ESI
        Dim f1 As New frmStatus

        Application.UseWaitCursor = True
        Call f1.Show()
        Application.DoEvents()

        ' Always do indicies first since facilities has a field it uses
        If ESIData.UpdateIndustrySystemsCostIndex(f1.lblStatus, f1.pgStatus) Then
            ' Reload the industry facilities now
            Call BPTabFacility.InitializeFacilities(ProgramLocation.BlueprintTab)

            ' Refresh the BP Tab if there is a blueprint selected
            If Not IsNothing(SelectedBlueprint) Then
                Call RefreshBP(True)
            End If

            MsgBox("Industry System Indicies Updated", vbInformation, Application.ProductName)
        End If

        f1.Dispose()
        Application.UseWaitCursor = False
    End Sub

    Private Sub UpdateMarketPricesToolStripMenuItem_Click(sender As System.Object, e As System.EventArgs) Handles mnuUpdateESIMarketPrices.Click
        Dim ESIData As New ESI
        Dim f1 As New frmStatus

        Application.UseWaitCursor = True
        Call f1.Show()
        Application.DoEvents()
        If ESIData.UpdateAdjAvgMarketPrices(f1.lblStatus, f1.pgStatus) Then

            ' Update all the prices in the program
            Call UpdateProgramPrices()

            MsgBox("Market Prices Updated", vbInformation, Application.ProductName)
        End If

        f1.Dispose()
        Application.UseWaitCursor = False
    End Sub

    Private Sub mnuUpdateESIPublicStructures_Click(sender As Object, e As EventArgs) Handles mnuUpdateESIPublicStructures.Click
        Dim ESIData As New ESI
        Dim f1 As New frmStatus

        Application.UseWaitCursor = True
        Call f1.Show()
        Application.DoEvents()
        If ESIData.UpdatePublicStructureswithMarkets(f1.lblStatus, f1.pgStatus) Then
            MsgBox("Public Structure Data Updated", vbInformation, Application.ProductName)
        End If

        f1.Dispose()
        Application.UseWaitCursor = False

    End Sub

#End Region

#Region "InlineListUpdate"

    ' Determines where to show the text box when clicking on the list sent
    Private Sub ListClicked(ListRef As ListView, sender As Object, e As System.Windows.Forms.MouseEventArgs)
        Dim iSubIndex As Integer = 0

        ' Hide the text box when a new line is selected
        txtListEdit.Hide()
        cmbEdit.Hide()

        CurrentRow = ListRef.GetItemAt(e.X, e.Y) ' which listviewitem was clicked
        SelectedGrid = ListRef

        If CurrentRow Is Nothing Then
            Exit Sub
        End If

        CurrentCell = CurrentRow.GetSubItemAt(e.X, e.Y)  ' which subitem was clicked

        ' Determine where the previous and next item boxes will be based on what they clicked - used in tab event handling
        Call SetNextandPreviousCells(ListRef)

        ' See which column has been clicked
        iSubIndex = CurrentRow.SubItems.IndexOf(CurrentCell)

        If ListRef.Name <> lstPricesView.Name And ListRef.Name <> lstMineGrid.Name _
            And ListRef.Name <> lstRawPriceProfile.Name And ListRef.Name <> lstManufacturedPriceProfile.Name Then
            ' Set the columns that can be edited, just ME and Price
            If iSubIndex = 2 Or iSubIndex = 3 Then

                If iSubIndex = 2 Then
                    MEUpdate = True
                Else
                    MEUpdate = False
                End If

                If iSubIndex = 3 Then
                    PriceUpdate = True
                Else
                    PriceUpdate = False
                End If

                ' For the update grids in the Blueprint Tab, only show the box if
                ' 1 - If the ME is clicked and it has something other than a '-' in it (meaning no BP)
                ' 2 - If the Price is clicked and the ME box has '-' in it
                If (CurrentRow.SubItems(2).Text <> "-" And MEUpdate) Or PriceUpdate Then
                    Call ShowEditBox(ListRef)
                End If

            End If

        ElseIf ListRef.Name = lstPricesView.Name Or ListRef.Name = lstMineGrid.Name Then ' Price update for update prices and mining grid

            ' Only process the price box logic on rows that are unrefined and compressed ore on mining tab
            If ListRef.Name = lstMineGrid.Name And CurrentRow.SubItems(2).Text = "Refined" Then
                Exit Sub
            End If

            ' Set the columns that can be edited, just Price
            If iSubIndex = 3 Then
                Call ShowEditBox(ListRef)
                PriceUpdate = True
            End If

        ElseIf ListRef.Name = lstRawPriceProfile.Name Or ListRef.Name = lstManufacturedPriceProfile.Name Then

            If iSubIndex > 0 Then
                ' Reset update type
                Call SetPriceProfileVariables(iSubIndex)
                Call ShowEditBox(ListRef)
            End If

        End If

    End Sub

    ' For updating the items in the list by clicking on them
    Private Sub ProcessKeyDownEdit(SentKey As Keys, ListRef As ListView)
        Dim SQL As String = ""
        Dim rsData As SQLiteDataReader

        Dim MEValue As String = ""
        Dim PriceValue As Double = 0
        Dim PriceUpdated As Boolean = False

        ' Change blank entry to 0
        If Trim(txtListEdit.Text) = "" Then
            txtListEdit.Text = "0"
        End If

        DataUpdated = False

        ' If they hit enter or tab away, mark the BP as owned in the DB with the values entered
        If (SentKey = Keys.Enter Or SentKey = Keys.ShiftKey Or SentKey = Keys.Tab) And DataEntered Then

            ' Check the input first
            If Not IsNumeric(txtListEdit.Text) And MEUpdate Then
                MsgBox("Invalid ME Value", vbExclamation)
                Exit Sub
            End If

            If Not IsNumeric(txtListEdit.Text) And PriceUpdate Then
                MsgBox("Invalid Price Value", vbExclamation)
                Exit Sub
            End If

            ' Save the data depending on what we are updating
            If MEUpdate Then
                MEValue = txtListEdit.Text
            End If

            If PriceUpdate Then
                PriceValue = CDbl(txtListEdit.Text)
            End If

            ' Now do the update for the grids
            If ListRef.Name <> lstPricesView.Name And ListRef.Name <> lstMineGrid.Name And
                ListRef.Name <> lstRawPriceProfile.Name And ListRef.Name <> lstManufacturedPriceProfile.Name Then
                ' BP Grid update

                ' Check the numbers, if the same then don't update
                If MEValue = CurrentRow.SubItems(2).Text And PriceValue = CDbl(CurrentRow.SubItems(3).Text) Then
                    ' Skip down
                    GoTo Tabs
                End If

                ' First, see if we are updating an ME or a price, then deal with each separately
                If MEUpdate Then
                    ' First we need to look up the Blueprint ID
                    SQL = "SELECT ALL_BLUEPRINTS.BLUEPRINT_ID, ALL_BLUEPRINTS.BLUEPRINT_NAME, TECH_LEVEL, "
                    SQL &= "CASE WHEN ALL_BLUEPRINTS.FAVORITE IS NULL THEN 0 ELSE ALL_BLUEPRINTS.FAVORITE END AS FAVORITE, IGNORE, "
                    SQL &= "CASE WHEN TE IS NULL THEN 0 ELSE TE END AS BP_TE "
                    SQL &= "FROM ALL_BLUEPRINTS LEFT JOIN OWNED_BLUEPRINTS ON ALL_BLUEPRINTS.BLUEPRINT_ID = OWNED_BLUEPRINTS.BLUEPRINT_ID  "
                    SQL &= "WHERE ITEM_NAME = '" & RemoveItemNameRuns(CurrentRow.SubItems(0).Text) & "'"

                    DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
                    rsData = DBCommand.ExecuteReader
                    rsData.Read()

                    ' If they update the ME of the blueprint, then we mark it as Owned and a 0 for TE value, but set the type depending on the bp loaded
                    Dim TempBPType As BPType
                    Dim AdditionalCost As Double
                    Dim TempTE As Integer = rsData.GetInt32(5)

                    If rsData.GetInt64(2) = BPTechLevel.T1 Then
                        ' T1 BPO
                        TempBPType = BPType.Original
                    Else
                        ' Remaining T2 and T3 must be invited
                        TempBPType = BPType.InventedBPC
                    End If

                    ' Check additional costs for saving with this bp
                    If IsNumeric(txtBPAddlCosts.Text) Then
                        AdditionalCost = CDbl(txtBPAddlCosts.Text)
                    Else
                        AdditionalCost = 0
                    End If

                    ' If there is no TE for an invented BPC then set it to the base
                    If TempBPType = BPType.InventedBPC And TempTE = 0 Then
                        TempTE = BaseT2T3TE
                    End If

                    Call UpdateBPinDB(rsData.GetInt64(0), CInt(MEValue), TempTE, TempBPType, CInt(MEValue), 0,
                                      CBool(rsData.GetInt32(3)), CBool(rsData.GetInt32(4)), AdditionalCost)

                    ' Mark the line with white color since it's no longer going to be unowned
                    CurrentRow.BackColor = Color.White

                    rsData.Close()

                Else ' Price per unit update

                    SQL = "UPDATE ITEM_PRICES_FACT SET PRICE = " & CStr(CDbl(txtListEdit.Text)) & ", PRICE_TYPE = 'User' WHERE ITEM_ID = " & GetTypeID(RemoveItemNameRuns(CurrentRow.SubItems(0).Text))
                    Call EVEDB.ExecuteNonQuerySQL(SQL)

                    ' Mark the line text with black incase it is red for no price
                    CurrentRow.ForeColor = Color.Black

                    PriceUpdated = True

                End If

                ' Update the data in the current row
                CurrentRow.SubItems(2).Text = CStr(MEValue)
                CurrentRow.SubItems(3).Text = FormatNumber(PriceValue, 2)

                ' For both ME and Prices, we need to re-calculate the blueprint (hit the Refresh Button) to reflect the new numbers
                ' First save the current grid for locations
                RefreshingGrid = True
                Call RefreshBP()
                RefreshingGrid = False

            ElseIf ListRef.Name <> lstRawPriceProfile.Name And ListRef.Name <> lstManufacturedPriceProfile.Name Then
                ' Price List Update
                SQL = "UPDATE ITEM_PRICES_FACT SET PRICE = " & CStr(CDbl(txtListEdit.Text)) & ", PRICE_TYPE = 'User' WHERE ITEM_ID = " & CurrentRow.SubItems(0).Text
                Call EVEDB.ExecuteNonQuerySQL(SQL)

                ' Change the value in the price grid, but don't update the grid
                CurrentRow.SubItems(3).Text = FormatNumber(txtListEdit.Text, 2)

                PriceUpdated = True
            Else
                ' Price Profile update
                Dim RawMat As String
                If ListRef.Name = lstRawPriceProfile.Name Then
                    RawMat = "1"
                Else
                    RawMat = "0"
                End If

                ' See if they have the profile set already
                SQL = "SELECT 'X' FROM PRICE_PROFILES WHERE ID = " & CStr(SelectedCharacter.ID) & " "
                SQL &= "AND GROUP_NAME = '" & CurrentRow.SubItems(0).Text & "' "
                SQL &= "AND RAW_MATERIAL = " & RawMat

                DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
                rsData = DBCommand.ExecuteReader

                If rsData.Read() Then
                    ' Update
                    SQL = "UPDATE PRICE_PROFILES SET "
                    If PriceTypeUpdate Then
                        ' Save current region/system
                        SQL &= "PRICE_TYPE = '" & cmbEdit.Text & "' "
                        CurrentRow.SubItems(1).Text = cmbEdit.Text
                    ElseIf PriceSystemUpdate Then
                        ' Just update system, save others
                        SQL &= "SOLAR_SYSTEM_NAME = '" & cmbEdit.Text & "' "
                        CurrentRow.SubItems(3).Text = cmbEdit.Text
                    ElseIf PriceRegionUpdate Then
                        ' Set region, but set system to all systems (blank)
                        SQL &= "REGION_NAME ='" & cmbEdit.Text & "', SOLAR_SYSTEM_NAME = 'All Systems' "
                        CurrentRow.SubItems(2).Text = cmbEdit.Text
                        CurrentRow.SubItems(3).Text = AllSystems
                    ElseIf PriceModifierUpdate Then
                        Dim PM As Double = CDbl(txtListEdit.Text.Replace("%", "")) / 100
                        SQL &= "PRICE_MODIFIER = " & CStr(PM) & " "
                        CurrentRow.SubItems(4).Text = FormatPercent(PM, 1)
                    End If

                    SQL &= "WHERE ID = " & CStr(SelectedCharacter.ID) & " "
                    SQL &= "AND GROUP_NAME ='" & CurrentRow.SubItems(0).Text & "' "
                    SQL &= "AND RAW_MATERIAL = " & RawMat

                    rsData.Close()

                Else
                    ' Insert new record
                    Dim TempPercent As String = CStr(CDbl(CurrentRow.SubItems(4).Text.Replace("%", "")) / 100)
                    SQL = "INSERT INTO PRICE_PROFILES VALUES (" & CStr(SelectedCharacter.ID) & ",'" & CurrentRow.SubItems(0).Text & "','"
                    If PriceTypeUpdate Then
                        ' Save current region/system
                        SQL &= FormatDBString(cmbEdit.Text) & "','" & CurrentRow.SubItems(2).Text & "','" & CurrentRow.SubItems(3).Text & "'," & TempPercent & "," & RawMat & ")"
                        CurrentRow.SubItems(1).Text = cmbEdit.Text
                    ElseIf PriceSystemUpdate Then
                        ' Just update system, save others
                        SQL &= CurrentRow.SubItems(1).Text & "','" & CurrentRow.SubItems(2).Text & "','" & FormatDBString(cmbEdit.Text) & "'," & TempPercent & "," & RawMat & ")"
                        CurrentRow.SubItems(3).Text = cmbEdit.Text
                    ElseIf PriceRegionUpdate Then
                        ' Set region, but set system to all systems (blank)
                        SQL &= CurrentRow.SubItems(1).Text & "','" & FormatDBString(cmbEdit.Text) & "','All Systems'," & TempPercent & "," & RawMat & ")"
                        ' Set the text
                        CurrentRow.SubItems(2).Text = cmbEdit.Text
                        CurrentRow.SubItems(3).Text = AllSystems
                    ElseIf PriceModifierUpdate Then
                        ' Save current region/system/type
                        SQL &= CurrentRow.SubItems(1).Text & "','" & CurrentRow.SubItems(2).Text & "','" & CurrentRow.SubItems(3).Text & "',"
                        Dim PM As Double = CDbl(txtListEdit.Text.Replace("%", "")) / 100
                        SQL &= CStr(PM) & "," & RawMat & ")"
                        CurrentRow.SubItems(4).Text = FormatPercent(PM, 1)
                    End If

                End If

                Call EVEDB.ExecuteNonQuerySQL(SQL)

                ' Reset these
                PriceTypeUpdate = False
                PriceRegionUpdate = False
                PriceSystemUpdate = False
                PreviousPriceType = ""
                PreviousRegion = ""
                PreviousSystem = ""
                PriceUpdated = False

            End If

            ' If we updated a price, then update the program everywhere to be consistent
            If PriceUpdated Then
                IgnoreFocus = True
                Call UpdateProgramPrices(False) ' Don't refresh the grid, we are already updating it
                IgnoreFocus = False
            End If

            ' Play sound to indicate update complete
            If PriceUpdated Then
                Call PlayNotifySound()
            End If

            ' Reset text they entered if tabbed
            If SentKey = Keys.ShiftKey Or SentKey = Keys.Tab Then
                txtListEdit.Text = ""
                cmbEdit.Text = ""
            End If

            If SentKey = Keys.Enter Then
                ' Just refresh and select the current row
                CurrentRow.Selected = True
                txtListEdit.Visible = False
            End If

            ' Data updated, so reset
            DataEntered = False
            DataUpdated = True

        End If

Tabs:
        ' If they hit tab, then tab to the next cell
        If SentKey = Keys.Tab Then
            If CurrentRow.Index = -1 Then
                ' Reset the current row based on the original click
                CurrentRow = ListRef.GetItemAt(SavedListClickLoc.X, SavedListClickLoc.Y)
                CurrentCell = CurrentRow.GetSubItemAt(SavedListClickLoc.X, SavedListClickLoc.Y)
                ' Reset the next and previous cells
                SetNextandPreviousCells(ListRef)
            End If

            CurrentCell = NextCell
            ' Reset these each time
            Call SetNextandPreviousCells(ListRef, "Next")
            If CurrentRow.Index = 0 Then
                ' Scroll to top
                ListRef.Items.Item(0).Selected = True
                ListRef.EnsureVisible(0)
                ListRef.Update()
            Else
                ' Make sure the row is visible
                ListRef.EnsureVisible(CurrentRow.Index)
            End If

            ' Show the text box
            Call ShowEditBox(ListRef)
        End If

        ' If shift+tab, then go to the previous cell 
        If SentKey = Keys.ShiftKey Then
            If CurrentRow.Index = -1 Then
                ' Reset the current row based on the original click
                CurrentRow = ListRef.GetItemAt(SavedListClickLoc.X, SavedListClickLoc.Y)
                CurrentCell = CurrentRow.GetSubItemAt(SavedListClickLoc.X, SavedListClickLoc.Y)
                ' Reset the next and previous cells
                SetNextandPreviousCells(ListRef)
            End If

            CurrentCell = PreviousCell
            ' Reset these each time
            Call SetNextandPreviousCells(ListRef, "Previous")
            If CurrentRow.Index = ListRef.Items.Count - 1 Then
                ' Scroll to bottom
                ListRef.Items.Item(ListRef.Items.Count - 1).Selected = True
                ListRef.EnsureVisible(ListRef.Items.Count - 1)
                ListRef.Update()
            Else
                ' Make sure the row is visible
                ListRef.EnsureVisible(CurrentRow.Index)
            End If

            ' Show the text box
            Call ShowEditBox(ListRef)
        End If

    End Sub

    ' Determines where the previous and next item boxes will be based on what they clicked - used in tab event handling
    Private Sub SetNextandPreviousCells(ListRef As ListView, Optional CellType As String = "")
        Dim iSubIndex As Integer = 0

        ' Normal Row
        If CellType = "Next" Then
            CurrentRow = NextCellRow
        ElseIf CellType = "Previous" Then
            CurrentRow = PreviousCellRow
        End If

        ' Get index of column
        iSubIndex = CurrentRow.SubItems.IndexOf(CurrentCell)

        ' Get next and previous rows. If at end, wrap to top. If at top, wrap to bottom
        If ListRef.Items.Count = 1 Then
            NextRow = CurrentRow
            PreviousRow = CurrentRow
        ElseIf CurrentRow.Index <> ListRef.Items.Count - 1 And CurrentRow.Index <> 0 Then
            ' Not the last line, so set the next and previous
            NextRow = ListRef.Items.Item(CurrentRow.Index + 1)
            PreviousRow = ListRef.Items.Item(CurrentRow.Index - 1)
        ElseIf CurrentRow.Index = 0 Then
            NextRow = ListRef.Items.Item(CurrentRow.Index + 1)
            ' Wrap to bottom
            PreviousRow = ListRef.Items.Item(ListRef.Items.Count - 1)
        ElseIf CurrentRow.Index = ListRef.Items.Count - 1 Then
            ' Need to wrap up to top
            NextRow = ListRef.Items.Item(0)
            PreviousRow = ListRef.Items.Item(CurrentRow.Index - 1)
        End If

        If ListRef.Name <> lstPricesView.Name And ListRef.Name <> lstMineGrid.Name _
            And ListRef.Name <> lstRawPriceProfile.Name And ListRef.Name <> lstManufacturedPriceProfile.Name Then

            ' For the update grids in the Blueprint Tab, only show the box if
            ' 1 - If the ME is clicked and it has something other than a '-' in it (meaning no BP)
            ' 2 - If the Price is clicked and the ME box has '-' in it

            ' The next row must be an ME or Price box on the next row 
            ' or a previous ME or price box on the previous row
            If iSubIndex = 2 Or iSubIndex = 3 Then
                ' Set the next and previous ME boxes (subitems)
                ' If the next row ME box is a '-' then the next row cell is Price
                If NextRow.SubItems(2).Text = "-" Then
                    NextCell = NextRow.SubItems.Item(3) ' Next row price box
                Else ' It can be the ME box in the next row
                    NextCell = NextRow.SubItems.Item(2) ' Next row ME box
                End If

                NextCellRow = NextRow

                'If the previous row ME box is a '-' then the previous row is Price
                If PreviousRow.SubItems(2).Text = "-" Then
                    PreviousCell = PreviousRow.SubItems.Item(3) ' Next row price box
                Else ' It can be the ME box in the next row
                    PreviousCell = PreviousRow.SubItems.Item(2) ' Next row ME box
                End If

                PreviousCellRow = PreviousRow

                If iSubIndex = 2 Then
                    MEUpdate = True
                    PriceUpdate = False
                Else
                    MEUpdate = False
                    PriceUpdate = True
                End If

            Else
                NextCell = Nothing
                PreviousCell = Nothing
                CurrentCell = Nothing
            End If

        ElseIf ListRef.Name = lstRawPriceProfile.Name Or ListRef.Name = lstManufacturedPriceProfile.Name Then

            If iSubIndex <> 0 Then
                ' Set the next and previous combo boxes
                If iSubIndex = 4 Then
                    NextCell = NextRow.SubItems.Item(1) ' Next now price type box
                    NextCellRow = NextRow
                Else
                    NextCell = CurrentRow.SubItems.Item(iSubIndex + 1) ' current row, next cell
                    NextCellRow = CurrentRow
                End If

                If iSubIndex = 1 Then
                    PreviousCell = PreviousRow.SubItems.Item(4) ' Previous row price mod
                    PreviousCellRow = PreviousRow
                Else
                    PreviousCell = CurrentRow.SubItems.Item(iSubIndex - 1) ' Same row, just back a cell
                    PreviousCellRow = CurrentRow
                End If

                ' Reset update type
                Call SetPriceProfileVariables(iSubIndex)

            Else
                NextCell = Nothing
                PreviousCell = Nothing
                CurrentCell = Nothing
            End If

        Else ' Price list 
            ' For this, just go up and down the rows
            NextCell = NextRow.SubItems.Item(3)
            NextCellRow = NextRow
            PreviousCell = PreviousRow.SubItems.Item(3)
            PreviousCellRow = PreviousRow
            PriceUpdate = True
            MEUpdate = False
        End If

    End Sub

    ' Shows the text box on the grid where clicked if enabled
    Private Sub ShowEditBox(ListRef As ListView)

        ' Save the center location of the edit box
        SavedListClickLoc.X = CurrentCell.Bounds.Left + CInt(CurrentCell.Bounds.Width / 2)
        SavedListClickLoc.Y = CurrentCell.Bounds.Top + CInt(CurrentCell.Bounds.Height / 2)

        ' Get the boundry data for the control now
        Dim pTop As Integer = ListRef.Top + CurrentCell.Bounds.Top
        Dim pLeft As Integer = ListRef.Left + CurrentCell.Bounds.Left + 2 ' pad right by 2 to align better
        Dim CurrentParent As Control

        CurrentParent = ListRef.Parent
        ' Look up all locations of parent controls to get the location for the control boundaries when shown
        Do Until CurrentParent.Name = "frmMain"
            pTop = pTop + CurrentParent.Top
            pLeft = pLeft + CurrentParent.Left
            CurrentParent = CurrentParent.Parent
        Loop

        If ListRef.Name <> lstRawPriceProfile.Name And ListRef.Name <> lstManufacturedPriceProfile.Name Or PriceModifierUpdate Then
            With txtListEdit
                .Hide()
                ' Set the bounds of the control
                .SetBounds(pLeft, pTop, CurrentCell.Bounds.Width, CurrentCell.Bounds.Height)
                .Text = CurrentCell.Text
                .Show()
                If CurrentRow.SubItems(2).Text = txtListEdit.Text Then
                    .TextAlign = HorizontalAlignment.Center
                Else
                    .TextAlign = HorizontalAlignment.Right
                End If

                .Focus()
            End With
            cmbEdit.Visible = False
        Else ' updates on the price profile grids

            With cmbEdit
                UpdatingCombo = True

                If PriceRegionUpdate Then
                    Call LoadRegionCombo(cmbEdit, CurrentCell.Text)
                    ' Set the bounds of the control
                    .SetBounds(pLeft, pTop, CurrentCell.Bounds.Width, CurrentCell.Bounds.Height)
                    .Show()
                    .Focus()
                Else
                    .Hide()
                    .BeginUpdate()
                    .Items.Clear()
                    Dim rsData As SQLiteDataReader
                    Dim SQL As String = ""

                    If PriceSystemUpdate Then
                        ' Base it off the data in the region cell
                        SQL = "SELECT solarSystemName FROM SOLAR_SYSTEMS, REGIONS "
                        SQL &= "WHERE SOLAR_SYSTEMS.regionID = REGIONS.regionID "
                        SQL &= "AND REGIONS.regionName = '" & PreviousCell.Text & "' "
                        SQL &= "ORDER BY solarSystemName"
                        DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
                        rsData = DBCommand.ExecuteReader

                        ' Add all systems if it's the system
                        .Items.Add(AllSystems)
                        While rsData.Read
                            .Items.Add(rsData.GetString(0))
                            ' Special processing for The Forge
                            If PreviousCell.Text = "The Forge" And rsData.GetString(0) = "Jita" Then
                                .Items.Add(JitaPerimeter)
                            End If
                        End While

                        rsData.Close()

                    ElseIf PriceTypeUpdate Then
                        ' Manually enter these
                        .Items.Add("Min Sell")
                        .Items.Add("Max Sell")
                        .Items.Add("Avg Sell")
                        .Items.Add("Median Sell")
                        .Items.Add("Percentile Sell")
                        .Items.Add("Min Buy")
                        .Items.Add("Max Buy")
                        .Items.Add("Avg Buy")
                        .Items.Add("Median Buy")
                        .Items.Add("Percentile Buy")
                        .Items.Add("Split Price")
                    End If

                    ' Set the bounds of the control
                    .SetBounds(pLeft, pTop, CurrentCell.Bounds.Width, CurrentCell.Bounds.Height)
                    .Text = CurrentCell.Text
                    .EndUpdate()
                    .Show()
                    .Focus()
                End If
                DataEntered = False ' We just updated so reset
                UpdatingCombo = False
            End With
            txtListEdit.Visible = False
        End If
    End Sub

    ' Processes the tab function in the text box for the grid. This overrides the default tabbing between controls
    Protected Overrides Function ProcessTabKey(ByVal TabForward As Boolean) As Boolean
        Dim ac As Control = Me.ActiveControl

        TabPressed = True

        If TabForward Then
            If ac Is txtListEdit Or ac Is cmbEdit Then
                Call ProcessKeyDownEdit(Keys.Tab, SelectedGrid)
                Return True
            End If
        Else
            If ac Is txtListEdit Or ac Is cmbEdit Then
                ' This is Shift + Tab but just send Shift for ease of processing
                Call ProcessKeyDownEdit(Keys.ShiftKey, SelectedGrid)
                Return True
            End If
        End If

        Return MyBase.ProcessTabKey(TabForward)

    End Function

    Private Sub cmbEdit_DropDownClosed(sender As Object, e As System.EventArgs) Handles cmbEdit.DropDownClosed
        If (PriceRegionUpdate And cmbEdit.Text <> PreviousRegion) Or
            (PriceSystemUpdate And cmbEdit.Text <> PreviousSystem) Or
            (PriceTypeUpdate And cmbEdit.Text <> PreviousPriceType) And Not UpdatingCombo Then
            DataEntered = True
            Call ProcessKeyDownEdit(Keys.Enter, SelectedGrid)
        End If
    End Sub

    Private Sub cmbEdit_SelectedIndexChanged(sender As Object, e As System.EventArgs) Handles cmbEdit.SelectedIndexChanged
        If Not DataUpdated Then
            DataEntered = True
        End If
    End Sub

    Private Sub cmbEdit_LostFocus(sender As Object, e As System.EventArgs) Handles cmbEdit.LostFocus
        ' Lost focus some other way than tabbing
        If ((PriceRegionUpdate And cmbEdit.Text <> PreviousRegion) Or
            (PriceSystemUpdate And cmbEdit.Text <> PreviousSystem) Or
            (PriceTypeUpdate And cmbEdit.Text <> PreviousPriceType)) _
            And Not TabPressed And Not UpdatingCombo Then
            DataEntered = True
            Call ProcessKeyDownEdit(Keys.Enter, SelectedGrid)
        End If
        cmbEdit.Visible = False
        TabPressed = False
    End Sub

    Private Sub txtListEdit_GotFocus(sender As Object, e As System.EventArgs) Handles txtListEdit.GotFocus
        Call txtListEdit.SelectAll()
    End Sub

    Private Sub txtListEdit_KeyDown(sender As Object, e As System.Windows.Forms.KeyEventArgs) Handles txtListEdit.KeyDown
        If Not DataEntered Then ' If data already entered, then they didn't do it through paste
            DataEntered = ProcessCutCopyPasteSelect(txtListEdit, e)
        End If

        If e.KeyCode = Keys.Enter Then
            IgnoreFocus = True
            Call ProcessKeyDownEdit(Keys.Enter, SelectedGrid)
            IgnoreFocus = False
        End If
    End Sub

    Private Sub txtListEdit_KeyPress(sender As Object, e As System.Windows.Forms.KeyPressEventArgs) Handles txtListEdit.KeyPress
        ' Make sure it's the right format for ME or Price update
        ' Only allow numbers or backspace
        If e.KeyChar <> ControlChars.Back Then
            If MEUpdate Then
                If allowedMETEChars.IndexOf(e.KeyChar) = -1 Then
                    ' Invalid Character
                    e.Handled = True
                Else
                    DataEntered = True
                End If
            ElseIf PriceUpdate Then
                If allowedPriceChars.IndexOf(e.KeyChar) = -1 Then
                    ' Invalid Character
                    e.Handled = True
                Else
                    DataEntered = True
                End If
            ElseIf PriceModifierUpdate Then
                e.Handled = CheckPercentCharEntry(e, txtListEdit)
                If e.Handled = False Then
                    DataEntered = True
                End If
            End If
        End If

    End Sub

    Private Sub txtListEdit_LostFocus(sender As Object, e As System.EventArgs) Handles txtListEdit.LostFocus
        If Not RefreshingGrid And DataEntered And Not IgnoreFocus And (PriceModifierUpdate And txtListEdit.Text <> PreviousPriceMod) Then
            Call ProcessKeyDownEdit(Keys.Enter, SelectedGrid)
        End If
        txtListEdit.Visible = False
    End Sub

    Private Sub txtListEdit_TextChanged(sender As Object, e As System.EventArgs) Handles txtListEdit.TextChanged
        If MEUpdate Then ' make sure they only enter 0-10 for values
            Call VerifyMETEEntry(txtListEdit, "ME")
        End If
    End Sub

    ' Sets the variables for price profiles
    Private Sub SetPriceProfileVariables(Index As Integer)
        PriceTypeUpdate = False
        PriceRegionUpdate = False
        PriceSystemUpdate = False
        PriceModifierUpdate = False

        Select Case Index
            Case 1
                PriceTypeUpdate = True
                PreviousPriceType = CurrentCell.Text
            Case 2
                PriceRegionUpdate = True
                PreviousRegion = CurrentCell.Text
            Case 3
                PriceSystemUpdate = True
                PreviousSystem = CurrentCell.Text
            Case 4
                PriceModifierUpdate = True
                PreviousPriceMod = CurrentCell.Text
        End Select

    End Sub

    ' Detects Scroll event and hides boxes
    Private Sub lstBPComponentMats_ProcMsg(ByVal m As System.Windows.Forms.Message) Handles lstBPComponentMats.ProcMsg
        txtListEdit.Hide()
        cmbEdit.Hide()
    End Sub

    ' Detects Scroll event and hides boxes
    Private Sub lstBPRawMats_ProcMsg(ByVal m As System.Windows.Forms.Message) Handles lstBPRawMats.ProcMsg
        txtListEdit.Hide()
        cmbEdit.Hide()
    End Sub

    ' Detects Scroll event and hides boxes
    Private Sub lstPricesView_ProcMsg(ByVal m As System.Windows.Forms.Message) Handles lstPricesView.ProcMsg
        txtListEdit.Hide()
        cmbEdit.Hide()
    End Sub

    ' Detects Scroll event and hides boxes
    Private Sub lstRawPriceProfile_ProcMsg(ByVal m As System.Windows.Forms.Message)
        txtListEdit.Hide()
        cmbEdit.Hide()
    End Sub

    ' Detects Scroll event and hides boxes
    Private Sub lstManufacturedPriceProfile_ProcMsg(ByVal m As System.Windows.Forms.Message)
        txtListEdit.Hide()
        cmbEdit.Hide()
    End Sub

#End Region

#Region "Blueprints Tab"

#Region "Blueprints Tab User Objects (Check boxes, Text, Buttons) Functions/Procedures "

    Private Sub btnBPComponents_Click(sender As Object, e As EventArgs) Handles btnBPComponents.Click
        lstBPComponentMats.Visible = True
        lstBPBuiltComponents.Visible = False
        lblBPComponentMats.Text = "Component Material List"
    End Sub

    ' Inits the Invention tab so it shows correctly with themes
    Public Sub InitInventionTab()
        Dim sb As String = String.Empty
        Dim v As String = String.Empty

        On Error Resume Next
        SetWindowTheme(Me.tabBPInventionEquip.Handle, " ", " ")
        On Error GoTo 0

    End Sub

    Private Sub btnBPBuiltComponents_Click(sender As Object, e As EventArgs) Handles btnBPBuiltComponents.Click
        lstBPComponentMats.Visible = False
        lstBPBuiltComponents.Visible = True
        lblBPComponentMats.Text = "Built Component Material List"
    End Sub

    Private Sub rbtnBPAdvT2MatType_CheckedChanged(sender As Object, e As EventArgs) Handles rbtnBPAdvT2MatType.CheckedChanged
        If rbtnBPAdvT2MatType.Checked Then
            Call LoadT2T3MatFacility(BuildMatType.AdvMaterials)
        End If
    End Sub

    Private Sub rbtnBPProcT2MatType_CheckedChanged(sender As Object, e As EventArgs) Handles rbtnBPProcT2MatType.CheckedChanged
        If rbtnBPProcT2MatType.Checked Then
            Call LoadT2T3MatFacility(BuildMatType.ProcessedMaterials)
        End If
    End Sub

    Private Sub rbtnBPRawT2MatType_CheckedChanged(sender As Object, e As EventArgs) Handles rbtnBPRawT2MatType.CheckedChanged
        If rbtnBPRawT2MatType.Checked Then
            Call LoadT2T3MatFacility(BuildMatType.RawMaterials)
        End If
    End Sub

    Private Sub LoadT2T3MatFacility(MatType As BuildMatType)
        UserBPTabSettings.BuildT2T3Materials = MatType
        If Not IsNothing(SelectedBlueprint) Then
            With SelectedBlueprint
                Call BPTabFacility.LoadFacility(.GetBPID, .GetItemGroupID, .GetItemCategoryID, .GetTechLevel, False, False, False, MatType)
            End With
        End If
        Call ProcessT2MatSelection()
    End Sub

    Private Sub chkPerUnit_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkBPPricePerUnit.CheckedChanged
        If Not FirstLoad And Not UpdatingCheck Then
            Call UpdateBPPriceLabels()
            ' Update history too
            Call UpdateBPHistory(False)
        End If
    End Sub

    Private Sub txtBPLines_DoubleClick(sender As Object, e As System.EventArgs) Handles txtBPLines.DoubleClick
        ' Enter the max lines we have
        txtBPLines.Text = CStr(SelectedCharacter.MaximumProductionLines)
    End Sub

    Private Sub txtBPLines_KeyDown(sender As Object, e As System.Windows.Forms.KeyEventArgs) Handles txtBPLines.KeyDown
        Call ProcessCutCopyPasteSelect(txtBPLines, e)
        Call EnterKeyRunBP(e)
    End Sub

    Private Sub txtBPLines_KeyPress(sender As Object, e As System.Windows.Forms.KeyPressEventArgs) Handles txtBPLines.KeyPress
        ' Only allow numbers or backspace
        If e.KeyChar <> ControlChars.Back Then
            If allowedRunschars.IndexOf(e.KeyChar) = -1 Then
                ' Invalid Character
                e.Handled = True
            Else
                Call ResetRefresh()
            End If
        End If
    End Sub

    Private Sub txtBPInventionLines_DoubleClick(sender As Object, e As System.EventArgs) Handles txtBPInventionLines.DoubleClick
        ' Enter the max lines we have
        txtBPInventionLines.Text = CStr(SelectedCharacter.MaximumLaboratoryLines)
    End Sub

    Private Sub txtBPInventionLines_KeyDown(sender As Object, e As System.Windows.Forms.KeyEventArgs) Handles txtBPInventionLines.KeyDown
        Call ProcessCutCopyPasteSelect(txtBPInventionLines, e)
        Call EnterKeyRunBP(e)
    End Sub

    Private Sub txtBPInventionLines_KeyPress(sender As Object, e As System.Windows.Forms.KeyPressEventArgs) Handles txtBPInventionLines.KeyPress
        ' Only allow numbers or backspace
        If e.KeyChar <> ControlChars.Back Then
            If allowedRunschars.IndexOf(e.KeyChar) = -1 Then
                ' Invalid Character
                e.Handled = True
            Else
                Call ResetRefresh()
            End If
        End If
    End Sub

    Private Sub lblBPCanMakeBP_DoubleClick(sender As Object, e As System.EventArgs) Handles lblBPCanMakeBP.DoubleClick
        ' Only allow if items in list
        If lstBPComponentMats.Items.Count > 0 Then
            Dim f1 As New frmReqSkills(SkillType.BPReqSkills)
            f1.Show()
        End If
    End Sub

    Private Sub lblBPCanMakeBPAll_DoubleClick(sender As Object, e As System.EventArgs) Handles lblBPCanMakeBPAll.DoubleClick
        ' Don't allow popup if buying all
        If lblBPCanMakeBPAll.Text = "Buying all Materials" Then
            Exit Sub
        End If

        ' Only update the make all label if we have something to make, else use the bp data
        If SelectedBlueprint.HasComponents Then
            Dim f1 As New frmReqSkills(SkillType.BPComponentSkills)
            f1.Show()
        Else
            Dim f1 As New frmReqSkills(SkillType.BPReqSkills)
            f1.Show()
        End If
    End Sub

    Private Sub lblBPInventStatus_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lblBPT2InventStatus.DoubleClick
        Dim f1 As New frmReqSkills(SkillType.InventionReqSkills)
        f1.Show()
    End Sub

    Private Sub lblReverseEngineerStatus_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lblT3InventStatus.DoubleClick
        Dim f1 As New frmReqSkills(SkillType.REReqSkills)
        f1.Show()
    End Sub

    Private Sub txtBPCCosts_KeyPress(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyPressEventArgs)
        ' Only allow numbers or backspace
        If e.KeyChar <> ControlChars.Back Then
            If allowedPriceChars.IndexOf(e.KeyChar) = -1 Then
                ' Invalid Character
                e.Handled = True
            End If
        End If
    End Sub

    Private Sub chkBPBuildBuy_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkBPBuildBuy.CheckedChanged
        ' Disable the choice for raw or components for shopping list and just add components
        If Not FirstLoad And Not UpdatingCheck Then
            If chkBPBuildBuy.Checked Then
                rbtnBPComponentCopy.Enabled = True
                rbtnBPRawmatCopy.Enabled = False
            Else
                If Not IsNothing(SelectedBlueprint) Then
                    If SelectedBlueprint.HasComponents Then
                        rbtnBPComponentCopy.Enabled = True
                        rbtnBPRawmatCopy.Enabled = True
                    Else
                        rbtnBPComponentCopy.Enabled = False
                        rbtnBPRawmatCopy.Enabled = False
                    End If
                End If
            End If

            ' Refresh
            If Not IsNothing(SelectedBlueprint) Then
                Call UpdateBPGrids(SelectedBlueprint.GetTypeID, SelectedBlueprint.GetTechLevel, False, SelectedBlueprint.GetItemGroupID, SelectedBlueprint.GetItemCategoryID, SentFromLocation.BlueprintTab)
            End If

        End If

    End Sub

    Private Sub lstBPComponentMats_ColumnClick(ByVal sender As Object, ByVal e As System.Windows.Forms.ColumnClickEventArgs) Handles lstBPComponentMats.ColumnClick
        Call ListViewColumnSorter(e.Column, CType(lstBPComponentMats, ListView), BPCompColumnClicked, BPCompColumnSortType)
    End Sub

    Private Sub lstBPRawMats_ColumnClick(ByVal sender As Object, ByVal e As System.Windows.Forms.ColumnClickEventArgs) Handles lstBPRawMats.ColumnClick
        Call ListViewColumnSorter(e.Column, CType(lstBPRawMats, ListView), BPRawColumnClicked, BPRawColumnSortType)
    End Sub

    Private Sub ResetInventionBoxes()
        ' Reset Decrytpor
        ResetDecryptorCombos(0)

        lblBPInventionCost.Text = "0.00"
        lblBPRECost.Text = "0.00"
        lblBPInventionChance.Text = "0%"
        lblBPDecryptorStats.Text = "ME: 0, TE: 0," & vbCrLf & "BP Runs: 0"

    End Sub

    Private Sub ResetDecryptorCombos(InventionTech As Integer)
        LoadingInventionDecryptors = True
        LoadingT3Decryptors = True
        InventionDecryptorsLoaded = False
        T3DecryptorsLoaded = False

        Dim TempDecryptors As New DecryptorList

        ' Auto load the decryptor if they want
        If InventionTech = 2 Then
            If UserApplicationSettings.SaveBPRelicsDecryptors And UserBPTabSettings.T2DecryptorType <> "" Then
                cmbBPInventionDecryptor.Text = UserBPTabSettings.T2DecryptorType
                SelectedDecryptor = TempDecryptors.GetDecryptor(cmbBPInventionDecryptor.Text)
            Else
                cmbBPInventionDecryptor.Text = None
                SelectedDecryptor = NoDecryptor ' Reset the selected decryptor too
            End If
        ElseIf InventionTech = 3 Then
            ' Load for T3
            If UserApplicationSettings.SaveBPRelicsDecryptors And UserBPTabSettings.T3DecryptorType <> "" Then
                cmbBPT3Decryptor.Text = UserBPTabSettings.T3DecryptorType
                SelectedDecryptor = TempDecryptors.GetDecryptor(cmbBPT3Decryptor.Text)
            Else
                cmbBPT3Decryptor.Text = None
                SelectedDecryptor = NoDecryptor ' Reset the selected decryptor too
            End If

            ' Reset both
        Else
            cmbBPInventionDecryptor.Text = None
            cmbBPT3Decryptor.Text = None
            SelectedDecryptor = NoDecryptor ' Reset the selected decryptor too
        End If

        LoadingInventionDecryptors = False
        LoadingT3Decryptors = False

    End Sub

    Private Sub ResetfromTechSizeCheck()
        cmbBPsLoaded = False

        ComboMenuDown = False
        MouseWheelSelection = False
        ComboBoxArrowKeys = False
        BPComboKeyDown = False

        Call LoadBlueprintCombo()

        cmbBPBlueprintSelection.Text = "Select Blueprint"
        cmbBPBlueprintSelection.Focus()

    End Sub

    Private Sub btnReset_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnClearItemFilter.Click
        txtPriceItemFilter.Text = ""
        Call UpdatePriceList()
    End Sub

    Private Sub txtBPRuns_MouseWheel(sender As Object, e As MouseEventArgs) Handles txtBPRuns.MouseWheel
        If e.Delta > 0 Then
            ' UP
            txtBPRuns.Text = CStr(Val(txtBPRuns.Text) + 1)
        Else
            ' Down
            If Val(txtBPRuns.Text) <> 1 Then
                txtBPRuns.Text = CStr(Val(txtBPRuns.Text) - 1)
            End If
        End If
    End Sub

    Private Sub txtBPRuns_GotFocus(sender As Object, e As System.EventArgs) Handles txtBPRuns.GotFocus
        Call txtBPRuns.SelectAll()
    End Sub

    Private Sub txtBPRuns_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles txtBPRuns.KeyDown
        Call ProcessCutCopyPasteSelect(txtBPRuns, e)
        Call EnterKeyRunBP(e)
    End Sub

    Private Sub txtBPRuns_KeyPress(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyPressEventArgs) Handles txtBPRuns.KeyPress
        ' Only allow numbers or backspace
        If e.KeyChar <> ControlChars.Back Then
            If allowedRunschars.IndexOf(e.KeyChar) = -1 Then
                ' Invalid Character
                e.Handled = True
            End If
        End If
    End Sub

    Private Sub txtBPRuns_KeyUp(sender As Object, e As System.Windows.Forms.KeyEventArgs) Handles txtBPRuns.KeyUp
        If Not EnterKeyPressed Then
            EnterKeyPressed = False
        End If
    End Sub

    Private Sub txtBPRuns_LostFocus(sender As Object, e As System.EventArgs) Handles txtBPRuns.LostFocus
        If Not IgnoreFocus Then
            Call UpdateBPLinesandBPs()
            IgnoreFocus = True
        End If
    End Sub

    Private Sub txtBPAddlCosts_KeyDown(sender As Object, e As System.Windows.Forms.KeyEventArgs) Handles txtBPAddlCosts.KeyDown
        Call ProcessCutCopyPasteSelect(txtBPAddlCosts, e)
        Call EnterKeyRunBP(e)
    End Sub

    Private Sub txtBPAddlCosts_KeyPress(sender As Object, e As System.Windows.Forms.KeyPressEventArgs) Handles txtBPAddlCosts.KeyPress
        ' Only allow numbers or backspace
        If e.KeyChar <> ControlChars.Back Then
            If allowedPriceChars.IndexOf(e.KeyChar) = -1 Then
                ' Invalid Character
                e.Handled = True
            End If
        End If
    End Sub

    Private Sub txtBPAddlCosts_LostFocus(sender As Object, e As System.EventArgs) Handles txtBPAddlCosts.LostFocus
        If IsNumeric(txtBPAddlCosts.Text) Then
            txtBPAddlCosts.Text = FormatNumber(txtBPAddlCosts.Text, 2)
        ElseIf Trim(txtBPAddlCosts.Text) = "" Then
            txtBPAddlCosts.Text = "0.00"
        End If
    End Sub

    Private Sub txtBPME_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles txtBPME.KeyDown
        Call ProcessCutCopyPasteSelect(txtBPME, e)
        If e.KeyCode = Keys.Enter Then
            Call EnterKeyRunBP(e)
        End If
    End Sub

    Private Sub txtBPME_KeyPress(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyPressEventArgs) Handles txtBPME.KeyPress
        ' Only allow numbers or backspace
        If e.KeyChar <> ControlChars.Back Then
            If allowedMETEChars.IndexOf(e.KeyChar) = -1 Then
                ' Invalid Character
                e.Handled = True
            End If
        End If
    End Sub

    Private Sub txtBPME_TextChanged(sender As Object, e As System.EventArgs) Handles txtBPME.TextChanged
        Call VerifyMETEEntry(txtBPME, "ME")
    End Sub

    Private Sub txtBPME_LostFocus(sender As Object, e As System.EventArgs) Handles txtBPME.LostFocus
        If Trim(txtBPME.Text) = "" Then
            txtBPME.Text = "0"
        End If
    End Sub

    Private Sub txtBPTE_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles txtBPTE.KeyDown
        Call ProcessCutCopyPasteSelect(txtBPTE, e)
        If e.KeyCode = Keys.Enter Then
            Call EnterKeyRunBP(e)
        End If
    End Sub

    Private Sub txtBPTE_KeyPress(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyPressEventArgs) Handles txtBPTE.KeyPress
        ' Only allow numbers or backspace
        If e.KeyChar <> ControlChars.Back Then
            If allowedMETEChars.IndexOf(e.KeyChar) = -1 Then
                ' Invalid Character
                e.Handled = True
            End If
        End If
    End Sub

    Private Sub txtBPTE_TextChanged(sender As Object, e As System.EventArgs) Handles txtBPTE.TextChanged
        Call VerifyMETEEntry(txtBPTE, "TE")
    End Sub

    Private Sub txtBPTE_LostFocus(sender As Object, e As System.EventArgs) Handles txtBPTE.LostFocus
        If Trim(txtBPTE.Text) = "" Then
            txtBPTE.Text = "0"
        End If
    End Sub

    Private Sub chkBPFacilityIncludeUsage_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs)
        'If Not FirstLoad And Not ChangingUsageChecks And Not SentFromManufacturingTab Then
        '    If Not IsNothing(SelectedBlueprint) And Not SentFromManufacturingTab Then
        '        Call SetDefaultFacilitybyCheck(GetProductionType(cmbBPFacilityActivities.Text, SelectedBlueprint.GetItemGroupID, SelectedBlueprint.GetItemCategoryID, cmbBPFacilityType.Text),
        '                chkBPFacilityIncludeUsage, BPTab, cmbBPFacilityType.Text, cmbBPFacilityorArray,
        '                lblBPFacilityDefault, btnBPFacilitySave, Nothing, Nothing, ttBP)

        '        Call UpdateBPGrids(SelectedBlueprint.GetTypeID, SelectedBlueprint.GetTechLevel, False, SelectedBlueprint.GetItemGroupID, SelectedBlueprint.GetItemCategoryID)
        '    End If
        'End If
    End Sub

    Private Sub chkBPTaxesFees_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkBPTaxes.CheckedChanged
        If Not FirstLoad And SetTaxFeeChecks Then
            Call RefreshBPData()
        End If
    End Sub

    Private Sub chkBPBrokerFees_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkBPBrokerFees.CheckedChanged
        If Not FirstLoad And SetTaxFeeChecks Then
            Call RefreshBPData()
        End If
    End Sub

    Private Sub chkBPBrokerFees_Click(sender As Object, e As EventArgs) Handles chkBPBrokerFees.Click
        If chkBPBrokerFees.Checked And chkBPBrokerFees.CheckState = CheckState.Indeterminate Then ' Show rate box
            txtBPBrokerFeeRate.Visible = True
        Else
            txtBPBrokerFeeRate.Visible = False
        End If

        If Not FirstLoad And SetTaxFeeChecks Then
            Call RefreshBPData()
        End If
    End Sub

    Private Sub txtBPBrokerFeeRate_KeyDown(sender As Object, e As KeyEventArgs) Handles txtBPBrokerFeeRate.KeyDown
        If e.KeyCode = Keys.Enter Then
            txtBPBrokerFeeRate.Text = GetFormattedPercentEntry(txtBPBrokerFeeRate)
            Call RefreshBPData()
        End If
    End Sub

    Private Sub txtBPBrokerFeeRate_KeyPress(sender As Object, e As KeyPressEventArgs) Handles txtBPBrokerFeeRate.KeyPress
        ' Only allow numbers, decimal, percent or backspace
        If e.KeyChar <> ControlChars.Back Then
            If allowedPercentChars.IndexOf(e.KeyChar) = -1 Then
                ' Invalid Character
                e.Handled = True
            End If
        End If
    End Sub

    Private Sub txtBPBrokerFeeRate_GotFocus(sender As Object, e As EventArgs) Handles txtBPBrokerFeeRate.GotFocus
        Call txtBPBrokerFeeRate.SelectAll()
    End Sub

    Private Sub txtBPBrokerFeeRate_LostFocus(sender As Object, e As EventArgs) Handles txtBPBrokerFeeRate.LostFocus
        txtBPBrokerFeeRate.Text = GetFormattedPercentEntry(txtBPBrokerFeeRate)
        Call RefreshBPData()
    End Sub

    Public Sub RefreshBPData()
        If Not IsNothing(SelectedBlueprint) Then
            Call SelectedBlueprint.SetPriceData(chkBPTaxes.Checked, GetBrokerFeeData(chkBPBrokerFees, txtBPBrokerFeeRate))
            Call UpdateBPPriceLabels()
        End If
    End Sub

    Private Sub txtBPNumBPs_DoubleClick(sender As Object, e As System.EventArgs) Handles txtBPNumBPs.DoubleClick
        If Not IsNothing(SelectedBlueprint) Then
            txtBPNumBPs.Text = CStr(GetUsedNumBPs(SelectedBlueprint.GetTypeID, SelectedBlueprint.GetTechLevel, CInt(txtBPRuns.Text),
                                                  CInt(txtBPLines.Text), CInt(txtBPNumBPs.Text), SelectedDecryptor.RunMod))
        End If
    End Sub

    Private Sub txtBPNumBPs_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles txtBPNumBPs.KeyDown
        Call ProcessCutCopyPasteSelect(txtBPNumBPs, e)
        Call EnterKeyRunBP(e)
    End Sub

    Private Sub txtBPNumBPs_KeyPress(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyPressEventArgs) Handles txtBPNumBPs.KeyPress
        ' Only allow numbers or backspace
        If e.KeyChar <> ControlChars.Back Then
            If allowedRunschars.IndexOf(e.KeyChar) = -1 Then
                ' Invalid Character
                e.Handled = True
            End If
        End If
    End Sub

    Private Sub cmbBPInventionDecryptor_DropDown(ByVal sender As Object, ByVal e As System.EventArgs) Handles cmbBPInventionDecryptor.DropDown
        Call LoadBPInventionDecryptors()
    End Sub

    Private Sub LoadBPInventionDecryptors()
        If Not InventionDecryptorsLoaded Then
            ' Clear anything that was there
            cmbBPInventionDecryptor.Items.Clear()

            ' Add NONE
            cmbBPInventionDecryptor.Items.Add(None)

            Dim Decryptors As New DecryptorList

            For i = 0 To Decryptors.GetDecryptorList.Count - 1
                cmbBPInventionDecryptor.Items.Add(Decryptors.GetDecryptorList(i).Name)
            Next

            InventionDecryptorsLoaded = True

        End If
    End Sub

    Private Sub LoadBPT3InventionDecryptors()
        If Not T3DecryptorsLoaded Then
            ' Clear anything that was there
            cmbBPT3Decryptor.Items.Clear()

            ' Add NONE
            cmbBPT3Decryptor.Items.Add(None)

            Dim Decryptors As New DecryptorList

            For i = 0 To Decryptors.GetDecryptorList.Count - 1
                cmbBPT3Decryptor.Items.Add(Decryptors.GetDecryptorList(i).Name)
            Next

            T3DecryptorsLoaded = True

        End If
    End Sub

    Private Sub cmbBPInventionDecryptor_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbBPInventionDecryptor.SelectedIndexChanged

        ' Only load when the user selects a new decryptor from the list, not when changing the text
        If Not LoadingInventionDecryptors Then
            Call SelectDecryptor(cmbBPInventionDecryptor.Text)

            ' Reload the number of bps you need etc
            ' If the runs changed, update the lines data based on decryptor, need to update it first before running
            Call UpdateBPLinesandBPs()

            ' Use the original ME and TE values when they change the decryptor
            Call UpdateBPGrids(SelectedBlueprint.GetTypeID, SelectedBlueprint.GetTechLevel, False, SelectedBlueprint.GetItemGroupID, SelectedBlueprint.GetItemCategoryID, SentFromLocation.BlueprintTab)

        End If

    End Sub

    Private Sub cmbBPT3Decryptor_DropDown(sender As Object, e As System.EventArgs) Handles cmbBPT3Decryptor.DropDown
        Call LoadBPT3InventionDecryptors()
    End Sub

    Private Sub cmbBPREDecryptor_SelectedIndexChanged(sender As System.Object, e As System.EventArgs) Handles cmbBPT3Decryptor.SelectedIndexChanged

        ' Only load when the user selects a new decryptor from the list, not when changing the text
        If Not LoadingT3Decryptors Then
            Call SelectDecryptor(cmbBPT3Decryptor.Text)

            ' Reload the number of bps you need etc
            ' If the runs changed, update the lines data based on decryptor, need to update it first before running
            Call UpdateBPLinesandBPs()

            ' Use the original ME and TE values when they change the decryptor
            Call UpdateBPGrids(SelectedBlueprint.GetTypeID, SelectedBlueprint.GetTechLevel, False, SelectedBlueprint.GetItemGroupID, SelectedBlueprint.GetItemCategoryID, SentFromLocation.BlueprintTab)

        End If
    End Sub

    Private Sub cmbBPRelic_DropDown(sender As Object, e As System.EventArgs) Handles cmbBPRelic.DropDown

        If Not RelicsLoaded Then
            Call LoadRelicTypes(SelectedBlueprint.GetTypeID)
        End If

    End Sub

    Private Sub cmbBPRelic_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbBPRelic.SelectedIndexChanged

        If Not LoadingRelics Then
            ' Use the original values when selecting a new relic
            Call UpdateBPGrids(SelectedBlueprint.GetTypeID, SelectedBlueprint.GetTechLevel, False, SelectedBlueprint.GetItemGroupID, SelectedBlueprint.GetItemCategoryID, SentFromLocation.BlueprintTab)
        End If

    End Sub

    Private Sub SetInventionEnabled(InventionType As String, Enable As Boolean)
        If InventionType = "T2" Then
            chkBPIncludeCopyCosts.Enabled = Enable
            chkBPIncludeCopyTime.Enabled = Enable
            chkBPIncludeInventionCosts.Enabled = Enable
            chkBPIncludeInventionTime.Enabled = Enable

            txtBPInventionLines.Enabled = Enable
            cmbBPInventionDecryptor.Enabled = Enable
        Else
            chkBPIncludeT3Costs.Enabled = Enable
            chkBPIncludeT3Time.Enabled = Enable
            txtBPRelicLines.Enabled = Enable
            cmbBPT3Decryptor.Enabled = Enable
            cmbBPRelic.Enabled = Enable
        End If
    End Sub

    Private Sub chkBPIgnoreInvention_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkBPIgnoreInvention.CheckedChanged

        If Not UpdatingInventionChecks Then
            UpdatingInventionChecks = True

            If chkBPIgnoreInvention.Checked Then
                If tabBPInventionEquip.Contains(tabInventionCalcs) Then
                    ' Disable all first
                    Call SetInventionEnabled("T2", False)
                    Call BPTabFacility.SetIgnoreInvention(True, ProductionType.Invention, False)

                ElseIf tabBPInventionEquip.Contains(tabT3Calcs) Then
                    ' Disable all first
                    Call SetInventionEnabled("T3", False)
                    Call BPTabFacility.SetIgnoreInvention(True, ProductionType.T3Invention, False)
                End If

            Else ' Set it on the user settings
                If tabBPInventionEquip.Contains(tabInventionCalcs) Then
                    ' Enable all first
                    Call SetInventionEnabled("T2", True)
                    Call BPTabFacility.SetIgnoreInvention(False, ProductionType.Invention, True)

                ElseIf tabBPInventionEquip.Contains(tabT3Calcs) Then
                    ' Enable all first
                    Call SetInventionEnabled("T3", True)
                    Call BPTabFacility.SetIgnoreInvention(False, ProductionType.T3Invention, True)
                End If

            End If

            ' Reset the ME/TE for the BP based on the invention check
            If Not IsNothing(SelectedBlueprint) Then
                With SelectedBlueprint
                    Call SetInventionData(.GetBPID, .GetTechLevel, False, SentFromLocation.None, IsReaction(.GetItemGroupID))
                End With
            End If

            UpdatingInventionChecks = False

            ' If we are inventing, make sure we add or remove the activity based on the check
            If tabBPInventionEquip.Contains(tabInventionCalcs) Or tabBPInventionEquip.Contains(tabT3Calcs) Then
                If chkBPIgnoreInvention.Checked Then
                    txtBPME.Enabled = True
                    txtBPTE.Enabled = True
                Else
                    txtBPME.Enabled = False
                    txtBPTE.Enabled = False
                End If
            End If

            If Not FirstLoad And Not IgnoreRefresh Then
                Call RefreshBP()
            End If
        End If
    End Sub

    Private Sub chkBPIgnoreMinerals_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkBPIgnoreMinerals.CheckedChanged
        If Not FirstLoad Then
            Call RefreshBP()
        End If
    End Sub

    Private Sub chkBPIgnoreT1Item_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkBPIgnoreT1Item.CheckedChanged
        If Not FirstLoad Then
            Call RefreshBP()
        End If
    End Sub

    ' Loads the T3 Relic types into the combo box based on BP Selected
    Private Sub LoadRelicTypes(ByVal BPID As Long)
        Dim SQL As String
        Dim readerRelic As SQLiteDataReader
        Dim RelicName As String
        Dim UserRelicType As String = ""

        LoadingRelics = True

        SQL = "SELECT typeName FROM INVENTORY_TYPES, INDUSTRY_ACTIVITY_PRODUCTS WHERE productTypeID =" & BPID & " "
        SQL &= "AND typeID = blueprintTypeID AND activityID = 8"

        DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
        readerRelic = DBCommand.ExecuteReader

        If UserBPTabSettings.RelicType <> "" Then
            If UserBPTabSettings.RelicType.Contains(WreckedRelic) Then
                UserRelicType = WreckedRelic
            ElseIf UserBPTabSettings.RelicType.Contains(MalfunctioningRelic) Then
                UserRelicType = MalfunctioningRelic
            ElseIf UserBPTabSettings.RelicType.Contains(IntactRelic) Then
                UserRelicType = IntactRelic
            End If
        End If

        cmbBPRelic.Items.Clear()

        While readerRelic.Read
            RelicName = readerRelic.GetString(0)
            cmbBPRelic.Items.Add(RelicName)
            ' Load the name of the Wrecked Relic or base tactical destroyer relic in the combo when found 
            If RelicName.Contains(WreckedRelic) And UserBPTabSettings.RelicType = "" Then
                cmbBPRelic.Text = RelicName
            ElseIf UserRelicType <> "" Then
                If RelicName.Contains(UserRelicType) Then
                    cmbBPRelic.Text = RelicName
                End If
            End If
        End While

        readerRelic.Close()

        readerRelic = Nothing
        DBCommand = Nothing

        LoadingRelics = False
        RelicsLoaded = True

    End Sub

    Private Sub btnCopyMatstoClip_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnBPCopyMatstoClip.Click
        Dim ClipboardData = New DataObject
        Dim OutputText As String = ""
        Dim DecryptorText As String = ""
        Dim RelicText As String = ""
        Dim AddlText As String = ""
        Dim ExportFormat As String = ""

        If cmbBPInventionDecryptor.Text <> None Then
            DecryptorText = "Decryptor: " & cmbBPInventionDecryptor.Text
        End If

        If cmbBPRelic.Text <> None Then
            RelicText = "Relic: " & cmbBPRelic.Text
        End If

        If RelicText <> "" Then
            AddlText = ", " & RelicText
        Else
            ' Decryptor
            If DecryptorText <> "" Then
                AddlText = ", " & DecryptorText
            End If
        End If

        AddlText = ")" & Environment.NewLine & Environment.NewLine

        If chkBPSimpleCopy.Checked = False Then
            ExportFormat = UserApplicationSettings.DataExportFormat
        Else
            ExportFormat = MultiBuyDataExport
        End If

        If (rbtnBPRawmatCopy.Checked Or chkBPBuildBuy.Checked) And lstBPBuiltComponents.Visible = False Then
            If chkBPSimpleCopy.Checked = False Then
                OutputText = "Raw Material List for " & txtBPRuns.Text & " Units of '" & cmbBPBlueprintSelection.Text & "' (ME: " & CStr(txtBPME.Text) & AddlText
            End If
            OutputText = OutputText & SelectedBlueprint.GetRawMaterials.GetClipboardList(ExportFormat, False, False, False, UserApplicationSettings.IncludeInGameLinksinCopyText)
        ElseIf lstBPBuiltComponents.Visible Then
            If chkBPSimpleCopy.Checked = False Then
                OutputText = "Component Material List for " & txtBPRuns.Text & " Units of '" & cmbBPBlueprintSelection.Text & "' (ME: " & CStr(txtBPME.Text) & AddlText
            End If
            ' Put the list into materials
            Dim BuiltList As New Materials
            Dim BIMat As Material
            For Each BI In SelectedBlueprint.BuiltComponentList.GetBuiltItemList
                With BI
                    BIMat = New Material(.BPTypeID, .ItemName, "", .ItemQuantity, .ItemVolume, 0, CStr(.BuildME), CStr(.BuildTE), True)
                    Call BuiltList.InsertMaterial(BIMat)
                End With
            Next
            OutputText = OutputText & BuiltList.GetClipboardList(ExportFormat, False, False, False, UserApplicationSettings.IncludeInGameLinksinCopyText, True)
        Else
            If chkBPSimpleCopy.Checked = False Then
                OutputText = "Component Material List for " & txtBPRuns.Text & " Units of '" & cmbBPBlueprintSelection.Text & "' (ME: " & CStr(txtBPME.Text) & AddlText
            End If
            OutputText = OutputText & SelectedBlueprint.GetComponentMaterials.GetClipboardList(ExportFormat, False, False, False, UserApplicationSettings.IncludeInGameLinksinCopyText)
        End If

        If UserApplicationSettings.ShopListIncludeInventMats Then
            If Not IsNothing(SelectedBlueprint.GetInventionMaterials.GetMaterialList) Then
                If chkBPSimpleCopy.Checked = False Then
                    OutputText = OutputText & Environment.NewLine & Environment.NewLine & "Invention Materials" & Environment.NewLine & Environment.NewLine
                End If
                OutputText = OutputText & SelectedBlueprint.GetInventionMaterials.GetClipboardList(ExportFormat, False, False, False, UserApplicationSettings.IncludeInGameLinksinCopyText)
            End If
        End If

        ' Paste to clipboard
        Call CopyTextToClipboard(OutputText)

    End Sub

    Private Sub cmbBPInventionDecryptor_KeyPress(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyPressEventArgs) Handles cmbBPInventionDecryptor.KeyPress
        e.Handled = True
    End Sub

    Private Sub cmbBPREDecryptor_KeyPress(sender As Object, e As System.Windows.Forms.KeyPressEventArgs) Handles cmbBPT3Decryptor.KeyPress
        e.Handled = True
    End Sub

    Private Sub rbtnAllBlueprints_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles rbtnBPAllBlueprints.CheckedChanged
        If rbtnBPAllBlueprints.Checked Then
            Call ResetBlueprintCombo(True, True, True, True, True, True)
        End If
    End Sub

    Private Sub rbtnBPOwnedBlueprints_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles rbtnBPOwnedBlueprints.CheckedChanged
        If rbtnBPOwnedBlueprints.Checked Then
            Call ResetBlueprintCombo(True, True, True, True, True, True)
        End If
    End Sub

    'Private Sub chkBPIncludeIgnoredBPs_CheckedChanged(sender As System.Object, e As System.EventArgs)
    '    If chkBPIncludeIgnoredBPs.Checked Then
    '        Call ResetBlueprintCombo(True, True, True, True, True, True)
    '    End If
    'End Sub

    Private Sub rbtnShipBlueprints_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles rbtnBPShipBlueprints.CheckedChanged
        If rbtnBPShipBlueprints.Checked Then
            Call ResetBlueprintCombo(True, True, True, False, True, True)
        End If
    End Sub

    Private Sub rbtnModuleBlueprints_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles rbtnBPModuleBlueprints.CheckedChanged
        If rbtnBPModuleBlueprints.Checked Then
            Call ResetBlueprintCombo(True, True, False, True, True, False)
        End If
    End Sub

    Private Sub rbtnDroneBlueprints_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles rbtnBPDroneBlueprints.CheckedChanged
        If rbtnBPDroneBlueprints.Checked Then
            Call ResetBlueprintCombo(True, True, False, False, False, True)
        End If
    End Sub

    Private Sub rbtnComponentBlueprints_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles rbtnBPComponentBlueprints.CheckedChanged
        If rbtnBPComponentBlueprints.Checked Then
            Call ResetBlueprintCombo(True, False, False, False, False, False)
        End If
    End Sub

    Private Sub rbtnSubsystemBlueprints_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles rbtnBPSubsystemBlueprints.CheckedChanged
        If rbtnBPSubsystemBlueprints.Checked Then
            Call ResetBlueprintCombo(False, False, True, False, False, False)
        End If
    End Sub

    Private Sub rbtnToolBlueprints_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles rbtnBPMiscBlueprints.CheckedChanged
        If rbtnBPMiscBlueprints.Checked Then
            Call ResetBlueprintCombo(True, False, False, False, False, False)
        End If
    End Sub

    Private Sub rbtnAmmoChargeBlueprints_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles rbtnBPAmmoChargeBlueprints.CheckedChanged
        If rbtnBPAmmoChargeBlueprints.Checked Then
            Call ResetBlueprintCombo(True, True, False, False, False, False)
        End If
    End Sub

    Private Sub rbtnRigBlueprints_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles rbtnBPRigBlueprints.CheckedChanged
        If rbtnBPRigBlueprints.Checked Then
            Call ResetBlueprintCombo(True, True, False, False, False, False)
        End If
    End Sub

    Private Sub rbtnStructureBlueprints_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles rbtnBPStructureBlueprints.CheckedChanged
        If rbtnBPStructureBlueprints.Checked Then
            Call ResetBlueprintCombo(True, False, False, False, False, True)
        End If
    End Sub

    Private Sub rbtnBoosterBlueprints_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles rbtnBPBoosterBlueprints.CheckedChanged
        If rbtnBPBoosterBlueprints.Checked Then
            Call ResetBlueprintCombo(True, False, False, False, False, False)
        End If
    End Sub

    Private Sub rbtnBPDeployableBlueprints_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles rbtnBPDeployableBlueprints.CheckedChanged
        If rbtnBPDeployableBlueprints.Checked Then
            Call ResetBlueprintCombo(True, True, False, False, False, False)
        End If
    End Sub

    Private Sub rbtnBPStationPartsBlueprints_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles rbtnBPStructureRigsBlueprints.CheckedChanged
        If rbtnBPStructureRigsBlueprints.Checked Then
            Call ResetBlueprintCombo(True, False, False, False, False, False)
        End If
    End Sub

    Private Sub rbtnBPStationModulesBlueprints_CheckedChanged(sender As Object, e As EventArgs) Handles rbtnBPStructureModulesBlueprints.CheckedChanged
        If rbtnBPStructureModulesBlueprints.Checked Then
            Call ResetBlueprintCombo(True, False, False, False, False, False)
        End If
    End Sub

    Private Sub rbtnBPReactionsBlueprints_CheckedChanged(sender As Object, e As EventArgs) Handles rbtnBPReactionsBlueprints.CheckedChanged
        If rbtnBPReactionsBlueprints.Checked Then
            Call ResetBlueprintCombo(True, False, False, False, False, False)
        End If
    End Sub

    Private Sub rbtnBPCelestialBlueprints_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles rbtnBPCelestialsBlueprints.CheckedChanged
        If rbtnBPCelestialsBlueprints.Checked Then
            Call ResetBlueprintCombo(True, False, False, False, False, False)
        End If
    End Sub

    Private Sub rbtnBPFavoriteBlueprints_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles rbtnBPFavoriteBlueprints.CheckedChanged
        If rbtnBPFavoriteBlueprints.Checked Then
            Call ResetBlueprintCombo(True, True, True, True, True, True)
        End If
    End Sub

    Private Sub chkBPNPCBPOs_CheckedChanged(sender As Object, e As EventArgs) Handles chkBPNPCBPOs.CheckedChanged
        Call ResetBlueprintCombo(True, False, False, False, False, False)
    End Sub

    Private Sub chkbpT1_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkBPT1.CheckedChanged
        If Not FirstLoad Then
            Call ResetfromTechSizeCheck()
            If chkBPT1.Checked Then
                chkBPNPCBPOs.Enabled = True
            Else
                chkBPNPCBPOs.Enabled = False
            End If
        End If
    End Sub

    Private Sub chkbpT2_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkBPT2.CheckedChanged
        If Not FirstLoad Then
            Call ResetfromTechSizeCheck()
        End If
    End Sub

    Private Sub chkbpT3_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkBPT3.CheckedChanged
        If Not FirstLoad Then
            Call ResetfromTechSizeCheck()
        End If
    End Sub

    Private Sub chkBPNavyFaction_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkBPNavyFaction.CheckedChanged
        If Not FirstLoad Then
            Call ResetfromTechSizeCheck()
        End If
    End Sub

    Private Sub chkBPPirateFaction_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkBPPirateFaction.CheckedChanged
        If Not FirstLoad Then
            Call ResetfromTechSizeCheck()
        End If
    End Sub

    Private Sub chkBPStoryline_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkBPStoryline.CheckedChanged
        If Not FirstLoad Then
            Call ResetfromTechSizeCheck()
        End If
    End Sub

    Private Sub chkBPSmall_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkBPSmall.CheckedChanged
        If Not FirstLoad Then
            Call ResetfromTechSizeCheck()
        End If
    End Sub

    Private Sub chkBPMedium_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkBPMedium.CheckedChanged
        If Not FirstLoad Then
            Call ResetfromTechSizeCheck()
        End If
    End Sub

    Private Sub chkBPLarge_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkBPLarge.CheckedChanged
        If Not FirstLoad Then
            Call ResetfromTechSizeCheck()
        End If
    End Sub

    Private Sub chkBPXL_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkBPXL.CheckedChanged
        If Not FirstLoad Then
            Call ResetfromTechSizeCheck()
        End If
    End Sub

    Private Sub btnRefreshBP_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnBPRefreshBP.Click
        Call RefreshBP()
    End Sub

    Private Sub chkBPSellExcessItems_CheckedChanged(sender As Object, e As EventArgs) Handles chkBPSellExcessItems.CheckedChanged
        Call RefreshBP()
    End Sub

    Public Sub RefreshBP(Optional IgnoreFocus As Boolean = False)
        If CorrectMETE(txtBPME.Text, txtBPTE.Text, txtBPME, txtBPTE) Then
            If Not IsNothing(SelectedBlueprint) Then
                Call UpdateBPGrids(SelectedBlueprint.GetTypeID, SelectedBlueprint.GetTechLevel, False, SelectedBlueprint.GetItemGroupID, SelectedBlueprint.GetItemCategoryID, SentFromLocation.BlueprintTab)
                txtBPRuns.SelectAll()
                If Not IgnoreFocus Then
                    txtBPRuns.Focus()
                End If
            End If
        End If
    End Sub

    Private Sub lstBPComponentMats_MouseClick(sender As Object, e As MouseEventArgs) Handles lstBPComponentMats.MouseClick
        Call ListClicked(lstBPComponentMats, sender, e)
    End Sub

    Private Sub lstBPComponentMats_MouseDown(sender As Object, e As MouseEventArgs) Handles lstBPComponentMats.MouseDown
        inhibitAutoCheck = True
    End Sub

    Private Sub lstBPComponentMats_MouseUp(sender As Object, e As MouseEventArgs) Handles lstBPComponentMats.MouseUp
        inhibitAutoCheck = False
    End Sub

    Private Sub lstBPComponentMats_ItemCheck(sender As Object, e As ItemCheckEventArgs) Handles lstBPComponentMats.ItemCheck
        ' If ClickedCheckBox(e, lstBPComponentMats.Items.Count) Then
        If inhibitAutoCheck Then
            e.NewValue = e.CurrentValue
        End If
        'End If
    End Sub

    Private Sub lstBPComponentMats_ItemChecked(sender As Object, e As ItemCheckedEventArgs) Handles lstBPComponentMats.ItemChecked
        If Not IgnoreListViewItemChecks Then
            ' Process user checks, insert the item id and the check state in the bb list
            Dim CheckedItem As New BuildBuyItem

            CheckedItem.BuildItem = e.Item.Checked
            CheckedItem.ItemID = GetTypeID(RemoveItemNameRuns(e.Item.SubItems(0).Text))

            ' See if we can build this or not, if not, just uncheck the box and exit - don't refresh the bp
            Dim SQL As String
            Dim readerIT As SQLiteDataReader

            SQL = "SELECT 'X' FROM ALL_BLUEPRINTS WHERE ITEM_ID = " & CheckedItem.ItemID
            DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
            readerIT = DBCommand.ExecuteReader()

            If readerIT.Read Then
                readerIT.Close()
            Else
                ' Can't build it
                IgnoreListViewItemChecks = True
                e.Item.Checked = False
                IgnoreListViewItemChecks = False
                readerIT.Close()
                Exit Sub
            End If

            Dim FoundItem As New BuildBuyItem

            ' Look up the list of BB Items and add the ItemID if not in the list, else make sure we have the correct toggle option
            BBItemtoFind = CheckedItem.ItemID
            FoundItem = BBItems.Find(AddressOf FindBBItem)

            ' If found, then update the preference
            If FoundItem.ItemID <> 0 Then
                Call BBItems.Remove(FoundItem)
                FoundItem.BuildItem = CheckedItem.BuildItem
                Call BBItems.Add(FoundItem)
            Else
                ' new item, so just add it
                Call BBItems.Add(CheckedItem)
            End If

            '' See if the BB Items for the BP are in the list
            'BPBBItemtoFind = SelectedBlueprint.GetBPID
            'FoundBPItem = BPBBItems.Find(AddressOf FindBPBBItem)

            '' See if the item checked is in the list, if so, update the temp, remove the old items and replace
            'If FoundBPItem.BPID <> 0 Then
            '    ' In list, so just add the item to the found BP item if not there or update if there
            '    For Each Item In FoundBPItem.BBItems
            '        If Item.ItemID = CheckedItem.ItemID Then
            '            ' just remove it then add later
            '            FoundBPItem.BBItems.Remove(Item)
            '            Exit For
            '        End If
            '    Next
            '    ' Add the item with current info
            '    FoundBPItem.BBItems.Add(CheckedItem)
            'Else
            '    ' New item to add, now add the item that was toggled
            '    TempBPItem.BPID = SelectedBlueprint.GetBPID
            '    TempBPItem.BBItems = New List(Of BuildBuyItem)
            '    TempBPItem.BBItems.Add(CheckedItem)
            '    Call BPBBItems.Add(TempBPItem)
            'End If

            If Not FirstLoad And Not IgnoreRefresh Then
                Call RefreshBP()
            End If

        End If
    End Sub

    Private Sub lstBPRawMats_MouseClick(sender As Object, e As System.Windows.Forms.MouseEventArgs) Handles lstBPRawMats.MouseClick
        Call ListClicked(lstBPRawMats, sender, e)
    End Sub

    Private Sub EnterKeyRunBP(ByVal e As System.Windows.Forms.KeyEventArgs)
        If CorrectMETE(txtBPME.Text, txtBPTE.Text, txtBPME, txtBPTE) Then
            If e.KeyCode = Keys.Enter Then
                EnterKeyPressed = True
                Call UpdateBPGrids(SelectedBlueprint.GetTypeID, SelectedBlueprint.GetTechLevel, False, SelectedBlueprint.GetItemGroupID, SelectedBlueprint.GetItemCategoryID, SentFromLocation.BlueprintTab)
                txtBPRuns.SelectAll()
                IgnoreFocus = True
                txtBPRuns.Focus()
                IgnoreFocus = False
            End If
        End If
    End Sub

    Private Sub btnBPBack_Click(sender As System.Object, e As System.EventArgs) Handles btnBPBack.Click
        Call LoadPreviousBlueprint()
    End Sub

    Private Sub btnBPForward_Click(sender As System.Object, e As System.EventArgs) Handles btnBPForward.Click
        Call LoadNextBlueprint()
    End Sub

    Private Sub tabBPInventionEquip_Click(sender As System.Object, e As System.EventArgs) Handles tabBPInventionEquip.Click
        SelectedBPTabIndex = tabBPInventionEquip.SelectedIndex
    End Sub

    Private Sub txtBPUpdateCostIndex_GotFocus(sender As Object, e As System.EventArgs) Handles txtBPUpdateCostIndex.GotFocus
        txtBPUpdateCostIndex.SelectAll()
    End Sub

    Private Sub txtBPUpdateCostIndex_KeyDown(sender As Object, e As System.Windows.Forms.KeyEventArgs) Handles txtBPUpdateCostIndex.KeyDown
        Call ProcessCutCopyPasteSelect(txtBPUpdateCostIndex, e)
        Call EnterKeyRunBP(e)
    End Sub

    Private Sub txtBPUpdateCostIndex_KeyPress(sender As Object, e As System.Windows.Forms.KeyPressEventArgs) Handles txtBPUpdateCostIndex.KeyPress
        ' Only allow numbers or backspace
        If e.KeyChar <> ControlChars.Back Then
            If allowedPercentChars.IndexOf(e.KeyChar) = -1 Then
                ' Invalid Character
                e.Handled = True
            Else
                btnBPUpdateCostIndex.Enabled = True
            End If
        End If
    End Sub

    Private Sub txtBPUpdateCostIndex_LostFocus(sender As Object, e As System.EventArgs) Handles txtBPUpdateCostIndex.LostFocus
        If IsNumeric(txtBPAddlCosts.Text) Then
            txtBPAddlCosts.Text = FormatNumber(txtBPAddlCosts.Text, 2)
        ElseIf Trim(txtBPAddlCosts.Text) = "" Then
            txtBPAddlCosts.Text = "0.00"
        End If
    End Sub

    Private Sub txtBPMarketPriceEdit_GotFocus(sender As Object, e As System.EventArgs) Handles txtBPMarketPriceEdit.GotFocus
        txtBPMarketPriceEdit.SelectAll()
    End Sub

    Private Sub txtBPMarketPriceEdit_KeyDown(sender As Object, e As System.Windows.Forms.KeyEventArgs) Handles txtBPMarketPriceEdit.KeyDown
        If Not DataEntered Then ' If data already entered, then they didn't do it through paste
            DataEntered = ProcessCutCopyPasteSelect(txtBPMarketPriceEdit, e)
        End If

        If e.KeyCode = Keys.Enter Then
            IgnoreMarketFocus = True
            ' Update the price for this item
            Call UpdateMarketPriceManually()
            IgnoreMarketFocus = False
        End If
    End Sub

    Private Sub txtBPMarketPriceEdit_KeyPress(sender As Object, e As System.Windows.Forms.KeyPressEventArgs) Handles txtBPMarketPriceEdit.KeyPress
        ' Make sure it's the right format for Price update
        ' Only allow numbers or backspace
        If e.KeyChar <> ControlChars.Back Then
            If allowedPriceChars.IndexOf(e.KeyChar) = -1 Then
                ' Invalid Character
                e.Handled = True
            End If
        End If

    End Sub

    Private Sub txtBPMarketPriceEdit_LostFocus(sender As Object, e As System.EventArgs) Handles txtBPMarketPriceEdit.LostFocus
        If Not IgnoreMarketFocus And txtBPMarketPriceEdit.Text <> lblBPMarketCost.Text Then
            Call UpdateMarketPriceManually()
        End If
        txtBPMarketPriceEdit.Visible = False
    End Sub

    Private Sub UpdateMarketPriceManually()
        If Trim(txtBPMarketPriceEdit.Text) <> "" Then
            Dim SQL As String = "UPDATE ITEM_PRICES_FACT SET PRICE = " & CStr(CDbl(txtBPMarketPriceEdit.Text)) & ", PRICE_TYPE = 'User' WHERE ITEM_ID = " & SelectedBlueprint.GetItemID
            Call EVEDB.ExecuteNonQuerySQL(SQL)
            Call PlayNotifySound()
            lblBPMarketCost.Text = FormatNumber(txtBPMarketPriceEdit.Text, 2)
            IgnoreFocus = True
        End If
        Call RefreshBP()
    End Sub

    Private Sub lblBPBPSVR_DoubleClick(sender As Object, e As System.EventArgs) Handles lblBPBPSVR.DoubleClick
        If chkBPBuildBuy.Checked Then
            lblBPBPSVR.Text = GetBPItemSVR(SelectedBlueprint.GetTotalProductionTime) ' use total time since they are both the same
        Else
            lblBPBPSVR.Text = GetBPItemSVR(SelectedBlueprint.GetProductionTime) ' just bp time
        End If
    End Sub

    Private Sub lblBPRawSVR_DoubleClick(sender As Object, e As System.EventArgs) Handles lblBPRawSVR.DoubleClick
        lblBPRawSVR.Text = GetBPItemSVR(SelectedBlueprint.GetTotalProductionTime) ' total time to build everything
    End Sub

    Private Sub lblBPCompProfit_DoubleClick(sender As System.Object, e As System.EventArgs) Handles lblBPCompProfit.DoubleClick
        If lblBPCompProfit1.Text.Contains("Percent") Then
            ' Swap to profit
            lblBPCompProfit.Text = FormatNumber(SelectedBlueprint.GetTotalComponentProfit, 2)
            lblBPCompProfit1.Text = "Component Profit:"
        Else
            lblBPCompProfit.Text = FormatPercent(SelectedBlueprint.GetTotalComponentProfitPercent, 2)
            lblBPCompProfit1.Text = "Component Profit Percent:"
        End If
    End Sub

    Private Sub lblBPRawProfit_DoubleClick(sender As System.Object, e As System.EventArgs) Handles lblBPRawProfit.DoubleClick
        If lblBPRawProfit1.Text.Contains("Percent") Then
            ' Swap to profit
            lblBPRawProfit.Text = FormatNumber(SelectedBlueprint.GetTotalRawProfit, 2)
            lblBPRawProfit1.Text = "Raw Profit:"
        Else
            lblBPRawProfit.Text = FormatPercent(SelectedBlueprint.GetTotalRawProfitPercent, 2)
            lblBPRawProfit1.Text = "Raw Profit Percent:"
        End If
    End Sub

    Private Sub lstBPComponentMats_DoubleClick(sender As Object, e As System.EventArgs) Handles lstBPComponentMats.DoubleClick

        ' If the item doesn't have an ME (set to "-") then don't load
        If lstBPComponentMats.SelectedItems.Count <> 0 Then
            If lstBPComponentMats.SelectedItems(0).SubItems(2).Text <> "-" Then
                Dim rsBP As SQLiteDataReader
                Dim SQL As String
                Dim BuildType As String = ""
                Dim TempItemName As String = lstBPComponentMats.SelectedItems(0).SubItems(0).Text

                ' Strip off any extra text
                If lstBPComponentMats.SelectedItems(0).SubItems(0).Text.Contains("(") Then
                    TempItemName = TempItemName.Substring(0, InStr(TempItemName, "(") - 2)
                End If

                SQL = "SELECT BLUEPRINT_ID, PORTION_SIZE, ITEM_GROUP_ID, ITEM_CATEGORY_ID, BLUEPRINT_NAME FROM ALL_BLUEPRINTS WHERE ITEM_NAME ="
                SQL &= "'" & TempItemName & "'"

                DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
                rsBP = DBCommand.ExecuteReader()
                rsBP.Read()

                If chkBPBuildBuy.Checked Then
                    BuildType = "Build/Buy"
                End If

                ' Adjust the runs for porition size needed and use that instead
                Dim BPID As Long = rsBP.GetInt64(0)
                Dim Runs As Long = CLng(lstBPComponentMats.SelectedItems(0).SubItems(1).Text)

                Dim GroupID As Integer = rsBP.GetInt32(2)
                Dim CategoryID As Integer = rsBP.GetInt32(3)
                Dim BPName As String = rsBP.GetString(4)

                rsBP.Close()

                Dim SelectedActivity As String = ""
                If BPName.Contains("Reaction Formula") Then
                    SelectedActivity = ManufacturingFacility.ActivityReactions
                Else
                    SelectedActivity = ManufacturingFacility.ActivityManufacturing
                End If

                With BPTabFacility
                    Call LoadBPfromEvent(BPID, BuildType, None, SentFromLocation.BlueprintTab,
                                    .GetSelectedManufacturingFacility(GroupID, CategoryID, SelectedActivity), .GetFacility(ProductionType.ComponentManufacturing),
                                    .GetFacility(ProductionType.CapitalComponentManufacturing),
                                    .GetSelectedInventionFacility(GroupID, CategoryID), .GetFacility(ProductionType.Copying),
                                    chkBPTaxes.Checked, GetBrokerFeeData(chkBPBrokerFees, txtBPBrokerFeeRate),
                                    lstBPComponentMats.SelectedItems(0).SubItems(2).Text, txtBPTE.Text,
                                    CStr(Runs), txtBPLines.Text, txtBPInventionLines.Text,
                                    "1", txtBPAddlCosts.Text, chkBPPricePerUnit.Checked) ' Use 1 bp for now
                End With
            End If
        End If
    End Sub

    Private Sub lstPricesView_ColumnWidthChanging(sender As Object, e As System.Windows.Forms.ColumnWidthChangingEventArgs) Handles lstPricesView.ColumnWidthChanging
        If e.ColumnIndex = 0 Or e.ColumnIndex >= 4 Then
            e.Cancel = True
            e.NewWidth = lstPricesView.Columns(e.ColumnIndex).Width
        End If
    End Sub

    Private Sub btnBPListMats_Click(sender As Object, e As EventArgs) Handles btnBPListMats.Click
        If Not IsNothing(SelectedBlueprint) Then
            Dim BFI As BrokerFeeInfo = GetBrokerFeeData(chkBPBrokerFees, txtBPBrokerFeeRate)
            Dim f1 As New frmMaterialListViewer(SelectedBlueprint.GetExcessMaterials, chkBPTaxes.Checked, BFI)
            Call f1.Show()
        End If
    End Sub

    ' Makes sure we have a tech checked for blueprints
    Private Sub EnsureBPTechCheck()
        If chkBPT1.Enabled And chkBPT1.Checked Then
            Exit Sub
        ElseIf chkBPT2.Enabled And chkBPT2.Checked Then
            Exit Sub
        ElseIf chkBPT3.Enabled And chkBPT3.Checked Then
            Exit Sub
        ElseIf chkBPNavyFaction.Enabled And chkBPNavyFaction.Checked Then
            Exit Sub
        ElseIf chkBPPirateFaction.Enabled And chkBPPirateFaction.Checked Then
            Exit Sub
        ElseIf chkBPStoryline.Enabled And chkBPStoryline.Checked Then
            Exit Sub
        End If

        ' If here, then none are checked that are enabled, find the first one enabled and check it
        If chkBPT1.Enabled Then
            chkBPT1.Checked = True
            Exit Sub
        ElseIf chkBPT2.Enabled Then
            chkBPT2.Checked = True
            Exit Sub
        ElseIf chkBPT3.Enabled Then
            chkBPT3.Checked = True
            Exit Sub
        ElseIf chkBPNavyFaction.Enabled Then
            chkBPNavyFaction.Checked = True
            Exit Sub
        ElseIf chkBPPirateFaction.Enabled Then
            chkBPPirateFaction.Checked = True
            Exit Sub
        ElseIf chkBPStoryline.Enabled Then
            chkBPStoryline.Checked = True
            Exit Sub
        End If

    End Sub

#End Region

#Region "BP Combo / List Processing "

    Private Sub cmbBPBlueprintSelection_DropDown(sender As Object, e As System.EventArgs) Handles cmbBPBlueprintSelection.DropDown
        ' If you drop down, don't show the text window
        'cmbBPBlueprintSelection.AutoCompleteMode = AutoCompleteMode.None
        lstBPList.Hide()
        ComboMenuDown = True
        ' if we drop down, we aren't using the arrow keys
        ComboBoxArrowKeys = False
        BPComboKeyDown = False
    End Sub

    Private Sub cmbBPBlueprintSelection_DropDownClosed(sender As Object, e As System.EventArgs) Handles cmbBPBlueprintSelection.DropDownClosed
        ' If it closes up, re-enable autocomplete
        'cmbBPBlueprintSelection.AutoCompleteMode = AutoCompleteMode.SuggestAppend
        ComboMenuDown = False
        lstBPList.Hide() ' This could show up if people type into the list when combo down
        'Call SelectBlueprint() ' Loads in selectionchangecommitted
        cmbBPBlueprintSelection.Focus()
    End Sub

    Private Sub cmbBPBlueprintSelection_MouseWheel(sender As Object, e As System.Windows.Forms.MouseEventArgs) Handles cmbBPBlueprintSelection.MouseWheel
        ' Only set mouse boolean when the combo isn't dropped down since users might want to use the wheel and click to select
        If ComboMenuDown Then
            MouseWheelSelection = False
        Else
            MouseWheelSelection = True
            cmbBPBlueprintSelection.Focus()
        End If

    End Sub

    Private Sub cmbBPBlueprintSelection_DoubleClick(sender As Object, e As EventArgs) Handles cmbBPBlueprintSelection.DoubleClick
        cmbBPBlueprintSelection.SelectAll()
    End Sub

    Private Sub cmbBPBlueprintSelection_LostFocus(sender As Object, e As EventArgs) Handles cmbBPBlueprintSelection.LostFocus
        ' Close the list view when lost focus
        Call lstBPList.Hide()
        Call cmbBPBlueprintSelection.SelectAll()
    End Sub

    ' Thrown when the user changes the value in the combo box
    Private Sub cmbBPBlueprintSelection_SelectionChangeCommitted(sender As Object, e As System.EventArgs) Handles cmbBPBlueprintSelection.SelectionChangeCommitted

        If Not MouseWheelSelection And Not ComboBoxArrowKeys Then
            lstBPList.Visible = False ' We are loading the bp, so hide this
            BPSelected = True
            Call LoadBPFromCombo()
        End If

        BPSelected = False

    End Sub

    ' Load the list box when the user types and don't use the drop down list
    Private Sub cmbBPBlueprintSelection_TextChanged(sender As System.Object, e As System.EventArgs) Handles cmbBPBlueprintSelection.TextChanged
        If Not FirstLoad And Not BPSelected And Trim(cmbBPBlueprintSelection.Text) <> "Select Blueprint" And BPComboKeyDown Then
            If ComboBoxArrowKeys = False Then
                If (cmbBPBlueprintSelection.Text <> "") Then
                    GetBPWithName(cmbBPBlueprintSelection.Text)
                End If
                If (String.IsNullOrEmpty(cmbBPBlueprintSelection.Text)) Then
                    lstBPList.Items.Clear()
                    lstBPList.Visible = False
                End If
            End If
        End If
    End Sub

    ' Process keys for bp combo
    Private Sub cmbBPBlueprintSelection_KeyDown(sender As Object, e As System.Windows.Forms.KeyEventArgs) Handles cmbBPBlueprintSelection.KeyDown

        If cmbBPBlueprintSelection.DroppedDown = False Then
            BPComboKeyDown = True
        Else
            BPComboKeyDown = False
        End If

        If e.KeyValue = Keys.Up Or e.KeyValue = Keys.Down Then
            ComboBoxArrowKeys = True
        Else
            ComboBoxArrowKeys = False
        End If

        ' If they hit the arrow keys when the combo is dropped down (just in the combo it won't throw this)
        If lstBPList.Visible = False Then
            ' If they select enter, then load the BP
            If e.KeyValue = Keys.Enter Then
                Call LoadBPFromCombo()
            End If
        Else
            ' They have the list down, so process up and down keys to work with selecting in the list
            e.Handled = True ' Don't process up and down in the combo when the list shown
            Select Case (e.KeyCode)
                Case Keys.Down
                    If (lstBPList.SelectedIndex < lstBPList.Items.Count - 1) Then
                        lstBPList.SelectedIndex = lstBPList.SelectedIndex + 1
                    End If
                Case Keys.Up
                    If (lstBPList.SelectedIndex > 0) Then
                        lstBPList.SelectedIndex = lstBPList.SelectedIndex - 1
                    End If
                Case Keys.Enter
                    If (lstBPList.SelectedIndex > -1) Then
                        SelectedBPText = lstBPList.SelectedItem.ToString()
                        cmbBPBlueprintSelection.Text = SelectedBPText
                        lstBPList.Visible = False
                        BPSelected = True
                        Call SelectBlueprint()
                        BPSelected = False
                    End If
                Case Keys.Escape
                    lstBPList.Visible = False
            End Select
        End If

    End Sub

    Private Sub cmbBlueprintSelection_GotFocus(ByVal sender As System.Object, ByVal e As System.EventArgs)
        Call cmbBPBlueprintSelection.SelectAll()
    End Sub

    ' Process up down arrows in bp list
    Private Sub lstBPList_SelectedValueChanged(sender As Object, e As EventArgs) Handles lstBPList.SelectedValueChanged
        If Not IsNothing(lstBPList.SelectedItem) Then
            cmbBPBlueprintSelection.Text = lstBPList.SelectedItem.ToString
            cmbBPBlueprintSelection.SelectAll()
        End If
    End Sub

    ' Loads the item by clicking on the item selected
    Private Sub lstBPList_MouseDown(sender As Object, e As MouseEventArgs) Handles lstBPList.MouseDown
        If lstBPList.SelectedItems.Count <> 0 Then
            SelectedBPText = lstBPList.SelectedItem.ToString()
            cmbBPBlueprintSelection.Text = SelectedBPText
            lstBPList.Visible = False
            Call SelectBlueprint()
            cmbBPBlueprintSelection.SelectAll()
            txtBPRuns.Focus()
        End If
    End Sub

    Private Sub lstBPList_MouseMove(sender As Object, e As MouseEventArgs) Handles lstBPList.MouseMove
        Dim Index As Integer = lstBPList.IndexFromPoint(e.X, e.Y)

        RemoveHandler lstBPList.SelectedValueChanged, AddressOf lstBPList_SelectedValueChanged
        lstBPList.SelectedIndex = Index
        AddHandler lstBPList.SelectedValueChanged, AddressOf lstBPList_SelectedValueChanged
    End Sub

    Private Sub lstBPList_LostFocus(sender As Object, e As EventArgs) Handles lstBPList.LostFocus
        ' hide when losing focus
        Call lstBPList.Hide()
        Call cmbBPBlueprintSelection.SelectAll()
    End Sub

    ' Loads the blueprint combo based on what was selected
    Private Sub LoadBlueprintCombo()
        Dim readerBPs As SQLiteDataReader
        Dim SQL As String = ""

        Application.UseWaitCursor = True
        If Not cmbBPsLoaded Then
            ' Clear anything that was there
            cmbBPBlueprintSelection.Items.Clear()
            cmbBPBlueprintSelection.BeginUpdate()

            ' Core Query ' Get rid of 's in blueprint name for sorting
            If Me.rbtnBPOwnedBlueprints.Checked Or Me.rbtnBPFavoriteBlueprints.Checked Then
                SQL = BuildBPSelectQuery()
            Else
                SQL = "SELECT ALL_BLUEPRINTS.BLUEPRINT_NAME, REPLACE(LOWER(BLUEPRINT_NAME),'''','') AS X FROM ALL_BLUEPRINTS, INVENTORY_TYPES AS IT, INVENTORY_TYPES AS IT2 "
                SQL &= "WHERE ALL_BLUEPRINTS.ITEM_ID = IT.typeID AND ALL_BLUEPRINTS.BLUEPRINT_ID = IT2.typeID "
                SQL &= BuildBPSelectQuery()
            End If

            If SQL = "" Then
                Application.UseWaitCursor = False
                Exit Sub
            End If

            SQL &= " ORDER BY X"

            DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
            readerBPs = DBCommand.ExecuteReader

            While readerBPs.Read
                ' Add the data to the array and combo
                cmbBPBlueprintSelection.Items.Add(Trim(readerBPs.GetString(0)))
                Application.DoEvents()
            End While

            readerBPs.Close()

            readerBPs = Nothing
            DBCommand = Nothing

            cmbBPBlueprintSelection.EndUpdate()

            cmbBPsLoaded = True

        End If
        Application.UseWaitCursor = False

    End Sub

    Private Sub GetBPWithName(bpName As String)
        ' Query: SELECT BLUEPRINT_NAME AS bpName FROM ALL_BLUEPRINTS b, INVENTORY_TYPES t WHERE b.ITEM_ID = t.typeID AND bpName LIKE '%Repair%'
        Dim readerBP As SQLiteDataReader
        Dim SQL As String = ""

        cmbBPBlueprintSelection.Text = bpName
        lstBPList.Items.Clear()

        ' Add limiting functions here based on radio buttons
        ' Use replace to Get rid of 's in blueprint name for sorting
        If Me.rbtnBPOwnedBlueprints.Checked Or Me.rbtnBPFavoriteBlueprints.Checked Then
            SQL = BuildBPSelectQuery()
        Else
            SQL = "SELECT ALL_BLUEPRINTS.BLUEPRINT_NAME, REPLACE(LOWER(BLUEPRINT_NAME),'''','') AS X FROM ALL_BLUEPRINTS, INVENTORY_TYPES AS IT2 "
            SQL &= "WHERE ALL_BLUEPRINTS.ITEM_ID = IT2.typeID "
            SQL &= BuildBPSelectQuery()
            SQL &= " AND ALL_BLUEPRINTS.BLUEPRINT_NAME LIKE '%" & FormatDBString(bpName) & "%'"
            SQL &= " ORDER BY X"
        End If

        ' query = "SELECT BLUEPRINT_NAME AS bpName FROM ALL_BLUEPRINTS b, INVENTORY_TYPES t WHERE b.ITEM_ID = t.typeID AND bpName LIKE '%" & bpName & "%'"

        DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
        readerBP = DBCommand.ExecuteReader
        lstBPList.BeginUpdate()

        While readerBP.Read()
            lstBPList.Items.Add(readerBP.GetString(0))
            Application.DoEvents()
        End While

        readerBP.Close()
        readerBP = Nothing
        lstBPList.EndUpdate()
        lstBPList.Visible = True
        Application.UseWaitCursor = False

    End Sub

    ' Builds the query for the select combo
    Private Function BuildBPSelectQuery() As String
        Dim SQL As String = ""
        Dim SQLItemType As String = ""

        ' See what ID we use for character bps
        Dim CharID As Long = 0
        If UserApplicationSettings.LoadBPsbyChar Then
            ' Use the ID sent
            CharID = SelectedCharacter.ID
        Else
            CharID = CommonLoadBPsID
        End If

        ' Find what type of blueprint we want
        With Me
            If .rbtnBPAmmoChargeBlueprints.Checked Then
                SQL &= "AND ITEM_CATEGORY = 'Charge' "
            ElseIf .rbtnBPDroneBlueprints.Checked Then
                SQL &= "AND ITEM_CATEGORY in ('Drone', 'Fighter') "
            ElseIf .rbtnBPModuleBlueprints.Checked Then
                SQL &= "AND (ITEM_CATEGORY ='Module' AND ITEM_GROUP NOT LIKE 'Rig%') "
            ElseIf .rbtnBPShipBlueprints.Checked Then
                SQL &= "AND ITEM_CATEGORY = 'Ship' "
            ElseIf .rbtnBPSubsystemBlueprints.Checked Then
                SQL &= "AND ITEM_CATEGORY = 'Subsystem' "
            ElseIf .rbtnBPBoosterBlueprints.Checked Then
                SQL &= "AND ITEM_CATEGORY = 'Implant' "
            ElseIf .rbtnBPComponentBlueprints.Checked Then
                SQL &= "AND (ITEM_GROUP LIKE '%Components%' AND ITEM_GROUP <> 'Station Components') "
            ElseIf .rbtnBPMiscBlueprints.Checked Then
                SQL &= "AND ITEM_GROUP IN ('Tool','Data Interfaces','Cyberimplant','Fuel Block') "
            ElseIf .rbtnBPDeployableBlueprints.Checked Then
                SQL &= "AND ITEM_CATEGORY = 'Deployable' "
            ElseIf .rbtnBPCelestialsBlueprints.Checked Then
                SQL &= "AND ITEM_CATEGORY IN ('Celestial','Orbitals','Sovereignty Structures', 'Station', 'Accessories', 'Infrastructure Upgrades') "
            ElseIf .rbtnBPStructureBlueprints.Checked Then
                SQL &= "AND (ITEM_CATEGORY IN ('Starbase','Structure') OR ITEM_GROUP = 'Station Components') "
            ElseIf .rbtnBPStructureRigsBlueprints.Checked Then
                SQL &= "AND ITEM_CATEGORY = 'Structure Rigs' "
            ElseIf .rbtnBPStructureModulesBlueprints.Checked Then
                SQL &= "AND (ITEM_CATEGORY = 'Structure Module' AND BLUEPRINT_GROUP NOT LIKE '%Rig Blueprint') "
            ElseIf .rbtnBPReactionsBlueprints.Checked Then
                SQL &= "AND BLUEPRINT_GROUP LIKE '%Reaction Formulas'"
            ElseIf .rbtnBPRigBlueprints.Checked Then
                SQL &= "AND BLUEPRINT_GROUP LIKE '%Rig Blueprint' "
            ElseIf .rbtnBPOwnedBlueprints.Checked Then
                SQL = "SELECT ALL_BLUEPRINTS.BLUEPRINT_NAME, REPLACE(LOWER(ALL_BLUEPRINTS.BLUEPRINT_NAME),'''','') AS X FROM ALL_BLUEPRINTS, INVENTORY_TYPES AS IT, INVENTORY_TYPES AS IT2, "
                SQL &= "OWNED_BLUEPRINTS WHERE OWNED <> 0 "
                SQL &= "AND OWNED_BLUEPRINTS.USER_ID IN (" & CharID & "," & SelectedCharacter.CharacterCorporation.CorporationID & ") "
                SQL &= "AND ALL_BLUEPRINTS.BLUEPRINT_ID = OWNED_BLUEPRINTS.BLUEPRINT_ID "
                SQL &= "AND ALL_BLUEPRINTS.ITEM_ID = IT.typeID AND ALL_BLUEPRINTS.BLUEPRINT_ID = IT2.typeID "
            ElseIf .rbtnBPFavoriteBlueprints.Checked Then
                SQL = "Select ALL_BLUEPRINTS.BLUEPRINT_NAME, REPLACE(LOWER(ALL_BLUEPRINTS.BLUEPRINT_NAME),'''','') AS X, "
                SQL &= "CASE WHEN OWNED_BLUEPRINTS.FAVORITE IS NOT NULL THEN OWNED_BLUEPRINTS.FAVORITE ELSE "
                SQL &= "CASE WHEN ALL_BLUEPRINTS.FAVORITE Is Not NULL THEN ALL_BLUEPRINTS.FAVORITE ELSE 0 END END AS MY_FAVORITE "
                SQL &= "FROM ALL_BLUEPRINTS, INVENTORY_TYPES AS IT, INVENTORY_TYPES AS IT2, "
                SQL &= "OWNED_BLUEPRINTS WHERE OWNED <> 0  "
                SQL &= "And OWNED_BLUEPRINTS.USER_ID IN (" & CharID & "," & SelectedCharacter.CharacterCorporation.CorporationID & ") "
                SQL &= "And ALL_BLUEPRINTS.BLUEPRINT_ID = OWNED_BLUEPRINTS.BLUEPRINT_ID And MY_FAVORITE = 1 "
                SQL &= "And ALL_BLUEPRINTS.ITEM_ID = IT.typeID And ALL_BLUEPRINTS.BLUEPRINT_ID = IT2.typeID "
            End If
        End With

        ' Item Type Definitions - These are set by me based on existing data
        ' 1, 2, 14 are T1, T2, T3
        ' 3 is Storyline
        ' 15 is Pirate Faction
        ' 16 is Navy Faction

        ' Check Tech version
        If chkBPT1.Enabled Then
            ' Only a Subsystem so T3
            If chkBPT1.Checked Then
                SQLItemType = SQLItemType & "1,"
            End If
        End If

        If chkBPT2.Enabled Then
            If chkBPT2.Checked Then
                SQLItemType = SQLItemType & "2,"
            End If
        End If

        If chkBPT3.Enabled Then
            If chkBPT3.Checked Then
                SQLItemType = SQLItemType & "14,"
            End If
        End If

        If chkBPStoryline.Enabled Then
            If chkBPStoryline.Checked Then
                SQLItemType = SQLItemType & "3,"
            End If
        End If

        If chkBPPirateFaction.Enabled Then
            If chkBPPirateFaction.Checked Then
                SQLItemType = SQLItemType & "15,"
            End If
        End If

        If chkBPNavyFaction.Enabled Then
            If chkBPNavyFaction.Checked Then
                SQLItemType = SQLItemType & "16,"
            End If
        End If

        ' Add Item Type
        If SQLItemType <> "" Then
            SQLItemType = " ALL_BLUEPRINTS.ITEM_TYPE IN (" & SQLItemType.Substring(0, SQLItemType.Length - 1) & ") "
        Else
            ' They need to have at least one. If not, just return nothing
            BuildBPSelectQuery = ""
            Exit Function
        End If

        ' Add the item types
        SQL &= " And " & SQLItemType

        Dim SizesClause As String = ""

        ' Finally add the sizes
        If chkBPSmall.Checked Then ' Light
            SizesClause = SizesClause & "'S',"
        End If

        If chkBPMedium.Checked Then ' Medium
            SizesClause = SizesClause & "'M',"
        End If

        If chkBPLarge.Checked Then ' Heavy
            SizesClause = SizesClause & "'L',"
        End If

        If chkBPXL.Checked Then ' Fighters
            SizesClause = SizesClause & "'XL',"
        End If

        If SizesClause <> "" Then
            SizesClause = " AND SIZE_GROUP IN (" & SizesClause.Substring(0, Len(SizesClause) - 1) & ") "
        End If

        Dim NPCBPOsClause As String = ""

        If chkBPNPCBPOs.Checked And chkBPNPCBPOs.Enabled Then
            NPCBPOsClause = " AND IT2.marketGroupID IS NOT NULL AND ITEM_TYPE = 1 " ' only include T1 BPOs
        End If

        SQL &= SizesClause & NPCBPOsClause

        '' Ignore flag
        'If chkBPIncludeIgnoredBPs.Checked = False Then
        '    SQL &= " AND IGNORE = 0 "
        'End If

        BuildBPSelectQuery = SQL

    End Function

    ' Loads a blueprint if selected in the combo box by different methods
    Private Sub LoadBPFromCombo()

        If Not IsNothing(cmbBPBlueprintSelection.SelectedItem) Then
            SelectedBPText = cmbBPBlueprintSelection.SelectedItem.ToString
            cmbBPBlueprintSelection.Text = SelectedBPText

            Call SelectBlueprint()

            ComboMenuDown = False
            MouseWheelSelection = False
            ComboBoxArrowKeys = False
            BPComboKeyDown = False
        End If

    End Sub

    ' Reloads the BP combo when run
    Private Sub ResetBlueprintCombo(ByVal T1 As Boolean, ByVal T2 As Boolean, ByVal T3 As Boolean, ByVal Storyline As Boolean, ByVal NavyFaction As Boolean, ByVal PirateFaction As Boolean)
        cmbBPsLoaded = False
        chkBPT1.Enabled = T1
        chkBPT2.Enabled = T2
        chkBPT3.Enabled = T3
        chkBPNavyFaction.Enabled = NavyFaction
        chkBPPirateFaction.Enabled = PirateFaction
        chkBPStoryline.Enabled = Storyline

        ComboMenuDown = False
        MouseWheelSelection = False
        ComboBoxArrowKeys = False
        BPComboKeyDown = False

        ' Make sure we have something checked
        Call EnsureBPTechCheck()
        ' Load the New data
        Call LoadBlueprintCombo()

        cmbBPBlueprintSelection.Text = "Select Blueprint"
        cmbBPBlueprintSelection.Focus()

    End Sub

    Private Sub UpdateSelectedBPText(bpName As String)
        If bpName.Contains("Blueprint") Or bpName.Contains("Reaction Formula") Then
            RemoveHandler cmbBPBlueprintSelection.TextChanged, AddressOf cmbBPBlueprintSelection_TextChanged
            cmbBPBlueprintSelection.Text = bpName
            SelectedBPText = bpName
            AddHandler cmbBPBlueprintSelection.TextChanged, AddressOf cmbBPBlueprintSelection_TextChanged
            Call SelectBlueprint()
        End If

    End Sub

    Private Sub btnBPListView_Click(sender As Object, e As EventArgs) Handles btnBPListView.Click
        Dim frmBPList = New frmBlueprintList
        AddHandler frmBPList.BPSelected, AddressOf UpdateSelectedBPText
        frmBPList.Show()

    End Sub

#End Region

    ' Initializes all the boxes on the BP tab
    Private Sub InitBPTab(Optional ResetBPHistory As Boolean = True)

        pictBP.Image = Nothing
        pictBP.BackgroundImage = Nothing
        pictBP.Update()

        cmbBPBlueprintSelection.Text = "Select Blueprint"

        With UserBPTabSettings
            ' Exort type (might change with build buy selection
            Select Case .ExporttoShoppingListType
                Case rbtnBPComponentCopy.Text
                    rbtnBPComponentCopy.Checked = True
                Case rbtnBPCopyInvREMats.Text
                    rbtnBPCopyInvREMats.Checked = True
                Case rbtnBPRawmatCopy.Text
                    rbtnBPRawmatCopy.Checked = True
            End Select

            ' Default build/buy
            chkBPBuildBuy.Checked = UserApplicationSettings.CheckBuildBuy

            cmbBPsLoaded = False
            InventionDecryptorsLoaded = False

            ' Set BP Lines to run production on
            txtBPNumBPs.Text = "1"

            ' Set the runs to 1
            txtBPRuns.Text = "1"

            ' Production time label
            lblBPProductionTime.Text = "00:00:00"
            lblBPTotalItemPT.Text = "00:00:00"

            ' SVR
            lblBPBPSVR.Text = "-"
            lblBPRawSVR.Text = "-"

            ' Cost labels
            lblBPRawMatCost.Text = "0.00"
            lblBPComponentMatCost.Text = "0.00"
            txtBPAddlCosts.Text = "0.00"

            ' Total
            lblBPRawTotalCost.Text = "0.00"
            lblBPTotalCompCost.Text = "0.00"

            lblBPRawIPH.Text = "0.00"
            lblBPRawIPH.ForeColor = Color.Black
            lblBPCompIPH.Text = "0.00"
            lblBPCompIPH.ForeColor = Color.Black

            lblBPCompProfit.Text = "0.00"
            lblBPCompProfit.ForeColor = Color.Black
            lblBPRawProfit.Text = "0.00"
            lblBPRawProfit.ForeColor = Color.Black

            lblBPMarketCost.Text = "0.00"

            ' Don't show labels to make
            lblBPCanMakeBP.Visible = False
            lblBPCanMakeBPAll.Visible = False

            ' Saved settings
            chkBPT1.Checked = .Tech1Check
            chkBPT2.Checked = .Tech2Check
            chkBPT3.Checked = .Tech3Check
            chkBPNavyFaction.Checked = .TechFactionCheck
            chkBPStoryline.Checked = .TechStorylineCheck
            chkBPPirateFaction.Checked = .TechPirateCheck

            chkBPSimpleCopy.Checked = .SimpleCopyCheck
            chkBPNPCBPOs.Checked = .NPCBPOs
            chkBPSellExcessItems.Checked = .SellExcessBuildItems

            chkBPSmall.Checked = .SmallCheck
            chkBPMedium.Checked = .MediumCheck
            chkBPLarge.Checked = .LargeCheck
            chkBPXL.Checked = .XLCheck

            Select Case .BlueprintTypeSelection
                Case rbtnBPAllBlueprints.Text
                    rbtnBPAllBlueprints.Checked = True
                Case rbtnBPOwnedBlueprints.Text
                    rbtnBPOwnedBlueprints.Checked = True
                Case rbtnBPFavoriteBlueprints.Text
                    rbtnBPFavoriteBlueprints.Checked = True
                Case rbtnBPShipBlueprints.Text
                    rbtnBPShipBlueprints.Checked = True
                Case rbtnBPDroneBlueprints.Text
                    rbtnBPDroneBlueprints.Checked = True
                Case rbtnBPAmmoChargeBlueprints.Text
                    rbtnBPAmmoChargeBlueprints.Checked = True
                Case rbtnBPModuleBlueprints.Text
                    rbtnBPModuleBlueprints.Checked = True
                Case rbtnBPComponentBlueprints.Text
                    rbtnBPComponentBlueprints.Checked = True
                Case rbtnBPStructureBlueprints.Text
                    rbtnBPStructureBlueprints.Checked = True
                Case rbtnBPSubsystemBlueprints.Text
                    rbtnBPSubsystemBlueprints.Checked = True
                Case rbtnBPRigBlueprints.Text
                    rbtnBPRigBlueprints.Checked = True
                Case rbtnBPBoosterBlueprints.Text
                    rbtnBPBoosterBlueprints.Checked = True
                Case rbtnBPMiscBlueprints.Text
                    rbtnBPMiscBlueprints.Checked = True
                Case rbtnBPDeployableBlueprints.Text
                    rbtnBPDeployableBlueprints.Checked = True
                Case rbtnBPCelestialsBlueprints.Text
                    rbtnBPCelestialsBlueprints.Checked = True
                Case rbtnBPStructureRigsBlueprints.Text
                    rbtnBPStructureRigsBlueprints.Checked = True
                Case rbtnBPReactionsBlueprints.Text
                    rbtnBPReactionsBlueprints.Checked = True
            End Select

            SetTaxFeeChecks = False
            chkBPTaxes.Checked = .IncludeTaxes
            txtBPBrokerFeeRate.Visible = False

            Select Case .IncludeFees
                Case 2
                    chkBPBrokerFees.CheckState = CheckState.Indeterminate
                    txtBPBrokerFeeRate.Visible = True
                Case 1
                    chkBPBrokerFees.CheckState = CheckState.Checked
                Case 0
                    chkBPBrokerFees.CheckState = CheckState.Unchecked
            End Select

            txtBPBrokerFeeRate.Text = FormatPercent(.BrokerFeeRate, 1)

            SetTaxFeeChecks = True

            chkBPPricePerUnit.Checked = .PricePerUnit

            BPRawColumnClicked = .RawColumnSort
            BPCompColumnClicked = .CompColumnSort

            If .RawColumnSortType = "Ascending" Then
                BPRawColumnSortType = SortOrder.Ascending
            Else
                BPRawColumnSortType = SortOrder.Descending
            End If

            If .CompColumnSortType = "Ascending" Then
                BPCompColumnSortType = SortOrder.Ascending
            Else
                BPCompColumnSortType = SortOrder.Descending
            End If

            ' Invention checks
            UpdatingInventionChecks = True
            chkBPIncludeInventionCosts.Checked = .IncludeInventionCost
            chkBPIncludeInventionTime.Checked = .IncludeInventionTime
            chkBPIncludeCopyCosts.Checked = .IncludeCopyCost
            chkBPIncludeCopyTime.Checked = .IncludeCopyTime
            chkBPIncludeT3Costs.Checked = .IncludeT3Cost
            chkBPIncludeT3Time.Checked = .IncludeT3Time
            UpdatingInventionChecks = False

            ' These facilities use the same include checks
            BPTabFacility.GetFacility(ProductionType.Invention).IncludeActivityCost = .IncludeInventionCost
            BPTabFacility.GetFacility(ProductionType.Invention).IncludeActivityTime = .IncludeInventionTime
            BPTabFacility.GetFacility(ProductionType.Copying).IncludeActivityCost = .IncludeCopyCost
            BPTabFacility.GetFacility(ProductionType.Copying).IncludeActivityTime = .IncludeCopyTime

            BPTabFacility.GetFacility(ProductionType.SubsystemManufacturing).IncludeActivityCost = .IncludeT3Cost
            BPTabFacility.GetFacility(ProductionType.SubsystemManufacturing).IncludeActivityTime = .IncludeT3Time
            BPTabFacility.GetFacility(ProductionType.T3CruiserManufacturing).IncludeActivityCost = .IncludeT3Cost
            BPTabFacility.GetFacility(ProductionType.T3CruiserManufacturing).IncludeActivityTime = .IncludeT3Time
            BPTabFacility.GetFacility(ProductionType.T3Invention).IncludeActivityCost = .IncludeT3Cost
            BPTabFacility.GetFacility(ProductionType.T3Invention).IncludeActivityTime = .IncludeT3Time

            ' Enter the max lines we have regardless
            txtBPLines.Text = CStr(.ProductionLines)
            ' Set Max Invention Lines
            txtBPInventionLines.Text = CStr(.LaboratoryLines)
            txtBPRelicLines.Text = CStr(.T3Lines)

            ' Ignore settings
            chkBPIgnoreInvention.Checked = .IgnoreInvention
            chkBPIgnoreMinerals.Checked = .IgnoreMinerals
            chkBPIgnoreT1Item.Checked = .IgnoreT1Item

            ' T2/T3 Material types
            lblBPT2MatTypeSelector.Enabled = False
            rbtnBPAdvT2MatType.Enabled = False
            rbtnBPProcT2MatType.Enabled = False
            rbtnBPRawT2MatType.Enabled = False

            Select Case .BuildT2T3Materials
                Case BuildMatType.AdvMaterials
                    rbtnBPAdvT2MatType.Checked = True
                Case BuildMatType.ProcessedMaterials
                    rbtnBPProcT2MatType.Checked = True
                Case BuildMatType.RawMaterials
                    rbtnBPRawT2MatType.Checked = True
            End Select

            ' Profit labels
            If .RawProfitType = "Percent" Then
                lblBPRawProfit1.Text = "Raw Profit Percent:"
            Else
                lblBPRawProfit1.Text = "Raw Profit:"
            End If

            If .CompProfitType = "Percent" Then
                lblBPCompProfit1.Text = "Component Profit Percent:"
            Else
                lblBPCompProfit1.Text = "Component Profit:"
            End If

        End With

        ' Only show the facility and options tab first
        tabBPInventionEquip.TabPages.Remove(tabInventionCalcs)
        tabBPInventionEquip.TabPages.Remove(tabT3Calcs)
        tabBPInventionEquip.SelectTab(0)
        tabBPInventionEquip.Enabled = False

        ' Disable all entry areas until a blueprint is selected
        btnBPRefreshBP.Enabled = False
        btnBPCopyMatstoClip.Enabled = False
        btnBPAddBPMatstoShoppingList.Enabled = False
        chkBPSimpleCopy.Enabled = False
        txtBPME.Enabled = False
        txtBPTE.Enabled = False
        txtBPRuns.Enabled = False
        txtBPNumBPs.Enabled = False
        txtBPLines.Enabled = False
        chkBPPricePerUnit.Enabled = False
        txtBPAddlCosts.Enabled = False
        chkBPBuildBuy.Enabled = False
        chkBPTaxes.Enabled = False
        chkBPBrokerFees.Enabled = False
        txtBPBrokerFeeRate.Enabled = False
        gbBPManualSystemCostIndex.Enabled = False
        gbBPIgnoreinCalcs.Enabled = False
        gbBPSellExcess.Enabled = False

        ' Copy Labels
        rbtnBPComponentCopy.Enabled = False
        rbtnBPRawmatCopy.Enabled = False
        rbtnBPCopyInvREMats.Enabled = False

        ' Color Labels
        lblBPBuyColor.Visible = False
        lblBPBuildColor.Visible = False

        ' BP Combo selection booleans
        ComboMenuDown = False
        MouseWheelSelection = False
        ComboBoxArrowKeys = False
        BPComboKeyDown = False

        ' Clear grids
        lstBPComponentMats.Items.Clear()
        lstBPBuiltComponents.Items.Clear()
        lstBPRawMats.Items.Clear()

        ResetBPTab = True
        EnterKeyPressed = False

        LoadingBPfromHistory = False
        PreviousBPfromHistory = False

        ' Load the combo
        Call LoadBlueprintCombo()

        ' BP History
        If ResetBPHistory Then
            BPHistory = New List(Of BPHistoryItem)
            CurrentBPHistoryIndex = -1 ' Nothing added yet
            btnBPBack.Enabled = False
            btnBPForward.Enabled = False
        Else
            Call LoadBPfromHistory(CurrentBPHistoryIndex, "")
        End If

    End Sub

    ' Saves the settings on the form for default later
    Private Sub btnBPSaveSettings_Click(sender As System.Object, e As System.EventArgs) Handles btnBPSaveSettings.Click
        Dim TempSettings As BPTabSettings = Nothing
        Dim Settings As New ProgramSettings

        If Trim(txtBPLines.Text) <> "" Then
            If Not IsNumeric(txtBPLines.Text) Then
                MsgBox("Invalid BP Lines value", vbExclamation, Application.ProductName)
                txtBPLines.Focus()
                Exit Sub
            End If
        End If

        If Trim(txtBPInventionLines.Text) <> "" Then
            If Not IsNumeric(txtBPInventionLines.Text) Then
                MsgBox("Invalid Invention Lines value", vbExclamation, Application.ProductName)
                txtBPInventionLines.Focus()
                Exit Sub
            End If
        End If

        If Trim(txtBPRelicLines.Text) <> "" Then
            If Not IsNumeric(txtBPRelicLines.Text) Then
                MsgBox("Invalid T3 Invention Lines value", vbExclamation, Application.ProductName)
                txtBPRelicLines.Focus()
                Exit Sub
            End If
        End If

        With TempSettings
            ' Prod/Lab Lines
            .ProductionLines = CInt(txtBPLines.Text)
            .LaboratoryLines = CInt(txtBPInventionLines.Text)
            .T3Lines = CInt(txtBPRelicLines.Text)

            If rbtnBPAllBlueprints.Checked Then
                .BlueprintTypeSelection = rbtnBPAllBlueprints.Text
            ElseIf rbtnBPOwnedBlueprints.Checked Then
                .BlueprintTypeSelection = rbtnBPOwnedBlueprints.Text
            ElseIf rbtnBPFavoriteBlueprints.Checked Then
                .BlueprintTypeSelection = rbtnBPFavoriteBlueprints.Text
            ElseIf rbtnBPShipBlueprints.Checked Then
                .BlueprintTypeSelection = rbtnBPShipBlueprints.Text
            ElseIf rbtnBPDroneBlueprints.Checked Then
                .BlueprintTypeSelection = rbtnBPDroneBlueprints.Text
            ElseIf rbtnBPAmmoChargeBlueprints.Checked Then
                .BlueprintTypeSelection = rbtnBPAmmoChargeBlueprints.Text
            ElseIf rbtnBPModuleBlueprints.Checked Then
                .BlueprintTypeSelection = rbtnBPModuleBlueprints.Text
            ElseIf rbtnBPComponentBlueprints.Checked Then
                .BlueprintTypeSelection = rbtnBPComponentBlueprints.Text
            ElseIf rbtnBPStructureBlueprints.Checked Then
                .BlueprintTypeSelection = rbtnBPStructureBlueprints.Text
            ElseIf rbtnBPSubsystemBlueprints.Checked Then
                .BlueprintTypeSelection = rbtnBPSubsystemBlueprints.Text
            ElseIf rbtnBPRigBlueprints.Checked Then
                .BlueprintTypeSelection = rbtnBPRigBlueprints.Text
            ElseIf rbtnBPBoosterBlueprints.Checked Then
                .BlueprintTypeSelection = rbtnBPBoosterBlueprints.Text
            ElseIf rbtnBPMiscBlueprints.Checked Then
                .BlueprintTypeSelection = rbtnBPMiscBlueprints.Text
            ElseIf rbtnBPCelestialsBlueprints.Checked Then
                .BlueprintTypeSelection = rbtnBPCelestialsBlueprints.Text
            ElseIf rbtnBPDeployableBlueprints.Checked Then
                .BlueprintTypeSelection = rbtnBPDeployableBlueprints.Text
            ElseIf rbtnBPStructureRigsBlueprints.Checked Then
                .BlueprintTypeSelection = rbtnBPStructureRigsBlueprints.Text
            ElseIf rbtnBPReactionsBlueprints.Checked Then
                .BlueprintTypeSelection = rbtnBPReactionsBlueprints.Text
            End If

            If rbtnBPComponentCopy.Checked Then
                .ExporttoShoppingListType = rbtnBPComponentCopy.Text
            ElseIf rbtnBPRawmatCopy.Checked Then
                .ExporttoShoppingListType = rbtnBPRawmatCopy.Text
            ElseIf rbtnBPCopyInvREMats.Checked Then
                .ExporttoShoppingListType = rbtnBPCopyInvREMats.Text
            End If

            .Tech1Check = chkBPT1.Checked
            .Tech2Check = chkBPT2.Checked
            .Tech3Check = chkBPT3.Checked
            .TechStorylineCheck = chkBPStoryline.Checked
            .TechFactionCheck = chkBPNavyFaction.Checked
            .TechPirateCheck = chkBPPirateFaction.Checked

            ' .IncludeIgnoredBPs = chkBPIncludeIgnoredBPs.Checked
            .SimpleCopyCheck = chkBPSimpleCopy.Checked
            .NPCBPOs = chkBPNPCBPOs.Checked
            .SellExcessBuildItems = chkBPSellExcessItems.Checked

            .SmallCheck = chkBPSmall.Checked
            .MediumCheck = chkBPMedium.Checked
            .LargeCheck = chkBPLarge.Checked
            .XLCheck = chkBPXL.Checked

            '.IncludeUsage = chkBPFacilityIncludeUsage.Checked
            .IncludeTaxes = chkBPTaxes.Checked
            If chkBPBrokerFees.CheckState = CheckState.Indeterminate Then
                .IncludeFees = 2
            ElseIf chkBPBrokerFees.CheckState = CheckState.Checked Then
                .IncludeFees = 1
            Else
                .IncludeFees = 0
            End If
            .BrokerFeeRate = FormatManualPercentEntry(txtBPBrokerFeeRate.Text)

            .IncludeInventionCost = chkBPIncludeInventionCosts.Checked
            .IncludeInventionTime = chkBPIncludeInventionTime.Checked
            BPTabFacility.GetFacility(ProductionType.Invention).IncludeActivityCost = chkBPIncludeInventionCosts.Checked
            BPTabFacility.GetFacility(ProductionType.Invention).IncludeActivityTime = chkBPIncludeInventionTime.Checked

            .IncludeCopyCost = chkBPIncludeCopyCosts.Checked
            .IncludeCopyTime = chkBPIncludeCopyTime.Checked
            BPTabFacility.GetFacility(ProductionType.Copying).IncludeActivityCost = chkBPIncludeCopyCosts.Checked
            BPTabFacility.GetFacility(ProductionType.Copying).IncludeActivityTime = chkBPIncludeCopyTime.Checked

            ' For T3 on the BP tab, save both facility data
            .IncludeT3Cost = chkBPIncludeT3Costs.Checked
            .IncludeT3Time = chkBPIncludeT3Time.Checked

            ' Ignore settings
            .IgnoreInvention = chkBPIgnoreInvention.Checked
            .IgnoreMinerals = chkBPIgnoreMinerals.Checked
            .IgnoreT1Item = chkBPIgnoreT1Item.Checked

            BPTabFacility.GetFacility(ProductionType.SubsystemManufacturing).IncludeActivityCost = chkBPIncludeT3Costs.Checked
            BPTabFacility.GetFacility(ProductionType.SubsystemManufacturing).IncludeActivityTime = chkBPIncludeT3Time.Checked
            BPTabFacility.GetFacility(ProductionType.T3CruiserManufacturing).IncludeActivityCost = chkBPIncludeT3Costs.Checked
            BPTabFacility.GetFacility(ProductionType.T3CruiserManufacturing).IncludeActivityTime = chkBPIncludeT3Time.Checked
            BPTabFacility.GetFacility(ProductionType.T3Invention).IncludeActivityCost = chkBPIncludeT3Costs.Checked
            BPTabFacility.GetFacility(ProductionType.T3Invention).IncludeActivityTime = chkBPIncludeT3Time.Checked

            .PricePerUnit = chkBPPricePerUnit.Checked

            .CompColumnSort = BPCompColumnClicked
            .RawColumnSort = BPRawColumnClicked

            If BPCompColumnSortType = SortOrder.Ascending Then
                .CompColumnSortType = "Ascending"
            Else
                .CompColumnSortType = "Descending"
            End If

            If BPRawColumnSortType = SortOrder.Ascending Then
                .RawColumnSortType = "Ascending"
            Else
                .RawColumnSortType = "Descending"
            End If

            ' Save the relic and decryptor if they have the setting set
            If UserApplicationSettings.SaveBPRelicsDecryptors And Not IsNothing(SelectedBlueprint) Then
                ' See if the T2 window is open and has a decryptor then save, only will be open if they have a t2 bp loaded
                If SelectedBlueprint.GetTechLevel = BPTechLevel.T2 Then
                    .T2DecryptorType = cmbBPInventionDecryptor.Text
                    .RelicType = UserBPTabSettings.RelicType
                    .T3DecryptorType = UserBPTabSettings.T3DecryptorType ' Save the old one
                End If

                ' See if the T3 window is open and has a decryptor then save, only will be open if they have a t3 bp loaded
                If SelectedBlueprint.GetTechLevel = BPTechLevel.T3 Then
                    .T2DecryptorType = UserBPTabSettings.T2DecryptorType ' Save the old one
                    .RelicType = cmbBPRelic.Text
                    .T3DecryptorType = cmbBPT3Decryptor.Text
                End If
            End If

            ' Profit type
            If lblBPRawProfit1.Text.Contains("Percent") Then
                .RawProfitType = "Percent"
            Else
                .RawProfitType = "Profit"
            End If

            If lblBPCompProfit1.Text.Contains("Percent") Then
                .CompProfitType = "Percent"
            Else
                .CompProfitType = "Profit"
            End If

            ' How they want to build T2/T3 items
            If rbtnBPAdvT2MatType.Checked Then
                .BuildT2T3Materials = BuildMatType.AdvMaterials
            ElseIf rbtnBPProcT2MatType.Checked Then
                .BuildT2T3Materials = BuildMatType.ProcessedMaterials
            ElseIf rbtnBPRawT2MatType.Checked Then
                .BuildT2T3Materials = BuildMatType.RawMaterials
            End If

        End With

        ' Save these here too
        UserApplicationSettings.CheckBuildBuy = chkBPBuildBuy.Checked
        Call Settings.SaveApplicationSettings(UserApplicationSettings)

        ' Save the data in the XML file
        Call Settings.SaveBPSettings(TempSettings)

        ' Save the data to the local variable
        UserBPTabSettings = TempSettings

        MsgBox("Settings Saved", vbInformation, Application.ProductName)

        cmbBPBlueprintSelection.Focus()

    End Sub

    ' Saves the BP data
    Private Sub btnBPSaveBP_Click(sender As System.Object, e As System.EventArgs) Handles btnBPSaveBP.Click
        Dim AdditionalCost As Double
        Dim SaveBPType As BPType

        If IsNothing(SelectedBlueprint) Then
            Exit Sub
        End If

        ' Check additional costs for saving with this bp
        If IsNumeric(txtBPAddlCosts.Text) Then
            AdditionalCost = CDbl(txtBPAddlCosts.Text)
        Else
            AdditionalCost = 0
        End If

        ' Save the BP
        If CorrectMETE(txtBPME.Text, txtBPTE.Text, txtBPME, txtBPTE) Then
            If SelectedBlueprint.GetTechLevel = BPTechLevel.T2 And chkBPIgnoreInvention.Checked = True Then
                ' T2 BPO 
                SaveBPType = BPType.Original
            ElseIf SelectedBlueprint.GetTechLevel = BPTechLevel.T2 Or SelectedBlueprint.GetTechLevel = BPTechLevel.T3 Then
                ' Save T2/T3 an invented BPC, since if they aren't ignoring invention they have to use a decryptor or invention to get it
                SaveBPType = BPType.InventedBPC
            Else ' Everything else is a copy
                SaveBPType = BPType.Copy
            End If

            Call UpdateBPinDB(SelectedBlueprint.GetTypeID, CInt(txtBPME.Text), CInt(txtBPTE.Text), SaveBPType,
                              CInt(txtBPME.Text), CInt(txtBPTE.Text), False, False, AdditionalCost)

            Call RefreshBP()

        End If

        MsgBox("BP Saved", vbInformation, Application.ProductName)

    End Sub

    ' Selects the blueprint from the combo and loads it into the grids
    Private Sub SelectBlueprint(Optional ByVal NewBP As Boolean = True, Optional SentFrom As SentFromLocation = 0, Optional FromEvent As Boolean = False)
        Dim SQL As String
        Dim readerBP As SQLiteDataReader
        Dim BPID As Integer
        Dim TempTech As Integer
        Dim ItemType As Integer
        Dim ItemGroupID As Integer
        Dim ItemCategoryID As Integer
        Dim BPGroup As String
        Dim Reaction As Boolean = False

        ' Set the number of runs to 1 if it's blank
        If Trim(txtBPRuns.Text) = "" Then
            txtBPRuns.Text = "1"
        End If

        ' Check the quantity
        If Not IsNumeric(txtBPRuns.Text) Then
            MsgBox("You must enter a valid number of runs", vbExclamation, Application.ProductName)
            txtBPRuns.SelectAll()
            txtBPRuns.Focus()
            Exit Sub
        End If

        ' Check the num bps
        If Not IsNumeric(txtBPNumBPs.Text) Or Trim(txtBPNumBPs.Text) = "" Then
            MsgBox("You must enter a valid number of BPs", vbExclamation, Application.ProductName)
            txtBPRuns.SelectAll()
            txtBPNumBPs.Focus()
            Exit Sub
        End If

        ' Additional costs
        If Not IsNumeric(txtBPAddlCosts.Text) Or Trim(txtBPAddlCosts.Text) = "" Then
            MsgBox("You must enter a valid additional cost value", vbExclamation, Application.ProductName)
            txtBPRuns.SelectAll()
            txtBPAddlCosts.Focus()
            Exit Sub
        End If

        txtBPME.Enabled = True
        txtBPTE.Enabled = True
        'txtBPME.Text = "0"
        'txtBPTE.Text = "0"

        SQL = "SELECT ALL_BLUEPRINTS.BLUEPRINT_ID, TECH_LEVEL, ITEM_TYPE, ITEM_GROUP_ID, ITEM_CATEGORY_ID, BLUEPRINT_GROUP "
        SQL &= "FROM ALL_BLUEPRINTS "
        SQL &= "WHERE ALL_BLUEPRINTS.BLUEPRINT_NAME = "

        If SelectedBPText = "" Then
            SelectedBPText = cmbBPBlueprintSelection.Text
        End If

        SQL &= "'" & FormatDBString(SelectedBPText) & "'"

        DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
        readerBP = DBCommand.ExecuteReader

        If readerBP.Read() Then
            BPID = readerBP.GetInt32(0)
            TempTech = readerBP.GetInt32(1)
            ItemType = readerBP.GetInt32(2)
            ItemGroupID = readerBP.GetInt32(3)
            ItemCategoryID = readerBP.GetInt32(4)
            BPGroup = readerBP.GetString(5)
        Else
            Exit Sub
        End If

        readerBP.Close()

        ' Load the facilty based on the groupid and categoryid
        Call BPTabFacility.LoadFacility(BPID, ItemGroupID, ItemCategoryID, TempTech, False, False, False, UserBPTabSettings.BuildT2T3Materials)

        ' Load the image
        Call LoadBlueprintPicture(BPID, ItemType)

        ' Set for max production lines 
        If SentFrom = SentFromLocation.None Then ' We might have different values there and they set on double click
            ' Reset the entry boxes
            txtBPRuns.Text = "1"
            txtBPNumBPs.Text = "1"

            txtBPLines.Text = CStr(UserBPTabSettings.ProductionLines)
            txtBPInventionLines.Text = CStr(UserBPTabSettings.LaboratoryLines)
            txtBPRelicLines.Text = CStr(UserBPTabSettings.T3Lines)

            Call ResetDecryptorCombos(TempTech)

        ElseIf SentFrom <> SentFromLocation.None Then  ' Sent from manufacturing tab, bp tab, history, or shopping list
            ' Set up for Reloading the decryptor combo on T2/T3
            ' Allow reloading of Decryptors
            InventionDecryptorsLoaded = False
            T3DecryptorsLoaded = False
            If Not chkBPIgnoreInvention.Checked Then
                If TempTech = 2 Then
                    cmbBPInventionDecryptor.Text = SelectedDecryptor.Name
                Else
                    cmbBPT3Decryptor.Text = SelectedDecryptor.Name
                End If
            End If
            ' Allow loading decryptors on drop down
            LoadingInventionDecryptors = False
            LoadingT3Decryptors = False
            ' Allow reloading of relics
            RelicsLoaded = False
        End If

        Reaction = IsReaction(ItemGroupID)

        ' If the previous bp was loaded from history and the current bp isn't loaded from history or event, then reset the facilities to default
        If PreviousBPfromHistory And SentFrom <> SentFromLocation.History And Not FromEvent Then
            PreviousBPfromHistory = False
            If Reaction Then
                Call BPTabFacility.SetSelectedFacility(BPTabFacility.GetProductionType(ItemGroupID, ItemCategoryID, ManufacturingFacility.ActivityReactions), ProgramLocation.BlueprintTab, False)
            Else
                Call BPTabFacility.SetSelectedFacility(BPTabFacility.GetProductionType(ItemGroupID, ItemCategoryID, ManufacturingFacility.ActivityManufacturing), ProgramLocation.BlueprintTab, False)
            End If
            Call BPTabFacility.SetSelectedFacility(ProductionType.ComponentManufacturing, ProgramLocation.BlueprintTab, False)
            Call BPTabFacility.SetSelectedFacility(ProductionType.CapitalComponentManufacturing, ProgramLocation.BlueprintTab, False)
        End If

        ' Set the invention info
        Call SetInventionData(BPID, TempTech, NewBP, SentFrom, Reaction)

        ' If they want to drill down on reactions, check all types
        If BPHasProcRawMats(BPID, BuildMatType.RawMaterials) Or Reaction Then
            ' Also enable the T2/T3 boxes for moon/gas mat types
            lblBPT2MatTypeSelector.Enabled = True
            rbtnBPAdvT2MatType.Enabled = True
            If TempTech = 3 Then
                rbtnBPProcT2MatType.Enabled = False ' No intermediate gas materials
            Else
                rbtnBPProcT2MatType.Enabled = True
            End If
            rbtnBPRawT2MatType.Enabled = True
        Else
            ' Disable the T2/T3 boxes for moon/gas mat types
            lblBPT2MatTypeSelector.Enabled = False
            rbtnBPAdvT2MatType.Enabled = False
            rbtnBPProcT2MatType.Enabled = False
            rbtnBPRawT2MatType.Enabled = False
        End If

        ' Reactions can't have ME or TE
        If SelectedBPText.Contains("Reaction Formula") Then
            txtBPME.Enabled = False
            txtBPTE.Enabled = False
        End If

        gbBPManualSystemCostIndex.Enabled = True
        gbBPIgnoreinCalcs.Enabled = True
        gbBPSellExcess.Enabled = True
        btnBPUpdateCostIndex.Enabled = False

        cmbBPBlueprintSelection.Focus()

        ' Make sure everything is enabled on first BP load
        If ResetBPTab Then
            btnBPRefreshBP.Enabled = True
            btnBPCopyMatstoClip.Enabled = True
            btnBPAddBPMatstoShoppingList.Enabled = True
            chkBPSimpleCopy.Enabled = True
            txtBPRuns.Enabled = True
            txtBPAddlCosts.Enabled = True
            chkBPBuildBuy.Enabled = True
            txtBPNumBPs.Enabled = True
            txtBPBrokerFeeRate.Enabled = True
            txtBPLines.Enabled = True
            chkBPTaxes.Enabled = True
            chkBPBrokerFees.Enabled = True
            chkBPPricePerUnit.Enabled = True

            btnBPBack.Enabled = True
            btnBPForward.Enabled = True

            ResetBPTab = False ' Reset
        End If

        Application.DoEvents()

        ' Update the grid
        Call UpdateBPGrids(BPID, TempTech, NewBP, ItemGroupID, ItemCategoryID, SentFromLocation.BlueprintTab)

        ' Save the blueprint in the history if it's not already in there
        If Not IsNothing(SelectedBlueprint) And SentFrom <> SentFromLocation.History Then
            Call UpdateBPHistory(True)
        End If

        txtBPRuns.SelectAll()
        txtBPRuns.Focus()
        cmbBPBlueprintSelection.SelectionLength = 0

    End Sub

    Private Sub SetInventionData(BlueprintID As Integer, BPTech As Integer, NewBP As Boolean, SentFrom As SentFromLocation, Reaction As Boolean)
        Dim SQL As String
        Dim readerBP As SQLiteDataReader

        ' Finally set the ME and TE in the display (need to allow the user to choose different BP's and play with ME/TE) - Search user bps first
        SQL = "SELECT ME, TE, ADDITIONAL_COSTS, RUNS, BP_TYPE"
        SQL &= " FROM OWNED_BLUEPRINTS WHERE USER_ID =" & GetBPUserID(SelectedCharacter.ID)
        SQL &= " AND BLUEPRINT_ID = " & BlueprintID & " AND OWNED <> 0 " ' Only load user or api owned bps

        DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
        readerBP = DBCommand.ExecuteReader()

        If NewBP Then
            Call SetInventionEnabled("T" & CStr(BPTech), True) ' First enable then let the ignore invention check override if needed
            If BPTech = 2 Then
                chkBPIgnoreInvention.Checked = UserBPTabSettings.IgnoreInvention
            End If
        End If

        Dim HasOwnedBP As Boolean = False

        If readerBP.Read() Then
            HasOwnedBP = True
        Else
            ' Try again with corp
            readerBP.Close()
            SQL = "SELECT ME, TE, ADDITIONAL_COSTS, RUNS, BP_TYPE"
            SQL &= " FROM OWNED_BLUEPRINTS WHERE USER_ID =" & SelectedCharacter.CharacterCorporation.CorporationID
            SQL &= " AND BLUEPRINT_ID = " & BlueprintID & " AND SCANNED <> 0 AND OWNED <> 0 "

            DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
            readerBP = DBCommand.ExecuteReader()

            If readerBP.Read() Then
                HasOwnedBP = True
            End If
        End If

        Dim OwnedBPRuns As Integer
        Dim TempBPType As BPType

        If HasOwnedBP Then
            TempBPType = GetBPType(readerBP.GetInt32(4))
        Else
            TempBPType = BPType.NotOwned
        End If

        If HasOwnedBP And Not SentFrom = SentFromLocation.ManufacturingTab Then
            ' Use owned settings
            If chkBPIgnoreInvention.Checked Or BPTech = 1 Then
                txtBPME.Text = CStr(readerBP.GetInt32(0))
                OwnedBPME = txtBPME.Text
                txtBPTE.Text = CStr(readerBP.GetInt32(1))
                OwnedBPPE = txtBPTE.Text
                OwnedBP = True
                txtBPAddlCosts.Text = FormatNumber(readerBP.GetDouble(2), 2)
                OwnedBPRuns = readerBP.GetInt32(3)
            ElseIf BPTech <> 1 Then
                Call SelectDecryptor(cmbBPInventionDecryptor.Text)
            End If
        Else ' If sent from manufacturing tab, use the values set from there or it's not owned
            OwnedBP = False
            OwnedBPRuns = 1
            If BPTech = 1 Then ' All T1
                If Reaction Then
                    ' Reactions can't be researched
                    txtBPME.Text = "0"
                    txtBPTE.Text = "0"
                ElseIf SentFrom <> SentFromLocation.ManufacturingTab Then
                    txtBPME.Text = CStr(UserApplicationSettings.DefaultBPME)
                    txtBPTE.Text = CStr(UserApplicationSettings.DefaultBPTE)
                ElseIf SentFrom = SentFromLocation.ShoppingList Then
                    ' Will be set already or use default
                    If Trim(txtBPME.Text) = "" Then
                        txtBPME.Text = CStr(UserApplicationSettings.DefaultBPME)
                    End If
                    txtBPTE.Text = CStr(UserApplicationSettings.DefaultBPTE)
                End If
                TempBPType = BPType.NotOwned ' set to not owned for non bp load events
            Else ' Default T2/T3 BPCs are going to be copies
                If chkBPIgnoreInvention.Checked = True Then
                    ' T2 BPO
                    If readerBP.HasRows Then
                        txtBPME.Text = CStr(readerBP.GetInt32(0))
                        OwnedBPME = txtBPME.Text
                        txtBPTE.Text = CStr(readerBP.GetInt32(1))
                        OwnedBPPE = txtBPTE.Text
                    Else
                        txtBPME.Text = "0"
                        txtBPTE.Text = "0"
                    End If
                Else
                    ' Use invention numbers
                    txtBPME.Text = CStr(BaseT2T3ME + SelectedDecryptor.MEMod)
                    txtBPTE.Text = CStr(BaseT2T3TE + SelectedDecryptor.TEMod)
                    TempBPType = BPType.NotOwned
                End If
            End If
        End If

        readerBP.Close()

        IgnoreRefresh = True

        If (BPTech <> 1 And TempBPType <> BPType.Original) Then
            If BPTech = 2 And TempBPType = BPType.Copy And NewBP Then
                ' This is a copy of a T2 BPO or exploration find - likely can't invent this ME/TE combo so check ignore invention when BP is first loaded
                chkBPIgnoreInvention.Checked = True
            End If

            ' disable the me/te boxes if invented, else enable and ignore invention
            If chkBPIgnoreInvention.Checked Then
                txtBPME.Enabled = True
                txtBPTE.Enabled = True
                Call SetInventionEnabled("T" & CStr(BPTech), False)
            Else
                txtBPME.Enabled = False
                txtBPTE.Enabled = False
            End If

        ElseIf BPTech = 2 And TempBPType = BPType.Original Then
            ' Check the ignore invention, they own this T2 BPO and don't need to invent it
            chkBPIgnoreInvention.Checked = True

            ' enable the me/te boxes
            txtBPME.Enabled = True
            txtBPTE.Enabled = True
        End If

        IgnoreRefresh = False

        If BPTech <> 2 Then
            chkBPIgnoreInvention.Enabled = False ' can't invent t1 - so don't allow toggle
        Else
            chkBPIgnoreInvention.Enabled = True ' All T2 options need the toggle
        End If

        ' Reset the combo for invention, and Load the relic types for BP selected for T3 - If sent from, then it's set there
        If NewBP And SentFrom = SentFromLocation.None Then
            Dim TempDName As String = ""
            If TempBPType = BPType.InventedBPC Or TempBPType = BPType.Copy Then
                ' Load the decryptor based on ME/TE
                Dim TempD As New DecryptorList
                LoadingInventionDecryptors = True
                LoadingT3Decryptors = True
                InventionDecryptorsLoaded = False
                T3DecryptorsLoaded = False
                ' Load up the decryptor based on data entered or BP data from an owned bp
                SelectedDecryptor = TempD.GetDecryptor(CInt(txtBPME.Text), CInt(txtBPTE.Text), OwnedBPRuns, BPTech)
                If SelectedDecryptor.Name = None And CInt(txtBPME.Text) <> BaseT2T3ME And CInt(txtBPTE.Text) <> BaseT2T3TE And TempBPType = BPType.Copy Then
                    TempDName = Unknown
                Else
                    TempDName = SelectedDecryptor.Name
                End If

                If BPTech = 2 Then
                    cmbBPInventionDecryptor.Text = TempDName
                ElseIf BPTech = 3 Then
                    cmbBPT3Decryptor.Text = TempDName
                End If

                LoadingInventionDecryptors = False
                LoadingT3Decryptors = False
            Else
                Call ResetDecryptorCombos(BPTech)
            End If

            If BPTech = 3 Then
                ' Load up the relic based on the bp data
                Call LoadRelicTypes(BlueprintID)
                Dim Tempstring As String
                Tempstring = GetRelicfromInputs(SelectedDecryptor, BlueprintID, OwnedBPRuns)
                If Tempstring <> "" Then
                    LoadingRelics = True
                    ' if found, set it else
                    cmbBPRelic.Text = Tempstring
                    LoadingRelics = False
                End If
            End If

        End If

    End Sub

    ' Updates the lists with the correct materials for the selected item
    Public Sub UpdateBPGrids(ByVal BPID As Integer, ByVal BPTech As Integer, ByVal NewBPSelection As Boolean,
                              BPGroupID As Integer, BPCategoryID As Integer, ByVal SentFrom As SentFromLocation)
        Dim IndustrySkill As Integer = 0
        Dim i As Integer = 0
        Dim BPRawMats As List(Of Material)
        Dim BPComponentMats As List(Of Material)
        Dim BPBuiltItems As New List(Of BuiltItem)
        Dim rawlstViewRow As ListViewItem
        Dim complstViewRow As ListViewItem
        Dim builtlistViewRow As ListViewItem
        Dim TempME As String = "0"
        Dim BPCName As String = ""

        ' For Invention Copy data - set defaults here
        Dim T1CopyRuns As Integer = 0
        Dim CopyCostPerSecond As Double = 0
        Dim SQL As String = ""
        Dim AdditionalCosts As Double

        Dim BPME As Integer = 0
        Dim BPTE As Integer = 0

        ' T2/T3 variables
        Dim RelicName As String = ""

        Dim SelectedRuns As Integer
        Dim ZeroCostToolTipText As String = ""

        ' Set the number of runs to 1 if it's blank
        If Trim(txtBPRuns.Text) = "" Then
            txtBPRuns.Text = "1"
        End If

        ' Check the quantity
        If Not IsNumeric(txtBPRuns.Text) Or Val(txtBPRuns.Text) <= 0 Then
            MsgBox("You must enter a valid number of runs", vbExclamation, Application.ProductName)
            txtBPRuns.SelectAll()
            txtBPRuns.Focus()
            Exit Sub
        Else
            SelectedRuns = CInt(txtBPRuns.Text)
        End If

        ' Check the num bps
        If Not IsNumeric(txtBPNumBPs.Text) Or Trim(txtBPNumBPs.Text) = "" Then
            MsgBox("You must enter a valid number of BPs", vbExclamation, Application.ProductName)
            txtBPRuns.SelectAll()
            txtBPNumBPs.Focus()
            Exit Sub
        End If

        ' Additional costs
        If Not IsNumeric(txtBPAddlCosts.Text) Or Trim(txtBPAddlCosts.Text) = "" Then
            MsgBox("You must enter a valid additional cost value", vbExclamation, Application.ProductName)
            txtBPRuns.SelectAll()
            txtBPAddlCosts.Focus()
            Exit Sub
        Else
            ' Set the additional costs (this is just a raw value they enter)
            AdditionalCosts = CDbl(txtBPAddlCosts.Text)
        End If

        ' Check num lines
        If Not IsNumeric(txtBPLines.Text) Or Val(txtBPLines.Text) <= 0 Then
            MsgBox("You must enter a valid number of Production Lines", vbExclamation, Application.ProductName)
            txtBPRuns.SelectAll()
            txtBPLines.Focus()
            Exit Sub
        End If

        ' Check the laboratory lines
        If Not IsNumeric(txtBPInventionLines.Text) Or Val(txtBPInventionLines.Text) <= 0 Then
            MsgBox("You must enter a valid number of Invention Lines", vbExclamation, Application.ProductName)
            txtBPRuns.SelectAll()
            txtBPInventionLines.Focus()
            Exit Sub
        End If

        If Not IsNumeric(txtBPRelicLines.Text) Or Val(txtBPRelicLines.Text) <= 0 Then
            MsgBox("You must enter a valid number of T3 Invention Lines", vbExclamation, Application.ProductName)
            txtBPRuns.SelectAll()
            txtBPRelicLines.Focus()
            Exit Sub
        End If

        ' Check num bps
        If Not IsNumeric(txtBPNumBPs.Text) Or Val(txtBPNumBPs.Text) <= 0 Then
            MsgBox("You must enter a valid number of BPs", vbExclamation, Application.ProductName)
            txtBPRuns.SelectAll()
            txtBPRuns.Focus()
            Exit Sub
        End If

        ' Facility setup
        Dim ComponentFacility As New IndustryFacility
        Dim BuildFacility As New IndustryFacility
        BuildFacility = BPTabFacility.GetSelectedManufacturingFacility(BPGroupID, BPCategoryID) ' This is the facility to manufacture the item in the blueprint

        If SelectedBPText.Contains("Reaction Formula") Then
            'Need to use the manufacturing facility instead of component facility since they are more likely to make fuel blocks for reactions there
            ComponentFacility = BPTabFacility.GetFacility(ProductionType.Manufacturing)
            'ElseIf ((BPCategoryID = ItemIDs.ComponentCategoryID Or BPGroupID = ItemIDs.AdvCapitalComponentGroupID) And Not BPGroupID = ItemIDs.CapitalComponentGroupID) Then
            '    ' Use the reaction facility as the 'component facility' if it's T2 component item, since they will do reactions
            '    ComponentFacility = BPTabFacility.GetFacility(ProductionType.Reactions)
        Else
            ComponentFacility = BPTabFacility.GetFacility(ProductionType.ComponentManufacturing)
        End If
        Dim CapitalComponentManufacturingFacility As IndustryFacility = BPTabFacility.GetFacility(ProductionType.CapitalComponentManufacturing)
        Dim ReactionFacility As IndustryFacility = BPTabFacility.GetFacility(ProductionType.Reactions)
        Dim CopyFacility As IndustryFacility = BPTabFacility.GetFacility(ProductionType.Copying)
        Dim InventionFacility As New IndustryFacility

        Dim ReprocessingFacility As IndustryFacility = BPTabFacility.GetFacility(ProductionType.Reprocessing)

        If BPTech = BPTechLevel.T2 Or BPTech = BPTechLevel.T3 Then
            ' Set the invention facility data
            If BPTech = BPTechLevel.T3 Then
                ' Need to add the relic variant to the query for just one item
                RelicName = cmbBPRelic.Text
                InventionFacility = BPTabFacility.GetFacility(ProductionType.T3Invention)
                ' Load the decryptor options
                Call LoadBPT3InventionDecryptors()
            ElseIf BPTech = BPTechLevel.T2 Then
                ' T2 no relic 
                RelicName = ""
                InventionFacility = BPTabFacility.GetFacility(ProductionType.Invention)
                ' Load the decryptor options
                Call LoadBPInventionDecryptors()
                ' T2 has copy costs/time
                CopyFacility.IncludeActivityCost = chkBPIncludeCopyCosts.Checked
                CopyFacility.IncludeActivityTime = chkBPIncludeCopyTime.Checked
            End If

            ' All invention facilities need to have these set
            InventionFacility.IncludeActivityCost = chkBPIncludeInventionCosts.Checked
            InventionFacility.IncludeActivityTime = chkBPIncludeInventionTime.Checked
        End If

        ' Now load the materials into the lists
        lstBPComponentMats.Items.Clear()
        lstBPComponentMats.Enabled = False
        lstBPRawMats.Items.Clear()
        lstBPRawMats.Enabled = False
        lstBPBuiltComponents.Items.Clear()
        lstBPBuiltComponents.Enabled = False

        lblBPCanMakeBP.Visible = False
        lblBPCanMakeBPAll.Visible = False
        txtListEdit.Visible = False
        btnBPRefreshBP.Enabled = False
        Me.Cursor = Cursors.WaitCursor
        IgnoreFocus = True
        Application.DoEvents()
        IgnoreFocus = False

        BPME = CInt(txtBPME.Text)
        BPTE = CInt(txtBPTE.Text)

        ' Get the Build/Buy preference list if needed
        Dim BPBuildBuyPref As List(Of BuildBuyItem)
        If chkBPBuildBuy.Checked Then
            BPBuildBuyPref = BBItems
        Else
            BPBuildBuyPref = Nothing
        End If

        ' Construct Blueprint
        SelectedBlueprint = New Blueprint(BPID, SelectedRuns, BPME, BPTE, CInt(txtBPNumBPs.Text), CInt(txtBPLines.Text), SelectedCharacter,
                                          UserApplicationSettings, chkBPBuildBuy.Checked, AdditionalCosts, BuildFacility,
                                          ComponentFacility, CapitalComponentManufacturingFacility, ReactionFacility, chkBPSellExcessItems.Checked,
                                          UserBPTabSettings.BuildT2T3Materials, True, BPBuildBuyPref, ReprocessingFacility, UserConversiontoOreSettings)

        ' Set the T2 and T3 inputs if necessary
        If BPTech <> BPTechLevel.T1 And chkBPIgnoreInvention.Checked = False Then
            ' Invent this bp
            txtBPNumBPs.Text = CStr(SelectedBlueprint.InventBlueprint(CInt(txtBPInventionLines.Text), SelectedDecryptor,
                                  InventionFacility, CopyFacility, GetInventItemTypeID(BPID, RelicName)))
        End If

        ' Build the item and get the list of materials
        Dim BFData As BrokerFeeInfo = GetBrokerFeeData(chkBPBrokerFees, txtBPBrokerFeeRate)
        Call SelectedBlueprint.BuildItems(chkBPTaxes.Checked, BFData, False, chkBPIgnoreMinerals.Checked, chkBPIgnoreT1Item.Checked)

        ' Get the lists
        BPRawMats = SelectedBlueprint.GetRawMaterials.GetMaterialList
        BPComponentMats = SelectedBlueprint.GetComponentMaterials.GetMaterialList
        BPBuiltItems = SelectedBlueprint.BuiltComponentList.GetBuiltItemList

        If chkBPBuildBuy.Checked Then
            lblBPComponentMats.Text = "Build/Buy Component Material List"
            lblBPRawMats.Text = "Build/Buy Raw Material List"
            lblBPBuildColor.Visible = True
            lblBPBuyColor.Visible = True
        Else ' Show all
            lblBPComponentMats.Text = "Component Material List"
            lblBPRawMats.Text = "Raw Material List"
            lblBPBuildColor.Visible = False
            lblBPBuyColor.Visible = False
        End If

        ' Fill Component List if components built
        If Not IsNothing(BPComponentMats) And SelectedBlueprint.HasComponents Then
            IgnoreListViewItemChecks = True

            If chkBPBuildBuy.Checked Then
                lstBPComponentMats.CheckBoxes = True
            Else
                lstBPComponentMats.CheckBoxes = False
            End If

            lstBPComponentMats.Items.Clear()
            lstBPComponentMats.BeginUpdate()
            For i = 0 To BPComponentMats.Count - 1
                'The remaining columns are subitems  
                complstViewRow = New ListViewItem(BPComponentMats(i).GetMaterialName)
                complstViewRow.SubItems.Add(FormatNumber(BPComponentMats(i).GetQuantity, 0))
                TempME = BPComponentMats(i).GetItemME

                Dim Reaction As Boolean
                Select Case BPComponentMats(i).GroupName
                    Case "Composite", "Biochemical Material", "Hybrid Polymers", "Intermediate Materials"
                        Reaction = True
                    Case Else
                        Reaction = False
                End Select

                ' Mark line grey if the blueprint for this item has no ME stored
                If TempME = "0" Then
                    complstViewRow.BackColor = Color.LightGray
                Else
                    complstViewRow.BackColor = Color.White
                End If

                ' If we want to build the item, then override the back color
                If chkBPBuildBuy.Checked Then
                    inhibitAutoCheck = False ' Don't let it reset the check based on previous value
                    If BPComponentMats(i).GetBuildItem Then
                        complstViewRow.BackColor = lblBPBuildColor.BackColor
                        complstViewRow.Checked = True
                    Else
                        complstViewRow.BackColor = lblBPBuyColor.BackColor
                        complstViewRow.Checked = False
                    End If
                End If

                complstViewRow.SubItems.Add(TempME)
                ' If the price is zero, highlight text as red
                If BPComponentMats(i).GetCostPerItem = 0 Then
                    complstViewRow.ForeColor = Color.Red
                Else
                    complstViewRow.ForeColor = Color.Black
                End If
                complstViewRow.SubItems.Add(FormatNumber(BPComponentMats(i).GetCostPerItem, 2))
                complstViewRow.SubItems.Add(FormatNumber(BPComponentMats(i).GetTotalCost, 2))
                Call lstBPComponentMats.Items.Add(complstViewRow)
            Next
            IgnoreListViewItemChecks = False

            Dim TempSort As SortOrder
            If BPCompColumnSortType = SortOrder.Ascending Then
                TempSort = SortOrder.Descending
            Else
                TempSort = SortOrder.Ascending
            End If

            ' Sort the component list
            Call ListViewColumnSorter(BPCompColumnClicked, CType(lstBPComponentMats, ListView), BPCompColumnClicked, TempSort)

            lstBPComponentMats.EndUpdate()

            ' Enable the raw and component selector radio for exporting to shopping list (only if we don't have calc build/buy checked)
            If chkBPBuildBuy.Checked = True Then
                rbtnBPRawmatCopy.Enabled = False
                rbtnBPComponentCopy.Enabled = True
            Else
                rbtnBPRawmatCopy.Enabled = True
                rbtnBPComponentCopy.Enabled = True
            End If

            If SentFrom <> SentFromLocation.ManufacturingTab Then
                Select Case UserBPTabSettings.ExporttoShoppingListType
                    Case rbtnBPComponentCopy.Text
                        rbtnBPComponentCopy.Checked = True
                    Case rbtnBPCopyInvREMats.Text
                        rbtnBPCopyInvREMats.Checked = True
                    Case rbtnBPRawmatCopy.Text
                        ' If the raw button isn't enabled, then default to components
                        If rbtnBPRawmatCopy.Enabled Then
                            rbtnBPRawmatCopy.Checked = True
                        Else
                            rbtnBPComponentCopy.Checked = True
                        End If
                End Select
                lstBPComponentMats.Enabled = True
            End If

            ' Fill the built component list if there
            If BPBuiltItems.Count <> 0 Then
                lstBPBuiltComponents.Items.Clear()
                lstBPBuiltComponents.BeginUpdate()

                For i = 0 To BPBuiltItems.Count - 1
                    builtlistViewRow = New ListViewItem(BPBuiltItems(i).ItemName)
                    builtlistViewRow.SubItems.Add(FormatNumber(BPBuiltItems(i).ItemQuantity, 0))
                    TempME = CStr(BPBuiltItems(i).BuildME)

                    ' Mark line grey if the blueprint for this item has no ME stored except if reaction
                    If TempME = "0" And BPBuiltItems(i).ManufacturingFacility.Activity <> ManufacturingFacility.ActivityReactions Then
                        builtlistViewRow.BackColor = Color.LightGray
                    Else
                        builtlistViewRow.BackColor = Color.White
                    End If

                    builtlistViewRow.SubItems.Add(TempME)
                    ' If the price is zero, highlight text as red
                    If BPBuiltItems(i).TotalBuildCost = 0 Then
                        builtlistViewRow.ForeColor = Color.Red
                    Else
                        builtlistViewRow.ForeColor = Color.Black
                    End If
                    builtlistViewRow.SubItems.Add(FormatNumber(BPBuiltItems(i).TotalExcessSellBuildCost, 2))
                    builtlistViewRow.SubItems.Add(FormatNumber(BPBuiltItems(i).TotalBuildCost, 2))
                    Call lstBPBuiltComponents.Items.Add(builtlistViewRow)

                Next

                If BPCompColumnSortType = SortOrder.Ascending Then
                    TempSort = SortOrder.Descending
                Else
                    TempSort = SortOrder.Ascending
                End If

                ' Sort the list
                Call ListViewColumnSorter(BPCompColumnClicked, CType(lstBPBuiltComponents, ListView), BPCompColumnClicked, TempSort)

                lstBPBuiltComponents.EndUpdate()
                lstBPBuiltComponents.Enabled = True
            End If

        Else ' No components
            ' Disable the raw and component selector radio for exporting to shopping list, the button will still just pull the data from the list anyway though
            rbtnBPComponentCopy.Enabled = False
            rbtnBPRawmatCopy.Enabled = True
            rbtnBPRawmatCopy.Checked = True
            lstBPComponentMats.Enabled = False
            lstBPBuiltComponents.Enabled = False
        End If

        If SelectedBlueprint.GetTechLevel <> BPTechLevel.T1 Then
            ' Enable the invention mats
            rbtnBPCopyInvREMats.Enabled = True

            ' Set this value if it just got enabled and they want it
            If UserBPTabSettings.ExporttoShoppingListType = rbtnBPCopyInvREMats.Text Then
                rbtnBPCopyInvREMats.Checked = True
            End If
        Else
            rbtnBPCopyInvREMats.Enabled = False
        End If

        If Not IsNothing(BPRawMats) Then
            ' Fill the Raw List
            lstBPRawMats.Items.Clear()
            lstBPRawMats.BeginUpdate()

            For i = 0 To BPRawMats.Count - 1
                rawlstViewRow = New ListViewItem(BPRawMats(i).GetMaterialName)
                'The remaining columns are subitems  
                rawlstViewRow.SubItems.Add(FormatNumber(BPRawMats(i).GetQuantity, 0))
                rawlstViewRow.SubItems.Add(BPRawMats(i).GetItemME)
                ' If the price is zero, highlight text as red
                If BPRawMats(i).GetCostPerItem = 0 Then
                    rawlstViewRow.ForeColor = Color.Red
                Else
                    rawlstViewRow.ForeColor = Color.Black
                End If
                rawlstViewRow.SubItems.Add(FormatNumber(BPRawMats(i).GetCostPerItem, 2))
                rawlstViewRow.SubItems.Add(FormatNumber(BPRawMats(i).GetTotalCost, 2))
                Call lstBPRawMats.Items.Add(rawlstViewRow)
            Next
            'End If
            ' Sort the raw mats list
            Dim TempSort As SortOrder
            If BPRawColumnSortType = SortOrder.Ascending Then
                TempSort = SortOrder.Descending
            Else
                TempSort = SortOrder.Ascending
            End If

            Call ListViewColumnSorter(BPRawColumnClicked, CType(lstBPRawMats, ListView), BPRawColumnClicked, TempSort)

            lstBPRawMats.EndUpdate()
        End If

        ' Get the production time
        If chkBPBuildBuy.Checked Then
            ' Grey this out because it doesn't really apply here
            lblBPProductionTime.Enabled = False
        Else
            lblBPProductionTime.Enabled = True
        End If

        ' Reset the number of bps to what we used in batches, not what was entered
        txtBPNumBPs.Text = CStr(SelectedBlueprint.GetUsedNumBPs)

        ' Show and update labels for T2 if selected
        If SelectedBlueprint.GetTechLevel = BPTechLevel.T2 Then
            If chkBPIgnoreInvention.Checked = False Then
                If SelectedBlueprint.UserCanInventRE Then
                    lblBPT2InventStatus.Text = "Invention Calculations:"
                    lblBPT2InventStatus.ForeColor = Color.Black
                Else
                    lblBPT2InventStatus.Text = "Cannot Invent - Typical Cost Shown"
                    lblBPT2InventStatus.ForeColor = Color.Red
                End If

                ' Invention cost to get enough success for the runs entered
                lblBPInventionCost.Text = FormatNumber(SelectedBlueprint.GetInventionCost(), 2)

                ' Add copy costs for enough succesful runs
                lblBPCopyCosts.Text = FormatNumber(SelectedBlueprint.GetCopyCost, 2)

                ' Invention Chance
                lblBPInventionChance.Text = FormatPercent(SelectedBlueprint.GetInventionChance(), 2)

                ' Update the decryptor stats box ME: -4, TE: -3, Runs: +9
                lblBPDecryptorStats.Text = "ME: " & CStr(SelectedDecryptor.MEMod) & ", TE: " & CStr(SelectedDecryptor.TEMod) & vbCrLf & "BP Runs: " & CStr(SelectedBlueprint.GetSingleInventedBPCRuns)

                ' Show the copy time if they want it
                lblBPCopyTime.Text = FormatIPHTime(SelectedBlueprint.GetCopyTime)

                ' Show the invention time if they want it
                lblBPInventionTime.Text = FormatIPHTime(SelectedBlueprint.GetInventionTime)

                ' Set the tool tip for copy costs to the invention chance label
                ttBP.SetToolTip(lblBPInventionChance, SelectedBlueprint.GetInventionBPC)

                ' Finally check the invention materials and make sure that if any have 0.00 for price,
                ' we update the invention label and add a tooltip for what has a price of 0
                If Not IsNothing(SelectedBlueprint.GetInventionMaterials.GetMaterialList) Then
                    With SelectedBlueprint.GetInventionMaterials
                        For i = 0 To .GetMaterialList.Count - 1
                            If .GetMaterialList(i).GetTotalCost = 0 And Not (.GetMaterialList(i).GetMaterialName.Contains("Blueprint") Or .GetMaterialList(i).GetMaterialName.Contains("Data Interface")) Then
                                ZeroCostToolTipText = ZeroCostToolTipText & .GetMaterialList(i).GetMaterialName & ", "
                            End If
                        Next
                    End With
                End If

                If ZeroCostToolTipText <> "" Then
                    ' We have a few zero priced items
                    ZeroCostToolTipText = ZeroCostToolTipText.Substring(0, Len(ZeroCostToolTipText) - 2)
                    ZeroCostToolTipText = "Invention Costs may be inaccurate; the following items have 0.00 for price: " & ZeroCostToolTipText
                    lblBPT2InventStatus.ForeColor = Color.Red
                    ttBP.SetToolTip(lblBPT2InventStatus, ZeroCostToolTipText)
                Else
                    lblBPT2InventStatus.ForeColor = Color.Black
                    ttBP.SetToolTip(lblBPT2InventStatus, "")
                End If
            Else
                FirstLoad = True
                Call ResetInventionBoxes()
                FirstLoad = False
            End If

            ' Show the invention tabs
            tabBPInventionEquip.TabPages.Remove(tabT3Calcs)
            If Not tabBPInventionEquip.TabPages.Contains(tabInventionCalcs) Then
                tabBPInventionEquip.TabPages.Add(tabInventionCalcs)
            End If

            ' Enable option
            rbtnBPCopyInvREMats.Enabled = True

        ElseIf SelectedBlueprint.GetTechLevel = BPTechLevel.T3 Then
            ' Show the RE calc tab
            tabBPInventionEquip.TabPages.Remove(tabInventionCalcs)
            If Not tabBPInventionEquip.TabPages.Contains(tabT3Calcs) Then
                tabBPInventionEquip.TabPages.Add(tabT3Calcs)
            End If

            If chkBPIgnoreInvention.Checked = False Then
                ' RE Cost and time
                lblBPRECost.Text = FormatNumber(SelectedBlueprint.GetInventionCost(), 2)
                lblBPRETime.Text = FormatIPHTime(SelectedBlueprint.GetInventionTime())

                ' Update the decryptor stats box ME: -4, TE: -3, Runs: +9
                lblBPT3Stats.Text = "ME: " & CStr(SelectedDecryptor.MEMod) & ", TE: " & CStr(SelectedDecryptor.TEMod) & "," & vbCrLf & "BP Runs: " & CStr(SelectedBlueprint.GetSingleInventedBPCRuns)

                If SelectedBlueprint.UserCanInventRE Then
                    lblT3InventStatus.Text = "T3 Invention Calculations:"
                    lblT3InventStatus.ForeColor = Color.Black
                Else
                    lblT3InventStatus.Text = "Cannot Invent - Typical Cost Shown"
                    lblT3InventStatus.ForeColor = Color.Red
                End If

                lblBPT3InventionChance.Text = FormatPercent(SelectedBlueprint.GetInventionChance(), 2)

                ' Enable option for adding mats to shopping list
                rbtnBPCopyInvREMats.Enabled = True

                ' Finally check the RE materials and make sure that if any have 0.00 for price,
                ' we update the RE label and add a tooltip for what has a price of 0
                If Not IsNothing(SelectedBlueprint.GetInventionMaterials.GetMaterialList) Then
                    With SelectedBlueprint.GetInventionMaterials
                        For i = 0 To .GetMaterialList.Count - 1
                            If .GetMaterialList(i).GetTotalCost = 0 Then
                                ZeroCostToolTipText = ZeroCostToolTipText & .GetMaterialList(i).GetMaterialName & ", "
                            End If
                        Next
                    End With
                End If

                If ZeroCostToolTipText <> "" Then
                    ' We have a few zero priced items
                    ZeroCostToolTipText = ZeroCostToolTipText.Substring(0, Len(ZeroCostToolTipText) - 2)
                    ZeroCostToolTipText = "T3 Invention Costs may be inaccurate; the following items have 0.00 for price: " & ZeroCostToolTipText
                    lblT3InventStatus.ForeColor = Color.Red
                    ttBP.SetToolTip(lblT3InventStatus, ZeroCostToolTipText)
                Else
                    lblBPT2InventStatus.ForeColor = Color.Black
                    ttBP.SetToolTip(lblT3InventStatus, "")
                End If
            Else
                FirstLoad = True
                Call ResetInventionBoxes()
                FirstLoad = False
            End If

        Else ' T1
            If rbtnBPCopyInvREMats.Checked Then
                ' We are turning this off, so move to raw
                rbtnBPRawmatCopy.Checked = True
            End If
            rbtnBPCopyInvREMats.Enabled = False

            ' Remove calcs for t1
            tabBPInventionEquip.TabPages.Remove(tabInventionCalcs)
            tabBPInventionEquip.TabPages.Remove(tabT3Calcs)
        End If

        ' Set the tab to the one selected
        If SelectedBPTabIndex <= tabBPInventionEquip.TabCount - 1 Then
            tabBPInventionEquip.SelectTab(SelectedBPTabIndex)
        Else
            tabBPInventionEquip.SelectTab(0)
        End If

        ' Finally Update the labels
        Call UpdateBPPriceLabels()

ExitForm:

        ' If the bp was updated (not new, then save any changes to the history - e.g. facility changes)
        If Not NewBPSelection And SentFrom = SentFromLocation.BlueprintTab Then
            Call UpdateBPHistory(False)
        End If

        LoadingBPfromHistory = False

        ' Done
        lstBPComponentMats.Enabled = True
        lstBPBuiltComponents.Enabled = True
        lstBPRawMats.Enabled = True
        lblBPCanMakeBP.Visible = True
        lblBPCanMakeBPAll.Visible = True
        btnBPRefreshBP.Enabled = True

        ' Enable facility selectors
        tabBPInventionEquip.Enabled = True

        Me.Cursor = Cursors.Default
        Application.DoEvents()

    End Sub

    ' Updates the blueprint history list for moving forward and back
    Private Sub UpdateBPHistory(ByVal NewBP As Boolean)
        Dim TempBPHistoryItem As BPHistoryItem
        Dim BP As Blueprint = SelectedBlueprint

        If Not IsNothing(BP) Then
            If Not LoadingBPfromHistory Then
                With TempBPHistoryItem
                    .BPID = BP.GetTypeID
                    .BPName = BP.GetName
                    If chkBPBuildBuy.Checked Then
                        .BuildType = "Build/Buy"
                    Else
                        .BuildType = ""
                    End If

                    If BP.GetTechLevel = BPTechLevel.T2 Then
                        .Inputs = BP.GetDecryptor.Name
                    ElseIf BP.GetTechLevel = BPTechLevel.T3 Then
                        .Inputs = BP.GetDecryptor.Name & " - " & BP.GetRelic ' parse decryptor and relic
                    Else
                        .Inputs = ""
                    End If
                    .SentFrom = SentFromLocation.History
                    .BuildFacility = CType(BPTabFacility.GetSelectedManufacturingFacility(BP.GetItemGroupID, BP.GetItemCategoryID).Clone, IndustryFacility)
                    .ComponentFacility = CType(BPTabFacility.GetFacility(ProductionType.ComponentManufacturing).Clone, IndustryFacility)
                    .CapComponentFacility = CType(BPTabFacility.GetFacility(ProductionType.CapitalComponentManufacturing).Clone, IndustryFacility)
                    .CopyFacility = CType(BPTabFacility.GetFacility(ProductionType.Copying).Clone, IndustryFacility)
                    .InventionFacility = CType(BPTabFacility.GetSelectedInventionFacility(BP.GetItemGroupID, BP.GetItemCategoryID).Clone, IndustryFacility)
                    .SentRuns = txtBPRuns.Text
                    .IncludeTaxes = chkBPTaxes.Checked

                    ' Save broker fee
                    .BrokerFeeData.IncludeFee = CType(chkBPBrokerFees.CheckState, BrokerFeeType)
                    .BrokerFeeData.FixedRate = FormatManualPercentEntry(txtBPBrokerFeeRate.Text)

                    .MEValue = txtBPME.Text
                    .TEValue = txtBPTE.Text
                    .SentRuns = txtBPRuns.Text
                    .ManufacturingLines = txtBPLines.Text
                    If BP.GetTechLevel = BPTechLevel.T2 Then
                        .LabLines = txtBPInventionLines.Text
                    ElseIf BP.GetTechLevel = BPTechLevel.T3 Then
                        .LabLines = txtBPRelicLines.Text
                    Else
                        .LabLines = "1"
                    End If
                    .NumBPs = txtBPNumBPs.Text
                    .AddlCosts = txtBPAddlCosts.Text
                    .PPU = chkBPPricePerUnit.Checked
                End With

                ' Find where the last bp was and insert the new one - so if we have 10 bps, and then select a new bp (component) the component is now the last bp
                If NewBP Then
                    If CurrentBPHistoryIndex < 0 Then
                        Call BPHistory.Add(TempBPHistoryItem)
                        CurrentBPHistoryIndex = 0
                    Else
                        Call BPHistory.Insert(CurrentBPHistoryIndex + 1, TempBPHistoryItem)
                        CurrentBPHistoryIndex = CurrentBPHistoryIndex + 1
                    End If
                Else
                    ' Remove the old one and replace it with the one we have now
                    If BPHistory.Count > 0 Then
                        Call BPHistory.RemoveAt(CurrentBPHistoryIndex)
                        Call BPHistory.Insert(CurrentBPHistoryIndex, TempBPHistoryItem)
                    End If
                End If

            End If
        End If

        Call UpdateBlueprintHistoryButtons()

    End Sub

    ' Selects the images to be shown in the picture when a blueprint is selected
    Private Sub LoadBlueprintPicture(ByVal BPID As Long, ByVal ItemType As Integer)
        Dim BPImage As String
        Dim BPTechImagePath As String = ""

        ' Load the image - use absolute value since I use negative bpid's for special bps
        BPImage = Path.Combine(UserImagePath, CStr(Math.Abs(BPID)) & "_64.png")

        ' Check for the Tech Image
        If File.Exists(BPImage) Then
            Dim fi As New IO.FileInfo(BPImage)
            If fi.Length <> 0 Then
                pictBP.Image = Image.FromFile(BPImage)
            Else
                ' This will cause errors so delete it until updated
                File.Delete(BPImage)
                pictBP.Image = Nothing
            End If
        Else
            pictBP.Image = Nothing
        End If

        pictBP.Update()

    End Sub

    ' Selects and sets the decryptor
    Private Function SelectDecryptor(ByVal DecryptorText As String) As Decryptor

        If DecryptorText = None Or DecryptorText = "" Then
            SelectedDecryptor = NoDecryptor
        Else
            Dim InventionDecryptors As New DecryptorList()
            SelectedDecryptor = InventionDecryptors.GetDecryptor(DecryptorText)
        End If

        ' Set the ME/TE text here
        txtBPME.Text = CStr(SelectedDecryptor.MEMod + BaseT2T3ME)
        txtBPTE.Text = CStr(SelectedDecryptor.TEMod + BaseT2T3TE)

        Return SelectedDecryptor

    End Function

    ' Updates the price and other labels on the BP tab for the selected BP
    Public Sub UpdateBPPriceLabels()
        ' For final printout in boxes
        Dim TotalRawProfit As Double
        Dim TotalCompProfit As Double
        Dim TotalRawIPH As Double
        Dim TotalCompIPH As Double
        Dim DivideUnits As Long

        If chkBPPricePerUnit.Checked Then
            ' Need to divide all values by the total units produced
            ' This will only update the values in the top right box
            DivideUnits = SelectedBlueprint.GetTotalUnits
            ' Show only 1 unit in the units label
            lblBPTotalUnits.Text = "1"
        Else
            ' Just keep everything the same
            DivideUnits = 1
            ' Show the total units
            lblBPTotalUnits.Text = FormatNumber(SelectedBlueprint.GetTotalUnits, 0)
        End If

        ' Find the market price for the produced item
        lblBPMarketCost.Text = FormatNumber(SelectedBlueprint.GetItemMarketPrice / DivideUnits, 2)

        ' Materials (bottom labels)
        lblBPRawMatCost.Text = FormatNumber(SelectedBlueprint.GetRawMaterials.GetTotalMaterialsCost, 2)
        lblBPComponentMatCost.Text = FormatNumber(SelectedBlueprint.GetComponentMaterials.GetTotalMaterialsCost, 2)

        ' Taxes/Fees
        lblBPTaxes.Text = FormatNumber(SelectedBlueprint.GetSalesTaxes / DivideUnits, 2)
        lblBPBrokerFees.Text = FormatNumber(SelectedBlueprint.GetSalesBrokerFees / DivideUnits, 2)

        ' Update usage labels
        Call UpdateFacilityUsage(DivideUnits)

        ' Total
        lblBPRawTotalCost.Text = FormatNumber((SelectedBlueprint.GetTotalRawCost) / DivideUnits, 2)
        lblBPTotalCompCost.Text = FormatNumber((SelectedBlueprint.GetTotalComponentCost) / DivideUnits, 2)

        ' Profit labels (market cost - total cost of mats and invention)
        TotalRawProfit = SelectedBlueprint.GetTotalRawProfit / DivideUnits

        If TotalRawProfit < 0 Then
            lblBPRawProfit.ForeColor = Color.Red
        Else
            lblBPRawProfit.ForeColor = Color.Black
        End If

        TotalCompProfit = SelectedBlueprint.GetTotalComponentProfit / DivideUnits

        If TotalCompProfit < 0 Then
            lblBPCompProfit.ForeColor = Color.Red
        Else
            lblBPCompProfit.ForeColor = Color.Black
        End If

        ' Profit labels, check what type
        If lblBPRawProfit1.Text.Contains("Percent") Then
            lblBPRawProfit.Text = FormatPercent(SelectedBlueprint.GetTotalRawProfitPercent, 2)
        Else
            lblBPRawProfit.Text = FormatNumber(TotalRawProfit, 2)
        End If

        If lblBPCompProfit1.Text.Contains("Percent") Then
            lblBPCompProfit.Text = FormatPercent(SelectedBlueprint.GetTotalComponentProfitPercent, 2)
        Else
            lblBPCompProfit.Text = FormatNumber(TotalCompProfit, 2)
        End If

        If DivideUnits = 1 Then
            TotalRawIPH = SelectedBlueprint.GetTotalIskperHourRaw
            TotalCompIPH = SelectedBlueprint.GetTotalIskperHourComponents
        Else ' Need to adjust the production time per unit then calck IPH
            ' ISK per Hour (divide total cost by production time in seconds for a isk per second calc, then multiply by 3600 for isk per hour)
            TotalRawIPH = TotalRawProfit / (SelectedBlueprint.GetTotalProductionTime / DivideUnits) * 3600 ' Build everything

            ' If we are doing build/buy then the total IPH will be the same as RAW since the lists are identical for what to buy 
            If chkBPBuildBuy.Checked Then
                TotalCompIPH = TotalRawIPH
            Else
                TotalCompIPH = TotalCompProfit / (SelectedBlueprint.GetProductionTime / DivideUnits) * 3600 ' Buy all components, just production time of BP
            End If

        End If

        If TotalRawProfit < 0 Then
            lblBPRawIPH.ForeColor = Color.Red
        Else
            lblBPRawIPH.ForeColor = Color.Black
        End If

        If TotalCompIPH < 0 Then
            lblBPCompIPH.ForeColor = Color.Red
        Else
            lblBPCompIPH.ForeColor = Color.Black
        End If

        ' ISK PER HOUR 
        lblBPRawIPH.Text = FormatNumber(TotalRawIPH, 2) ' Build everything
        lblBPCompIPH.Text = FormatNumber(TotalCompIPH, 2) ' Buy components

        ' Set the labels if the User Can make this item and/or all components
        If SelectedBlueprint.UserCanBuildBlueprint Then
            lblBPCanMakeBP.Text = "Can make this Item"
            lblBPCanMakeBP.ForeColor = Color.Black
        Else
            lblBPCanMakeBP.Text = "Cannot make this Item"
            lblBPCanMakeBP.ForeColor = Color.Red
        End If

        ' Only update the make all lable if we have something to make, else use the bp data
        If SelectedBlueprint.HasComponents Then
            If SelectedBlueprint.UserCanBuildAllComponents Then
                lblBPCanMakeBPAll.Text = "Can make All Components for this Item"
                lblBPCanMakeBPAll.ForeColor = Color.Black
            Else
                lblBPCanMakeBPAll.Text = "Cannot make All Components for this Item"
                lblBPCanMakeBPAll.ForeColor = Color.Red
            End If

            ' Has components, but if we are buying everything (no skills/build buy) - then state that instead, else show BP stuff
            If SelectedBlueprint.GetReqComponentSkills.NumSkills = 0 And chkBPBuildBuy.Checked Then
                lblBPCanMakeBPAll.Text = "Buying all Materials"
                lblBPCanMakeBPAll.ForeColor = Color.Black
            End If
        Else
            If SelectedBlueprint.UserCanBuildBlueprint Then
                lblBPCanMakeBPAll.Text = "Can make this Item"
                lblBPCanMakeBPAll.ForeColor = Color.Black
            Else
                lblBPCanMakeBPAll.Text = "Cannot make this Item"
                lblBPCanMakeBPAll.ForeColor = Color.Red
            End If

        End If

        ' BP production time
        lblBPProductionTime.Text = FormatIPHTime(SelectedBlueprint.GetProductionTime)
        ' Set the total time to produce all items for this Blueprint
        lblBPTotalItemPT.Text = FormatIPHTime(SelectedBlueprint.GetTotalProductionTime)

        ' SVR Values
        ' Set these first so it doesn't look goofy
        lblBPBPSVR.Text = "-"
        lblBPRawSVR.Text = "-"

        If UserApplicationSettings.AutoUpdateSVRonBPTab Then
            Dim TempRawSVR As String = GetBPItemSVR(SelectedBlueprint.GetTotalProductionTime)
            Dim TempBPSVR As String
            If chkBPBuildBuy.Checked Then
                TempBPSVR = TempRawSVR
            Else
                TempBPSVR = GetBPItemSVR(SelectedBlueprint.GetProductionTime)
            End If
            ' Get the values before setting so they update at the same time on the form
            lblBPBPSVR.Text = TempBPSVR
            lblBPRawSVR.Text = TempRawSVR
        End If

        ' Set the ME and TE values if they changed
        txtBPME.Text = CStr(SelectedBlueprint.GetME)
        txtBPTE.Text = CStr(SelectedBlueprint.GetTE)

    End Sub

    ' Update the facility usage directly in the object
    Private Sub UpdateFacilityUsage(DivideUnits As Long)
        Dim UsedFacility As IndustryFacility = BPTabFacility.GetSelectedFacility()
        Dim TTText As String = ""
        Dim SelectedManufacturingFacility As IndustryFacility = BPTabFacility.GetSelectedManufacturingFacility(SelectedBlueprint.GetItemGroupID, SelectedBlueprint.GetItemCategoryID)

        ' Save all the usage values each time we update to allow updates for changing the facility
        If SelectedManufacturingFacility.FacilityProductionType = ProductionType.Reactions Then
            SelectedManufacturingFacility.FacilityUsage = SelectedBlueprint.GetReactionFacilityUsage / DivideUnits
        Else
            SelectedManufacturingFacility.FacilityUsage = SelectedBlueprint.GetManufacturingFacilityUsage / DivideUnits
        End If

        If SelectedManufacturingFacility.FacilityProductionType <> ProductionType.ComponentManufacturing Then
            If SelectedManufacturingFacility.FacilityProductionType = ProductionType.Reactions Then
                ' Need to save the usage value on the manufacturing facility for fuel blocks instead of components
                BPTabFacility.GetFacility(ProductionType.Manufacturing).FacilityUsage = SelectedBlueprint.GetManufacturingFacilityUsage() / DivideUnits
            Else
                BPTabFacility.GetFacility(ProductionType.ComponentManufacturing).FacilityUsage = SelectedBlueprint.GetComponentFacilityUsage() / DivideUnits
            End If
        End If

        If SelectedManufacturingFacility.FacilityProductionType <> ProductionType.CapitalComponentManufacturing Then
            BPTabFacility.GetFacility(ProductionType.CapitalComponentManufacturing).FacilityUsage = SelectedBlueprint.GetCapComponentFacilityUsage() / DivideUnits
        End If

        If SelectedManufacturingFacility.FacilityProductionType <> ProductionType.Reactions Then
            BPTabFacility.GetFacility(ProductionType.Reactions).FacilityUsage = SelectedBlueprint.GetReactionFacilityUsage() / DivideUnits
        End If

        BPTabFacility.GetFacility(ProductionType.Invention).FacilityUsage = SelectedBlueprint.GetInventionUsage() / DivideUnits
        BPTabFacility.GetFacility(ProductionType.Copying).FacilityUsage = SelectedBlueprint.GetCopyUsage() / DivideUnits

        BPTabFacility.GetFacility(ProductionType.Reprocessing).FacilityUsage = SelectedBlueprint.GetReprocessingUsage() / DivideUnits

        ' Show the usage cost for the activity selected
        If UsedFacility.IncludeActivityUsage Then
            Select Case UsedFacility.Activity
                Case ManufacturingFacility.ActivityManufacturing
                    UsedFacility.FacilityUsage = SelectedBlueprint.GetManufacturingFacilityUsage / DivideUnits
                    TTText = GetUsageToolTipText(SelectedBlueprint.GetManufacturingFacility, True)
                Case ManufacturingFacility.ActivityInvention
                    UsedFacility.FacilityUsage = SelectedBlueprint.GetInventionUsage / DivideUnits
                    TTText = GetUsageToolTipText(SelectedBlueprint.GetInventionFacility, False)
                Case ManufacturingFacility.ActivityCopying
                    UsedFacility.FacilityUsage = SelectedBlueprint.GetCopyUsage / DivideUnits
                    TTText = GetUsageToolTipText(SelectedBlueprint.GetCopyFacility, False)
                Case ManufacturingFacility.ActivityComponentManufacturing
                    UsedFacility.FacilityUsage = SelectedBlueprint.GetComponentFacilityUsage / DivideUnits
                    TTText = GetUsageToolTipText(SelectedBlueprint.GetComponentManufacturingFacility, True)
                Case ManufacturingFacility.ActivityCapComponentManufacturing
                    UsedFacility.FacilityUsage = SelectedBlueprint.GetCapComponentFacilityUsage / DivideUnits
                    TTText = GetUsageToolTipText(SelectedBlueprint.GetCapitalComponentManufacturingFacility, True)
                Case ManufacturingFacility.ActivityReactions
                    UsedFacility.FacilityUsage = SelectedBlueprint.GetReactionFacilityUsage / DivideUnits
                    TTText = GetUsageToolTipText(SelectedBlueprint.GetReactionFacility, True)
                Case ManufacturingFacility.ActivityReprocessing
                    UsedFacility.FacilityUsage = SelectedBlueprint.GetReprocessingUsage / DivideUnits
                    TTText = GetUsageToolTipText(SelectedBlueprint.GetReprocessingFacility, True)
            End Select
        Else
            UsedFacility.FacilityUsage = 0
        End If

        ' Set the tool tip text
        Call BPTabFacility.UpdateUsage(TTText)

    End Sub

    ' Check if the runs they entered can be made with the number of blueprints, this only applies to BPC's (T2 and T3)
    Private Sub UpdateBPLinesandBPs()

        If Not IsNothing(SelectedBlueprint) Then
            If Trim(txtBPRuns.Text) <> "" Then
                txtBPNumBPs.Text = CStr(GetUsedNumBPs(SelectedBlueprint.GetTypeID, SelectedBlueprint.GetTechLevel, CInt(txtBPRuns.Text),
                                                      CInt(txtBPLines.Text), CInt(txtBPNumBPs.Text), SelectedDecryptor.RunMod))
            End If
        End If

    End Sub

    ' Returns the number of BPs to use for item type and runs sent
    Private Function GetUsedNumBPs(ByVal BlueprintTypeID As Long, ByVal SentTechLevel As Integer,
                                   ByVal SentRuns As Integer, ByVal SentLines As Integer, ByVal SentNumBps As Integer, ByVal DecryptorMod As Integer) As Integer
        Dim readerOwned As SQLiteDataReader
        Dim SQL As String
        Dim MaxProductionRuns As Long
        Dim ReturnValue As Integer

        If SentTechLevel = 1 Then
            If SentRuns >= SentNumBps Then
                Return SentNumBps
            Else
                Return SentRuns
            End If
        End If

        ' Set the number of bps
        If SentTechLevel = 2 Then
            SQL = "SELECT MAX_PRODUCTION_LIMIT FROM ALL_BLUEPRINTS WHERE BLUEPRINT_ID =" & CStr(BlueprintTypeID)

            DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
            readerOwned = DBCommand.ExecuteReader()
            readerOwned.Read()

            MaxProductionRuns = readerOwned.GetInt32(0)

            readerOwned.Close()
            readerOwned = Nothing

        Else ' base T3 runs off of the relic
            Dim readerBP As SQLiteDataReader

            SQL = "SELECT quantity FROM INVENTORY_TYPES, INDUSTRY_ACTIVITY_PRODUCTS "
            SQL &= "WHERE typeID = blueprintTypeID AND productTypeID = " & CStr(BlueprintTypeID) & " AND typeName = '" & cmbBPRelic.Text & "'"

            DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
            readerBP = DBCommand.ExecuteReader()

            If readerBP.Read Then
                MaxProductionRuns = readerBP.GetInt32(0)
            Else
                ' Assume wrecked bp
                MaxProductionRuns = 3
            End If

            readerBP.Close()
            readerBP = Nothing

        End If

        MaxProductionRuns = MaxProductionRuns + DecryptorMod
        ' Set the num bps off of the calculated amount
        ReturnValue = CInt(Math.Ceiling(SentRuns / MaxProductionRuns))

        Return ReturnValue

    End Function

    ' Adds item to shopping list
    Private Sub btnAddBPMatstoShoppingList_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnBPAddBPMatstoShoppingList.Click

        ' Just add it to shopping list with options
        Call AddToShoppingList(SelectedBlueprint, chkBPBuildBuy.Checked, rbtnBPRawmatCopy.Checked, BPTabFacility.GetFacility(BPTabFacility.GetCurrentFacilityProductionType()),
                               chkBPIgnoreInvention.Checked, chkBPIgnoreMinerals.Checked, chkBPIgnoreT1Item.Checked, rbtnBPCopyInvREMats.Checked)

        If TotalShoppingList.GetNumShoppingItems > 0 Then
            ' Add the final item and mark as items in list
            pnlShoppingList.Text = "Items in Shopping List"
            pnlShoppingList.ForeColor = Color.Red
        Else
            pnlShoppingList.Text = "No Items in Shopping List"
            pnlShoppingList.ForeColor = Color.Black
        End If

        ' Refresh the data if it's open
        If frmShop.Visible Then
            Call frmShop.RefreshLists()
        End If

    End Sub

    ' Loads the previous blueprint 
    Private Sub LoadPreviousBlueprint()
        Call LoadBPfromHistory(CurrentBPHistoryIndex - 1, "Backward")
    End Sub

    ' Loads the next blueprint if they used previous 
    Private Sub LoadNextBlueprint()
        Call LoadBPfromHistory(CurrentBPHistoryIndex + 1, "Forward")
    End Sub

    Private Sub LoadBPfromHistory(ByRef LocationID As Integer, BPType As String)

        If BPHistory.Count > 0 And LocationID < BPHistory.Count And LocationID >= 0 Then
            With BPHistory(LocationID)
                LoadingBPfromHistory = True
                PreviousBPfromHistory = True
                Call LoadBPfromEvent(.BPID, .BuildType, .Inputs, .SentFrom, .BuildFacility, .ComponentFacility, .CapComponentFacility, .InventionFacility, .CopyFacility, .IncludeTaxes,
                                           .BrokerFeeData, .MEValue, .TEValue, .SentRuns, .ManufacturingLines, .LabLines, .NumBPs, .AddlCosts, .PPU)
            End With

            CurrentBPHistoryIndex = LocationID

            Call UpdateBlueprintHistoryButtons()
        End If
    End Sub

    Private Sub UpdateBlueprintHistoryButtons()
        If BPHistory.Count > 1 Then
            If CurrentBPHistoryIndex = 0 Then
                ' Switch back to transparent until they go forward
                btnBPBack.BackColor = Color.Transparent
            Else
                btnBPBack.BackColor = Color.SteelBlue
            End If

            If CurrentBPHistoryIndex = BPHistory.Count - 1 Then
                btnBPForward.BackColor = Color.Transparent
            Else
                btnBPForward.BackColor = Color.SteelBlue
            End If
        Else
            btnBPBack.BackColor = Color.Transparent
            btnBPForward.BackColor = Color.Transparent
        End If
    End Sub

    ' Takes the facility and sets all the tool tip text based on the data it used
    Private Function GetUsageToolTipText(SentFacility As IndustryFacility, IncludeTax As Boolean) As String
        ' Set the usage tool tip data
        Dim TTString As String = ""

        TTString = TTString & "System Index = " & FormatPercent(SentFacility.CostIndex, 2) & " " & vbCrLf
        If IncludeTax Then
            TTString = TTString & "Facility Tax Rate = " & FormatPercent(SentFacility.TaxRate, 2) & " " & vbCrLf
        End If
        TTString = TTString & "Double-click for a list of facility usages"

        Return TTString

    End Function

    ' Updates the cost index in the DB or adds it if it doesn't exist
    Private Sub btnBPUpdateCostIndex_Click(sender As System.Object, e As System.EventArgs) Handles btnBPUpdateCostIndex.Click
        ' Check the data
        Dim Text As String = txtBPUpdateCostIndex.Text.Replace("%", "")
        Dim SelectedFacility As IndustryFacility = BPTabFacility.GetSelectedFacility

        If Text <> "" Then
            If Not IsNumeric(Text) Then
                MsgBox("Invalid Cost index value", vbExclamation, Application.ProductName)
                txtBPUpdateCostIndex.Focus()
                Exit Sub
            End If
        End If

        Application.UseWaitCursor = True
        Application.DoEvents()

        Dim SQL As String
        Dim rsCheck As SQLiteDataReader
        Dim CostIndex As String = CStr(Val(txtBPUpdateCostIndex.Text.Replace("%", "")) / 100)

        ' Look up Solar System ID
        Dim SSName As String = Trim(FormatDBString(SelectedFacility.SolarSystemName.Substring(0, InStr(SelectedFacility.SolarSystemName, "(") - 1)))
        Dim SSID As String = CStr(GetSolarSystemID(SSName))
        Dim SelectedActivityID As String = CStr(GetActivityID(SelectedFacility.Activity))

        SQL = "SELECT * FROM INDUSTRY_SYSTEMS_COST_INDICIES WHERE SOLAR_SYSTEM_ID = " & SSID & " "
        SQL &= "AND ACTIVITY_ID = " & SelectedActivityID
        DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
        rsCheck = DBCommand.ExecuteReader
        rsCheck.Read()

        ' See if the Current facility data exists, and update it. If not, then insert a new record
        If rsCheck.HasRows Then
            ' Update
            SQL = "UPDATE INDUSTRY_SYSTEMS_COST_INDICIES SET COST_INDEX = " & CostIndex
            SQL &= " WHERE SOLAR_SYSTEM_ID = " & SSID & " AND ACTIVITY_ID = " & SelectedActivityID
        Else
            ' Insert 
            SQL = "INSERT INTO INDUSTRY_SYSTEMS_COST_INDICIES VALUES (" & SSID & ",'" & SSName & "',"
            SQL &= SelectedActivityID & ",'" & SelectedFacility.Activity & "'," & CostIndex & ")"
        End If

        rsCheck.Close()

        Call EVEDB.ExecuteNonQuerySQL(SQL)

        ' Reload all the facilities to get the change
        Call LoadFacilities()

        ' Refresh the bp, which will reload the facility with the changes
        Call UpdateBPGrids(SelectedBlueprint.GetTypeID, SelectedBlueprint.GetTechLevel, False, SelectedBlueprint.GetItemGroupID, SelectedBlueprint.GetItemCategoryID, SentFromLocation.BlueprintTab)

        btnBPUpdateCostIndex.Enabled = False

        Application.UseWaitCursor = False
        Application.DoEvents()
        MsgBox("Index Updated", vbInformation, Application.ProductName)

    End Sub

    ' Allow update of the market price from clicking on the label
    Private Sub lblBPMarketCost_Click(sender As System.Object, e As System.EventArgs) Handles lblBPMarketCost.Click
        txtBPMarketPriceEdit.Size = lblBPMarketCost.Size
        Dim p As Point = lblBPMarketCost.Location
        p.Y = lblBPMarketCost.Location.Y - 2 ' move the text box up two pixels since it is larger than the label and looks funky
        txtBPMarketPriceEdit.Location = p
        txtBPMarketPriceEdit.Text = lblBPMarketCost.Text
        txtBPMarketPriceEdit.Visible = True
        txtBPMarketPriceEdit.Focus()
    End Sub

#End Region

#Region "Update Prices Tab"

#Region "Update Prices Tab User Object (Check boxes, Text, Buttons) Functions/Procedures "

    ' Disables the forms and controls on update prices
    Private Sub DisableUpdatePricesTab(Value As Boolean)
        ' Disable tab
        gbRawMaterials.Enabled = Not Value
        gbManufacturedItems.Enabled = Not Value
        gbTradeHubSystems.Enabled = Not Value
        gbPriceOptions.Enabled = Not Value
        txtPriceItemFilter.Enabled = Not Value
        lblItemFilter.Enabled = Not Value
        btnClearItemFilter.Enabled = Not Value
        chkPriceMaterialResearchEqPrices.Enabled = Not Value
        chkPriceManufacturedPrices.Enabled = Not Value
        btnToggleAllPriceItems.Enabled = Not Value
        btnDownloadPrices.Enabled = Not Value
        btnOpenMarketBrowser.Enabled = Not Value
        btnSaveUpdatePrices.Enabled = Not Value
        lstPricesView.Enabled = Not Value
        btnSavePricestoFile.Enabled = Not Value
        btnLoadPricesfromFile.Enabled = Not Value
    End Sub

    ' Checks or unchecks all the prices
    Private Sub UpdateAllPrices()
        If RunUpdatePriceList Then
            ' Don't update prices yet
            UpdateAllTechChecks = True
            RunUpdatePriceList = False

            Application.DoEvents()

            ' Just update the prices based on the checks
            Call CheckAllManufacturedPrices()
            Call CheckAllRawPrices()

            ' Good to go, update or clear
            RunUpdatePriceList = True
            UpdateAllTechChecks = True

            Application.DoEvents()

            If chkPriceManufacturedPrices.Checked = False And chkPriceMaterialResearchEqPrices.Checked = False Then
                lstPricesView.Items.Clear()
                btnToggleAllPriceItems.Text = "Select All Items"
            Else
                If chkPriceManufacturedPrices.Checked = True And chkPriceMaterialResearchEqPrices.Checked = True Then
                    btnToggleAllPriceItems.Text = "Uncheck All Items"
                Else
                    btnToggleAllPriceItems.Text = "Select All Items"
                End If
                Call UpdatePriceList()
            End If
        End If
    End Sub

    ' Checks or unchecks just the prices for raw material items
    Private Sub CheckAllRawPrices()
        Dim BoolToggle As Boolean = False
        RunUpdatePriceList = False

        ' Check all item boxes and do not run updates
        If chkPriceMaterialResearchEqPrices.Checked = True Then
            BoolToggle = True
        End If

        chkAdvancedProtectiveTechnology.Checked = BoolToggle
        chkGas.Checked = BoolToggle
        chkIceProducts.Checked = BoolToggle
        chkMolecularForgingTools.Checked = BoolToggle
        chkFactionMaterials.Checked = BoolToggle
        chkNamedComponents.Checked = BoolToggle
        chkMinerals.Checked = BoolToggle
        chkPlanetary.Checked = BoolToggle
        chkRawMaterials.Checked = BoolToggle
        chkSalvage.Checked = BoolToggle
        chkMisc.Checked = BoolToggle
        chkBPCs.Checked = BoolToggle

        chkAncientRelics.Checked = BoolToggle
        chkDatacores.Checked = BoolToggle
        chkDecryptors.Checked = BoolToggle
        chkRDb.Checked = BoolToggle

        chkAdvancedMats.Checked = BoolToggle
        chkBoosterMats.Checked = BoolToggle
        chkMolecularForgedMaterials.Checked = BoolToggle
        chkPolymers.Checked = BoolToggle
        chkProcessedMats.Checked = BoolToggle
        chkRawMoonMats.Checked = BoolToggle

        RunUpdatePriceList = True

    End Sub

    ' Checks or unchecks just the prices for manufactured items
    Private Sub CheckAllManufacturedPrices()

        RunUpdatePriceList = False

        Dim BoolToggle As Boolean = False
        RunUpdatePriceList = False

        ' Check all item boxes and do not run updates
        If chkPriceManufacturedPrices.Checked = True Then
            BoolToggle = True
        End If

        chkShips.Checked = BoolToggle
        chkCharges.Checked = BoolToggle
        chkModules.Checked = BoolToggle
        chkDrones.Checked = BoolToggle
        chkRigs.Checked = BoolToggle
        chkSubsystems.Checked = BoolToggle
        chkDeployables.Checked = BoolToggle
        chkBoosters.Checked = BoolToggle
        chkStructures.Checked = BoolToggle
        chkStructureRigs.Checked = BoolToggle
        chkCelestials.Checked = BoolToggle
        chkStructureModules.Checked = BoolToggle
        chkImplants.Checked = BoolToggle

        chkCapT2Components.Checked = BoolToggle
        chkComponents.Checked = BoolToggle
        chkFuelBlocks.Checked = BoolToggle
        chkProtectiveComponents.Checked = BoolToggle
        chkRAM.Checked = BoolToggle
        chkCapitalShipComponents.Checked = BoolToggle
        chkStructureComponents.Checked = BoolToggle
        chkSubsystemComponents.Checked = BoolToggle

        RunUpdatePriceList = True

    End Sub

    Private Sub chkPriceSelectManufacturedItems_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkPriceManufacturedPrices.CheckedChanged

        Call CheckAllManufacturedPrices()

        If chkPriceManufacturedPrices.Checked = False And chkPriceMaterialResearchEqPrices.Checked = False Then
            lstPricesView.Items.Clear()
            btnToggleAllPriceItems.Text = "Select All Items"
        Else
            If chkPriceManufacturedPrices.Checked = True And chkPriceMaterialResearchEqPrices.Checked = True Then
                btnToggleAllPriceItems.Text = "Uncheck All Items"
            Else
                btnToggleAllPriceItems.Text = "Select All Items"
            End If
        End If

        If PriceToggleButtonHit = False And Not FirstLoad Then
            Call UpdatePriceList()
        End If

    End Sub

    Private Sub chkPriceRawMaterialPrices_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkPriceMaterialResearchEqPrices.CheckedChanged

        Call CheckAllRawPrices()

        If chkPriceManufacturedPrices.Checked = False And chkPriceMaterialResearchEqPrices.Checked = False Then
            lstPricesView.Items.Clear()
            btnToggleAllPriceItems.Text = "Select All Items"
        Else
            If chkPriceManufacturedPrices.Checked = True And chkPriceMaterialResearchEqPrices.Checked = True Then
                btnToggleAllPriceItems.Text = "Uncheck All Items"
            Else
                btnToggleAllPriceItems.Text = "Select All Items"
            End If
        End If

        If PriceToggleButtonHit = False And Not FirstLoad Then
            Call UpdatePriceList()
        End If

    End Sub

    ' Toggles all selection checks on the prices tab
    Private Sub btnToggleAllPriceItems_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnToggleAllPriceItems.Click

        RunUpdatePriceList = False
        PriceToggleButtonHit = True

        If btnToggleAllPriceItems.Text = "Select All Items" And (chkPriceManufacturedPrices.Checked = False Or chkPriceMaterialResearchEqPrices.Checked = False) Then
            ' Set the name, then uncheck all
            btnToggleAllPriceItems.Text = "Uncheck All Items"
            chkPriceMaterialResearchEqPrices.Checked = True
            chkPriceManufacturedPrices.Checked = True
        ElseIf btnToggleAllPriceItems.Text = "Uncheck All Items" And chkPriceManufacturedPrices.Checked = True And chkPriceMaterialResearchEqPrices.Checked = True Then
            ' Turn off all item checks
            btnToggleAllPriceItems.Text = "Select All Items"
            chkPriceMaterialResearchEqPrices.Checked = False
            chkPriceManufacturedPrices.Checked = False
        End If

        RunUpdatePriceList = True

        Call UpdateAllPrices()
        PriceToggleButtonHit = False

    End Sub

    ' Updates the T1, T2 and T3 check boxes depending on item selections
    Private Sub UpdateTechChecks()
        Dim T1 As Boolean = False
        Dim T2 As Boolean = False
        Dim T3 As Boolean = False
        Dim Storyline As Boolean = False
        Dim Navy As Boolean = False
        Dim Pirate As Boolean = False

        Dim ItemsSelected As Boolean = False
        Dim i As Integer
        Dim TechChecks As Boolean = False

        ' For check all 
        If Not RunUpdatePriceList And UpdateAllTechChecks Then
            UpdateAllTechChecks = False
            ' Check all and leave
            For i = 1 To TechCheckBoxes.Length - 1
                TechCheckBoxes(i).Enabled = True
                ' Check this one and leave
                TechCheckBoxes(i).Checked = True
            Next i
            Exit Sub
        End If

        ' Check each item checked and set the check boxes accordingly
        If chkShips.Checked Then
            T1 = True
            T2 = True
            T3 = True
            Navy = True
            Pirate = True
            ItemsSelected = True
        End If

        If chkModules.Checked Then
            T1 = True
            T2 = True
            Navy = True
            Storyline = True
            ItemsSelected = True
        End If

        If chkSubsystems.Checked Then
            T3 = True
            ItemsSelected = True
        End If

        If chkDrones.Checked Then
            T1 = True
            T2 = True
            ItemsSelected = True
        End If

        If chkRigs.Checked Then
            T1 = True
            T2 = True
            ItemsSelected = True
        End If

        If chkStructureRigs.Checked Then
            T1 = True
            T2 = True
            ItemsSelected = True
        End If

        If chkStructures.Checked Then
            T1 = True
            Pirate = True
            ItemsSelected = True
        End If

        If chkCharges.Checked Then
            T1 = True
            T2 = True
            ItemsSelected = True
        End If

        ' If none are checked, then uncheck and un-enable all
        If ItemsSelected Then

            ' Enable the Checks
            If T1 Then
                chkPricesT1.Enabled = True
            Else
                chkPricesT1.Enabled = False
            End If

            If T2 Then
                chkPricesT2.Enabled = True
            Else
                chkPricesT2.Enabled = False
            End If

            If T3 Then
                chkPricesT3.Enabled = True
            Else
                chkPricesT3.Enabled = False
            End If

            If Storyline Then
                chkPricesT4.Enabled = True
            Else
                chkPricesT4.Enabled = False
            End If

            If Navy Then
                chkPricesT5.Enabled = True
            Else
                chkPricesT5.Enabled = False
            End If

            If Pirate Then
                chkPricesT6.Enabled = True
            Else
                chkPricesT6.Enabled = False
            End If

            ' Make sure we have at le=t one checked
            For i = 1 To TechCheckBoxes.Length - 1
                If TechCheckBoxes(i).Enabled Then
                    If TechCheckBoxes(i).Checked Then
                        TechChecks = True
                        ' Found one enabled and checked, so leave for
                        Exit For
                    End If
                End If
            Next i

            If Not TechChecks Then
                ' Need to check at le=t one
                For i = 1 To TechCheckBoxes.Length - 1
                    If TechCheckBoxes(i).Enabled Then
                        ' Check this one and leave
                        TechCheckBoxes(i).Checked = True
                    End If
                Next i
            End If

        Else
            chkPricesT1.Enabled = False
            chkPricesT2.Enabled = False
            chkPricesT3.Enabled = False
            chkPricesT4.Enabled = False
            chkPricesT5.Enabled = False
            chkPricesT6.Enabled = False
        End If

        ' Save status of the Tech check boxes
        PriceCheckT1Enabled = chkPricesT1.Enabled
        PriceCheckT2Enabled = chkPricesT2.Enabled
        PriceCheckT3Enabled = chkPricesT3.Enabled
        PriceCheckT4Enabled = chkPricesT4.Enabled
        PriceCheckT5Enabled = chkPricesT5.Enabled
        PriceCheckT6Enabled = chkPricesT6.Enabled

    End Sub

    ' Clears all system's that may be checked including resetting the system combo
    Private Sub ClearTradeHubSystems(Optional ResetSystemCombo As Boolean = True)
        Dim i As Integer

        If Not IgnoreSystemCheckUpdates Then
            For i = 1 To SystemCheckBoxes.Length - 1
                SystemCheckBoxes(i).Checked = False
            Next
        End If
    End Sub

    Private Sub cmbPriceShipTypes_DropDown(sender As Object, e As System.EventArgs) Handles cmbPriceShipTypes.DropDown
        If FirstPriceShipTypesComboLoad Then
            Call LoadPriceShipTypes()
            FirstPriceShipTypesComboLoad = False
        End If
    End Sub

    Private Sub cmbPriceChargeTypes_DropDown(sender As Object, e As System.EventArgs) Handles cmbPriceChargeTypes.DropDown
        If FirstPriceChargeTypesComboLoad Then
            Call LoadPriceChargeTypes()
            FirstPriceChargeTypesComboLoad = False
        End If
    End Sub

    Private Sub txtPriceItemFilter_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles txtPriceItemFilter.KeyDown
        'Call ProcessCutCopyPasteSelect(txtPriceItemFilter, e)
        If e.KeyCode = Keys.Enter Then
            Call UpdatePriceList()
        End If
    End Sub

    ' Checks all item check's to see if there is one checked. True if one or more checked, False if not
    Private Function ItemsSelected() As Boolean

        ' If the prices list doesnt' have any items in it, nothing to update so nothing checked
        If lstPricesView.Items.Count <> 0 Then
            Return True
        Else
            Return False
        End If

    End Function

    Private Sub PriceSourceSelection_CheckedChanged(sender As Object, e As EventArgs) Handles rbtnPriceSourceEM.CheckedChanged, rbtnPriceSourceCCPData.CheckedChanged, rbtnPriceSourceFW.CheckedChanged
        If rbtnPriceSourceCCPData.Checked Then
            btnAddStructureIDs.Visible = True
            btnViewSavedStructures.Visible = True
        Else
            btnAddStructureIDs.Visible = False
            btnViewSavedStructures.Visible = False
        End If
    End Sub

    Private Sub chkPricesTech_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles chkPricesT1.Click, chkPricesT2.Click, chkPricesT3.Click, chkPricesT4.Click, chkPricesT5.Click, chkPricesT6.Click
        If RefreshList Then
            Call UpdatePriceList()
        End If
    End Sub

    Private Sub ProcessnonTechItemChecks_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkAdvancedProtectiveTechnology.CheckedChanged,
        chkGas.CheckedChanged, chkIceProducts.CheckedChanged, chkMolecularForgingTools.CheckedChanged, chkFactionMaterials.CheckedChanged, chkNamedComponents.CheckedChanged,
        chkMinerals.CheckedChanged, chkPlanetary.CheckedChanged, chkRawMaterials.CheckedChanged, chkSalvage.CheckedChanged, chkMisc.CheckedChanged, chkBPCs.CheckedChanged,
        chkDatacores.CheckedChanged, chkDecryptors.CheckedChanged, chkAncientRelics.CheckedChanged, chkRDb.CheckedChanged, chkAdvancedMats.CheckedChanged, chkBoosterMats.CheckedChanged,
        chkMolecularForgedMaterials.CheckedChanged, chkPolymers.CheckedChanged, chkProcessedMats.CheckedChanged, chkRawMoonMats.CheckedChanged, chkBoosters.CheckedChanged,
        chkCapT2Components.CheckedChanged, chkComponents.CheckedChanged, chkFuelBlocks.CheckedChanged, chkProtectiveComponents.CheckedChanged, chkRAM.CheckedChanged,
        chkCapitalShipComponents.CheckedChanged, chkStructureComponents.CheckedChanged, chkSubsystemComponents.CheckedChanged, chkDeployables.CheckedChanged,
        chkStructureModules.CheckedChanged, chkImplants.CheckedChanged, chkCelestials.CheckedChanged, chkNoBuildItems.CheckedChanged
        Call UpdatePriceList()
    End Sub

    Private Sub chkTechManufacturedItems_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkModules.CheckedChanged, chkDrones.CheckedChanged, chkRigs.CheckedChanged,
            chkSubsystems.CheckedChanged, chkStructures.CheckedChanged, chkUpdatePricesNoPrice.CheckedChanged, chkStructureRigs.CheckedChanged
        RefreshList = False
        Call UpdateTechChecks()
        Call UpdatePriceList()
        RefreshList = True
    End Sub

    Private Sub chkShips_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkShips.CheckedChanged

        If chkShips.Checked = True Then
            cmbPriceShipTypes.Enabled = True
        ElseIf chkShips.Checked = False Then
            cmbPriceShipTypes.Enabled = False
        End If

        RefreshList = False
        Call UpdateTechChecks()
        Call UpdatePriceList()
        RefreshList = True

    End Sub

    Private Sub chkCharges_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkCharges.CheckedChanged

        If chkCharges.Checked = True Then
            cmbPriceChargeTypes.Enabled = True
        ElseIf chkCharges.Checked = False Then
            cmbPriceChargeTypes.Enabled = False
        End If

        RefreshList = False
        Call UpdateTechChecks()
        Call UpdatePriceList()
        RefreshList = True

    End Sub

    Private Sub chkSystems1_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkSystems1.CheckedChanged, chkSystems2.CheckedChanged, chkSystems3.CheckedChanged,
            chkSystems4.CheckedChanged, chkSystems5.CheckedChanged, chkSystems6.CheckedChanged
        If Not UpdatingCheck Then
            Call SyncPriceCheckBoxes(CInt(CType(sender, CheckBox).Name.ToString.Substring(Len(CType(sender, CheckBox).Name.ToString) - 1)))
        End If
    End Sub

    Private Sub SyncPriceCheckBoxes(ByVal TriggerIndex As Integer)
        Dim i As Integer

        If Not FirstLoad Then
            UpdatingCheck = True

            ' Allow them to toggle both but if either Jita or Perimeter selected, clear all others
            If TriggerIndex = 1 Or TriggerIndex = 6 Then
                ' clear the others except 1 or 6
                SystemCheckBoxes(2).Checked = False
                SystemCheckBoxes(3).Checked = False
                SystemCheckBoxes(4).Checked = False
                SystemCheckBoxes(5).Checked = False
            Else
                ' Trigger Index is a box that was checked on or off
                If SystemCheckBoxes(TriggerIndex).Checked = True Then
                    ' Uncheck all other systems and regions
                    ' Clear all the boxes
                    For i = 1 To SystemCheckBoxes.Length - 1
                        If i <> TriggerIndex Then
                            SystemCheckBoxes(i).Checked = False
                        End If
                    Next
                End If
            End If

            cmbPriceRegions.Text = DefaultRegionPriceCombo
            cmbPriceSystems.Text = DefaultSystemPriceCombo

            PreviousPriceRegion = ""

            UpdatingCheck = False

        End If

    End Sub

    Private Sub cmbPriceSystems_DropDownClosed(sender As Object, e As System.EventArgs) Handles cmbPriceSystems.DropDownClosed
        ' If it closes up, re-enable autocomplete
        cmbPriceSystems.AutoCompleteMode = AutoCompleteMode.SuggestAppend
    End Sub

    Private Sub cmbPriceSystems_GotFocus(sender As Object, e As System.EventArgs) Handles cmbPriceSystems.GotFocus
        cmbPriceSystems.SelectAll()
    End Sub

    Private Sub cmbPriceShipTypes_SelectedIndexChanged(sender As System.Object, e As System.EventArgs) Handles cmbPriceShipTypes.SelectedIndexChanged
        If Not FirstPriceShipTypesComboLoad Then
            Call UpdatePriceList()
        End If
    End Sub

    Private Sub cmbPriceChargeTypes_SelectedIndexChanged(sender As System.Object, e As System.EventArgs) Handles cmbPriceChargeTypes.SelectedIndexChanged
        If Not FirstPriceChargeTypesComboLoad Then
            Call UpdatePriceList()
        End If
    End Sub

    Private Sub lstPricesView_ColumnClick(sender As System.Object, e As System.Windows.Forms.ColumnClickEventArgs) Handles lstPricesView.ColumnClick
        Call ListViewColumnSorter(e.Column, CType(lstPricesView, ListView), UpdatePricesColumnClicked, UpdatePricesColumnSortType)
    End Sub

    Private Sub rbtnPriceSettingPriceProfile_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles rbtnPriceSettingPriceProfile.CheckedChanged
        ' set in init, and use this to toggle
        If rbtnPriceSettingPriceProfile.Checked Then
            gbSingleSource.Enabled = False
            gbPriceProfile.Enabled = True
            ' Disable other buttons and lists
            cmbRawMatsSplitPrices.Enabled = False
            lblRawMatsSplitPrices.Enabled = False
            cmbItemsSplitPrices.Enabled = False
            lblItemsSplitPrices.Enabled = False
            lblRawPriceModifier.Enabled = False
            lblItemsPriceModifier.Enabled = False
            txtRawPriceModifier.Enabled = False
            txtItemsPriceModifier.Enabled = False
        Else
            gbSingleSource.Enabled = True
            gbPriceProfile.Enabled = False
            ' Enable other buttons and lists
            cmbRawMatsSplitPrices.Enabled = True
            lblRawMatsSplitPrices.Enabled = True
            cmbItemsSplitPrices.Enabled = True
            lblItemsSplitPrices.Enabled = True
            lblRawPriceModifier.Enabled = True
            lblItemsPriceModifier.Enabled = True
            txtRawPriceModifier.Enabled = True
            txtItemsPriceModifier.Enabled = True
        End If
    End Sub

    Private Sub txtRawPriceModifier_KeyPress(sender As System.Object, e As System.Windows.Forms.KeyPressEventArgs) Handles txtRawPriceModifier.KeyPress
        e.Handled = CheckPercentCharEntry(e, txtRawPriceModifier)
    End Sub

    Private Sub txtItemsPriceModifier_KeyPress(sender As System.Object, e As System.Windows.Forms.KeyPressEventArgs) Handles txtItemsPriceModifier.KeyPress
        e.Handled = CheckPercentCharEntry(e, txtItemsPriceModifier)
    End Sub

    Private Sub txtRawPriceModifier_LostFocus(sender As Object, e As System.EventArgs) Handles txtRawPriceModifier.LostFocus
        txtRawPriceModifier.Text = FormatPriceModifier(txtRawPriceModifier)
    End Sub

    Private Sub txtItemsPriceModifier_LostFocus(sender As Object, e As System.EventArgs) Handles txtItemsPriceModifier.LostFocus
        txtItemsPriceModifier.Text = FormatPriceModifier(txtItemsPriceModifier)
    End Sub

    Private Function FormatPriceModifier(PricetxtBox As TextBox) As String
        If Trim(PricetxtBox.Text) = "" Then
            Return "0.0%"
        Else
            Return FormatPercent(CDbl(PricetxtBox.Text.Replace("%", "")) / 100, 1)
        End If
    End Function

    Private Sub txtPPDefaultsPriceMod_LostFocus(sender As Object, e As System.EventArgs) Handles txtPPDefaultsPriceMod.LostFocus
        txtPPDefaultsPriceMod.Text = FormatPriceModifier(txtPPDefaultsPriceMod)
    End Sub

    Private Sub txtPPDefaultsPriceMod_KeyPress(sender As Object, e As System.Windows.Forms.KeyPressEventArgs) Handles txtPPDefaultsPriceMod.KeyPress
        e.Handled = CheckPercentCharEntry(e, txtPPDefaultsPriceMod)
    End Sub

    Private Sub cmbPPDefaultsRegion_SelectedIndexChanged(sender As System.Object, e As System.EventArgs) Handles cmbPPDefaultsRegion.SelectedIndexChanged
        If PreviousPPRegion <> cmbPPDefaultsRegion.Text Then
            PPSystemsLoaded = False
            cmbPPDefaultsSystem.Text = AllSystems
            PreviousPPRegion = cmbPPDefaultsRegion.Text
        End If
    End Sub

    Private Sub cmbPPDefaultsRegion_DropDown(sender As System.Object, e As System.EventArgs) Handles cmbPPDefaultsRegion.DropDown
        If Not PPRegionsLoaded Then
            Call LoadRegionCombo(cmbPPDefaultsRegion, cmbPPDefaultsRegion.Text)
            PPRegionsLoaded = True
        End If
    End Sub

    Private Sub cmbPPDefaultsSystem_DropDown(sender As System.Object, e As System.EventArgs) Handles cmbPPDefaultsSystem.DropDown
        If Not PPSystemsLoaded Then
            Call LoadSystemCombo(cmbPPDefaultsSystem, cmbPPDefaultsRegion.Text, AllSystems)
            PPSystemsLoaded = True
        End If
    End Sub

    Private Sub cmbPriceRegion_DropDown(sender As System.Object, e As System.EventArgs) Handles cmbPriceRegions.DropDown
        If Not PriceRegionsLoaded Then
            Call LoadRegionCombo(cmbPriceRegions, cmbPriceRegions.Text)
            PriceRegionsLoaded = True
        End If
    End Sub

    Private Sub cmbPriceRegion_SelectedIndexChanged(sender As System.Object, e As System.EventArgs) Handles cmbPriceRegions.SelectedIndexChanged
        If PreviousPriceRegion <> cmbPriceRegions.Text Then
            PriceSystemsLoaded = False
            PreviousPriceRegion = cmbPriceRegions.Text
            UpdatingCheck = True
            Call ClearTradeHubSystems() ' clear the checks for trade hubs
            UpdatingCheck = False
            ' Set up systems combo
            Call LoadSystemCombo(cmbPriceSystems, cmbPriceRegions.Text, AllSystems)
            PriceSystemsLoaded = True
        End If
    End Sub

    Private Sub cmbPriceSystems_DropDown(sender As System.Object, e As System.EventArgs) Handles cmbPriceSystems.DropDown
        If Not PriceSystemsLoaded Then
            Call LoadSystemCombo(cmbPriceSystems, cmbPriceRegions.Text, AllSystems)
            PriceSystemsLoaded = True
        End If
    End Sub

    Private Sub cmbPriceSystems_SelectedIndexChanged(sender As System.Object, e As System.EventArgs) Handles cmbPriceSystems.SelectedIndexChanged
        If cmbPriceSystems.Text <> DefaultSystemPriceCombo Then
            Call ClearTradeHubSystems(False)
        End If
    End Sub

    Private Sub btnPPUpdateDefaults_Click(sender As System.Object, e As System.EventArgs) Handles btnPPUpdateDefaults.Click

        ' Do some error checking first
        If Trim(cmbPPDefaultsRegion.Text) = "" Or Not cmbPPDefaultsRegion.Items.Contains(cmbPPDefaultsRegion.Text) Then
            MsgBox("Invalid Default Region", vbExclamation, Application.ProductName)
            cmbPPDefaultsRegion.Focus()
            Exit Sub
        End If

        If Trim(cmbPPDefaultsSystem.Text) = "" Or Not cmbPPDefaultsSystem.Items.Contains(cmbPPDefaultsSystem.Text) Then
            MsgBox("Invalid Default System", vbExclamation, Application.ProductName)
            cmbPPDefaultsSystem.Focus()
            Exit Sub
        End If

        If Trim(txtPPDefaultsPriceMod.Text) = "" Then
            MsgBox("Invalid Default Price Modifier", vbExclamation, Application.ProductName)
            txtPPDefaultsPriceMod.Focus()
            Exit Sub
        End If

        Dim SQL As String = ""

        SQL = "UPDATE PRICE_PROFILES SET PRICE_TYPE = '" & Trim(cmbPPDefaultsPriceType.Text) & "', REGION_NAME = '" & FormatDBString(cmbPPDefaultsRegion.Text) & "', "
        SQL &= "SOLAR_SYSTEM_NAME = '" & FormatDBString(cmbPPDefaultsSystem.Text) & "', PRICE_MODIFIER = " & CStr(CDbl(txtPPDefaultsPriceMod.Text.Replace("%", "")) / 100) & " "
        SQL &= "WHERE ID IN (" & SelectedCharacter.ID & ",0) AND RAW_MATERIAL = "

        If tabPriceProfile.SelectedTab.TabIndex = 0 Then
            SQL &= "1"
        Else
            SQL &= "0"
        End If

        EVEDB.ExecuteNonQuerySQL(SQL)

        ' Refresh the grids
        Call LoadPriceProfileGrids()

        MsgBox("Defaults set", vbInformation, Application.ProductName)

    End Sub

#End Region

    ' Initalizes all the prices tab boxes, etc
    Private Sub InitUpdatePricesTab()
        Dim TempRegion As String = ""

        FirstPriceChargeTypesComboLoad = True
        FirstPriceShipTypesComboLoad = True
        RefreshList = False

        Call ClearTradeHubSystems()

        txtPriceItemFilter.Text = ""

        With UserUpdatePricesTabSettings
            chkPriceMaterialResearchEqPrices.Checked = .AllRawMats
            RunUpdatePriceList = False ' If the settings trigger an update, we don't want to update the prices
            chkAdvancedProtectiveTechnology.Checked = .AdvancedProtectiveTechnology
            chkGas.Checked = .Gas
            chkIceProducts.Checked = .IceProducts
            chkMolecularForgingTools.Checked = .MolecularForgingTools
            chkFactionMaterials.Checked = .FactionMaterials
            chkNamedComponents.Checked = .NamedComponents
            chkMinerals.Checked = .Minerals
            chkPlanetary.Checked = .Planetary
            chkRawMaterials.Checked = .RawMaterials
            chkSalvage.Checked = .Salvage
            chkMisc.Checked = .Misc
            Select Case .BPCs
                Case 2
                    chkBPCs.CheckState = CheckState.Indeterminate
                Case 1
                    chkBPCs.CheckState = CheckState.Checked
                Case 0
                    chkBPCs.CheckState = CheckState.Unchecked
            End Select
            chkAncientRelics.Checked = .AncientRelics
            chkDatacores.Checked = .Datacores
            chkDecryptors.Checked = .Decryptors
            chkRDb.Checked = .RDB

            chkAdvancedMats.Checked = .AdvancedMoonMats
            chkBoosterMats.Checked = .BoosterMats
            chkMolecularForgedMaterials.Checked = .MolecularForgedMats
            chkPolymers.Checked = .Polymers
            chkProcessedMats.Checked = .ProcessedMoonMats
            chkRawMoonMats.Checked = .RawMoonMats

            chkPriceManufacturedPrices.Checked = .AllManufacturedItems
            RunUpdatePriceList = False ' If the settings trigger an update, we don't want to update the prices
            chkShips.Checked = .Ships
            chkCharges.Checked = .Charges
            chkModules.Checked = .Modules
            chkDrones.Checked = .Drones
            chkRigs.Checked = .Rigs
            chkSubsystems.Checked = .Subsystems
            chkDeployables.Checked = .Deployables
            chkBoosters.Checked = .Boosters
            chkStructures.Checked = .Structures
            chkStructureRigs.Checked = .StructureRigs
            chkCelestials.Checked = .Celestials
            chkStructureModules.Checked = .StructureModules
            chkImplants.Checked = .Implants

            chkCapT2Components.Checked = .AdvancedCapComponents
            chkComponents.Checked = .AdvancedComponents
            chkFuelBlocks.Checked = .FuelBlocks
            chkProtectiveComponents.Checked = .ProtectiveComponents
            chkRAM.Checked = .RAM
            chkNoBuildItems.Checked = .NoBuildItems
            chkCapitalShipComponents.Checked = .CapitalShipComponents
            chkStructureComponents.Checked = .StructureComponents
            chkSubsystemComponents.Checked = .SubsystemComponents

            chkPricesT1.Checked = .T1
            chkPricesT2.Checked = .T2
            chkPricesT3.Checked = .T3
            chkPricesT4.Checked = .Storyline
            chkPricesT5.Checked = .Faction
            chkPricesT6.Checked = .Pirate

            cmbItemsSplitPrices.Text = .ItemsCombo
            cmbRawMatsSplitPrices.Text = .RawMatsCombo
            txtRawPriceModifier.Text = FormatPercent(.RawPriceModifier, 1)
            txtItemsPriceModifier.Text = FormatPercent(.ItemsPriceModifier, 1)

            Select Case .PriceDataSource
                Case DataSource.CCP
                    rbtnPriceSourceCCPData.Checked = True
                Case DataSource.EVEMarketer
                    rbtnPriceSourceEM.Checked = True
                Case DataSource.Fuzzworks
                    rbtnPriceSourceFW.Checked = True
            End Select

            If .UsePriceProfile Then
                rbtnPriceSettingPriceProfile.Checked = True
                gbSingleSource.Enabled = False
                gbPriceProfile.Enabled = True
                ' Disable other buttons and lists
                cmbRawMatsSplitPrices.Enabled = False
                lblRawMatsSplitPrices.Enabled = False
                cmbItemsSplitPrices.Enabled = False
                lblItemsSplitPrices.Enabled = False
                lblRawPriceModifier.Enabled = False
                lblItemsPriceModifier.Enabled = False
                txtRawPriceModifier.Enabled = False
                txtItemsPriceModifier.Enabled = False
            Else
                rbtnPriceSettingSingleSelect.Checked = True
                gbSingleSource.Enabled = True
                gbPriceProfile.Enabled = False
                ' Enable other buttons and lists
                cmbRawMatsSplitPrices.Enabled = True
                lblRawMatsSplitPrices.Enabled = True
                cmbItemsSplitPrices.Enabled = True
                lblItemsSplitPrices.Enabled = True
                lblRawPriceModifier.Enabled = True
                lblItemsPriceModifier.Enabled = True
                txtRawPriceModifier.Enabled = True
                txtItemsPriceModifier.Enabled = True
            End If

            tabPriceProfile.SelectedTab = tabPriceProfile.TabPages(0)

            ' Set the defaults for the default price profiles
            cmbPPDefaultsPriceType.Text = .PPRawPriceType
            ' First load the regions combo, then set the default region
            PreviousPPRegion = .PPRawRegion
            Call LoadRegionCombo(cmbPPDefaultsRegion, .PPRawRegion)
            ' Now that we have the default region, load up the systems based on that
            Call LoadSystemCombo(cmbPPDefaultsSystem, .PPRawRegion, .PPRawSystem)
            txtPPDefaultsPriceMod.Text = FormatPercent(.PPRawPriceMod, 1)
            PPSystemsLoaded = False

        End With

        RunUpdatePriceList = True
        RefreshList = True

        ' Disable cancel
        btnCancelUpdate.Enabled = False

        ' Set system/region 
        If UserUpdatePricesTabSettings.SelectedRegion = "0" Then
            ' They set only the trade hubs
            Select Case UserUpdatePricesTabSettings.SelectedSystem
                Case "Jita"
                    chkSystems1.Checked = True
                Case "Perimeter"
                    chkSystems6.Checked = True
                Case "Amarr"
                    chkSystems2.Checked = True
                Case "Dodixie"
                    chkSystems3.Checked = True
                Case "Rens"
                    chkSystems4.Checked = True
                Case "Hek"
                    chkSystems5.Checked = True
                Case "JitaPerimeter", "PerimeterJita"
                    chkSystems1.Checked = True
                    chkSystems6.Checked = True
            End Select
            ' Set these to default
            cmbPriceRegions.Text = DefaultRegionPriceCombo
            cmbPriceSystems.Text = DefaultSystemPriceCombo

        Else ' They set a region and/or system
            cmbPriceRegions.Text = UserUpdatePricesTabSettings.SelectedRegion
            ' Preload the systems combo
            Dim SelectedSystem As String
            If cmbPriceRegions.Text <> DefaultRegionPriceCombo Then
                SelectedSystem = UserUpdatePricesTabSettings.SelectedSystem
            Else
                SelectedSystem = DefaultSystemPriceCombo
            End If
            Call LoadSystemCombo(cmbPriceSystems, cmbPriceRegions.Text, SelectedSystem)
        End If

        UpdatePricesColumnClicked = UserUpdatePricesTabSettings.ColumnSort
        If UserUpdatePricesTabSettings.ColumnSortType = "Ascending" Then
            UpdatePricesColumnSortType = SortOrder.Ascending
        Else
            UpdatePricesColumnSortType = SortOrder.Descending
        End If

        ' Load up the price profile grids
        Call LoadPriceProfileGrids()

        ' Refresh the prices
        Call UpdatePriceList()

    End Sub

    ' Save the settings
    Private Sub btnSaveUpdatePrices_Click(sender As System.Object, e As System.EventArgs) Handles btnSaveUpdatePrices.Click
        Dim i As Integer
        Dim TempSettings As UpdatePriceTabSettings = Nothing
        Dim TempRegions As New List(Of String)

        Dim RegionChecked As Boolean = False
        Dim SystemChecked As Boolean = False
        Dim SearchSystem As String = ""

        ' Make sure they have at least one region checked first
        If cmbPriceRegions.Text <> DefaultRegionPriceCombo Then
            RegionChecked = True
        End If

        ' Check systems too
        For i = 1 To SystemCheckBoxes.Length - 1
            If SystemCheckBoxes(i).Checked = True Then
                ' Save the checked system (can only be one)
                SearchSystem = SystemCheckBoxes(i).Text
                SystemChecked = True
                Exit For
            End If
        Next

        If Not RegionChecked And Not SystemChecked And Not rbtnPriceSettingPriceProfile.Checked Then
            MsgBox("Must Choose a Region or System", MsgBoxStyle.Exclamation, Me.Name)
            Exit Sub
        End If

        If Not ItemsSelected() Then
            MsgBox("Must Choose at least one Item type", MsgBoxStyle.Exclamation, Me.Name)
            Exit Sub
        End If

        TempSettings.ItemsCombo = cmbItemsSplitPrices.Text
        TempSettings.RawMatsCombo = cmbRawMatsSplitPrices.Text

        TempSettings.RawPriceModifier = CDbl(txtRawPriceModifier.Text.Replace("%", "")) / 100
        TempSettings.ItemsPriceModifier = CDbl(txtItemsPriceModifier.Text.Replace("%", "")) / 100

        ' Search for a set system first
        TempSettings.SelectedSystem = ""
        If cmbPriceSystems.Text <> DefaultSystemPriceCombo And cmbPriceSystems.Text <> AllSystems Then
            TempSettings.SelectedSystem = cmbPriceSystems.Text
        Else
            For i = 1 To SystemCheckBoxes.Count - 1
                If SystemCheckBoxes(i).Checked Then
                    ' Save it
                    TempSettings.SelectedSystem &= SystemCheckBoxes(i).Text
                End If
            Next
        End If

        ' If no system found, then region
        TempSettings.SelectedRegion = "0" ' Save something we can check so the default not loaded
        If cmbPriceRegions.Text <> DefaultRegionPriceCombo Then
            TempSettings.SelectedRegion = cmbPriceRegions.Text
        End If

        ' Raw items
        ' Manufactured Items
        With TempSettings
            .AllRawMats = chkPriceMaterialResearchEqPrices.Checked

            .AdvancedProtectiveTechnology = chkAdvancedProtectiveTechnology.Checked
            .Gas = chkGas.Checked
            .IceProducts = chkIceProducts.Checked
            .MolecularForgingTools = chkMolecularForgingTools.Checked
            .FactionMaterials = chkFactionMaterials.Checked
            .NamedComponents = chkNamedComponents.Checked
            .Minerals = chkMinerals.Checked
            .Planetary = chkPlanetary.Checked
            .RawMaterials = chkRawMaterials.Checked
            .Salvage = chkSalvage.Checked
            .Misc = chkMisc.Checked
            If chkBPCs.CheckState = CheckState.Indeterminate Then
                .BPCs = 2
            ElseIf chkBPCs.CheckState = CheckState.Checked Then
                .BPCs = 1
            ElseIf chkBPCs.CheckState = CheckState.Unchecked Then
                .BPCs = 0
            End If
            .AncientRelics = chkAncientRelics.Checked
            .Datacores = chkDatacores.Checked
            .Decryptors = chkDecryptors.Checked
            .RDB = chkRDb.Checked

            .AdvancedMoonMats = chkAdvancedMats.Checked
            .BoosterMats = chkBoosterMats.Checked
            .MolecularForgedMats = chkMolecularForgedMaterials.Checked
            .Polymers = chkPolymers.Checked
            .ProcessedMoonMats = chkProcessedMats.Checked
            .RawMoonMats = chkRawMoonMats.Checked

            .AllManufacturedItems = chkPriceManufacturedPrices.Checked

            .Ships = chkShips.Checked
            .Charges = chkCharges.Checked
            .Modules = chkModules.Checked
            .Drones = chkDrones.Checked
            .Rigs = chkRigs.Checked
            .Subsystems = chkSubsystems.Checked
            .Deployables = chkDeployables.Checked
            .Boosters = chkBoosters.Checked
            .Structures = chkStructures.Checked
            .StructureRigs = chkStructureRigs.Checked
            .Celestials = chkCelestials.Checked
            .StructureModules = chkStructureModules.Checked
            .Implants = chkImplants.Checked

            .AdvancedCapComponents = chkCapT2Components.Checked
            .AdvancedComponents = chkComponents.Checked
            .FuelBlocks = chkFuelBlocks.Checked
            .ProtectiveComponents = chkProtectiveComponents.Checked
            .RAM = chkRAM.Checked
            .NoBuildItems = chkNoBuildItems.Checked
            .CapitalShipComponents = chkCapitalShipComponents.Checked
            .StructureComponents = chkStructureComponents.Checked
            .SubsystemComponents = chkSubsystemComponents.Checked

            .T1 = chkPricesT1.Checked
            .T2 = chkPricesT2.Checked
            .T3 = chkPricesT3.Checked
            .Storyline = chkPricesT4.Checked
            .Faction = chkPricesT5.Checked
            .Pirate = chkPricesT6.Checked

            If rbtnPriceSourceCCPData.Checked Then
                .PriceDataSource = DataSource.CCP
            ElseIf rbtnPriceSourceEM.Checked Then
                .PriceDataSource = DataSource.EVEMarketer
            ElseIf rbtnPriceSourceFW.Checked Then
                .PriceDataSource = DataSource.Fuzzworks
            End If

            If rbtnPriceSettingPriceProfile.Checked Then
                .UsePriceProfile = True
            Else
                .UsePriceProfile = False
            End If

            ' Price profile defaults
            If tabPriceProfile.SelectedTab.TabIndex = 0 Then
                .PPRawPriceType = cmbPPDefaultsPriceType.Text
                .PPRawRegion = cmbPPDefaultsRegion.Text
                .PPRawSystem = cmbPPDefaultsSystem.Text
                .PPRawPriceMod = CDbl(txtPPDefaultsPriceMod.Text.Replace("%", "")) / 100
                ' Save the current item settings too
                .PPItemsPriceType = UserUpdatePricesTabSettings.PPItemsPriceType
                .PPItemsRegion = UserUpdatePricesTabSettings.PPItemsRegion
                .PPItemsSystem = UserUpdatePricesTabSettings.PPItemsSystem
                .PPItemsPriceMod = UserUpdatePricesTabSettings.PPItemsPriceMod
            Else
                .PPItemsPriceType = cmbPPDefaultsPriceType.Text
                .PPItemsRegion = cmbPPDefaultsRegion.Text
                .PPItemsSystem = cmbPPDefaultsSystem.Text
                .PPItemsPriceMod = CDbl(txtPPDefaultsPriceMod.Text.Replace("%", "")) / 100
                ' Save the current raw settings too
                .PPRawPriceType = UserUpdatePricesTabSettings.PPRawPriceType
                .PPRawRegion = UserUpdatePricesTabSettings.PPRawRegion
                .PPRawSystem = UserUpdatePricesTabSettings.PPRawSystem
                .PPRawPriceMod = UserUpdatePricesTabSettings.PPRawPriceMod
            End If
        End With

        TempSettings.ColumnSort = UpdatePricesColumnClicked

        If UpdatePricesColumnSortType = SortOrder.Ascending Then
            TempSettings.ColumnSortType = "Ascending"
        Else
            TempSettings.ColumnSortType = "Descending"
        End If

        ' Save the data in the XML file
        Call AllSettings.SaveUpdatePricesSettings(TempSettings)

        ' Save the data to the local variable
        UserUpdatePricesTabSettings = TempSettings

        MsgBox("Update Prices Settings Saved", vbInformation, Application.ProductName)
        btnDownloadPrices.Focus()
        Application.UseWaitCursor = False

    End Sub

    ' If we change tabs, save the previous tab info in the settings and load the selected tab
    Private Sub tabPriceProfile_SelectedIndexChanged(sender As Object, e As EventArgs) Handles tabPriceProfile.SelectedIndexChanged
        If Not FirstLoad Then
            With UserUpdatePricesTabSettings
                If tabPriceProfile.SelectedTab.TabIndex = 0 Then
                    ' First save the items settings
                    .PPItemsPriceType = cmbPPDefaultsPriceType.Text
                    .PPItemsRegion = cmbPPDefaultsRegion.Text
                    .PPItemsSystem = cmbPPDefaultsSystem.Text
                    .PPItemsPriceMod = CDbl(txtPPDefaultsPriceMod.Text.Replace("%", "")) / 100

                    cmbPPDefaultsPriceType.Text = .PPRawPriceType
                    PreviousPPRegion = .PPRawRegion
                    Call LoadRegionCombo(cmbPPDefaultsRegion, .PPRawRegion)
                    Call LoadSystemCombo(cmbPPDefaultsSystem, .PPRawRegion, .PPRawSystem)
                    txtPPDefaultsPriceMod.Text = FormatPercent(.PPRawPriceMod, 1)
                Else
                    ' First save the raw settings
                    .PPRawPriceType = cmbPPDefaultsPriceType.Text
                    .PPRawRegion = cmbPPDefaultsRegion.Text
                    .PPRawSystem = cmbPPDefaultsSystem.Text
                    .PPRawPriceMod = CDbl(txtPPDefaultsPriceMod.Text.Replace("%", "")) / 100

                    cmbPPDefaultsPriceType.Text = .PPItemsPriceType
                    PreviousPPRegion = .PPItemsRegion
                    Call LoadRegionCombo(cmbPPDefaultsRegion, .PPItemsRegion)
                    Call LoadSystemCombo(cmbPPDefaultsSystem, .PPItemsRegion, .PPItemsSystem)
                    txtPPDefaultsPriceMod.Text = FormatPercent(.PPItemsPriceMod, 1)
                End If
                PPSystemsLoaded = True
            End With
        End If

    End Sub

    ' Structure for loading price profiles in the appropriate grids
    Private Structure PriceProfile
        Dim GroupName As String
        Dim PriceType As String
        Dim RegionName As String
        Dim SolarSystemName As String
        Dim PriceModifier As Double
        Dim RawMaterial As Boolean
    End Structure

    ' Loads the price profiles system combo
    Private Sub LoadSystemCombo(ByRef SystemCombo As ComboBox, ByVal Region As String, ByVal System As String)

        If Region <> DefaultRegionPriceCombo Then
            Dim SQL As String = ""
            Dim rsData As SQLiteDataReader
            Dim SystemName As String

            SQL = "SELECT solarSystemName FROM SOLAR_SYSTEMS, REGIONS "
            SQL &= "WHERE SOLAR_SYSTEMS.regionID = REGIONS.regionID "
            SQL &= "AND REGIONS.regionName = '" & Region & "' ORDER BY solarSystemName"

            DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
            rsData = DBCommand.ExecuteReader
            SystemCombo.BeginUpdate()
            SystemCombo.Items.Clear()
            ' Add the all systems item
            SystemCombo.Items.Add(AllSystems)
            While rsData.Read
                SystemName = rsData.GetString(0)
                SystemCombo.Items.Add(SystemName)
                If SystemName = "Jita" Then
                    ' Add Jita/Perimeter
                    SystemCombo.Items.Add(JitaPerimeter)
                End If
            End While
            SystemCombo.EndUpdate()
            rsData.Close()
            SystemCombo.Text = System
        End If

    End Sub

    ' Loads up the settings in the price profile grids on update prices
    Private Sub LoadPriceProfileGrids()
        Dim rsPP As SQLiteDataReader
        Dim SQL As String
        Dim GroupRawFlagList As String = ""
        Dim Profiles As New List(Of PriceProfile)
        Dim TempProfile As PriceProfile

        SQL = "SELECT GROUP_NAME, PRICE_TYPE, REGION_NAME, SOLAR_SYSTEM_NAME, PRICE_MODIFIER, RAW_MATERIAL "
        SQL &= "FROM PRICE_PROFILES WHERE ID = " & CStr(SelectedCharacter.ID)
        DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
        rsPP = DBCommand.ExecuteReader

        While rsPP.Read
            ' Build the list of groups we have, then use to query the ones we don't
            GroupRawFlagList = GroupRawFlagList & "AND NOT (GROUP_NAME ='" & rsPP.GetString(0) & "' AND RAW_MATERIAL =" & CStr(rsPP.GetInt32(5)) & ") "

            TempProfile.GroupName = rsPP.GetString(0)
            TempProfile.PriceType = rsPP.GetString(1)
            TempProfile.RegionName = rsPP.GetString(2)
            TempProfile.SolarSystemName = rsPP.GetString(3)
            TempProfile.PriceModifier = rsPP.GetDouble(4)
            TempProfile.RawMaterial = CBool(rsPP.GetInt32(5))
            Profiles.Add(TempProfile)
        End While

        rsPP.Close()

        ' Now get everything we don't have
        SQL = "SELECT GROUP_NAME, PRICE_TYPE, REGION_NAME, SOLAR_SYSTEM_NAME, PRICE_MODIFIER, RAW_MATERIAL "
        SQL &= "FROM PRICE_PROFILES WHERE ID = 0 " & GroupRawFlagList & ""
        DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
        rsPP = DBCommand.ExecuteReader

        While rsPP.Read
            TempProfile.GroupName = rsPP.GetString(0)
            TempProfile.PriceType = rsPP.GetString(1)
            TempProfile.RegionName = rsPP.GetString(2)
            TempProfile.SolarSystemName = rsPP.GetString(3)
            TempProfile.PriceModifier = rsPP.GetDouble(4)
            TempProfile.RawMaterial = CBool(rsPP.GetInt32(5))
            Profiles.Add(TempProfile)
        End While

        rsPP.Close()

        ' Load the lists
        Dim listRow As New ListViewItem
        lstRawPriceProfile.Items.Clear()
        lstManufacturedPriceProfile.Items.Clear()
        lstRawPriceProfile.BeginUpdate()
        lstManufacturedPriceProfile.BeginUpdate()

        For i = 0 To Profiles.Count - 1
            With Profiles(i)
                listRow = New ListViewItem(.GroupName)
                'The remaining columns are subitems  
                listRow.SubItems.Add(.PriceType)
                listRow.SubItems.Add(.RegionName)
                listRow.SubItems.Add(.SolarSystemName)
                listRow.SubItems.Add(FormatPercent(.PriceModifier, 1))

                If .RawMaterial Then
                    Call lstRawPriceProfile.Items.Add(listRow)
                Else
                    Call lstManufacturedPriceProfile.Items.Add(listRow)
                End If
            End With
        Next

        ' Sort by group name - don't enable column sorting here - use desc since the function flips it
        Call ListViewColumnSorter(0, CType(lstRawPriceProfile, ListView), 0, SortOrder.Descending)
        Call ListViewColumnSorter(0, CType(lstManufacturedPriceProfile, ListView), 0, SortOrder.Descending)

        lstRawPriceProfile.EndUpdate()
        lstManufacturedPriceProfile.EndUpdate()

    End Sub

    Private Sub lstPricesView_MouseClick(sender As Object, e As System.Windows.Forms.MouseEventArgs) Handles lstPricesView.MouseClick
        Call ListClicked(lstPricesView, sender, e)
    End Sub

    Private Sub lstRawPriceProfile_MouseClick(sender As System.Object, e As System.Windows.Forms.MouseEventArgs) Handles lstRawPriceProfile.MouseClick
        Call ListClicked(lstRawPriceProfile, sender, e)
    End Sub

    Private Sub lstManufacturedPriceProfile_MouseClick(sender As System.Object, e As System.Windows.Forms.MouseEventArgs) Handles lstManufacturedPriceProfile.MouseClick
        Call ListClicked(lstManufacturedPriceProfile, sender, e)
    End Sub

    Private Sub btnAddStructureIDs_Click(sender As Object, e As EventArgs) Handles btnAddStructureIDs.Click
        Dim f1 As New frmAddStructureIDs

        f1.ShowDialog()

    End Sub

    ' Checks the user entry and then sends the type ids and regions to the cache update
    Private Sub btnImportPrices_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnDownloadPrices.Click
        Dim RegionSelected As Boolean
        Dim SystemSelected As Boolean
        Dim readerSystems As SQLiteDataReader
        Dim SQL As String

        Dim RegionName As String = ""
        Dim Items As New List(Of PriceItem)
        Dim BlueprintItems As New List(Of PriceItem)
        Dim TempItem As PriceItem
        Dim SearchRegion As String = ""
        Dim SearchSystem As String = ""
        Dim BPCRegion As String = "" ' Region to use for BPC Contract price updates
        Dim SearchStructureID As String = ""
        Dim NumSystems As Integer = 0

        RegionSelected = False
        SystemSelected = False

        Dim DataErrors As Boolean = True

        ' Progress Bar Init
        pnlProgressBar.Value = 0

        Dim RegionSelectedCount As Integer = 0
        Dim JitaPerimeterChecked As Boolean = False

        ' Check region
        If cmbPriceRegions.Text <> DefaultRegionPriceCombo Then
            RegionSelected = True
        End If

        ' Check systems too
        For i = 1 To SystemCheckBoxes.Length - 1
            If SystemCheckBoxes(i).Checked = True Then
                ' Save the checked system (can only be one)
                SearchSystem = SystemCheckBoxes(i).Text
                SystemSelected = True
                Exit For
            End If
        Next

        If (chkSystems1.Checked And chkSystems6.Checked And rbtnPriceSettingSingleSelect.Checked) Or cmbPriceSystems.Text = JitaPerimeter Then
            ' Need to run for both for non-price profile 
            JitaPerimeterChecked = True
        End If

        ' Finally check system combo
        If Not SystemSelected And cmbPriceSystems.Text <> DefaultSystemPriceCombo And cmbPriceSystems.Text <> AllSystems Then
            SystemSelected = True
            SearchSystem = cmbPriceSystems.Text
        End If

        If Not RegionSelected And Not SystemSelected And Not rbtnPriceSettingPriceProfile.Checked Then
            MsgBox("Must Choose a Region or System", MsgBoxStyle.Exclamation, Me.Name)
            GoTo ExitSub
        End If

        If (Trim(cmbPriceSystems.Text) = "" Or (Not cmbPriceSystems.Items.Contains(cmbPriceSystems.Text) And cmbPriceSystems.Text <> DefaultSystemPriceCombo)) And rbtnPriceSettingSingleSelect.Checked And cmbPriceSystems.Enabled Then
            MsgBox("Invalid Solar System Name", vbCritical, Application.ProductName)
            GoTo ExitSub
        End If

        If Not ItemsSelected() Then
            MsgBox("Must Choose at least one Item type", MsgBoxStyle.Exclamation, Me.Name)
            GoTo ExitSub
        End If

        If rbtnPriceSourceCCPData.Checked And RegionSelectedCount > 1 Then
            MsgBox("You cannot choose more than one region when downloading CCP Data", MsgBoxStyle.Exclamation, Me.Name)
            GoTo ExitSub
        End If

        DataErrors = False

        ' Working
        Call DisableUpdatePricesTab(True)

        Dim SavedgbPPValue As Boolean = gbPriceProfile.Enabled
        Dim SavedgbSSValue As Boolean = gbSingleSource.Enabled

        gbPriceProfile.Enabled = False
        gbSingleSource.Enabled = False

        ' Enable cancel
        btnCancelUpdate.Enabled = True

        ' Set the source for the entire update
        If rbtnPriceSourceEM.Checked Then
            UpdatePricesDataSource = CStr(CInt(DataSource.EVEMarketer))
        ElseIf rbtnPriceSourceFW.Checked Then
            UpdatePricesDataSource = CStr(CInt(DataSource.Fuzzworks))
        ElseIf rbtnPriceSourceCCPData.Checked Then
            UpdatePricesDataSource = CStr(CInt(DataSource.CCP))
        End If

        Me.Refresh()
        Me.Cursor = Cursors.WaitCursor
        pnlStatus.Text = "Initializing Query..."
        Application.DoEvents()

        ' Find the selected region - single select
        If rbtnPriceSettingSingleSelect.Checked Then
            If RegionSelected And Not SystemSelected Then ' If they selected a region but not a system, look up region data
                ' Get the search list string
                SQL = "SELECT regionID FROM REGIONS "
                SQL &= "WHERE regionName = '" & cmbPriceRegions.Text & "'"

                DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
                readerSystems = DBCommand.ExecuteReader
                If readerSystems.Read Then
                    SearchRegion = CStr(readerSystems.GetValue(0))
                    SearchSystem = ""
                Else
                    MsgBox("Invalid Region Name", vbCritical, Application.ProductName)
                    GoTo ExitSub
                End If

                readerSystems.Close()

            ElseIf SystemSelected Then
                If SearchSystem = JitaPerimeter Then
                    SearchSystem = "Jita"
                    SearchRegion = CStr(TheForgeTypeID)
                End If

                ' Get the system ID string
                SQL = "SELECT solarSystemID, regionID FROM SOLAR_SYSTEMS, REGIONS "
                SQL &= "WHERE REGIONS.regionID = SOLAR_SYSTEMS.regionID AND solarSystemName = '" & SearchSystem & "'"

                DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
                readerSystems = DBCommand.ExecuteReader
                If readerSystems.Read Then
                    SearchSystem = CStr(readerSystems.GetValue(0))
                    SearchRegion = CStr(readerSystems.GetValue(1))
                Else
                    MsgBox("Invalid Solar System Name", vbCritical, Application.ProductName)
                    GoTo ExitSub
                End If

                readerSystems.Close()
            End If
        End If

        BPCRegion = SearchRegion

        ' Build the list of types we want to update and include the type, region/system
        For i = 0 To lstPricesView.Items.Count - 1
            ' Only include items that are in the market (Market ID not null in Inventory Types) or blueprints/reactions
            If lstPricesView.Items(i).SubItems(5).Text <> "" Or (lstPricesView.Items(i).SubItems(1).Text.Contains("Blueprint") Or lstPricesView.Items(i).SubItems(1).Text.Contains("Reaction")) Then
                TempItem = New PriceItem
                TempItem.TypeID = CLng(lstPricesView.Items(i).SubItems(0).Text)
                TempItem.GroupName = GetPriceGroupName(TempItem.TypeID)

                ' If the group name exists, then look it up
                If TempItem.GroupName <> "" Then
                    TempItem.Manufacture = CBool(lstPricesView.Items(i).SubItems(4).Text)
                    TempItem.RegionID = ""

                    If rbtnPriceSettingSingleSelect.Checked Then
                        TempItem.RegionID = SearchRegion
                        TempItem.SystemID = SearchSystem
                        TempItem.StructureID = SearchStructureID
                        If TempItem.Manufacture Then
                            TempItem.PriceType = cmbItemsSplitPrices.Text
                            TempItem.PriceModifier = CDbl(txtItemsPriceModifier.Text.Replace("%", "")) / 100
                        Else
                            TempItem.PriceType = cmbRawMatsSplitPrices.Text
                            TempItem.PriceModifier = CDbl(txtRawPriceModifier.Text.Replace("%", "")) / 100
                        End If
                    Else ' *** PRICE PROFILES ***
                        ' Using price profiles, so look up all the data per group name
                        Dim rsPP As SQLiteDataReader
                        SQL = "SELECT PRICE_TYPE, regionID, SOLAR_SYSTEM_NAME, PRICE_MODIFIER FROM PRICE_PROFILES, REGIONS "
                        SQL &= "WHERE REGIONS.regionName = PRICE_PROFILES.REGION_NAME "
                        SQL &= "AND (ID = " & CStr(SelectedCharacter.ID) & " OR ID = 0) AND GROUP_NAME = '" & TempItem.GroupName & "' "
                        If SelectedCharacter.ID <> DummyCharacterID Then
                            SQL &= "ORDER BY ID DESC"
                        Else
                            SQL &= "ORDER BY ID"
                        End If

                        DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
                        rsPP = DBCommand.ExecuteReader

                        If rsPP.Read Then
                            TempItem.PriceType = rsPP.GetString(0)
                            If rsPP.GetString(2) = AllSystems Then
                                ' Can only do one region for price profile
                                TempItem.RegionID = CStr(rsPP.GetInt64(1))
                                TempItem.SystemID = ""
                            Else
                                ' Look up the system name
                                If rsPP.GetString(2) = JitaPerimeter Then
                                    ' System name set below
                                    JitaPerimeterChecked = True
                                Else
                                    JitaPerimeterChecked = False
                                    TempItem.RegionID = CStr(rsPP.GetInt64(1))
                                    TempItem.SystemID = CStr(GetSolarSystemID(rsPP.GetString(2)))
                                End If
                            End If
                            TempItem.PriceModifier = rsPP.GetDouble(3)
                        End If
                        rsPP.Close()
                    End If

                    ' Add the item to the list if not there 
                    If Not Items.Contains(TempItem) And TempItem.GroupName <> "Blueprint" And Not TempItem.GroupName.Contains("Reaction") Then
                        If JitaPerimeterChecked Then
                            ' Add Jita first with flag
                            TempItem.JitaPerimeterPrice = True
                            TempItem.SystemID = JitaID
                            TempItem.RegionID = CStr(TheForgeTypeID)
                            Items.Add(TempItem)
                            ' Perimeter will always be after Jita but add both temp items to get prices for both
                            Dim TempItem2 As New PriceItem
                            TempItem2 = CType(TempItem.Clone, PriceItem)
                            TempItem2.SystemID = PerimeterID
                            Items.Add(TempItem2)
                        Else
                            ' Just basic add
                            TempItem.JitaPerimeterPrice = False
                            Items.Add(TempItem)
                        End If
                    ElseIf TempItem.GroupName = "Blueprint" Or TempItem.GroupName.Contains("Reaction") Then
                        ' Put this in the blueprints list and we will look at contracts for prices
                        ' Jita/Perimeter won't matter since they are in the same region and we can only query regions for contracts
                        Call BlueprintItems.Add(TempItem)
                        End If

                        ' If this is the BPC profile, save the region they want used
                        If TempItem.GroupName = "Blueprint Copies" Then
                            BPCRegion = TempItem.RegionID
                        End If

                    End If
                End If
        Next

        ' Load the prices
        Call LoadPrices(Items, BlueprintItems)

UpdateProgramPrices:

        ' Update all the prices in the program
        Call UpdateProgramPrices()

ExitSub:

        Application.UseWaitCursor = False
        Application.DoEvents()

        If Not DataErrors Then
            ' Enable tab
            Call DisableUpdatePricesTab(False)

            gbSingleSource.Enabled = SavedgbSSValue
            gbPriceProfile.Enabled = SavedgbPPValue
        End If

        ' Disable cancel
        btnCancelUpdate.Enabled = False

        Me.Refresh()
        Me.Cursor = Cursors.Default
        pnlProgressBar.Visible = False
        pnlStatus.Text = ""

    End Sub

    Private RegiontoFind As String
    Private TypeIDRegiontoFind As String

    ' Predicate for searching a list items
    Private Function FindTypeIDRegion(ByVal Item As TypeIDRegion) As Boolean
        If Item.RegionString = RegiontoFind Then
            ' Go through the list to see if the id is already in there
            If Item.TypeIDs.Contains(TypeIDRegiontoFind) Then
                Return True
            End If
        End If

        Return False

    End Function

    ' Loads prices from the cache into the ITEM_PRICES table based on the info selected on the main form
    Private Sub LoadPrices(ByVal SentItems As List(Of PriceItem), ByVal BPItems As List(Of PriceItem))
        Dim readerPrices As SQLiteDataReader
        Dim SQL As String = ""
        Dim i As Integer
        Dim RegionorSystemList As String
        Dim SelectedPrice As Double
        Dim MP As New MarketPriceInterface(pnlProgressBar)
        Dim ESIData As New ESI
        Dim RegionID As String = ""
        Dim PriceRegions As New List(Of String)
        Dim PriceSystem As String = ""
        Dim PriceType As String = "" ' Default
        Dim Items As New List(Of TypeIDRegion)

        ' Use CCP Data
        If rbtnPriceSourceCCPData.Checked Then
            ' Loop through each item and set it's pair for query
            For i = 0 To SentItems.Count - 1
                Dim Temp As New TypeIDRegion
                Temp.TypeIDs.Add(CStr(SentItems(i).TypeID))

                ' Look up regionID since we can only look up regions in ESI
                If SentItems(i).SystemID <> "" Then
                    DBCommand = New SQLiteCommand("SELECT regionID FROM SOLAR_SYSTEMS WHERE solarsystemID = '" & SentItems(i).SystemID & "'", EVEDB.DBREf)
                    readerPrices = DBCommand.ExecuteReader
                    readerPrices.Read()
                    RegionID = CStr(readerPrices.GetInt64(0))
                    readerPrices.Close()
                    DBCommand = Nothing
                    PriceSystem = SentItems(i).SystemID
                Else
                    ' for ESI, only one region per update
                    RegionID = SentItems(i).RegionID
                End If

                ' Set the region
                Temp.RegionString = RegionID

                ' Save the regionID in the list
                If Not PriceRegions.Contains(RegionID) Then
                    PriceRegions.Add(RegionID)
                End If

                ' If not in the main list, add it
                Dim TempItem As New TypeIDRegion
                RegiontoFind = RegionID
                TypeIDRegiontoFind = CStr(SentItems(i).TypeID)
                TempItem = Items.Find(AddressOf FindTypeIDRegion)
                If IsNothing(TempItem) Then
                    Items.Add(Temp)
                End If
            Next

            pnlStatus.Text = "Downloading Station Prices..."

            ' Update the ESI prices cache
            If Not MP.UpdateESIMarketOrders(Items) Then
                ' Update Failed, don't reload everything
                Call MsgBox("Some prices did not update from stations. Please try again.", vbInformation, Application.ProductName)
                pnlStatus.Text = ""
                Exit Sub
            End If

            If CancelThreading Then
                ' They had a ton of errors
                Call MsgBox("You had an excessive amount of errors while attempting to update station orders and the process was canceled. Please try again later.", vbCritical, Application.ProductName)
                CancelThreading = False
                Exit Sub
            End If

            pnlStatus.Text = ""
            Application.DoEvents()

            ' Now, based on the region and selected items, select the public upwell structures and get each set of market data from those
            If SelectedCharacter.StructureMarketsAccess And SelectedCharacter.PublicStructuresAccess And Not CancelUpdatePrices Then
                pnlStatus.Text = "Downloading Public Structure Prices..."

                ' First, make sure we have structures in the table to query
                Call ESIData.UpdatePublicStructureswithMarkets()

                If Not ESIData.UpdateStructureMarketOrders(PriceRegions, PriceSystem, SelectedCharacter.CharacterTokenData, pnlProgressBar) Then
                    ' Update Failed, don't reload everything
                    Call MsgBox("Some prices did not update from public structures. Please try again.", vbInformation, Application.ProductName)
                    pnlStatus.Text = ""
                    Exit Sub
                End If

                If CancelThreading Then
                    ' They had a ton of errors
                    Call MsgBox("You had an excessive amount of errors while attempting to update structure orders and the process was canceled. Please try again later.", vbCritical, Application.ProductName)
                    CancelThreading = False
                    Exit Sub
                End If

                pnlStatus.Text = ""
            End If
        Else
            ' Update the cache with EVE Marketer or Fuzzworks selected
            If Not UpdatePricesCache(SentItems) Then
                ' Update Failed, don't reload everything
                Exit Sub
            End If
        End If

        ' Blueprint Copies - if they have the intermediate selected for bpcs,
        ' then update all the data from contracts for all BPCs from the region selected
        If chkBPCs.CheckState = CheckState.Indeterminate Then
            Call ESIData.UpdatePublicContracts(BPCRegionID, pnlStatus, pnlProgressBar) ' Contracts only available for a region
        End If

        ' Working
        pnlStatus.Text = "Updating Item Prices..."
        RegionorSystemList = ""
        pnlProgressBar.Value = 0
        pnlProgressBar.Minimum = 0
        pnlProgressBar.Maximum = SentItems.Count + 1
        pnlProgressBar.Visible = True

        Application.DoEvents()

        If EVEDB.TransactionActive And CancelUpdatePrices Then
            ' We Canceled the update so rollback anything
            EVEDB.RollbackSQLiteTransaction()
        End If

        Call EVEDB.BeginSQLiteTransaction()

        ' Select the prices from the cache table
        For i = 0 To SentItems.Count - 1
            ' Use combo values for min or max.
            Select Case SentItems(i).PriceType
                Case "Min Sell"
                    PriceType = "sellMin"
                Case "Max Sell"
                    PriceType = "sellMax"
                Case "Avg Sell"
                    PriceType = "sellAvg"
                Case "Median Sell"
                    PriceType = "sellMedian"
                Case "Percentile Sell"
                    PriceType = "sellPercentile"
                Case "Min Buy"
                    PriceType = "buyMin"
                Case "Max Buy"
                    PriceType = "buyMax"
                Case "Avg Buy"
                    PriceType = "buyAvg"
                Case "Median Buy"
                    PriceType = "buyMedian"
                Case "Percentile Buy"
                    PriceType = "buyPercentile"
                Case "Split Price"
                    PriceType = "splitPrice"
            End Select

            ' Build the region list for each item
            RegionorSystemList = ""
            If SentItems(i).JitaPerimeterPrice Then
                RegionorSystemList = JitaID & "," & PerimeterID
            ElseIf SentItems(i).SystemID = "" Then
                RegionorSystemList = SentItems(i).RegionID
            Else
                RegionorSystemList = SentItems(i).SystemID
            End If

            ' Third Party data pull
            If rbtnPriceSourceEM.Checked Or rbtnPriceSourceFW.Checked Then
                Dim SQLPricetype As String = ""
                If PriceType <> "splitPrice" Then
                    ' If it's Jita Perimeter, we need to do functions on the values - just take averages of non-min/max values
                    If SentItems(i).JitaPerimeterPrice Then
                        Select Case PriceType
                            Case "buyAvg"
                                SQLPricetype = "AVG(buyAvg)"
                            Case "buyMax"
                                SQLPricetype = "MAX(buyMax)"
                            Case "buyMedian"
                                SQLPricetype = "AVG(buyMedian)"
                            Case "buyMin"
                                SQLPricetype = "MIN(buyMin)"
                            Case "buyPercentile"
                                SQLPricetype = "AVG(buyPercentile)"
                            Case "sellAvg"
                                SQLPricetype = "AVG(sellAvg)"
                            Case "sellMax"
                                SQLPricetype = "MAX(sellMax)"
                            Case "sellMedian"
                                SQLPricetype = "AVG(sellMedian)"
                            Case "sellMin"
                                SQLPricetype = "MIN(sellMin)"
                            Case "sellPercentile"
                                SQLPricetype = "AVG(sellPercentile)"
                        End Select
                    Else
                        SQLPricetype = PriceType
                    End If
                Else
                    SQLPricetype = "((buyMax + sellMin) / 2)"
                End If

                SQL = "SELECT " & SQLPricetype & ", RegionORSystem FROM ITEM_PRICES_CACHE WHERE TYPEID = " & CStr(SentItems(i).TypeID)
                SQL &= " AND RegionOrSystem IN (" & RegionorSystemList & ") AND PRICE_SOURCE = " & UpdatePricesDataSource
                If SentItems(i).JitaPerimeterPrice Then
                    If PriceType = "sellMin" Then
                        SQL &= " AND sellMin > 0"
                    ElseIf PriceType = "buyMin0" Then
                        SQL &= " AND buyMin > 0"
                    End If
                End If
                SQL &= " ORDER BY DateTime(UPDATEDATE) DESC"

            Else ' CCP Data pull
                Dim LimittoBuy As Boolean = False
                Dim LimittoSell As Boolean = False
                Dim SystemID As String = ""

                RegionID = ""

                If SentItems(i).SystemID <> "" Then
                    SystemID = RegionorSystemList
                Else
                    RegionID = RegionorSystemList
                End If

                ' Got the data from ESI so we need to do some calcuations depending on the type they want
                SQL = "SELECT "
                Select Case PriceType
                    Case "buyAvg"
                        SQL &= "AVG(PRICE)"
                        LimittoBuy = True
                    Case "buyMax"
                        SQL &= "MAX(PRICE)"
                        LimittoBuy = True
                    Case "buyMedian"
                        SQL &= CalcMedian(SentItems(i).TypeID, RegionID, SystemID, True)
                    Case "buyMin"
                        SQL &= "MIN(PRICE)"
                        LimittoBuy = True
                    Case "buyPercentile"
                        SQL &= CalcPercentile(SentItems(i).TypeID, RegionID, SystemID, True)
                    Case "sellAvg"
                        SQL &= "AVG(PRICE)"
                        LimittoSell = True
                    Case "sellMax"
                        SQL &= "MAX(PRICE)"
                        LimittoSell = True
                    Case "sellMedian"
                        SQL &= CalcMedian(SentItems(i).TypeID, RegionID, SystemID, False)
                    Case "sellMin"
                        SQL &= "MIN(PRICE)"
                        LimittoSell = True
                    Case "sellPercentile"
                        SQL &= CalcPercentile(SentItems(i).TypeID, RegionID, SystemID, False)
                    Case "splitPrice"
                        SQL &= CalcSplit(SentItems(i).TypeID, RegionID, SystemID)
                End Select

                ' If they want a system, then limit all the data to that system id
                If SentItems(i).SystemID <> "" Then
                    ' Set the main from using both CCP Data price locations
                    SQL &= ", SOLAR_SYSTEM_ID FROM (SELECT * FROM MARKET_ORDERS UNION ALL SELECT * FROM STRUCTURE_MARKET_ORDERS) WHERE TYPE_ID = " & CStr(SentItems(i).TypeID) & " "
                    SQL &= "And SOLAR_SYSTEM_ID In (" & RegionorSystemList & ") "
                Else
                    ' Use the region
                    ' Set the main from using both CCP Data price locations
                    SQL &= ", REGION_ID FROM (SELECT * FROM MARKET_ORDERS UNION ALL SELECT * FROM STRUCTURE_MARKET_ORDERS) WHERE TYPE_ID = " & CStr(SentItems(i).TypeID) & " "
                    SQL &= "And REGION_ID = " & RegionorSystemList & " "
                End If

                ' See if we limit to buy/sell only
                If LimittoBuy Then
                    SQL &= "AND IS_BUY_ORDER <> 0 "
                ElseIf LimittoSell Then
                    SQL &= "AND IS_BUY_ORDER = 0 "
                End If

                SQL &= "AND PRICE > 0 "

            End If

            DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
            readerPrices = DBCommand.ExecuteReader

            ' Grab the first record, which will be the latest one, if no record just leave what is already in item prices
            If readerPrices.Read Then
                If Not IsDBNull(readerPrices.GetValue(0)) Then
                    ' Modify the price depending on modifier
                    SelectedPrice = readerPrices.GetDouble(0) * (1 + SentItems(i).PriceModifier)

                    ' Now Update the ITEM_PRICES table, set price, price type, Data source, and RegionORSystem used for the price
                    SQL = "UPDATE ITEM_PRICES_FACT Set PRICE = " & CStr(SelectedPrice) & ", PRICE_TYPE = '" & PriceType & "' "
                    SQL &= ", RegionORSystem = " & CStr(readerPrices.GetValue(1)) & ", PRICE_SOURCE = " & UpdatePricesDataSource
                    SQL &= " WHERE ITEM_ID = " & CStr(SentItems(i).TypeID)
                    Call EVEDB.ExecuteNonQuerySQL(SQL)
                End If
                readerPrices.Close()
            End If

            ' For each record, update the progress bar
            Call IncrementToolStripProgressBar(pnlProgressBar)

            Application.DoEvents()
        Next

        Call EVEDB.CommitSQLiteTransaction()

        ' Done updating, hide the progress bar
        pnlProgressBar.Visible = False
        pnlStatus.Text = ""
        Application.DoEvents()

    End Sub

    Private Function CalcSplit(TypeID As Long, RegionID As String, SystemID As String) As String
        Dim SQL As String = ""
        Dim rsData As SQLiteDataReader
        Dim PriceList As New List(Of Double)
        Dim SellOrderSQL As String = "AND IS_BUY_ORDER = 0 "
        Dim BuyOrderSQL As String = "AND IS_BUY_ORDER <> 0 "

        Dim MinSellPrice As Double = 0
        Dim MaxBuyPrice As Double = 0

        SQL = "SELECT MIN(PRICE) FROM (SELECT * FROM MARKET_ORDERS UNION ALL SELECT * FROM STRUCTURE_MARKET_ORDERS) WHERE TYPE_ID = " & CStr(TypeID) & " "
        If SystemID <> "" Then
            If SystemID.Contains(",") Then
                SQL &= "AND SOLAR_SYSTEM_ID IN (" & SystemID & ") "
            Else
                SQL &= "AND SOLAR_SYSTEM_ID = " & SystemID & " "
            End If
        Else
            ' Use the region
            SQL &= "AND REGION_ID = " & RegionID & " "
        End If

        ' Look up the min sell price
        DBCommand = New SQLiteCommand(SQL & SellOrderSQL, EVEDB.DBREf)
        rsData = DBCommand.ExecuteReader
        rsData.Read()

        If rsData.HasRows Then
            If Not IsDBNull(rsData.GetValue(0)) Then
                MinSellPrice = rsData.GetDouble(0)
            End If
        End If

        rsData.Close()

        SQL = "SELECT MAX(PRICE) FROM (SELECT * FROM MARKET_ORDERS UNION ALL SELECT * FROM STRUCTURE_MARKET_ORDERS) WHERE TYPE_ID = " & CStr(TypeID) & " "
        If SystemID <> "" Then
            If SystemID.Contains(",") Then
                SQL &= "AND SOLAR_SYSTEM_ID IN (" & SystemID & ") "
            Else
                SQL &= "AND SOLAR_SYSTEM_ID = " & SystemID & " "
            End If
        Else
            ' Use the region
            SQL &= "AND REGION_ID = " & RegionID & " "
        End If

        ' Look up the max buy order
        DBCommand = New SQLiteCommand(SQL & BuyOrderSQL, EVEDB.DBREf)
        rsData = DBCommand.ExecuteReader
        rsData.Read()

        If rsData.HasRows Then
            If Not IsDBNull(rsData.GetValue(0)) Then
                MaxBuyPrice = rsData.GetDouble(0)
            End If
        End If

        rsData.Close()

        Return CStr((MaxBuyPrice + MinSellPrice) / 2)

    End Function

    ' Queries market orders and calculates the median and returns the median as a string
    Private Function CalcMedian(TypeID As Long, RegionID As String, SystemID As String, IsBuyOrder As Boolean) As String
        Dim MedianList As List(Of Double) = GetMarketOrderPriceList(TypeID, RegionID, SystemID, IsBuyOrder)
        Dim value As Double
        Dim size As Integer = MedianList.Count

        ' Calculate the median
        If size > 0 Then
            If size Mod 2 = 0 Then
                ' Need to average
                Dim a As Double = MedianList(CInt(size / 2 - 1))
                Dim b As Double = MedianList(CInt(size / 2))
                value = (a + b) / 2
            Else
                value = MedianList(CInt(Math.Floor(size / 2)))
            End If
        Else
            value = 0
        End If

        ' return 2 decimals
        Return FormatNumber(value, 2)

    End Function

    ' Queries market orders and calculates the percential price
    Private Function CalcPercentile(TypeID As Long, RegionID As String, SystemID As String, IsBuyOrder As Boolean) As String
        Dim PriceList As List(Of Double) = GetMarketOrderPriceList(TypeID, RegionID, SystemID, IsBuyOrder)
        Dim index As Integer

        If PriceList.Count > 0 Then
            If IsBuyOrder Then
                ' Get the top 5% 
                index = CInt(Math.Floor(0.95 * PriceList.Count))
            Else
                ' Get the bottom 5% for SELL or ALL - matches EVE Central?
                index = CInt(Math.Floor(0.05 * PriceList.Count))
            End If
            Return CStr(PriceList(index))
        Else
            Return "0.00"
        End If

    End Function

    ' Returns the list of prices for variables sent, sorted ascending
    Private Function GetMarketOrderPriceList(TypeID As Long, RegionID As String, SystemID As String, IsBuyOrder As Boolean) As List(Of Double)
        Dim SQL As String = ""
        Dim rsData As SQLiteDataReader
        Dim PriceList As New List(Of Double)

        SQL = "SELECT PRICE FROM (SELECT * FROM MARKET_ORDERS UNION ALL SELECT * FROM STRUCTURE_MARKET_ORDERS) WHERE TYPE_ID = " & CStr(TypeID) & " "
        If SystemID <> "" Then
            If SystemID.Contains(",") Then
                SQL &= "AND SOLAR_SYSTEM_ID IN (" & SystemID & ") "
            Else
                SQL &= "AND SOLAR_SYSTEM_ID = " & SystemID & " "
            End If
        Else
            ' Use the region
            SQL &= "AND REGION_ID = " & RegionID & " "
        End If

        If IsBuyOrder Then
            SQL &= "AND IS_BUY_ORDER <> 0 "
        Else
            SQL &= "AND IS_BUY_ORDER = 0 "
        End If

        SQL &= "ORDER BY PRICE ASC"

        DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
        rsData = DBCommand.ExecuteReader

        While rsData.Read
            PriceList.Add(rsData.GetDouble(0))
        End While

        rsData.Close()

        Return PriceList

    End Function

    ' Gets the group name from ITEM_PRICES
    Private Function GetPriceGroupName(TypeID As Long) As String
        Dim SQL As String = "SELECT ITEM_GROUP, ITEM_CATEGORY, ITEM_NAME FROM ITEM_PRICES WHERE ITEM_ID = " & CStr(TypeID)
        Dim rsGroup As SQLiteDataReader
        Dim RGN As String = ""
        Dim GN As String = ""
        Dim CN As String = ""
        Dim ITN As String = ""

        DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
        rsGroup = DBCommand.ExecuteReader

        If rsGroup.Read Then
            GN = rsGroup.GetString(0)
            CN = rsGroup.GetString(1)
            ITN = rsGroup.GetString(2)

            Select Case GN
                Case "Advanced Protective Technology"
                    RGN = "Advanced Protective Technology"
                Case "Materials and Compounds", "Artifacts and Prototypes", "Rogue Drone Components"
                    RGN = "Faction Materials"
                Case "Harvestable Cloud"
                    RGN = "Harvestable Cloud"
                Case "Ice Product"
                    RGN = "Ice Products"
                Case "Mineral"
                    RGN = "Minerals"
                Case "Molecular-Forging Tools"
                    RGN = "Molecular-Forging Tools"
                Case "Salvaged Materials", "Ancient Salvage"
                    RGN = "Salvage"

                Case "Hybrid Polymers"
                    RGN = "Hybrid Polymers"
                Case "Moon Materials"
                    RGN = "Raw Moon Materials"
                Case "Intermediate Materials"
                    RGN = "Processed Moon Materials"
                Case "Composite"
                    RGN = "Advanced Moon Materials"
                Case "Molecular-Forged Materials"
                    RGN = "Molecular-Forged Materials"
                Case "Materials and Compounds", "Artifacts and Prototypes", "Named Components", "'Rogue Drone Components"
                    RGN = "Materials & Compounds"
                Case "Biochemical Material"
                    RGN = "Booster Materials"

                Case "Advanced Capital Construction Components"
                    RGN = "Adv. Capital Components"
                Case "Construction Components"
                    RGN = "Advanced Components"
                Case "Fuel Block"
                    RGN = "Fuel Blocks"
                Case "Protective Components"
                    RGN = "Protective Components"
                Case "Capital Construction Components"
                    RGN = "Std. Capital Ship Components"
                Case "Structure Components"
                    RGN = "Structure Components"
                Case "Hybrid Tech Components"
                    RGN = "Subsystem Components"

                Case "Booster"
                    RGN = "Boosters"
                Case "Datacores"
                    RGN = "Datacores"

                Case Else
                    ' Do if checks or select on category
                    If GN.Contains("Decryptor") Then
                        RGN = "Decryptors"
                    ElseIf ITN.Contains("R.Db") And Not ITN.Contains("Blueprint") Then
                        RGN = "R.Db."
                    ElseIf ITN.Contains("R.A.M.") And Not ITN.Contains("Blueprint") Then
                        RGN = "R.A.M.s"
                    ElseIf (GN = "General" Or GN = "Livestock" Or GN = "Radioactive" Or GN = "Biohazard" Or GN = "Commodities" _
                        Or GN = "Empire Insignia Drops" Or GN = "Criminal Tags" Or GN = "Miscellaneous" Or GN = "Unknown Components" Or GN = "Lease") Then
                        RGN = "Misc."
                    ElseIf GN = "Rogue Drone Components" Or ITN = "Elite Drone AI" Then
                        RGN = "Rogue Drone Components"
                    ElseIf GN = "Cyberimplant" Or (CN = "Implant" And GN <> "Booster") Then
                        RGN = "Implants"
                    ElseIf CN.Contains("Planetary") Or ITN = "Oxygen" Or ITN = "Water" Then
                        RGN = "Planetary Materials"
                    ElseIf CN.Contains("Blueprint") Then
                        RGN = "Blueprint"
                    ElseIf CN = "Ancient Relics" Then
                        RGN = "Ancient Relics"
                    ElseIf CN = "Deployable" Then
                        RGN = "Deployables"
                    ElseIf CN = "Asteroid" Or GN = "Abyssal Materials" Then
                        RGN = "Raw Materials"
                    ElseIf CN = "Ship" Then
                        RGN = "Ships"
                    ElseIf CN = "Subsystem" Then
                        RGN = "Subsystems"
                    ElseIf CN = "Structure Module" Then
                        RGN = "Structure Modules"
                    ElseIf CN = "Starbase" Then
                        RGN = "Structures"
                    ElseIf CN = "Charge" Then
                        RGN = "Charges"
                    ElseIf CN = "Drone" Or CN = "Fighter" Then
                        RGN = "Drones"
                    ElseIf CN = "Module" And Not GN.Contains("Rig") Then
                        RGN = "Modules"
                    ElseIf CN = "Module" And GN.Contains("Rig") Then
                        RGN = "Rigs"
                    ElseIf (CN = "Celestial" Or CN = "Orbitals" Or CN = "Sovereignty Structures" Or CN = "Station" Or CN = "Accessories" Or CN = "Infrastructure Upgrades") And GN <> "Harvestable Clound" Then
                        RGN = "Celestials"
                    ElseIf CN = "Structure" Then
                        RGN = "Structures"
                    ElseIf CN = "Structure Rigs" Then
                        RGN = "Structure Rigs"
                    End If
            End Select
        End If

        If RGN = "" Then
            ' If no groupname, then set it as a nobuild item
            RGN = "No Build Items"
        End If

        rsGroup.Close()

        Return RGN

    End Function

    ' Adds prices for each type id and region to the cache 
    Private Function UpdatePricesCache(ByVal CacheItems As List(Of PriceItem)) As Boolean
        Dim TypeIDUpdatePriceList As New List(Of PriceItem)
        Dim i As Integer
        Dim SQL As String = ""
        Dim FWPriceRecords As List(Of FuzzworksMarketPrice)
        Dim FuzzworksMarketPrices = New FuzzworksMarket
        Dim EMPriceRecords As List(Of EVEMarketerPrice)
        Dim EVEMarketerPrices As New EVEMarketer
        Dim PriceDLError As MyError

        Dim RegionSystem As String = "" ' Used for querying the Price Cache for regions
        Dim TotalUpdateItems As Integer = 0 ' For progress bar, only count the ones we update
        Dim InsertRecord As Boolean = False
        Dim Query3rdPartySource As Boolean = False
        Dim readerPriceCheck As SQLiteDataReader

        Dim SystemID As Long
        Dim RegionID As Long

        ' Reset the value of the progress bar
        pnlProgressBar.Value = 0
        If CacheItems.Count <> 0 Then
            pnlProgressBar.Maximum = CacheItems.Count - 1
        Else
            pnlProgressBar.Maximum = 0
        End If

        pnlProgressBar.Visible = True
        CancelUpdatePrices = False

        pnlStatus.Text = "Checking Items..."
        Application.DoEvents()

        ' Loop through the list of items to get full query of just those that need to be updated
        For i = 0 To CacheItems.Count - 1

            If CancelUpdatePrices Then
                Exit For
            End If

            ' Reset Insert
            InsertRecord = False

            ' Get the region/system list since they will always be the same, use the first one for EVE Marketer/Fuzzworks
            If CacheItems(i).SystemID <> "" Then
                RegionSystem = CacheItems(i).SystemID
                SystemID = CLng(CacheItems(i).SystemID)
            Else
                RegionSystem = CacheItems(i).RegionID
                RegionID = CLng(CacheItems(i).RegionID)
            End If

            ' See if the record is in the cache first
            SQL = "SELECT * FROM ITEM_PRICES_CACHE WHERE TYPEID = " & CStr(CacheItems(i).TypeID) & " AND RegionOrSystem = " & RegionSystem & " AND PRICE_SOURCE = " & UpdatePricesDataSource

            DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
            readerPriceCheck = DBCommand.ExecuteReader

            If Not readerPriceCheck.HasRows Then
                ' Not found
                InsertRecord = True
            Else
                readerPriceCheck.Close()
                ' There is a record, see if it needs to be updated
                SQL = "SELECT UPDATEDATE FROM ITEM_PRICES_CACHE WHERE TYPEID = " & CStr(CacheItems(i).TypeID) & " AND RegionOrSystem = " & RegionSystem & " AND PRICE_SOURCE = " & UpdatePricesDataSource
                DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
                readerPriceCheck = DBCommand.ExecuteReader

                ' If no record or the max date
                If readerPriceCheck.Read Then
                    ' If older than the interval, add a new record
                    If DateTime.ParseExact(readerPriceCheck.GetString(0), SQLiteDateFormat, LocalCulture) < DateAdd(DateInterval.Minute, -1 * UserApplicationSettings.UpdatePricesRefreshInterval, Now) Then
                        InsertRecord = True
                    End If
                End If
            End If

            readerPriceCheck.Close()

            ' Add to query item list for EVE Marketer
            If InsertRecord Then
                ' Add to the list
                TypeIDUpdatePriceList.Add(CacheItems(i))

                ' Count up the update items
                TotalUpdateItems = TotalUpdateItems + 1
                ' We are inserting at least one record, so query eve marketer/FW
                Query3rdPartySource = True

            End If

            ' For each record, update the progress bar
            Call IncrementToolStripProgressBar(pnlProgressBar)

            Application.DoEvents()
        Next

        ' Don't show until download is done
        pnlProgressBar.Visible = False
        ' Reset the value of the progress bar
        pnlProgressBar.Value = 0
        ' Set the maximum updates for the progress bar
        pnlProgressBar.Maximum = TotalUpdateItems + 1

        If Query3rdPartySource Then
            pnlStatus.Text = "Downloading Item Prices..."
            Application.DoEvents()

            ' Get the list of records to insert
            ' *** Fuzzworks ***
            If rbtnPriceSourceFW.Checked Then

                FWPriceRecords = FuzzworksMarketPrices.GetPrices(TypeIDUpdatePriceList)

                If IsNothing(FWPriceRecords) Then
                    ' There was an error in the request 
                    PriceDLError = FuzzworksMarketPrices.GetErrorData
                    MsgBox("Fuzzworks Market Server is Unavailable" & Chr(13) & PriceDLError.Description & Chr(13) & "Please try again later", vbExclamation, Me.Text)
                    UpdatePricesCache = False
                    Exit Function
                End If

                ' Show the progress bar now and update status
                pnlProgressBar.Visible = True
                pnlStatus.Text = "Updating Price Cache..."
                Application.DoEvents()

                Call EVEDB.BeginSQLiteTransaction()

                ' Loop through the price records and insert each one
                For i = 0 To FWPriceRecords.Count - 1

                    If CancelUpdatePrices Then
                        Exit For
                    End If

                    ' Insert record in Cache
                    With FWPriceRecords(i)
                        ' First, delete the record
                        SQL = "DELETE FROM ITEM_PRICES_CACHE WHERE TYPEID = " & CStr(.TypeID) & " AND RegionOrSystem = " & .PriceLocation & " AND PRICE_SOURCE = " & UpdatePricesDataSource
                        Call EVEDB.ExecuteNonQuerySQL(SQL)

                        ' Insert new data
                        SQL = "INSERT INTO ITEM_PRICES_CACHE (typeID, buyVolume, buyAvg, buyweightedAvg, buyMax, buyMin, buyStdDev, buyMedian, buyPercentile, buyVariance, "
                        SQL &= "sellVolume, sellAvg, sellweightedAvg, sellMax, sellMin, sellStdDev, sellMedian, sellPercentile, sellVariance, RegionOrSystem, UpdateDate, PRICE_SOURCE) VALUES "
                        SQL &= "(" & CStr(.TypeID) & "," & CStr(.BuyVolume) & "," & CStr(.BuyWeightedAveragePrice) & "," & CStr(.BuyWeightedAveragePrice) & "," & CStr(.BuyMaxPrice) & "," & CStr(.BuyMinPrice) & "," & CStr(.BuyStdDev) & "," & CStr(.BuyMedian) & "," & CStr(.BuyPercentile) & "," & "0" & ","
                        SQL &= CStr(.SellVolume) & "," & CStr(.SellWeightedAveragePrice) & "," & CStr(.SellWeightedAveragePrice) & "," & CStr(.SellMaxPrice) & "," & CStr(.SellMinPrice) & "," & CStr(.SellStdDev) & "," & CStr(.SellMedian) & "," & CStr(.SellPercentile) & "," & "0" & ","
                        SQL &= .PriceLocation & ",'" & Format(Now, SQLiteDateFormat) & "'," & UpdatePricesDataSource & ")"

                    End With

                    Call EVEDB.ExecuteNonQuerySQL(SQL)

                    ' For each record, update the progress bar
                    Call IncrementToolStripProgressBar(pnlProgressBar)

                    Application.DoEvents()
                Next

                Call EVEDB.CommitSQLiteTransaction()

            Else ' *** EVE Marketer ***
                EMPriceRecords = EVEMarketerPrices.GetPrices(TypeIDUpdatePriceList)

                If IsNothing(EMPriceRecords) Then
                    ' There was an error in the request 
                    PriceDLError = EVEMarketerPrices.GetErrorData
                    MsgBox("EVE Marketer Server is Unavailable" & Chr(13) & PriceDLError.Description & Chr(13) & "Please try again later", vbExclamation, Me.Text)
                    UpdatePricesCache = False
                    Exit Function
                End If

                ' Show the progress bar now and update status
                pnlProgressBar.Visible = True
                pnlStatus.Text = "Updating Price Cache..."
                Application.DoEvents()

                Call EVEDB.BeginSQLiteTransaction()

                ' Loop through the price records and insert each one
                For i = 0 To EMPriceRecords.Count - 1

                    If CancelUpdatePrices Then
                        Exit For
                    End If

                    ' Insert record in Cache
                    With EMPriceRecords(i)
                        ' First, delete the record 
                        SQL = "DELETE FROM ITEM_PRICES_CACHE WHERE TYPEID = " & CStr(.TypeID) & " AND RegionOrSystem = " & .PriceLocation & " AND PRICE_SOURCE = " & UpdatePricesDataSource
                        Call EVEDB.ExecuteNonQuerySQL(SQL)

                        ' Insert new data
                        SQL = "INSERT INTO ITEM_PRICES_CACHE (typeID, buyVolume, buyAvg, buyweightedAvg, buyMax, buyMin, buyStdDev, buyMedian, buyPercentile, buyVariance, sellVolume, "
                        SQL &= " sellAvg, sellweightedAvg, sellMax, sellMin, sellStdDev, sellMedian, sellPercentile, sellVariance, RegionOrSystem, UpdateDate, PRICE_SOURCE) VALUES "
                        SQL &= "(" & CStr(.TypeID) & "," & CStr(.BuyVolume) & "," & CStr(.BuyAvgPrice) & "," & CStr(.BuyWeightedAveragePrice) & "," & CStr(.BuyMaxPrice) & "," & CStr(.BuyMinPrice) & "," & CStr(.BuyStdDev) & "," & CStr(.BuyMedian) & "," & CStr(.BuyPercentile) & "," & CStr(.BuyVariance) & ","
                        SQL &= CStr(.SellVolume) & "," & CStr(.SellAvgPrice) & "," & CStr(.SellWeightedAveragePrice) & "," & CStr(.SellMaxPrice) & "," & CStr(.SellMinPrice) & "," & CStr(.SellStdDev) & "," & CStr(.SellMedian) & "," & CStr(.SellPercentile) & "," & CStr(.SellVariance) & ","
                        SQL &= "'" & .PriceLocation & "','" & Format(Now, SQLiteDateFormat) & "'," & UpdatePricesDataSource & ")"

                    End With

                    Call EVEDB.ExecuteNonQuerySQL(SQL)

                    ' For each record, update the progress bar
                    Call IncrementToolStripProgressBar(pnlProgressBar)

                    Application.DoEvents()
                Next

                Call EVEDB.CommitSQLiteTransaction()

            End If
        End If

        If CancelUpdatePrices Then
            Call MsgBox("Price Update Canceled", vbInformation, Application.ProductName)
        End If

        ' Done updating, hide the progress bar
        CancelUpdatePrices = False
        pnlProgressBar.Visible = False
        UpdatePricesCache = True
        pnlStatus.Text = ""
        Application.DoEvents()

    End Function

    ' Function just queries the items table based on the item type selection then updates the list
    Public Sub UpdatePriceList()
        Dim readerMats As SQLiteDataReader
        Dim SQL As String
        Dim TechSQL As String = ""
        Dim TechChecked As Boolean = False
        Dim lstViewRow As ListViewItem
        Dim ItemChecked As Boolean = False

        ' See if we want to run the update
        ' This will happen in times of things like selecting all boxes
        If Not RunUpdatePriceList Then
            Exit Sub
        End If

        ' Working
        Me.Cursor = Cursors.WaitCursor
        pnlStatus.Text = "Refreshing List..."
        Application.DoEvents()

        ' Add the marketGroupID to the list for checks later
        SQL = "SELECT ITEM_ID, ITEM_NAME, ITEM_GROUP, PRICE, MANUFACTURE, marketGroupID, PRICE_TYPE FROM ITEM_PRICES, INVENTORY_TYPES "
        SQL &= "WHERE ITEM_PRICES.ITEM_ID = INVENTORY_TYPES.typeID AND ("

        ' Materials & Research Equipment Grid
        ' Materials First
        If chkAdvancedProtectiveTechnology.Checked Then
            SQL &= "ITEM_GROUP = 'Advanced Protective Technology' OR "
            ItemChecked = True
        End If
        If chkFactionMaterials.Checked Then
            SQL &= "(ITEM_GROUP IN ('Materials and Compounds','Artifacts and Prototypes','Rogue Drone Components') OR ITEM_GROUP LIKE 'Decryptors -%') OR "
            ItemChecked = True
        End If
        If chkGas.Checked Then
            SQL &= "ITEM_GROUP IN ('Harvestable Cloud','Compressed Gas') OR "
            ItemChecked = True
        End If
        If chkIceProducts.Checked Then
            SQL &= "ITEM_GROUP = 'Ice Product' OR "
            ItemChecked = True
        End If
        If chkMinerals.Checked Then
            SQL &= "ITEM_GROUP = 'Mineral' OR "
            ItemChecked = True
        End If
        If chkMolecularForgingTools.Checked Then
            SQL &= "ITEM_GROUP = 'Molecular-Forging Tools' OR "
            ItemChecked = True
        End If
        If chkNamedComponents.Checked Then
            SQL &= "ITEM_GROUP = 'Named Components' OR "
            ItemChecked = True
        End If
        If chkPlanetary.Checked Then
            SQL &= "ITEM_CATEGORY LIKE 'Planetary%' OR "
            ItemChecked = True
        End If

        ' Raw Materials (Ores)
        If chkRawMaterials.Checked Then
            SQL &= "(ITEM_CATEGORY = 'Asteroid' OR ITEM_GROUP = 'Abyssal Materials') OR "
            ItemChecked = True
        End If

        ' Reaction Materials
        If chkAdvancedMats.Checked Then
            SQL &= "ITEM_GROUP = 'Composite' OR "
            ItemChecked = True
        End If
        If chkBoosterMats.Checked Then
            SQL &= "ITEM_GROUP = 'Biochemical Material' OR "
            ItemChecked = True
        End If
        If chkMolecularForgedMaterials.Checked Then
            SQL &= "ITEM_GROUP = 'Molecular-Forged Materials' OR "
            ItemChecked = True
        End If
        If chkPolymers.Checked Then
            SQL &= "ITEM_GROUP = 'Hybrid Polymers' OR "
            ItemChecked = True
        End If
        If chkProcessedMats.Checked Then
            SQL &= "ITEM_GROUP = 'Intermediate Materials' OR "
            ItemChecked = True
        End If
        If chkRawMoonMats.Checked Then
            SQL &= "ITEM_GROUP = 'Moon Materials' OR "
            ItemChecked = True
        End If

        If chkSalvage.Checked Then
            SQL &= "ITEM_GROUP IN ('Salvaged Materials','Ancient Salvage') OR "
            ItemChecked = True
        End If

        ' Research Equipment
        If chkAncientRelics.Checked Then
            SQL &= "ITEM_CATEGORY = 'Ancient Relics' OR "
            ItemChecked = True
        End If
        If chkDatacores.Checked Then
            SQL &= "ITEM_GROUP = 'Datacores' OR "
            ItemChecked = True
        End If
        If chkDecryptors.Checked Then
            SQL &= "ITEM_CATEGORY = 'Decryptors' OR "
            ItemChecked = True
        End If
        If chkRDb.Checked Then
            SQL &= "ITEM_NAME LIKE 'R.Db%' OR "
            ItemChecked = True
        End If

        ' Blueprint Copies
        If chkBPCs.Checked Then
            SQL &= "ITEM_CATEGORY = 'Blueprint Copies' OR "
            ItemChecked = True
        End If
        If chkMisc.Checked Then ' Commodities = Shattered Villard Wheel
            SQL &= "ITEM_GROUP IN ('General','Livestock','Radioactive','Biohazard','Commodities','Empire Insignia Drops','Criminal Tags','Miscellaneous','Unknown Components','Lease') OR "
            ItemChecked = True
        End If

        ' Other Manufacturables
        If chkCapT2Components.Checked Then
            SQL &= "ITEM_GROUP = 'Advanced Capital Construction Components' OR "
            ItemChecked = True
        End If
        If chkComponents.Checked Then
            SQL &= "ITEM_GROUP = 'Construction Components' OR "
            ItemChecked = True
        End If
        If chkFuelBlocks.Checked Then
            SQL &= "ITEM_GROUP = 'Fuel Block' OR "
            ItemChecked = True
        End If
        If chkProtectiveComponents.Checked Then
            SQL &= "ITEM_GROUP = 'Protective Components' OR "
            ItemChecked = True
        End If
        If chkRAM.Checked Then
            SQL &= "ITEM_NAME LIKE 'R.A.M.%' OR "
            ItemChecked = True
        End If
        If chkNoBuildItems.Checked Then
            SQL &= "MANUFACTURE = -1 OR "
            ItemChecked = True
        End If
        If chkCapitalShipComponents.Checked Then
            SQL &= "ITEM_GROUP = 'Capital Construction Components' OR "
            ItemChecked = True
        End If
        If chkStructureComponents.Checked Then
            SQL &= "ITEM_GROUP = 'Structure Components' OR "
            ItemChecked = True
        End If
        If chkSubsystemComponents.Checked Then
            SQL &= "ITEM_GROUP = 'Hybrid Tech Components' OR "
            ItemChecked = True
        End If
        If chkBoosters.Checked Then
            SQL &= "ITEM_GROUP = 'Booster' OR "
            ItemChecked = True
        End If

        ' All other manufactured items
        If chkImplants.Checked Then
            SQL &= "(ITEM_GROUP = 'Cyberimplant' OR (ITEM_CATEGORY = 'Implant' AND ITEM_GROUP <> 'Booster')) OR "
            ItemChecked = True
        End If
        If chkDeployables.Checked Then
            SQL &= "ITEM_CATEGORY = 'Deployable' OR "
            ItemChecked = True
        End If
        If chkStructureModules.Checked Then
            SQL &= "(ITEM_CATEGORY = 'Structure Module' AND ITEM_GROUP NOT LIKE '%Rig%') OR "
            ItemChecked = True
        End If
        If chkCelestials.Checked Then
            SQL &= "(ITEM_CATEGORY IN ('Celestial','Orbitals','Sovereignty Structures','Station','Accessories','Infrastructure Upgrades')  AND ITEM_GROUP NOT IN ('Harvestable Cloud','Compressed Gas')) OR "
            ItemChecked = True
        End If

        ' Manufactured Items
        If chkShips.Checked Or chkModules.Checked Or chkDrones.Checked Or chkRigs.Checked Or chkSubsystems.Checked Or chkStructures.Checked Or chkCharges.Checked Or chkStructureRigs.Checked Then

            ' Make sure we have at least one tech checked that is enabled
            TechChecked = CheckTechChecks()

            If Not TechChecked And Not ItemChecked Then
                ' There isn't an item checked before this and these items all require tech, so exit
                ItemChecked = False
            Else
                ItemChecked = True
            End If

            ' If they choose a tech level, then build this part of the SQL query
            If TechChecked Then
                If PriceCheckT1Enabled Then
                    If chkPricesT1.Checked Then
                        ' Add to SQL query for tech level
                        TechSQL = TechSQL & "ITEM_TYPE = 1 OR "
                    End If
                End If

                If PriceCheckT2Enabled Then
                    If chkPricesT2.Checked Then
                        ' Add to SQL query for tech level
                        TechSQL = TechSQL & "ITEM_TYPE = 2 OR "
                    End If
                End If

                If PriceCheckT3Enabled Then
                    If chkPricesT3.Checked Then
                        ' Add to SQL query for tech level
                        TechSQL = TechSQL & "ITEM_TYPE = 14 OR "
                    End If
                End If

                ' Add the Pirate, Storyline, Navy search string
                ' Storyline
                If PriceCheckT4Enabled Then
                    If chkPricesT4.Checked Then
                        ' Add to SQL query for tech level
                        TechSQL = TechSQL & "ITEM_TYPE = 3 OR "
                    End If
                End If

                ' Navy
                If PriceCheckT5Enabled Then
                    If chkPricesT5.Checked Then
                        ' Add to SQL query for tech level
                        TechSQL = TechSQL & "ITEM_TYPE = 16 OR "
                    End If
                End If

                ' Pirate
                If PriceCheckT6Enabled Then
                    If chkPricesT6.Checked Then
                        ' Add to SQL query for tech level
                        TechSQL = TechSQL & "ITEM_TYPE = 15 OR "
                    End If
                End If

                ' Format TechSQL - Add on Meta codes - 21,22,23,24 are T3
                If TechSQL <> "" Then
                    TechSQL = "(" & TechSQL.Substring(0, TechSQL.Length - 3) & "OR ITEM_TYPE IN (21,22,23,24)) "
                End If

                ' Build Tech 1,2,3 Manufactured Items
                If chkCharges.Checked Then
                    SQL &= "(ITEM_CATEGORY = 'Charge' AND " & TechSQL
                    If cmbPriceChargeTypes.Text <> "All Charge Types" Then
                        SQL &= " AND ITEM_GROUP = '" & cmbPriceChargeTypes.Text & "'"
                    End If
                    SQL &= ") OR "
                End If
                If chkDrones.Checked Then
                    SQL &= "(ITEM_CATEGORY IN ('Drone', 'Fighter') AND " & TechSQL & ") OR "
                End If
                If chkModules.Checked Then ' Not rigs but Modules
                    SQL &= "(ITEM_CATEGORY = 'Module' AND ITEM_GROUP NOT LIKE 'Rig%' AND " & TechSQL & ") OR "
                End If
                If chkShips.Checked Then
                    SQL &= "(ITEM_CATEGORY = 'Ship' AND " & TechSQL
                    If cmbPriceShipTypes.Text <> "All Ship Types" Then
                        SQL &= " AND ITEM_GROUP = '" & cmbPriceShipTypes.Text & "'"
                    End If
                    SQL &= ") OR "
                End If
                If chkSubsystems.Checked Then
                    SQL &= "(ITEM_CATEGORY = 'Subsystem' AND " & TechSQL & ") OR "
                End If
                If chkStructureRigs.Checked Then
                    SQL &= "(ITEM_CATEGORY = 'Structure Rigs' AND " & TechSQL & ") OR "
                End If
                If chkRigs.Checked Then ' Rigs
                    SQL &= "((ITEM_CATEGORY = 'Module' AND ITEM_GROUP LIKE 'Rig%' AND " & TechSQL & ") OR (ITEM_CATEGORY = 'Structure Module' AND ITEM_GROUP LIKE '%Rig%')) OR "
                End If
                If chkStructures.Checked Then
                    SQL &= "((ITEM_CATEGORY IN ('Starbase','Structure') AND " & TechSQL & ") OR ITEM_GROUP = 'Station Components') OR "
                End If
            Else
                ' No tech level chosen, so just continue with other options and skip these that require a tech selection
            End If
        End If

        ' Leave function if no items checked
        If Not ItemChecked Then
            lstPricesView.Items.Clear()
        Else
            ' Take off last OR and add the final )
            SQL = SQL.Substring(0, SQL.Length - 4)
            SQL &= ") "

            ' Search based on text
            If txtPriceItemFilter.Text <> "" Then
                SQL &= "AND " & GetSearchText(txtPriceItemFilter.Text, "ITEM_NAME", "ITEM_GROUP") & " "
            End If

            ' See if we want prices that are 0 only
            If chkUpdatePricesNoPrice.Checked Then
                SQL &= "AND PRICE = 0 "
            End If

            SQL &= "ORDER BY ITEM_GROUP, ITEM_CATEGORY, ITEM_NAME"

            DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
            readerMats = DBCommand.ExecuteReader

            ' Clear List
            lstPricesView.Items.Clear()
            ' Disable sorting because it will crawl after we update if there are too many records
            lstPricesView.ListViewItemSorter = Nothing
            lstPricesView.BeginUpdate()
            Me.Cursor = Cursors.WaitCursor

            ' Fill list
            While readerMats.Read
                'ITEM_ID, ITEM_NAME, ITEM_GROUP, PRICE, MANUFACTURE
                lstViewRow = New ListViewItem(CStr(readerMats.GetValue(0))) ' ID
                'The remaining columns are subitems  
                lstViewRow.SubItems.Add(CStr(readerMats.GetString(2))) ' Group
                lstViewRow.SubItems.Add(CStr(readerMats.GetString(1))) ' Name
                lstViewRow.SubItems.Add(FormatNumber(readerMats.GetDouble(3), 2))
                lstViewRow.SubItems.Add(CStr(readerMats.GetValue(4)))
                If IsDBNull(readerMats.GetValue(5)) Then
                    lstViewRow.SubItems.Add("")
                Else
                    lstViewRow.SubItems.Add(CStr(readerMats.GetInt64(5)))
                End If
                ' Price Type - look it up
                lstViewRow.SubItems.Add(CStr(readerMats.GetString(6)))

                Call lstPricesView.Items.Add(lstViewRow)
            End While

            readerMats.Close()

            ' Now sort this
            Dim TempType As SortOrder
            If UpdatePricesColumnSortType = SortOrder.Ascending Then
                TempType = SortOrder.Descending
            Else
                TempType = SortOrder.Ascending
            End If
            Call ListViewColumnSorter(UpdatePricesColumnClicked, CType(lstPricesView, ListView), UpdatePricesColumnClicked, TempType)
            Me.Cursor = Cursors.Default
            lstPricesView.EndUpdate()
        End If

        ' Reset
        txtListEdit.Visible = False
        Me.Cursor = Cursors.Default
        Application.DoEvents()
        pnlStatus.Text = ""

    End Sub

    ' Makes sure a tech is enabled and checked for items that require tech based on saved values, not current due to disabling form
    Private Function CheckTechChecks() As Boolean

        If PriceCheckT1Enabled Then
            If TechCheckBoxes(1).Checked Then
                Return True
            End If
        End If

        If PriceCheckT2Enabled Then
            If TechCheckBoxes(2).Checked Then
                Return True
            End If
        End If

        If PriceCheckT3Enabled Then
            If TechCheckBoxes(3).Checked Then
                Return True
            End If
        End If

        If PriceCheckT4Enabled Then
            If TechCheckBoxes(4).Checked Then
                Return True
            End If
        End If

        If PriceCheckT5Enabled Then
            If TechCheckBoxes(5).Checked Then
                Return True
            End If
        End If

        If PriceCheckT6Enabled Then
            If TechCheckBoxes(6).Checked Then
                Return True
            End If
        End If

        Return False

    End Function

    Private Sub LoadPriceShipTypes()
        Dim SQL As String
        Dim readerShipType As SQLiteDataReader

        ' Load the select systems combobox with systems
        SQL = "SELECT groupName from inventory_types, inventory_groups, inventory_categories "
        SQL &= "WHERE  inventory_types.groupID = inventory_groups.groupID "
        SQL &= "AND inventory_groups.categoryID = inventory_categories.categoryID "
        SQL &= "AND categoryname = 'Ship' AND groupName NOT IN ('Rookie ship','Prototype Exploration Ship') "
        SQL &= "AND inventory_types.published <> 0  "
        SQL &= "GROUP BY groupName "

        DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
        readerShipType = DBCommand.ExecuteReader

        cmbPriceShipTypes.Items.Add("All Ship Types")

        While readerShipType.Read
            cmbPriceShipTypes.Items.Add(readerShipType.GetString(0))
        End While

        readerShipType.Close()

        cmbPriceShipTypes.Text = "All Ship Types"

    End Sub

    Private Sub LoadPriceChargeTypes()
        Dim SQL As String
        Dim readerChargeType As SQLiteDataReader

        ' Load the select systems combobox with systems
        SQL = "SELECT groupName from inventory_types, inventory_groups, inventory_categories "
        SQL &= "WHERE  inventory_types.groupID = inventory_groups.groupID "
        SQL &= "AND inventory_groups.categoryID = inventory_categories.categoryID "
        SQL &= "AND categoryname = 'Charge' "
        SQL &= "AND inventory_types.published <> 0 and inventory_groups.published <> 0 and inventory_categories.published <> 0 "
        SQL &= "GROUP BY groupName "

        DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
        readerChargeType = DBCommand.ExecuteReader

        cmbPriceChargeTypes.Items.Add("All Charge Types")

        While readerChargeType.Read
            cmbPriceChargeTypes.Items.Add(readerChargeType.GetString(0))
        End While

        readerChargeType.Close()

        cmbPriceChargeTypes.Text = "All Charge Types"

    End Sub

    Private Sub btnSavePricestoFile_Click(sender As System.Object, e As System.EventArgs) Handles btnSavePricestoFile.Click
        Dim MyStream As StreamWriter
        Dim FileName As String
        Dim OutputText As String
        Dim Price As ListViewItem

        Dim Items As ListView.ListViewItemCollection
        Dim i As Integer = 0

        ' Show the dialog
        Dim ExportTypeString As String
        Dim Separator As String
        Dim FileHeader As String

        If UserApplicationSettings.DataExportFormat = CSVDataExport Then
            ' Save file name with date
            FileName = "Price List - " & Format(Now, "MMddyyyy") & ".csv"
            ExportTypeString = CSVDataExport
            Separator = ","
            FileHeader = PriceListHeaderCSV
            SaveFileDialog.Filter = "csv files (*.csv)|*.csv|All files (*.*)|*.*"
        ElseIf UserApplicationSettings.DataExportFormat = SSVDataExport Then
            ' Save file name with date
            FileName = "Price List - " & Format(Now, "MMddyyyy") & ".ssv"
            ExportTypeString = SSVDataExport
            Separator = ";"
            FileHeader = PriceListHeaderSSV
            SaveFileDialog.Filter = "ssv files (*.ssv*)|*.ssv*|All files (*.*)|*.*"
        Else
            ' Save file name with date
            FileName = "Price List - " & Format(Now, "MMddyyyy") & ".txt"
            ExportTypeString = DefaultTextDataExport
            Separator = "|"
            FileHeader = PriceListHeaderTXT
            SaveFileDialog.Filter = "txt files (*.txt)|*.txt|All files (*.*)|*.*"
        End If

        SaveFileDialog.FilterIndex = 1
        SaveFileDialog.RestoreDirectory = True
        SaveFileDialog.FileName = FileName

        If SaveFileDialog.ShowDialog() = DialogResult.OK Then
            Try
                MyStream = File.CreateText(SaveFileDialog.FileName)

                If Not (MyStream Is Nothing) Then

                    ' Output the buy list first
                    Items = lstPricesView.Items

                    If Items.Count > 0 Then
                        Me.Cursor = Cursors.WaitCursor

                        Application.DoEvents()

                        OutputText = FileHeader
                        MyStream.Write(OutputText & Environment.NewLine)

                        For Each Price In Items
                            Application.DoEvents()
                            ' Build the output text -"Group,Item Name,Price,Price Type,Raw Material,Type ID"
                            OutputText = Price.SubItems(1).Text & Separator
                            OutputText = OutputText & Price.SubItems(2).Text & Separator
                            If ExportTypeString = SSVDataExport Then
                                ' Format to EU
                                OutputText = OutputText & ConvertUStoEUDecimal(Price.SubItems(3).Text) & Separator
                            Else
                                OutputText = OutputText & Format(Price.SubItems(3).Text, "Fixed") & Separator
                            End If
                            OutputText = OutputText & Price.SubItems(6).Text & Separator
                            ' Manufacturing flag - set if raw mat or not (raw mats are not manufactured)
                            If Price.SubItems(4).Text = "0" Then
                                OutputText = OutputText & "TRUE" & Separator
                            Else
                                OutputText = OutputText & "FALSE" & Separator
                            End If
                            OutputText = OutputText & Price.SubItems(0).Text

                            MyStream.Write(OutputText & Environment.NewLine)
                        Next

                    End If

                    MyStream.Flush()
                    MyStream.Close()

                    MsgBox("Price List Saved", vbInformation, Application.ProductName)

                End If
            Catch
                MsgBox(Err.Description, vbExclamation, Application.ProductName)
            End Try
        End If

        ' Done processing 
        Me.Cursor = Cursors.Default
        Me.Refresh()
        Application.DoEvents()

    End Sub

    Private Sub btnLoadPricesfromFile_Click(sender As System.Object, e As System.EventArgs) Handles btnLoadPricesfromFile.Click
        Dim SQL As String
        Dim BPStream As StreamReader = Nothing
        Dim openFileDialog1 As New OpenFileDialog()
        Dim Line As String
        Dim Header As String = ""
        Dim ParsedLine As String()
        Dim Separator As String = ""
        Dim FileType As String

        If UserApplicationSettings.DataExportFormat = CSVDataExport Then
            FileType = CSVDataExport
            openFileDialog1.Filter = "csv files (*.csv)|*.csv|All files (*.*)|*.*"
            openFileDialog1.FileName = "*.csv"
            openFileDialog1.FilterIndex = 2
            openFileDialog1.RestoreDirectory = True
        ElseIf UserApplicationSettings.DataExportFormat = SSVDataExport Then
            FileType = SSVDataExport
            openFileDialog1.Filter = "ssv files (*.ssv*)|*.ssv*|All files (*.*)|*.*"
            openFileDialog1.FileName = "*.ssv"
            openFileDialog1.FilterIndex = 2
            openFileDialog1.RestoreDirectory = True
        Else
            FileType = DefaultTextDataExport
            openFileDialog1.Filter = "txt files (*.txt)|*.txt|All files (*.*)|*.*"
            openFileDialog1.FileName = "*.txt"
            openFileDialog1.FilterIndex = 2
            openFileDialog1.RestoreDirectory = True
        End If

        Dim SavedgbPPValue As Boolean = gbPriceProfile.Enabled
        Dim SavedgbSSValue As Boolean = gbSingleSource.Enabled

        If openFileDialog1.ShowDialog() = System.Windows.Forms.DialogResult.OK Then
            Try
                BPStream = New StreamReader(openFileDialog1.FileName)

                If (BPStream IsNot Nothing) Then
                    ' Read the file line by line here, start with headers
                    Header = BPStream.ReadLine
                    Line = BPStream.ReadLine ' First line of data

                    If Line Is Nothing Then
                        ' Leave loop
                        Exit Try
                    Else
                        ' disable the tab
                        Call DisableUpdatePricesTab(True)
                        gbPriceProfile.Enabled = False
                        gbSingleSource.Enabled = False
                    End If

                    Call EVEDB.BeginSQLiteTransaction()
                    Application.UseWaitCursor = True

                    While Line IsNot Nothing
                        Application.DoEvents()
                        ' Format for IPH saved file is is: Group Name, Item Name, Price, Price Type, Raw Material, Type ID

                        ' Parse it
                        Select Case FileType
                            Case CSVDataExport
                                ParsedLine = Line.Split(New Char() {","c}, StringSplitOptions.RemoveEmptyEntries)
                            Case SSVDataExport
                                ParsedLine = Line.Split(New Char() {";"c}, StringSplitOptions.RemoveEmptyEntries)
                            Case Else ' Text
                                ' See if this is an IPH saved file or an EVE Client file
                                If Header = "price,volRemaining,typeID,range,orderID,volEntered,minVolume,bid,issueDate,duration,stationID,regionID,solarSystemID,jumps," Then
                                    ' This is the EVE Client format so just throw a message and exit
                                    ParsedLine = Nothing
                                    MsgBox("This file was exprted by the EVE Client. IPH does not load prices from the EVE Client export.", vbInformation, Application.ProductName)
                                    GoTo ExitPRocessing
                                Else
                                    ' IPH format
                                    ParsedLine = Line.Split(New Char() {"|"c}, StringSplitOptions.RemoveEmptyEntries)
                                End If
                        End Select

                        ' Loop through and update the price and price type, the rest is static
                        SQL = "UPDATE ITEM_PRICES_FACT SET "
                        If FileType = SSVDataExport Then
                            ' Need to swap periods and commas before inserting
                            ParsedLine(2) = ParsedLine(2).Replace(".", "") ' Just replace the periods as they are commas for numbers, which aren't needed
                            ParsedLine(2) = ParsedLine(2).Replace(",", ".") ' now update the commas for decimal
                        Else
                            ParsedLine(2) = ParsedLine(2).Replace(",", "") ' Make sure we format correctly, strip out any commas
                        End If
                        SQL &= "PRICE = " & ParsedLine(2) & ","
                        SQL &= "PRICE_TYPE = '" & ParsedLine(3) & "' "
                        SQL &= "WHERE ITEM_ID = " & ParsedLine(5)

                        ' Update the record
                        Call EVEDB.ExecuteNonQuerySQL(SQL)

                        Line = BPStream.ReadLine ' Read next line

                    End While

                    Call EVEDB.CommitSQLiteTransaction()

                    Application.UseWaitCursor = False
                    MsgBox("Prices Loaded", vbInformation, Application.ProductName)

                End If
            Catch Ex As Exception
                Application.UseWaitCursor = False
                Call EVEDB.RollbackSQLiteTransaction()
                MessageBox.Show("Cannot read file from disk. Original error: " & Ex.Message)
            Finally
                ' Check this again, since we need to make sure we didn't throw an exception on open.
                If (BPStream IsNot Nothing) Then
                    BPStream.Close()
                End If
            End Try
        End If

ExitPRocessing:

        Application.UseWaitCursor = False
        ' Enable the tab
        Call DisableUpdatePricesTab(False)
        gbSingleSource.Enabled = SavedgbSSValue
        gbPriceProfile.Enabled = SavedgbPPValue
        Call UpdatePriceList()
        Application.DoEvents()

    End Sub

    Private Sub btnViewSavedStructures_Click(sender As Object, e As EventArgs) Handles btnViewSavedStructures.Click
        If frmViewStructures.Visible = False Then
            frmViewStructures = New frmViewSavedStructures
            frmViewStructures.Show()
        End If
    End Sub

#End Region

#Region "Manufacturing"

#Region "Manufacturing Object Functions"

    Private Sub lstManufacturing_KeyDown(sender As System.Object, e As System.Windows.Forms.KeyEventArgs) Handles lstManufacturing.KeyDown

        If e.KeyCode = Keys.C AndAlso e.Control = True Then ' Copy
            ' Find the bp record selected
            Dim FoundItem As New ManufacturingItem
            ' Copy the bps to the clipboard or item name if bp isn't set
            Dim OutputText As String = ""

            For i = 0 To lstManufacturing.SelectedItems.Count - 1
                ' Find the item clicked in the list of items then just send those values over
                ManufacturingRecordIDToFind = CLng(lstManufacturing.SelectedItems(i).SubItems(0).Text)
                FoundItem = FinalManufacturingItemList.Find(AddressOf FindManufacturingItem)
                OutputText &= FoundItem.ItemName & vbCrLf
            Next

            Call CopyTextToClipboard(OutputText)

        ElseIf e.KeyCode = Keys.A AndAlso e.Control = True Then ' Select all
            For i = 0 To lstManufacturing.Items.Count - 1
                lstManufacturing.Items(i).Selected = True
                Application.DoEvents()
            Next
        End If

    End Sub

    Private Sub btnCalcShowAssets_Click(sender As System.Object, e As System.EventArgs) Handles btnCalcShowAssets.Click
        ' Make sure it's not disposed
        If IsNothing(frmDefaultAssets) Then
            ' Make new form
            frmDefaultAssets = New frmAssetsViewer(AssetWindow.ManufacturingTab)
        Else
            If frmDefaultAssets.IsDisposed Then
                ' Make new form
                frmDefaultAssets = New frmAssetsViewer(AssetWindow.ManufacturingTab)
            End If
        End If

        ' Now open the Asset List
        frmDefaultAssets.Show()
        frmDefaultAssets.Focus()

        Application.DoEvents()
    End Sub

    Private Sub cmbCalcFWManufUpgradeLevel_SelectedIndexChanged(sender As System.Object, e As System.EventArgs)
        Call ResetRefresh()
    End Sub

    Private Sub cmbCalcFWCopyUpgradeLevel_SelectedIndexChanged(sender As System.Object, e As System.EventArgs)
        Call ResetRefresh()
    End Sub

    Private Sub cmbCalcFWInventionUpgradeLevel_SelectedIndexChanged(sender As System.Object, e As System.EventArgs)
        Call ResetRefresh()
    End Sub

    Private Sub cmbCalcFWUpgrade_KeyPress(sender As Object, e As System.Windows.Forms.KeyPressEventArgs)
        e.Handled = True
    End Sub

    Private Sub CheckRelicCalcChecks()
        Dim i As Integer

        If chkCalcT3.Checked Then
            If Not FirstLoad Then
                For i = 1 To CalcRelicCheckboxes.Count - 1
                    If CalcRelicCheckboxes(i).Checked Then
                        Exit Sub
                    End If
                Next

                ' One wasn't checked, display message and check wrecked
                MsgBox("Must select at least one relic type", vbExclamation, Application.ProductName)
                chkCalcRERelic1.Checked = True
            End If
        End If

    End Sub

    Private Sub CheckDecryptorChecks()
        Dim i As Integer

        ' Only check decryptor checks if they have T2 bp's checked
        If chkCalcT2.Checked Then
            If Not FirstLoad Then
                For i = 1 To CalcDecryptorCheckBoxes.Count - 1
                    If CalcDecryptorCheckBoxes(i).Checked Then
                        GoTo CheckTechs
                    End If
                Next

                ' One wasn't checked, display message and check wrecked
                MsgBox("Must select at least one decryptor type", vbExclamation, Application.ProductName)
                chkCalcDecryptor1.Checked = True
            End If
        End If

CheckTechs:

        If chkCalcDecryptorforT2.Enabled And chkCalcDecryptorforT3.Enabled Then
            ' If both enabled, one needs to be checked
            If chkCalcDecryptorforT2.Checked = False And chkCalcDecryptorforT3.Checked = False Then
                MsgBox("Must select Decryptor if using Tech 2 and 3", vbExclamation, Application.ProductName)
                chkCalcDecryptorforT2.Checked = True
            End If
        ElseIf chkCalcDecryptorforT2.Enabled Then
            If chkCalcDecryptorforT2.Checked = False Then
                MsgBox("Must select Decryptor if using Tech 2", vbExclamation, Application.ProductName)
                chkCalcDecryptorforT2.Checked = True
            End If
        ElseIf chkCalcDecryptorforT3.Enabled Then
            If chkCalcDecryptorforT3.Checked = False Then
                MsgBox("Must select Decryptor if using Tech 3", vbExclamation, Application.ProductName)
                chkCalcDecryptorforT3.Checked = True
            End If
        End If

    End Sub

    Private Sub rbtnCalcRawT2MatType_CheckedChanged(sender As Object, e As EventArgs) Handles rbtnCalcRawT2MatType.CheckedChanged
        If rbtnCalcRawT2MatType.Checked Then
            UserManufacturingTabSettings.BuildT2T3Materials = BuildMatType.RawMaterials
            Call ResetRefresh()
            Call ProcessT2MatSelection()
        End If
    End Sub

    Private Sub rbtnCalcProcT2MatType_CheckedChanged(sender As Object, e As EventArgs) Handles rbtnCalcProcT2MatType.CheckedChanged
        If rbtnCalcProcT2MatType.Checked Then
            UserManufacturingTabSettings.BuildT2T3Materials = BuildMatType.ProcessedMaterials
            Call ResetRefresh()
            Call ProcessT2MatSelection()
        End If
    End Sub

    Private Sub rbtnCalcAdvT2MatType_CheckedChanged(sender As Object, e As EventArgs) Handles rbtnCalcAdvT2MatType.CheckedChanged
        If rbtnCalcAdvT2MatType.Checked Then
            UserManufacturingTabSettings.BuildT2T3Materials = BuildMatType.AdvMaterials
            Call ResetRefresh()
            Call ProcessT2MatSelection()
        End If
    End Sub

    Private Sub txtCalcProdLines_DoubleClick(sender As Object, e As System.EventArgs) Handles txtCalcProdLines.DoubleClick
        ' Enter the max lines we have
        txtCalcProdLines.Text = CStr(SelectedCharacter.MaximumProductionLines)
    End Sub

    Private Sub txtCalcProdLines_KeyPress(sender As Object, e As System.Windows.Forms.KeyPressEventArgs) Handles txtCalcProdLines.KeyPress
        ' Only allow numbers or backspace
        If e.KeyChar <> ControlChars.Back Then
            If allowedRunschars.IndexOf(e.KeyChar) = -1 Then
                ' Invalid Character
                e.Handled = True
            Else
                Call ResetRefresh()
            End If
        End If
    End Sub

    Private Sub txtCalcProdLines_TextChanged(sender As System.Object, e As System.EventArgs) Handles txtCalcProdLines.TextChanged
        Call ResetRefresh()
    End Sub

    Private Sub txtCalcBPs_KeyPress(sender As Object, e As System.Windows.Forms.KeyPressEventArgs) Handles txtCalcNumBPs.KeyPress
        ' Only allow numbers or backspace
        If e.KeyChar <> ControlChars.Back Then
            If allowedRunschars.IndexOf(e.KeyChar) = -1 Then
                ' Invalid Character
                e.Handled = True
            Else
                Call ResetRefresh()
            End If
        End If
    End Sub

    Private Sub txtCalcBPs_TextChanged(sender As System.Object, e As System.EventArgs) Handles txtCalcNumBPs.TextChanged
        Call ResetRefresh()
    End Sub

    Private Sub txtCalcRuns_TextChanged(sender As System.Object, e As System.EventArgs) Handles txtCalcRuns.TextChanged
        Call ResetRefresh()
    End Sub

    Private Sub txtCalcLabLines_DoubleClick(sender As Object, e As System.EventArgs) Handles txtCalcLabLines.DoubleClick
        ' Enter the max lab lines we have
        txtCalcLabLines.Text = CStr(SelectedCharacter.MaximumLaboratoryLines)
    End Sub

    Private Sub txtCalcLabLines_KeyPress(sender As Object, e As System.Windows.Forms.KeyPressEventArgs) Handles txtCalcLabLines.KeyPress
        ' Only allow numbers or backspace
        If e.KeyChar <> ControlChars.Back Then
            If allowedRunschars.IndexOf(e.KeyChar) = -1 Then
                ' Invalid Character
                e.Handled = True
            Else
                Call ResetRefresh()
            End If
        End If
    End Sub

    Private Sub txtCalcLabLines_TextChanged(sender As Object, e As System.EventArgs) Handles txtCalcLabLines.TextChanged
        Call ResetRefresh()
    End Sub

    Private Sub chkCalcIgnoreLowSVR_CheckedChanged(sender As System.Object, e As System.EventArgs)
        Call ResetRefresh()
    End Sub

    Private Sub cmbCalcAvgPriceDuration_KeyPress(sender As Object, e As System.Windows.Forms.KeyPressEventArgs) Handles cmbCalcAvgPriceDuration.KeyPress
        ' Only allow numbers or backspace
        If e.KeyChar <> ControlChars.Back Then
            If allowedRunschars.IndexOf(e.KeyChar) = -1 Then
                ' Invalid Character
                e.Handled = True
            Else
                Call ResetRefresh()
            End If
        End If
    End Sub

    Private Sub cmbCalcAvgPriceDuration_SelectedIndexChanged(sender As System.Object, e As System.EventArgs) Handles cmbCalcAvgPriceDuration.SelectedIndexChanged
        Call ResetRefresh()
    End Sub

    Private Sub chkCalcIgnoreMinerals_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs)
        Call ResetRefresh()
    End Sub

    Private Sub chkCalcIgnoreT1_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs)
        Call ResetRefresh()
    End Sub

    Private Sub chkCalcTaxes_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkCalcTaxes.CheckedChanged
        Call ResetRefresh()
    End Sub

    Private Sub chkCalcFees_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkCalcFees.CheckedChanged
        Call ResetRefresh()
    End Sub

    Private Sub chkCalcFees_Click(sender As Object, e As EventArgs) Handles chkCalcFees.Click
        If chkCalcFees.Checked And chkCalcFees.CheckState = CheckState.Indeterminate Then ' Show rate box
            txtCalcBrokerFeeRate.Visible = True
        Else
            txtCalcBrokerFeeRate.Visible = False
        End If
    End Sub

    Private Sub txtCalcBrokerFeeRate_KeyDown(sender As Object, e As KeyEventArgs) Handles txtCalcBrokerFeeRate.KeyDown
        If e.KeyCode = Keys.Enter Then
            txtCalcBrokerFeeRate.Text = GetFormattedPercentEntry(txtCalcBrokerFeeRate)
        End If
    End Sub

    Private Sub txtCalcBrokerFeeRate_KeyPress(sender As Object, e As KeyPressEventArgs) Handles txtCalcBrokerFeeRate.KeyPress
        ' Only allow numbers, decimal, percent or backspace
        If e.KeyChar <> ControlChars.Back Then
            If allowedPercentChars.IndexOf(e.KeyChar) = -1 Then
                ' Invalid Character
                e.Handled = True
            End If
        End If
    End Sub

    Private Sub txtCalcBrokerFeeRate_GotFocus(sender As Object, e As EventArgs) Handles txtCalcBrokerFeeRate.GotFocus
        Call txtCalcBrokerFeeRate.SelectAll()
    End Sub

    Private Sub txtCalcBrokerFeeRate_LostFocus(sender As Object, e As EventArgs) Handles txtCalcBrokerFeeRate.LostFocus
        txtCalcBrokerFeeRate.Text = GetFormattedPercentEntry(txtCalcBrokerFeeRate)
    End Sub

    Private Sub chkCalcSellExessItems_CheckedChanged(sender As Object, e As EventArgs) Handles chkCalcSellExessItems.CheckedChanged
        Call ResetRefresh()
    End Sub

    Private Sub chkCalcUsage_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs)
        Call ResetRefresh()
    End Sub

    Private Sub chkCalcIgnoreRAMS_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs)
        Call ResetRefresh()
    End Sub

    Private Sub chkCalcIgnoreInvention_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs)
        Call ResetRefresh()
    End Sub

    Private Sub chkCalcEstimateCopyCost_CheckedChanged(sender As System.Object, e As System.EventArgs)
        Call ResetRefresh()
    End Sub

    Private Sub chkCalcIgnoreInvention_CheckedChanged_1(sender As System.Object, e As System.EventArgs) Handles chkCalcIgnoreInvention.CheckedChanged
        Call ResetRefresh()
    End Sub

    Private Sub chkCalcIgnoreMinerals_CheckedChanged_1(sender As System.Object, e As System.EventArgs) Handles chkCalcIgnoreMinerals.CheckedChanged
        Call ResetRefresh()
    End Sub

    Private Sub chkCalcIgnoreT1Item_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkCalcIgnoreT1Item.CheckedChanged
        Call ResetRefresh()
    End Sub

    Private Sub rbtnCalcCompareAll_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles rbtnCalcCompareAll.CheckedChanged
        Call ResetRefresh()
    End Sub

    Private Sub txtCalcSVRThreshold_KeyPress(sender As Object, e As System.Windows.Forms.KeyPressEventArgs) Handles txtCalcSVRThreshold.KeyPress
        ' Only allow numbers, decimal, negative or backspace
        If e.KeyChar <> ControlChars.Back Then
            If allowedDecimalChars.IndexOf(e.KeyChar) = -1 Then
                ' Invalid Character
                e.Handled = True
            Else
                Call ResetRefresh()
            End If
        End If
    End Sub

    Private Sub txtCalcSVRThreshold_TextChanged(sender As System.Object, e As System.EventArgs) Handles txtCalcSVRThreshold.TextChanged
        Call ResetRefresh()
    End Sub

    Private Sub chkCalcSVRIncludeNull_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkCalcSVRIncludeNull.CheckedChanged
        Call ResetRefresh()
    End Sub

    Private Sub rbtnCalcCompareBuildBuy_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles rbtnCalcCompareBuildBuy.CheckedChanged
        Call ResetRefresh()
    End Sub

    Private Sub rbtnCalcCompareRawMats_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles rbtnCalcCompareRawMats.CheckedChanged
        Call ResetRefresh()
    End Sub

    Private Sub rbtnCalcCompareComponents_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles rbtnCalcCompareComponents.CheckedChanged
        Call ResetRefresh()
    End Sub

    Private Sub chkCalcPPU_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkCalcPPU.CheckedChanged
        Call ResetRefresh()
    End Sub

    Private Sub cmbCalcShipBPCNoD_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs)
        Call ResetRefresh()
    End Sub

    Private Sub cmbCalcShipBPCD_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs)
        Call ResetRefresh()
    End Sub

    Private Sub cmbCalcNonShipBPCNoD_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs)
        Call ResetRefresh()
    End Sub

    Private Sub cmbCalcNonShipBPCD_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs)
        Call ResetRefresh()
    End Sub

    Private Sub chkCalcCanBuild_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkCalcCanBuild.CheckedChanged
        Call ResetRefresh()
    End Sub

    Private Sub chkCalcCanInvent_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkCalcCanInvent.CheckedChanged
        Call ResetRefresh()
    End Sub

    Private Sub txtTempME_KeyPress(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyPressEventArgs) Handles txtCalcTempME.KeyPress
        ' Only allow numbers, negative or backspace
        If e.KeyChar <> ControlChars.Back Then
            If allowedMETEChars.IndexOf(e.KeyChar) = -1 Then
                ' Invalid Character
                e.Handled = True
            Else
                Call ResetRefresh()
            End If
        End If
    End Sub

    Private Sub txtTempPE_KeyPress(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyPressEventArgs) Handles txtCalcTempTE.KeyPress
        ' Only allow numbers or backspace
        If e.KeyChar <> ControlChars.Back Then
            If allowedMETEChars.IndexOf(e.KeyChar) = -1 Then
                ' Invalid Character
                e.Handled = True
            Else
                Call ResetRefresh()
            End If
        End If
    End Sub

    Private Sub txtCalcItemFilter_TextChanged(sender As System.Object, e As System.EventArgs) Handles txtCalcItemFilter.TextChanged
        If Not FirstManufacturingGridLoad Then
            FirstLoadCalcBPTypes = True
            cmbCalcBPTypeFilter.Text = "All Types"
            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcRERelic1_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkCalcRERelic1.CheckedChanged
        Call CheckRelicCalcChecks()
        Call ResetRefresh()
    End Sub

    Private Sub chkCalcUseMaxBPCRunsNoRunsDecryptor_CheckedChanged(sender As System.Object, e As System.EventArgs)
        Call ResetRefresh()
    End Sub

    Private Sub chkCalcRERelic2_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkCalcRERelic2.CheckedChanged
        Call CheckRelicCalcChecks()
        Call ResetRefresh()
    End Sub

    Private Sub chkCalcRERelic3_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkCalcRERelic3.CheckedChanged
        Call CheckRelicCalcChecks()
        Call ResetRefresh()
    End Sub

    Private Sub btnCalcReset_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnCalcReset.Click
        FirstManufacturingGridLoad = True ' Reset
        Call InitManufacturingTab()
        ' Load the calc types because it won't get loaded if firstmanufacturinggridload = true
        Call LoadCalcBPTypes()
    End Sub

    Private Sub cmbCalcBPTypeFilter_DropDown(ByVal sender As Object, ByVal e As System.EventArgs) Handles cmbCalcBPTypeFilter.DropDown
        If FirstLoadCalcBPTypes Then
            Call LoadCalcBPTypes()
            FirstLoadCalcBPTypes = False
        End If
    End Sub

    Private Sub cmbCalcBPTypeFilter_GotFocus(ByVal sender As Object, ByVal e As System.EventArgs) Handles cmbCalcBPTypeFilter.GotFocus
        Call cmbCalcBPTypeFilter.SelectAll()
    End Sub

    Private Sub cmbCalcBPTypeFilter_KeyPress(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyPressEventArgs) Handles cmbCalcBPTypeFilter.KeyPress
        ' Only let them select a bp by clicking
        Dim i As Integer
        i = 0
    End Sub

    Private Sub cmbCalcBPTypeFilter_SelectedValueChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles cmbCalcBPTypeFilter.SelectedValueChanged
        Call ResetRefresh()
    End Sub

    Private Sub cmbCalcBPTypeFilter_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbCalcBPTypeFilter.Click
        Call cmbCalcBPTypeFilter.SelectAll()
    End Sub

    Private Sub chkCalcOnlyOwnedBPOInvent_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs)
        If Not FirstManufacturingGridLoad Then
            FirstLoadCalcBPTypes = True
            cmbCalcBPTypeFilter.Text = "All Types"
            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcT1_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkCalcT1.CheckedChanged
        If Not FirstManufacturingGridLoad Then
            FirstLoadCalcBPTypes = True
            cmbCalcBPTypeFilter.Text = "All Types"

            ' Disable NPC BPOs
            If chkCalcT1.Checked = False Then
                chkCalcNPCBPOs.Enabled = False
            Else
                chkCalcNPCBPOs.Enabled = True
            End If

            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcT2_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkCalcT2.CheckedChanged
        If Not FirstManufacturingGridLoad Then
            EnableDisableT2T3Options()
        End If
    End Sub

    Private Sub chkCalcT3_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkCalcT3.CheckedChanged
        If Not FirstManufacturingGridLoad Then
            Call EnableDisableT2T3Options()
        End If
    End Sub

    ' Enables and disables the checks on the screen when T2 or T3 is selected
    Private Sub EnableDisableT2T3Options()

        FirstLoadCalcBPTypes = True
        cmbCalcBPTypeFilter.Text = "All Types"
        Call ResetRefresh()

        ' If checked, show the options, disable if not
        If chkCalcT2.Checked = True Then
            chkCalcCanInvent.Enabled = True
            chkCalcCanInvent.Enabled = True
            chkCalcIncludeT2Owned.Enabled = True
            chkCalcDecryptorforT2.Enabled = True
        Else
            chkCalcCanInvent.Enabled = False
            chkCalcCanInvent.Enabled = False
            chkCalcIncludeT2Owned.Enabled = False
            chkCalcDecryptorforT2.Enabled = False
        End If

        ' If T3 checked, enable T3 options, else disable
        If chkCalcT3.Checked = True Then
            gbCalcRelics.Enabled = True
            chkCalcIncludeT3Owned.Enabled = True
            chkCalcDecryptorforT3.Enabled = True
        Else
            gbCalcRelics.Enabled = False
            chkCalcIncludeT3Owned.Enabled = False
            chkCalcDecryptorforT3.Enabled = False
        End If

        If chkCalcT3.Checked = False And chkCalcT2.Checked = False Then
            gbCalcInvention.Enabled = False
        Else
            gbCalcInvention.Enabled = True
        End If

        ' Auto check if only one option enabled
        If chkCalcDecryptorforT2.Enabled And chkCalcT2.Checked And chkCalcDecryptorforT3.Enabled = False Then
            ' Auto check this
            chkCalcDecryptorforT2.Checked = True
        ElseIf chkCalcDecryptorforT3.Enabled And chkCalcT3.Checked And chkCalcDecryptorforT2.Enabled = False Then
            ' Auto check this
            chkCalcDecryptorforT3.Checked = True
        End If

    End Sub

    Private Sub chkCalcT2_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles chkCalcT2.Click
        Call CheckDecryptorChecks()
        Call ResetRefresh()
    End Sub

    Private Sub chkCalcT3_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles chkCalcT3.Click
        Call CheckRelicCalcChecks()
        Call ResetRefresh()
    End Sub

    Private Sub chkCalcStoryline_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkCalcStoryline.CheckedChanged
        If Not FirstManufacturingGridLoad Then
            FirstLoadCalcBPTypes = True
            cmbCalcBPTypeFilter.Text = "All Types"
            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcNavyFaction_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkCalcNavyFaction.CheckedChanged
        If Not FirstManufacturingGridLoad Then
            FirstLoadCalcBPTypes = True
            cmbCalcBPTypeFilter.Text = "All Types"
            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcPirateFaction_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkCalcPirateFaction.CheckedChanged
        If Not FirstManufacturingGridLoad Then
            FirstLoadCalcBPTypes = True
            cmbCalcBPTypeFilter.Text = "All Types"
            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcNPCBPOs_CheckedChanged(sender As Object, e As EventArgs) Handles chkCalcNPCBPOs.CheckedChanged
        If Not FirstManufacturingGridLoad Then
            FirstLoadCalcBPTypes = True
            cmbCalcBPTypeFilter.Text = "All Types"
            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcShips_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkCalcShips.CheckedChanged
        If Not FirstManufacturingGridLoad Then
            FirstLoadCalcBPTypes = True
            cmbCalcBPTypeFilter.Text = "All Types"
            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcModules_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkCalcModules.CheckedChanged
        If Not FirstManufacturingGridLoad Then
            FirstLoadCalcBPTypes = True
            cmbCalcBPTypeFilter.Text = "All Types"
            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcDrones_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkCalcDrones.CheckedChanged
        If Not FirstManufacturingGridLoad Then
            FirstLoadCalcBPTypes = True
            cmbCalcBPTypeFilter.Text = "All Types"
            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcAmmo_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkCalcAmmo.CheckedChanged
        If Not FirstManufacturingGridLoad Then
            FirstLoadCalcBPTypes = True
            cmbCalcBPTypeFilter.Text = "All Types"
            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcRigs_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkCalcRigs.CheckedChanged
        If Not FirstManufacturingGridLoad Then
            FirstLoadCalcBPTypes = True
            cmbCalcBPTypeFilter.Text = "All Types"
            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcComponents_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkCalcComponents.CheckedChanged
        If Not FirstManufacturingGridLoad Then
            FirstLoadCalcBPTypes = True
            cmbCalcBPTypeFilter.Text = "All Types"
            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcStationParts_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkCalcStructureRigs.CheckedChanged
        If Not FirstManufacturingGridLoad Then
            FirstLoadCalcBPTypes = True
            cmbCalcBPTypeFilter.Text = "All Types"
            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcSubsystems_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkCalcSubsystems.CheckedChanged
        If Not FirstManufacturingGridLoad Then
            FirstLoadCalcBPTypes = True
            cmbCalcBPTypeFilter.Text = "All Types"
            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcStructures_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkCalcStructures.CheckedChanged
        If Not FirstManufacturingGridLoad Then
            FirstLoadCalcBPTypes = True
            cmbCalcBPTypeFilter.Text = "All Types"
            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcBoosters_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkCalcBoosters.CheckedChanged
        If Not FirstManufacturingGridLoad Then
            FirstLoadCalcBPTypes = True
            cmbCalcBPTypeFilter.Text = "All Types"
            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcMisc_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkCalcMisc.CheckedChanged
        If Not FirstManufacturingGridLoad Then
            FirstLoadCalcBPTypes = True
            cmbCalcBPTypeFilter.Text = "All Types"
            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcCelestials_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkCalcCelestials.CheckedChanged
        If Not FirstManufacturingGridLoad Then
            FirstLoadCalcBPTypes = True
            cmbCalcBPTypeFilter.Text = "All Types"
            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcReactions_CheckedChanged(sender As Object, e As EventArgs) Handles chkCalcReactions.CheckedChanged
        If Not FirstManufacturingGridLoad Then
            FirstLoadCalcBPTypes = True
            cmbCalcBPTypeFilter.Text = "All Types"
            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcStructureModules_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkCalcStructureModules.CheckedChanged
        If Not FirstManufacturingGridLoad Then
            FirstLoadCalcBPTypes = True
            cmbCalcBPTypeFilter.Text = "All Types"
            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcDeployables_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkCalcDeployables.CheckedChanged
        If Not FirstManufacturingGridLoad Then
            FirstLoadCalcBPTypes = True
            cmbCalcBPTypeFilter.Text = "All Types"
            Call ResetRefresh()
        End If
    End Sub

    Private Sub rbtnCalcBPOwned_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles rbtnCalcBPOwned.CheckedChanged
        If Not FirstManufacturingGridLoad Then
            FirstLoadCalcBPTypes = True
            cmbCalcBPTypeFilter.Text = "All Types"
            gbCalcIncludeOwned.Enabled = True
            Call ResetRefresh()
        End If
    End Sub

    Private Sub rbtnCalcAllBPs_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles rbtnCalcAllBPs.CheckedChanged
        If Not FirstManufacturingGridLoad Then
            FirstLoadCalcBPTypes = True
            cmbCalcBPTypeFilter.Text = "All Types"
            gbCalcIncludeOwned.Enabled = False
            Call ResetRefresh()
        End If
    End Sub

    Private Sub rbtnCalcBPFavorites_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles rbtnCalcBPFavorites.CheckedChanged
        If Not FirstManufacturingGridLoad Then
            FirstLoadCalcBPTypes = True
            cmbCalcBPTypeFilter.Text = "All Types"
            gbCalcIncludeOwned.Enabled = True
            Call ResetRefresh()
        End If
    End Sub

    Private Sub txtCalcItemFilter_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles txtCalcItemFilter.KeyDown
        'Call ProcessCutCopyPasteSelect(txtCalcItemFilter, e)
        If e.KeyCode = Keys.Enter Then
            Call ResetRefresh()
            Call DisplayManufacturingResults(False)
        End If
    End Sub

    Private Sub btnCalcResetTextSearch_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnCalcResetTextSearch.Click
        txtCalcItemFilter.Text = ""
        txtCalcItemFilter.Focus()
        If Not FirstManufacturingGridLoad Then
            FirstLoadCalcBPTypes = True
            cmbCalcBPTypeFilter.Text = "All Types"
            Call ResetRefresh()
        End If
    End Sub

    Private Sub txtCalcBPCCosts_KeyPress(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyPressEventArgs)
        ' Only allow numbers or backspace
        If e.KeyChar <> ControlChars.Back Then
            If allowedPriceChars.IndexOf(e.KeyChar) = -1 Then
                ' Invalid Character
                e.Handled = True
            Else
                Call ResetRefresh()
            End If
        End If
    End Sub

    Private Sub chkCalcDecryptor0_Click(sender As System.Object, e As System.EventArgs) Handles chkCalcDecryptor0.Click
        ' Change the name based on the check state
        If chkCalcDecryptor0.CheckState = CheckState.Unchecked Then
            chkCalcDecryptor0.Text = "Optimal"
        ElseIf chkCalcDecryptor0.CheckState = CheckState.Checked Then
            chkCalcDecryptor0.Text = "Optimal IPH"
        ElseIf chkCalcDecryptor0.CheckState = CheckState.Indeterminate Then
            chkCalcDecryptor0.Text = "Optimal Profit"
        End If

        If Not FirstLoad Then
            ' For this one, it's optimal so disable all the others if checked
            If chkCalcDecryptor0.Checked Then
                chkCalcDecryptor1.Enabled = False
                chkCalcDecryptor2.Enabled = False
                chkCalcDecryptor3.Enabled = False
                chkCalcDecryptor4.Enabled = False
                chkCalcDecryptor5.Enabled = False
                chkCalcDecryptor6.Enabled = False
                chkCalcDecryptor7.Enabled = False
                chkCalcDecryptor8.Enabled = False
                chkCalcDecryptor9.Enabled = False
            Else
                chkCalcDecryptor1.Enabled = True
                chkCalcDecryptor2.Enabled = True
                chkCalcDecryptor3.Enabled = True
                chkCalcDecryptor4.Enabled = True
                chkCalcDecryptor5.Enabled = True
                chkCalcDecryptor6.Enabled = True
                chkCalcDecryptor7.Enabled = True
                chkCalcDecryptor8.Enabled = True
                chkCalcDecryptor9.Enabled = True
            End If
            Call CheckDecryptorChecks()
            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcDecryptor1_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkCalcDecryptor1.CheckedChanged
        If Not FirstLoad Then
            Call CheckDecryptorChecks()
            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcDecryptor2_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkCalcDecryptor2.CheckedChanged
        If Not FirstLoad Then
            Call CheckDecryptorChecks()
            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcDecryptor3_CheckedChanged_1(sender As System.Object, e As System.EventArgs) Handles chkCalcDecryptor3.CheckedChanged
        If Not FirstLoad Then
            Call CheckDecryptorChecks()
            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcDecryptor4_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkCalcDecryptor4.CheckedChanged
        If Not FirstLoad Then
            Call CheckDecryptorChecks()
            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcDecryptor5_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkCalcDecryptor5.CheckedChanged
        If Not FirstLoad Then
            Call CheckDecryptorChecks()
            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcDecryptor6_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkCalcDecryptor6.CheckedChanged
        If Not FirstLoad Then
            Call CheckDecryptorChecks()
            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcDecryptor7_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkCalcDecryptor7.CheckedChanged
        If Not FirstLoad Then
            Call CheckDecryptorChecks()
            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcDecryptor8_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkCalcDecryptor8.CheckedChanged
        If Not FirstLoad Then
            Call CheckDecryptorChecks()
            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcDecryptor9_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkCalcDecryptor9.CheckedChanged
        If Not FirstLoad Then
            Call CheckDecryptorChecks()
            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcDecryptorforT2_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkCalcDecryptorforT2.CheckedChanged
        If Not FirstLoad Then
            Call CheckDecryptorChecks()
            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcDecryptorforT3_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkCalcDecryptorforT3.CheckedChanged
        If Not FirstLoad Then
            Call CheckDecryptorChecks()
            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcIncludeT2Owned_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkCalcIncludeT2Owned.CheckedChanged
        Call ResetRefresh()
    End Sub

    Private Sub chkCalcIncludeT3Owned_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkCalcIncludeT3Owned.CheckedChanged
        Call ResetRefresh()
    End Sub

    Private Sub chkCalcRaceAmarr_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkCalcRaceAmarr.CheckedChanged
        Call ResetRefresh()
    End Sub

    Private Sub chkCalcRaceCaldari_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkCalcRaceCaldari.CheckedChanged
        Call ResetRefresh()
    End Sub

    Private Sub chkCalcRaceGallente_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkCalcRaceGallente.CheckedChanged
        Call ResetRefresh()
    End Sub

    Private Sub chkCalcRaceMinmatar_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkCalcRaceMinmatar.CheckedChanged
        Call ResetRefresh()
    End Sub

    Private Sub chkCalcRacePirate_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkCalcRacePirate.CheckedChanged
        Call ResetRefresh()
    End Sub

    Private Sub chkCalcRaceOther_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkCalcRaceOther.CheckedChanged
        Call ResetRefresh()
    End Sub

    Private Sub cmbCalcHistoryRegion_DropDown(sender As Object, e As System.EventArgs) Handles cmbCalcHistoryRegion.DropDown
        If Not CalcHistoryRegionLoaded Then
            Call LoadRegionCombo(cmbCalcHistoryRegion, cmbCalcHistoryRegion.Text)
            CalcHistoryRegionLoaded = True
        End If
    End Sub

    Private Sub cmbCalcSVRRegion_KeyPress(sender As Object, e As System.Windows.Forms.KeyPressEventArgs) Handles cmbCalcHistoryRegion.KeyPress
        e.Handled = True
    End Sub

    Private Sub cmbCalcSVRRegion_SelectedIndexChanged(sender As System.Object, e As System.EventArgs) Handles cmbCalcHistoryRegion.SelectedIndexChanged
        Call ResetRefresh()
    End Sub

    Private Sub cmbCalcBuildTimeMod_SelectedIndexChanged(sender As System.Object, e As System.EventArgs)
        Call ResetRefresh()
    End Sub

    Private Sub chkCalcSmall_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkCalcSmall.CheckedChanged
        If Not FirstManufacturingGridLoad Then
            FirstLoadCalcBPTypes = True
            cmbCalcBPTypeFilter.Text = "All Types"
            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcMedium_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkCalcMedium.CheckedChanged
        If Not FirstManufacturingGridLoad Then
            FirstLoadCalcBPTypes = True
            cmbCalcBPTypeFilter.Text = "All Types"
            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcLarge_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkCalcLarge.CheckedChanged
        If Not FirstManufacturingGridLoad Then
            FirstLoadCalcBPTypes = True
            cmbCalcBPTypeFilter.Text = "All Types"
            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcXL_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkCalcXL.CheckedChanged
        If Not FirstManufacturingGridLoad Then
            FirstLoadCalcBPTypes = True
            cmbCalcBPTypeFilter.Text = "All Types"
            Call ResetRefresh()
        End If
    End Sub

    Private Sub btnCalcSelectColumns_Click(sender As System.Object, e As System.EventArgs) Handles btnCalcSelectColumns.Click
        Dim f1 As New frmSelectManufacturingTabColumns
        ManufacturingTabColumnsChanged = False
        f1.ShowDialog()

        ' Now Refresh the grid if it changed
        If ManufacturingTabColumnsChanged Then
            If lstManufacturing.Items.Count <> 0 Then
                RefreshCalcData = True
                Call DisplayManufacturingResults(False)
            Else
                Call RefreshManufacturingTabColumns()
            End If
        End If
    End Sub

    Private Sub txtCalcTempME_TextChanged(sender As System.Object, e As System.EventArgs) Handles txtCalcTempME.TextChanged
        Call VerifyMETEEntry(txtCalcTempME, "ME")
    End Sub

    Private Sub txtCalcTempTE_TextChanged(sender As System.Object, e As System.EventArgs) Handles txtCalcTempTE.TextChanged
        Call VerifyMETEEntry(txtCalcTempTE, "TE")
    End Sub

    Private Sub chkCalcAutoCalcT2NumBPs_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkCalcAutoCalcT2NumBPs.CheckedChanged
        Call ResetRefresh()
    End Sub

    Private Sub lstManufacturing_ColumnClick(sender As System.Object, e As System.Windows.Forms.ColumnClickEventArgs) Handles lstManufacturing.ColumnClick

        Call ListViewColumnSorter(e.Column, CType(lstManufacturing, ListView), ManufacturingColumnClicked, ManufacturingColumnSortType)

    End Sub

    Private Sub txtCalcIPHThreshold_KeyPress(sender As System.Object, e As System.Windows.Forms.KeyPressEventArgs) Handles txtCalcIPHThreshold.KeyPress
        ' Only allow numbers, decimal, negative or backspace
        If e.KeyChar <> ControlChars.Back Then
            If allowedDecimalChars.IndexOf(e.KeyChar) = -1 Then
                ' Invalid Character
                e.Handled = True
            Else
                Call ResetRefresh()
            End If
        End If
    End Sub

    Private Sub txtCalcIPHThreshold_LostFocus(sender As Object, e As System.EventArgs) Handles txtCalcIPHThreshold.LostFocus
        txtCalcIPHThreshold.Text = FormatNumber(txtCalcIPHThreshold.Text, 2)
    End Sub

    Private Sub txtCalcProfitThreshold_KeyPress(sender As Object, e As System.Windows.Forms.KeyPressEventArgs) Handles txtCalcProfitThreshold.KeyPress

        If chkCalcProfitThreshold.Text.Contains("%") Then
            ' Only allow numbers, decimal, negative or backspace
            If e.KeyChar <> ControlChars.Back Then
                If allowedPercentChars.IndexOf(e.KeyChar) = -1 Then
                    ' Invalid Character
                    e.Handled = True
                Else
                    ProfitPercentText = txtCalcProfitThreshold.Text
                    Call ResetRefresh()
                End If
            End If
        Else
            ' Only allow numbers, decimal, negative or backspace
            If e.KeyChar <> ControlChars.Back Then
                If allowedDecimalChars.IndexOf(e.KeyChar) = -1 Then
                    ' Invalid Character
                    e.Handled = True
                Else
                    ProfitText = txtCalcProfitThreshold.Text
                    Call ResetRefresh()
                End If
            End If
        End If
    End Sub

    Private Sub txtCalcProfitThreshold_LostFocus(sender As Object, e As System.EventArgs) Handles txtCalcProfitThreshold.LostFocus

        If chkCalcProfitThreshold.Text.Contains("%") Then
            txtCalcProfitThreshold.Text = FormatPercent(CDbl(txtCalcProfitThreshold.Text.Replace("%", "")) / 100, 1)
        Else
            txtCalcProfitThreshold.Text = FormatNumber(txtCalcProfitThreshold.Text, 2)
        End If
    End Sub

    Private Sub txtCalcVolumeThreshold_KeyPress(sender As Object, e As System.Windows.Forms.KeyPressEventArgs) Handles txtCalcVolumeThreshold.KeyPress
        ' Only allow postive numbers
        If e.KeyChar <> ControlChars.Back Then
            If allowedRunschars.IndexOf(e.KeyChar) = -1 Then
                ' Invalid Character
                e.Handled = True
            Else
                Call ResetRefresh()
            End If
        End If
    End Sub

    Private Sub txtCalcVolumeThreshold_LostFocus(sender As Object, e As System.EventArgs) Handles txtCalcVolumeThreshold.LostFocus
        txtCalcVolumeThreshold.Text = FormatNumber(txtCalcVolumeThreshold.Text, 0)
    End Sub

    Private Sub cmbCalcPriceTrend_SelectedIndexChanged(sender As System.Object, e As System.EventArgs) Handles cmbCalcPriceTrend.SelectedIndexChanged
        Call ResetRefresh()
    End Sub

    Private Sub txtCalcIPHThreshold_TextChanged(sender As System.Object, e As System.EventArgs) Handles txtCalcIPHThreshold.TextChanged
        Call ResetRefresh()
    End Sub

    Private Sub txtCalcProfitThreshold_TextChanged(sender As System.Object, e As System.EventArgs) Handles txtCalcProfitThreshold.TextChanged
        Call ResetRefresh()
    End Sub

    Private Sub txtCalcVolumeThreshold_TextChanged(sender As System.Object, e As System.EventArgs) Handles txtCalcVolumeThreshold.TextChanged
        Call ResetRefresh()
    End Sub

    Private Sub chkCalcMinBuildTimeFilter_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkCalcMinBuildTimeFilter.CheckedChanged
        Call ResetRefresh()
        If chkCalcMinBuildTimeFilter.Checked Then
            tpMinBuildTimeFilter.Enabled = True
        Else
            tpMinBuildTimeFilter.Enabled = False
        End If
    End Sub

    Private Sub chkCalcMaxBuildTimeFilter_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkCalcMaxBuildTimeFilter.CheckedChanged
        Call ResetRefresh()
        If chkCalcMaxBuildTimeFilter.Checked Then
            tpMaxBuildTimeFilter.Enabled = True
        Else
            tpMaxBuildTimeFilter.Enabled = False
        End If
    End Sub

    Private Sub chkCalcIPHThreshold_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkCalcIPHThreshold.CheckedChanged
        Call ResetRefresh()
        If chkCalcIPHThreshold.Checked Then
            txtCalcIPHThreshold.Enabled = True
        Else
            txtCalcIPHThreshold.Enabled = False
        End If
    End Sub

    Private Sub chkCalcProfitThreshold_Click(sender As Object, e As EventArgs) Handles chkCalcProfitThreshold.Click

        ' Save the value
        If txtCalcProfitThreshold.Text.Contains("%") Then
            ProfitPercentText = Trim(txtCalcProfitThreshold.Text)
            If Not IsNumeric(ProfitPercentText.Replace("%", "")) Then
                ProfitPercentText = "0.0%"
            End If
        Else
            ProfitText = Trim(txtCalcProfitThreshold.Text)
            If ProfitText.Contains("%") Then
                ProfitText = ProfitText.Replace("%", "")
            End If
            If Not IsNumeric(ProfitText) Then
                ProfitText = "0.00"
            End If
        End If

        ' Change the name based on the check state
        If chkCalcProfitThreshold.CheckState <> CheckState.Indeterminate Then
            chkCalcProfitThreshold.Text = "Profit Threshold:"
            txtCalcProfitThreshold.Text = FormatNumber(ProfitText, 2)
        ElseIf chkCalcProfitThreshold.CheckState = CheckState.Indeterminate Then
            chkCalcProfitThreshold.Text = "Profit % Threshold:"
            txtCalcProfitThreshold.Text = FormatPercent(CDbl(ProfitPercentText.Replace("%", "")) / 100)
        End If

        If Not FirstLoad Then
            ' For this one, it's optimal so disable all the others if checked
            If chkCalcProfitThreshold.CheckState <> CheckState.Unchecked Then
                txtCalcProfitThreshold.Enabled = True
            Else
                txtCalcProfitThreshold.Enabled = False
            End If
            Call ResetRefresh()
        End If
    End Sub

    Private Sub chkCalcVolumeThreshold_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkCalcVolumeThreshold.CheckedChanged
        Call ResetRefresh()
        If chkCalcVolumeThreshold.Checked Then
            txtCalcVolumeThreshold.Enabled = True
        Else
            txtCalcVolumeThreshold.Enabled = False
        End If
    End Sub

    Private Sub tpMinBuildTimeFilter_TimeChange(sender As Object, e As System.EventArgs) Handles tpMinBuildTimeFilter.TimeChange
        Call ResetRefresh()
    End Sub

    Private Sub tpMaxBuildTimeFilter_TimeChange(sender As Object, e As System.EventArgs) Handles tpMaxBuildTimeFilter.TimeChange
        Call ResetRefresh()
    End Sub

#End Region

#Region "Column Select Functions"

    ' Clears the list and rebuilds it with columns they selected
    Private Sub RefreshManufacturingTabColumns()

        Call LoadManufacturingTabColumnPositions()
        Call lstManufacturing.Clear()
        AddingColumns = True

        ' Add the first hidden column
        lstManufacturing.Columns.Add("ListID")
        lstManufacturing.Columns(0).Width = 0

        ' Now load all the columns in order of the settings
        For i = 1 To ColumnPositions.Count - 1
            If ColumnPositions(i) <> "" Then
                lstManufacturing.Columns.Add(ColumnPositions(i), GetColumnWidth(ColumnPositions(i)), GetColumnAlignment(ColumnPositions(i)))
            End If
        Next

        ' Hack to get around the scroll bar not showing
        lstManufacturing.AutoResizeColumn(0, ColumnHeaderAutoResizeStyle.None)

        AddingColumns = False

    End Sub

    ' Takes the column settings and saves the order to an array
    Private Sub LoadManufacturingTabColumnPositions()

        For i = 0 To ColumnPositions.Count - 1
            ColumnPositions(i) = ""
        Next

        With UserManufacturingTabColumnSettings
            ColumnPositions(.ItemCategory) = ProgramSettings.ItemCategoryColumnName
            ColumnPositions(.ItemGroup) = ProgramSettings.ItemGroupColumnName
            ColumnPositions(.ItemName) = ProgramSettings.ItemNameColumnName
            ColumnPositions(.Owned) = ProgramSettings.OwnedColumnName
            ColumnPositions(.Tech) = ProgramSettings.TechColumnName
            ColumnPositions(.BPME) = ProgramSettings.BPMEColumnName
            ColumnPositions(.BPTE) = ProgramSettings.BPTEColumnName
            ColumnPositions(.Inputs) = ProgramSettings.InputsColumnName
            ColumnPositions(.Compared) = ProgramSettings.ComparedColumnName
            ColumnPositions(.TotalRuns) = ProgramSettings.TotalRunsColumnName
            ColumnPositions(.SingleInventedBPCRuns) = ProgramSettings.SingleInventedBPCRunsColumnName
            ColumnPositions(.ProductionLines) = ProgramSettings.ProductionLinesColumnName
            ColumnPositions(.LaboratoryLines) = ProgramSettings.LaboratoryLinesColumnName
            ColumnPositions(.TotalInventionCost) = ProgramSettings.TotalInventionCostColumnName
            ColumnPositions(.TotalCopyCost) = ProgramSettings.TotalCopyCostColumnName
            ColumnPositions(.Taxes) = ProgramSettings.TaxesColumnName
            ColumnPositions(.BrokerFees) = ProgramSettings.BrokerFeesColumnName
            ColumnPositions(.BPProductionTime) = ProgramSettings.BPProductionTimeColumnName
            ColumnPositions(.TotalProductionTime) = ProgramSettings.TotalProductionTimeColumnName
            ColumnPositions(.CopyTime) = ProgramSettings.CopyTimeColumnName
            ColumnPositions(.InventionTime) = ProgramSettings.InventionTimeColumnName
            ColumnPositions(.ItemMarketPrice) = ProgramSettings.ItemMarketPriceColumnName
            ColumnPositions(.Profit) = ProgramSettings.ProfitColumnName
            ColumnPositions(.ProfitPercentage) = ProgramSettings.ProfitPercentageColumnName
            ColumnPositions(.IskperHour) = ProgramSettings.IskperHourColumnName
            ColumnPositions(.SVR) = ProgramSettings.SVRColumnName
            ColumnPositions(.SVRxIPH) = ProgramSettings.SVRxIPHColumnName
            ColumnPositions(.PriceTrend) = ProgramSettings.PriceTrendColumnName
            ColumnPositions(.TotalItemsSold) = ProgramSettings.TotalItemsSoldColumnName
            ColumnPositions(.TotalOrdersFilled) = ProgramSettings.TotalOrdersFilledColumnName
            ColumnPositions(.AvgItemsperOrder) = ProgramSettings.AvgItemsperOrderColumnName
            ColumnPositions(.CurrentSellOrders) = ProgramSettings.CurrentSellOrdersColumnName
            ColumnPositions(.CurrentBuyOrders) = ProgramSettings.CurrentBuyOrdersColumnName
            ColumnPositions(.ItemsinProduction) = ProgramSettings.ItemsinProductionColumnName
            ColumnPositions(.ItemsinStock) = ProgramSettings.ItemsinStockColumnName
            ColumnPositions(.MaterialCost) = ProgramSettings.MaterialCostColumnName
            ColumnPositions(.TotalCost) = ProgramSettings.TotalCostColumnName
            ColumnPositions(.BaseJobCost) = ProgramSettings.BaseJobCostColumnName
            ColumnPositions(.NumBPs) = ProgramSettings.NumBPsColumnName
            ColumnPositions(.InventionChance) = ProgramSettings.InventionChanceColumnName
            ColumnPositions(.BPType) = ProgramSettings.BPTypeColumnName
            ColumnPositions(.Race) = ProgramSettings.RaceColumnName
            ColumnPositions(.VolumeperItem) = ProgramSettings.VolumeperItemColumnName
            ColumnPositions(.TotalVolume) = ProgramSettings.TotalVolumeColumnName
            ColumnPositions(.SellExcess) = ProgramSettings.SellExcessColumnName
            ColumnPositions(.ROI) = ProgramSettings.ROIColumnName
            ColumnPositions(.PortionSize) = ProgramSettings.PortionSizeColumnName
            ColumnPositions(.ManufacturingJobFee) = ProgramSettings.ManufacturingJobFeeColumnName
            ColumnPositions(.ManufacturingFacilityName) = ProgramSettings.ManufacturingFacilityNameColumnName
            ColumnPositions(.ManufacturingFacilitySystem) = ProgramSettings.ManufacturingFacilitySystemColumnName
            ColumnPositions(.ManufacturingFacilityRegion) = ProgramSettings.ManufacturingFacilityRegionColumnName
            ColumnPositions(.ManufacturingFacilitySystemIndex) = ProgramSettings.ManufacturingFacilitySystemIndexColumnName
            ColumnPositions(.ManufacturingFacilityTax) = ProgramSettings.ManufacturingFacilityTaxColumnName
            ColumnPositions(.ManufacturingFacilityMEBonus) = ProgramSettings.ManufacturingFacilityMEBonusColumnName
            ColumnPositions(.ManufacturingFacilityTEBonus) = ProgramSettings.ManufacturingFacilityTEBonusColumnName
            ColumnPositions(.ManufacturingFacilityUsage) = ProgramSettings.ManufacturingFacilityUsageColumnName
            ColumnPositions(.ManufacturingFacilityFWSystemLevel) = ProgramSettings.ManufacturingFacilityFWSystemLevelColumnName
            ColumnPositions(.ComponentFacilityName) = ProgramSettings.ComponentFacilityNameColumnName
            ColumnPositions(.ComponentFacilitySystem) = ProgramSettings.ComponentFacilitySystemColumnName
            ColumnPositions(.ComponentFacilityRegion) = ProgramSettings.ComponentFacilityRegionColumnName
            ColumnPositions(.ComponentFacilitySystemIndex) = ProgramSettings.ComponentFacilitySystemIndexColumnName
            ColumnPositions(.ComponentFacilityTax) = ProgramSettings.ComponentFacilityTaxColumnName
            ColumnPositions(.ComponentFacilityMEBonus) = ProgramSettings.ComponentFacilityMEBonusColumnName
            ColumnPositions(.ComponentFacilityTEBonus) = ProgramSettings.ComponentFacilityTEBonusColumnName
            ColumnPositions(.ComponentFacilityUsage) = ProgramSettings.ComponentFacilityUsageColumnName
            ColumnPositions(.ComponentFacilityFWSystemLevel) = ProgramSettings.ComponentFacilityFWSystemLevelColumnName
            ColumnPositions(.CapComponentFacilityName) = ProgramSettings.CapComponentFacilityNameColumnName
            ColumnPositions(.CapComponentFacilitySystem) = ProgramSettings.CapComponentFacilitySystemColumnName
            ColumnPositions(.CapComponentFacilityRegion) = ProgramSettings.CapComponentFacilityRegionColumnName
            ColumnPositions(.CapComponentFacilitySystemIndex) = ProgramSettings.CapComponentFacilitySystemIndexColumnName
            ColumnPositions(.CapComponentFacilityTax) = ProgramSettings.CapComponentFacilityTaxColumnName
            ColumnPositions(.CapComponentFacilityMEBonus) = ProgramSettings.CapComponentFacilityMEBonusColumnName
            ColumnPositions(.CapComponentFacilityTEBonus) = ProgramSettings.CapComponentFacilityTEBonusColumnName
            ColumnPositions(.CapComponentFacilityUsage) = ProgramSettings.CapComponentFacilityUsageColumnName
            ColumnPositions(.CapComponentFacilityFWSystemLevel) = ProgramSettings.CapComponentFacilityFWSystemLevelColumnName
            ColumnPositions(.CopyingFacilityName) = ProgramSettings.CopyingFacilityNameColumnName
            ColumnPositions(.CopyingFacilitySystem) = ProgramSettings.CopyingFacilitySystemColumnName
            ColumnPositions(.CopyingFacilityRegion) = ProgramSettings.CopyingFacilityRegionColumnName
            ColumnPositions(.CopyingFacilitySystemIndex) = ProgramSettings.CopyingFacilitySystemIndexColumnName
            ColumnPositions(.CopyingFacilityTax) = ProgramSettings.CopyingFacilityTaxColumnName
            ColumnPositions(.CopyingFacilityMEBonus) = ProgramSettings.CopyingFacilityMEBonusColumnName
            ColumnPositions(.CopyingFacilityTEBonus) = ProgramSettings.CopyingFacilityTEBonusColumnName
            ColumnPositions(.CopyingFacilityUsage) = ProgramSettings.CopyingFacilityUsageColumnName
            ColumnPositions(.CopyingFacilityFWSystemLevel) = ProgramSettings.CopyingFacilityFWSystemLevelColumnName
            ColumnPositions(.InventionFacilityName) = ProgramSettings.InventionFacilityNameColumnName
            ColumnPositions(.InventionFacilitySystem) = ProgramSettings.InventionFacilitySystemColumnName
            ColumnPositions(.InventionFacilityRegion) = ProgramSettings.InventionFacilityRegionColumnName
            ColumnPositions(.InventionFacilitySystemIndex) = ProgramSettings.InventionFacilitySystemIndexColumnName
            ColumnPositions(.InventionFacilityTax) = ProgramSettings.InventionFacilityTaxColumnName
            ColumnPositions(.InventionFacilityMEBonus) = ProgramSettings.InventionFacilityMEBonusColumnName
            ColumnPositions(.InventionFacilityTEBonus) = ProgramSettings.InventionFacilityTEBonusColumnName
            ColumnPositions(.InventionFacilityUsage) = ProgramSettings.InventionFacilityUsageColumnName
            ColumnPositions(.InventionFacilityFWSystemLevel) = ProgramSettings.InventionFacilityFWSystemLevelColumnName
            ColumnPositions(.ReactionFacilityName) = ProgramSettings.ReactionFacilityNameColumnName
            ColumnPositions(.ReactionFacilitySystem) = ProgramSettings.ReactionFacilitySystemColumnName
            ColumnPositions(.ReactionFacilityRegion) = ProgramSettings.ReactionFacilityRegionColumnName
            ColumnPositions(.ReactionFacilitySystemIndex) = ProgramSettings.ReactionFacilitySystemIndexColumnName
            ColumnPositions(.ReactionFacilityTax) = ProgramSettings.ReactionFacilityTaxColumnName
            ColumnPositions(.ReactionFacilityMEBonus) = ProgramSettings.ReactionFacilityMEBonusColumnName
            ColumnPositions(.ReactionFacilityTEBonus) = ProgramSettings.ReactionFacilityTEBonusColumnName
            ColumnPositions(.ReactionFacilityUsage) = ProgramSettings.ReactionFacilityUsageColumnName
            ColumnPositions(.ReactionFacilityFWSystemLevel) = ProgramSettings.ReactionFacilityFWSystemLevelColumnName
            ColumnPositions(.ReprocessingFacilityName) = ProgramSettings.ReprocessingFacilityNameColumnName
            ColumnPositions(.ReprocessingFacilitySystem) = ProgramSettings.ReprocessingFacilitySystemColumnName
            ColumnPositions(.ReprocessingFacilityRegion) = ProgramSettings.ReprocessingFacilityRegionColumnName
            ColumnPositions(.ReprocessingFacilityTax) = ProgramSettings.ReprocessingFacilityTaxColumnName
            ColumnPositions(.ReprocessingFacilityUsage) = ProgramSettings.ReprocessingFacilityUsageColumnName
            ColumnPositions(.ReprocessingFacilityOreRefineRate) = ProgramSettings.ReprocessingFacilityOreRefineRateColumnName
            ColumnPositions(.ReprocessingFacilityIceRefineRate) = ProgramSettings.ReprocessingFacilityIceRefineRateColumnName
            ColumnPositions(.ReprocessingFacilityMoonRefineRate) = ProgramSettings.ReprocessingFacilityMoonRefineRateColumnName
        End With

        ' First column is always the ListID
        ColumnPositions(0) = "ListID"

    End Sub

    ' Returns the column Width for the sent column name
    Private Function GetColumnWidth(ColumnName As String) As Integer

        With UserManufacturingTabColumnSettings
            Select Case ColumnName
                Case ProgramSettings.ItemCategoryColumnName
                    Return .ItemCategoryWidth
                Case ProgramSettings.ItemGroupColumnName
                    Return .ItemGroupWidth
                Case ProgramSettings.ItemNameColumnName
                    Return .ItemNameWidth
                Case ProgramSettings.OwnedColumnName
                    Return .OwnedWidth
                Case ProgramSettings.TechColumnName
                    Return .TechWidth
                Case ProgramSettings.BPMEColumnName
                    Return .BPMEWidth
                Case ProgramSettings.BPTEColumnName
                    Return .BPTEWidth
                Case ProgramSettings.InputsColumnName
                    Return .InputsWidth
                Case ProgramSettings.ComparedColumnName
                    Return .ComparedWidth
                Case ProgramSettings.TotalRunsColumnName
                    Return .TotalRunsWidth
                Case ProgramSettings.SingleInventedBPCRunsColumnName
                    Return .SingleInventedBPCRunsWidth
                Case ProgramSettings.ProductionLinesColumnName
                    Return .ProductionLinesWidth
                Case ProgramSettings.LaboratoryLinesColumnName
                    Return .LaboratoryLinesWidth
                Case ProgramSettings.TotalInventionCostColumnName
                    Return .TotalInventionCostWidth
                Case ProgramSettings.TotalCopyCostColumnName
                    Return .TotalCopyCostWidth
                Case ProgramSettings.TaxesColumnName
                    Return .TaxesWidth
                Case ProgramSettings.BrokerFeesColumnName
                    Return .BrokerFeesWidth
                Case ProgramSettings.BPProductionTimeColumnName
                    Return .BPProductionTimeWidth
                Case ProgramSettings.TotalProductionTimeColumnName
                    Return .TotalProductionTimeWidth
                Case ProgramSettings.CopyTimeColumnName
                    Return .CopyTimeWidth
                Case ProgramSettings.InventionTimeColumnName
                    Return .InventionTimeWidth
                Case ProgramSettings.ItemMarketPriceColumnName
                    Return .ItemMarketPriceWidth
                Case ProgramSettings.ProfitColumnName
                    Return .ProfitWidth
                Case ProgramSettings.ProfitPercentageColumnName
                    Return .ProfitPercentageWidth
                Case ProgramSettings.IskperHourColumnName
                    Return .IskperHourWidth
                Case ProgramSettings.SVRColumnName
                    Return .SVRWidth
                Case ProgramSettings.SVRxIPHColumnName
                    Return .SVRxIPHWidth
                Case ProgramSettings.PriceTrendColumnName
                    Return .PriceTrendWidth
                Case ProgramSettings.TotalItemsSoldColumnName
                    Return .TotalItemsSoldWidth
                Case ProgramSettings.TotalOrdersFilledColumnName
                    Return .TotalOrdersFilledWidth
                Case ProgramSettings.AvgItemsperOrderColumnName
                    Return .AvgItemsperOrderWidth
                Case ProgramSettings.CurrentSellOrdersColumnName
                    Return .CurrentSellOrdersWidth
                Case ProgramSettings.CurrentBuyOrdersColumnName
                    Return .CurrentBuyOrdersWidth
                Case ProgramSettings.ItemsinProductionColumnName
                    Return .ItemsinProductionWidth
                Case ProgramSettings.ItemsinStockColumnName
                    Return .ItemsinStockWidth
                Case ProgramSettings.MaterialCostColumnName
                    Return .MaterialCostWidth
                Case ProgramSettings.TotalCostColumnName
                    Return .TotalCostWidth
                Case ProgramSettings.BaseJobCostColumnName
                    Return .BaseJobCostWidth
                Case ProgramSettings.NumBPsColumnName
                    Return .NumBPsWidth
                Case ProgramSettings.InventionChanceColumnName
                    Return .InventionChanceWidth
                Case ProgramSettings.BPTypeColumnName
                    Return .BPTypeWidth
                Case ProgramSettings.RaceColumnName
                    Return .RaceWidth
                Case ProgramSettings.VolumeperItemColumnName
                    Return .VolumeperItemWidth
                Case ProgramSettings.TotalVolumeColumnName
                    Return .TotalVolumeWidth
                Case ProgramSettings.SellExcessColumnName
                    Return .SellExcessWidth
                Case ProgramSettings.ROIColumnName
                    Return .ROIWidth
                Case ProgramSettings.PortionSizeColumnName
                    Return .PortionSizeWidth
                Case ProgramSettings.ManufacturingJobFeeColumnName
                    Return .ManufacturingJobFeeWidth
                Case ProgramSettings.ManufacturingFacilityNameColumnName
                    Return .ManufacturingFacilityNameWidth
                Case ProgramSettings.ManufacturingFacilitySystemColumnName
                    Return .ManufacturingFacilitySystemWidth
                Case ProgramSettings.ManufacturingFacilityRegionColumnName
                    Return .ManufacturingFacilityRegionWidth
                Case ProgramSettings.ManufacturingFacilitySystemIndexColumnName
                    Return .ManufacturingFacilitySystemIndexWidth
                Case ProgramSettings.ManufacturingFacilityTaxColumnName
                    Return .ManufacturingFacilityTaxWidth
                Case ProgramSettings.ManufacturingFacilityMEBonusColumnName
                    Return .ManufacturingFacilityMEBonusWidth
                Case ProgramSettings.ManufacturingFacilityTEBonusColumnName
                    Return .ManufacturingFacilityTEBonusWidth
                Case ProgramSettings.ManufacturingFacilityUsageColumnName
                    Return .ManufacturingFacilityUsageWidth
                Case ProgramSettings.ManufacturingFacilityFWSystemLevelColumnName
                    Return .ManufacturingFacilityFWSystemLevelWidth
                Case ProgramSettings.ComponentFacilityNameColumnName
                    Return .ComponentFacilityNameWidth
                Case ProgramSettings.ComponentFacilitySystemColumnName
                    Return .ComponentFacilitySystemWidth
                Case ProgramSettings.ComponentFacilityRegionColumnName
                    Return .ComponentFacilityRegionWidth
                Case ProgramSettings.ComponentFacilitySystemIndexColumnName
                    Return .ComponentFacilitySystemIndexWidth
                Case ProgramSettings.ComponentFacilityTaxColumnName
                    Return .ComponentFacilityTaxWidth
                Case ProgramSettings.ComponentFacilityMEBonusColumnName
                    Return .ComponentFacilityMEBonusWidth
                Case ProgramSettings.ComponentFacilityTEBonusColumnName
                    Return .ComponentFacilityTEBonusWidth
                Case ProgramSettings.ComponentFacilityUsageColumnName
                    Return .ComponentFacilityUsageWidth
                Case ProgramSettings.ComponentFacilityFWSystemLevelColumnName
                    Return .ComponentFacilityFWSystemLevelWidth
                Case ProgramSettings.CapComponentFacilityNameColumnName
                    Return .CapComponentFacilityNameWidth
                Case ProgramSettings.CapComponentFacilitySystemColumnName
                    Return .CapComponentFacilitySystemWidth
                Case ProgramSettings.CapComponentFacilityRegionColumnName
                    Return .CapComponentFacilityRegionWidth
                Case ProgramSettings.CapComponentFacilitySystemIndexColumnName
                    Return .CapComponentFacilitySystemIndexWidth
                Case ProgramSettings.CapComponentFacilityTaxColumnName
                    Return .CapComponentFacilityTaxWidth
                Case ProgramSettings.CapComponentFacilityMEBonusColumnName
                    Return .CapComponentFacilityMEBonusWidth
                Case ProgramSettings.CapComponentFacilityTEBonusColumnName
                    Return .CapComponentFacilityTEBonusWidth
                Case ProgramSettings.CapComponentFacilityUsageColumnName
                    Return .CapComponentFacilityUsageWidth
                Case ProgramSettings.CapComponentFacilityFWSystemLevelColumnName
                    Return .CapComponentFacilityFWSystemLevelWidth
                Case ProgramSettings.CopyingFacilityNameColumnName
                    Return .CopyingFacilityNameWidth
                Case ProgramSettings.CopyingFacilitySystemColumnName
                    Return .CopyingFacilitySystemWidth
                Case ProgramSettings.CopyingFacilityRegionColumnName
                    Return .CopyingFacilityRegionWidth
                Case ProgramSettings.CopyingFacilitySystemIndexColumnName
                    Return .CopyingFacilitySystemIndexWidth
                Case ProgramSettings.CopyingFacilityTaxColumnName
                    Return .CopyingFacilityTaxWidth
                Case ProgramSettings.CopyingFacilityMEBonusColumnName
                    Return .CopyingFacilityMEBonusWidth
                Case ProgramSettings.CopyingFacilityTEBonusColumnName
                    Return .CopyingFacilityTEBonusWidth
                Case ProgramSettings.CopyingFacilityUsageColumnName
                    Return .CopyingFacilityUsageWidth
                Case ProgramSettings.CopyingFacilityFWSystemLevelColumnName
                    Return .CopyingFacilityFWSystemLevelWidth
                Case ProgramSettings.InventionFacilityNameColumnName
                    Return .InventionFacilityNameWidth
                Case ProgramSettings.InventionFacilitySystemColumnName
                    Return .InventionFacilitySystemWidth
                Case ProgramSettings.InventionFacilityRegionColumnName
                    Return .InventionFacilityRegionWidth
                Case ProgramSettings.InventionFacilitySystemIndexColumnName
                    Return .InventionFacilitySystemIndexWidth
                Case ProgramSettings.InventionFacilityTaxColumnName
                    Return .InventionFacilityTaxWidth
                Case ProgramSettings.InventionFacilityMEBonusColumnName
                    Return .InventionFacilityMEBonusWidth
                Case ProgramSettings.InventionFacilityTEBonusColumnName
                    Return .InventionFacilityTEBonusWidth
                Case ProgramSettings.InventionFacilityUsageColumnName
                    Return .InventionFacilityUsageWidth
                Case ProgramSettings.InventionFacilityFWSystemLevelColumnName
                    Return .InventionFacilityFWSystemLevelWidth
                Case ProgramSettings.ReactionFacilityNameColumnName
                    Return .ReactionFacilityNameWidth
                Case ProgramSettings.ReactionFacilitySystemColumnName
                    Return .ReactionFacilitySystemWidth
                Case ProgramSettings.ReactionFacilityRegionColumnName
                    Return .ReactionFacilityRegionWidth
                Case ProgramSettings.ReactionFacilitySystemIndexColumnName
                    Return .ReactionFacilitySystemIndexWidth
                Case ProgramSettings.ReactionFacilityTaxColumnName
                    Return .ReactionFacilityTaxWidth
                Case ProgramSettings.ReactionFacilityMEBonusColumnName
                    Return .ReactionFacilityMEBonusWidth
                Case ProgramSettings.ReactionFacilityTEBonusColumnName
                    Return .ReactionFacilityTEBonusWidth
                Case ProgramSettings.ReactionFacilityUsageColumnName
                    Return .ReactionFacilityUsageWidth
                Case ProgramSettings.ReactionFacilityFWSystemLevelColumnName
                    Return .ReactionFacilityFWSystemLevelWidth
                Case ProgramSettings.ReprocessingFacilityNameColumnName
                    Return .ReprocessingFacilityNameWidth
                Case ProgramSettings.ReprocessingFacilitySystemColumnName
                    Return .ReprocessingFacilitySystemWidth
                Case ProgramSettings.ReprocessingFacilityRegionColumnName
                    Return .ReprocessingFacilityRegionWidth
                Case ProgramSettings.ReprocessingFacilityTaxColumnName
                    Return .ReprocessingFacilityTaxWidth
                Case ProgramSettings.ReprocessingFacilityUsageColumnName
                    Return .ReprocessingFacilityUsageWidth
                Case ProgramSettings.ReprocessingFacilityOreRefineRateColumnName
                    Return .ReprocessingFacilityOreRefineRateWidth
                Case ProgramSettings.ReprocessingFacilityIceRefineRateColumnName
                    Return .ReprocessingFacilityIceRefineRateWidth
                Case ProgramSettings.ReprocessingFacilityMoonRefineRateColumnName
                    Return .ReprocessingFacilityMoonRefineRateWidth
                Case Else
                    Return 0
            End Select
        End With

    End Function

    ' Updates the column order when changed
    Private Sub lstManufacturing_ColumnReordered(sender As Object, e As System.Windows.Forms.ColumnReorderedEventArgs) Handles lstManufacturing.ColumnReordered
        Dim TempArray(NumManufacturingTabColumns) As String
        Dim Minus1 As Boolean = False

        e.Cancel = True ' Cancel the event so we can manually update the grid columns

        For i = 0 To NumManufacturingTabColumns
            TempArray(i) = ""
        Next

        ' First index is the ListID
        TempArray(0) = "ListID"

        If e.OldDisplayIndex > e.NewDisplayIndex Then
            ' For all indices larger than the new index, need to move it to the next array
            For i = 1 To e.NewDisplayIndex - 1
                TempArray(i) = ColumnPositions(i)
            Next

            ' Insert the new column
            TempArray(e.NewDisplayIndex) = ColumnPositions(e.OldDisplayIndex)

            ' Move all the rest of the items up one
            For i = e.NewDisplayIndex + 1 To TempArray.Count - 1
                If i < e.OldDisplayIndex + 1 Then
                    TempArray(i) = ColumnPositions(i - 1)
                Else
                    TempArray(i) = ColumnPositions(i)
                End If
            Next
        Else
            ' For all indices larger than the new index, need to move it to the next array
            For i = 1 To e.OldDisplayIndex - 1
                TempArray(i) = ColumnPositions(i)
            Next

            ' Insert the new column
            TempArray(e.NewDisplayIndex) = ColumnPositions(e.OldDisplayIndex)

            ' Back fill the array between the column we moved and the new location
            For i = e.OldDisplayIndex To e.NewDisplayIndex - 1
                TempArray(i) = ColumnPositions(i + 1)
            Next

            ' Replace all the items left
            For i = e.NewDisplayIndex + 1 To TempArray.Count - 1
                TempArray(i) = ColumnPositions(i)
            Next

        End If

        ColumnPositions = TempArray

        ' Save the columns based on the current order
        With UserManufacturingTabColumnSettings
            For i = 1 To ColumnPositions.Count - 1
                Select Case ColumnPositions(i)
                    Case ProgramSettings.ItemCategoryColumnName
                        .ItemCategory = i
                    Case ProgramSettings.ItemGroupColumnName
                        .ItemGroup = i
                    Case ProgramSettings.ItemNameColumnName
                        .ItemName = i
                    Case ProgramSettings.OwnedColumnName
                        .Owned = i
                    Case ProgramSettings.TechColumnName
                        .Tech = i
                    Case ProgramSettings.BPMEColumnName
                        .BPME = i
                    Case ProgramSettings.BPTEColumnName
                        .BPTE = i
                    Case ProgramSettings.InputsColumnName
                        .Inputs = i
                    Case ProgramSettings.ComparedColumnName
                        .Compared = i
                    Case ProgramSettings.TotalRunsColumnName
                        .TotalRuns = i
                    Case ProgramSettings.SingleInventedBPCRunsColumnName
                        .SingleInventedBPCRuns = i
                    Case ProgramSettings.ProductionLinesColumnName
                        .ProductionLines = i
                    Case ProgramSettings.LaboratoryLinesColumnName
                        .LaboratoryLines = i
                    Case ProgramSettings.TotalInventionCostColumnName
                        .TotalInventionCost = i
                    Case ProgramSettings.TotalCopyCostColumnName
                        .TotalCopyCost = i
                    Case ProgramSettings.TaxesColumnName
                        .Taxes = i
                    Case ProgramSettings.BrokerFeesColumnName
                        .BrokerFees = i
                    Case ProgramSettings.BPProductionTimeColumnName
                        .BPProductionTime = i
                    Case ProgramSettings.TotalProductionTimeColumnName
                        .TotalProductionTime = i
                    Case ProgramSettings.CopyTimeColumnName
                        .CopyTime = i
                    Case ProgramSettings.InventionTimeColumnName
                        .InventionTime = i
                    Case ProgramSettings.ItemMarketPriceColumnName
                        .ItemMarketPrice = i
                    Case ProgramSettings.ProfitColumnName
                        .Profit = i
                    Case ProgramSettings.ProfitPercentageColumnName
                        .ProfitPercentage = i
                    Case ProgramSettings.IskperHourColumnName
                        .IskperHour = i
                    Case ProgramSettings.SVRColumnName
                        .SVR = i
                    Case ProgramSettings.SVRxIPHColumnName
                        .SVRxIPH = i
                    Case ProgramSettings.PriceTrendColumnName
                        .PriceTrend = i
                    Case ProgramSettings.TotalItemsSoldColumnName
                        .TotalItemsSold = i
                    Case ProgramSettings.TotalOrdersFilledColumnName
                        .TotalOrdersFilled = i
                    Case ProgramSettings.AvgItemsperOrderColumnName
                        .AvgItemsperOrder = i
                    Case ProgramSettings.CurrentSellOrdersColumnName
                        .CurrentSellOrders = i
                    Case ProgramSettings.CurrentBuyOrdersColumnName
                        .CurrentBuyOrders = i
                    Case ProgramSettings.ItemsinProductionColumnName
                        .ItemsinProduction = i
                    Case ProgramSettings.ItemsinStockColumnName
                        .ItemsinStock = i
                    Case ProgramSettings.MaterialCostColumnName
                        .MaterialCost = i
                    Case ProgramSettings.TotalCostColumnName
                        .TotalCost = i
                    Case ProgramSettings.BaseJobCostColumnName
                        .BaseJobCost = i
                    Case ProgramSettings.NumBPsColumnName
                        .NumBPs = i
                    Case ProgramSettings.InventionChanceColumnName
                        .InventionChance = i
                    Case ProgramSettings.BPTypeColumnName
                        .BPType = i
                    Case ProgramSettings.RaceColumnName
                        .Race = i
                    Case ProgramSettings.VolumeperItemColumnName
                        .VolumeperItem = i
                    Case ProgramSettings.TotalVolumeColumnName
                        .TotalVolume = i
                    Case ProgramSettings.SellExcessColumnName
                        .SellExcess = i
                    Case ProgramSettings.ROIColumnName
                        .ROI = i
                    Case ProgramSettings.PortionSizeColumnName
                        .PortionSize = i
                    Case ProgramSettings.ManufacturingJobFeeColumnName
                        .ManufacturingJobFee = i
                    Case ProgramSettings.ManufacturingFacilityNameColumnName
                        .ManufacturingFacilityName = i
                    Case ProgramSettings.ManufacturingFacilitySystemColumnName
                        .ManufacturingFacilitySystem = i
                    Case ProgramSettings.ManufacturingFacilityRegionColumnName
                        .ManufacturingFacilityRegion = i
                    Case ProgramSettings.ManufacturingFacilitySystemIndexColumnName
                        .ManufacturingFacilitySystemIndex = i
                    Case ProgramSettings.ManufacturingFacilityTaxColumnName
                        .ManufacturingFacilityTax = i
                    Case ProgramSettings.ManufacturingFacilityMEBonusColumnName
                        .ManufacturingFacilityMEBonus = i
                    Case ProgramSettings.ManufacturingFacilityTEBonusColumnName
                        .ManufacturingFacilityTEBonus = i
                    Case ProgramSettings.ManufacturingFacilityUsageColumnName
                        .ManufacturingFacilityUsage = i
                    Case ProgramSettings.ManufacturingFacilityFWSystemLevelColumnName
                        .ManufacturingFacilityFWSystemLevel = i
                    Case ProgramSettings.ComponentFacilityNameColumnName
                        .ComponentFacilityName = i
                    Case ProgramSettings.ComponentFacilitySystemColumnName
                        .ComponentFacilitySystem = i
                    Case ProgramSettings.ComponentFacilityRegionColumnName
                        .ComponentFacilityRegion = i
                    Case ProgramSettings.ComponentFacilitySystemIndexColumnName
                        .ComponentFacilitySystemIndex = i
                    Case ProgramSettings.ComponentFacilityTaxColumnName
                        .ComponentFacilityTax = i
                    Case ProgramSettings.ComponentFacilityMEBonusColumnName
                        .ComponentFacilityMEBonus = i
                    Case ProgramSettings.ComponentFacilityTEBonusColumnName
                        .ComponentFacilityTEBonus = i
                    Case ProgramSettings.ComponentFacilityUsageColumnName
                        .ComponentFacilityUsage = i
                    Case ProgramSettings.ComponentFacilityFWSystemLevelColumnName
                        .ComponentFacilityFWSystemLevel = i
                    Case ProgramSettings.CapComponentFacilityNameColumnName
                        .CapComponentFacilityName = i
                    Case ProgramSettings.CapComponentFacilitySystemColumnName
                        .CapComponentFacilitySystem = i
                    Case ProgramSettings.CapComponentFacilityRegionColumnName
                        .CapComponentFacilityRegion = i
                    Case ProgramSettings.CapComponentFacilitySystemIndexColumnName
                        .CapComponentFacilitySystemIndex = i
                    Case ProgramSettings.CapComponentFacilityTaxColumnName
                        .CapComponentFacilityTax = i
                    Case ProgramSettings.CapComponentFacilityMEBonusColumnName
                        .CapComponentFacilityMEBonus = i
                    Case ProgramSettings.CapComponentFacilityTEBonusColumnName
                        .CapComponentFacilityTEBonus = i
                    Case ProgramSettings.CapComponentFacilityUsageColumnName
                        .CapComponentFacilityUsage = i
                    Case ProgramSettings.CapComponentFacilityFWSystemLevelColumnName
                        .CapComponentFacilityFWSystemLevel = i
                    Case ProgramSettings.CopyingFacilityNameColumnName
                        .CopyingFacilityName = i
                    Case ProgramSettings.CopyingFacilitySystemColumnName
                        .CopyingFacilitySystem = i
                    Case ProgramSettings.CopyingFacilityRegionColumnName
                        .CopyingFacilityRegion = i
                    Case ProgramSettings.CopyingFacilitySystemIndexColumnName
                        .CopyingFacilitySystemIndex = i
                    Case ProgramSettings.CopyingFacilityTaxColumnName
                        .CopyingFacilityTax = i
                    Case ProgramSettings.CopyingFacilityMEBonusColumnName
                        .CopyingFacilityMEBonus = i
                    Case ProgramSettings.CopyingFacilityTEBonusColumnName
                        .CopyingFacilityTEBonus = i
                    Case ProgramSettings.CopyingFacilityUsageColumnName
                        .CopyingFacilityUsage = i
                    Case ProgramSettings.CopyingFacilityFWSystemLevelColumnName
                        .CopyingFacilityFWSystemLevel = i
                    Case ProgramSettings.InventionFacilityNameColumnName
                        .InventionFacilityName = i
                    Case ProgramSettings.InventionFacilitySystemColumnName
                        .InventionFacilitySystem = i
                    Case ProgramSettings.InventionFacilityRegionColumnName
                        .InventionFacilityRegion = i
                    Case ProgramSettings.InventionFacilitySystemIndexColumnName
                        .InventionFacilitySystemIndex = i
                    Case ProgramSettings.InventionFacilityTaxColumnName
                        .InventionFacilityTax = i
                    Case ProgramSettings.InventionFacilityMEBonusColumnName
                        .InventionFacilityMEBonus = i
                    Case ProgramSettings.InventionFacilityTEBonusColumnName
                        .InventionFacilityTEBonus = i
                    Case ProgramSettings.InventionFacilityUsageColumnName
                        .InventionFacilityUsage = i
                    Case ProgramSettings.InventionFacilityFWSystemLevelColumnName
                        .InventionFacilityFWSystemLevel = i
                    Case ProgramSettings.ReactionFacilityNameColumnName
                        .ReactionFacilityName = i
                    Case ProgramSettings.ReactionFacilitySystemColumnName
                        .ReactionFacilitySystem = i
                    Case ProgramSettings.ReactionFacilityRegionColumnName
                        .ReactionFacilityRegion = i
                    Case ProgramSettings.ReactionFacilitySystemIndexColumnName
                        .ReactionFacilitySystemIndex = i
                    Case ProgramSettings.ReactionFacilityTaxColumnName
                        .ReactionFacilityTax = i
                    Case ProgramSettings.ReactionFacilityMEBonusColumnName
                        .ReactionFacilityMEBonus = i
                    Case ProgramSettings.ReactionFacilityTEBonusColumnName
                        .ReactionFacilityTEBonus = i
                    Case ProgramSettings.ReactionFacilityUsageColumnName
                        .ReactionFacilityUsage = i
                    Case ProgramSettings.ReactionFacilityFWSystemLevelColumnName
                        .ReactionFacilityFWSystemLevel = i
                    Case ProgramSettings.ReprocessingFacilityNameColumnName
                        .ReprocessingFacilityName = i
                    Case ProgramSettings.ReprocessingFacilitySystemColumnName
                        .ReprocessingFacilitySystem = i
                    Case ProgramSettings.ReprocessingFacilityRegionColumnName
                        .ReprocessingFacilityRegion = i
                    Case ProgramSettings.ReprocessingFacilityTaxColumnName
                        .ReprocessingFacilityTax = i
                    Case ProgramSettings.ReprocessingFacilityUsageColumnName
                        .ReprocessingFacilityUsage = i
                    Case ProgramSettings.ReprocessingFacilityOreRefineRateColumnName
                        .ReprocessingFacilityOreRefineRate = i
                    Case ProgramSettings.ReprocessingFacilityIceRefineRateColumnName
                        .ReprocessingFacilityIceRefineRate = i
                    Case ProgramSettings.ReprocessingFacilityMoonRefineRateColumnName
                        .ReprocessingFacilityMoonRefineRate = i
                End Select
            Next
        End With

        ' Now Refresh the grid
        If lstManufacturing.Items.Count <> 0 Then
            RefreshCalcData = True
            Call DisplayManufacturingResults(False)
        Else
            Call RefreshManufacturingTabColumns()
        End If

    End Sub

    ' Updates the column sizes when changed
    Private Sub lstManufacturing_ColumnWidthChanged(sender As Object, e As System.Windows.Forms.ColumnWidthChangedEventArgs) Handles lstManufacturing.ColumnWidthChanged
        Dim NewWidth As Integer = lstManufacturing.Columns(e.ColumnIndex).Width

        If Not AddingColumns Then
            With UserManufacturingTabColumnSettings
                Select Case ColumnPositions(e.ColumnIndex)
                    Case ProgramSettings.ItemCategoryColumnName
                        .ItemCategoryWidth = NewWidth
                    Case ProgramSettings.ItemGroupColumnName
                        .ItemGroupWidth = NewWidth
                    Case ProgramSettings.ItemNameColumnName
                        .ItemNameWidth = NewWidth
                    Case ProgramSettings.OwnedColumnName
                        .OwnedWidth = NewWidth
                    Case ProgramSettings.TechColumnName
                        .TechWidth = NewWidth
                    Case ProgramSettings.BPMEColumnName
                        .BPMEWidth = NewWidth
                    Case ProgramSettings.BPTEColumnName
                        .BPTEWidth = NewWidth
                    Case ProgramSettings.InputsColumnName
                        .InputsWidth = NewWidth
                    Case ProgramSettings.ComparedColumnName
                        .ComparedWidth = NewWidth
                    Case ProgramSettings.TotalRunsColumnName
                        .TotalRunsWidth = NewWidth
                    Case ProgramSettings.SingleInventedBPCRunsColumnName
                        .SingleInventedBPCRunsWidth = NewWidth
                    Case ProgramSettings.ProductionLinesColumnName
                        .ProductionLinesWidth = NewWidth
                    Case ProgramSettings.LaboratoryLinesColumnName
                        .LaboratoryLinesWidth = NewWidth
                    Case ProgramSettings.TotalInventionCostColumnName
                        .TotalInventionCostWidth = NewWidth
                    Case ProgramSettings.TotalCopyCostColumnName
                        .TotalCopyCostWidth = NewWidth
                    Case ProgramSettings.TaxesColumnName
                        .TaxesWidth = NewWidth
                    Case ProgramSettings.BrokerFeesColumnName
                        .BrokerFeesWidth = NewWidth
                    Case ProgramSettings.BPProductionTimeColumnName
                        .BPProductionTimeWidth = NewWidth
                    Case ProgramSettings.TotalProductionTimeColumnName
                        .TotalProductionTimeWidth = NewWidth
                    Case ProgramSettings.CopyTimeColumnName
                        .CopyTimeWidth = NewWidth
                    Case ProgramSettings.InventionTimeColumnName
                        .InventionTimeWidth = NewWidth
                    Case ProgramSettings.ItemMarketPriceColumnName
                        .ItemMarketPriceWidth = NewWidth
                    Case ProgramSettings.ProfitColumnName
                        .ProfitWidth = NewWidth
                    Case ProgramSettings.ProfitPercentageColumnName
                        .ProfitPercentageWidth = NewWidth
                    Case ProgramSettings.IskperHourColumnName
                        .IskperHourWidth = NewWidth
                    Case ProgramSettings.SVRColumnName
                        .SVRWidth = NewWidth
                    Case ProgramSettings.SVRxIPHColumnName
                        .SVRxIPHWidth = NewWidth
                    Case ProgramSettings.PriceTrendColumnName
                        .PriceTrendWidth = NewWidth
                    Case ProgramSettings.TotalItemsSoldColumnName
                        .TotalItemsSoldWidth = NewWidth
                    Case ProgramSettings.TotalOrdersFilledColumnName
                        .TotalOrdersFilledWidth = NewWidth
                    Case ProgramSettings.AvgItemsperOrderColumnName
                        .AvgItemsperOrderWidth = NewWidth
                    Case ProgramSettings.CurrentSellOrdersColumnName
                        .CurrentSellOrdersWidth = NewWidth
                    Case ProgramSettings.CurrentBuyOrdersColumnName
                        .CurrentBuyOrdersWidth = NewWidth
                    Case ProgramSettings.ItemsinProductionColumnName
                        .ItemsinProductionWidth = NewWidth
                    Case ProgramSettings.ItemsinStockColumnName
                        .ItemsinStockWidth = NewWidth
                    Case ProgramSettings.MaterialCostColumnName
                        .MaterialCostWidth = NewWidth
                    Case ProgramSettings.TotalCostColumnName
                        .TotalCostWidth = NewWidth
                    Case ProgramSettings.BaseJobCostColumnName
                        .BaseJobCostWidth = NewWidth
                    Case ProgramSettings.NumBPsColumnName
                        .NumBPsWidth = NewWidth
                    Case ProgramSettings.InventionChanceColumnName
                        .InventionChanceWidth = NewWidth
                    Case ProgramSettings.BPTypeColumnName
                        .BPTypeWidth = NewWidth
                    Case ProgramSettings.RaceColumnName
                        .RaceWidth = NewWidth
                    Case ProgramSettings.VolumeperItemColumnName
                        .VolumeperItemWidth = NewWidth
                    Case ProgramSettings.TotalVolumeColumnName
                        .TotalVolumeWidth = NewWidth
                    Case ProgramSettings.SellExcessColumnName
                        .SellExcessWidth = NewWidth
                    Case ProgramSettings.ROIColumnName
                        .ROIWidth = NewWidth
                    Case ProgramSettings.PortionSizeColumnName
                        .PortionSizeWidth = NewWidth
                    Case ProgramSettings.ManufacturingJobFeeColumnName
                        .ManufacturingJobFeeWidth = NewWidth
                    Case ProgramSettings.ManufacturingFacilityNameColumnName
                        .ManufacturingFacilityNameWidth = NewWidth
                    Case ProgramSettings.ManufacturingFacilitySystemColumnName
                        .ManufacturingFacilitySystemWidth = NewWidth
                    Case ProgramSettings.ManufacturingFacilityRegionColumnName
                        .ManufacturingFacilityRegionWidth = NewWidth
                    Case ProgramSettings.ManufacturingFacilitySystemIndexColumnName
                        .ManufacturingFacilitySystemIndexWidth = NewWidth
                    Case ProgramSettings.ManufacturingFacilityTaxColumnName
                        .ManufacturingFacilityTaxWidth = NewWidth
                    Case ProgramSettings.ManufacturingFacilityMEBonusColumnName
                        .ManufacturingFacilityMEBonusWidth = NewWidth
                    Case ProgramSettings.ManufacturingFacilityTEBonusColumnName
                        .ManufacturingFacilityTEBonusWidth = NewWidth
                    Case ProgramSettings.ManufacturingFacilityUsageColumnName
                        .ManufacturingFacilityUsageWidth = NewWidth
                    Case ProgramSettings.ManufacturingFacilityFWSystemLevelColumnName
                        .ManufacturingFacilityFWSystemLevelWidth = NewWidth
                    Case ProgramSettings.ComponentFacilityNameColumnName
                        .ComponentFacilityNameWidth = NewWidth
                    Case ProgramSettings.ComponentFacilitySystemColumnName
                        .ComponentFacilitySystemWidth = NewWidth
                    Case ProgramSettings.ComponentFacilityRegionColumnName
                        .ComponentFacilityRegionWidth = NewWidth
                    Case ProgramSettings.ComponentFacilitySystemIndexColumnName
                        .ComponentFacilitySystemIndexWidth = NewWidth
                    Case ProgramSettings.ComponentFacilityTaxColumnName
                        .ComponentFacilityTaxWidth = NewWidth
                    Case ProgramSettings.ComponentFacilityMEBonusColumnName
                        .ComponentFacilityMEBonusWidth = NewWidth
                    Case ProgramSettings.ComponentFacilityTEBonusColumnName
                        .ComponentFacilityTEBonusWidth = NewWidth
                    Case ProgramSettings.ComponentFacilityUsageColumnName
                        .ComponentFacilityUsageWidth = NewWidth
                    Case ProgramSettings.ComponentFacilityFWSystemLevelColumnName
                        .ComponentFacilityFWSystemLevelWidth = NewWidth
                    Case ProgramSettings.CapComponentFacilityNameColumnName
                        .CapComponentFacilityNameWidth = NewWidth
                    Case ProgramSettings.CapComponentFacilitySystemColumnName
                        .CapComponentFacilitySystemWidth = NewWidth
                    Case ProgramSettings.CapComponentFacilityRegionColumnName
                        .CapComponentFacilityRegionWidth = NewWidth
                    Case ProgramSettings.CapComponentFacilitySystemIndexColumnName
                        .CapComponentFacilitySystemIndexWidth = NewWidth
                    Case ProgramSettings.CapComponentFacilityTaxColumnName
                        .CapComponentFacilityTaxWidth = NewWidth
                    Case ProgramSettings.CapComponentFacilityMEBonusColumnName
                        .CapComponentFacilityMEBonusWidth = NewWidth
                    Case ProgramSettings.CapComponentFacilityTEBonusColumnName
                        .CapComponentFacilityTEBonusWidth = NewWidth
                    Case ProgramSettings.CapComponentFacilityUsageColumnName
                        .CapComponentFacilityUsageWidth = NewWidth
                    Case ProgramSettings.CapComponentFacilityFWSystemLevelColumnName
                        .CapComponentFacilityFWSystemLevelWidth = NewWidth
                    Case ProgramSettings.CopyingFacilityNameColumnName
                        .CopyingFacilityNameWidth = NewWidth
                    Case ProgramSettings.CopyingFacilitySystemColumnName
                        .CopyingFacilitySystemWidth = NewWidth
                    Case ProgramSettings.CopyingFacilityRegionColumnName
                        .CopyingFacilityRegionWidth = NewWidth
                    Case ProgramSettings.CopyingFacilitySystemIndexColumnName
                        .CopyingFacilitySystemIndexWidth = NewWidth
                    Case ProgramSettings.CopyingFacilityTaxColumnName
                        .CopyingFacilityTaxWidth = NewWidth
                    Case ProgramSettings.CopyingFacilityMEBonusColumnName
                        .CopyingFacilityMEBonusWidth = NewWidth
                    Case ProgramSettings.CopyingFacilityTEBonusColumnName
                        .CopyingFacilityTEBonusWidth = NewWidth
                    Case ProgramSettings.CopyingFacilityUsageColumnName
                        .CopyingFacilityUsageWidth = NewWidth
                    Case ProgramSettings.CopyingFacilityFWSystemLevelColumnName
                        .CopyingFacilityFWSystemLevelWidth = NewWidth
                    Case ProgramSettings.InventionFacilityNameColumnName
                        .InventionFacilityNameWidth = NewWidth
                    Case ProgramSettings.InventionFacilitySystemColumnName
                        .InventionFacilitySystemWidth = NewWidth
                    Case ProgramSettings.InventionFacilityRegionColumnName
                        .InventionFacilityRegionWidth = NewWidth
                    Case ProgramSettings.InventionFacilitySystemIndexColumnName
                        .InventionFacilitySystemIndexWidth = NewWidth
                    Case ProgramSettings.InventionFacilityTaxColumnName
                        .InventionFacilityTaxWidth = NewWidth
                    Case ProgramSettings.InventionFacilityMEBonusColumnName
                        .InventionFacilityMEBonusWidth = NewWidth
                    Case ProgramSettings.InventionFacilityTEBonusColumnName
                        .InventionFacilityTEBonusWidth = NewWidth
                    Case ProgramSettings.InventionFacilityUsageColumnName
                        .InventionFacilityUsageWidth = NewWidth
                    Case ProgramSettings.InventionFacilityFWSystemLevelColumnName
                        .InventionFacilityFWSystemLevelWidth = NewWidth
                    Case ProgramSettings.ReactionFacilityNameColumnName
                        .ReactionFacilityNameWidth = NewWidth
                    Case ProgramSettings.ReactionFacilitySystemColumnName
                        .ReactionFacilitySystemWidth = NewWidth
                    Case ProgramSettings.ReactionFacilityRegionColumnName
                        .ReactionFacilityRegionWidth = NewWidth
                    Case ProgramSettings.ReactionFacilitySystemIndexColumnName
                        .ReactionFacilitySystemIndexWidth = NewWidth
                    Case ProgramSettings.ReactionFacilityTaxColumnName
                        .ReactionFacilityTaxWidth = NewWidth
                    Case ProgramSettings.ReactionFacilityMEBonusColumnName
                        .ReactionFacilityMEBonusWidth = NewWidth
                    Case ProgramSettings.ReactionFacilityTEBonusColumnName
                        .ReactionFacilityTEBonusWidth = NewWidth
                    Case ProgramSettings.ReactionFacilityUsageColumnName
                        .ReactionFacilityUsageWidth = NewWidth
                    Case ProgramSettings.ReactionFacilityFWSystemLevelColumnName
                        .ReactionFacilityFWSystemLevelWidth = NewWidth
                    Case ProgramSettings.ReprocessingFacilityNameColumnName
                        .ReprocessingFacilityNameWidth = NewWidth
                    Case ProgramSettings.ReprocessingFacilitySystemColumnName
                        .ReprocessingFacilitySystemWidth = NewWidth
                    Case ProgramSettings.ReprocessingFacilityRegionColumnName
                        .ReprocessingFacilityRegionWidth = NewWidth
                    Case ProgramSettings.ReprocessingFacilityTaxColumnName
                        .ReprocessingFacilityTaxWidth = NewWidth
                    Case ProgramSettings.ReprocessingFacilityUsageColumnName
                        .ReprocessingFacilityUsageWidth = NewWidth
                    Case ProgramSettings.ReprocessingFacilityOreRefineRateColumnName
                        .ReprocessingFacilityOreRefineRateWidth = NewWidth
                    Case ProgramSettings.ReprocessingFacilityIceRefineRateColumnName
                        .ReprocessingFacilityIceRefineRateWidth = NewWidth
                    Case ProgramSettings.ReprocessingFacilityMoonRefineRateColumnName
                        .ReprocessingFacilityMoonRefineRateWidth = NewWidth
                End Select
            End With
        End If

    End Sub

    ' Determines if we display the sent column
    Private Function ShowColumn(ColumnName As String) As Boolean
        If Array.IndexOf(ColumnPositions, ColumnName) <> -1 Then
            Return True
        Else
            Return False
        End If
    End Function

    ' Returns the allignment for the column name sent
    Private Function GetColumnAlignment(ColumnName As String) As HorizontalAlignment

        Select Case ColumnName
            Case ProgramSettings.ItemCategoryColumnName
                Return HorizontalAlignment.Left
            Case ProgramSettings.ItemGroupColumnName
                Return HorizontalAlignment.Left
            Case ProgramSettings.ItemNameColumnName
                Return HorizontalAlignment.Left
            Case ProgramSettings.OwnedColumnName
                Return HorizontalAlignment.Left
            Case ProgramSettings.TechColumnName
                Return HorizontalAlignment.Left
            Case ProgramSettings.BPMEColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.BPTEColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.InputsColumnName
                Return HorizontalAlignment.Left
            Case ProgramSettings.ComparedColumnName
                Return HorizontalAlignment.Left
            Case ProgramSettings.TotalRunsColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.SingleInventedBPCRunsColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.ProductionLinesColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.LaboratoryLinesColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.TotalInventionCostColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.TotalCopyCostColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.TaxesColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.BrokerFeesColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.BPProductionTimeColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.TotalProductionTimeColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.CopyTimeColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.InventionTimeColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.ItemMarketPriceColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.ProfitColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.ProfitPercentageColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.IskperHourColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.SVRColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.SVRxIPHColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.PriceTrendColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.TotalItemsSoldColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.TotalOrdersFilledColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.AvgItemsperOrderColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.CurrentSellOrdersColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.CurrentBuyOrdersColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.ItemsinProductionColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.ItemsinStockColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.MaterialCostColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.TotalCostColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.BaseJobCostColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.NumBPsColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.InventionChanceColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.BPTypeColumnName
                Return HorizontalAlignment.Left
            Case ProgramSettings.RaceColumnName
                Return HorizontalAlignment.Left
            Case ProgramSettings.VolumeperItemColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.TotalVolumeColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.SellExcessColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.ROIColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.PortionSizeColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.ManufacturingJobFeeColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.ManufacturingFacilityNameColumnName
                Return HorizontalAlignment.Left
            Case ProgramSettings.ManufacturingFacilitySystemColumnName
                Return HorizontalAlignment.Left
            Case ProgramSettings.ManufacturingFacilityRegionColumnName
                Return HorizontalAlignment.Left
            Case ProgramSettings.ManufacturingFacilitySystemIndexColumnName
                Return HorizontalAlignment.Left
            Case ProgramSettings.ManufacturingFacilityTaxColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.ManufacturingFacilityMEBonusColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.ManufacturingFacilityTEBonusColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.ManufacturingFacilityUsageColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.ManufacturingFacilityFWSystemLevelColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.ComponentFacilityNameColumnName
                Return HorizontalAlignment.Left
            Case ProgramSettings.ComponentFacilitySystemColumnName
                Return HorizontalAlignment.Left
            Case ProgramSettings.ComponentFacilityRegionColumnName
                Return HorizontalAlignment.Left
            Case ProgramSettings.ComponentFacilitySystemIndexColumnName
                Return HorizontalAlignment.Left
            Case ProgramSettings.ComponentFacilityTaxColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.ComponentFacilityMEBonusColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.ComponentFacilityTEBonusColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.ComponentFacilityUsageColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.ComponentFacilityFWSystemLevelColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.CapComponentFacilityNameColumnName
                Return HorizontalAlignment.Left
            Case ProgramSettings.CapComponentFacilitySystemColumnName
                Return HorizontalAlignment.Left
            Case ProgramSettings.CapComponentFacilityRegionColumnName
                Return HorizontalAlignment.Left
            Case ProgramSettings.CapComponentFacilitySystemIndexColumnName
                Return HorizontalAlignment.Left
            Case ProgramSettings.CapComponentFacilityTaxColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.CapComponentFacilityMEBonusColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.CapComponentFacilityTEBonusColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.CapComponentFacilityUsageColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.CapComponentFacilityFWSystemLevelColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.CopyingFacilityNameColumnName
                Return HorizontalAlignment.Left
            Case ProgramSettings.CopyingFacilitySystemColumnName
                Return HorizontalAlignment.Left
            Case ProgramSettings.CopyingFacilityRegionColumnName
                Return HorizontalAlignment.Left
            Case ProgramSettings.CopyingFacilitySystemIndexColumnName
                Return HorizontalAlignment.Left
            Case ProgramSettings.CopyingFacilityTaxColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.CopyingFacilityMEBonusColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.CopyingFacilityTEBonusColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.CopyingFacilityUsageColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.CopyingFacilityFWSystemLevelColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.InventionFacilityNameColumnName
                Return HorizontalAlignment.Left
            Case ProgramSettings.InventionFacilitySystemColumnName
                Return HorizontalAlignment.Left
            Case ProgramSettings.InventionFacilityRegionColumnName
                Return HorizontalAlignment.Left
            Case ProgramSettings.InventionFacilitySystemIndexColumnName
                Return HorizontalAlignment.Left
            Case ProgramSettings.InventionFacilityTaxColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.InventionFacilityMEBonusColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.InventionFacilityTEBonusColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.InventionFacilityUsageColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.InventionFacilityFWSystemLevelColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.ReactionFacilityNameColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.ReactionFacilitySystemColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.ReactionFacilityRegionColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.ReactionFacilitySystemIndexColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.ReactionFacilityTaxColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.ReactionFacilityMEBonusColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.ReactionFacilityTEBonusColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.ReactionFacilityUsageColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.ReactionFacilityFWSystemLevelColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.ReprocessingFacilityNameColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.ReprocessingFacilitySystemColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.ReprocessingFacilityRegionColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.ReprocessingFacilityTaxColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.ReprocessingFacilityUsageColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.ReprocessingFacilityOreRefineRateColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.ReprocessingFacilityIceRefineRateColumnName
                Return HorizontalAlignment.Right
            Case ProgramSettings.ReprocessingFacilityMoonRefineRateColumnName
                Return HorizontalAlignment.Right
            Case Else
                Return 0
        End Select

    End Function

#End Region

    Private Sub InitManufacturingTab()

        lstManufacturing.Items.Clear()

        With UserManufacturingTabSettings
            ' Blueprints
            chkCalcNPCBPOs.Checked = .CheckBPTypeNPCBPOs
            chkCalcAmmo.Checked = .CheckBPTypeAmmoCharges
            chkCalcBoosters.Checked = .CheckBPTypeBoosters
            chkCalcComponents.Checked = .CheckBPTypeComponents
            chkCalcDrones.Checked = .CheckBPTypeDrones
            chkCalcModules.Checked = .CheckBPTypeModules
            chkCalcRigs.Checked = .CheckBPTypeRigs
            chkCalcShips.Checked = .CheckBPTypeShips
            chkCalcSubsystems.Checked = .CheckBPTypeSubsystems
            chkCalcStructures.Checked = .CheckBPTypeStructures
            chkCalcMisc.Checked = .CheckBPTypeMisc
            chkCalcDeployables.Checked = .CheckBPTypeDeployables
            chkCalcCelestials.Checked = .CheckBPTypeCelestials
            chkCalcReactions.Checked = .CheckBPTypeReactions
            chkCalcStructureModules.Checked = .CheckBPTypeStructureModules
            chkCalcStructureRigs.Checked = .CheckBPTypeStationParts

            ' Tech
            chkCalcT1.Checked = .CheckTech1
            chkCalcT2.Checked = .CheckTech2
            chkCalcT3.Checked = .CheckTech3
            chkCalcStoryline.Checked = .CheckTechStoryline
            chkCalcPirateFaction.Checked = .CheckTechPirate
            chkCalcNavyFaction.Checked = .CheckTechNavy

            ' Blueprint load types
            Select Case .BlueprintType
                Case rbtnCalcAllBPs.Text
                    rbtnCalcAllBPs.Checked = True
                    gbCalcIncludeOwned.Enabled = False
                Case rbtnCalcBPOwned.Text
                    rbtnCalcBPOwned.Checked = True
                    gbCalcIncludeOwned.Enabled = True
            End Select

            cmbCalcBPTypeFilter.Text = .ItemTypeFilter
            txtCalcItemFilter.Text = .TextItemFilter

            chkCalcAutoCalcT2NumBPs.Checked = .CheckAutoCalcNumBPs

            FirstManufacturingGridLoad = False ' Change this now so it will load the grids for all on reset

            chkCalcTaxes.Checked = .CheckIncludeTaxes
            Select Case .CheckIncludeBrokersFees
                Case 2
                    chkCalcFees.CheckState = CheckState.Indeterminate
                    txtCalcBrokerFeeRate.Visible = True
                Case 1
                    chkCalcFees.CheckState = CheckState.Checked
                Case 0
                    chkCalcFees.CheckState = CheckState.Unchecked
            End Select

            txtCalcBrokerFeeRate.Text = FormatPercent(.CalcBrokerFeeRate, 1)

            chkCalcSellExessItems.Checked = .CheckSellExcessItems

            Select Case .BuildT2T3Materials
                Case BuildMatType.AdvMaterials
                    rbtnCalcAdvT2MatType.Checked = True
                Case BuildMatType.ProcessedMaterials
                    rbtnCalcProcT2MatType.Checked = True
                Case BuildMatType.RawMaterials
                    rbtnCalcRawT2MatType.Checked = True
            End Select

            ' Check wrecked Relics, do not check meta levels or decryptors (NONE)
            chkCalcDecryptor0.CheckState = CType(.CheckDecryptorOptimal, CheckState)
            chkCalcDecryptor1.Checked = .CheckDecryptorNone ' No decryptor
            chkCalcDecryptor2.Checked = .CheckDecryptor06
            chkCalcDecryptor3.Checked = .CheckDecryptor09
            chkCalcDecryptor4.Checked = .CheckDecryptor10
            chkCalcDecryptor5.Checked = .CheckDecryptor11
            chkCalcDecryptor6.Checked = .CheckDecryptor12
            chkCalcDecryptor7.Checked = .CheckDecryptor15
            chkCalcDecryptor8.Checked = .CheckDecryptor18
            chkCalcDecryptor9.Checked = .CheckDecryptor19

            ' Change the name based on the check state
            If chkCalcDecryptor0.CheckState = CheckState.Unchecked Then
                chkCalcDecryptor0.Text = "Optimal"
            ElseIf chkCalcDecryptor0.CheckState = CheckState.Checked Then
                chkCalcDecryptor0.Text = "Optimal IPH"
            ElseIf chkCalcDecryptor0.CheckState = CheckState.Indeterminate Then
                chkCalcDecryptor0.Text = "Optimal Profit"
            End If

            If chkCalcDecryptor0.CheckState <> CheckState.Unchecked Then
                chkCalcDecryptor1.Enabled = False
                chkCalcDecryptor2.Enabled = False
                chkCalcDecryptor3.Enabled = False
                chkCalcDecryptor4.Enabled = False
                chkCalcDecryptor5.Enabled = False
                chkCalcDecryptor6.Enabled = False
                chkCalcDecryptor7.Enabled = False
                chkCalcDecryptor8.Enabled = False
                chkCalcDecryptor9.Enabled = False
            Else
                chkCalcDecryptor1.Enabled = True
                chkCalcDecryptor2.Enabled = True
                chkCalcDecryptor3.Enabled = True
                chkCalcDecryptor4.Enabled = True
                chkCalcDecryptor5.Enabled = True
                chkCalcDecryptor6.Enabled = True
                chkCalcDecryptor7.Enabled = True
                chkCalcDecryptor8.Enabled = True
                chkCalcDecryptor9.Enabled = True
            End If

            chkCalcDecryptorforT2.Checked = .CheckDecryptorUseforT2
            chkCalcDecryptorforT3.Checked = .CheckDecryptorUseforT3

            chkCalcRERelic3.Checked = .CheckRelicIntact
            chkCalcRERelic2.Checked = .CheckRelicMalfunction
            chkCalcRERelic1.Checked = .CheckRelicWrecked

            chkCalcRaceAmarr.Checked = .CheckRaceAmarr
            chkCalcRaceCaldari.Checked = .CheckRaceCaldari
            chkCalcRaceMinmatar.Checked = .CheckRaceMinmatar
            chkCalcRaceGallente.Checked = .CheckRaceGallente
            chkCalcRacePirate.Checked = .CheckRacePirate
            chkCalcRaceOther.Checked = .CheckRaceOther

            chkCalcSmall.Checked = .CheckSmall
            chkCalcMedium.Checked = .CheckMedium
            chkCalcLarge.Checked = .CheckLarge
            chkCalcXL.Checked = .CheckXL

            chkCalcCanBuild.Checked = .CheckOnlyBuild
            chkCalcCanInvent.Checked = .CheckOnlyInvent

            Select Case .PriceCompare
                Case rbtnCalcCompareAll.Text
                    rbtnCalcCompareAll.Checked = True
                Case rbtnCalcCompareBuildBuy.Text
                    rbtnCalcCompareBuildBuy.Checked = True
                Case rbtnCalcCompareComponents.Text
                    rbtnCalcCompareComponents.Checked = True
                Case rbtnCalcCompareRawMats.Text
                    rbtnCalcCompareRawMats.Checked = True
            End Select

            ' Other defaults
            txtCalcTempME.Text = CStr(UserApplicationSettings.DefaultBPME)
            txtCalcTempTE.Text = CStr(UserApplicationSettings.DefaultBPTE)

            chkCalcIncludeT2Owned.Checked = .CheckIncludeT2Owned
            chkCalcIncludeT3Owned.Checked = .CheckIncludeT3Owned

            chkCalcSVRIncludeNull.Checked = .CheckSVRIncludeNull

            txtCalcSVRThreshold.Text = CStr(UserApplicationSettings.IgnoreSVRThresholdValue)
            cmbCalcHistoryRegion.Text = UserApplicationSettings.SVRAveragePriceRegion
            cmbCalcAvgPriceDuration.Text = UserApplicationSettings.SVRAveragePriceDuration

            txtCalcProdLines.Text = CStr(.ProductionLines)
            txtCalcLabLines.Text = CStr(.LaboratoryLines)
            txtCalcRuns.Text = CStr(.Runs)
            txtCalcNumBPs.Text = CStr(.BPRuns)

            ' Time pickers
            chkCalcMaxBuildTimeFilter.Checked = .MaxBuildTimeCheck
            chkCalcMinBuildTimeFilter.Checked = .MinBuildTimeCheck
            tpMaxBuildTimeFilter.Text = .MaxBuildTime
            tpMinBuildTimeFilter.Text = .MinBuildTime

            cmbCalcPriceTrend.Text = .PriceTrend

            ' Thresholds
            chkCalcIPHThreshold.Checked = .IPHThresholdCheck
            txtCalcIPHThreshold.Text = FormatNumber(.IPHThreshold, 2)
            chkCalcVolumeThreshold.Checked = .VolumeThresholdCheck
            txtCalcVolumeThreshold.Text = FormatNumber(.VolumeThreshold, 2)

            ProfitPercentText = "0.0%"
            ProfitText = "0.00"

            Select Case .ProfitThresholdCheck
                Case CheckState.Checked
                    chkCalcProfitThreshold.CheckState = CheckState.Checked
                    txtCalcProfitThreshold.Text = FormatNumber(.ProfitThreshold, 2)
                    ProfitText = txtCalcProfitThreshold.Text
                    chkCalcProfitThreshold.Text = "Profit Threshold"
                    txtCalcProfitThreshold.Enabled = True
                Case CheckState.Unchecked
                    chkCalcProfitThreshold.CheckState = CheckState.Unchecked
                    txtCalcProfitThreshold.Text = FormatNumber(.ProfitThreshold, 2)
                    ProfitText = txtCalcProfitThreshold.Text
                    chkCalcProfitThreshold.Text = "Profit Threshold"
                    txtCalcProfitThreshold.Enabled = False
                Case CheckState.Indeterminate
                    chkCalcProfitThreshold.CheckState = CheckState.Indeterminate
                    txtCalcProfitThreshold.Text = FormatPercent(.ProfitThreshold, 1)
                    ProfitPercentText = txtCalcProfitThreshold.Text
                    chkCalcProfitThreshold.Text = "Profit % Threshold"
                    txtCalcProfitThreshold.Enabled = True
            End Select

            chkCalcPPU.Checked = .CalcPPU
            chkBPSellExcessItems.Checked = .CheckSellExcessItems

            ListIDIterator = 0

            btnCalcCalculate.Enabled = True
            lstManufacturing.Enabled = True

            If .ColumnSortType = "Ascending" Then
                ManufacturingColumnSortType = SortOrder.Ascending
            Else
                ManufacturingColumnSortType = SortOrder.Descending
            End If

            ManufacturingColumnClicked = .ColumnSort

            AddToShoppingListToolStripMenuItem.Enabled = False ' Don't enable this until they calculate something

        End With

        Call ResetRefresh()
        Call EnableDisableT2T3Options()

    End Sub

    ' Saves all the settings on the screen
    Private Sub btnCalcSaveSettings_Click(sender As System.Object, e As System.EventArgs) Handles btnCalcSaveSettings.Click
        Dim TempSettings As ManufacturingTabSettings = Nothing
        Dim Settings As New ProgramSettings

        ' If they entered an ME/TE value make sure it's ok
        If Trim(txtCalcTempME.Text) <> "" Then
            If Not IsNumeric(txtCalcTempME.Text) Then
                MsgBox("Invalid Temp ME value", vbExclamation, Application.ProductName)
                txtCalcTempME.Focus()
                Exit Sub
            End If
        End If

        If Trim(txtCalcTempTE.Text) <> "" Then
            If Not IsNumeric(txtCalcTempTE.Text) Then
                MsgBox("Invalid Temp TE value", vbExclamation, Application.ProductName)
                txtCalcTempTE.Focus()
                Exit Sub
            End If
        End If

        If Trim(txtCalcSVRThreshold.Text) <> "" Then
            If Not IsNumeric(txtCalcSVRThreshold.Text) Then
                MsgBox("Invalid SVR Threshold value", vbExclamation, Application.ProductName)
                txtCalcSVRThreshold.Focus()
                Exit Sub
            End If
        End If

        If Trim(txtCalcProdLines.Text) <> "" Then
            If Not IsNumeric(txtCalcProdLines.Text) Then
                MsgBox("Invalid Production Lines Value", vbExclamation, Application.ProductName)
                txtCalcProdLines.Focus()
                Exit Sub
            End If
        End If

        If Trim(txtCalcLabLines.Text) <> "" Then
            If Not IsNumeric(txtCalcLabLines.Text) Then
                MsgBox("Invalid Laboratory Lines Value", vbExclamation, Application.ProductName)
                txtCalcLabLines.Focus()
                Exit Sub
            End If
        End If

        If Trim(txtCalcRuns.Text) <> "" Then
            If Not IsNumeric(txtCalcRuns.Text) Then
                MsgBox("Invalid Runs Value", vbExclamation, Application.ProductName)
                txtCalcRuns.Focus()
                Exit Sub
            End If
        End If

        ' Save the column order and width first
        AllSettings.SaveManufacturingTabColumnSettings(UserManufacturingTabColumnSettings)

        With TempSettings
            .CheckBPTypeNPCBPOs = chkCalcNPCBPOs.Checked
            .CheckBPTypeAmmoCharges = chkCalcAmmo.Checked
            .CheckBPTypeBoosters = chkCalcBoosters.Checked
            .CheckBPTypeComponents = chkCalcComponents.Checked
            .CheckBPTypeDrones = chkCalcDrones.Checked
            .CheckBPTypeModules = chkCalcModules.Checked
            .CheckBPTypeRigs = chkCalcRigs.Checked
            .CheckBPTypeShips = chkCalcShips.Checked
            .CheckBPTypeSubsystems = chkCalcSubsystems.Checked
            .CheckBPTypeStructures = chkCalcStructures.Checked
            .CheckBPTypeMisc = chkCalcMisc.Checked
            .CheckBPTypeDeployables = chkCalcDeployables.Checked
            .CheckBPTypeCelestials = chkCalcCelestials.Checked
            .CheckBPTypeReactions = chkCalcReactions.Checked
            .CheckBPTypeStructureModules = chkCalcStructureModules.Checked
            .CheckBPTypeStationParts = chkCalcStructureRigs.Checked

            .CheckTech1 = chkCalcT1.Checked
            .CheckTech2 = chkCalcT2.Checked
            .CheckTech3 = chkCalcT3.Checked
            .CheckTechStoryline = chkCalcStoryline.Checked
            .CheckTechPirate = chkCalcPirateFaction.Checked
            .CheckTechNavy = chkCalcNavyFaction.Checked

            If CalcComponentsFacility.GetCurrentFacilityProductionType = ProductionType.CapitalComponentManufacturing Then
                .CheckCapitalComponentsFacility = True
            Else
                .CheckCapitalComponentsFacility = False
            End If

            If CalcT3ShipsFacility.GetCurrentFacilityProductionType = ProductionType.T3DestroyerManufacturing Then
                .CheckT3DestroyerFacility = True
            Else
                .CheckT3DestroyerFacility = False
            End If

            .CheckAutoCalcNumBPs = chkCalcAutoCalcT2NumBPs.Checked

            ' Blueprint load types
            If rbtnCalcAllBPs.Checked Then
                .BlueprintType = rbtnCalcAllBPs.Text
            ElseIf rbtnCalcBPOwned.Checked Then
                .BlueprintType = rbtnCalcBPOwned.Text
            End If

            .ItemTypeFilter = cmbCalcBPTypeFilter.Text
            .TextItemFilter = txtCalcItemFilter.Text

            .CheckIncludeTaxes = chkCalcTaxes.Checked
            If chkCalcFees.CheckState = CheckState.Indeterminate Then
                .CheckIncludeBrokersFees = 2
            ElseIf chkCalcFees.CheckState = CheckState.Checked Then
                .CheckIncludeBrokersFees = 1
            Else
                .CheckIncludeBrokersFees = 0
            End If
            .CalcBrokerFeeRate = FormatManualPercentEntry(txtCalcBrokerFeeRate.Text)

            .CheckSellExcessItems = chkCalcSellExessItems.Checked

            .CheckDecryptorOptimal = CInt(chkCalcDecryptor0.CheckState)
            .CheckDecryptorNone = chkCalcDecryptor1.Checked
            .CheckDecryptor06 = chkCalcDecryptor2.Checked
            .CheckDecryptor09 = chkCalcDecryptor3.Checked
            .CheckDecryptor10 = chkCalcDecryptor4.Checked
            .CheckDecryptor11 = chkCalcDecryptor5.Checked
            .CheckDecryptor12 = chkCalcDecryptor6.Checked
            .CheckDecryptor15 = chkCalcDecryptor7.Checked
            .CheckDecryptor18 = chkCalcDecryptor8.Checked
            .CheckDecryptor19 = chkCalcDecryptor9.Checked

            .CheckDecryptorUseforT2 = chkCalcDecryptorforT2.Checked
            .CheckDecryptorUseforT3 = chkCalcDecryptorforT3.Checked

            .CheckRelicIntact = chkCalcRERelic3.Checked
            .CheckRelicMalfunction = chkCalcRERelic2.Checked
            .CheckRelicWrecked = chkCalcRERelic1.Checked

            .CheckRaceAmarr = chkCalcRaceAmarr.Checked
            .CheckRaceCaldari = chkCalcRaceCaldari.Checked
            .CheckRaceMinmatar = chkCalcRaceMinmatar.Checked
            .CheckRaceGallente = chkCalcRaceGallente.Checked
            .CheckRacePirate = chkCalcRacePirate.Checked
            .CheckRaceOther = chkCalcRaceOther.Checked

            .CalcPPU = chkCalcPPU.Checked
            .CheckSellExcessItems = chkBPSellExcessItems.Checked

            .ColumnSort = ManufacturingColumnClicked
            If ManufacturingColumnSortType = SortOrder.Ascending Then
                .ColumnSortType = "Ascending"
            Else
                .ColumnSortType = "Decending"
            End If

            ' Sort the list based on the saved column, if they change the number of columns below value, then find IPH, if not there, use column 0
            If ManufacturingColumnClicked > lstManufacturing.Columns.Count Then
                ' Find the IPH column
                If UserManufacturingTabColumnSettings.IskperHour <> 0 Then
                    ManufacturingColumnClicked = UserManufacturingTabColumnSettings.IskperHour
                Else
                    ManufacturingColumnClicked = 0 ' Default, will always be there
                End If

            End If

            .ColumnSort = ManufacturingColumnClicked

            If rbtnCalcCompareAll.Checked Then
                .PriceCompare = rbtnCalcCompareAll.Text
            ElseIf rbtnCalcCompareBuildBuy.Checked Then
                .PriceCompare = rbtnCalcCompareBuildBuy.Text
            ElseIf rbtnCalcCompareComponents.Checked Then
                .PriceCompare = rbtnCalcCompareComponents.Text
            ElseIf rbtnCalcCompareRawMats.Checked Then
                .PriceCompare = rbtnCalcCompareRawMats.Text
            End If

            .CheckSmall = chkCalcSmall.Checked
            .CheckMedium = chkCalcMedium.Checked
            .CheckLarge = chkCalcLarge.Checked
            .CheckXL = chkCalcXL.Checked

            .CheckIncludeT2Owned = chkCalcIncludeT2Owned.Checked
            .CheckIncludeT3Owned = chkCalcIncludeT3Owned.Checked

            .CheckSVRIncludeNull = chkCalcSVRIncludeNull.Checked
            .ProductionLines = CInt(txtCalcProdLines.Text)
            .LaboratoryLines = CInt(txtCalcLabLines.Text)
            .Runs = CInt(txtCalcRuns.Text)
            .BPRuns = CInt(txtCalcNumBPs.Text)

            .CheckOnlyBuild = chkCalcCanBuild.Checked
            .CheckOnlyInvent = chkCalcCanInvent.Checked

            .PriceTrend = cmbCalcPriceTrend.Text

            .MaxBuildTimeCheck = chkCalcMaxBuildTimeFilter.Checked
            .MaxBuildTime = tpMaxBuildTimeFilter.Text
            .MinBuildTimeCheck = chkCalcMinBuildTimeFilter.Checked
            .MinBuildTime = tpMinBuildTimeFilter.Text

            .IPHThresholdCheck = chkCalcIPHThreshold.Checked
            .IPHThreshold = CDbl(txtCalcIPHThreshold.Text)
            .VolumeThresholdCheck = chkCalcVolumeThreshold.Checked
            .VolumeThreshold = CDbl(txtCalcVolumeThreshold.Text)

            ' How they want to build T2/T3 items
            If rbtnCalcAdvT2MatType.Checked Then
                .BuildT2T3Materials = BuildMatType.AdvMaterials
            ElseIf rbtnCalcProcT2MatType.Checked Then
                .BuildT2T3Materials = BuildMatType.ProcessedMaterials
            ElseIf rbtnCalcRawT2MatType.Checked Then
                .BuildT2T3Materials = BuildMatType.RawMaterials
            End If

            Select Case chkCalcProfitThreshold.CheckState
                Case CheckState.Checked
                    .ProfitThresholdCheck = CheckState.Checked
                    .ProfitThreshold = CDbl(txtCalcProfitThreshold.Text.Replace("%", ""))
                Case CheckState.Unchecked
                    .ProfitThresholdCheck = CheckState.Unchecked
                    .ProfitThreshold = CDbl(txtCalcProfitThreshold.Text.Replace("%", ""))
                Case CheckState.Indeterminate
                    ' Profit percent
                    .ProfitThresholdCheck = CheckState.Indeterminate
                    .ProfitThreshold = CpctD(txtCalcProfitThreshold.Text)
            End Select

            ' Save these here as well as in settings
            With UserApplicationSettings
                .DefaultBPME = CInt(txtCalcTempME.Text)
                .DefaultBPTE = CInt(txtCalcTempTE.Text)

                .IgnoreSVRThresholdValue = CDbl(txtCalcSVRThreshold.Text)
                .SVRAveragePriceRegion = cmbCalcHistoryRegion.Text
                .SVRAveragePriceDuration = cmbCalcAvgPriceDuration.Text
            End With

            Call Settings.SaveApplicationSettings(UserApplicationSettings)

        End With


        ' Save the data in the XML file
        Call Settings.SaveManufacturingSettings(TempSettings)

        ' Save the data to the local variable
        UserManufacturingTabSettings = TempSettings

        MsgBox("Settings Saved", vbInformation, Application.ProductName)

    End Sub

    ' Switches button to calculate
    Public Sub ResetRefresh()
        RefreshCalcData = False
        btnCalcCalculate.Text = "Calculate"
    End Sub

    Structure OptimalDecryptorItem
        Dim ItemTypeID As Long
        Dim ListLocationID As Integer ' The unique number of the item in the list
        Dim CalcType As String ' Raw, Component, or Build/Buy
        Dim CompareValue As Double ' IPH or profit
    End Structure

    Private Function ReturnNumber() As Integer
        Return 1
    End Function

    ' Displays the results of the options on the screen. If Calculate is true, then it will run the calculations. If not, just a preview of the data
    Private Sub DisplayManufacturingResults(ByVal Calculate As Boolean)
        Dim SQL As String
        Dim readerBPs As SQLiteDataReader
        Dim readerIDs As SQLiteDataReader

        Dim UpdateTypeIDs As New List(Of Long) ' Full list of TypeID's to update SVR data with, these will have Market IDs
        Dim MarketRegionID As Long
        Dim AveragePriceDays As Integer

        Dim BaseItems As New List(Of ManufacturingItem) ' Holds all the items and their decryptors, relics, meta etc for initial list
        Dim ManufacturingList As New List(Of ManufacturingItem) ' List of all the items we manufactured - may be different than the item list
        Dim FinalItemList As New List(Of ManufacturingItem) ' Final list of data

        Dim InsertItem As New ManufacturingItem

        Dim ManufacturingBlueprint As Blueprint

        Dim BPList As ListViewItem

        Dim i, j As Integer
        Dim BPRecordCount As Integer = 0
        Dim TotalItemCount As Integer = 0
        Dim TempItemType As Integer = 0

        Dim InventionDecryptors As New DecryptorList

        Dim OrigME As Integer
        Dim OrigTE As Integer

        Dim AddItem As Boolean
        Dim DecryptorUsed As New Decryptor

        ' T2/T3 variables
        Dim RelicName As String = ""
        Dim InputText As String = ""
        Dim DecryptorName As String = ""

        ' BPC stuff
        Dim CopyPricePerSecond As Double = 0
        Dim T1BPCType As String = ""
        Dim T1BPCName As String = ""
        Dim T1BPCMaxRuns As Integer = 0

        ' SVR Threshold
        Dim SVRThresholdValue As Double
        Dim TypeIDCheck As String = ""

        ' Number of blueprints used
        Dim NumberofBlueprints As Integer

        Dim OriginalBPOwnedFlag As Boolean

        ' For the optimal decryptor checking
        Dim OptimalDecryptorItems As New List(Of OptimalDecryptorItem)

        Dim ItemIsReaction As Boolean

        ' Set this now and enable it if they calculate
        AddToShoppingListToolStripMenuItem.Enabled = False

        ' If they entered an ME/TE value make sure it's ok
        If Not CorrectMETE(txtCalcTempME.Text, txtCalcTempTE.Text, txtCalcTempME, txtCalcTempTE) Then
            Exit Sub
        End If

        If Trim(cmbCalcAvgPriceDuration.Text) <> "" Then
            If Not IsNumeric(cmbCalcAvgPriceDuration.Text) Then
                MsgBox("Invalid SVR Average Days. Please select a valid number of days from the combo selection box.", vbExclamation, Application.ProductName)
                cmbCalcAvgPriceDuration.Focus()
                cmbCalcAvgPriceDuration.SelectAll()
                Exit Sub
            End If
        End If

        ' Days can only be between 2 and 365 based on ESI data
        If CInt(cmbCalcAvgPriceDuration.Text) < 2 Or CInt(cmbCalcAvgPriceDuration.Text) > 365 Then
            MsgBox("Averge price updates can only be done for greater than 1 or less than 365 days", vbExclamation, Application.ProductName)
            cmbCalcAvgPriceDuration.Focus()
            cmbCalcAvgPriceDuration.SelectAll()
            Exit Sub
        End If

        If Trim(txtCalcProdLines.Text) <> "" Then
            If Not IsNumeric(txtCalcProdLines.Text) Then
                MsgBox("Invalid Production Lines value", vbExclamation, Application.ProductName)
                txtCalcProdLines.Focus()
                txtCalcProdLines.SelectAll()
                Exit Sub
            End If
        End If

        If Val(txtCalcProdLines.Text) = 0 Then
            MsgBox("You must select a non-zero production lines value.", vbExclamation, Application.ProductName)
            txtCalcProdLines.Focus()
            txtCalcProdLines.SelectAll()
            Exit Sub
        End If

        If Trim(txtCalcNumBPs.Text) <> "" Then
            If Not IsNumeric(txtCalcNumBPs.Text) Then
                MsgBox("Invalid Num BPs value", vbExclamation, Application.ProductName)
                txtCalcNumBPs.Focus()
                txtCalcNumBPs.SelectAll()
                Exit Sub
            End If
        End If

        If Val(txtCalcNumBPs.Text) = 0 Then
            MsgBox("You must select a non-zero Num BPs value.", vbExclamation, Application.ProductName)
            txtCalcNumBPs.Focus()
            txtCalcNumBPs.SelectAll()
            Exit Sub
        End If

        If Trim(txtCalcRuns.Text) <> "" Then
            If Not IsNumeric(txtCalcRuns.Text) Then
                MsgBox("Invalid Runs value", vbExclamation, Application.ProductName)
                txtCalcRuns.Focus()
                txtCalcRuns.SelectAll()
                Exit Sub
            End If
        End If

        If Val(txtCalcRuns.Text) = 0 Then
            MsgBox("You must select a non-zero Runs value.", vbExclamation, Application.ProductName)
            txtCalcRuns.Focus()
            txtCalcRuns.SelectAll()
            Exit Sub
        End If

        If Trim(txtCalcLabLines.Text) <> "" Then
            If Not IsNumeric(txtCalcLabLines.Text) Then
                MsgBox("Invalid Laboratory Lines value", vbExclamation, Application.ProductName)
                txtCalcLabLines.Focus()
                txtCalcLabLines.SelectAll()
                Exit Sub
            End If
        End If

        If Val(txtCalcLabLines.Text) = 0 Then
            MsgBox("You must select a non-zero laboratory lines value.", vbExclamation, Application.ProductName)
            txtCalcLabLines.Focus()
            txtCalcLabLines.SelectAll()
            Exit Sub
        End If

        ' Make sure the build times don't overlap if both checked
        If chkCalcMinBuildTimeFilter.Checked And chkCalcMaxBuildTimeFilter.Checked Then
            If ConvertDHMSTimetoSeconds(tpMinBuildTimeFilter.Text) >= ConvertDHMSTimetoSeconds(tpMaxBuildTimeFilter.Text) Then
                MsgBox("You must select a Min Build time less than the Max Build time selected.", vbExclamation, Application.ProductName)
                chkCalcMinBuildTimeFilter.Focus()
                Exit Sub
            End If
        End If

        If txtCalcSVRThreshold.Text = "" Then
            SVRThresholdValue = Nothing ' Include everything
        Else
            SVRThresholdValue = CDbl(txtCalcSVRThreshold.Text)
        End If

        ' Save the refresh value since everytime we load the facility it will change it
        Dim SavedRefreshValue As Boolean = RefreshCalcData

        ' Make sure they have a facility loaded - if not, load the default for the type
        If Not CalcBaseFacility.GetFacility(ProductionType.Manufacturing).FullyLoaded Then
            CalcBaseFacility.InitializeFacilities(ProgramLocation.ManufacturingTab, ProductionType.Manufacturing)
        End If
        If Not CalcComponentsFacility.GetFacility(ProductionType.ComponentManufacturing).FullyLoaded Then
            CalcComponentsFacility.InitializeFacilities(ProgramLocation.ManufacturingTab, ProductionType.ComponentManufacturing)
        End If
        If Not CalcComponentsFacility.GetFacility(ProductionType.CapitalComponentManufacturing).FullyLoaded Then
            CalcComponentsFacility.InitializeFacilities(ProgramLocation.ManufacturingTab, ProductionType.CapitalComponentManufacturing)
        End If
        If Not CalcInventionFacility.GetFacility(ProductionType.Invention).FullyLoaded Then
            CalcInventionFacility.InitializeFacilities(ProgramLocation.ManufacturingTab, ProductionType.Invention)
        End If
        If Not CalcCopyFacility.GetFacility(ProductionType.Copying).FullyLoaded Then
            CalcCopyFacility.InitializeFacilities(ProgramLocation.ManufacturingTab, ProductionType.Copying)
        End If
        If Not CalcT3InventionFacility.GetFacility(ProductionType.T3Invention).FullyLoaded Then
            CalcT3InventionFacility.InitializeFacilities(ProgramLocation.ManufacturingTab, ProductionType.T3Invention)
        End If
        If Not CalcSupersFacility.GetFacility(ProductionType.SuperManufacturing).FullyLoaded Then
            CalcSupersFacility.InitializeFacilities(ProgramLocation.ManufacturingTab, ProductionType.SuperManufacturing)
        End If
        If Not CalcCapitalsFacility.GetFacility(ProductionType.CapitalManufacturing).FullyLoaded Then
            CalcCapitalsFacility.InitializeFacilities(ProgramLocation.ManufacturingTab, ProductionType.CapitalManufacturing)
        End If
        If Not CalcT3ShipsFacility.GetFacility(ProductionType.T3CruiserManufacturing).FullyLoaded Then
            CalcT3ShipsFacility.InitializeFacilities(ProgramLocation.ManufacturingTab, ProductionType.T3CruiserManufacturing)
        End If
        If Not CalcT3ShipsFacility.GetFacility(ProductionType.T3DestroyerManufacturing).FullyLoaded Then
            CalcT3ShipsFacility.InitializeFacilities(ProgramLocation.ManufacturingTab, ProductionType.T3DestroyerManufacturing)
        End If
        If Not CalcSubsystemsFacility.GetFacility(ProductionType.SubsystemManufacturing).FullyLoaded Then
            CalcSubsystemsFacility.InitializeFacilities(ProgramLocation.ManufacturingTab, ProductionType.SubsystemManufacturing)
        End If
        If Not CalcBoostersFacility.GetFacility(ProductionType.BoosterManufacturing).FullyLoaded Then
            CalcBoostersFacility.InitializeFacilities(ProgramLocation.ManufacturingTab, ProductionType.BoosterManufacturing)
        End If
        If Not CalcReactionsFacility.GetFacility(ProductionType.Reactions).FullyLoaded Then
            CalcReactionsFacility.InitializeFacilities(ProgramLocation.ManufacturingTab, ProductionType.Reactions)
        End If

        If Not SavedRefreshValue Then
            Application.UseWaitCursor = True
            Me.Cursor = Cursors.WaitCursor
            Application.DoEvents()

            ' Only cancel if they hit the cancel button
            btnCalcCalculate.Text = "Cancel"

            ' Get the query for the data
            SQL = BuildManufacturingSelectQuery(BPRecordCount, UserInventedBPs)

            If SQL = "" Then
                ' No valid query so just show nothing
                lstManufacturing.Items.Clear()
                FinalManufacturingItemList = Nothing
                GoTo ExitCalc
            End If

            ' Get data
            DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
            DBCommand.Parameters.AddWithValue("@USERBP_USERID", GetBPUserID(SelectedCharacter.ID)) ' need to search for corp ID too
            DBCommand.Parameters.AddWithValue("@USERBP_CORPID", CStr(SelectedCharacter.CharacterCorporation.CorporationID))
            readerBPs = DBCommand.ExecuteReader

            If Not readerBPs.HasRows Then
                ' No data
                lstManufacturing.Items.Clear()
                ' Clear list of data
                FinalManufacturingItemList = Nothing
                GoTo ExitCalc
            End If

            'Me.Cursor = Cursors.WaitCursor
            pnlProgressBar.Minimum = 0
            pnlProgressBar.Maximum = BPRecordCount
            pnlProgressBar.Value = 0
            pnlProgressBar.Visible = True

            ' Reset the record Iterator and list formats
            ListIDIterator = 0
            ListRowFormats = New List(Of RowFormat)

            pnlStatus.Text = "Building List..."

            ' Add the data to the final list, then display into the grid
            While readerBPs.Read
                Application.DoEvents()
                ' If they cancel the calc
                If CancelManufacturingTabCalc Then
                    GoTo ExitCalc
                End If

                ' 0-BP_ID, 1-BLUEPRINT_GROUP, 2-BLUEPRINT_NAME, 3-ITEM_GROUP_ID, 4-ITEM_GROUP, 5-ITEM_CATEGORY_ID, 
                ' 6-ITEM_CATEGORY, 7-ITEM_ID, 8-ITEM_NAME, 9-ME, 10-TE, 11-USERID, 12-ITEM_TYPE, 13-RACE_ID, 14-OWNED, 15-SCANNED 
                ' 16-BP_TYPE, 17-UNIQUE_BP_ITEM_ID, 18-FAVORITE, 19-VOLUME, 20-MARKET_GROUP_ID, 21-ADDITIONAL_COSTS, 
                ' 22-LOCATION_ID, 23-QUANTITY, 24-FLAG_ID, 25-RUNS, 26-IGNORE, 27-TECH_LEVEL
                InsertItem = New ManufacturingItem

                ' Save the items before adding
                InsertItem.BPID = CLng(readerBPs.GetValue(0)) ' Hidden
                InsertItem.ItemGroupID = readerBPs.GetInt32(3)
                InsertItem.ItemGroup = readerBPs.GetString(4)
                InsertItem.ItemCategoryID = readerBPs.GetInt32(5)
                InsertItem.ItemCategory = readerBPs.GetString(6)
                InsertItem.ItemTypeID = CLng(readerBPs.GetValue(7))
                InsertItem.ItemName = readerBPs.GetString(8)
                InsertItem.AddlCosts = readerBPs.GetDouble(21)

                ' 1, 2, 14 are T1, T2, T3
                ' 3 is Storyline
                ' 15 is Pirate Faction
                ' 16 is Navy Faction
                TempItemType = CInt(readerBPs.GetValue(12))

                Select Case TempItemType ' For Tech
                    Case 1
                        InsertItem.TechLevel = "T1"
                    Case 2
                        InsertItem.TechLevel = "T2"
                    Case 14
                        InsertItem.TechLevel = "T3"
                    Case 3
                        InsertItem.TechLevel = "Storyline"
                    Case 15
                        InsertItem.TechLevel = "Pirate"
                    Case 16
                        InsertItem.TechLevel = "Navy"
                    Case Else
                        InsertItem.TechLevel = ""
                End Select

                ' Owned flag
                If readerBPs.GetInt32(14) = 0 Then
                    InsertItem.Owned = No
                    OriginalBPOwnedFlag = False
                Else
                    InsertItem.Owned = Yes
                    OriginalBPOwnedFlag = True
                End If

                ' Scanned flag for corp or personal bps
                InsertItem.Scanned = readerBPs.GetInt32(15)

                ' BP Type
                InsertItem.BlueprintType = GetBPType(readerBPs.GetInt32(16))

                ' Save the runs for checking decryptors and relics later
                InsertItem.SavedBPRuns = readerBPs.GetInt32(25)

                Select Case InsertItem.ItemGroupID
                    Case ReturnNumber()
                        ItemIsReaction = False
                    Case ReactionGroupID(InsertItem.ItemGroupID)
                        ItemIsReaction = True
                    Case Else
                        ItemIsReaction = False
                End Select

                ' ME value, either what the entered or in the table
                Select Case TempItemType
                    Case 3, 15, 16
                        ' Storyline, Pirate, and Navy can't be updated
                        InsertItem.BPME = 0
                    Case 2, 14 ' T2 or T3 - either Invented, or BPO
                        If InsertItem.Owned = No Then
                            InsertItem.BPME = BaseT2T3ME
                        Else
                            ' Use what they entered
                            InsertItem.BPME = CInt(readerBPs.GetValue(9))
                        End If
                    Case Else
                        If ItemIsReaction Then
                            ' Can't research reactions
                            InsertItem.BPTE = 0
                        ElseIf InsertItem.Owned = No Then
                            ' Use the default
                            InsertItem.BPME = CInt(txtCalcTempME.Text)
                        Else
                            ' Use what they entered
                            InsertItem.BPME = CInt(readerBPs.GetValue(9))
                        End If
                End Select

                ' TE value, either what the entered or in the table
                Select Case TempItemType
                    Case 3, 15, 16
                        ' Storyline, Pirate, and Navy can't be updated
                        InsertItem.BPTE = 0
                    Case 2, 14 ' T2 or T3 - either Invented, or BPO
                        If InsertItem.Owned = No Then
                            InsertItem.BPTE = BaseT2T3TE
                        Else
                            ' Use what they entered
                            InsertItem.BPTE = CInt(readerBPs.GetValue(10))
                        End If
                    Case Else
                        If ItemIsReaction Then
                            ' Can't research reactions
                            InsertItem.BPTE = 0
                        ElseIf InsertItem.Owned = No Then
                            ' Use the default
                            InsertItem.BPTE = CInt(txtCalcTempTE.Text)
                        Else
                            ' Use what they entered
                            InsertItem.BPTE = CInt(readerBPs.GetValue(10))
                        End If
                End Select

                ' Default to building/inventing/RE'ing all
                InsertItem.CanBuildBP = True
                InsertItem.CanInvent = True
                InsertItem.CanRE = True

                ' Default prices
                InsertItem.Profit = 0
                InsertItem.ProfitPercent = 0
                InsertItem.IPH = 0

                ' Save the original ME/TE
                OrigME = CInt(InsertItem.BPME)
                OrigTE = CInt(InsertItem.BPTE)

                ' Runs and lines
                InsertItem.Runs = CInt(txtCalcRuns.Text)
                InsertItem.ProductionLines = CInt(txtCalcProdLines.Text)
                InsertItem.LaboratoryLines = CInt(txtCalcLabLines.Text)

                ' Reset all the industry facilities
                InsertItem.BuildFacility = New IndustryFacility
                InsertItem.ComponentManufacturingFacility = New IndustryFacility
                InsertItem.CapComponentManufacturingFacility = New IndustryFacility
                InsertItem.CopyFacility = New IndustryFacility
                InsertItem.InventionFacility = New IndustryFacility
                InsertItem.ReactionFacility = New IndustryFacility

                Dim TempFacility As New ManufacturingFacility

                Dim BuildType As ProductionType

                ' Set the facility for manufacturing and set it to the current selected facility for this type
                If ItemIsReaction Then
                    BuildType = ProductionType.Reactions
                Else
                    BuildType = TempFacility.GetProductionType(InsertItem.ItemGroupID, InsertItem.ItemCategoryID, ManufacturingFacility.ActivityManufacturing)
                End If

                Select Case BuildType
                    Case ProductionType.Manufacturing
                        InsertItem.BuildFacility = CalcBaseFacility.GetFacility(BuildType)
                    Case ProductionType.ComponentManufacturing, ProductionType.CapitalComponentManufacturing
                        InsertItem.BuildFacility = CalcComponentsFacility.GetFacility(BuildType)
                    Case ProductionType.BoosterManufacturing
                        InsertItem.BuildFacility = CalcBoostersFacility.GetFacility(BuildType)
                    Case ProductionType.CapitalManufacturing
                        InsertItem.BuildFacility = CalcCapitalsFacility.GetFacility(BuildType)
                    Case ProductionType.Reactions
                        InsertItem.BuildFacility = CalcReactionsFacility.GetFacility(BuildType)
                    Case ProductionType.SubsystemManufacturing
                        InsertItem.BuildFacility = CalcSubsystemsFacility.GetFacility(BuildType)
                    Case ProductionType.SuperManufacturing
                        InsertItem.BuildFacility = CalcSupersFacility.GetFacility(BuildType)
                    Case ProductionType.T3CruiserManufacturing, ProductionType.T3DestroyerManufacturing
                        InsertItem.BuildFacility = CalcT3ShipsFacility.GetFacility(BuildType)
                End Select

                If BuildType = ProductionType.Reactions Then
                    'Need to use the manufacturing facility instead of component facility since they are more likely to make fuel blocks for reactions there
                    InsertItem.ComponentManufacturingFacility = CalcBaseFacility.GetFacility(ProductionType.Manufacturing)
                ElseIf ((InsertItem.ItemCategoryID = ItemIDs.ComponentCategoryID Or InsertItem.ItemGroupID = ItemIDs.AdvCapitalComponentGroupID) And Not InsertItem.ItemGroupID = ItemIDs.CapitalComponentGroupID) Then
                    ' Use the reaction facility as the 'component facility' if it's T2 component item, since they will do reactions
                    InsertItem.ComponentManufacturingFacility = CalcReactionsFacility.GetFacility(ProductionType.Reactions)
                Else
                    InsertItem.ComponentManufacturingFacility = CalcComponentsFacility.GetFacility(ProductionType.ComponentManufacturing)
                End If

                InsertItem.CapComponentManufacturingFacility = CalcComponentsFacility.GetFacility(ProductionType.CapitalComponentManufacturing)
                InsertItem.CopyFacility = CalcCopyFacility.GetFacility(ProductionType.Copying)
                InsertItem.ReactionFacility = CalcReactionsFacility.GetFacility(ProductionType.Reactions)

                ' Now determine how many copies of the base item we need with different data changed
                ' If T1, just select compare types (raw and components)
                ' If T2, first select each decryptor, then select Compare types (raw and components)
                ' If T3, first choose a decryptor, then Relic, then select compare types (raw and components)
                ' Insert each different combination
                If InsertItem.TechLevel = "T2" Or InsertItem.TechLevel = "T3" Then
                    ' For determining the owned blueprints
                    Dim TempDecryptors As New DecryptorList
                    Dim OriginalRelicUsed As String = ""
                    Dim CheckOwnedBP As Boolean = False
                    Dim OriginalBPType As BPType = InsertItem.BlueprintType
                    Dim OriginalDecryptorUsed As Decryptor = TempDecryptors.GetDecryptor(OrigME, OrigTE, InsertItem.SavedBPRuns, CInt(InsertItem.TechLevel.Substring(1)))
                    If InsertItem.TechLevel = "T3" Then
                        OriginalRelicUsed = GetRelicfromInputs(OriginalDecryptorUsed, InsertItem.BPID, InsertItem.SavedBPRuns)
                    End If

                    ' Now add additional records for each decryptor
                    For j = 1 To CalcDecryptorCheckBoxes.Count - 1
                        ' If it's checked or if optimal is checked, add the decryptor
                        If CalcDecryptorCheckBoxes(j).Checked Or chkCalcDecryptor0.Checked Then

                            ' These are all invented BPCs, BPC and BPOs are added separately below
                            InsertItem.BlueprintType = BPType.InventedBPC

                            ' If they are not using for T2 or T3 then only add No Decyrptor and exit for
                            If CalcDecryptorCheckBoxes(j).Text <> None _
                                And ((InsertItem.TechLevel = "T2" And chkCalcDecryptorforT2.Enabled And chkCalcDecryptorforT2.Checked) _
                                Or (InsertItem.TechLevel = "T3" And chkCalcDecryptorforT3.Enabled And chkCalcDecryptorforT3.Checked)) Then

                                ' Select a decryptor
                                DecryptorUsed = InventionDecryptors.GetDecryptor(CDbl(CalcDecryptorCheckBoxes(j).Text.Substring(0, 3)))

                                ' Add decryptor
                                InsertItem.Decryptor = DecryptorUsed
                                InsertItem.Inputs = DecryptorUsed.Name
                                InsertItem.BPME = BaseT2T3ME + InsertItem.Decryptor.MEMod
                                InsertItem.BPTE = BaseT2T3TE + InsertItem.Decryptor.TEMod

                            Else
                                ' Add no decryptor, this is a copy or bpo
                                InsertItem.Decryptor = NoDecryptor
                                InsertItem.Inputs = NoDecryptor.Name
                                InsertItem.BPME = BaseT2T3ME
                                InsertItem.BPTE = BaseT2T3TE
                            End If

                            ' Facilities
                            If InsertItem.TechLevel = "T2" Then
                                InsertItem.InventionFacility = CalcInventionFacility.GetFacility(ProductionType.Invention)
                                InsertItem.CopyFacility = CalcCopyFacility.GetFacility(ProductionType.Copying)
                                InsertItem.InventionFacility.FWUpgradeLevel = CalcComponentsFacility.GetFacility(ProductionType.Invention).FWUpgradeLevel
                            ElseIf InsertItem.TechLevel = "T3" Then
                                InsertItem.InventionFacility = CalcT3InventionFacility.GetFacility(ProductionType.T3Invention)
                                InsertItem.InventionFacility.FWUpgradeLevel = CalcComponentsFacility.GetFacility(ProductionType.T3Invention).FWUpgradeLevel
                                InsertItem.CopyFacility = NoFacility
                            End If

                            InsertItem.CopyFacility.FWUpgradeLevel = CalcComponentsFacility.GetFacility(ProductionType.Copying).FWUpgradeLevel

                            Dim BaseInputs As String = InsertItem.Inputs

                            ' Relics
                            If InsertItem.TechLevel = "T3" Then
                                ' Loop through each relic check box and process for each decryptor
                                For k = 1 To CalcRelicCheckboxes.Count - 1
                                    If CalcRelicCheckboxes(k).Checked Then
                                        InsertItem.Relic = CalcRelicCheckboxes(k).Text
                                        ' Add to the inputs
                                        InsertItem.Inputs = BaseInputs & " - " & InsertItem.Relic
                                        ' Set the owned flag before inserting
                                        CheckOwnedBP = SetItemOwnedFlag(InsertItem, OriginalDecryptorUsed, OriginalRelicUsed, OrigME, OrigTE, OriginalBPOwnedFlag)
                                        If rbtnCalcAllBPs.Checked Or (chkCalcIncludeT3Owned.Checked) Or
                                            (rbtnCalcBPOwned.Checked And CheckOwnedBP) Then
                                            ' Insert the item 
                                            Call InsertItemCalcType(BaseItems, InsertItem, ListRowFormats)
                                        End If
                                    End If
                                Next
                            Else
                                ' No relic for T2
                                InsertItem.Relic = ""
                                ' Set the owned flag before inserting
                                CheckOwnedBP = SetItemOwnedFlag(InsertItem, OriginalDecryptorUsed, OriginalRelicUsed, OrigME, OrigTE, OriginalBPOwnedFlag)
                                If rbtnCalcAllBPs.Checked Or (chkCalcIncludeT2Owned.Checked And UserInventedBPs.Contains(InsertItem.BPID)) Or
                                    (rbtnCalcBPOwned.Checked And CheckOwnedBP) Or rbtnCalcBPFavorites.Checked Then
                                    ' Insert the item 
                                    Call InsertItemCalcType(BaseItems, InsertItem, ListRowFormats)
                                End If
                            End If

                            ' If they don't want to include decryptors, then exit loop after adding none
                            If (InsertItem.TechLevel = "T2" And (chkCalcDecryptorforT2.Enabled = False Or chkCalcDecryptorforT2.Checked = False)) _
                                    Or (InsertItem.TechLevel = "T3" And (chkCalcDecryptorforT3.Enabled = False Or chkCalcDecryptorforT3.Checked = False)) Then
                                Exit For
                            End If
                        End If
                    Next

                    ' Finally, see if the original blueprint was not invented and then add it separately - BPCs and BPOs (should only be T2)
                    If OriginalBPType = BPType.Copy Or OriginalBPType = BPType.Original Then
                        ' Get the original me/te
                        InsertItem.BPME = OrigME
                        InsertItem.BPTE = OrigTE
                        InsertItem.Owned = Yes
                        InsertItem.Inputs = Unknown
                        InsertItem.BlueprintType = OriginalBPType

                        ' Insert the item 
                        Call InsertItemCalcType(BaseItems, InsertItem, ListRowFormats)
                    End If

                Else ' All T1 and others
                    InsertItem.Inputs = None
                    InsertItem.Relic = ""
                    InsertItem.Decryptor = NoDecryptor

                    InsertItem.InventionFacility = NoFacility
                    InsertItem.CopyFacility = NoFacility

                    ' Insert the items based on compare types
                    Call InsertItemCalcType(BaseItems, InsertItem, ListRowFormats)
                End If

                ' For each record, update the progress bar
                Call IncrementToolStripProgressBar(pnlProgressBar)

            End While

            ' Set the formats
            Call lstManufacturing.SetRowFormats(ListRowFormats)
            Application.DoEvents()

            readerBPs.Close()

            TotalItemCount = BaseItems.Count

            ' *** Calculate ***
            ' Got all the data, now see if they want to calculate prices
            If Calculate Then
                'If TotalItemCount > 1000 Then
                '    ' Make sure they know this will take a bit to run - unless this is fairly quick
                '    Response = MsgBox("This may take some time to complete. Do you want to continue?", vbYesNo, Me.Text)

                '    If Response = vbNo Then
                '        ' Just display the results of the query
                '        GoTo DisplayResults
                '    End If
                'End If

                ListIDIterator = 0 ' Reset the iterator for new list
                ' Reset the format list and recalc
                ListRowFormats = New List(Of RowFormat)

                ' Disable all the controls individulally so we can use cancel button
                btnCalcPreview.Enabled = False
                btnCalcReset.Enabled = False
                btnCalcSelectColumns.Enabled = False
                btnCalcSaveSettings.Enabled = False
                btnCalcExportList.Enabled = False
                gbCalcBPSelect.Enabled = False
                gbCalcIncludeItems.Enabled = False
                gbCalcBPRace.Enabled = False
                gbCalcBPType.Enabled = False
                chkCalcNPCBPOs.Enabled = False
                gbCalcSizeLimit.Enabled = False
                gbCalcBPTech.Enabled = False
                gbCalcCompareType.Enabled = False
                gbCalcMarketFilters.Enabled = False
                gbCalcFilter.Enabled = False
                gbCalcIgnoreinCalcs.Enabled = False
                gbCalcIncludeOwned.Enabled = False
                gbCalcInvention.Enabled = False
                gbCalcProdLines.Enabled = False
                gbCalcRelics.Enabled = False
                gbCalcTextColors.Enabled = False
                gbCalcTextFilter.Enabled = False
                lstManufacturing.Enabled = False
                tabCalcFacilities.Enabled = False

                If Not UserApplicationSettings.DisableSVR Then

                    Dim MH As New MarketPriceInterface(pnlProgressBar)

                    ' First thing we want to do is update the manufactured item prices
                    pnlStatus.Text = "Updating Market History..."
                    pnlProgressBar.Visible = False
                    Application.DoEvents()

                    ' First find out which of the typeIDs in BaseItems have MarketID's
                    For i = 0 To BaseItems.Count - 1
                        TypeIDCheck = TypeIDCheck & BaseItems(i).ItemTypeID & ","
                    Next

                    ' Format string
                    TypeIDCheck = "(" & TypeIDCheck.Substring(0, Len(TypeIDCheck) - 1) & ")"
                    SQL = "SELECT typeID FROM INVENTORY_TYPES WHERE typeID IN " & TypeIDCheck & " AND marketGroupID IS NOT NULL"
                    DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
                    readerIDs = DBCommand.ExecuteReader

                    ' Now add these to the list
                    While readerIDs.Read()
                        If Not UpdateTypeIDs.Contains(readerIDs.GetInt64(0)) Then
                            UpdateTypeIDs.Add(readerIDs.GetInt64(0))
                        End If
                    End While
                    readerIDs.Close()

                    AveragePriceDays = CInt(cmbCalcAvgPriceDuration.Text)
                    ' Get the region ID
                    MarketRegionID = GetRegionID(cmbCalcHistoryRegion.Text)

                    If MarketRegionID = 0 Then
                        MarketRegionID = TheForgeTypeID ' The Forge as default
                        cmbCalcHistoryRegion.Text = "The Forge"
                    End If

                    ' Update the prices
                    If Not MH.UpdateESIPriceHistory(UpdateTypeIDs, MarketRegionID) Then
                        ' Update Failed, don't reload everything
                        Call MsgBox("Price update timed out for some items. Please try again.", vbInformation, Application.ProductName)
                    End If
                    If CancelThreading Then
                        ' They had a ton of errors
                        Call MsgBox("You had an excessive amount of errors while attempting to update price history and the process was canceled. Please try again later.", vbCritical, Application.ProductName)
                        CancelThreading = False
                    End If
                End If

                pnlStatus.Text = "Calculating..."
                pnlProgressBar.Minimum = 0
                pnlProgressBar.Maximum = TotalItemCount
                pnlProgressBar.Value = 0
                pnlProgressBar.Visible = True

                Application.DoEvents()

                ' Loop through the item list and calculate data
                For i = 0 To BaseItems.Count - 1

                    Application.DoEvents()

                    InsertItem = BaseItems(i)

                    ' If they cancel the calc
                    If CancelManufacturingTabCalc Then
                        GoTo ExitCalc
                    End If

                    ' Set the number of BPs
                    With InsertItem
                        If (.TechLevel = "T2" Or .TechLevel = "T3") And chkCalcAutoCalcT2NumBPs.Checked = True And (.BlueprintType = BPType.InventedBPC Or .BlueprintType = BPType.NotOwned) Then
                            ' For T3 or if they have calc checked, we will never have a BPO so determine the number of BPs
                            NumberofBlueprints = GetUsedNumBPs(.BPID, CInt(.TechLevel.Substring(1, 1)), .Runs, .ProductionLines, .NumBPs, .Decryptor.RunMod)
                        Else
                            NumberofBlueprints = CInt(txtCalcNumBPs.Text)
                        End If
                    End With

                    ' Construct the BP
                    ManufacturingBlueprint = New Blueprint(InsertItem.BPID, CInt(txtCalcRuns.Text), InsertItem.BPME, InsertItem.BPTE,
                                                           NumberofBlueprints, CInt(txtCalcProdLines.Text), SelectedCharacter,
                                                           UserApplicationSettings, rbtnCalcCompareBuildBuy.Checked, InsertItem.AddlCosts, InsertItem.BuildFacility,
                                                           InsertItem.ComponentManufacturingFacility, InsertItem.CapComponentManufacturingFacility, InsertItem.ReactionFacility,
                                                           chkCalcSellExessItems.Checked, UserManufacturingTabSettings.BuildT2T3Materials, True)

                    ' Set the T2 and T3 inputs if necessary
                    If ((InsertItem.TechLevel = "T2" Or InsertItem.TechLevel = "T3") And InsertItem.BlueprintType = BPType.InventedBPC) And chkCalcIgnoreInvention.Checked = False Then

                        ' Strip off the relic if in here for the decryptor
                        If InsertItem.Inputs.Contains("-") Then
                            InputText = InsertItem.Inputs.Substring(0, InStr(InsertItem.Inputs, "-") - 2)
                        Else
                            InputText = InsertItem.Inputs
                        End If

                        If InputText = None Then
                            SelectedDecryptor = NoDecryptor
                        Else ' A decryptor is set
                            SelectedDecryptor = InventionDecryptors.GetDecryptor(InputText)
                        End If

                        ' Construct the T2/T3 BP
                        Call ManufacturingBlueprint.InventBlueprint(CInt(txtCalcLabLines.Text), SelectedDecryptor, InsertItem.InventionFacility,
                                                               InsertItem.CopyFacility, GetInventItemTypeID(InsertItem.BPID, InsertItem.Relic))

                    End If

                    ' Build the blueprint(s)
                    Call ManufacturingBlueprint.BuildItems(chkCalcTaxes.Checked, GetBrokerFeeData(chkCalcFees, txtCalcBrokerFeeRate), False, chkCalcIgnoreMinerals.Checked, chkCalcIgnoreT1Item.Checked)

                    ' If checked, Add the values to the array only if we can Build, Invent, or RE it
                    AddItem = True

                    ' User can Build
                    If chkCalcCanBuild.Checked And Not ManufacturingBlueprint.UserCanBuildBlueprint Then
                        AddItem = False
                    End If

                    ' User can Invent
                    If chkCalcCanInvent.Checked And chkCalcCanInvent.Enabled And Not ManufacturingBlueprint.UserCanInventRE And (ManufacturingBlueprint.GetTechLevel = 2 Or ManufacturingBlueprint.GetTechLevel = 3) Then
                        AddItem = False
                    End If

                    ' Adjust the item with calculations
                    If AddItem Then
                        Application.DoEvents()
                        ' Add data that will the same for all options (need to move more from the bottom but have to test)
                        InsertItem.CanBuildBP = ManufacturingBlueprint.UserCanBuildBlueprint
                        InsertItem.CanInvent = ManufacturingBlueprint.UserCanInventRE
                        InsertItem.CanRE = ManufacturingBlueprint.UserCanInventRE
                        ' Trend data
                        InsertItem.PriceTrend = CalculatePriceTrend(InsertItem.ItemTypeID, MarketRegionID, CInt(cmbCalcAvgPriceDuration.Text))
                        InsertItem.ItemMarketPrice = ManufacturingBlueprint.GetItemMarketPrice

                        ' Add all the volume, items on hand, etc here since they won't change
                        InsertItem.TotalItemsSold = CalculateTotalItemsSold(InsertItem.ItemTypeID, MarketRegionID, CInt(cmbCalcAvgPriceDuration.Text))
                        InsertItem.TotalOrdersFilled = CalculateTotalOrdersFilled(InsertItem.ItemTypeID, MarketRegionID, CInt(cmbCalcAvgPriceDuration.Text))
                        InsertItem.AvgItemsperOrder = CDbl(IIf(InsertItem.TotalOrdersFilled = 0, 0, InsertItem.TotalItemsSold / InsertItem.TotalOrdersFilled))
                        Call GetCurrentOrders(InsertItem.ItemTypeID, MarketRegionID, InsertItem.CurrentBuyOrders, InsertItem.CurrentSellOrders)

                        InsertItem.ItemsinStock = GetTotalItemsinStock(InsertItem.ItemTypeID)
                        InsertItem.ItemsinProduction = GetTotalItemsinProduction(InsertItem.ItemTypeID)

                        ' Get the output data
                        If rbtnCalcCompareAll.Checked Then
                            ' Need to add a record for each of the three types

                            ' *** For components, only add if it has buildable components
                            If ManufacturingBlueprint.HasComponents Then
                                ' Components first
                                InsertItem.ProfitPercent = ManufacturingBlueprint.GetTotalComponentProfitPercent
                                InsertItem.Profit = ManufacturingBlueprint.GetTotalComponentProfit
                                InsertItem.IPH = ManufacturingBlueprint.GetTotalIskperHourComponents
                                InsertItem.CalcType = "Components"
                                InsertItem.SVR = GetItemSVR(InsertItem.ItemTypeID, MarketRegionID, AveragePriceDays, ManufacturingBlueprint.GetProductionTime, ManufacturingBlueprint.GetTotalUnits)
                                If InsertItem.SVR = "-" Then
                                    InsertItem.SVRxIPH = "0.00"
                                Else
                                    InsertItem.SVRxIPH = FormatNumber(CType(InsertItem.SVR, Double) * InsertItem.IPH, 2)
                                End If
                                InsertItem.TotalCost = ManufacturingBlueprint.GetTotalComponentCost
                                InsertItem.Taxes = ManufacturingBlueprint.GetSalesTaxes
                                InsertItem.BrokerFees = ManufacturingBlueprint.GetSalesBrokerFees
                                InsertItem.SingleInventedBPCRunsperBPC = ManufacturingBlueprint.GetSingleInventedBPCRuns
                                InsertItem.BaseJobCost = ManufacturingBlueprint.GetBaseJobCost
                                InsertItem.JobFee = ManufacturingBlueprint.GetJobFee
                                InsertItem.NumBPs = ManufacturingBlueprint.GetUsedNumBPs
                                InsertItem.InventionChance = ManufacturingBlueprint.GetInventionChance
                                InsertItem.Race = GetRace(ManufacturingBlueprint.GetRaceID)
                                InsertItem.VolumeperItem = ManufacturingBlueprint.GetItemVolume
                                InsertItem.TotalVolume = ManufacturingBlueprint.GetTotalItemVolume
                                InsertItem.MaterialCost = ManufacturingBlueprint.GetRawMaterials.GetTotalMaterialsCost
                                InsertItem.SellExcess = ManufacturingBlueprint.GetExcessMaterials.GetTotalMaterialsCost
                                InsertItem.ROI = ManufacturingBlueprint.GetTotalComponentProfit / ManufacturingBlueprint.GetTotalComponentCost

                                If chkCalcPPU.Checked Then
                                    InsertItem.DivideUnits = CInt(ManufacturingBlueprint.GetTotalUnits)
                                    InsertItem.PortionSize = 1
                                Else
                                    InsertItem.DivideUnits = 1
                                    InsertItem.PortionSize = CInt(ManufacturingBlueprint.GetTotalUnits)
                                End If

                                InsertItem.BPProductionTime = FormatIPHTime(ManufacturingBlueprint.GetProductionTime / InsertItem.DivideUnits)
                                InsertItem.TotalProductionTime = FormatIPHTime(ManufacturingBlueprint.GetProductionTime / InsertItem.DivideUnits) ' Total production time for components only is always the bp production time
                                InsertItem.CopyTime = FormatIPHTime(ManufacturingBlueprint.GetCopyTime / InsertItem.DivideUnits)
                                InsertItem.InventionTime = FormatIPHTime(ManufacturingBlueprint.GetInventionTime / InsertItem.DivideUnits)

                                If (ManufacturingBlueprint.GetTechLevel = BPTechLevel.T2 Or ManufacturingBlueprint.GetTechLevel = BPTechLevel.T3) _
                                    And (InsertItem.BlueprintType <> BPType.Original And InsertItem.BlueprintType <> BPType.Copy) Then
                                    InsertItem.InventionCost = ManufacturingBlueprint.GetInventionCost
                                Else
                                    InsertItem.InventionCost = 0
                                End If

                                If ManufacturingBlueprint.GetTechLevel = BPTechLevel.T2 Then
                                    InsertItem.CopyCost = ManufacturingBlueprint.GetCopyCost
                                Else
                                    InsertItem.CopyCost = 0
                                End If

                                ' Usage
                                InsertItem.BuildFacilityUsage = ManufacturingBlueprint.GetManufacturingFacilityUsage
                                ' Don't build components in this calculation
                                InsertItem.ComponentManufacturingFacilityUsage = 0
                                InsertItem.CapComponentManufacturingFacilityUsage = 0
                                InsertItem.CopyFacilityUsage = ManufacturingBlueprint.GetCopyUsage
                                InsertItem.InventionFacilityUsage = ManufacturingBlueprint.GetInventionUsage
                                InsertItem.ReprocessingFacilityUsage = ManufacturingBlueprint.GetReprocessingUsage

                                ' Save the bp
                                InsertItem.Blueprint = ManufacturingBlueprint

                                ' Insert Components Item
                                Call InsertManufacturingItem(InsertItem, SVRThresholdValue, chkCalcSVRIncludeNull.Checked, ManufacturingList, ListRowFormats)

                                ' Insert the item for decryptor compare
                                Call InsertDecryptorforOptimalCompare(ManufacturingBlueprint, InsertItem.CalcType, InsertItem.ListID, OptimalDecryptorItems)

                            End If

                            ' *** Raw Mats - always add
                            InsertItem.ProfitPercent = ManufacturingBlueprint.GetTotalRawProfitPercent
                            InsertItem.Profit = ManufacturingBlueprint.GetTotalRawProfit
                            InsertItem.IPH = ManufacturingBlueprint.GetTotalIskperHourRaw
                            InsertItem.CalcType = "Raw Materials"
                            InsertItem.SVR = GetItemSVR(InsertItem.ItemTypeID, MarketRegionID, AveragePriceDays, ManufacturingBlueprint.GetTotalProductionTime, ManufacturingBlueprint.GetTotalUnits)
                            If InsertItem.SVR = "-" Then
                                InsertItem.SVRxIPH = "0.00"
                            Else
                                InsertItem.SVRxIPH = FormatNumber(CType(InsertItem.SVR, Double) * InsertItem.IPH, 2)
                            End If
                            InsertItem.TotalCost = ManufacturingBlueprint.GetTotalBuildCost
                            InsertItem.Taxes = ManufacturingBlueprint.GetSalesTaxes
                            InsertItem.BrokerFees = ManufacturingBlueprint.GetSalesBrokerFees
                            InsertItem.SingleInventedBPCRunsperBPC = ManufacturingBlueprint.GetSingleInventedBPCRuns
                            InsertItem.BaseJobCost = ManufacturingBlueprint.GetBaseJobCost
                            InsertItem.JobFee = ManufacturingBlueprint.GetJobFee
                            InsertItem.NumBPs = ManufacturingBlueprint.GetUsedNumBPs
                            InsertItem.InventionChance = ManufacturingBlueprint.GetInventionChance
                            InsertItem.Race = GetRace(ManufacturingBlueprint.GetRaceID)
                            InsertItem.VolumeperItem = ManufacturingBlueprint.GetItemVolume
                            InsertItem.TotalVolume = ManufacturingBlueprint.GetTotalItemVolume
                            InsertItem.MaterialCost = ManufacturingBlueprint.GetRawMaterials.GetTotalMaterialsCost
                            InsertItem.SellExcess = ManufacturingBlueprint.GetExcessMaterials.GetTotalMaterialsCost
                            InsertItem.ROI = ManufacturingBlueprint.GetTotalComponentProfit / ManufacturingBlueprint.GetTotalComponentCost

                            If chkCalcPPU.Checked Then
                                InsertItem.DivideUnits = CInt(ManufacturingBlueprint.GetTotalUnits)
                                InsertItem.PortionSize = 1
                            Else
                                InsertItem.DivideUnits = 1
                                InsertItem.PortionSize = CInt(ManufacturingBlueprint.GetTotalUnits)
                            End If

                            InsertItem.BPProductionTime = FormatIPHTime(ManufacturingBlueprint.GetProductionTime / InsertItem.DivideUnits)
                            InsertItem.TotalProductionTime = FormatIPHTime(ManufacturingBlueprint.GetTotalProductionTime / InsertItem.DivideUnits)
                            InsertItem.CopyTime = FormatIPHTime(ManufacturingBlueprint.GetCopyTime / InsertItem.DivideUnits)
                            InsertItem.InventionTime = FormatIPHTime(ManufacturingBlueprint.GetInventionTime / InsertItem.DivideUnits)

                            If (ManufacturingBlueprint.GetTechLevel = BPTechLevel.T2 Or ManufacturingBlueprint.GetTechLevel = BPTechLevel.T3) _
                                    And (InsertItem.BlueprintType <> BPType.Original And InsertItem.BlueprintType <> BPType.Copy) Then
                                InsertItem.InventionCost = ManufacturingBlueprint.GetInventionCost
                            Else
                                InsertItem.InventionCost = 0
                            End If

                            If ManufacturingBlueprint.GetTechLevel = BPTechLevel.T2 And InsertItem.BlueprintType <> BPType.Original Then
                                InsertItem.CopyCost = ManufacturingBlueprint.GetCopyCost
                            Else
                                InsertItem.CopyCost = 0
                            End If

                            ' Usage
                            InsertItem.BuildFacilityUsage = ManufacturingBlueprint.GetManufacturingFacilityUsage
                            InsertItem.ComponentManufacturingFacilityUsage = ManufacturingBlueprint.GetComponentFacilityUsage
                            InsertItem.CapComponentManufacturingFacilityUsage = ManufacturingBlueprint.GetCapComponentFacilityUsage
                            InsertItem.ReactionFacilityUsage = ManufacturingBlueprint.GetTotalReactionFacilityUsage
                            InsertItem.CopyFacilityUsage = ManufacturingBlueprint.GetCopyUsage
                            InsertItem.InventionFacilityUsage = ManufacturingBlueprint.GetInventionUsage
                            InsertItem.ReprocessingFacilityUsage = ManufacturingBlueprint.GetReprocessingUsage

                            ' Save the bp
                            InsertItem.Blueprint = ManufacturingBlueprint

                            ' Insert Raw Mats item
                            Call InsertManufacturingItem(InsertItem, SVRThresholdValue, chkCalcSVRIncludeNull.Checked, ManufacturingList, ListRowFormats)

                            ' Insert the item for decryptor compare
                            Call InsertDecryptorforOptimalCompare(ManufacturingBlueprint, InsertItem.CalcType, InsertItem.ListID, OptimalDecryptorItems)

                            ' *** For Build/Buy we need to construct a new BP and add that
                            ' Construct the BP
                            ManufacturingBlueprint = New Blueprint(InsertItem.BPID, CInt(txtCalcRuns.Text), InsertItem.BPME, InsertItem.BPTE,
                                                        NumberofBlueprints, CInt(txtCalcProdLines.Text), SelectedCharacter,
                                                        UserApplicationSettings, True, InsertItem.AddlCosts, InsertItem.BuildFacility,
                                                        InsertItem.ComponentManufacturingFacility, InsertItem.CapComponentManufacturingFacility,
                                                        InsertItem.ReactionFacility, chkCalcSellExessItems.Checked, UserManufacturingTabSettings.BuildT2T3Materials, True)

                            If ((InsertItem.TechLevel = "T2" Or InsertItem.TechLevel = "T3") And InsertItem.BlueprintType = BPType.InventedBPC) And chkCalcIgnoreInvention.Checked = False Then
                                ' Construct the T2/T3 BP
                                ManufacturingBlueprint.InventBlueprint(CInt(txtCalcLabLines.Text), SelectedDecryptor, InsertItem.InventionFacility,
                                                                       InsertItem.CopyFacility, GetInventItemTypeID(InsertItem.BPID, InsertItem.Relic))

                            End If

                            ' Get the list of materials
                            Call ManufacturingBlueprint.BuildItems(chkCalcTaxes.Checked, GetBrokerFeeData(chkCalcFees, txtCalcBrokerFeeRate), False, chkCalcIgnoreMinerals.Checked, chkCalcIgnoreT1Item.Checked)

                            ' Build/Buy (add only if it has components we build)
                            If ManufacturingBlueprint.HasComponents Then
                                InsertItem.ProfitPercent = ManufacturingBlueprint.GetTotalRawProfitPercent
                                InsertItem.Profit = ManufacturingBlueprint.GetTotalRawProfit
                                InsertItem.IPH = ManufacturingBlueprint.GetTotalIskperHourRaw
                                InsertItem.CalcType = "Build/Buy"
                                InsertItem.SVR = GetItemSVR(InsertItem.ItemTypeID, MarketRegionID, AveragePriceDays, ManufacturingBlueprint.GetTotalProductionTime, ManufacturingBlueprint.GetTotalUnits)
                                If InsertItem.SVR = "-" Then
                                    InsertItem.SVRxIPH = "0.00"
                                Else
                                    InsertItem.SVRxIPH = FormatNumber(CType(InsertItem.SVR, Double) * InsertItem.IPH, 2)
                                End If
                                InsertItem.TotalCost = ManufacturingBlueprint.GetTotalBuildCost
                                InsertItem.Taxes = ManufacturingBlueprint.GetSalesTaxes
                                InsertItem.BrokerFees = ManufacturingBlueprint.GetSalesBrokerFees
                                InsertItem.SingleInventedBPCRunsperBPC = ManufacturingBlueprint.GetSingleInventedBPCRuns
                                InsertItem.BaseJobCost = ManufacturingBlueprint.GetBaseJobCost
                                InsertItem.JobFee = ManufacturingBlueprint.GetJobFee
                                InsertItem.NumBPs = ManufacturingBlueprint.GetUsedNumBPs
                                InsertItem.InventionChance = ManufacturingBlueprint.GetInventionChance
                                InsertItem.Race = GetRace(ManufacturingBlueprint.GetRaceID)
                                InsertItem.VolumeperItem = ManufacturingBlueprint.GetItemVolume
                                InsertItem.TotalVolume = ManufacturingBlueprint.GetTotalItemVolume
                                InsertItem.MaterialCost = ManufacturingBlueprint.GetRawMaterials.GetTotalMaterialsCost
                                InsertItem.SellExcess = ManufacturingBlueprint.GetExcessMaterials.GetTotalMaterialsCost
                                InsertItem.ROI = ManufacturingBlueprint.GetTotalComponentProfit / ManufacturingBlueprint.GetTotalComponentCost

                                If chkCalcPPU.Checked Then
                                    InsertItem.DivideUnits = CInt(ManufacturingBlueprint.GetTotalUnits)
                                    InsertItem.PortionSize = 1
                                Else
                                    InsertItem.DivideUnits = 1
                                    InsertItem.PortionSize = CInt(ManufacturingBlueprint.GetTotalUnits)
                                End If

                                InsertItem.BPProductionTime = FormatIPHTime(ManufacturingBlueprint.GetProductionTime / InsertItem.DivideUnits)
                                InsertItem.TotalProductionTime = FormatIPHTime(ManufacturingBlueprint.GetTotalProductionTime / InsertItem.DivideUnits)
                                InsertItem.CopyTime = FormatIPHTime(ManufacturingBlueprint.GetCopyTime / InsertItem.DivideUnits)
                                InsertItem.InventionTime = FormatIPHTime(ManufacturingBlueprint.GetInventionTime / InsertItem.DivideUnits)

                                If (ManufacturingBlueprint.GetTechLevel = BPTechLevel.T2 Or ManufacturingBlueprint.GetTechLevel = BPTechLevel.T3) _
                                    And (InsertItem.BlueprintType <> BPType.Original And InsertItem.BlueprintType <> BPType.Copy) Then
                                    InsertItem.InventionCost = ManufacturingBlueprint.GetInventionCost
                                Else
                                    InsertItem.InventionCost = 0
                                End If

                                If ManufacturingBlueprint.GetTechLevel = BPTechLevel.T2 And InsertItem.BlueprintType <> BPType.Original Then
                                    InsertItem.CopyCost = ManufacturingBlueprint.GetCopyCost
                                Else
                                    InsertItem.CopyCost = 0
                                End If

                                ' Usage
                                InsertItem.BuildFacilityUsage = ManufacturingBlueprint.GetManufacturingFacilityUsage
                                InsertItem.ComponentManufacturingFacilityUsage = ManufacturingBlueprint.GetComponentFacilityUsage
                                InsertItem.CapComponentManufacturingFacilityUsage = ManufacturingBlueprint.GetCapComponentFacilityUsage
                                InsertItem.ReactionFacilityUsage = ManufacturingBlueprint.GetReactionFacilityUsage
                                InsertItem.CopyFacilityUsage = ManufacturingBlueprint.GetCopyUsage
                                InsertItem.InventionFacilityUsage = ManufacturingBlueprint.GetInventionUsage
                                InsertItem.ReprocessingFacilityUsage = ManufacturingBlueprint.GetReprocessingUsage

                                ' Save the bp
                                InsertItem.Blueprint = ManufacturingBlueprint

                                ' Insert Build/Buy item
                                Call InsertManufacturingItem(InsertItem, SVRThresholdValue, chkCalcSVRIncludeNull.Checked, ManufacturingList, ListRowFormats)

                                ' Insert the item for decryptor compare
                                Call InsertDecryptorforOptimalCompare(ManufacturingBlueprint, InsertItem.CalcType, InsertItem.ListID, OptimalDecryptorItems)

                            End If
                        Else

                            ' Just look at each one individually
                            If rbtnCalcCompareComponents.Checked Then
                                ' Use the Component values
                                InsertItem.ProfitPercent = ManufacturingBlueprint.GetTotalComponentProfitPercent
                                InsertItem.Profit = ManufacturingBlueprint.GetTotalComponentProfit
                                InsertItem.IPH = ManufacturingBlueprint.GetTotalIskperHourComponents
                                InsertItem.CalcType = "Components"
                                InsertItem.SVR = GetItemSVR(InsertItem.ItemTypeID, MarketRegionID, AveragePriceDays, ManufacturingBlueprint.GetProductionTime, ManufacturingBlueprint.GetTotalUnits)
                                If InsertItem.SVR = "-" Then
                                    InsertItem.SVRxIPH = "0.00"
                                Else
                                    InsertItem.SVRxIPH = FormatNumber(CType(InsertItem.SVR, Double) * InsertItem.IPH, 2)
                                End If
                                InsertItem.TotalCost = ManufacturingBlueprint.GetTotalComponentCost
                            ElseIf rbtnCalcCompareRawMats.Checked Then
                                ' Use the Raw values 
                                InsertItem.ProfitPercent = ManufacturingBlueprint.GetTotalRawProfitPercent
                                InsertItem.Profit = ManufacturingBlueprint.GetTotalRawProfit
                                InsertItem.IPH = ManufacturingBlueprint.GetTotalIskperHourRaw
                                InsertItem.CalcType = "Raw Materials"
                                InsertItem.SVR = GetItemSVR(InsertItem.ItemTypeID, MarketRegionID, AveragePriceDays, ManufacturingBlueprint.GetTotalProductionTime, ManufacturingBlueprint.GetTotalUnits)
                                If InsertItem.SVR = "-" Then
                                    InsertItem.SVRxIPH = "0.00"
                                Else
                                    InsertItem.SVRxIPH = FormatNumber(CType(InsertItem.SVR, Double) * InsertItem.IPH, 2)
                                End If
                                InsertItem.TotalCost = ManufacturingBlueprint.GetTotalBuildCost
                            ElseIf rbtnCalcCompareBuildBuy.Checked Then
                                ' Use the Build/Buy best rate values (the blueprint was set to get these values above)
                                InsertItem.ProfitPercent = ManufacturingBlueprint.GetTotalRawProfitPercent
                                InsertItem.Profit = ManufacturingBlueprint.GetTotalRawProfit
                                InsertItem.IPH = ManufacturingBlueprint.GetTotalIskperHourRaw
                                InsertItem.CalcType = "Build/Buy"
                                InsertItem.SVR = GetItemSVR(InsertItem.ItemTypeID, MarketRegionID, AveragePriceDays, ManufacturingBlueprint.GetTotalProductionTime, ManufacturingBlueprint.GetTotalUnits)
                                If InsertItem.SVR = "-" Then
                                    InsertItem.SVRxIPH = "0.00"
                                Else
                                    InsertItem.SVRxIPH = FormatNumber(CType(InsertItem.SVR, Double) * InsertItem.IPH, 2)
                                End If
                                InsertItem.TotalCost = ManufacturingBlueprint.GetTotalBuildCost
                            End If

                            InsertItem.Taxes = ManufacturingBlueprint.GetSalesTaxes
                            InsertItem.BrokerFees = ManufacturingBlueprint.GetSalesBrokerFees
                            InsertItem.SingleInventedBPCRunsperBPC = ManufacturingBlueprint.GetSingleInventedBPCRuns
                            InsertItem.BaseJobCost = ManufacturingBlueprint.GetBaseJobCost
                            InsertItem.JobFee = ManufacturingBlueprint.GetJobFee
                            InsertItem.NumBPs = ManufacturingBlueprint.GetUsedNumBPs
                            InsertItem.InventionChance = ManufacturingBlueprint.GetInventionChance
                            InsertItem.Race = GetRace(ManufacturingBlueprint.GetRaceID)
                            InsertItem.VolumeperItem = ManufacturingBlueprint.GetItemVolume
                            InsertItem.TotalVolume = ManufacturingBlueprint.GetTotalItemVolume
                            InsertItem.MaterialCost = ManufacturingBlueprint.GetRawMaterials.GetTotalMaterialsCost
                            InsertItem.SellExcess = ManufacturingBlueprint.GetExcessMaterials.GetTotalMaterialsCost
                            InsertItem.ROI = ManufacturingBlueprint.GetTotalComponentProfit / ManufacturingBlueprint.GetTotalComponentCost

                            If chkCalcPPU.Checked Then
                                InsertItem.DivideUnits = CInt(ManufacturingBlueprint.GetTotalUnits)
                                InsertItem.PortionSize = 1
                            Else
                                InsertItem.DivideUnits = 1
                                InsertItem.PortionSize = CInt(ManufacturingBlueprint.GetTotalUnits)
                            End If

                            InsertItem.BPProductionTime = FormatIPHTime(ManufacturingBlueprint.GetProductionTime / InsertItem.DivideUnits)
                            If rbtnCalcCompareComponents.Checked Then
                                ' Total production time for components only is always the bp production time
                                InsertItem.TotalProductionTime = FormatIPHTime(ManufacturingBlueprint.GetProductionTime / InsertItem.DivideUnits)
                            Else
                                InsertItem.TotalProductionTime = FormatIPHTime(ManufacturingBlueprint.GetTotalProductionTime / InsertItem.DivideUnits)
                            End If

                            InsertItem.CopyTime = FormatIPHTime(ManufacturingBlueprint.GetCopyTime / InsertItem.DivideUnits)
                            InsertItem.InventionTime = FormatIPHTime(ManufacturingBlueprint.GetInventionTime / InsertItem.DivideUnits)

                            If (ManufacturingBlueprint.GetTechLevel = BPTechLevel.T2 Or ManufacturingBlueprint.GetTechLevel = BPTechLevel.T3) _
                                    And (InsertItem.BlueprintType <> BPType.Original And InsertItem.BlueprintType <> BPType.Copy) Then
                                InsertItem.InventionCost = ManufacturingBlueprint.GetInventionCost
                            Else
                                InsertItem.InventionCost = 0
                            End If

                            If ManufacturingBlueprint.GetTechLevel = BPTechLevel.T2 And InsertItem.BlueprintType <> BPType.Original Then
                                InsertItem.CopyCost = ManufacturingBlueprint.GetCopyCost
                            Else
                                InsertItem.CopyCost = 0
                            End If

                            ' Usage
                            ' If it's a reaction, we don't want to add the manufacturing usage for any fuel blocks if it's a component
                            Select Case InsertItem.ItemGroupID
                                Case ReactionGroupID(InsertItem.ItemGroupID)
                                    InsertItem.BuildFacilityUsage = 0
                                Case Else
                                    InsertItem.BuildFacilityUsage = ManufacturingBlueprint.GetManufacturingFacilityUsage
                            End Select
                            InsertItem.ComponentManufacturingFacilityUsage = ManufacturingBlueprint.GetComponentFacilityUsage
                            InsertItem.CapComponentManufacturingFacilityUsage = ManufacturingBlueprint.GetCapComponentFacilityUsage
                            InsertItem.ReactionFacilityUsage = ManufacturingBlueprint.GetReactionFacilityUsage
                            InsertItem.CopyFacilityUsage = ManufacturingBlueprint.GetCopyUsage
                            InsertItem.InventionFacilityUsage = ManufacturingBlueprint.GetInventionUsage
                            InsertItem.ReprocessingFacilityUsage = ManufacturingBlueprint.GetReprocessingUsage

                            ' Save the bp
                            InsertItem.Blueprint = ManufacturingBlueprint

                            ' Insert the chosen item
                            Call InsertManufacturingItem(InsertItem, SVRThresholdValue, chkCalcSVRIncludeNull.Checked, ManufacturingList, ListRowFormats)

                            ' Insert the item for decryptor compare
                            Call InsertDecryptorforOptimalCompare(ManufacturingBlueprint, InsertItem.CalcType, InsertItem.ListID, OptimalDecryptorItems)

                        End If

                    End If

                    ' For each record, update the progress bar
                    Call IncrementToolStripProgressBar(pnlProgressBar)

                Next

                ' Done processing the blueprints
                pnlProgressBar.Value = 0
                pnlProgressBar.Visible = False
                'Me.Cursor = Cursors.Default
                pnlStatus.Text = ""

                ' BPs were calcualted so enable it
                AddToShoppingListToolStripMenuItem.Enabled = True

            End If

        End If

        ' **********************************************************************
        ' *** Display results in grid - use for both calcuations and preview ***
        ' **********************************************************************
DisplayResults:

        ' Reset the columns before processing data
        Call RefreshManufacturingTabColumns()

        Dim NumManufacturingItems As Integer

        ' If no records first, then don't let them try and refresh nothing
        If IsNothing(FinalManufacturingItemList) And SavedRefreshValue Then
            Exit Sub
        End If

        If Not SavedRefreshValue Then
            ' Calc or new display data
            NumManufacturingItems = ManufacturingList.Count

            If NumManufacturingItems = 0 Then
                If Not Calculate Then
                    FinalManufacturingItemList = BaseItems ' Save for later use, this was just display
                Else
                    FinalManufacturingItemList = Nothing ' It didn't calculate anything, so just clear the grid and exit
                    lstManufacturing.Items.Clear()
                    GoTo ExitCalc
                End If
            Else
                ' Use Current data lists and save
                FinalManufacturingItemList = ManufacturingList
            End If
        Else
            ' Use pre-calc'd or loaded list
            NumManufacturingItems = FinalManufacturingItemList.Count
        End If

        ' Remove only but the optimal decryptor items before final display, and set the final list
        FinalItemList = SetOptimalDecryptorList(FinalManufacturingItemList, OptimalDecryptorItems)

        pnlProgressBar.Minimum = 0
        pnlProgressBar.Maximum = FinalItemList.Count
        pnlProgressBar.Value = 0
        pnlProgressBar.Visible = True

        lstManufacturing.Items.Clear()
        lstManufacturing.BeginUpdate()
        ' Disable sorting because it will crawl after we update if there are too many records
        lstManufacturing.ListViewItemSorter = Nothing
        lstManufacturing.SmallImageList = CalcImageList
        ' Set the formats before drawing
        lstManufacturing.SetRowFormats(ListRowFormats)

        pnlStatus.Text = "Refreshing List..."

        Dim BonusString As String = ""

        ' Load the final grid
        For i = 0 To FinalItemList.Count - 1
            Application.DoEvents()

            BPList = New ListViewItem(CStr(FinalItemList(i).ListID)) ' Always the first item

            If FinalItemList(i).DivideUnits = 0 Then
                ' So the display will show zeros instead of NaN (divide by zero)
                FinalItemList(i).DivideUnits = 1
            End If

            ' If the bp is a blueprint, change the reaction facility equal to the manufacturing facility (used in bp)
            ' and the manufacturing facility equal to the component facility
            Select Case FinalItemList(i).ItemGroup
                Case "Composite", "Biochemical Material", "Hybrid Polymers", "Intermediate Materials"
                    FinalItemList(i).ReactionFacility = CType(FinalItemList(i).BuildFacility.Clone, IndustryFacility)
                    FinalItemList(i).BuildFacility = CType(FinalItemList(i).ComponentManufacturingFacility.Clone, IndustryFacility) ' fuel blocks
            End Select

            For j = 1 To ColumnPositions.Count - 1
                Select Case ColumnPositions(j)
                    Case ProgramSettings.ItemCategoryColumnName
                        BPList.SubItems.Add(FinalItemList(i).ItemCategory)
                    Case ProgramSettings.ItemGroupColumnName
                        BPList.SubItems.Add(FinalItemList(i).ItemGroup)
                    Case ProgramSettings.ItemNameColumnName
                        BPList.SubItems.Add(FinalItemList(i).ItemName)
                    Case ProgramSettings.OwnedColumnName
                        BPList.SubItems.Add(FinalItemList(i).Owned)
                    Case ProgramSettings.TechColumnName
                        BPList.SubItems.Add(FinalItemList(i).TechLevel)
                    Case ProgramSettings.BPMEColumnName
                        BPList.SubItems.Add(CStr(FinalItemList(i).BPME))
                    Case ProgramSettings.BPTEColumnName
                        BPList.SubItems.Add(CStr(FinalItemList(i).BPTE))
                    Case ProgramSettings.InputsColumnName
                        BPList.SubItems.Add(FinalItemList(i).Inputs)
                    Case ProgramSettings.ComparedColumnName
                        BPList.SubItems.Add(FinalItemList(i).CalcType)
                    Case ProgramSettings.TotalRunsColumnName
                        BPList.SubItems.Add(CStr(FinalItemList(i).Runs))
                    Case ProgramSettings.SingleInventedBPCRunsColumnName
                        BPList.SubItems.Add(CStr(FinalItemList(i).SingleInventedBPCRunsperBPC))
                    Case ProgramSettings.ProductionLinesColumnName
                        BPList.SubItems.Add(CStr(FinalItemList(i).ProductionLines))
                    Case ProgramSettings.LaboratoryLinesColumnName
                        BPList.SubItems.Add(CStr(FinalItemList(i).LaboratoryLines))
                    Case ProgramSettings.TotalInventionCostColumnName
                        BPList.SubItems.Add(FormatNumber(FinalItemList(i).InventionCost / FinalItemList(i).DivideUnits, 2))
                    Case ProgramSettings.TotalCopyCostColumnName
                        BPList.SubItems.Add(FormatNumber(FinalItemList(i).CopyCost / FinalItemList(i).DivideUnits, 2))
                    Case ProgramSettings.TaxesColumnName
                        BPList.SubItems.Add(FormatNumber(FinalItemList(i).Taxes / FinalItemList(i).DivideUnits, 2))
                    Case ProgramSettings.BrokerFeesColumnName
                        BPList.SubItems.Add(FormatNumber(FinalItemList(i).BrokerFees / FinalItemList(i).DivideUnits, 2))
                    Case ProgramSettings.BPProductionTimeColumnName
                        BPList.SubItems.Add(FinalItemList(i).BPProductionTime)
                    Case ProgramSettings.TotalProductionTimeColumnName
                        BPList.SubItems.Add(FinalItemList(i).TotalProductionTime)
                    Case ProgramSettings.CopyTimeColumnName
                        BPList.SubItems.Add(FinalItemList(i).CopyTime)
                    Case ProgramSettings.InventionTimeColumnName
                        BPList.SubItems.Add(FinalItemList(i).InventionTime)
                    Case ProgramSettings.ItemMarketPriceColumnName
                        BPList.SubItems.Add(FormatNumber(FinalItemList(i).ItemMarketPrice / FinalItemList(i).DivideUnits, 2))
                    Case ProgramSettings.ProfitColumnName
                        BPList.SubItems.Add(FormatNumber(FinalItemList(i).Profit / FinalItemList(i).DivideUnits, 2))
                    Case ProgramSettings.ProfitPercentageColumnName
                        BPList.SubItems.Add(FormatPercent(FinalItemList(i).ProfitPercent, 2))
                    Case ProgramSettings.IskperHourColumnName
                        BPList.SubItems.Add(FormatNumber(FinalItemList(i).IPH, 2))
                    Case ProgramSettings.SVRColumnName
                        BPList.SubItems.Add(FinalItemList(i).SVR)
                    Case ProgramSettings.SVRxIPHColumnName
                        BPList.SubItems.Add(FinalItemList(i).SVRxIPH)
                    Case ProgramSettings.PriceTrendColumnName
                        BPList.SubItems.Add(FormatPercent(FinalItemList(i).PriceTrend, 2))
                    Case ProgramSettings.TotalItemsSoldColumnName
                        BPList.SubItems.Add(FormatNumber(FinalItemList(i).TotalItemsSold, 0))
                    Case ProgramSettings.TotalOrdersFilledColumnName
                        BPList.SubItems.Add(FormatNumber(FinalItemList(i).TotalOrdersFilled, 0))
                    Case ProgramSettings.AvgItemsperOrderColumnName
                        BPList.SubItems.Add(FormatNumber(FinalItemList(i).AvgItemsperOrder, 2))
                    Case ProgramSettings.CurrentSellOrdersColumnName
                        BPList.SubItems.Add(FormatNumber(FinalItemList(i).CurrentSellOrders, 0))
                    Case ProgramSettings.CurrentBuyOrdersColumnName
                        BPList.SubItems.Add(FormatNumber(FinalItemList(i).CurrentBuyOrders, 0))
                    Case ProgramSettings.ItemsinStockColumnName
                        BPList.SubItems.Add(FormatNumber(FinalItemList(i).ItemsinStock, 0))
                    Case ProgramSettings.ItemsinProductionColumnName
                        BPList.SubItems.Add(FormatNumber(FinalItemList(i).ItemsinProduction, 0))
                    Case ProgramSettings.TotalCostColumnName
                        BPList.SubItems.Add(FormatNumber(FinalItemList(i).TotalCost / FinalItemList(i).DivideUnits, 2))
                    Case ProgramSettings.BaseJobCostColumnName
                        BPList.SubItems.Add(FormatNumber(FinalItemList(i).BaseJobCost / FinalItemList(i).DivideUnits, 2))
                    Case ProgramSettings.NumBPsColumnName
                        BPList.SubItems.Add(CStr(FinalItemList(i).NumBPs))
                    Case ProgramSettings.InventionChanceColumnName
                        BPList.SubItems.Add(FormatPercent(FinalItemList(i).InventionChance, 2))
                    Case ProgramSettings.BPTypeColumnName
                        BPList.SubItems.Add(GetBPTypeString(FinalItemList(i).BlueprintType))
                    Case ProgramSettings.RaceColumnName
                        BPList.SubItems.Add(FinalItemList(i).Race)
                    Case ProgramSettings.VolumeperItemColumnName
                        BPList.SubItems.Add(FormatNumber(FinalItemList(i).VolumeperItem, 2))
                    Case ProgramSettings.TotalVolumeColumnName
                        BPList.SubItems.Add(FormatNumber(FinalItemList(i).TotalVolume / FinalItemList(i).DivideUnits, 2))
                    Case ProgramSettings.PortionSizeColumnName
                        BPList.SubItems.Add(FormatNumber(FinalItemList(i).PortionSize, 0))
                    Case ProgramSettings.MaterialCostColumnName
                        BPList.SubItems.Add(FormatNumber(FinalItemList(i).MaterialCost, 2))
                    Case ProgramSettings.SellExcessColumnName
                        BPList.SubItems.Add(FormatNumber(FinalItemList(i).SellExcess, 2))
                    Case ProgramSettings.ROIColumnName
                        BPList.SubItems.Add(FormatPercent(FinalItemList(i).ROI, 2))

                    Case ProgramSettings.ManufacturingJobFeeColumnName
                        BPList.SubItems.Add(FormatNumber(FinalItemList(i).JobFee / FinalItemList(i).DivideUnits, 2))
                    Case ProgramSettings.ManufacturingFacilityNameColumnName
                        BPList.SubItems.Add(FinalItemList(i).BuildFacility.FacilityName)
                    Case ProgramSettings.ManufacturingFacilitySystemColumnName
                        BPList.SubItems.Add(FinalItemList(i).BuildFacility.SolarSystemName)
                    Case ProgramSettings.ManufacturingFacilitySystemIndexColumnName
                        BPList.SubItems.Add(FormatNumber(FinalItemList(i).BuildFacility.CostIndex, 5))
                    Case ProgramSettings.ManufacturingFacilityTaxColumnName
                        BPList.SubItems.Add(FormatPercent(FinalItemList(i).BuildFacility.TaxRate, 1))
                    Case ProgramSettings.ManufacturingFacilityRegionColumnName
                        BPList.SubItems.Add(FinalItemList(i).BuildFacility.RegionName)
                    Case ProgramSettings.ManufacturingFacilityMEBonusColumnName
                        BPList.SubItems.Add(CStr(FinalItemList(i).BuildFacility.MaterialMultiplier))
                    Case ProgramSettings.ManufacturingFacilityTEBonusColumnName
                        BPList.SubItems.Add(CStr(FinalItemList(i).BuildFacility.TimeMultiplier))
                    Case ProgramSettings.ManufacturingFacilityUsageColumnName
                        BPList.SubItems.Add(FormatNumber(FinalItemList(i).BuildFacilityUsage / FinalItemList(i).DivideUnits, 2))
                    Case ProgramSettings.ManufacturingFacilityFWSystemLevelColumnName
                        BPList.SubItems.Add(CStr(FinalItemList(i).BuildFacility.FWUpgradeLevel))

                    Case ProgramSettings.ComponentFacilityNameColumnName
                        BPList.SubItems.Add(FinalItemList(i).ComponentManufacturingFacility.FacilityName)
                    Case ProgramSettings.ComponentFacilitySystemColumnName
                        BPList.SubItems.Add(FinalItemList(i).ComponentManufacturingFacility.SolarSystemName)
                    Case ProgramSettings.ComponentFacilitySystemIndexColumnName
                        BPList.SubItems.Add(FormatNumber(FinalItemList(i).ComponentManufacturingFacility.CostIndex, 5))
                    Case ProgramSettings.ComponentFacilityTaxColumnName
                        BPList.SubItems.Add(FormatPercent(FinalItemList(i).ComponentManufacturingFacility.TaxRate, 1))
                    Case ProgramSettings.ComponentFacilityRegionColumnName
                        BPList.SubItems.Add(FinalItemList(i).ComponentManufacturingFacility.RegionName)
                    Case ProgramSettings.ComponentFacilityMEBonusColumnName
                        BPList.SubItems.Add(CStr(FinalItemList(i).ComponentManufacturingFacility.MaterialMultiplier))
                    Case ProgramSettings.ComponentFacilityTEBonusColumnName
                        BPList.SubItems.Add(CStr(FinalItemList(i).ComponentManufacturingFacility.TimeMultiplier))
                    Case ProgramSettings.ComponentFacilityUsageColumnName
                        BPList.SubItems.Add(FormatNumber(FinalItemList(i).ComponentManufacturingFacilityUsage / FinalItemList(i).DivideUnits, 2))
                    Case ProgramSettings.ComponentFacilityFWSystemLevelColumnName
                        BPList.SubItems.Add(CStr(FinalItemList(i).ComponentManufacturingFacility.FWUpgradeLevel))

                    Case ProgramSettings.CapComponentFacilityNameColumnName
                        BPList.SubItems.Add(FinalItemList(i).CapComponentManufacturingFacility.FacilityName)
                    Case ProgramSettings.CapComponentFacilitySystemColumnName
                        BPList.SubItems.Add(FinalItemList(i).CapComponentManufacturingFacility.SolarSystemName)
                    Case ProgramSettings.CapComponentFacilitySystemIndexColumnName
                        BPList.SubItems.Add(FormatNumber(FinalItemList(i).CapComponentManufacturingFacility.CostIndex, 5))
                    Case ProgramSettings.CapComponentFacilityTaxColumnName
                        BPList.SubItems.Add(FormatPercent(FinalItemList(i).CapComponentManufacturingFacility.TaxRate, 1))
                    Case ProgramSettings.CapComponentFacilityRegionColumnName
                        BPList.SubItems.Add(FinalItemList(i).CapComponentManufacturingFacility.RegionName)
                    Case ProgramSettings.CapComponentFacilityMEBonusColumnName
                        BPList.SubItems.Add(CStr(FinalItemList(i).CapComponentManufacturingFacility.MaterialMultiplier))
                    Case ProgramSettings.CapComponentFacilityTEBonusColumnName
                        BPList.SubItems.Add(CStr(FinalItemList(i).CapComponentManufacturingFacility.TimeMultiplier))
                    Case ProgramSettings.CapComponentFacilityUsageColumnName
                        BPList.SubItems.Add(FormatNumber(FinalItemList(i).CapComponentManufacturingFacilityUsage / FinalItemList(i).DivideUnits, 2))
                    Case ProgramSettings.CapComponentFacilityFWSystemLevelColumnName
                        BPList.SubItems.Add(CStr(FinalItemList(i).CapComponentManufacturingFacility.FWUpgradeLevel))

                    Case ProgramSettings.CopyingFacilityNameColumnName
                        BPList.SubItems.Add(FinalItemList(i).CopyFacility.FacilityName)
                    Case ProgramSettings.CopyingFacilitySystemColumnName
                        BPList.SubItems.Add(FinalItemList(i).CopyFacility.SolarSystemName)
                    Case ProgramSettings.CopyingFacilitySystemIndexColumnName
                        BPList.SubItems.Add(FormatNumber(FinalItemList(i).CopyFacility.CostIndex, 5))
                    Case ProgramSettings.CopyingFacilityTaxColumnName
                        BPList.SubItems.Add(FormatPercent(FinalItemList(i).CopyFacility.TaxRate, 1))
                    Case ProgramSettings.CopyingFacilityRegionColumnName
                        BPList.SubItems.Add(FinalItemList(i).CopyFacility.RegionName)
                    Case ProgramSettings.CopyingFacilityMEBonusColumnName
                        BPList.SubItems.Add(CStr(FinalItemList(i).CopyFacility.MaterialMultiplier))
                    Case ProgramSettings.CopyingFacilityTEBonusColumnName
                        BPList.SubItems.Add(CStr(FinalItemList(i).CopyFacility.TimeMultiplier))
                    Case ProgramSettings.CopyingFacilityUsageColumnName
                        BPList.SubItems.Add(FormatNumber(FinalItemList(i).CopyFacilityUsage / FinalItemList(i).DivideUnits, 2))
                    Case ProgramSettings.CopyingFacilityFWSystemLevelColumnName
                        BPList.SubItems.Add(CStr(FinalItemList(i).CopyFacility.FWUpgradeLevel))

                    Case ProgramSettings.InventionFacilityNameColumnName
                        BPList.SubItems.Add(FinalItemList(i).InventionFacility.FacilityName)
                    Case ProgramSettings.InventionFacilitySystemColumnName
                        BPList.SubItems.Add(FinalItemList(i).InventionFacility.SolarSystemName)
                    Case ProgramSettings.InventionFacilitySystemIndexColumnName
                        BPList.SubItems.Add(FormatNumber(FinalItemList(i).InventionFacility.CostIndex, 5))
                    Case ProgramSettings.InventionFacilityTaxColumnName
                        BPList.SubItems.Add(FormatPercent(FinalItemList(i).InventionFacility.TaxRate, 1))
                    Case ProgramSettings.InventionFacilityRegionColumnName
                        BPList.SubItems.Add(FinalItemList(i).InventionFacility.RegionName)
                    Case ProgramSettings.InventionFacilityMEBonusColumnName
                        BPList.SubItems.Add(CStr(FinalItemList(i).InventionFacility.MaterialMultiplier))
                    Case ProgramSettings.InventionFacilityTEBonusColumnName
                        BPList.SubItems.Add(CStr(FinalItemList(i).InventionFacility.TimeMultiplier))
                    Case ProgramSettings.InventionFacilityUsageColumnName
                        BPList.SubItems.Add(FormatNumber(FinalItemList(i).InventionFacilityUsage / FinalItemList(i).DivideUnits, 2))
                    Case ProgramSettings.InventionFacilityFWSystemLevelColumnName
                        BPList.SubItems.Add(CStr(FinalItemList(i).InventionFacility.FWUpgradeLevel))

                    Case ProgramSettings.ReactionFacilityNameColumnName
                        BPList.SubItems.Add(FinalItemList(i).ReactionFacility.FacilityName)
                    Case ProgramSettings.ReactionFacilitySystemColumnName
                        BPList.SubItems.Add(FinalItemList(i).ReactionFacility.SolarSystemName)
                    Case ProgramSettings.ReactionFacilitySystemIndexColumnName
                        BPList.SubItems.Add(FormatNumber(FinalItemList(i).ReactionFacility.CostIndex, 5))
                    Case ProgramSettings.ReactionFacilityTaxColumnName
                        BPList.SubItems.Add(FormatPercent(FinalItemList(i).ReactionFacility.TaxRate, 1))
                    Case ProgramSettings.ReactionFacilityRegionColumnName
                        BPList.SubItems.Add(FinalItemList(i).ReactionFacility.RegionName)
                    Case ProgramSettings.ReactionFacilityMEBonusColumnName
                        BPList.SubItems.Add(CStr(FinalItemList(i).ReactionFacility.MaterialMultiplier))
                    Case ProgramSettings.ReactionFacilityTEBonusColumnName
                        BPList.SubItems.Add(CStr(FinalItemList(i).ReactionFacility.TimeMultiplier))
                    Case ProgramSettings.ReactionFacilityUsageColumnName
                        BPList.SubItems.Add(FormatNumber(FinalItemList(i).ReactionFacilityUsage / FinalItemList(i).DivideUnits, 2))
                    Case ProgramSettings.ReactionFacilityFWSystemLevelColumnName
                        BPList.SubItems.Add(CStr(FinalItemList(i).ReactionFacility.FWUpgradeLevel))

                    Case ProgramSettings.ReprocessingFacilityNameColumnName
                        BPList.SubItems.Add(If(Not IsNothing(FinalItemList(i).ReprocessingFacility), FinalItemList(i).ReprocessingFacility.FacilityName, ""))
                    Case ProgramSettings.ReprocessingFacilitySystemColumnName
                        BPList.SubItems.Add(If(Not IsNothing(FinalItemList(i).ReprocessingFacility), FinalItemList(i).ReprocessingFacility.SolarSystemName, ""))
                    Case ProgramSettings.ReprocessingFacilityTaxColumnName
                        BPList.SubItems.Add(If(Not IsNothing(FinalItemList(i).ReprocessingFacility), FormatPercent(FinalItemList(i).ReprocessingFacility.TaxRate, 1), ""))
                    Case ProgramSettings.ReprocessingFacilityRegionColumnName
                        BPList.SubItems.Add(If(Not IsNothing(FinalItemList(i).ReprocessingFacility), FinalItemList(i).ReprocessingFacility.RegionName, ""))
                    Case ProgramSettings.ReprocessingFacilityOreRefineRateColumnName
                        BPList.SubItems.Add(If(Not IsNothing(FinalItemList(i).ReprocessingFacility), CStr(FinalItemList(i).ReprocessingFacility.OreFacilityRefineRate), ""))
                    Case ProgramSettings.ReprocessingFacilityIceRefineRateColumnName
                        BPList.SubItems.Add(If(Not IsNothing(FinalItemList(i).ReprocessingFacility), CStr(FinalItemList(i).ReprocessingFacility.IceFacilityRefineRate), ""))
                    Case ProgramSettings.ReprocessingFacilityMoonRefineRateColumnName
                        BPList.SubItems.Add(If(Not IsNothing(FinalItemList(i).ReprocessingFacility), CStr(FinalItemList(i).ReprocessingFacility.MoonOreFacilityRefineRate), ""))
                    Case ProgramSettings.ReprocessingFacilityUsageColumnName
                        BPList.SubItems.Add(FormatNumber(FinalItemList(i).ReprocessingFacilityUsage / FinalItemList(i).DivideUnits, 2))

                End Select
            Next

            ' Add the record
            Call lstManufacturing.Items.Add(BPList)

            ' For each record, update the progress bar
            Call IncrementToolStripProgressBar(pnlProgressBar)

        Next

        Dim TempType As SortOrder

        ' Now sort this
        If ManufacturingColumnSortType = SortOrder.Ascending Then
            TempType = SortOrder.Descending
        Else
            TempType = SortOrder.Ascending
        End If

        ' Sort the list based on the saved column, if they change the number of columns below value, then find IPH, if not there, use column 0
        If ManufacturingColumnClicked > lstManufacturing.Columns.Count Then
            ' Find the IPH column
            If UserManufacturingTabColumnSettings.IskperHour <> 0 Then
                ManufacturingColumnClicked = UserManufacturingTabColumnSettings.IskperHour
            Else
                ManufacturingColumnClicked = 0 ' Default, will always be there
            End If

        End If

        ' Sort away
        Call ListViewColumnSorter(ManufacturingColumnClicked, CType(lstManufacturing, ListView), ManufacturingColumnClicked, TempType)

        lstManufacturing.EndUpdate()

ExitCalc:
        pnlProgressBar.Value = 0
        pnlProgressBar.Visible = False
        pnlStatus.Text = ""
        lstManufacturing.EndUpdate()

        ' Enable all the controls
        btnCalcPreview.Enabled = True
        btnCalcReset.Enabled = True
        btnCalcSelectColumns.Enabled = True
        btnCalcSaveSettings.Enabled = True
        btnCalcExportList.Enabled = True
        gbCalcMarketFilters.Enabled = True
        gbCalcBPSelect.Enabled = True
        gbCalcIncludeItems.Enabled = True
        gbCalcBPRace.Enabled = True
        gbCalcBPType.Enabled = True
        chkCalcNPCBPOs.Enabled = True
        gbCalcSizeLimit.Enabled = True
        gbCalcBPTech.Enabled = True
        gbCalcCompareType.Enabled = True
        gbCalcFilter.Enabled = True
        gbCalcIgnoreinCalcs.Enabled = True
        gbCalcIncludeOwned.Enabled = True
        gbCalcInvention.Enabled = True
        gbCalcProdLines.Enabled = True
        gbCalcRelics.Enabled = True
        gbCalcTextColors.Enabled = True
        gbCalcTextFilter.Enabled = True
        lstManufacturing.Enabled = True
        tabCalcFacilities.Enabled = True

        Application.UseWaitCursor = False
        Me.Cursor = Cursors.Default
        Application.DoEvents()

        If lstManufacturing.Items.Count = 0 And Not CancelManufacturingTabCalc Then
            MsgBox("No Blueprints calculated for options selected.", vbExclamation, Application.ProductName)
        End If

        If Not Calculate Or CancelManufacturingTabCalc Then
            Call ResetRefresh()
            CancelManufacturingTabCalc = False
        Else
            btnCalcCalculate.Text = "Refresh"
            RefreshCalcData = True ' Allow data to be refreshed since we just calcuated
        End If

    End Sub

    ' Finds the total items sold over the time period for the region sent
    Private Function CalculateTotalItemsSold(ByVal TypeID As Long, ByVal RegionID As Long, DaysfromToday As Integer) As Long
        Dim SQL As String
        Dim rsItems As SQLiteDataReader
        Dim Volume As Long = 0

        SQL = "SELECT SUM(TOTAL_VOLUME_FILLED) FROM MARKET_HISTORY WHERE TYPE_ID = " & CStr(TypeID) & " AND REGION_ID = " & CStr(RegionID) & " "
        SQL &= "AND DATETIME(PRICE_HISTORY_DATE) >= " & " DateTime('" & Format(DateAdd(DateInterval.Day, -(DaysfromToday + 1), Date.UtcNow.Date), SQLiteDateFormat) & "') "
        SQL &= "AND DATETIME(PRICE_HISTORY_DATE) < " & " DateTime('" & Format(Date.UtcNow.Date, SQLiteDateFormat) & "') "
        DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
        rsItems = DBCommand.ExecuteReader

        If rsItems.Read() And Not IsDBNull(rsItems.GetValue(0)) Then
            Volume = rsItems.GetInt64(0)
        End If

        rsItems.Close()

        Return Volume

    End Function

    ' Finds the total orders filled over the time period for the region sent
    Private Function CalculateTotalOrdersFilled(ByVal TypeID As Long, ByVal RegionID As Long, DaysfromToday As Integer) As Long
        Dim SQL As String
        Dim rsItems As SQLiteDataReader
        Dim Volume As Long = 0

        SQL = "SELECT SUM(TOTAL_ORDERS_FILLED) FROM MARKET_HISTORY WHERE TYPE_ID = " & CStr(TypeID) & " AND REGION_ID = " & CStr(RegionID) & " "
        SQL &= "AND DATETIME(PRICE_HISTORY_DATE) >= " & " DateTime('" & Format(DateAdd(DateInterval.Day, -(DaysfromToday + 1), Date.UtcNow.Date), SQLiteDateFormat) & "') "
        SQL &= "AND DATETIME(PRICE_HISTORY_DATE) < " & " DateTime('" & Format(Date.UtcNow.Date, SQLiteDateFormat) & "') "
        DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
        rsItems = DBCommand.ExecuteReader

        If rsItems.Read() And Not IsDBNull(rsItems.GetValue(0)) Then
            Volume = rsItems.GetInt64(0)
        End If

        rsItems.Close()

        Return Volume

    End Function

    ' Finds the average items sold per order over the time period for the region sent, and sets the two by reference
    Private Sub GetCurrentOrders(ByVal TypeID As Long, ByVal RegionID As Long, ByRef BuyOrders As Long, ByRef SellOrders As Long)
        Dim SQL As String
        Dim rsItems As SQLiteDataReader

        SQL = "SELECT IS_BUY_ORDER, SUM(VOLUME_REMAINING) FROM (SELECT * FROM MARKET_ORDERS UNION ALL SELECT * FROM STRUCTURE_MARKET_ORDERS) "
        SQL &= "WHERE TYPE_ID = " & CStr(TypeID) & " And REGION_ID = " & CStr(RegionID) & " "
        SQL &= "GROUP BY IS_BUY_ORDER"
        DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
        rsItems = DBCommand.ExecuteReader

        While rsItems.Read
            If rsItems.GetInt32(0) = 0 Then
                SellOrders = rsItems.GetInt64(1)
            Else
                BuyOrders = rsItems.GetInt64(1)
            End If
        End While

        rsItems.Close()

    End Sub

    ' Finds the number of items in stock for the asset settings set here
    Private Function GetTotalItemsinStock(ByVal TypeID As Long) As Integer
        Dim SQL As String
        Dim readerAssets As SQLiteDataReader
        Dim CurrentItemName As String = ""
        Dim ItemQuantity As Integer = 0

        Application.UseWaitCursor = True
        Me.Cursor = Cursors.WaitCursor
        Application.DoEvents()

        Dim IDString As String = ""

        ' Set the ID string we will use to update
        If UserAssetWindowShoppingListSettings.AssetType = "Both" Then
            IDString = CStr(SelectedCharacter.ID) & "," & CStr(SelectedCharacter.CharacterCorporation.CorporationID)
        ElseIf UserAssetWindowShoppingListSettings.AssetType = "Personal" Then
            IDString = CStr(SelectedCharacter.ID)
        ElseIf UserAssetWindowShoppingListSettings.AssetType = "Corporation" Then
            IDString = CStr(SelectedCharacter.CharacterCorporation.CorporationID)
        End If

        ' Build the where clause to look up data
        Dim AssetLocationFlagList As New List(Of String)
        ' First look up the location and flagID pairs - unique ID of asset locations
        SQL = "SELECT LocationID, FlagID FROM ASSET_LOCATIONS WHERE EnumAssetType = " & CStr(AssetWindow.ManufacturingTab) & " And ID IN (" & IDString & ")"
        DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
        readerAssets = DBCommand.ExecuteReader

        While readerAssets.Read
            If readerAssets.GetInt32(1) = -4 Then
                ' If the flag is the base location, then we want all items at the location id
                AssetLocationFlagList.Add("(LocationID = " & CStr(readerAssets.GetInt64(0)) & ")")
            Else
                AssetLocationFlagList.Add("(LocationID = " & CStr(readerAssets.GetInt64(0)) & " And Flag = " & CStr(readerAssets.GetInt32(1)) & ")")
            End If
        End While

        readerAssets.Close()

        ' Look up each item in their assets in their locations stored, and sum up the quantity'
        ' Split into groups to run (1000 identifiers max so limit to 900)
        Dim Splits As Integer = CInt(Math.Ceiling(AssetLocationFlagList.Count / 900))
        For k = 0 To Splits - 1
            Application.DoEvents()
            Dim TempAssetWhereList As String = ""
            ' Build the partial asset location id/flag list
            For z = k * 900 To (k + 1) * 900 - 1
                If z = AssetLocationFlagList.Count Then
                    ' exit if we get to the end of the list
                    Exit For
                End If
                TempAssetWhereList = TempAssetWhereList & AssetLocationFlagList(z) & " Or "
            Next

            ' Strip final OR
            TempAssetWhereList = TempAssetWhereList.Substring(0, Len(TempAssetWhereList) - 4)

            SQL = "SELECT SUM(Quantity) FROM ASSETS WHERE (" & TempAssetWhereList & ") "
            SQL &= " And ASSETS.TypeID = " & CStr(TypeID) & " And ID IN (" & IDString & ")"

            DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
            readerAssets = DBCommand.ExecuteReader
            readerAssets.Read()

            If readerAssets.HasRows And Not IsDBNull(readerAssets.GetValue(0)) Then
                ItemQuantity += readerAssets.GetInt32(0) ' sum up
            End If
            readerAssets.Close()
        Next

        Return ItemQuantity

    End Function

    ' Finds the number of items in production from all loaded characters
    Private Function GetTotalItemsinProduction(ByVal TypeID As Long) As Integer
        Dim SQL As String
        Dim rsItems As SQLiteDataReader
        Dim Volume As Integer = 0

        SQL = "SELECT SUM(runs * PORTION_SIZE) FROM INDUSTRY_JOBS, ALL_BLUEPRINTS WHERE INDUSTRY_JOBS.productTypeID = ALL_BLUEPRINTS.ITEM_ID "
        SQL &= "And productTypeID = " & CStr(TypeID) & " And status = 'active' And activityID IN (1,11) "
        'SQL &= "And installerID = " & CStr(SelectedCharacter.ID) & " "

        DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
        rsItems = DBCommand.ExecuteReader

        If rsItems.Read() And Not IsDBNull(rsItems.GetValue(0)) Then
            Volume = rsItems.GetInt32(0)
        End If

        rsItems.Close()

        Return Volume

    End Function

    ' Sets the owned flag for an insert item
    Private Function SetItemOwnedFlag(ByRef SentItem As ManufacturingItem, ByVal SentOrigDecryptor As Decryptor, ByVal SentOrigRelic As String,
                                 ByVal SentOrigME As Integer, ByVal SentOrigTE As Integer, ByVal SentOriginalBPOwnedFlag As Boolean) As Boolean
        ' We know the original decryptor and relic used for this bp so see if they match what we just 
        ' used and set the owned flag and it's invented, which all these are - also make sure the me/te are same
        ' as base if no decryptor used
        If SentItem.Decryptor.Name = SentOrigDecryptor.Name And SentOrigRelic.Contains(SentItem.Relic) _
            And SentOriginalBPOwnedFlag = True And SentItem.BlueprintType = BPType.InventedBPC _
            And Not (SentOrigDecryptor.Name = NoDecryptor.Name And SentOrigME <> BaseT2T3ME And SentOrigTE <> BaseT2T3TE) Then
            SentItem.Owned = Yes
            Return True
        Else
            SentItem.Owned = No
            Return False
        End If
    End Function

    ' Loads the cmbBPTypeFilter object with types based on the radio button selected - Ie, Drones will load Drone types (Small, Medium, Heavy...etc)
    Private Sub LoadCalcBPTypes()
        Dim SQL As String
        Dim WhereClause As String = ""
        Dim readerTypes As SQLiteDataReader
        Dim InventedBPs As New List(Of Long)

        cmbCalcBPTypeFilter.Text = UserManufacturingTabSettings.ItemTypeFilter
        SQL = "SELECT ITEM_GROUP FROM " & USER_BLUEPRINTS

        WhereClause = BuildManufactureWhereClause(True, InventedBPs)

        If WhereClause = "" Then
            ' They didn't select anything, just clear and exit
            cmbCalcBPTypeFilter.Items.Clear()
            cmbCalcBPTypeFilter.Text = "All Types"
            Exit Sub
        End If

        ' See if we are looking at User Owned blueprints or All
        If rbtnCalcBPOwned.Checked Then
            WhereClause = WhereClause & "And USER_ID = " & SelectedCharacter.ID & " And OWNED <> 0  "
        End If

        SQL &= WhereClause & "GROUP BY ITEM_GROUP"

        DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
        DBCommand.Parameters.AddWithValue("@USERBP_USERID", GetBPUserID(SelectedCharacter.ID)) ' need to search for corp ID too
        DBCommand.Parameters.AddWithValue("@USERBP_CORPID", CStr(SelectedCharacter.CharacterCorporation.CorporationID))
        readerTypes = DBCommand.ExecuteReader

        cmbCalcBPTypeFilter.Items.Clear()

        cmbCalcBPTypeFilter.Items.Add("All Types")

        While readerTypes.Read
            cmbCalcBPTypeFilter.Items.Add(readerTypes.GetString(0))
        End While

        readerTypes.Close()

    End Sub

    ' Just adds an item into the list and duplicates if raw or components checked
    Private Sub InsertItemCalcType(ByRef ManufacturingItemList As List(Of ManufacturingItem), ByVal BaseItem As ManufacturingItem, ByRef FormatList As List(Of RowFormat))

        Dim CalcType As String = ""
        Dim TempItem As New ManufacturingItem
        Dim CurrentRowFormat As New RowFormat

        If IsNothing(BaseItem.ReactionFacility) Then
            Application.DoEvents()
        End If

        If rbtnCalcCompareRawMats.Checked Then
            CalcType = "Raw Mats"
        ElseIf rbtnCalcCompareComponents.Checked Then
            CalcType = "Components"
        ElseIf rbtnCalcCompareBuildBuy.Checked Then
            CalcType = "Build/Buy"
        Else ' All
            CalcType = "All Calcs"
        End If

        TempItem = CType(BaseItem.Clone, ManufacturingItem)
        ListIDIterator += 1
        TempItem.ListID = ListIDIterator
        TempItem.CalcType = CalcType

        ManufacturingItemList.Add(TempItem)

        ' Set the list row format for just display, after calcs it will reset
        ' Now determine the format of the item and save it for drawing the list
        CurrentRowFormat.ListID = TempItem.ListID

        'Set the row format for background and foreground colors
        'All columns need to be colored properly
        ' Color owned BP's
        If TempItem.Owned = Yes Then
            If TempItem.Scanned = 1 Or TempItem.Scanned = 0 Then
                CurrentRowFormat.BackColor = Brushes.BlanchedAlmond
            ElseIf TempItem.Scanned = 2 Then
                ' Corp owned
                CurrentRowFormat.BackColor = Brushes.LightGreen
            End If
        ElseIf UserInventedBPs.Contains(TempItem.BPID) Then
            ' It's an invented BP that we own the T1 BP for
            CurrentRowFormat.BackColor = Brushes.LightSteelBlue
        Else
            CurrentRowFormat.BackColor = Brushes.White
        End If

        ' Set default and change if needed
        CurrentRowFormat.ForeColor = Brushes.Black

        ' Insert the format
        FormatList.Add(CurrentRowFormat)

    End Sub

    ' Exports the list to clipboard
    Private Sub btnCalcExportList_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnCalcExportList.Click
        Dim MyStream As StreamWriter
        Dim FileName As String
        Dim OutputText As String
        Dim Price As ListViewItem
        Dim Separator As String = ""
        Dim Items As ListView.ListViewItemCollection
        Dim ExportColumns As New List(Of String)
        Dim NumItems As Integer = 0

        If UserApplicationSettings.DataExportFormat = SSVDataExport Then
            ' Save file name with date
            FileName = "Manufacturing Calculations Export - " & Format(Now, "MMddyyyy") & ".ssv"

            ' Show the dialog
            SaveFileDialog.Filter = "ssv files (*.ssv)|*.ssv|All files (*.*)|*.*"
            Separator = ";"
        Else ' All others in CSV for now
            ' Save file name with date
            FileName = "Manufacturing Calculations Export - " & Format(Now, "MMddyyyy") & ".csv"

            ' Show the dialog
            SaveFileDialog.Filter = "csv files (*.csv)|*.csv|All files (*.*)|*.*"
            Separator = ","
        End If

        SaveFileDialog.FilterIndex = 1
        SaveFileDialog.RestoreDirectory = True
        SaveFileDialog.FileName = FileName

        If SaveFileDialog.ShowDialog() = DialogResult.OK Then
            Try
                MyStream = File.CreateText(SaveFileDialog.FileName)

                If Not (MyStream Is Nothing) Then

                    Items = lstManufacturing.Items

                    If Items.Count > 0 Then
                        Me.Cursor = Cursors.WaitCursor
                        pnlProgressBar.Minimum = 0
                        pnlProgressBar.Maximum = Items.Count - 1
                        pnlProgressBar.Value = 0
                        pnlProgressBar.Visible = True
                        pnlStatus.Text = "Exporting Table..."
                        Application.DoEvents()

                        OutputText = ""
                        For i = 1 To ColumnPositions.Count - 1
                            If ColumnPositions(i) <> "" Then
                                OutputText = OutputText & ColumnPositions(i) & Separator
                                ExportColumns.Add(ColumnPositions(i))
                            End If
                        Next
                        OutputText = OutputText.Substring(0, Len(OutputText) - 1) ' Strip last separator

                        MyStream.Write(OutputText & Environment.NewLine)

                        For Each Price In Items
                            OutputText = ""
                            For j = 0 To ExportColumns.Count - 1
                                ' Format each column value and save
                                OutputText = OutputText & GetOutputText(ExportColumns(j), Price.SubItems(j + 1).Text, Separator, UserApplicationSettings.DataExportFormat)
                            Next

                            ' For each record, update the progress bar
                            Call IncrementToolStripProgressBar(pnlProgressBar)
                            Application.DoEvents()

                            MyStream.Write(OutputText & Environment.NewLine)
                        Next

                        MyStream.Flush()
                        MyStream.Close()

                        MsgBox("Manufacturing Data Exported", vbInformation, Application.ProductName)

                    End If
                End If
            Catch
                MsgBox(Err.Description, vbExclamation, Application.ProductName)
            End Try
        End If

        ' Done processing the blueprints
        pnlProgressBar.Value = 0
        pnlProgressBar.Visible = False

        gbCalcBPSelectOptions.Enabled = True
        Me.Cursor = Cursors.Default
        Me.Refresh()
        Application.DoEvents()
        pnlStatus.Text = ""

    End Sub

    ' Outputs text in the correct format
    Private Function GetOutputText(ColumnName As String, DataText As String, Separator As String, ExportDataType As String) As String
        Dim ExportData As String

        Select Case ColumnName
            Case ProgramSettings.InventionChanceColumnName
                ExportData = Format(DataText, "Fixed") & Separator
            Case ProgramSettings.VolumeperItemColumnName
                ExportData = Format(DataText, "Fixed") & Separator
            Case ProgramSettings.TotalVolumeColumnName
                ExportData = Format(DataText, "Fixed") & Separator
            Case ProgramSettings.TotalInventionCostColumnName
                ExportData = Format(DataText, "Fixed") & Separator
            Case ProgramSettings.TotalCopyCostColumnName
                ExportData = Format(DataText, "Fixed") & Separator
            Case ProgramSettings.TaxesColumnName
                ExportData = Format(DataText, "Fixed") & Separator
            Case ProgramSettings.BrokerFeesColumnName
                ExportData = Format(DataText, "Fixed") & Separator
            Case ProgramSettings.ItemMarketPriceColumnName
                ExportData = Format(DataText, "Fixed") & Separator
            Case ProgramSettings.ProfitColumnName
                ExportData = Format(DataText, "Fixed") & Separator
            Case ProgramSettings.IskperHourColumnName
                ExportData = Format(DataText, "Fixed") & Separator
            Case ProgramSettings.SVRColumnName
                ExportData = Format(DataText, "Fixed") & Separator
            Case ProgramSettings.SVRxIPHColumnName
                ExportData = Format(DataText, "Fixed") & Separator
            Case ProgramSettings.TotalItemsSoldColumnName
                ExportData = Format(DataText, "Fixed") & Separator
            Case ProgramSettings.TotalOrdersFilledColumnName
                ExportData = Format(DataText, "Fixed") & Separator
            Case ProgramSettings.AvgItemsperOrderColumnName
                ExportData = Format(DataText, "Fixed") & Separator
            Case ProgramSettings.CurrentSellOrdersColumnName
                ExportData = Format(DataText, "Fixed") & Separator
            Case ProgramSettings.CurrentBuyOrdersColumnName
                ExportData = Format(DataText, "Fixed") & Separator
            Case ProgramSettings.ItemsinProductionColumnName
                ExportData = Format(DataText, "Fixed") & Separator
            Case ProgramSettings.ItemsinStockColumnName
                ExportData = Format(DataText, "Fixed") & Separator
            Case ProgramSettings.TotalCostColumnName
                ExportData = Format(DataText, "Fixed") & Separator
            Case ProgramSettings.MaterialCostColumnName
                ExportData = Format(DataText, "Fixed") & Separator
            Case ProgramSettings.BaseJobCostColumnName
                ExportData = Format(DataText, "Fixed") & Separator
            Case ProgramSettings.ManufacturingJobFeeColumnName
                ExportData = Format(DataText, "Fixed") & Separator
            Case ProgramSettings.ManufacturingFacilitySystemIndexColumnName
                ExportData = FormatNumber(DataText, 5) & Separator
            Case ProgramSettings.ManufacturingFacilityUsageColumnName
                ExportData = Format(DataText, "Fixed") & Separator
            Case ProgramSettings.ComponentFacilitySystemIndexColumnName
                ExportData = FormatNumber(DataText, 5) & Separator
            Case ProgramSettings.ComponentFacilityUsageColumnName
                ExportData = Format(DataText, "Fixed") & Separator
            Case ProgramSettings.CapComponentFacilitySystemIndexColumnName
                ExportData = FormatNumber(DataText, 5) & Separator
            Case ProgramSettings.CapComponentFacilityUsageColumnName
                ExportData = Format(DataText, "Fixed") & Separator
            Case ProgramSettings.CopyingFacilitySystemIndexColumnName
                ExportData = FormatNumber(DataText, 5) & Separator
            Case ProgramSettings.CopyingFacilityUsageColumnName
                ExportData = Format(DataText, "Fixed") & Separator
            Case ProgramSettings.InventionFacilitySystemIndexColumnName
                ExportData = FormatNumber(DataText, 5) & Separator
            Case ProgramSettings.InventionFacilityUsageColumnName
                ExportData = Format(DataText, "Fixed") & Separator
            Case ProgramSettings.PortionSizeColumnName
                ExportData = Format(DataText, "Fixed") & Separator
            Case Else
                ExportData = DataText & Separator
        End Select

        If ExportDataType = SSVDataExport Then
            ' Format to EU
            ExportData = ConvertUStoEUDecimal(ExportData)
        End If

        Return ExportData

    End Function

    ' Refresh the list with blueprints before we calculate the data so the user knows what they are calculating
    Private Sub btnManufactureRefresh_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnCalcPreview.Click
        Call DisplayManufacturingResults(False)
    End Sub

    ' Reads through the manufacturing blueprint list and calculates the isk per hour for all that are selected, then sorts them and displays
    Private Sub btnCalculate_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnCalcCalculate.Click
        If btnCalcCalculate.Text = "Cancel" Then
            CancelManufacturingTabCalc = True
        Else
            Call DisplayManufacturingResults(True)
        End If
    End Sub

    ' Builds the query for the main grid update
    Private Function BuildManufacturingSelectQuery(ByRef RecordCount As Integer, ByRef InventedBPs As List(Of Long)) As String
        Dim SQL As String = ""
        Dim SQLTemp As String = ""
        Dim WhereClause As String = ""
        Dim ComboType As String = ""

        ' Core Query
        SQL = "SELECT * FROM " & USER_BLUEPRINTS

        WhereClause = BuildManufactureWhereClause(False, InventedBPs)

        ' Don't load if no where clause
        If WhereClause = "" Then
            Return ""
        End If

        ' Get the record count first
        SQLTemp = "SELECT COUNT(*) FROM " & USER_BLUEPRINTS & WhereClause

        Dim CMDCount As New SQLiteCommand(SQLTemp, EVEDB.DBREf)
        CMDCount.Parameters.AddWithValue("@USERBP_USERID", GetBPUserID(SelectedCharacter.ID)) ' need to search for corp ID too
        CMDCount.Parameters.AddWithValue("@USERBP_CORPID", CStr(SelectedCharacter.CharacterCorporation.CorporationID))
        RecordCount = CInt(CMDCount.ExecuteScalar())

        Return SQL & WhereClause & " ORDER BY ITEM_GROUP, ITEM_NAME"

    End Function

    ' Builds the where clause for the calc screen based on Tech and Group selections, by reference will return the list of Invented BPs
    Private Function BuildManufactureWhereClause(LoadingList As Boolean, ByRef InventedBPs As List(Of Long)) As String
        Dim WhereClause As String = ""
        Dim ItemTypes As String = ""
        Dim ComboType As String = ""
        Dim ItemTypeNumbers As String = ""
        Dim T2Selected As Boolean = False ' Whether the user wants to look at T2 blueprints or not - this is used in loading only T2 bps that we can invent
        Dim readerT1s As SQLiteDataReader
        Dim TempRace As String = ""
        Dim RaceClause As String = ""
        Dim SizesClause As String = ""
        Dim NPCBPOsClause As String = ""

        Dim SQL As String = ""
        Dim T2Query As String = ""
        Dim T3Query As String = ""
        Dim RelicRuns As String = ""

        ' Items
        If chkCalcAmmo.Checked Then
            ItemTypes = ItemTypes & "X.ITEM_CATEGORY = 'Charge' OR "
        End If
        If chkCalcDrones.Checked Then
            ItemTypes = ItemTypes & "X.ITEM_CATEGORY IN ('Drone', 'Fighter') OR "
        End If
        If chkCalcModules.Checked Then
            ItemTypes = ItemTypes & "(X.ITEM_CATEGORY = 'Module' AND X.ITEM_GROUP NOT LIKE 'Rig%') OR "
        End If
        If chkCalcShips.Checked Then
            ItemTypes = ItemTypes & "X.ITEM_CATEGORY = 'Ship' OR "
        End If
        If chkCalcSubsystems.Checked Then
            ItemTypes = ItemTypes & "X.ITEM_CATEGORY = 'Subsystem' OR "
        End If
        If chkCalcBoosters.Checked Then
            ItemTypes = ItemTypes & "X.ITEM_CATEGORY = 'Implant' OR "
        End If
        If chkCalcComponents.Checked Then
            ItemTypes = ItemTypes & "(X.ITEM_GROUP LIKE '%Components%' AND X.ITEM_GROUP <> 'Station Components') OR "
        End If
        If chkCalcRigs.Checked Then
            ItemTypes = ItemTypes & "(X.BLUEPRINT_GROUP = 'Rig Blueprint' OR (X.ITEM_CATEGORY = 'Structure Module' AND X.ITEM_GROUP LIKE '%Rig%')) OR "
        End If
        If chkCalcStructureRigs.Checked Then
            ItemTypes = ItemTypes & "X.ITEM_CATEGORY = 'Structure Rigs' OR "
        End If
        If chkCalcCelestials.Checked Then
            ItemTypes = ItemTypes & "X.ITEM_CATEGORY IN ('Celestial', 'Orbitals', 'Sovereignty Structures', 'Station', 'Accessories') OR "
        End If
        If chkCalcStructureModules.Checked Then
            ItemTypes = ItemTypes & "(X.ITEM_CATEGORY = 'Structure Module' AND X.ITEM_GROUP NOT LIKE '%Rig%') OR "
        End If
        If chkCalcReactions.Checked Then
            ItemTypes = ItemTypes & "(X.BLUEPRINT_GROUP LIKE '%Reaction Formulas') OR "
        End If
        If chkCalcMisc.Checked Then
            ItemTypes = ItemTypes & "X.ITEM_GROUP IN ('Tool','Data Interfaces','Cyberimplant','Fuel Block') OR "
        End If
        If chkCalcDeployables.Checked Then
            ItemTypes = ItemTypes & "X.ITEM_CATEGORY = 'Deployable' OR "
        End If
        If chkCalcStructures.Checked Then
            ItemTypes = ItemTypes & "(X.ITEM_CATEGORY IN ('Starbase','Structure') OR X.ITEM_GROUP = 'Station Components')  OR "
        End If

        ' Take off last OR
        If ItemTypes <> "" Then
            ItemTypes = ItemTypes.Substring(0, ItemTypes.Count - 4)
        Else
            ' Can't run this
            Return ""
        End If

        ' Item Type Definitions - These are set by me based on existing data
        ' 1, 2, 14 are T1, T2, T3
        ' 3 is Storyline
        ' 15 is Pirate Faction
        ' 16 is Navy Faction

        ' Check Tech version
        If chkCalcT1.Enabled Then
            ' Only a Subsystem so T3
            If chkCalcT1.Checked Then
                ItemTypeNumbers = ItemTypeNumbers & "1,"
            End If
        End If

        If chkCalcT2.Enabled Then
            If chkCalcT2.Checked Then
                ' If we have T2 blueprints and they selected to only have T2 they have T1 blueprints for to invent
                ' then build this list and add a special SQL item type entry for T2's
                If rbtnCalcAllBPs.Checked Or chkCalcIncludeT2Owned.Checked Then
                    InventedBPs = New List(Of Long)
                    ' Select all the T2 bps that we can invent from our owned bps and save them
                    SQL = "SELECT productTypeID FROM INDUSTRY_ACTIVITY_PRODUCTS "
                    SQL &= "WHERE activityID = 8 AND blueprintTypeID IN "
                    SQL &= "(SELECT BP_ID FROM " & USER_BLUEPRINTS & " WHERE "
                    If rbtnCalcBPFavorites.Checked Then
                        SQL &= " X.FAVORITE = 1 AND "
                    Else
                        SQL &= " X.OWNED <> 0 AND "
                    End If
                    SQL &= "X.ITEM_TYPE = 1) GROUP BY productTypeID"

                    DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
                    DBCommand.Parameters.AddWithValue("@USERBP_USERID", GetBPUserID(SelectedCharacter.ID)) ' need to search for corp ID too
                    DBCommand.Parameters.AddWithValue("@USERBP_CORPID", CStr(SelectedCharacter.CharacterCorporation.CorporationID))
                    readerT1s = DBCommand.ExecuteReader()

                    While readerT1s.Read
                        ' Build list for where clause
                        T2Query = T2Query & CStr(readerT1s.GetValue(0)) & ","
                        ' Save the T2 BPID for later lookup to display
                        InventedBPs.Add(CLng(readerT1s.GetValue(0)))
                    End While

                    readerT1s.Close()

                    ' Set the list of T2 BPC's we want and allow for User ID 0 (not owned but invented) or the User ID (OWNED)
                    If InventedBPs.Count <> 0 And T2Query <> "" Then
                        T2Query = " OR (X.ITEM_TYPE = 2 AND X.BP_ID IN (" & T2Query.Substring(0, T2Query.Length - 1) & ")) "
                    End If
                Else
                    T2Query = ""
                End If

                ItemTypeNumbers = ItemTypeNumbers & "2,"

            End If
        End If

        If chkCalcT3.Enabled Then
            If chkCalcT3.Checked Then
                If rbtnCalcAllBPs.Checked Or chkCalcIncludeT3Owned.Checked Then
                    T3Query = " OR (X.ITEM_TYPE = 14) "
                Else
                    T3Query = ""
                End If

                ItemTypeNumbers = ItemTypeNumbers & "14,"

            End If
        End If

        If chkCalcStoryline.Enabled Then
            If chkCalcStoryline.Checked Then
                ItemTypeNumbers = ItemTypeNumbers & "3,"
            End If
        End If

        If chkCalcPirateFaction.Enabled Then
            If chkCalcPirateFaction.Checked Then
                ItemTypeNumbers = ItemTypeNumbers & "15,"
            End If
        End If

        If chkCalcNavyFaction.Enabled Then
            If chkCalcNavyFaction.Checked Then
                ItemTypeNumbers = ItemTypeNumbers & "16,"
            End If
        End If

        ' Add Item Type
        If ItemTypeNumbers <> "" Then
            ItemTypeNumbers = "X.ITEM_TYPE IN (" & ItemTypeNumbers.Substring(0, ItemTypeNumbers.Length - 1) & ") "
        Else
            ' They need to have at least one tech. If not, just return nothing
            Return ""
        End If

        ' See if we are looking at User Owned blueprints or item types and add this - only want owned item types
        If rbtnCalcBPOwned.Checked Then
            ItemTypeNumbers = ItemTypeNumbers & " AND OWNED <> 0 "
        End If

        ' Determine what race we are looking at
        If chkCalcRaceAmarr.Checked Then
            TempRace = TempRace & "4,"
        End If
        If chkCalcRaceCaldari.Checked Then
            TempRace = TempRace & "1,"
        End If
        If chkCalcRaceMinmatar.Checked Then
            TempRace = TempRace & "2,"
        End If
        If chkCalcRaceGallente.Checked Then
            TempRace = TempRace & "8,"
        End If
        If chkCalcRacePirate.Checked Then
            TempRace = TempRace & "15,"
        End If
        If chkCalcRaceOther.Checked Then
            TempRace = TempRace & "0,"
        End If

        If TempRace <> "" Then
            TempRace = "(" & TempRace.Substring(0, Len(TempRace) - 1) & ")"
            RaceClause = "X.RACE_ID IN " & TempRace
        Else
            ' They need to have at least one. If not, just return nothing
            Return ""
        End If

        ' If they select a type of item, set that
        If LoadingList Then
            ComboType = ""
        Else ' We are doing a main query so limit
            If Trim(cmbCalcBPTypeFilter.Text) <> "All Types" And Trim(cmbCalcBPTypeFilter.Text) <> "Select Type" And Trim(cmbCalcBPTypeFilter.Text) <> "" Then
                ComboType = "AND X.ITEM_GROUP ='" & Trim(cmbCalcBPTypeFilter.Text) & "' "
            Else
                ComboType = ""
            End If
        End If

        SizesClause = ""

        ' Finally add the sizes
        If chkCalcSmall.Checked Then ' Light
            SizesClause = SizesClause & "'S',"
        End If

        If chkCalcMedium.Checked Then ' Medium
            SizesClause = SizesClause & "'M',"
        End If

        If chkCalcLarge.Checked Then ' Heavy
            SizesClause = SizesClause & "'L',"
        End If

        If chkCalcXL.Checked Then ' Fighters
            SizesClause = SizesClause & "'XL',"
        End If

        If SizesClause <> "" Then
            SizesClause = " AND SIZE_GROUP IN (" & SizesClause.Substring(0, Len(SizesClause) - 1) & ") "
        End If

        If chkCalcNPCBPOs.Checked And chkCalcNPCBPOs.Enabled Then
            NPCBPOsClause = " AND NPC_BPO = 1 AND ITEM_TYPE = 1 " ' only include T1 BPOs
        End If

        ' Flag for favorites 
        If rbtnCalcBPFavorites.Checked Then
            WhereClause = "WHERE FAVORITE = 1 AND "
        Else
            WhereClause = "WHERE "
        End If

        ' Add all the items to the where clause
        WhereClause = WhereClause & RaceClause & " AND (" & ItemTypes & ") AND (((" & ItemTypeNumbers & ") " & T2Query & T3Query & "))" & SizesClause & ComboType & NPCBPOsClause & " "

        ' Finally add on text if they added it
        If Trim(txtCalcItemFilter.Text) <> "" Then
            WhereClause = WhereClause & "AND " & GetSearchText(txtCalcItemFilter.Text, "X.ITEM_NAME", "X.ITEM_GROUP")
        End If

        ' Only bps not ignored - no option for this yet
        WhereClause = WhereClause & " AND IGNORE = 0 "

        Return WhereClause

    End Function

    ' Checks data on different filters to see if we enter the item, and formats colors, etc. after
    Private Sub InsertManufacturingItem(ByVal SentItem As ManufacturingItem, ByVal SVRThreshold As Double,
                                        ByVal InsertBlankSVR As Boolean, ByRef SentList As List(Of ManufacturingItem),
                                        ByRef FormatList As List(Of RowFormat))
        Dim CurrentRowFormat As New RowFormat
        Dim InsertItem As Boolean = True ' Assume we include until the record doesn't pass one condition
        ListIDIterator += 1

        SentItem.ListID = ListIDIterator

        ' If not blank, does it meet the threshold? If nothing, then we want to include it, so skip
        If SentItem.SVR <> "-" And Not IsNothing(SVRThreshold) Then
            ' It's below the threshold, so don't insert
            If CDbl(SentItem.SVR) < SVRThreshold Then
                InsertItem = False
            End If
        End If

        ' If it's empty and you don't want blank svr's, don't insert
        If SentItem.SVR = "-" And Not InsertBlankSVR Then
            InsertItem = False
        End If

        ' Filter based on price trend first
        If cmbCalcPriceTrend.Text = "Up" Then
            ' They want up trends and this is less than zero, so false
            If SentItem.PriceTrend < 0 Then
                InsertItem = False
            End If
        ElseIf cmbCalcPriceTrend.Text = "Down" Then
            ' They want down trends and this is greater than zero, so false
            If SentItem.PriceTrend > 0 Then
                InsertItem = False
            End If
        End If

        ' Min Build time
        If chkCalcMinBuildTimeFilter.Checked Then
            ' If greater than max threshold, don't include
            If ConvertDHMSTimetoSeconds(SentItem.TotalProductionTime) < ConvertDHMSTimetoSeconds(tpMinBuildTimeFilter.Text) Then
                InsertItem = False
            End If
        End If

        ' Max Build time
        If chkCalcMaxBuildTimeFilter.Checked Then
            ' If greater than max threshold, don't include
            If ConvertDHMSTimetoSeconds(SentItem.TotalProductionTime) > ConvertDHMSTimetoSeconds(tpMaxBuildTimeFilter.Text) Then
                InsertItem = False
            End If
        End If

        ' IPH Threshold
        If chkCalcIPHThreshold.Checked Then
            ' If less than threshold, don't include
            If SentItem.IPH < CDbl(txtCalcIPHThreshold.Text) Then
                InsertItem = False
            End If
        End If

        ' Profit Threshold
        If chkCalcProfitThreshold.CheckState = CheckState.Checked Then
            ' If less than threshold, don't include
            If SentItem.Profit < CDbl(txtCalcProfitThreshold.Text) Then
                InsertItem = False
            End If
        ElseIf chkCalcProfitThreshold.CheckState = CheckState.Indeterminate Then
            ' Profit %
            If SentItem.ProfitPercent < CpctD(txtCalcProfitThreshold.Text) Then
                InsertItem = False
            End If
        End If

        ' Profit Threshold
        If chkCalcVolumeThreshold.Checked Then
            ' If less than threshold, don't include
            If SentItem.TotalItemsSold < CDbl(txtCalcVolumeThreshold.Text) Then
                InsertItem = False
            End If
        End If

        ' Now determine the format of the item and save it for drawing the list - only if we add it
        If InsertItem Then
            ' Add the record
            SentList.Add(CType(SentItem.Clone, ManufacturingItem))

            CurrentRowFormat.ListID = ListIDIterator

            'Set the row format for background and foreground colors
            'All columns need to be colored properly
            ' Color owned BP's
            If SentItem.Owned = Yes Then
                If SentItem.Scanned = 1 Or SentItem.Scanned = 0 Then
                    CurrentRowFormat.BackColor = Brushes.BlanchedAlmond
                ElseIf SentItem.Scanned = 2 Then
                    ' Corp owned
                    CurrentRowFormat.BackColor = Brushes.LightGreen
                End If
            ElseIf UserInventedBPs.Contains(SentItem.BPID) Then
                ' It's an invented BP that we own the T1 BP for
                CurrentRowFormat.BackColor = Brushes.LightSkyBlue
            Else
                CurrentRowFormat.BackColor = Brushes.White
            End If

            ' Set default and change if needed
            CurrentRowFormat.ForeColor = Brushes.Black

            ' Highlight those we can't build, RE or Invent
            If Not SentItem.CanBuildBP Then
                CurrentRowFormat.ForeColor = Brushes.DarkRed
            End If

            If Not SentItem.CanInvent And SentItem.TechLevel = "T2" And SentItem.BlueprintType = BPType.InventedBPC And Not chkCalcIgnoreInvention.Checked Then
                CurrentRowFormat.ForeColor = Brushes.DarkOrange
            End If

            If Not SentItem.CanRE And SentItem.TechLevel = "T3" And SentItem.BlueprintType = BPType.InventedBPC And Not chkCalcIgnoreInvention.Checked Then
                CurrentRowFormat.ForeColor = Brushes.DarkGreen
            End If

            ' Insert the format
            FormatList.Add(CurrentRowFormat)

        End If

    End Sub

    ' Checks if the BP is T2 or T3 and we want to save it for determining the optimal calc for decryptors
    Private Sub InsertDecryptorforOptimalCompare(ByRef BP As Blueprint, ByRef CalcType As String, ByRef LocationID As Integer, ByRef OptimalList As List(Of OptimalDecryptorItem))
        If chkCalcDecryptor0.Checked Then
            Dim TempItem As New OptimalDecryptorItem
            Dim CompareIPH As Boolean

            If chkCalcDecryptor0.Text.Contains("Profit") Then
                CompareIPH = False
            Else
                CompareIPH = True
            End If

            ' Insert the record if it has a decryptor and T2/T3
            If (BP.GetTechLevel = BPTechLevel.T2 And chkCalcDecryptorforT2.Checked) Or
               (BP.GetTechLevel = BPTechLevel.T3 And chkCalcDecryptorforT3.Checked) Then
                TempItem.CalcType = CalcType
                TempItem.ItemTypeID = BP.GetItemID
                TempItem.ListLocationID = LocationID

                If CompareIPH Then
                    If CalcType <> "Components" Then
                        TempItem.CompareValue = BP.GetTotalIskperHourRaw
                    Else
                        TempItem.CompareValue = BP.GetTotalIskperHourComponents
                    End If
                Else ' Profit
                    If CalcType <> "Components" Then
                        TempItem.CompareValue = BP.GetTotalRawProfit
                    Else
                        TempItem.CompareValue = BP.GetTotalComponentProfit
                    End If
                End If
            End If

            OptimalList.Add(TempItem)

        End If
    End Sub

    ' Reads optimal decryptor list and removes only but the most optimal decryptor from the item list
    Private Function SetOptimalDecryptorList(ByVal ItemList As List(Of ManufacturingItem), OptimalItemList As List(Of OptimalDecryptorItem)) As List(Of ManufacturingItem)
        Dim TempDecryptorItem As New OptimalDecryptorItem
        Dim TempList As New List(Of OptimalDecryptorItem)
        Dim CompareValue As Double = 0
        Dim OptimalLocationID As Integer = 0
        Dim RemoveLocations As New List(Of Integer)

        If OptimalItemList.Count <> 0 Then
            For i = 0 To ItemList.Count - 1
                ' Get all the items in the decryptor list (if they exist)
                DecryptorItemToFind.CalcType = ItemList(i).CalcType
                DecryptorItemToFind.ItemTypeID = ItemList(i).ItemTypeID
                ' Find all the items
                TempList = OptimalItemList.FindAll(AddressOf FindDecryptorItem)
                If TempList IsNot Nothing Then
                    ' Loop through each one and get the Location ID for the most optimal item
                    For j = 0 To TempList.Count - 1
                        If CompareValue = 0 Or CompareValue <= TempList(j).CompareValue Then
                            CompareValue = TempList(j).CompareValue
                            ' Save/reset the location for the optimal
                            OptimalLocationID = TempList(j).ListLocationID
                        End If
                    Next

                    ' Reset
                    CompareValue = 0

                    ' Insert the location ID into the list to remove later
                    For j = 0 To TempList.Count - 1
                        If TempList(j).ListLocationID <> OptimalLocationID Then
                            ' Remove this one
                            RemoveLocations.Add(TempList(j).ListLocationID)
                        End If
                    Next

                End If
            Next

            ' Finally, remove all the ID's in the remove list
            For i = 0 To RemoveLocations.Count - 1
                ManufacturingRecordIDToFind = RemoveLocations(i)
                ItemList.Remove(ItemList.Find(AddressOf FindManufacturingItem))
            Next
        End If

        Return ItemList

    End Function

    Private DecryptorItemToFind As OptimalDecryptorItem

    ' Predicate for finding an in the list of decryptors
    Private Function FindDecryptorItem(ByVal Item As OptimalDecryptorItem) As Boolean
        If Item.CalcType = DecryptorItemToFind.CalcType And Item.ItemTypeID = DecryptorItemToFind.ItemTypeID Then
            Return True
        Else
            Return False
        End If
    End Function

    Private Sub lstManufacturing_ColumnWidthChanging(sender As Object, e As System.Windows.Forms.ColumnWidthChangingEventArgs) Handles lstManufacturing.ColumnWidthChanging
        If e.ColumnIndex = 0 Then
            e.Cancel = True
            e.NewWidth = lstPricesView.Columns(e.ColumnIndex).Width
        End If
    End Sub

    ' On double click of the item, it will open up the bp window with the item 
    Private Sub lstManufacturing_DoubleClick(ByVal sender As Object, ByVal e As System.EventArgs) Handles lstManufacturing.DoubleClick
        Dim FoundItem As New ManufacturingItem
        Dim CompareType As String

        ' Find the item clicked in the list of items then just send those values over
        ManufacturingRecordIDToFind = CLng(lstManufacturing.SelectedItems(0).SubItems(0).Text)
        FoundItem = FinalManufacturingItemList.Find(AddressOf FindManufacturingItem)

        ' Set the build facility we are sending to the proper facility type for this item. 
        If FoundItem IsNot Nothing Then
            ' We found it, so load the current bp
            With FoundItem
                If rbtnCalcCompareAll.Checked Or rbtnCalcCompareComponents.Checked Or rbtnCalcCompareBuildBuy.Checked Then
                    CompareType = "Components"
                Else
                    CompareType = "Raw"
                End If

                Dim T2T3Type As BuildMatType
                If rbtnCalcAdvT2MatType.Checked Then
                    T2T3Type = BuildMatType.AdvMaterials
                ElseIf rbtnCalcProcT2MatType.Checked Then
                    T2T3Type = BuildMatType.ProcessedMaterials
                ElseIf rbtnCalcRawT2MatType.Checked Then
                    T2T3Type = BuildMatType.RawMaterials
                Else
                    T2T3Type = Nothing
                End If

                Call LoadBPfromEvent(.BPID, .CalcType, .Inputs, SentFromLocation.ManufacturingTab,
                                     .BuildFacility, .ComponentManufacturingFacility, .CapComponentManufacturingFacility,
                                     .InventionFacility, .CopyFacility,
                                     chkCalcTaxes.Checked, GetBrokerFeeData(chkCalcFees, txtCalcBrokerFeeRate),
                                     CStr(.BPME), CStr(.BPTE), txtCalcRuns.Text, txtCalcProdLines.Text, txtCalcLabLines.Text,
                                     txtCalcNumBPs.Text, FormatNumber(.AddlCosts, 2), chkCalcPPU.Checked, CompareType, T2T3Type)
            End With
        End If

    End Sub

    ' The manufacturing item to load the grid
    Public Class ManufacturingItem
        Implements ICloneable

        Public ListID As Integer ' Unique record id

        Public Blueprint As Blueprint ' The blueprint we used to make this item - for shopping list references

        Public BPID As Long
        Public ItemGroup As String
        Public ItemGroupID As Integer
        Public ItemCategory As String
        Public ItemCategoryID As Integer
        Public ItemTypeID As Long
        Public ItemName As String
        Public TechLevel As String
        Public Owned As String
        Public Scanned As Integer
        Public BPME As Integer
        Public BPTE As Integer
        Public Inputs As String
        Public AddlCosts As Double
        Public Profit As Double
        Public ProfitPercent As Double
        Public IPH As Double
        Public MaterialCost As Double
        Public TotalCost As Double
        Public CalcType As String ' Type of calculation to get the profit - either Components, Raw Mats or Build/Buy
        Public BlueprintType As BPType

        Public Runs As Integer
        Public SingleInventedBPCRunsperBPC As Integer
        Public ProductionLines As Integer
        Public LaboratoryLines As Integer

        ' Inputs
        Public Decryptor As New Decryptor
        Public Relic As String
        Public SavedBPRuns As Integer ' The number of runs on the bp that they have, helpful for determing decryptor and relics

        ' Can do variables
        Public CanBuildBP As Boolean
        Public CanInvent As Boolean
        Public CanRE As Boolean

        Public SVR As String ' Sales volume ratio
        Public SVRxIPH As String
        Public PriceTrend As Double
        Public TotalItemsSold As Long
        Public TotalOrdersFilled As Long
        Public AvgItemsperOrder As Double
        Public CurrentSellOrders As Long
        Public CurrentBuyOrders As Long
        Public ItemsinStock As Integer
        Public ItemsinProduction As Integer

        Public BuildFacility As IndustryFacility
        Public BuildFacilityUsage As Double
        Public ComponentManufacturingFacility As IndustryFacility
        Public ComponentManufacturingFacilityUsage As Double
        Public CapComponentManufacturingFacility As IndustryFacility
        Public CapComponentManufacturingFacilityUsage As Double
        Public ReactionFacility As IndustryFacility
        Public ReactionFacilityUsage As Double

        Public CopyCost As Double
        Public CopyFacilityUsage As Double
        Public CopyFacility As IndustryFacility

        Public InventionCost As Double
        Public InventionFacilityUsage As Double
        Public InventionFacility As IndustryFacility

        Public ReprocessingFacilityUsage As Double
        Public ReprocessingFacility As IndustryFacility

        Public BPProductionTime As String
        Public TotalProductionTime As String
        Public CopyTime As String
        Public InventionTime As String

        Public ItemMarketPrice As Double

        Public BrokerFees As Double
        Public Taxes As Double

        Public BaseJobCost As Double
        Public NumBPs As Integer
        Public InventionChance As Double
        Public Race As String
        Public VolumeperItem As Double
        Public TotalVolume As Double
        Public PortionSize As Integer
        Public DivideUnits As Integer

        Public SellExcess As Double
        Public ROI As Double

        Public JobFee As Double

        Public Function Clone() As Object Implements System.ICloneable.Clone
            Dim CopyofMe As New ManufacturingItem

            CopyofMe.ListID = ListID
            CopyofMe.Blueprint = Blueprint
            CopyofMe.BPID = BPID
            CopyofMe.ItemGroup = ItemGroup
            CopyofMe.ItemGroupID = ItemGroupID
            CopyofMe.ItemCategory = ItemCategory
            CopyofMe.ItemCategoryID = ItemCategoryID
            CopyofMe.ItemTypeID = ItemTypeID
            CopyofMe.ItemName = ItemName
            CopyofMe.TechLevel = TechLevel
            CopyofMe.Owned = Owned
            CopyofMe.Scanned = Scanned
            CopyofMe.BPME = BPME
            CopyofMe.BPTE = BPTE
            CopyofMe.Inputs = Inputs
            CopyofMe.AddlCosts = AddlCosts
            CopyofMe.Profit = Profit
            CopyofMe.ProfitPercent = ProfitPercent
            CopyofMe.IPH = IPH
            CopyofMe.TotalCost = TotalCost
            CopyofMe.MaterialCost = MaterialCost
            CopyofMe.CalcType = CalcType
            CopyofMe.BlueprintType = BlueprintType

            CopyofMe.Runs = Runs
            CopyofMe.SingleInventedBPCRunsperBPC = SingleInventedBPCRunsperBPC
            CopyofMe.ProductionLines = ProductionLines
            CopyofMe.LaboratoryLines = LaboratoryLines

            CopyofMe.CopyTime = CopyTime
            CopyofMe.InventionTime = InventionTime

            CopyofMe.Inputs = Inputs
            CopyofMe.Decryptor = Decryptor
            CopyofMe.Relic = Relic
            CopyofMe.SavedBPRuns = SavedBPRuns

            CopyofMe.CanBuildBP = CanBuildBP
            CopyofMe.CanInvent = CanInvent
            CopyofMe.CanRE = CanRE

            CopyofMe.SVR = SVR
            CopyofMe.SVRxIPH = SVRxIPH
            CopyofMe.PriceTrend = PriceTrend
            CopyofMe.TotalItemsSold = TotalItemsSold
            CopyofMe.TotalOrdersFilled = TotalOrdersFilled
            CopyofMe.AvgItemsperOrder = AvgItemsperOrder
            CopyofMe.CurrentSellOrders = CurrentSellOrders
            CopyofMe.CurrentBuyOrders = CurrentBuyOrders
            CopyofMe.ItemsinStock = ItemsinStock
            CopyofMe.ItemsinProduction = ItemsinProduction

            CopyofMe.CopyCost = CopyCost
            CopyofMe.InventionCost = InventionCost

            CopyofMe.BuildFacility = BuildFacility
            CopyofMe.ComponentManufacturingFacility = ComponentManufacturingFacility
            CopyofMe.CapComponentManufacturingFacility = CapComponentManufacturingFacility
            CopyofMe.ReactionFacility = ReactionFacility
            CopyofMe.InventionFacility = InventionFacility
            CopyofMe.CopyFacility = CopyFacility
            CopyofMe.ReprocessingFacility = ReprocessingFacility

            CopyofMe.BPProductionTime = BPProductionTime
            CopyofMe.TotalProductionTime = TotalProductionTime
            CopyofMe.ItemMarketPrice = ItemMarketPrice
            CopyofMe.BrokerFees = BrokerFees
            CopyofMe.Taxes = Taxes
            CopyofMe.BaseJobCost = BaseJobCost

            CopyofMe.NumBPs = NumBPs
            CopyofMe.InventionChance = InventionChance
            CopyofMe.BlueprintType = BlueprintType
            CopyofMe.Race = Race
            CopyofMe.VolumeperItem = VolumeperItem
            CopyofMe.TotalVolume = TotalVolume
            CopyofMe.PortionSize = PortionSize
            CopyofMe.DivideUnits = DivideUnits
            CopyofMe.SellExcess = SellExcess
            CopyofMe.ROI = ROI

            CopyofMe.JobFee = JobFee

            CopyofMe.BuildFacilityUsage = BuildFacilityUsage
            CopyofMe.ComponentManufacturingFacilityUsage = ComponentManufacturingFacilityUsage
            CopyofMe.CapComponentManufacturingFacilityUsage = CapComponentManufacturingFacilityUsage
            CopyofMe.ReactionFacilityUsage = ReactionFacilityUsage
            CopyofMe.CopyFacilityUsage = CopyFacilityUsage
            CopyofMe.InventionFacilityUsage = InventionFacilityUsage
            CopyofMe.ReprocessingFacilityUsage = ReprocessingFacilityUsage

            Return CopyofMe

        End Function

    End Class

    ' Predicate for finding an item in a list EVE Market Data of items
    Private Function FindManufacturingItem(ByVal Item As ManufacturingItem) As Boolean
        If Item.ListID = ManufacturingRecordIDToFind Then
            Return True
        Else
            Return False
        End If
    End Function

    ' Predicate for finding an item in a list EVE Market Data of items
    Private Function FindManufacturingItembyName(ByVal Item As ManufacturingItem) As Boolean
        If Item.ItemName = ManufacturingNameToFind Then
            Return True
        Else
            Return False
        End If
    End Function

    ' Calculates the slope of the trend line for the market history for the sent type id for the last x days sent
    ' Formula and logic from here: http://classroom.synonym.com/calculate-trendline-2709.html
    Private Function CalculatePriceTrend(ByVal TypeID As Long, ByVal RegionID As Long, DaysfromToday As Integer) As Double
        Dim SQL As String
        Dim rsMarketHistory As SQLiteDataReader
        Dim GraphData As New List(Of EVEIPHPricePoint)
        Dim counter As Integer = 0

        Dim n_value As Double = 0 ' Let n = the number of data points, in this case 3
        Dim a_value As Double = 0
        Dim b_value As Double = 0
        Dim c_value As Double = 0
        Dim d_value As Double = 0
        Dim e_value As Double = 0
        Dim f_value As Double = 0

        Dim x_sum As Double = 0
        Dim x_squared As Double = 0
        Dim y_sum As Double = 0

        Dim slope As Double = 0
        Dim y_intercept As Double = 0

        Dim AdjustPrice As Double = 0

        ' Average price is the Y values, dates (or just days) is the x value

        ' Now get all the prices for the time period
        SQL = "SELECT PRICE_HISTORY_DATE, AVG_PRICE FROM MARKET_HISTORY WHERE TYPE_ID = " & CStr(TypeID) & " AND REGION_ID = " & CStr(RegionID) & " "
        SQL &= "AND DATETIME(PRICE_HISTORY_DATE) >= " & " DateTime('" & Format(DateAdd(DateInterval.Day, -(DaysfromToday + 1), Date.UtcNow.Date), SQLiteDateFormat) & "') "
        SQL &= "AND DATETIME(PRICE_HISTORY_DATE) < " & " DateTime('" & Format(Date.UtcNow.Date, SQLiteDateFormat) & "') "
        SQL &= "ORDER BY PRICE_HISTORY_DATE ASC"
        DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
        rsMarketHistory = DBCommand.ExecuteReader

        While rsMarketHistory.Read
            Dim TempPoint As EVEIPHPricePoint
            counter += 1
            TempPoint.PointDate = rsMarketHistory.GetDateTime(0)
            TempPoint.X_Date_Marker = counter
            If counter = 1 Then
                ' Save the base value and then reduce from all other prices
                AdjustPrice = rsMarketHistory.GetDouble(1)
                TempPoint.Y_Price = rsMarketHistory.GetDouble(1)
            Else
                TempPoint.Y_Price = rsMarketHistory.GetDouble(1)
            End If

            ' Since we are looping through the data, just do the summation calcs now
            a_value += (counter * TempPoint.Y_Price)
            ' Grab the sum here too
            y_sum += TempPoint.Y_Price
            x_sum += TempPoint.X_Date_Marker
            x_squared += TempPoint.X_Date_Marker ^ 2

            GraphData.Add(TempPoint)
        End While

        rsMarketHistory.Close()

        ' Set the n_value from the loop
        If counter <= 1 Then
            ' If it's 0 or 1, then we can't do a slope calculation 
            Return 0
        Else
            n_value = counter
        End If

        ' Now we have all the data to do the calculations

        ' Calculate a
        ' Let a equal n times the summation of all x-values multiplied by their corresponding y-values, like so: a = 3 x {(1 x 3) +( 2 x 5) + (3 x 6.5)} = 97.5
        ' Use previous calc value and multiply by n
        a_value = a_value * n_value

        ' Calculate b
        ' Let b equal the sum of all x-values times the sum of all y-values, like so: b = (1 + 2 + 3) x (3 + 5 + 6.5) = 87
        ' Use x_sum and y_sum from earlier and calculate b
        b_value = x_sum * y_sum

        ' Calculate c
        ' Let c equal n times the sum of all squared x-values, like so: c = 3 x (1^2 + 2^2 + 3^2) = 42
        c_value = n_value * x_squared

        ' Calculate d
        ' Let d equal the squared sum of all x-values, like so: d = (1 + 2 + 3)^2 = 36
        d_value = x_sum ^ 2

        ' Calculate the slope
        ' Plug the values that you calculated for a, b, c, and d into the following equation to calculate the slope, m, of the regression line: 
        ' slope = m = (a - b) / (c - d) = (97.5 - 87) / (42 - 36) = 10.5 / 6 = 1.75
        slope = (a_value - b_value) / (c_value - d_value)

        ' Now find the intercepts so we can normalize the slope value
        ' Consider the same data set. Let e equal the sum of all y-values, like so: e = (3 + 5 + 6.5) = 14.5
        e_value = y_sum

        ' Let f equal the slope times the sum of all x-values, like so: f = 1.75 x (1 + 2 + 3) = 10.5
        f_value = slope * x_sum

        ' Calculate the y-intercept
        ' Plug the values you have calculated for e and f into the following equation for the y-intercept, b, of the trendline: 
        ' y-intercept = b = (e - f) / n = (14.5 - 10.5) / 3 = 1.3)
        y_intercept = (e_value - f_value) / n_value

        ' Now that we have all the parts of y = mx + b, normalize the trendline to a percentage change value
        ' First figure out the value today (the start value is the y-intercept)
        Dim TodaysTrendLinePrice As Double = slope * n_value + y_intercept
        'y = 50,098.90x - 1,518,343.83
        Dim trend As Double = (TodaysTrendLinePrice - y_intercept) / TodaysTrendLinePrice
        Return trend

    End Function

    Public Structure EVEIPHPricePoint
        Dim PointDate As Date
        Dim X_Date_Marker As Integer ' simplifies code for dates
        Dim Y_Price As Double ' price value
    End Structure

#Region "List Options Menu"

    Private Sub ListOptionsMenu_Opening(sender As System.Object, e As System.ComponentModel.CancelEventArgs) Handles ListOptionsMenu.Opening
        ' If we have one line selected, then allow both options, if more than one line don't allow the market history to be selected
        If lstManufacturing.SelectedItems.Count > 1 Then
            ViewMarketHistoryToolStripMenuItem.Enabled = False
        Else
            ViewMarketHistoryToolStripMenuItem.Enabled = True
        End If
    End Sub

    ' Allows users to ignore one or more blueprints from the manufacturing tab
    Private Sub IgnoreBlueprintToolStripMenuItem_Click(sender As System.Object, e As System.EventArgs) Handles IgnoreBlueprintToolStripMenuItem.Click

        If lstManufacturing.Items.Count > 0 Then
            Dim FoundItem As New ManufacturingItem
            Dim SQL As String
            Dim RemovedIDs As New List(Of Integer)

            ' Find the each item selected in the list of items then remove each one from the list
            For i = 0 To lstManufacturing.SelectedItems.Count - 1
                ManufacturingRecordIDToFind = CLng(lstManufacturing.SelectedItems(i).SubItems(0).Text)
                FoundItem = FinalManufacturingItemList.Find(AddressOf FindManufacturingItem)

                If FoundItem IsNot Nothing Then
                    Dim ListIDstoRemove As New List(Of Integer)

                    ' We found it, so set the bp to ignore
                    With FoundItem
                        SQL = "UPDATE ALL_BLUEPRINTS_FACT SET IGNORE = 1 WHERE BLUEPRINT_ID = " & CStr(FoundItem.BPID)
                        Call EVEDB.ExecuteNonQuerySQL(SQL)

                        ' Remove the item from the list in all it's forms plus from the manufacturing list
                        ' Get all the items with the name to remove
                        ManufacturingNameToFind = FoundItem.ItemName
                        FoundItem = Nothing

                        Do
                            FoundItem = FinalManufacturingItemList.Find(AddressOf FindManufacturingItembyName)
                            If FoundItem IsNot Nothing Then
                                ' Remove it
                                FinalManufacturingItemList.Remove(FoundItem)
                                RemovedIDs.Add(FoundItem.ListID)
                            End If
                        Loop Until FoundItem Is Nothing

                    End With
                End If
            Next

            ' Now remove all BPs we got rid of from the list
            lstManufacturing.BeginUpdate()
            Dim ListCount As Integer = lstManufacturing.Items.Count
            Dim j As Integer = 0
            While j < ListCount
                If RemovedIDs.Contains(CInt(lstManufacturing.Items(j).SubItems(0).Text)) Then
                    ' Add the indicies to remove
                    lstManufacturing.Items(j).Remove()
                    ListCount -= 1
                    j -= 1 ' make sure we reset since we just removed a line
                End If
                j += 1
            End While

            lstManufacturing.EndUpdate()

            Call PlayNotifySound()
        End If
    End Sub

    Private Sub FavoriteBlueprintToolStripMenuItem_Click(sender As Object, e As EventArgs) Handles FavoriteBlueprintToolStripMenuItem.Click

        If lstManufacturing.Items.Count > 0 Then
            Dim FoundItem As New ManufacturingItem
            Dim SQL As String

            ' Find the each item selected in the list of items then remove each one from the list
            For i = 0 To lstManufacturing.SelectedItems.Count - 1
                ManufacturingRecordIDToFind = CLng(lstManufacturing.SelectedItems(i).SubItems(0).Text)
                FoundItem = FinalManufacturingItemList.Find(AddressOf FindManufacturingItem)

                If FoundItem IsNot Nothing Then
                    ' We found it, so set the bp to a favorite in all_blueprints
                    SQL = "UPDATE ALL_BLUEPRINTS_FACT SET FAVORITE = 1 WHERE BLUEPRINT_ID = " & CStr(FoundItem.BPID)
                    Call EVEDB.ExecuteNonQuerySQL(SQL)

                    ' Assume they want to update owned blueprints too if they own it
                    SQL = "UPDATE OWNED_BLUEPRINTS SET FAVORITE = 1 WHERE BLUEPRINT_ID = " & CStr(FoundItem.BPID) & " AND USER_ID = " & CStr(SelectedCharacter.ID)
                    Call EVEDB.ExecuteNonQuerySQL(SQL)

                End If
            Next

            Call PlayNotifySound()

        End If

    End Sub

    ' Gets the typeID and other data to open up the market history viewer
    Private Sub ViewMarketHistoryToolStripMenuItem_Click(sender As System.Object, e As System.EventArgs) Handles ViewMarketHistoryToolStripMenuItem.Click
        Dim FoundItem As New ManufacturingItem
        Dim RegionID As Long

        ' Find the item clicked in the list of items by looking up the row number stored in the hidden column
        If lstManufacturing.Items.Count > 0 And lstManufacturing.SelectedItems.Count > 0 Then
            ManufacturingRecordIDToFind = CLng(lstManufacturing.SelectedItems(0).SubItems(0).Text)
            FoundItem = FinalManufacturingItemList.Find(AddressOf FindManufacturingItem)

            If FoundItem IsNot Nothing Then
                ' Get the region ID
                RegionID = GetRegionID(cmbCalcHistoryRegion.Text)
                If RegionID = 0 Then
                    RegionID = TheForgeTypeID
                End If

                Dim f1 As New frmMarketHistoryViewer(FoundItem.ItemTypeID, FoundItem.ItemName, RegionID, cmbCalcHistoryRegion.Text,
                                                     CInt(cmbCalcAvgPriceDuration.Text))
                f1.Show()

            Else
                MsgBox("Unable to find item data for history", vbInformation, Application.ProductName)
            End If
        End If
    End Sub

    ' Adds one or multiple items to the shopping list from the manufacturing tab
    Private Sub AddToShoppingListToolStripMenuItem_Click(sender As System.Object, e As System.EventArgs) Handles AddToShoppingListToolStripMenuItem.Click

        If lstManufacturing.Items.Count > 0 Then
            Dim FoundItem As New ManufacturingItem

            ' Find the each item selected in the list of items then remove each one from the list
            For i = 0 To lstManufacturing.SelectedItems.Count - 1

                ' Find the item clicked in the list of items then just send those values over
                ManufacturingRecordIDToFind = CLng(lstManufacturing.SelectedItems(i).SubItems(0).Text)
                FoundItem = FinalManufacturingItemList.Find(AddressOf FindManufacturingItem)

                ' Add it to shopping list
                If FoundItem IsNot Nothing Then
                    Dim BuildBuy As Boolean
                    Dim CopyRaw As Boolean

                    If FoundItem.CalcType = "Build/Buy" Then
                        BuildBuy = True
                    End If

                    If FoundItem.CalcType = "Raw Materials" Or BuildBuy = True Then
                        CopyRaw = True
                    Else
                        CopyRaw = False
                    End If

                    ' Get the BP variable and send the other settings to shopping list
                    With FoundItem
                        If Not IsNothing(.Blueprint) Then
                            Call AddToShoppingList(.Blueprint, BuildBuy, CopyRaw, BPTabFacility.GetFacility(BPTabFacility.GetCurrentFacilityProductionType()),
                               chkBPIgnoreInvention.Checked, chkBPIgnoreMinerals.Checked, chkBPIgnoreT1Item.Checked, rbtnBPCopyInvREMats.Checked)
                        Else
                            MsgBox("You must calculate an item before adding it to the shopping list.", MsgBoxStyle.Information, Application.ProductName)
                            Exit Sub
                        End If
                    End With
                End If
            Next
        End If

        If TotalShoppingList.GetNumShoppingItems > 0 Then
            ' Add the final item and mark as items in list
            pnlShoppingList.Text = "Items in Shopping List"
            pnlShoppingList.ForeColor = Color.Red
        Else
            pnlShoppingList.Text = "No Items in Shopping List"
            pnlShoppingList.ForeColor = Color.Black
        End If

        ' Refresh the data if it's open
        If frmShop.Visible Then
            Call frmShop.RefreshLists()
        End If

    End Sub

#End Region

#End Region

#Region "Datacores"

#Region "Datacores Tab User Object (Check boxes, Text, Buttons) Functions/Procedures "

    Private Sub CorpCheckBoxOnClickLabel(ByVal index As Integer)
        If DCCorpCheckBoxes(index).Checked Then
            DCCorpCheckBoxes(index).Checked = False
        Else
            DCCorpCheckBoxes(index).Checked = True
        End If
    End Sub

    Private Sub CoreCheckBoxOnClickLabel(ByVal index As Integer)
        If DCSkillCheckBoxes(index).Checked Then
            DCSkillCheckBoxes(index).Checked = False
        Else
            DCSkillCheckBoxes(index).Checked = True
        End If
    End Sub

    Private Sub lblDCCorp1_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lblDCCorp1.Click
        Call CorpCheckBoxOnClickLabel(1)
    End Sub

    Private Sub lblDCCorp2_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lblDCCorp2.Click
        Call CorpCheckBoxOnClickLabel(2)
    End Sub

    Private Sub lblDCCorp3_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lblDCCorp3.Click
        Call CorpCheckBoxOnClickLabel(3)
    End Sub

    Private Sub lblDCCorp4_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lblDCCorp4.Click
        Call CorpCheckBoxOnClickLabel(4)
    End Sub

    Private Sub lblDCCorp5_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lblDCCorp5.Click
        Call CorpCheckBoxOnClickLabel(5)
    End Sub

    Private Sub lblDCCorp6_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lblDCCorp6.Click
        Call CorpCheckBoxOnClickLabel(6)
    End Sub

    Private Sub lblDCCorp7_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lblDCCorp7.Click
        Call CorpCheckBoxOnClickLabel(7)
    End Sub

    Private Sub lblDCCorp8_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lblDCCorp8.Click
        Call CorpCheckBoxOnClickLabel(8)
    End Sub

    Private Sub lblDCCorp9_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lblDCCorp9.Click
        Call CorpCheckBoxOnClickLabel(9)
    End Sub

    Private Sub lblDCCorp10_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lblDCCorp10.Click
        Call CorpCheckBoxOnClickLabel(10)
    End Sub

    Private Sub lblDCCorp11_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lblDCCorp11.Click
        Call CorpCheckBoxOnClickLabel(11)
    End Sub

    Private Sub lblDCCorp12_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lblDCCorp12.Click
        Call CorpCheckBoxOnClickLabel(12)
    End Sub

    Private Sub lblDCCorp13_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lblDCCorp13.Click
        Call CorpCheckBoxOnClickLabel(13)
    End Sub

    Private Sub lblDatacore1_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lblDatacore1.Click
        Call CoreCheckBoxOnClickLabel(1)
    End Sub

    Private Sub lblDatacore2_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lblDatacore2.Click
        Call CoreCheckBoxOnClickLabel(2)
    End Sub

    Private Sub lblDatacore3_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lblDatacore3.Click
        Call CoreCheckBoxOnClickLabel(3)
    End Sub

    Private Sub lblDatacore4_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lblDatacore4.Click
        Call CoreCheckBoxOnClickLabel(4)
    End Sub

    Private Sub lblDatacore5_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lblDatacore5.Click
        Call CoreCheckBoxOnClickLabel(5)
    End Sub

    Private Sub lblDatacore6_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lblDatacore6.Click
        Call CoreCheckBoxOnClickLabel(6)
    End Sub

    Private Sub lblDatacore7_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lblDatacore7.Click
        Call CoreCheckBoxOnClickLabel(7)
    End Sub

    Private Sub lblDatacore8_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lblDatacore8.Click
        Call CoreCheckBoxOnClickLabel(8)
    End Sub

    Private Sub lblDatacore9_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lblDatacore9.Click
        Call CoreCheckBoxOnClickLabel(9)
    End Sub

    Private Sub lblDatacore10_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lblDatacore10.Click
        Call CoreCheckBoxOnClickLabel(10)
    End Sub

    Private Sub lblDatacore11_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lblDatacore11.Click
        Call CoreCheckBoxOnClickLabel(11)
    End Sub

    Private Sub lblDatacore12_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lblDatacore12.Click
        Call CoreCheckBoxOnClickLabel(12)
    End Sub

    Private Sub lblDatacore13_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lblDatacore13.Click
        Call CoreCheckBoxOnClickLabel(13)
    End Sub

    Private Sub lblDatacore14_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lblDatacore14.Click
        Call CoreCheckBoxOnClickLabel(14)
    End Sub

    Private Sub lblDatacore15_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lblDatacore15.Click
        Call CoreCheckBoxOnClickLabel(15)
    End Sub

    Private Sub lblDatacore16_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lblDatacore16.Click
        Call CoreCheckBoxOnClickLabel(16)
    End Sub

    Private Sub lblDatacore17_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lblDatacore17.Click
        Call CoreCheckBoxOnClickLabel(17)
    End Sub

    Private Sub lstDC_ItemCheck(ByVal sender As Object, ByVal e As System.Windows.Forms.ItemCheckEventArgs) Handles lstDC.ItemCheck
        Dim TotalAgents As Integer = CInt(cmbDCResearchMgmt.Text) + 1

        If TotalAgents = lstDC.CheckedItems.Count And e.NewValue = CheckState.Checked Then
            ' Change to unchecked
            e.NewValue = CheckState.Unchecked
        End If

    End Sub

    Private Sub lstDC_ItemChecked(ByVal sender As Object, ByVal e As System.Windows.Forms.ItemCheckedEventArgs) Handles lstDC.ItemChecked

        ' Item was checked so add up the total iph
        If e.Item.Checked Then
            ' Add the value 
            TotalSelectedIPH = TotalSelectedIPH + CDbl(e.Item.SubItems(DCIPH_COLUMN).Text)
        ElseIf Not e.Item.Checked Then
            If lstDC.CheckedItems.Count = 0 Then
                ' Reset if last one checked
                TotalSelectedIPH = 0
            Else
                ' Subtract the amount
                TotalSelectedIPH = TotalSelectedIPH - CDbl(e.Item.SubItems(DCIPH_COLUMN).Text)
            End If
        End If

        txtDCTotalSelectedIPH.Text = CStr(FormatNumber(TotalSelectedIPH, 2))

    End Sub

    Private Sub cmbDCConnections_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbDCConnections.SelectedIndexChanged
        Call LoadDCCorpStandings(False)
    End Sub

    Private Sub chkDC1_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkDC1.CheckedChanged
        Call EnableDCSkillChecks(sender)
    End Sub

    Private Sub chkDC2_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkDC2.CheckedChanged
        Call EnableDCSkillChecks(sender)
    End Sub

    Private Sub chkDC3_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkDC3.CheckedChanged
        Call EnableDCSkillChecks(sender)
    End Sub

    Private Sub chkDC4_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkDC4.CheckedChanged
        Call EnableDCSkillChecks(sender)
    End Sub

    Private Sub chkDC5_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkDC5.CheckedChanged
        Call EnableDCSkillChecks(sender)
    End Sub

    Private Sub chkDC6_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkDC6.CheckedChanged
        Call EnableDCSkillChecks(sender)
    End Sub

    Private Sub chkDC7_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkDC7.CheckedChanged
        Call EnableDCSkillChecks(sender)
    End Sub

    Private Sub chkDC8_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkDC8.CheckedChanged
        Call EnableDCSkillChecks(sender)
    End Sub

    Private Sub chkDC9_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkDC9.CheckedChanged
        Call EnableDCSkillChecks(sender)
    End Sub

    Private Sub chkDC10_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkDC10.CheckedChanged
        Call EnableDCSkillChecks(sender)
    End Sub

    Private Sub chkDC11_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkDC11.CheckedChanged
        Call EnableDCSkillChecks(sender)
    End Sub

    Private Sub chkDC12_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkDC12.CheckedChanged
        Call EnableDCSkillChecks(sender)
    End Sub

    Private Sub chkDC13_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkDC13.CheckedChanged
        Call EnableDCSkillChecks(sender)
    End Sub

    Private Sub chkDC14_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkDC14.CheckedChanged
        Call EnableDCSkillChecks(sender)
    End Sub

    Private Sub chkDC15_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkDC15.CheckedChanged
        Call EnableDCSkillChecks(sender)
    End Sub

    Private Sub chkDC16_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkDC16.CheckedChanged
        Call EnableDCSkillChecks(sender)
    End Sub

    Private Sub chkDC17_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkDC17.CheckedChanged
        Call EnableDCSkillChecks(sender)
    End Sub

    Private Sub chkDCCorp1_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkDCCorp1.CheckedChanged
        Call EnableDCCorpTexts(sender)
    End Sub

    Private Sub chkDCCorp2_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkDCCorp2.CheckedChanged
        Call EnableDCCorpTexts(sender)
    End Sub

    Private Sub chkDCCorp3_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkDCCorp3.CheckedChanged
        Call EnableDCCorpTexts(sender)
    End Sub

    Private Sub chkDCCorp4_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkDCCorp4.CheckedChanged
        Call EnableDCCorpTexts(sender)
    End Sub

    Private Sub chkDCCorp5_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkDCCorp5.CheckedChanged
        Call EnableDCCorpTexts(sender)
    End Sub

    Private Sub chkDCCorp6_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkDCCorp6.CheckedChanged
        Call EnableDCCorpTexts(sender)
    End Sub

    Private Sub chkDCCorp7_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkDCCorp7.CheckedChanged
        Call EnableDCCorpTexts(sender)
    End Sub

    Private Sub chkDCCorp8_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkDCCorp8.CheckedChanged
        Call EnableDCCorpTexts(sender)
    End Sub

    Private Sub chkDCCorp9_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkDCCorp9.CheckedChanged
        Call EnableDCCorpTexts(sender)
    End Sub

    Private Sub chkDCCorp10_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkDCCorp10.CheckedChanged
        Call EnableDCCorpTexts(sender)
    End Sub

    Private Sub chkDCCorp11_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkDCCorp11.CheckedChanged
        Call EnableDCCorpTexts(sender)
    End Sub

    Private Sub chkDCCorp12_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkDCCorp12.CheckedChanged
        Call EnableDCCorpTexts(sender)
    End Sub

    Private Sub chkDCCorp13_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkDCCorp13.CheckedChanged
        Call EnableDCCorpTexts(sender)
    End Sub

    Private Sub EnableDCSkillChecks(ByVal sender As Object)
        Dim i As Integer
        Dim cbox As CheckBox

        cbox = DirectCast(sender, CheckBox)

        If Not FirstShowDatacores Then
            For i = 1 To DCSkillCheckBoxes.Count - 1
                If cbox.Name = DCSkillCheckBoxes(i).Name Then
                    If CBool(cbox.Checked) Then
                        DCSkillCombos(i).Enabled = True
                    Else
                        DCSkillCombos(i).Enabled = False
                    End If

                End If
            Next
        End If
    End Sub

    Private Sub EnableDCCorpTexts(ByVal sender As Object)
        Dim i As Integer
        Dim cbox As CheckBox

        cbox = DirectCast(sender, CheckBox)

        If Not FirstShowDatacores Then
            For i = 1 To DCCorpCheckBoxes.Count - 1
                If cbox.Name = DCCorpCheckBoxes(i).Name Then
                    If CBool(cbox.Checked) Then
                        DCCorpTextboxes(i).Enabled = True
                    Else
                        DCCorpTextboxes(i).Enabled = False
                    End If

                End If
            Next
        End If
    End Sub

    Private Sub btnDCReset_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnDCReset.Click
        Call LoadDatacoreTab()
    End Sub

    Private Sub lstDC_ColumnClick(ByVal sender As System.Object, ByVal e As System.Windows.Forms.ColumnClickEventArgs) Handles lstDC.ColumnClick
        Call ListViewColumnSorter(e.Column, lstDC, DCColumnClicked, DCColumnSortType)
    End Sub

#End Region

    Public Structure DCAgent
        Dim Faction As String
        Dim FactionStanding As Double
        Dim Corporation As String
        Dim CorporationStanding As Double
        Dim Agent As String
        Dim AgentStanding As Double
        Dim AgentLevel As Integer
        'Dim AgentQuality As Integer *** Removed on 19 May 2011 ***
        Dim AgentLocation As String ' System name + security
        Dim DataCoreID As Long
        Dim DataCoreSkill As String
        Dim DataCoreSkillLevel As Integer
        Dim DataCorePrice As Double
        Dim PriceFrom As String
        Dim RPperDay As Double
        Dim CoresPerDay As Double
        Dim IskPerHour As Double
        ' Location ID's
        Dim SystemID As Long
        Dim SystemSecurity As Double
        Dim RegionID As Long

        Dim AgentAvailable As Boolean

    End Structure

    Private Sub InitDatacoreTab()
        ' Reload screen when called
        Call LoadDatacoreTab()
    End Sub

    ' Loads the datacore skills into the Datacore screen
    Private Sub LoadDatacoreTab()
        Dim i As Integer
        Dim TempSkillLevel As Integer
        Dim Settings As New ProgramSettings

        ' Load the datacore skills first
        For i = 1 To DCSkillLabels.Count - 1
            TempSkillLevel = SelectedCharacter.Skills.GetSkillLevel(SelectedCharacter.Skills.GetSkillTypeID(DCSkillLabels(i).Text))

            ' Check based on default
            If UserDCTabSettings.SkillsChecked(i - 1) = Settings.DefaultSkillLevelChecked Then
                If TempSkillLevel <> 0 Then
                    ' Check
                    DCSkillCheckBoxes(i).Checked = True
                    DCSkillCombos(i).Enabled = True
                Else
                    DCSkillCombos(i).Text = "1"
                    DCSkillCheckBoxes(i).Checked = False
                    DCSkillCombos(i).Enabled = False
                End If
            Else ' use what they saved
                DCSkillCombos(i).Text = "1"
                DCSkillCheckBoxes(i).Checked = CBool(UserDCTabSettings.SkillsChecked(i - 1))
                DCSkillCombos(i).Enabled = CBool(UserDCTabSettings.SkillsChecked(i - 1))
            End If

            ' Use the default or use what they saved
            If UserDCTabSettings.SkillsLevel(i - 1) = Settings.DefaultSkillLevel Then
                DCSkillCombos(i).Text = CStr(TempSkillLevel)
            Else ' use what they saved
                DCSkillCombos(i).Text = CStr(UserDCTabSettings.SkillsLevel(i - 1))
            End If

        Next

        ' Load the connections and negotiation skill. If default, then load skills else use what they set
        If UserDCTabSettings.Connections = Settings.DefaultConnections Then
            cmbDCConnections.Text = CStr(SelectedCharacter.Skills.GetSkillLevel(3359))
        Else
            cmbDCConnections.Text = CStr(UserDCTabSettings.Connections)
        End If

        If UserDCTabSettings.Negotiation = Settings.DefaultNegotiation Then
            cmbDCNegotiation.Text = CStr(SelectedCharacter.Skills.GetSkillLevel(3356))
        Else
            cmbDCNegotiation.Text = CStr(UserDCTabSettings.Negotiation)
        End If

        If UserDCTabSettings.ResearchProjectMgt = Settings.DefaultResearchProjMgt Then
            cmbDCResearchMgmt.Text = CStr(SelectedCharacter.Skills.GetSkillLevel(12179))
        Else
            cmbDCResearchMgmt.Text = CStr(UserDCTabSettings.ResearchProjectMgt)
        End If

        ' Load the corp standing text boxes
        Call LoadDCCorpStandings()

        ' Check the Corporation Standings boxes if not 0
        For i = 1 To DCCorpLabels.Count - 1
            If DCCorpTextboxes(i).Text <> "0.00" Then
                DCCorpCheckBoxes(i).Checked = True
                DCCorpTextboxes(i).Enabled = True
            Else
                DCCorpCheckBoxes(i).Checked = False
                DCCorpTextboxes(i).Enabled = False
            End If
        Next

        Select Case UserDCTabSettings.PricesFrom
            Case rbtnDCUpdatedPrices.Text
                rbtnDCUpdatedPrices.Checked = True
            Case rbtnDCRegionPrices.Text
                rbtnDCRegionPrices.Checked = True
            Case rbtnDCSystemPrices.Text
                rbtnDCSystemPrices.Checked = True
        End Select

        chkDCHighSecAgents.Checked = UserDCTabSettings.CheckHighSecAgents
        chkDCLowSecAgents.Checked = UserDCTabSettings.CheckLowNullSecAgents
        chkDCIncludeAllAgents.Checked = UserDCTabSettings.CheckIncludeAgentsCannotAccess

        ' Sov checks
        chkDCAmarrSov.Checked = UserDCTabSettings.CheckSovAmarr
        chkDCAmmatarSov.Checked = UserDCTabSettings.CheckSovAmmatar
        chkDCCaldariSov.Checked = UserDCTabSettings.CheckSovCaldari
        chkDCGallenteSov.Checked = UserDCTabSettings.CheckSovGallente
        chkDCKhanidSov.Checked = UserDCTabSettings.CheckSovKhanid
        chkDCMinmatarSov.Checked = UserDCTabSettings.CheckSovMinmatar
        chkDCSyndicateSov.Checked = UserDCTabSettings.CheckSovSyndicate
        chkDCThukkerSov.Checked = UserDCTabSettings.CheckSovThukker

        DCColumnClicked = UserDCTabSettings.ColumnSort
        If UserDCTabSettings.ColumnSortType = "Ascending" Then
            DCColumnSortType = SortOrder.Ascending
        Else
            DCColumnSortType = SortOrder.Descending
        End If

        cmbDCRegions.Text = UserDCTabSettings.AgentsInRegion

    End Sub

    Private Sub btnDCSaveSettings_Click(sender As System.Object, e As System.EventArgs) Handles btnDCSaveSettings.Click
        Dim TempSettings As DataCoreTabSettings = Nothing
        Dim Settings As New ProgramSettings
        Dim TempSkill As Integer
        Dim TempStanding As Double

        ReDim TempSettings.SkillsLevel(Settings.NumberofDCSettingsSkillRecords)
        ReDim TempSettings.SkillsChecked(Settings.NumberofDCSettingsSkillRecords)
        ReDim TempSettings.CorpsStanding(Settings.NumberofDCSettingsCorpRecords)
        ReDim TempSettings.CorpsChecked(Settings.NumberofDCSettingsCorpRecords)

        If rbtnDCUpdatedPrices.Checked = True Then
            TempSettings.PricesFrom = rbtnDCUpdatedPrices.Text
        ElseIf rbtnDCRegionPrices.Checked = True Then
            TempSettings.PricesFrom = rbtnDCRegionPrices.Text
        ElseIf rbtnDCSystemPrices.Checked = True Then
            TempSettings.PricesFrom = rbtnDCSystemPrices.Text
        End If

        TempSettings.CheckHighSecAgents = chkDCHighSecAgents.Checked
        TempSettings.CheckLowNullSecAgents = chkDCLowSecAgents.Checked
        TempSettings.CheckIncludeAgentsCannotAccess = chkDCIncludeAllAgents.Checked

        TempSettings.CheckSovAmarr = chkDCAmarrSov.Checked
        TempSettings.CheckSovAmmatar = chkDCAmmatarSov.Checked
        TempSettings.CheckSovCaldari = chkDCCaldariSov.Checked
        TempSettings.CheckSovGallente = chkDCGallenteSov.Checked
        TempSettings.CheckSovKhanid = chkDCKhanidSov.Checked
        TempSettings.CheckSovMinmatar = chkDCMinmatarSov.Checked
        TempSettings.CheckSovSyndicate = chkDCSyndicateSov.Checked
        TempSettings.CheckSovThukker = chkDCThukkerSov.Checked

        TempSettings.AgentsInRegion = cmbDCRegions.Text

        ' Save skills
        For i = 1 To DCSkillCheckBoxes.Count - 1
            TempSkill = SelectedCharacter.Skills.GetSkillLevel(SelectedCharacter.Skills.GetSkillTypeID(DCSkillLabels(i).Text))

            ' Only save if they don't have the skill and have checked it or have it and unchecked it
            If (TempSkill = 0 And DCSkillCheckBoxes(i).Checked = False) Or (TempSkill <> 0 And DCSkillCheckBoxes(i).Checked = True) Then
                ' Save as default
                TempSettings.SkillsChecked(i - 1) = Settings.DefaultSkillLevelChecked
            Else
                ' Got a value
                TempSettings.SkillsChecked(i - 1) = CInt(DCSkillCheckBoxes(i).Checked)
            End If

            ' If the skill level they have is the same as the skill of the character, then just save as default
            If CInt(DCSkillCombos(i).Text) = TempSkill Then
                TempSettings.SkillsLevel(i - 1) = Settings.DefaultSkillLevel
            Else
                TempSettings.SkillsLevel(i - 1) = CInt(DCSkillCombos(i).Text)
            End If
        Next

        ' Save Corp Standings
        For i = 1 To DCCorpCheckBoxes.Count - 1
            TempStanding = CDbl(FormatNumber(SelectedCharacter.Standings.GetEffectiveStanding(DCCorpLabels(i).Text, CInt(cmbDCConnections.Text), SelectedCharacter.Skills.GetSkillLevel(3357)), 2))

            ' Only save if they don't have the standing and it's checked or they have it and unchecked
            If (TempStanding = 0 And DCCorpCheckBoxes(i).Checked = False) Or (TempStanding <> 0 And DCCorpCheckBoxes(i).Checked = True) Then
                TempSettings.CorpsChecked(i - 1) = Settings.DefaultCorpStandingChecked
            Else
                TempSettings.CorpsChecked(i - 1) = CInt(DCCorpCheckBoxes(i).Checked)
            End If

            ' If SetWindowTheme standing level they have is the same as the standing on the characters, just save as default
            If CDbl(DCCorpTextboxes(i).Text) = TempStanding Then
                TempSettings.CorpsStanding(i - 1) = Settings.DefaultCorpStanding
            Else
                TempSettings.CorpsStanding(i - 1) = CDbl(DCCorpTextboxes(i).Text)
            End If
        Next

        ' Three main skills, only save if they aren't the same as the character
        If cmbDCConnections.Text = CStr(SelectedCharacter.Skills.GetSkillLevel(3359)) Then
            TempSettings.Connections = Settings.DefaultConnections
        Else
            TempSettings.Connections = CInt(cmbDCConnections.Text)
        End If

        If cmbDCNegotiation.Text = CStr(SelectedCharacter.Skills.GetSkillLevel(3356)) Then
            TempSettings.Negotiation = Settings.DefaultNegotiation
        Else
            TempSettings.Negotiation = CInt(cmbDCNegotiation.Text)
        End If

        If cmbDCResearchMgmt.Text = CStr(SelectedCharacter.Skills.GetSkillLevel(12179)) Then
            TempSettings.ResearchProjectMgt = Settings.DefaultResearchProjMgt
        Else
            TempSettings.ResearchProjectMgt = CInt(cmbDCResearchMgmt.Text)
        End If

        TempSettings.ColumnSort = DCColumnClicked

        If DCColumnSortType = SortOrder.Ascending Then
            TempSettings.ColumnSortType = "Ascending"
        Else
            TempSettings.ColumnSortType = "Decending"
        End If

        ' Save the data in the XML file
        Call Settings.SaveDatacoreSettings(TempSettings)

        ' Save the data to the local variable
        UserDCTabSettings = TempSettings

        MsgBox("Settings Saved", vbInformation, Application.ProductName)

    End Sub

    ' Refresh's the tab with agents
    Private Sub btnDCRefresh_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnDCRefresh.Click
        Dim i As Integer
        Dim j As Integer ' for highlighting top number of agents the user can use
        Dim UniqueAgentList() As String
        Dim TotalIPH As Double = 0 ' For storing the total IPH for the top agents used
        Dim SQL As String
        Dim NegotationSkill As Integer = CInt(cmbDCNegotiation.Text)
        Dim ConnectionsSkill As Integer = CInt(cmbDCConnections.Text)
        Dim TotalRDAgents As Integer = CInt(cmbDCResearchMgmt.Text) + 1
        Dim ResearchTypeList As String = "('"
        Dim CorporationList As String = "('"
        Dim SystemSecurityCheck As String = ""

        Dim readerDC As SQLiteDataReader
        Dim readerDC2 As SQLiteDataReader
        Dim readerRecordCount As Integer

        Dim DCAgentList As New List(Of DCAgent)
        Dim TempDCAgentList As New List(Of DCAgent)
        Dim DCAgentRecord As DCAgent

        ' Price Updates
        Dim TypeIDs As New List(Of PriceItem)
        Dim TempItem As PriceItem = Nothing
        Dim DCTypeIDList As New List(Of PriceItem)
        Dim DCSystemList As New List(Of String)
        Dim DCRegionList As New List(Of String)

        Dim lstDCViewRow As ListViewItem
        Dim CanUseAgent As Boolean
        Dim CoreSkillLevel As Integer
        Dim FactionString As String = ""

        ' Standings
        Dim BaseAgentStanding As Double
        Dim BaseFactionStanding As Double
        Dim AgentStanding As Double
        Dim AgentEffectiveStanding As Double
        Dim CorpStanding As Double
        Dim FactionStanding As Double
        Dim ReqStanding As Double
        Dim ReqCorpStanding As Double

        Dim AgentLevel As Integer
        Dim Diplomacy As Integer
        Dim RPPerDay As Double
        'Dim Multiplier As Integer ' Removed with Inferno 5/22/2012
        Dim CoreSkillName As String

        ' Start
        Me.Cursor = Cursors.WaitCursor
        pnlStatus.Text = "Loading Agents..."
        Application.DoEvents()

        ' Load the Research names
        For i = 1 To DCSkillCheckBoxes.Count - 1
            If DCSkillCheckBoxes(i).Checked Then
                ' Safe this one
                ResearchTypeList = ResearchTypeList & DCSkillLabels(i).Text & "','"
            End If
        Next

        ' Format the last list
        ResearchTypeList = ResearchTypeList.Substring(0, ResearchTypeList.Length - 2) & ")"

        ' Load the Corporations
        For i = 1 To DCCorpCheckBoxes.Count - 1
            If DCCorpCheckBoxes(i).Checked Then
                CorporationList = CorporationList & DCCorpLabels(i).Text & "','"
            End If
        Next

        ' Format the last list
        CorporationList = CorporationList.Substring(0, CorporationList.Length - 2) & ")"

        ' If no corps, or skills, then exit
        If ResearchTypeList = ")" Or CorporationList = ")" Then
            MsgBox("No Datacore Agents for Selected Options", vbInformation, Application.ProductName)
            pnlStatus.Text = ""
            Me.Cursor = Cursors.Default
            Exit Sub
        End If

        ' See if they want high sec and low sec, or just high or just low sec agents - Low sec includes Null
        If chkDCHighSecAgents.Checked And Not chkDCLowSecAgents.Checked Then
            SystemSecurityCheck = " AND ROUND(SECURITY,1) >= 0.5 "
        ElseIf chkDCLowSecAgents.Checked And Not chkDCHighSecAgents.Checked Then
            SystemSecurityCheck = " AND ROUND(SECURITY,1) < 0.5 "
        End If

        ' Get count first
        SQL = "SELECT COUNT(*) FROM RESEARCH_AGENTS WHERE RESEARCH_TYPE IN " & ResearchTypeList & " AND CORPORATION_NAME IN " & CorporationList & SystemSecurityCheck

        Dim CMDCount As New SQLiteCommand(SQL, EVEDB.DBREf)
        readerRecordCount = CInt(CMDCount.ExecuteScalar())

        ' Read the settings and stats to make the query
        SQL = "SELECT FACTION, CORPORATION_ID, CORPORATION_NAME, AGENT_NAME, LEVEL, 'QUALITY', RESEARCH_TYPE_ID, "
        SQL &= "RESEARCH_TYPE, REGION_ID, REGION_NAME, SOLAR_SYSTEM_ID, SOLAR_SYSTEM_NAME, SECURITY, STATION "
        SQL &= "FROM RESEARCH_AGENTS, FACTIONS, REGIONS "
        SQL &= "WHERE RESEARCH_AGENTS.REGION_ID = REGIONS.regionID "
        SQL &= "AND REGIONS.factionID = FACTIONS.factionID "
        SQL &= "AND RESEARCH_TYPE IN " & ResearchTypeList & " AND CORPORATION_NAME IN " & CorporationList & SystemSecurityCheck

        FactionString = "AND FACTIONS.factionName in ("

        ' Set Sov check
        If chkDCAmarrSov.Checked Then
            FactionString = FactionString & "'Amarr Empire',"
        End If
        If chkDCAmmatarSov.Checked Then
            FactionString = FactionString & "'Ammatar Mandate',"
        End If
        If chkDCCaldariSov.Checked Then
            FactionString = FactionString & "'Caldari State',"
        End If
        If chkDCGallenteSov.Checked Then
            FactionString = FactionString & "'Gallente Federation',"
        End If
        If chkDCKhanidSov.Checked Then
            FactionString = FactionString & "'Khanid Kingdom',"
        End If
        If chkDCMinmatarSov.Checked Then
            FactionString = FactionString & "'Minmatar Republic',"
        End If
        If chkDCSyndicateSov.Checked Then
            FactionString = FactionString & "'The Syndicate',"
        End If
        If chkDCThukkerSov.Checked Then
            FactionString = FactionString & "'Thukker Tribe',"
        End If

        If FactionString <> "AND FACTIONS.factionName in (" Then
            FactionString = FactionString.Substring(0, Len(FactionString) - 1) & ") "
            ' Add the faction string
            SQL &= FactionString
        Else
            ' Clear
            MsgBox("No Datacore Agents for Selected Options", vbInformation, Application.ProductName)
            lstDC.Items.Clear()
            GoTo Leave
        End If

        If cmbDCRegions.Text <> "All Regions" Then
            SQL &= " AND regionName = '" & cmbDCRegions.Text & "'"
        End If

        DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
        readerDC = DBCommand.ExecuteReader

        If Not readerDC.HasRows Then
            ' Clear and exit
            MsgBox("No Datacore Agents for Selected Options", vbInformation, Application.ProductName)
            lstDC.Items.Clear()
            GoTo Leave
        End If

        pnlProgressBar.Value = 0
        pnlProgressBar.Visible = True
        pnlProgressBar.Maximum = readerRecordCount

        ' Loop through all the agents and build the list to put into the graph
        While readerDC.Read
            ' First find out what personal standing to use, faction, corp or personal
            ' Get user's base agent standing with this agent
            If Not IsNothing(SelectedCharacter.Standings) Then
                BaseAgentStanding = SelectedCharacter.Standings.GetStanding(readerDC.GetString(3))
                BaseFactionStanding = SelectedCharacter.Standings.GetStanding(readerDC.GetString(0))
            Else
                BaseAgentStanding = 0
                BaseFactionStanding = 0
            End If

            ' The corp standing will either be the original corp standing or whatever they put in (skills are applied in text box display)
            CorpStanding = GetDCtxtCorpStanding(readerDC.GetString(2))

            Diplomacy = SelectedCharacter.Skills.GetSkillLevel(3357)

            ' Standing = (BaseStanding + (10 - BaseStanding) * (0.04 * ConnectionsSkill))
            If BaseAgentStanding < 0 Then
                ' Use Diplomacy
                AgentStanding = BaseAgentStanding + ((10 - BaseAgentStanding) * (0.04 * Diplomacy))
            ElseIf BaseAgentStanding > 0 Then
                ' Use connections
                AgentStanding = BaseAgentStanding + ((10 - BaseAgentStanding) * (0.04 * ConnectionsSkill))
            Else
                AgentStanding = 0
            End If

            If BaseFactionStanding < 0 Then
                ' Use Diplomacy
                FactionStanding = BaseFactionStanding + ((10 - BaseFactionStanding) * (0.04 * Diplomacy))
            ElseIf BaseFactionStanding > 0 Then
                ' Use connections
                FactionStanding = BaseFactionStanding + ((10 - BaseFactionStanding) * (0.04 * ConnectionsSkill))
            Else
                FactionStanding = 0
            End If

            '******* Agent Quality Removed on 19 May 2011 *******
            ' Base Quality is now 20 for all agents
            AgentLevel = readerDC.GetInt32(4)

            ' Agent_Effective_Quality = Agent_Quality + (5 * Negotiation_Skill_Level) + Round_Down(AgentPersonalStanding)
            AgentEffectiveStanding = 20 + (5 * NegotationSkill) + AgentStanding

            ' Required Standing = ((Level - 1) * 2) + (Quality / 20) 
            ' ReqStanding = (AgentLevel - 1) * 2 -- May 19th change
            Select Case AgentLevel
                Case 1
                    ReqStanding = 0
                Case 2
                    ReqStanding = 1
                Case 3
                    ReqStanding = 3
                Case 4
                    ReqStanding = 5
            End Select

            ReqCorpStanding = ReqStanding - 2

            ' Now determine if we can use this agent or not based on all the data
            ' New from game: Your effective personal standings must be 3.00 or higher toward this agent's corporation in order to use this agent, 
            ' as well as an effective personal standing of 5.00 or higher toward this agent, its faction, or its corporation in order to use this agent's services.

            ' From game: Your effective personal standings must be 2.00 or higher toward this agent's 
            ' corporation in order to use this agent (level 3, qual 0, effqual 20), 
            ' as well as an effective personal standing of 4.00 or higher toward this agent, its faction, 
            ' or its corporation in order to use this agent's services.

            If CorpStanding >= ReqCorpStanding And (AgentStanding >= ReqStanding Or CorpStanding >= ReqStanding Or FactionStanding >= ReqStanding) Then
                ' Can use agent
                CanUseAgent = True
            Else
                ' Can't so grey out line
                CanUseAgent = False
            End If

            CoreSkillName = readerDC.GetString(7)
            CoreSkillLevel = GetCoreSkillLevel(CoreSkillName)

            ' Research_Points_Per_Day = Multiplier * ((1 + (Agent_Effective_Quality / 100)) *  ((Your_Skill + Agent_Skill) ^ 2))
            RPPerDay = Math.Round(((CoreSkillLevel + AgentLevel) ^ 2) * (1 + (AgentEffectiveStanding / 100)), 2)

            ' Now load information into list
            DCAgentRecord.SystemID = readerDC.GetInt64(10)
            DCAgentRecord.SystemSecurity = Math.Round(readerDC.GetDouble(12), 1)
            DCAgentRecord.RegionID = readerDC.GetInt64(8)
            DCAgentRecord.Faction = readerDC.GetString(0)
            DCAgentRecord.FactionStanding = FactionStanding
            DCAgentRecord.Corporation = readerDC.GetString(2)
            DCAgentRecord.CorporationStanding = CorpStanding
            DCAgentRecord.Agent = readerDC.GetString(3)
            DCAgentRecord.AgentStanding = Math.Truncate(AgentStanding * 100) / 100
            DCAgentRecord.AgentLevel = readerDC.GetInt32(4)
            DCAgentRecord.AgentLocation = readerDC.GetString(13) & " (" & CStr(DCAgentRecord.SystemSecurity) & ") - " & readerDC.GetString(9)  ' Station name + security + region

            ' Need the Core typeID
            Dim TempCoreName As String = ""

            If readerDC.GetString(7).Contains("Amarr Starship") Then
                TempCoreName = "Amarrian Starship Engineering"
            ElseIf readerDC.GetString(7).Contains("Gallente Starship") Then
                TempCoreName = "Gallentean Starship Engineering"
            Else
                TempCoreName = readerDC.GetString(7)
            End If

            SQL = "SELECT typeID FROM INVENTORY_TYPES WHERE typeName = 'Datacore - " & TempCoreName & "'"

            DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
            readerDC2 = DBCommand.ExecuteReader()
            If readerDC2.Read() Then
                DCAgentRecord.DataCoreID = readerDC2.GetInt64(0)
            Else
                DCAgentRecord.DataCoreID = 0
            End If
            readerDC2.Close()

            DCAgentRecord.DataCoreSkill = readerDC.GetString(7)
            DCAgentRecord.DataCoreSkillLevel = CoreSkillLevel
            DCAgentRecord.AgentAvailable = CanUseAgent
            DCAgentRecord.RPperDay = RPPerDay
            DCAgentRecord.CoresPerDay = RPPerDay / 100 ' Inferno Change - all cores cost 100 RP per core
            DCAgentRecord.DataCorePrice = 0
            DCAgentRecord.PriceFrom = ""
            DCAgentRecord.IskPerHour = 0

            ' Add the record
            DCAgentList.Add(DCAgentRecord)

            ' For each record, update the progress bar
            Call IncrementToolStripProgressBar(pnlProgressBar)

        End While

        readerDC.Close()

        pnlProgressBar.Visible = False
        Application.DoEvents()

        pnlStatus.Text = "Calculating..."
        pnlProgressBar.Value = 0
        pnlProgressBar.Maximum = DCAgentList.Count
        pnlProgressBar.Visible = True
        Application.DoEvents()

        ' Now figure out what prices to use and load accordingly
        If rbtnDCUpdatedPrices.Checked Then ' Use whatever the user has loaded in Item Prices
            For i = 0 To DCAgentList.Count - 1

                ' First save the record and then remove the record we are on
                DCAgentRecord = DCAgentList(i)
                DCAgentRecord.DataCorePrice = GetItemPrice(DCAgentList(i).DataCoreID)
                DCAgentRecord.DataCorePrice -= DataCoreRedeemCost ' Add an amount of Isk to redeem each datacore, so subtract this from the market price
                DCAgentRecord.PriceFrom = "Current"
                DCAgentRecord.IskPerHour = Math.Round((DCAgentRecord.DataCorePrice * DCAgentRecord.CoresPerDay) / 24, 2)

                ' Insert the record
                TempDCAgentList.Add(DCAgentRecord)

            Next

        ElseIf rbtnDCRegionPrices.Checked Then ' Look up the max buy price for the region the Agent is located
            ' Update the price cache with our list of Regions for these datacores
            ' Build the list of datacore ID's and Regions
            For i = 0 To DCAgentList.Count - 1
                TempItem.Manufacture = False
                TempItem.TypeID = DCAgentList(i).DataCoreID
                TempItem.GroupName = GetPriceGroupName(TempItem.TypeID)
                TempItem.PriceModifier = 0
                TempItem.SystemID = ""

                Dim TempRegionList As New List(Of String)
                TempItem.RegionID = DCRegionList(j)

                If Not DCTypeIDList.Contains(TempItem) Then
                    DCTypeIDList.Add(TempItem)
                End If

                If Not DCRegionList.Contains(CStr(DCAgentList(i).RegionID)) Then
                    DCRegionList.Add(CStr(DCAgentList(i).RegionID))
                End If

            Next

            ' Update
            Call UpdatePricesCache(DCTypeIDList)

            ' Now search for each item's price in the cache with its region and pull up the max buy order
            For i = 0 To DCAgentList.Count - 1
                SQL = "SELECT buyMax FROM ITEM_PRICES_CACHE WHERE typeID =" & DCAgentList(i).DataCoreID & " AND RegionOrSystem =" & DCAgentList(i).RegionID & " AND PRICE_SOURCE = " & UpdatePricesDataSource

                DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
                readerDC2 = DBCommand.ExecuteReader()

                DCAgentRecord = DCAgentList(i)

                If readerDC2.Read Then
                    DCAgentRecord.DataCorePrice = readerDC2.GetDouble(0)
                Else
                    DCAgentRecord.DataCorePrice = 0
                End If

                DCAgentRecord.DataCorePrice -= DataCoreRedeemCost ' Add an amount of Isk to redeem each datacore, so subtract this from the market price

                DCAgentRecord.PriceFrom = "Region"
                DCAgentRecord.IskPerHour = Math.Round((DCAgentRecord.DataCorePrice * DCAgentRecord.CoresPerDay) / 24, 2)

                ' Insert the record
                TempDCAgentList.Add(DCAgentRecord)

                readerDC2.Close()
            Next

        ElseIf rbtnDCSystemPrices.Checked Then ' Use the max buy price for the system the Agent is located
            ' Update the price cache with a list of systems for these datacores
            ' Build the list of datacore ID's and systems
            For i = 0 To DCAgentList.Count - 1
                TempItem.Manufacture = False
                TempItem.TypeID = DCAgentList(i).DataCoreID
                TempItem.GroupName = GetPriceGroupName(TempItem.TypeID)
                TempItem.PriceModifier = 0
                TempItem.SystemID = CStr(DCAgentList(i).SystemID)
                TempItem.RegionID = ""

                If Not DCTypeIDList.Contains(TempItem) Then
                    DCTypeIDList.Add(TempItem)
                End If

                If Not DCSystemList.Contains(CStr(DCAgentList(i).SystemID)) Then
                    DCSystemList.Add(CStr(DCAgentList(i).SystemID))
                End If

            Next

            ' Need to update the cache for each region, for all typeids so send one system at a time
            For i = 0 To DCSystemList.Count - 1
                Call UpdatePricesCache(DCTypeIDList)
            Next

            ' Now search for each item's price in the cache with its solar system and pull up the max buy order
            For i = 0 To DCAgentList.Count - 1
                SQL = "SELECT buyMax FROM ITEM_PRICES_CACHE WHERE typeID =" & DCAgentList(i).DataCoreID & " AND RegionOrSystem =" & DCAgentList(i).SystemID & " AND PRICE_SOURCE = " & UpdatePricesDataSource

                DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
                readerDC2 = DBCommand.ExecuteReader()

                DCAgentRecord = DCAgentList(i)

                If readerDC2.Read Then
                    DCAgentRecord.DataCorePrice = readerDC2.GetDouble(0)
                Else
                    DCAgentRecord.DataCorePrice = 0
                End If

                DCAgentRecord.DataCorePrice -= DataCoreRedeemCost ' Add an amount of Isk to redeem each datacore, so subtract this from the market price

                DCAgentRecord.PriceFrom = "System"
                DCAgentRecord.IskPerHour = Math.Round((DCAgentRecord.DataCorePrice * DCAgentRecord.CoresPerDay) / 24, 2)

                ' Insert the record
                TempDCAgentList.Add(DCAgentRecord)

                readerDC2.Close()
            Next

        End If

        ' Set the updated list
        DCAgentList = TempDCAgentList
        ' Sort by IPH for calculating the top 5
        DCAgentList.Sort(New DataCoreIPHComparer)

        ' Get number of R&D Agents they can use
        ReDim UniqueAgentList(TotalRDAgents - 1)
        j = 0

        pnlStatus.Text = "Refreshing List..."
        pnlProgressBar.Value = 0
        pnlProgressBar.Maximum = DCAgentList.Count
        pnlProgressBar.Visible = True
        Application.DoEvents()

        ' Build a list of unique agent names equal to number the user can use in order of Isk per hour
        For i = 0 To DCAgentList.Count - 1
            If DCAgentList(i).AgentAvailable Or (Not DCAgentList(i).AgentAvailable And chkDCIncludeAllAgents.Checked) Then ' make sure we want to look at this one
                If Not UniqueAgentList.Contains(DCAgentList(i).Agent) Then
                    ' Add the agent
                    UniqueAgentList(j) = DCAgentList(i).Agent
                    j = j + 1

                    If j > TotalRDAgents - 1 Then
                        Exit For
                    End If
                End If
            End If
        Next

        j = 0
        lstDC.Items.Clear()

        ' Load the data into the table
        lstDC.BeginUpdate()
        For i = 0 To DCAgentList.Count - 1
            If DCAgentList(i).AgentAvailable Or (Not DCAgentList(i).AgentAvailable And chkDCIncludeAllAgents.Checked) Then
                lstDCViewRow = New ListViewItem("") ' Check
                'The remaining columns are subitems  
                lstDCViewRow.SubItems.Add(DCAgentList(i).Corporation)
                lstDCViewRow.SubItems.Add(DCAgentList(i).Agent)
                lstDCViewRow.SubItems.Add(CStr(DCAgentList(i).AgentLevel))
                lstDCViewRow.SubItems.Add(FormatNumber(DCAgentList(i).AgentStanding, 2))
                lstDCViewRow.SubItems.Add(DCAgentList(i).AgentLocation)
                lstDCViewRow.SubItems.Add(DCAgentList(i).DataCoreSkill)
                lstDCViewRow.SubItems.Add(FormatNumber(DCAgentList(i).DataCorePrice, 2))
                lstDCViewRow.SubItems.Add(DCAgentList(i).PriceFrom)
                lstDCViewRow.SubItems.Add(FormatNumber(DCAgentList(i).CoresPerDay, 2))
                lstDCViewRow.SubItems.Add(FormatNumber(DCAgentList(i).IskPerHour, 2))

                ' Color in the top 5 unique agents
                If j <= TotalRDAgents - 1 Then
                    If DCAgentList(i).Agent = UniqueAgentList(j) Then
                        ' Color this row
                        lstDCViewRow.BackColor = Color.LightGreen
                        ' Save the total iph for this agent and add it to the total
                        TotalIPH = TotalIPH + DCAgentList(i).IskPerHour
                        ' Move to next agent name
                        j = j + 1
                    End If
                End If

                ' If the agent can't be used, grey out the row
                If Not DCAgentList(i).AgentAvailable Then
                    lstDCViewRow.ForeColor = Color.Gray
                Else
                    Select Case DCAgentList(i).SystemSecurity
                        Case Is < 0.1
                            lstDCViewRow.ForeColor = Color.Red
                        Case Is < 0.5
                            lstDCViewRow.ForeColor = Color.Orange
                        Case Else
                            lstDCViewRow.ForeColor = Color.Black
                    End Select
                End If

                ' Finally, highlight with blue text the agents we have selected
                For Each DBAgent In SelectedCharacter.GetResearchAgents.GetResearchAgents
                    If DCAgentList(i).Agent = DBAgent.Agent And DCAgentList(i).AgentLevel = DBAgent.AgentLevel _
                        And DCAgentList(i).DataCoreSkill = DBAgent.Field And DCAgentList(i).AgentAvailable Then
                        lstDCViewRow.ForeColor = Color.Blue
                        Exit For
                    End If
                Next

                Call lstDC.Items.Add(lstDCViewRow)

            End If

            ' For each record, update the progress bar
            Call IncrementToolStripProgressBar(pnlProgressBar)

        Next

        ' Now sort this
        Dim TempType As SortOrder
        If DCColumnSortType = SortOrder.Ascending Then
            TempType = SortOrder.Descending
        Else
            TempType = SortOrder.Ascending
        End If
        Call ListViewColumnSorter(DCColumnClicked, CType(lstDC, ListView), DCColumnClicked, TempType)
        Me.Cursor = Cursors.Default
        lstDC.EndUpdate()

        ' Update the Total IPH
        txtDCTotalOptIPH.Text = FormatNumber(TotalIPH, 2)

Leave:
        ' End
        Me.Cursor = Cursors.Default
        pnlStatus.Text = ""
        pnlProgressBar.Visible = False
        Application.DoEvents()

    End Sub

    ' Returns the text standing in the DC box for the corp name sent
    Private Function GetDCtxtCorpStanding(ByVal CorpName As String) As Double
        ' Load the Research names
        For i = 1 To DCCorpLabels.Count - 1
            ' Compare to the label (all indexes are synched)
            If DCCorpLabels(i).Text = CorpName Then
                ' Return the value of the text box
                If Trim(DCCorpTextboxes(i).Text) = "" Or Not IsNumeric(DCCorpTextboxes(i).Text) Then
                    DCCorpTextboxes(i).Text = "0.00"
                    Return 0
                Else
                    Return CDbl(DCCorpTextboxes(i).Text)
                End If
            End If
        Next

        Return 0
    End Function

    ' Returns the skill set in the combo boxes that is sent
    Private Function GetCoreSkillLevel(ByVal SkillName As String) As Integer
        Dim i As Integer

        For i = 1 To DCSkillLabels.Count - 1
            If DCSkillLabels(i).Text = SkillName Then
                Return CInt(DCSkillCombos(i).Text)
            End If
        Next

        Return 0

    End Function

    ' Loads the corporation standings on the Datacore screen
    Private Sub LoadDCCorpStandings(Optional ByVal UpdateCheckBoxes As Boolean = True)
        Dim Settings As New ProgramSettings

        ' Load the Corporation Standings with skills
        If SelectedCharacter.Name <> None Then
            For i = 1 To DCCorpLabels.Count - 1

                ' Check based on default
                If UserDCTabSettings.CorpsStanding(i - 1) = Settings.DefaultCorpStanding Then
                    DCCorpTextboxes(i).Text = FormatNumber(SelectedCharacter.Standings.GetEffectiveStanding(DCCorpLabels(i).Text, CInt(cmbDCConnections.Text), SelectedCharacter.Skills.GetSkillLevel(3357)), 2)
                Else ' use what they entered
                    DCCorpTextboxes(i).Text = FormatNumber(UserDCTabSettings.CorpsStanding(i - 1), 2)
                End If

                If UpdateCheckBoxes Then
                    ' check it based on defaults
                    If UserDCTabSettings.CorpsChecked(i - 1) = Settings.DefaultCorpStandingChecked Then
                        If DCCorpTextboxes(i).Text <> "0.00" Then
                            DCCorpCheckBoxes(i).Checked = True
                            DCCorpTextboxes(i).Enabled = True
                        Else
                            DCCorpCheckBoxes(i).Checked = False
                            DCCorpTextboxes(i).Enabled = False
                        End If
                    Else ' What they set
                        DCCorpCheckBoxes(i).Checked = CBool(UserDCTabSettings.CorpsChecked(i - 1))
                        DCCorpTextboxes(i).Enabled = CBool(UserDCTabSettings.CorpsChecked(i - 1))
                    End If

                End If

            Next

            If UpdateCheckBoxes Then
                txtDCTotalOptIPH.Text = "0.00"
                txtDCTotalSelectedIPH.Text = "0.00"
                lstDC.Items.Clear()
            End If
        Else
            ' Using dummy, so uncheck all and disable all boxes
            For i = 1 To DCCorpLabels.Count - 1
                DCCorpCheckBoxes(i).Checked = False
                DCCorpTextboxes(i).Enabled = False
                DCCorpTextboxes(i).Text = "0.00"
            Next
        End If

    End Sub

    Private Sub btnDCExporttoClip_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnDCExporttoClip.Click
        Dim ClipboardData = New DataObject
        Dim OutputText As String = ""
        Dim item As ListViewItem
        Dim checkeditems As ListView.CheckedListViewItemCollection
        Dim ItemsSelected As Boolean = False
        Dim Separator As String = ""

        If lstDC.CheckedItems.Count <> 0 Then
            ' For each checked item, export the data
            checkeditems = lstDC.CheckedItems

            If UserApplicationSettings.DataExportFormat = CSVDataExport Then
                Separator = ", "
            ElseIf UserApplicationSettings.DataExportFormat = SSVDataExport Then
                Separator = "; "
            End If

            If UserApplicationSettings.DataExportFormat = CSVDataExport Then
                OutputText = "Selected R&D Agents:" & Environment.NewLine & "Corporation, Agent Name, Agent Level, Agent Location, DataCore Skill, Isk per Hour" & Environment.NewLine & Environment.NewLine
            ElseIf UserApplicationSettings.DataExportFormat = SSVDataExport Then
                OutputText = "Selected R&D Agents:" & Environment.NewLine & "Corporation; Agent Name; Agent Level; Agent Location; DataCore Skill; Isk per Hour" & Environment.NewLine & Environment.NewLine
            Else
                OutputText = "Selected R&D Agents:" & Environment.NewLine & Environment.NewLine
            End If

            For Each item In checkeditems
                ItemsSelected = True
                If UserApplicationSettings.DataExportFormat = CSVDataExport Or UserApplicationSettings.DataExportFormat = SSVDataExport Then
                    OutputText = OutputText & item.SubItems(1).Text & Separator & item.SubItems(2).Text & Separator & item.SubItems(3).Text & Separator
                    OutputText = OutputText & item.SubItems(5).Text & Separator & item.SubItems(6).Text & Separator
                    If UserApplicationSettings.DataExportFormat = SSVDataExport Then
                        ' Replace any commas with decimals and vice versa
                        OutputText = OutputText & ConvertUStoEUDecimal(item.SubItems(10).Text) & Separator & Environment.NewLine
                    Else ' Save as normal but remove any commas in the price
                        OutputText = OutputText & item.SubItems(10).Text.Replace(",", "") & Separator & Environment.NewLine
                    End If
                Else
                    OutputText = OutputText & "Corporation: " & item.SubItems(1).Text & Environment.NewLine
                    OutputText = OutputText & "Agent Name: " & item.SubItems(2).Text & Environment.NewLine
                    OutputText = OutputText & "Agent Level: " & item.SubItems(3).Text & Environment.NewLine
                    OutputText = OutputText & "Agent Location: " & item.SubItems(5).Text & Environment.NewLine
                    OutputText = OutputText & "Datacore Skill: " & item.SubItems(6).Text & Environment.NewLine
                    OutputText = OutputText & "Isk per Hour: " & item.SubItems(10).Text & Environment.NewLine & Environment.NewLine
                End If
            Next

            If ItemsSelected Then
                ' Paste to clipboard
                Call CopyTextToClipboard(OutputText)
            End If
        Else
            MsgBox("No Agents Selected", vbInformation, Application.ProductName)
        End If

    End Sub

    Private Sub cmbDCRegions_DropDown(ByVal sender As Object, ByVal e As System.EventArgs) Handles cmbDCRegions.DropDown
        Dim SQL As String
        Dim readerReg As SQLiteDataReader

        If Not DCRegionsLoaded Then

            ' Load the select systems combobox with systems
            SQL = "SELECT regionName FROM RESEARCH_AGENTS, REGIONS WHERE RESEARCH_AGENTS.REGION_ID = REGIONS.regionID "
            SQL &= "GROUP BY regionName"

            DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
            readerReg = DBCommand.ExecuteReader

            cmbDCRegions.Items.Add("All Regions")

            While readerReg.Read
                cmbDCRegions.Items.Add(readerReg.GetString(0))
            End While

            readerReg.Close()

            cmbDCRegions.Text = "All Regions"
            DCRegionsLoaded = True

        End If

    End Sub

    ' For sorting a list of Mining Ore
    Public Class DataCoreIPHComparer

        Implements System.Collections.Generic.IComparer(Of DCAgent)

        Public Function Compare(ByVal p1 As DCAgent, ByVal p2 As DCAgent) As Integer Implements IComparer(Of DCAgent).Compare
            ' swap p2 and p1 to do decending sort
            Return p2.IskPerHour.CompareTo(p1.IskPerHour)
        End Function

    End Class

#End Region

#Region "Mining"

#Region "Mining Object Functions"

    Private Sub lstMineGrid_ColumnWidthChanging(sender As Object, e As System.Windows.Forms.ColumnWidthChangingEventArgs) Handles lstMineGrid.ColumnWidthChanging
        If e.ColumnIndex = 0 Then
            e.Cancel = True
            e.NewWidth = lstPricesView.Columns(e.ColumnIndex).Width
        End If
    End Sub

    Private Sub lstMineGrid_MouseClick(sender As System.Object, e As System.Windows.Forms.MouseEventArgs) Handles lstMineGrid.MouseClick
        Call ListClicked(lstMineGrid, sender, e)
    End Sub

    Private Sub OreCheckProcessing_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkOreProcessing1.CheckedChanged, chkOreProcessing2.CheckedChanged, chkOreProcessing3.CheckedChanged,
                                                                                                                      chkOreProcessing4.CheckedChanged, chkOreProcessing5.CheckedChanged, chkOreProcessing6.CheckedChanged,
                                                                                                                      chkOreProcessing7.CheckedChanged, chkOreProcessing8.CheckedChanged, chkOreProcessing9.CheckedChanged,
                                                                                                                      chkOreProcessing10.CheckedChanged, chkOreProcessing11.CheckedChanged, chkOreProcessing12.CheckedChanged


        Call UpdateProcessingSkillBoxes(CInt(CType(sender, CheckBox).Name.Substring(16)), CType(sender, CheckBox).Checked)
    End Sub

    Private Sub UpdateProcessingSkillBoxes(ByVal Index As Integer, ByVal Checked As Boolean)
        MineProcessingCombos(Index).Enabled = Checked
        MineProcessingLabels(Index).Enabled = Checked
    End Sub

    Private Sub cmbMineDroneName_SelectedIndexChanged(sender As Object, e As EventArgs) Handles cmbMineDroneName.SelectedIndexChanged
        If Not FirstLoad Then
            Call UpdateNumberMiningDrones(cmbMineDroneName.Text, cmbMineShipName.Text, cmbMineNumMiningDrones, False)
        End If
    End Sub

    Private Sub cmbMineBoosterDroneName_SelectedIndexChanged(sender As Object, e As EventArgs) Handles cmbMineBoosterDroneName.SelectedIndexChanged
        If Not FirstLoad Then
            Call UpdateNumberMiningDrones(cmbMineBoosterDroneName.Text, cmbMineBoosterShipName.Text, cmbMineBoosterNumMiningDrones, False)
        End If
    End Sub

    Private Sub cmbMineShipName_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbMineShipName.SelectedIndexChanged
        If Not UpdatingMiningShips And Not FirstLoad Then
            Call LoadMiningshipImage()
            Call UpdateMiningSkills()
            Call UpdateMiningShipEquipment()
            Call UpdateShipMiningDrones()

            If MiningShipSelected() And cmbMineOreType.Text = "Ore" Then
                chkMineMichiImplant.Enabled = True
            Else
                chkMineMichiImplant.Enabled = False
                chkMineMichiImplant.ForeColor = Color.Black
            End If

            ' Save the ship selected locally so it reloads if they select a different mining type
            Select Case cmbMineOreType.Text
                Case "Ore"
                    UserMiningTabSettings.OreMiningShip = cmbMineShipName.Text
                Case "Ice"
                    UserMiningTabSettings.IceMiningShip = cmbMineShipName.Text
                Case "Gas"
                    UserMiningTabSettings.GasMiningShip = cmbMineShipName.Text
            End Select

            ' Clear the grid
            lstMineGrid.Items.Clear()
        End If
    End Sub

    Private Sub cmbMineShipName_DropDown(ByVal sender As Object, ByVal e As System.EventArgs) Handles cmbMineShipName.DropDown
        Call UpdateMiningShipsCombo()
    End Sub

    Private Sub cmbMineAstrogeology_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbMineAstrogeology.SelectedIndexChanged
        If Not FirstLoad Then
            Call UpdateMiningShipForm(True)
        End If
    End Sub

    Private Sub cmbMineAdvShipSkill_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbMineAdvShipSkill.SelectedIndexChanged
        If Not FirstLoad Then
            Call UpdateMiningShipForm(False)
        End If
    End Sub

    Private Sub cmbMineBaseShipSkill_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbMineBaseShipSkill.SelectedIndexChanged
        If Not FirstLoad Then
            Call UpdateMiningShipForm(False)
        End If
    End Sub

    Private Sub cmbMineSkill_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbMineSkill.SelectedIndexChanged
        If Not FirstLoad Then
            Call UpdateMiningShipForm(True)
        End If
    End Sub

    Private Sub cmbMineIceHarvesting_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbMineGasIceHarvesting.SelectedIndexChanged
        If Not FirstLoad Then
            Call UpdateMiningShipForm(True)
        End If
    End Sub

    Private Sub cmbMineDeepCore_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbMineDeepCore.SelectedIndexChanged
        If Not FirstLoad Then
            Call UpdateMiningShipForm(True)
        End If
    End Sub

    Private Sub cmbMineType_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbMineOreType.SelectedIndexChanged

        If cmbMineOreType.Text = "Ice" Then
            chkMineIncludeHighYieldOre.Enabled = False
            gbMiningRigs.Enabled = True
            chkMineIncludeHighYieldOre.Text = "High Yield Ice"
            chkMineIncludeHighSec.Text = "High Sec Ice"
            chkMineIncludeLowSec.Text = "Low Sec Ice"
            chkMineIncludeNullSec.Text = "Null Sec Ice"
            lstMineGrid.Columns(1).Text = "Ice Name"
            lblMineFacilityOreRate1.Text = "Ice:"
            tabMiningDrones.Enabled = True
            chkMineMoonMining.Enabled = False ' Can't moon mine ice
            chkMineRefinedOre.Enabled = True

            ' No ice in wormholes
            chkMineWH.Enabled = False
            chkMineC1.Enabled = False
            chkMineC2.Enabled = False
            chkMineC3.Enabled = False
            chkMineC4.Enabled = False
            chkMineC5.Enabled = False
            chkMineC6.Enabled = False

        ElseIf cmbMineOreType.Text = "Ore" Then
            gbMiningRigs.Enabled = True
            chkMineIncludeHighYieldOre.Enabled = True
            chkMineIncludeHighYieldOre.Text = "High Yield Ores"
            chkMineIncludeHighSec.Text = "High Sec Ore"
            chkMineIncludeLowSec.Text = "Low Sec Ore"
            chkMineIncludeNullSec.Text = "Null Sec Ore"
            lstMineGrid.Columns(1).Text = "Ore Name"
            lblMineFacilityOreRate1.Text = "Ore:"
            tabMiningDrones.Enabled = True
            chkMineMoonMining.Enabled = True ' Moon mining
            chkMineRefinedOre.Enabled = True

            chkMineWH.Enabled = True
            If chkMineWH.Checked Then
                chkMineC1.Enabled = True
                chkMineC2.Enabled = True
                chkMineC3.Enabled = True
                chkMineC4.Enabled = True
                chkMineC5.Enabled = True
                chkMineC6.Enabled = True
            Else
                chkMineC1.Enabled = False
                chkMineC2.Enabled = False
                chkMineC3.Enabled = False
                chkMineC4.Enabled = False
                chkMineC5.Enabled = False
                chkMineC6.Enabled = False
            End If

        ElseIf cmbMineOreType.Text = "Gas" Then
            gbMiningRigs.Enabled = False
            chkMineIncludeHighYieldOre.Enabled = False
            chkMineIncludeHighYieldOre.Text = "High Yield Gas"
            chkMineIncludeHighSec.Text = "High Sec Gas"
            chkMineIncludeLowSec.Text = "Low Sec Gas"
            chkMineIncludeNullSec.Text = "Null Sec Gas"
            lstMineGrid.Columns(1).Text = "Gas Name"
            tabMiningDrones.Enabled = False
            chkMineWH.Enabled = True
            chkMineC1.Enabled = True
            chkMineC2.Enabled = True
            chkMineC3.Enabled = True
            chkMineC4.Enabled = True
            chkMineC5.Enabled = True
            chkMineC6.Enabled = True

            chkMineMoonMining.Enabled = False ' Can't moon mine gas

            ' Dont allow refining for gas
            chkMineRefinedOre.Enabled = False
            If chkMineRefinedOre.Checked Then
                ' Auto select if they had refined checked
                chkMineUnrefinedOre.Checked = True
                chkMineRefinedOre.Checked = False
            End If

        End If

        Call UpdateBoosterDroneRigChecks()

        If Not FirstLoad Then
            ' Load all the skills for the character first
            Call LoadCharacterMiningSkills()
            Call UpdateMiningImplants()
            Call UpdateMiningShipForm(True)
            Call UpdateProcessingSkills()
            Call UpdateShipMiningDrones()
            Call UpdateBoosterMiningDrones()
            Call RefreshMiningTabRefiningRates()
        End If

        lstMineGrid.Items.Clear()

    End Sub

    Private Sub lstMineGrid_ColumnClick(ByVal sender As System.Object, ByVal e As System.Windows.Forms.ColumnClickEventArgs) Handles lstMineGrid.ColumnClick
        Call ListViewColumnSorter(e.Column, lstMineGrid, MiningColumnClicked, MiningColumnSortType)
    End Sub

    Private Sub chkMineUseFleetBooster_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkMineUseFleetBooster.CheckedChanged
        If Not FirstLoad Then
            Call LoadFleetBoosterImage()
            Call UpdateBoosterSkills()
            If chkMineUseFleetBooster.Checked And chkMineBoosterUseDrones.Checked Then
                tabBoosterDrones.Enabled = True
            Else
                tabBoosterDrones.Enabled = False
            End If
        End If
    End Sub

    Private Sub cmbMineMiningForeman_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbMineMiningForeman.SelectedIndexChanged
        If Not FirstLoad Then
            Call UpdateBoosterSkills()
        End If
    End Sub

    Private Sub cmbMineMiningDirector_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbMineMiningDirector.SelectedIndexChanged
        If Not FirstLoad Then
            Call UpdateBoosterSkills()
        End If
    End Sub

    Private Sub cmbMineBoosterShip_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbMineBoosterShipName.SelectedIndexChanged
        If Not UpdatingMiningShips Then
            Call LoadFleetBoosterImage()
            Call UpdateBoosterSkills()
            Call UpdateBoosterMiningDrones()
            ' Clear the grid
            lstMineGrid.Items.Clear()
        End If
    End Sub

    Private Sub chkMineForemanBooster_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles chkMineForemanLaserOpBoost.Click
        Call UpdateMiningBoosterObjects()
    End Sub

    Private Sub txtMineNumberMiners_KeyPress(sender As Object, e As System.Windows.Forms.KeyPressEventArgs) Handles txtMineNumberMiners.KeyPress
        ' Only allow numbers or backspace
        If e.KeyChar <> ControlChars.Back Then
            If allowedPriceChars.IndexOf(e.KeyChar) = -1 Then
                ' Invalid Character
                e.Handled = True
            End If
        End If
    End Sub

    Private Sub txtMineTotalJumpM3_KeyPress(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyPressEventArgs)
        ' Only allow numbers or backspace
        If e.KeyChar <> ControlChars.Back Then
            If allowedPriceChars.IndexOf(e.KeyChar) = -1 Then
                ' Invalid Character
                e.Handled = True
            End If
        End If
    End Sub

    Private Sub txtMineTotalJumpFuel_KeyPress(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyPressEventArgs)
        ' Only allow numbers or backspace
        If e.KeyChar <> ControlChars.Back Then
            If allowedPriceChars.IndexOf(e.KeyChar) = -1 Then
                ' Invalid Character
                e.Handled = True
            End If
        End If
    End Sub

    Private Sub chkMineUseHauler_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkMineUseHauler.CheckedChanged
        If chkMineUseHauler.Checked Then
            lblMineRTMin.Enabled = False
            txtMineRTMin.Enabled = False
            lblMineRTSec.Enabled = False
            txtMineRTSec.Enabled = False
            lblMineHaulerM3.Enabled = False
            txtMineHaulerM3.Enabled = False
        Else
            lblMineRTMin.Enabled = True
            txtMineRTMin.Enabled = True
            lblMineRTSec.Enabled = True
            txtMineRTSec.Enabled = True
            lblMineHaulerM3.Enabled = True
            txtMineHaulerM3.Enabled = True
        End If

        ' Refresh this value regardless
        Call RefreshHaulerM3()

    End Sub

    Private Sub txtMineRTMin_GotFocus(ByVal sender As Object, ByVal e As System.EventArgs) Handles txtMineRTMin.GotFocus
        Call txtMineRTMin.SelectAll()
    End Sub

    Private Sub txtMineHaulerM3_GotFocus(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles txtMineHaulerM3.GotFocus
        Call txtMineHaulerM3.SelectAll()
    End Sub

    Private Sub txtMineHaulerM3_KeyPress(sender As System.Object, e As System.Windows.Forms.KeyPressEventArgs) Handles txtMineHaulerM3.KeyPress
        ' Only allow numbers or backspace
        If e.KeyChar <> ControlChars.Back Then
            If allowedRunschars.IndexOf(e.KeyChar) = -1 Then
                ' Invalid Character
                e.Handled = True
            End If
        End If
    End Sub

    Private Sub txtMineHaulerM3_LostFocus(sender As Object, e As System.EventArgs) Handles txtMineHaulerM3.LostFocus
        txtMineHaulerM3.Text = FormatNumber(txtMineHaulerM3.Text, 1)
    End Sub

    Private Sub txtMineRTMin_KeyPress(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyPressEventArgs) Handles txtMineRTMin.KeyPress
        ' Only allow numbers or backspace
        If e.KeyChar <> ControlChars.Back Then
            If allowedRunschars.IndexOf(e.KeyChar) = -1 Then
                ' Invalid Character
                e.Handled = True
            End If
        End If
    End Sub

    Private Sub txtMineRTSec_GotFocus(ByVal sender As Object, ByVal e As System.EventArgs) Handles txtMineRTSec.GotFocus
        Call txtMineRTSec.SelectAll()
    End Sub

    Private Sub txtMineRTSec_KeyPress(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyPressEventArgs) Handles txtMineRTSec.KeyPress
        ' Only allow numbers or backspace
        If e.KeyChar <> ControlChars.Back Then
            If allowedRunschars.IndexOf(e.KeyChar) = -1 Then
                ' Invalid Character
                e.Handled = True
            End If
        End If
    End Sub

    Private Sub txtMineRTSec_TextChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles txtMineRTSec.TextChanged
        ' Update the minutes and seconds if they enter greater than 60
        If CInt(txtMineRTSec.Text) >= 60 Then
            txtMineRTMin.Text = CStr(Math.Floor(CInt(txtMineRTSec.Text) / 60))
            txtMineRTSec.Text = CStr(CInt(txtMineRTSec.Text) - (CInt(txtMineRTMin.Text) * 60))
        End If
    End Sub

    Private Sub btnMineRefresh_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnMineRefresh.Click
        Call LoadMiningGrid()
    End Sub

    Private Sub btnMineReset_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnMineReset.Click
        Call LoadMiningTab()
    End Sub

    Private Sub cmbMineRefining_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbMineRefining.SelectedIndexChanged

        ' Load up the right processing checks
        Call UpdateProcessingSkills()

    End Sub

    Private Sub cmbMineRefineryEff_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbMineRefineryEff.SelectedIndexChanged

        ' Load up the right processing checks
        Call UpdateProcessingSkills()

    End Sub

    Private Sub cmbMineMiningLaser_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbMineMiningLaser.SelectedIndexChanged
        Dim rsLookup As SQLiteDataReader
        Dim SQL As String

        SQL = "SELECT 'X' FROM ATTRIB_LOOKUP WHERE typeName = '" & cmbMineMiningLaser.Text & "' "
        SQL &= "AND attributeID IN (604,605) AND value IN (663,482)" ' 604 and 605 are used with charge groups...and the values returned are groupIDs for mercoxit mining crystal or mining crystal resp

        DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
        rsLookup = DBCommand.ExecuteReader

        If rsLookup.HasRows Then
            ' Enable the crystal group boxes
            gbMineCrystals.Enabled = True
            gbMineCrystalType.Enabled = True
        Else
            gbMineCrystals.Enabled = False
            gbMineCrystalType.Enabled = False
        End If

        rsLookup.Close()

    End Sub

    Private Sub txtMineBrokerFeeRate_KeyDown(sender As Object, e As KeyEventArgs) Handles txtMineBrokerFeeRate.KeyDown
        If e.KeyCode = Keys.Enter Then
            txtMineBrokerFeeRate.Text = GetFormattedPercentEntry(txtMineBrokerFeeRate)
        End If
    End Sub

    Private Sub txtMineBrokerFeeRate_KeyPress(sender As Object, e As KeyPressEventArgs) Handles txtMineBrokerFeeRate.KeyPress
        ' Only allow numbers, decimal, percent or backspace
        If e.KeyChar <> ControlChars.Back Then
            If allowedPercentChars.IndexOf(e.KeyChar) = -1 Then
                ' Invalid Character
                e.Handled = True
            End If
        End If
    End Sub

    Private Sub txtMineBrokerFeeRate_GotFocus(sender As Object, e As EventArgs) Handles txtMineBrokerFeeRate.GotFocus
        Call txtMineBrokerFeeRate.SelectAll()
    End Sub

    Private Sub txtMineBrokerFeeRate_LostFocus(sender As Object, e As EventArgs) Handles txtMineBrokerFeeRate.LostFocus
        txtMineBrokerFeeRate.Text = GetFormattedPercentEntry(txtMineBrokerFeeRate)
    End Sub

    Private Sub chkMineIncludeBrokerFees_Click(sender As Object, e As EventArgs) Handles chkMineIncludeBrokerFees.Click
        If chkMineIncludeBrokerFees.Checked And chkMineIncludeBrokerFees.CheckState = CheckState.Indeterminate Then ' Show rate box
            txtMineBrokerFeeRate.Visible = True
        Else
            txtMineBrokerFeeRate.Visible = False
        End If
    End Sub

    Private Sub chkMineForemanLaserRangeBoost_Click(sender As Object, e As System.EventArgs) Handles chkMineForemanLaserRangeBoost.Click
        Call UpdateMiningBoosterObjects()
    End Sub

    Private Sub BoosterMiningDroneRigs_Click(sender As Object, e As EventArgs) Handles chkMineBoosterDroneRig1.Click, chkMineBoosterDroneRig2.Click, chkMineBoosterDroneRig3.Click
        Call UpdateDroneRigChecks(CType(sender, CheckBox))
        Call UpdateBoosterMiningDroneStats()
    End Sub

    Private Sub ShipMiningDroneRigs_SelectedIndexChanged(sender As Object, e As EventArgs) Handles cmbMineMiningRig1.SelectedIndexChanged, cmbMineMiningRig2.SelectedIndexChanged, cmbMineMiningRig3.SelectedIndexChanged
        Call UpdateShipMiningDroneStats()
    End Sub

    Private Sub chkMineBoosterUseDrones_CheckedChanged(sender As Object, e As EventArgs) Handles chkMineBoosterUseDrones.CheckedChanged
        Call UpdateBoosterDroneRigChecks()
    End Sub

    Private Sub UpdateDroneRigChecks(ByRef RigCheckbox As CheckBox, Optional Value As Integer = -1)
        If Value <> -1 Then
            Select Case Value
                Case 2
                    RigCheckbox.CheckState = CheckState.Indeterminate
                Case 1
                    RigCheckbox.Checked = True
                Case 0
                    RigCheckbox.Checked = False
            End Select
        End If
        If RigCheckbox.Enabled Then
            If RigCheckbox.Checked And RigCheckbox.CheckState = CheckState.Indeterminate Then ' Show T2
                RigCheckbox.Text = "T2 Drone Rig"
                RigCheckbox.ForeColor = Color.DarkOrange
            Else
                RigCheckbox.Text = "T1 Drone Rig"
                RigCheckbox.ForeColor = Color.Black
            End If
        End If
    End Sub

    Private Sub chkMineRorqDeployedMode_Click(sender As Object, e As EventArgs) Handles chkMineIndyCoreDeployedMode.Click
        Call UpdateIndustrialCoreCheck()
        Call UpdateShipMiningDroneStats()
        Call UpdateBoosterMiningDroneStats()
    End Sub

    Private Function GetMiningShipImage(ShipName As String) As String
        Dim ImageFile As Long
        Dim BPImage As String

        ' Display the mining ship
        Select Case ShipName
            Case Venture
                ImageFile = MiningShipTypeID.Venture
            Case Covetor
                ImageFile = MiningShipTypeID.Covetor
            Case Retriever
                ImageFile = MiningShipTypeID.Retriever
            Case Hulk
                ImageFile = MiningShipTypeID.Hulk
            Case Skiff
                ImageFile = MiningShipTypeID.Skiff
            Case Procurer
                ImageFile = MiningShipTypeID.Procurer
            Case Mackinaw
                ImageFile = MiningShipTypeID.Mackinaw
            Case Rorqual
                ImageFile = MiningShipTypeID.Rorqual
            Case Orca
                ImageFile = MiningShipTypeID.Orca
            Case Porpoise
                ImageFile = MiningShipTypeID.Porpoise
            Case Drake
                ImageFile = MiningShipTypeID.Drake
            Case Gnosis
                ImageFile = MiningShipTypeID.Gnosis
            Case Rokh
                ImageFile = MiningShipTypeID.Rokh
            Case Prospect
                ImageFile = MiningShipTypeID.Prospect
            Case Endurance
                ImageFile = MiningShipTypeID.Endurance
            Case Else
                ImageFile = 0
        End Select

        BPImage = Path.Combine(UserImagePath, CStr(ImageFile) & "_64.png")

        Return BPImage

    End Function

    Private Sub chkMineWH_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkMineWH.CheckedChanged
        If chkMineWH.Checked = True Then
            chkMineC1.Enabled = True
            chkMineC2.Enabled = True
            chkMineC3.Enabled = True
            chkMineC4.Enabled = True
            chkMineC5.Enabled = True
            chkMineC6.Enabled = True
            ' Also check the null box if not checked
            chkMineIncludeNullSec.Checked = True
        Else
            chkMineC1.Enabled = False
            chkMineC2.Enabled = False
            chkMineC3.Enabled = False
            chkMineC4.Enabled = False
            chkMineC5.Enabled = False
            chkMineC6.Enabled = False
        End If

        Call UpdateOrebySpaceChecks()
    End Sub

    Private Sub UpdateOrebySpaceChecks()

        If Not FirstLoad Then
            If cmbMineOreType.Text = "Ore" And chkMineWH.Checked = True And chkMineAmarr.Checked = False And chkMineGallente.Checked = False _
                And chkMineMinmatar.Checked = False And chkMineCaldari.Checked = False Then
                chkMineIncludeHighYieldOre.Enabled = False
            Else
                chkMineIncludeHighYieldOre.Enabled = True
            End If
        End If

    End Sub

    Private Sub MiningSpace_CheckChange(sender As System.Object, e As System.EventArgs) Handles chkMineAmarr.CheckedChanged, chkMineGallente.CheckedChanged,
            chkMineCaldari.CheckedChanged, chkMineMinmatar.CheckedChanged, chkMineTriglavian.CheckedChanged, chkMineMoonMining.CheckedChanged

        Call UpdateOrebySpaceChecks()

        If CType(sender, CheckBox).Name = "chkMineTriglavian" Or CType(sender, CheckBox).Name = "chkMineMoonMining" Then
            Call UpdateProcessingSkills()
        End If

        Call RefreshMiningTabRefiningRates()

    End Sub

    Private Sub chkMineIncludeNullSec_CheckedChanged(sender As System.Object, e As System.EventArgs) Handles chkMineIncludeNullSec.CheckedChanged
        ' Don't let them choose WH classes unless null checked
        If chkMineIncludeNullSec.Checked And chkMineWH.Checked Then
            chkMineC1.Enabled = True
            chkMineC2.Enabled = True
            chkMineC3.Enabled = True
            chkMineC4.Enabled = True
            chkMineC5.Enabled = True
            chkMineC6.Enabled = True
        Else
            chkMineC1.Enabled = False
            chkMineC2.Enabled = False
            chkMineC3.Enabled = False
            chkMineC4.Enabled = False
            chkMineC5.Enabled = False
            chkMineC6.Enabled = False
            ' Turn off WH
            chkMineWH.Checked = False
        End If

    End Sub

    Private Sub cmbMineNumMiningDrones_SelectedIndexChanged(sender As Object, e As EventArgs) Handles cmbMineNumMiningDrones.SelectedIndexChanged
        If Not FirstLoad Then
            Call UpdateShipMiningDroneStats()
        End If
    End Sub

    Private Sub cmbMineBoosterNumMiningDrones_SelectedIndexChanged(sender As Object, e As EventArgs) Handles cmbMineBoosterNumMiningDrones.SelectedIndexChanged
        If Not FirstLoad Then
            Call UpdateBoosterMiningDroneStats()
        End If
    End Sub

    Private Sub cmbMineDroneOpSkill_SelectedIndexChanged(sender As Object, e As EventArgs) Handles cmbMineDroneOpSkill.SelectedIndexChanged
        If Not FirstLoad Then
            If CInt(cmbMineDroneOpSkill.Text) < 5 Then
                cmbMineDroneSpecSkill.Text = "0"
                cmbMineDroneSpecSkill.Enabled = False
            Else
                cmbMineDroneSpecSkill.Enabled = True
            End If
            Call UpdateShipMiningDrones()
            Call UpdateShipMiningDroneStats()
        End If
    End Sub

    Private Sub cmbMineBoosterDroneOpSkill_SelectedIndexChanged(sender As Object, e As EventArgs) Handles cmbMineBoosterDroneOpSkill.SelectedIndexChanged
        If Not FirstLoad Then
            If CInt(cmbMineBoosterDroneOpSkill.Text) < 5 Then
                cmbMineBoosterDroneSpecSkill.Text = "0"
                cmbMineBoosterDroneSpecSkill.Enabled = False
            Else
                cmbMineBoosterDroneSpecSkill.Enabled = True
            End If
            Call UpdateBoosterMiningDrones()
            Call UpdateBoosterMiningDroneStats()
        End If
    End Sub

    Private Sub cmbMineDroneSpecSkill_SelectedIndexChanged(sender As Object, e As EventArgs) Handles cmbMineDroneSpecSkill.SelectedIndexChanged
        If Not FirstLoad Then
            Call UpdateShipMiningDrones()
            Call UpdateShipMiningDroneStats()
        End If
    End Sub

    Private Sub cmbMineBoosterDroneSpecSkill_SelectedIndexChanged(sender As Object, e As EventArgs) Handles cmbMineBoosterDroneSpecSkill.SelectedIndexChanged
        If Not FirstLoad Then
            Call UpdateBoosterMiningDrones()
            Call UpdateBoosterMiningDroneStats()
        End If
    End Sub

    Private Sub cmbMineDroneInterfacingSkill_SelectedIndexChanged(sender As Object, e As EventArgs) Handles cmbMineDroneInterfacingSkill.SelectedIndexChanged
        If Not FirstLoad Then
            Call UpdateShipMiningDroneStats()
        End If
    End Sub

    Private Sub cmbMineBoosterDroneInterfacingSkill_SelectedIndexChanged(sender As Object, e As EventArgs) Handles cmbMineBoosterDroneInterfacingSkill.SelectedIndexChanged
        If Not FirstLoad Then
            Call UpdateBoosterMiningDroneStats()
        End If
    End Sub

#End Region

    Private Const AstrogeologySkillTypeID As Integer = 3410
    Private Const DeepCoreMiningSkillTypeID As Integer = 11395
    Private Const ExhumersSkillTypeID As Integer = 22551
    Private Const ExpeditionFrigatesSkillTypeID As Integer = 33856
    Private Const GasCloudHarvestingSkillTypeID As Integer = 25544
    Private Const IceHarvestingSkillTypeID As Integer = 16281
    Private Const MiningSkillTypeID As Integer = 3386
    Private Const MiningBargeSkillTypeID As Integer = 17940
    Private Const MiningFrigateSkillTypeID As Integer = 32918
    Private Const ReprocessingSkillTypeID As Integer = 3385
    Private Const ReprocessingEfficiencySkillTypeID As Integer = 3389

    ' Drone skills
    Private Const DroneInterfacingSkillTypeID As Integer = 3442
    Private Const MiningDroneOperationSkillTypeID As Integer = 3438
    Private Const MiningDroneSpecializationSkillTypeID As Integer = 22541
    Private Const IceHarvestingDroneOperationSkillTypeID As Integer = 43702
    Private Const IceHarvestingDroneSpecializationSkillTypeID As Integer = 43703

    Private MiningDronem3Hr As Double
    Private BoosterMiningDronem3Hr As Double
    Private DroneNamesLoaded As Boolean

    Private Enum MiningShipTypeID
        Venture = 32880
        Covetor = 17476
        Retriever = 17478
        Hulk = 22544
        Skiff = 22546
        Mackinaw = 22548
        Rorqual = 28352
        Orca = 28606
        Porpoise = 42244
        Procurer = 17480
        Drake = 24698
        Gnosis = 3756
        Rokh = 24688
        Prospect = 33697
        Endurance = 37135
    End Enum

    Private Sub InitMiningTab()
        Call LoadMiningTab()
    End Sub

    ' Loads in all the skills and such for the tab 
    Private Sub LoadMiningTab()
        Dim i As Integer
        Dim TempSkillLevel As Integer

        With UserMiningTabSettings
            ' Ore types
            cmbMineOreType.Text = .OreType

            chkMineIncludeHighYieldOre.Checked = .CheckHighYieldOres
            chkMineIncludeHighSec.Checked = .CheckHighSecOres
            chkMineIncludeLowSec.Checked = .CheckLowSecOres
            chkMineIncludeNullSec.Checked = .CheckNullSecOres
            chkMineWH.Checked = .CheckSovWormhole
            chkMineMoonMining.Checked = .CheckSovMoon

            If chkMineIncludeNullSec.Checked And chkMineWH.Checked Then
                chkMineC1.Enabled = True
                chkMineC2.Enabled = True
                chkMineC3.Enabled = True
                chkMineC4.Enabled = True
                chkMineC5.Enabled = True
                chkMineC6.Enabled = True
            Else
                chkMineC1.Enabled = False
                chkMineC2.Enabled = False
                chkMineC3.Enabled = False
                chkMineC4.Enabled = False
                chkMineC5.Enabled = False
                chkMineC6.Enabled = False
                ' Can't check wh if they don't select null
                chkMineWH.Checked = False
            End If

            ' Check all locations
            chkMineAmarr.Checked = .CheckSovAmarr
            chkMineCaldari.Checked = .CheckSovCaldari
            chkMineGallente.Checked = .CheckSovGallente
            chkMineMinmatar.Checked = .CheckSovMinmatar
            chkMineTriglavian.Checked = .CheckSovTriglavian
            chkMineEDENCOM.Checked = .CheckEDENCOM

            chkMineC1.Checked = .CheckSovC1
            chkMineC2.Checked = .CheckSovC2
            chkMineC3.Checked = .CheckSovC3
            chkMineC4.Checked = .CheckSovC4
            chkMineC5.Checked = .CheckSovC5
            chkMineC6.Checked = .CheckSovC6

            ' Fleet booster
            chkMineUseFleetBooster.Checked = .CheckUseFleetBooster
            cmbMineBoosterShipName.Text = .BoosterShip
            cmbMineMiningDirector.Text = CStr(.MiningDirectorSkill)
            cmbMineMiningForeman.Text = CStr(.MiningFormanSkill)
            cmbMineBoosterShipSkill.Text = CStr(.BoosterShipSkill)
            chkMineForemanMindlink.Checked = .CheckMiningForemanMindLink
            cmbMineIndustReconfig.Text = CStr(.IndustrialReconfig)
            chkMineBoosterUseDrones.Checked = .BoosterUseDrones

            ' Booster rigs
            If .OreType = "Ore" Then
                Call UpdateDroneRigChecks(chkMineBoosterDroneRig1, .BoosterDroneRig1)
                Call UpdateDroneRigChecks(chkMineBoosterDroneRig2, .BoosterDroneRig2)
                Call UpdateDroneRigChecks(chkMineBoosterDroneRig3, .BoosterDroneRig3)
            ElseIf .OreType = "Ice" Then
                Call UpdateDroneRigChecks(chkMineBoosterDroneRig1, .BoosterIceDroneRig1)
                Call UpdateDroneRigChecks(chkMineBoosterDroneRig2, .BoosterIceDroneRig2)
                Call UpdateDroneRigChecks(chkMineBoosterDroneRig3, .BoosterIceDroneRig3)
            End If

            Select Case .CheckRorqDeployed
                Case 2
                    chkMineIndyCoreDeployedMode.CheckState = CheckState.Indeterminate
                Case 1
                    chkMineIndyCoreDeployedMode.Checked = True
                Case 0
                    chkMineIndyCoreDeployedMode.Checked = False
            End Select

            Call UpdateIndustrialCoreCheck()

            Select Case .CheckMineForemanLaserOpBoost
                Case 2
                    chkMineForemanLaserOpBoost.CheckState = CheckState.Indeterminate
                Case 1
                    chkMineForemanLaserOpBoost.Checked = True
                Case 0
                    chkMineForemanLaserOpBoost.Checked = False
            End Select

            Select Case .CheckMineForemanLaserRangeBoost
                Case 2
                    chkMineForemanLaserRangeBoost.CheckState = CheckState.Indeterminate
                Case 1
                    chkMineForemanLaserRangeBoost.Checked = True
                Case 0
                    chkMineForemanLaserRangeBoost.Checked = False
            End Select

            ' Update the Booster boxes
            Call UpdateBoosterSkills()

            ' Refining
            chkMineRefinedOre.Checked = .RefinedOre
            chkMineUnrefinedOre.Checked = .UnrefinedOre
            chkMineCompressedOre.Checked = .CompressedOre

            ' Hauler
            If .CheckUseHauler Then
                lblMineHaulerM3.Enabled = False
                lblMineRTMin.Enabled = False
                lblMineRTSec.Enabled = False
            Else
                lblMineHaulerM3.Enabled = True
                lblMineRTMin.Enabled = True
                lblMineRTSec.Enabled = True
            End If

            chkMineUseHauler.Checked = .CheckUseHauler
            txtMineRTMin.Text = FormatNumber(.RoundTripMin, 0)
            txtMineRTSec.Text = FormatNumber(.RoundTripSec, 0)
            txtMineHaulerM3.Text = FormatNumber(.Haulerm3, 0)

            MiningColumnClicked = .ColumnSort
            If .ColumnSortType = "Ascending" Then
                MiningColumnSortType = SortOrder.Ascending
            Else
                MiningColumnSortType = SortOrder.Descending
            End If

            ' Taxes and Fees
            chkMineIncludeBrokerFees.Checked = .CheckIncludeFees
            chkMineIncludeTaxes.Checked = .CheckIncludeTaxes

            txtMineBrokerFeeRate.Text = FormatPercent(.BrokerFeeRate, 1)

            ' Michii
            chkMineMichiImplant.Checked = .MichiiImplant

            ' Number of miners
            txtMineNumberMiners.Text = CStr(.NumberofMiners)

            ' Upgrades and miner types - different for Ice or Ore
            If .OreType = "Ore" Then
                gbMiningRigs.Enabled = True
                cmbMineShipName.Text = .OreMiningShip
                cmbMineMiningLaser.Text = .OreStrip
                cmbMineDroneName.Text = .MiningDrone
                cmbMineNumMiningDrones.Text = CStr(.NumMiningDrones)
                If cmbMineMiningUpgrade.Items.Contains(.OreUpgrade) Then
                    cmbMineMiningUpgrade.Text = .OreUpgrade
                Else
                    cmbMineMiningUpgrade.Text = None
                End If
                cmbMineNumLasers.Text = CStr(.NumOreMiners)
                cmbMineNumMiningUpgrades.Text = CStr(.NumOreUpgrades)
                cmbMineMiningRig1.Text = .ShipDroneRig1
                cmbMineMiningRig2.Text = .ShipDroneRig2
                cmbMineMiningRig3.Text = .ShipDroneRig3
            ElseIf .OreType = "Ice" Then
                gbMiningRigs.Enabled = True
                cmbMineShipName.Text = .IceMiningShip
                cmbMineMiningLaser.Text = .IceStrip
                cmbMineDroneName.Text = .IceMiningDrone
                cmbMineNumMiningDrones.Text = CStr(.NumIceMiningDrones)
                If cmbMineMiningUpgrade.Items.Contains(.IceUpgrade) Then
                    cmbMineMiningUpgrade.Text = .IceUpgrade
                Else
                    cmbMineMiningUpgrade.Text = None
                End If
                cmbMineNumLasers.Text = CStr(.NumIceMiners)
                cmbMineNumMiningUpgrades.Text = CStr(.NumIceUpgrades)
                cmbMineMiningRig1.Text = .ShipIceDroneRig1
                cmbMineMiningRig2.Text = .ShipIceDroneRig2
                cmbMineMiningRig3.Text = .ShipIceDroneRig3
            ElseIf .OreType = "Gas" Then
                cmbMineDroneName.Text = None
                cmbMineNumMiningDrones.Text = ""
                cmbMineShipName.Text = .GasMiningShip
                cmbMineMiningLaser.Text = .GasHarvester
                cmbMineMiningUpgrade.Text = .GasUpgrade
                cmbMineNumLasers.Text = CStr(.NumGasHarvesters)
                cmbMineNumMiningUpgrades.Text = CStr(.NumGasUpgrades)
                gbMiningRigs.Enabled = False
            End If

            If .OreType = "Ore" Then
                gbMineCrystals.Enabled = True
                If .T1Crystals Then
                    chkMineT1Crystals.Checked = True
                Else
                    chkMineT1Crystals.Checked = False
                End If
                If .T2Crystals Then
                    chkMineT2Crystals.Checked = True
                Else
                    chkMineT2Crystals.Checked = False
                End If

                If .CrystalTypeA Then
                    chkMineTypeA.Checked = True
                Else
                    chkMineTypeA.Checked = False
                End If
                If .CrystalTypeB Then
                    chkMineTypeB.Checked = True
                Else
                    chkMineTypeB.Checked = False
                End If
                If .CrystalTypeC Then
                    chkMineTypeC.Checked = True
                Else
                    chkMineTypeC.Checked = False
                End If

            Else
                gbMineCrystals.Enabled = False
            End If

            ' Implants
            Call UpdateMiningImplants()

            ' Load the ore processing skills
            For i = 1 To MineProcessingCheckBoxes.Count - 1
                TempSkillLevel = SelectedCharacter.Skills.GetSkillLevel(SelectedCharacter.Skills.GetSkillTypeID(MineProcessingLabels(i).Text))
                If TempSkillLevel <> 0 Then
                    MineProcessingCombos(i).Text = CStr(TempSkillLevel)
                    MineProcessingCheckBoxes(i).Checked = True
                Else
                    MineProcessingCombos(i).Text = "0"
                    MineProcessingCheckBoxes(i).Checked = False
                End If
            Next

            ' Update the ore processing skills
            Call UpdateProcessingSkills()

        End With

        ' Load all the skills for the character
        Call LoadCharacterMiningSkills()

        ' Updates the mining ship form with correct boxes enabled and equipment, etc
        Call UpdateMiningShipForm(True)

        ' Set drones now that everything else is loaded
        DroneNamesLoaded = False
        Call UpdateShipMiningDrones()
        Call UpdateShipMiningDroneStats()
        Call UpdateBoosterMiningDrones()
        Call UpdateBoosterMiningDroneStats()

        ' Load up the ship image
        Call LoadMiningshipImage()

        ' Clear the grid
        lstMineGrid.Items.Clear()

    End Sub

    Private Enum MiningOreType
        Ore = 1
        Ice = 2
        Gas = 3
    End Enum

    ' Main grid function for loading ores to mine
    Public Sub LoadMiningGrid()
        Dim SQL As String
        Dim SQLMain As String
        Dim readerMine As SQLiteDataReader
        Dim readerCrystal As SQLiteDataReader
        Dim readerOre As SQLiteDataReader
        Dim i As Integer
        Dim lstOreRow As ListViewItem
        Dim AttribLookup As New EVEAttributes
        Dim MiningType As MiningOreType

        Dim ShipMiningYield As Double
        Dim BaseCycleTime As Double
        Dim CycleTimeLabel As String = ""
        Dim CycleTime As Double
        Dim CrystalMiningYield As Double
        Dim OreList As New List(Of MiningOre)
        Dim TempOre As MiningOre = Nothing

        Dim Orem3PerSecond As Double
        Dim OrePerSecond As Double

        Dim ResidueProbability As Double = 0
        Dim ModuleResidueProbability As Double = 0
        Dim ResidueVolumeMuliplier As Double = 0
        Dim ModuleResidueVolumeMuliplier As Double = 0
        Dim MiningLaserBaseCycleTime As Double = 0

        ' Ice stuff
        Dim IceCylesPerHour As Integer
        Dim IceBlocksPerHour As Integer
        ' Ice Hauling
        Dim IceBlocksPerLoad As Integer

        Dim ReprocessingYield As Double ' For reference out of refining
        Dim ReprocessingTax As Double

        Dim TotalDroneIceBlocksPerHour As Integer = 0
        Dim TotalDroneOrePerHour As Double = 0

        ' For hauler calcs
        Dim SecondstoFill As Double  ' How much time it took to fill the m3 value with ore
        Dim FillCycles As Double ' How many cycles it will take to fill the m3 value with ore in an hour
        Dim RTTimetoStationSeconds As Long = 0 ' Seconds to get back to station to drop off ore

        Dim HeavyWaterCost As Double = 0 ' Total it costs to run the Rorq in deployed mode

        Dim MoonType As String = ""

        Dim CycletimeNoCrystal As Double = 0 ' If this is zero, then use the calculated rate, else use the base time because it takes crystal time into account

        ' Determine multiplier - assume all additional mining ships have the same yield and other costs
        Dim MinerMultiplier As Integer = CInt(txtMineNumberMiners.Text)

        ' Error checks
        If Not CheckMiningEntryData() Then
            Exit Sub
        End If

        lstMineGrid.Items.Clear()
        lstMineGrid.BeginUpdate()
        lblMineCycleTime.Text = ""
        lblMineRange.Text = ""
        Me.Cursor = Cursors.WaitCursor
        Application.DoEvents()

        Select Case cmbMineOreType.Text
            Case "Ore"
                MiningType = MiningOreType.Ore
            Case "Ice"
                MiningType = MiningOreType.Ice
            Case "Gas"
                MiningType = MiningOreType.Gas
        End Select

        ' First determine what type of stuff we are mining
        SQLMain = "SELECT ORES.ORE_ID, ORE_NAME, ORE_VOLUME, UNITS_TO_REFINE, SPACE, BELT_TYPE FROM ORES, ORE_LOCATIONS "
        SQL = "WHERE ORES.ORE_ID = ORE_LOCATIONS.ORE_ID "
        If chkMineMoonMining.Checked = True And chkMineMoonMining.Enabled = True Then
            SQL &= "AND (BELT_TYPE = '" & cmbMineOreType.Text & "' OR BELT_TYPE LIKE '%Moon Asteroid%') "
        Else
            SQL &= "AND BELT_TYPE = '" & cmbMineOreType.Text & "' "
        End If

        ' See if we want High yield ores
        If MiningType = MiningOreType.Ice Then
            SQL &= "AND ORES.HIGH_YIELD_ORE = -1 "
        ElseIf MiningType = MiningOreType.Gas Then
            SQL &= "AND ORES.HIGH_YIELD_ORE = -2 "
        Else
            If chkMineIncludeHighYieldOre.Checked = False Then
                ' Only base ores
                SQL &= "AND ORES.HIGH_YIELD_ORE = 0 "
            End If
        End If

        ' See where we want this for security
        SQL &= "AND SYSTEM_SECURITY IN ("

        If chkMineIncludeHighSec.Checked = True Then
            SQL &= "'High Sec',"
        End If
        If chkMineIncludeLowSec.Checked = True Then
            SQL &= "'Low Sec',"
        End If
        If chkMineIncludeNullSec.Checked = True Then
            SQL &= "'Null Sec',"
        End If

        ' If WH checked, then add the classes
        If chkMineWH.Checked = True Then
            If chkMineC1.Checked And chkMineC1.Enabled Then
                SQL &= "'C1',"
            End If
            If chkMineC2.Checked And chkMineC2.Enabled Then
                SQL &= "'C2',"
            End If
            If chkMineC3.Checked And chkMineC3.Enabled Then
                SQL &= "'C3',"
            End If
            If chkMineC4.Checked And chkMineC4.Enabled Then
                SQL &= "'C4',"
            End If
            If chkMineC5.Checked And chkMineC5.Enabled Then
                SQL &= "'C5',"
            End If
            If chkMineC6.Checked And chkMineC6.Enabled Then
                SQL &= "'C6',"
            End If
        End If

        SQL = SQL.Substring(0, Len(SQL) - 1) & ") "

        ' Now determine what space we are looking at
        SQL &= "AND SPACE IN ("

        If chkMineAmarr.Checked Then
            SQL &= "'Amarr',"
        End If
        If chkMineCaldari.Checked Then
            SQL &= "'Caldari',"
        End If
        If chkMineGallente.Checked Then
            SQL &= "'Gallente',"
        End If
        If chkMineMinmatar.Checked Then
            SQL &= "'Minmatar',"
        End If
        If chkMineTriglavian.Checked Then
            SQL &= "'Triglavian',"
        End If
        If chkMineWH.Checked Then
            SQL &= "'WH',"
        End If
        If chkMineMoonMining.Checked Then
            SQL &= "'Moon',"
        End If
        SQL = SQL.Substring(0, Len(SQL) - 1) & ") "

        ' Group them
        Dim SQLGroup As String = "GROUP BY ORES.ORE_ID, ORE_NAME, ORE_VOLUME, UNITS_TO_REFINE "

        ' Based on the crystal types selected, they could have 7 different types of returns - no crystal, and T1, T2, with all 3 types (A,B,C)
        ' So set the loops we need 
        ' NEED TO LOOK UP CRYSTAL TYPE FOR EACH ORE
        Dim CrystalList As New List(Of String)

        If gbMineCrystals.Enabled And gbMineCrystalType.Enabled Then
            If chkMineT1Crystals.Checked Then
                If chkMineTypeA.Checked Then
                    CrystalList.Add("Type A I")
                End If
                If chkMineTypeB.Checked Then
                    CrystalList.Add("Type B I")
                End If
                If chkMineTypeC.Checked Then
                    CrystalList.Add("Type C I")
                End If
            End If
            If chkMineT2Crystals.Checked Then
                If chkMineTypeA.Checked Then
                    CrystalList.Add("Type A II")
                End If
                If chkMineTypeB.Checked Then
                    CrystalList.Add("Type B II")
                End If
                If chkMineTypeC.Checked Then
                    CrystalList.Add("Type C II")
                End If
            End If
            If chkMineT1Crystals.Checked = False And chkMineT2Crystals.Checked = False Then
                ' They can't have a type without a tech, so just set to none
                CrystalList.Add(None)
            End If
        Else
            ' No crystals for this module so just run one time
            CrystalList.Add(None)
        End If

        ' Get Heavy Water costs
        If (chkMineIndyCoreDeployedMode.Checked Or chkMineIndyCoreDeployedMode.CheckState = CheckState.Indeterminate) And CInt(cmbMineIndustReconfig.Text) <> 0 And chkMineUseFleetBooster.Checked Then
            ' Add (subtract from total isk) the heavy water cost
            HeavyWaterCost = CalculateIndyCoreDeployedCost(CInt(cmbMineIndustReconfig.Text), CInt(cmbMineBoosterShipSkill.Text))
        Else
            HeavyWaterCost = 0
        End If

        ' Refining
        Dim ReprocessedMaterials As New Materials
        ' These will only set up base refine rates, we need to adjust with the rig updated rates
        Dim ReprocessingStation As New ReprocessingPlant(MineRefineFacility.GetFacility(ProductionType.Reprocessing), CDbl(UserApplicationSettings.RefiningImplantValue))

        ' Set the progress bar on the main tab
        pnlProgressBar.Value = 0
        pnlProgressBar.Minimum = 0
        pnlProgressBar.Maximum = 0

        ' Get the total count of rows for the progressbar - start with multplier
        Dim OreTypes As Integer = 0
        If chkMineRefinedOre.Checked And Not MiningType = MiningOreType.Gas Then
            OreTypes += 1
        End If
        If chkMineUnrefinedOre.Checked Or MiningType = MiningOreType.Gas Then
            OreTypes += 1
        End If

        ' If they have 0 ore types, then they must want compressed
        If OreTypes <> 0 Then
            ' Get the count of all non-compressed items 
            DBCommand = New SQLiteCommand("SELECT COUNT(*) FROM (SELECT DISTINCT ORE_NAME FROM ORES, ORE_LOCATIONS " & SQL & " AND COMPRESSED = 0)", EVEDB.DBREf)
            readerMine = DBCommand.ExecuteReader
            readerMine.Read()

            ' Set the initial max value without compressed ores taken into account
            pnlProgressBar.Maximum = (readerMine.GetInt32(0) * (CrystalList.Count) * OreTypes)
            readerMine.Close()
        End If

        ' Get the count of all compressed items if checked
        If chkMineCompressedOre.Checked Then
            DBCommand = New SQLiteCommand("SELECT COUNT(*) FROM (SELECT DISTINCT ORE_NAME FROM ORES, ORE_LOCATIONS " & SQL & " AND COMPRESSED = 1)", EVEDB.DBREf)
            readerMine = DBCommand.ExecuteReader
            readerMine.Read()
            ' Add the count and adjust for crystals
            pnlProgressBar.Maximum += (readerMine.GetInt32(0) * (CrystalList.Count))
            readerMine.Close()
        End If

        If pnlProgressBar.Maximum > 0 Then
            pnlProgressBar.Maximum -= 1
        End If
        pnlProgressBar.Visible = True
        pnlStatus.Text = "Calculating Mining Values..."

        Application.DoEvents()

        ' Run for main query - Only get the ore list of base ores and add compressed values later
        DBCommand = New SQLiteCommand(SQLMain & SQL & " AND COMPRESSED = 0 " & SQLGroup, EVEDB.DBREf)
        readerMine = DBCommand.ExecuteReader

        Dim CrystalYieldModifier As Double
        Dim CrystalAsteroidDurationMultiplier As Double

        ' Get the module state values
        ModuleResidueProbability = AttribLookup.GetAttribute(cmbMineMiningLaser.Text, ItemAttributes.miningWasteProbability)
        ModuleResidueVolumeMuliplier = AttribLookup.GetAttribute(cmbMineMiningLaser.Text, ItemAttributes.miningWastedVolumeMultiplier)
        MiningLaserBaseCycleTime = AttribLookup.GetAttribute(cmbMineMiningLaser.Text, ItemAttributes.duration)

        ' Boosters use one module and charges for boosting 
        Dim GangBurstBonusCycle As Double = 0
        Dim GangBurstBonusRange As Double = 0
        If chkMineUseFleetBooster.Checked Then
            GangBurstBonusCycle = CalculateBurstBonus(BurstBonusType.Cycle, chkMineForemanLaserOpBoost)
            GangBurstBonusRange = CalculateBurstBonus(BurstBonusType.Range, chkMineForemanLaserRangeBoost)
        End If

        ' Loop through all the ores and determine ore amount, refine, 
        While readerMine.Read
            ' For each crystal type and tech, calculate a row
            For Each Crystal In CrystalList
                Application.DoEvents()

                ' Reset these
                ResidueProbability = ModuleResidueProbability
                ResidueVolumeMuliplier = ModuleResidueVolumeMuliplier

                ' DB Data
                TempOre = New MiningOre
                ReprocessingYield = 0
                TempOre.OreID = readerMine.GetInt64(0)
                TempOre.OreName = readerMine.GetString(1)
                TempOre.OreVolume = readerMine.GetDouble(2)
                TempOre.UnitsToRefine = readerMine.GetInt32(3)
                TempOre.Space = readerMine.GetString(4)
                TempOre.BeltType = readerMine.GetString(5)

                CrystalYieldModifier = 1
                CrystalAsteroidDurationMultiplier = 1

                If Crystal <> None Then
                    ' Get the crystal id from the list and look up crystal mining bonus, residue probability and volume, and cycle time bonus
                    Dim CSQL As String
                    CSQL = "Select attributeID, value from TYPE_ATTRIBUTES WHERE typeID In "
                    CSQL &= "(Select IT.typeID FROM TYPE_ATTRIBUTES As TA, INVENTORY_TYPES As IT "
                    CSQL &= "WHERE value In (Select value FROM TYPE_ATTRIBUTES As TA, INVENTORY_TYPES As IT "
                    CSQL &= "WHERE TA.typeID = IT.typeID And attributeID = 790 And typeName = '" & TempOre.OreName & "') "
                    CSQL &= "AND TA.typeID = IT.typeID AND attributeID = 182 AND IT.typeName LIKE '%" & Crystal & "') "
                    CSQL &= "AND attributeID IN (782,3159,3160,3161)"
                    DBCommand = New SQLiteCommand(CSQL, EVEDB.DBREf)
                    readerCrystal = DBCommand.ExecuteReader

                    While readerCrystal.Read
                        Select Case readerCrystal.GetInt32(0)
                            Case ItemAttributes.specializationAsteroidYieldMultiplier
                                CrystalYieldModifier = readerCrystal.GetDouble(1)
                                ' Add rig value for mercoxit if used (32817 = rig typeid)
                                If cmbMineMiningRig1.Text = "Mercoxit Opt" And TempOre.OreName.Contains("Mercoxit") Then
                                    CrystalYieldModifier += AttribLookup.GetAttribute(32817, ItemAttributes.miningAmountBonus) / 100
                                End If
                            Case ItemAttributes.specializationAsteroidDurationMultiplier
                                CrystalAsteroidDurationMultiplier = readerCrystal.GetDouble(1)
                            Case ItemAttributes.specializationCrystalMiningWasteProbabilityBonus
                                ResidueProbability += readerCrystal.GetDouble(1)
                            Case ItemAttributes.specializationCrystalMiningWastedVolumeMultiplierBonus
                                ResidueVolumeMuliplier += readerCrystal.GetDouble(1)
                        End Select
                    End While
                    readerCrystal.Close()
                End If

                ' Save values
                TempOre.ResidueProbability = ResidueProbability
                TempOre.ResidueVolumeMuliplier = ResidueVolumeMuliplier

                ' Get the mining yield first (this is without crystals and no mercoxit)
                If MiningShipSelected() Then
                    ShipMiningYield = CalculateMiningAmount()
                    ' Duration is in milliseconds - add in crystal bonus too
                    CycletimeNoCrystal = CalculateMiningCycleTime(MiningLaserBaseCycleTime / 1000, GangBurstBonusCycle)
                    BaseCycleTime = CycletimeNoCrystal * CrystalAsteroidDurationMultiplier
                    If CrystalAsteroidDurationMultiplier = 1 Then
                        CycleTimeLabel = FormatNumber(BaseCycleTime, 1) & " s"
                        ttMining.SetToolTip(lblMineCycleTime, "")
                    Else
                        CycleTimeLabel = FormatNumber(CycletimeNoCrystal, 1) & " s*"
                        ttMining.SetToolTip(lblMineCycleTime, "* Base Cycle time without Crystal Bonus")
                    End If
                Else
                    ShipMiningYield = 0
                    CycleTimeLabel = "N/A"
                    BaseCycleTime = 1 ' For not dividing by zero
                End If

                TempOre.CycleTime = BaseCycleTime

                ' If not using a hauler, adjust the cycle time based on round trip time
                If chkMineUseHauler.Checked = False Then

                    If TempOre.OreVolume > CDbl(txtMineHaulerM3.Text) Then
                        ' You can't use this hauler for this amount of ore
                        ' So no point in going on
                        MsgBox("The volume of the hauler is too small to use for this setup.", vbExclamation, Application.ProductName)
                        txtMineHaulerM3.Focus()
                        Exit Sub
                    End If

                    ' Get Round Trip Time (RTT) to station to drop off ore - User entered, in seconds
                    RTTimetoStationSeconds = (CInt(txtMineRTMin.Text) * 60) + CInt(txtMineRTSec.Text)

                End If

                ' Ore amount
                If Not MiningType = MiningOreType.Ice And Not MiningType = MiningOreType.Gas Then
                    ' Determine crystal amount
                    CrystalMiningYield = ShipMiningYield * CrystalYieldModifier
                    ' Save the crystal type
                    TempOre.CrystalType = Crystal
                    TempOre.OreUnitsPerCycle = CrystalMiningYield

                    ' Calculate the m3 per second for this ore including mining drone input
                    TotalDroneOrePerHour = MiningDronem3Hr
                    If chkMineBoosterUseDrones.Checked And chkMineUseFleetBooster.Checked Then
                        TotalDroneOrePerHour += CInt(Math.Floor(BoosterMiningDronem3Hr))
                    End If
                    Orem3PerSecond = (CrystalMiningYield / BaseCycleTime) + (TotalDroneOrePerHour / 3600)

                    ' This is the m3 per second, but need to get this ORE per second based on it's volume
                    OrePerSecond = Orem3PerSecond / TempOre.OreVolume

                ElseIf MiningType = MiningOreType.Ice Then
                    TempOre.CrystalType = None
                    IceCylesPerHour = CInt(Math.Floor(3600 / BaseCycleTime))

                    ' Total ice blocks per hour
                    TotalDroneIceBlocksPerHour = CInt(Math.Floor(MiningDronem3Hr / 1000))
                    If chkMineBoosterUseDrones.Checked And chkMineUseFleetBooster.Checked Then
                        TotalDroneIceBlocksPerHour += CInt(Math.Floor(BoosterMiningDronem3Hr / 1000))
                    End If

                    If ShipMiningYield = 0 Then
                        ' This is just drone yield
                        ShipMiningYield = TotalDroneIceBlocksPerHour / 3600
                    End If
                    IceBlocksPerHour = CInt(IceCylesPerHour * ShipMiningYield)

                    ' Total ice blocks per cycle
                    TempOre.OreUnitsPerCycle = ShipMiningYield * 1000 ' Ice is 1000 m3

                ElseIf MiningType = MiningOreType.Gas Then
                    TempOre.CrystalType = None

                    TempOre.OreUnitsPerCycle = ShipMiningYield
                    Orem3PerSecond = ShipMiningYield / BaseCycleTime

                    ' This is the m3 per second, but need to get this ORE per second based on it's volume
                    OrePerSecond = Orem3PerSecond / TempOre.OreVolume
                End If

                If chkMineUseHauler.Checked = False Then
                    ' Treat Ore and Gas the same
                    If Not MiningType = MiningOreType.Ice Then
                        ' How long to fill the cargo?
                        SecondstoFill = CDbl(txtMineHaulerM3.Text) / Orem3PerSecond
                        ' How many cycles where in this session?
                        FillCycles = SecondstoFill / BaseCycleTime

                        ' Add on the round trip time and recalculate cycle time
                        CycleTime = ((FillCycles * BaseCycleTime) + RTTimetoStationSeconds) / FillCycles

                        ' Recalculate with new cycle time
                        If cmbMineOreType.Text = "Ore" Then
                            Orem3PerSecond = (CrystalMiningYield / CycleTime) + (CDbl(TotalDroneOrePerHour) / 3600)
                        Else ' Gas
                            Orem3PerSecond = ShipMiningYield / CycleTime
                        End If

                        ' This is the m3 per second, but need to get CycleTime ORE per second based on it's volume
                        OrePerSecond = Orem3PerSecond / TempOre.OreVolume

                    Else ' Ice
                        ' How much can fit in cargo?
                        IceBlocksPerLoad = CInt(Math.Floor(CDbl(txtMineHaulerM3.Text) / TempOre.OreVolume))

                        ' How many full cycles to fill the cargo?
                        FillCycles = CInt(Math.Ceiling(IceBlocksPerLoad / ShipMiningYield))

                        ' Add on the round trip time and recalculate cycle time
                        CycleTime = ((FillCycles * BaseCycleTime) + RTTimetoStationSeconds) / FillCycles

                        ' Recalculate with new cycle time
                        IceCylesPerHour = CInt(Math.Floor(3600 / CycleTime))

                        ' Total ice blocks per hour
                        IceBlocksPerHour = CInt(IceCylesPerHour * ShipMiningYield)
                    End If
                End If

                If MiningType = MiningOreType.Ice Then
                    TempOre.UnitsPerHour = IceBlocksPerHour
                Else
                    TempOre.UnitsPerHour = OrePerSecond * 3600
                End If

                ' Only refine ore or ice
                If chkMineRefinedOre.Checked And Not MiningType = MiningOreType.Gas Then

                    Dim BFI As BrokerFeeInfo = GetBrokerFeeData(chkMineIncludeBrokerFees, txtMineBrokerFeeRate)
                    Dim TempOreProcessingSkill As Integer = GetFormOreProcessingSkill(TempOre.OreName, MineProcessingLabels, MineProcessingCombos)

                    ' Update the material modifier based on the type of ore
                    If TempOre.BeltType.Contains("Moon") Then
                        ReprocessingStation.GetFacilility.MaterialMultiplier = ReprocessingStation.GetFacilility.MoonOreFacilityRefineRate
                    ElseIf TempOre.BeltType = "Ore" Then
                        ReprocessingStation.GetFacilility.MaterialMultiplier = ReprocessingStation.GetFacilility.OreFacilityRefineRate
                    ElseIf TempOre.BeltType = "Ice" Then
                        ReprocessingStation.GetFacilility.MaterialMultiplier = ReprocessingStation.GetFacilility.IceFacilityRefineRate
                    End If

                    ' Refine total Ore we mined for an hour and save the total isk/hour
                    ReprocessedMaterials = ReprocessingStation.Reprocess(TempOre.OreID, CInt(cmbMineRefining.Text), CInt(cmbMineRefineryEff.Text), TempOreProcessingSkill,
                                                                            TempOre.UnitsPerHour, chkMineIncludeTaxes.Checked, BFI, ReprocessingYield, ReprocessingTax)

                    TempOre.RefineYield = ReprocessingYield

                    If ReprocessingStation.GetFacilility.IncludeActivityUsage Then
                        TempOre.IPH = ReprocessedMaterials.GetTotalMaterialsCost - ReprocessingTax
                    Else
                        TempOre.IPH = ReprocessedMaterials.GetTotalMaterialsCost
                    End If

                    ' Add (subtract from total isk) the heavy water cost
                    TempOre.IPH = TempOre.IPH - HeavyWaterCost

                    'Drone yield included in total ore so just for display
                    TempOre.DroneYield = GetDroneYield(MiningType = MiningOreType.Ice, MiningType = MiningOreType.Gas, MinerMultiplier)

                    ' Calculate the unit price by refining one batch
                    ReprocessedMaterials = ReprocessingStation.Reprocess(TempOre.OreID, CInt(cmbMineRefining.Text), CInt(cmbMineRefineryEff.Text), TempOreProcessingSkill,
                                                                            TempOre.UnitsToRefine, chkMineIncludeTaxes.Checked, BFI, ReprocessingYield, Nothing)
                    TempOre.OreUnitPrice = ReprocessedMaterials.GetTotalMaterialsCost / TempOre.UnitsToRefine
                    TempOre.RefineType = "Refined"

                    If TempOre.RefineYield = 0 Then
                        TempOre.RefineYield = ReprocessingYield
                    End If

                    ' For each record, update the progress bar
                    Call IncrementToolStripProgressBar(pnlProgressBar)
                    OreList.Add(TempOre)
                End If

                If chkMineCompressedOre.Checked Then
                    ' First, get the unit price and volume for the compressed ore
                    SQL = "SELECT PRICE FROM ITEM_PRICES WHERE ITEM_NAME LIKE 'Compressed " & TempOre.OreName & "'"
                    DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
                    readerOre = DBCommand.ExecuteReader

                    If readerOre.Read() Then
                        TempOre.OreUnitPrice = readerOre.GetDouble(0)
                        ' Reset the units mined
                        Dim SavedUnits As Double = TempOre.UnitsPerHour
                        ' Now all blocks are 1 unit, you need 100 units to refine to get the same yield
                        'If Not MiningType = MiningOreType.Ice Then
                        '    ' All ores are 100 to 1 compressed block, ice is 1 to 1
                        '    TempOre.UnitsPerHour = TempOre.UnitsPerHour / 100
                        'End If

                        'Drone yield included in total ore so just for display
                        TempOre.DroneYield = GetDroneYield(MiningType = MiningOreType.Ice, MiningType = MiningOreType.Gas, MinerMultiplier)

                        ' Units we mined, times unit price is IPH
                        TempOre.IPH = (TempOre.UnitsPerHour * TempOre.OreUnitPrice)
                        TempOre.RefineYield = 0
                        TempOre.RefineType = "Compressed"
                        ' For each record, update the progress bar
                        Call IncrementToolStripProgressBar(pnlProgressBar)
                        OreList.Add(TempOre)
                        ' Reset the units if we do unrefined
                        TempOre.UnitsPerHour = SavedUnits
                    End If

                    readerOre.Close()

                End If

                If chkMineUnrefinedOre.Checked Or MiningType = MiningOreType.Gas Then ' Just use the Ore prices since we are selling it straight
                    ' First, get the unit price for the ore
                    SQL = "SELECT PRICE FROM ITEM_PRICES WHERE ITEM_NAME = '" & TempOre.OreName & "'"
                    DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
                    readerOre = DBCommand.ExecuteReader

                    If readerOre.Read() Then
                        TempOre.OreUnitPrice = readerOre.GetDouble(0)
                        ' Units we mined, times unit price is IPH 
                        TempOre.IPH = (TempOre.UnitsPerHour * TempOre.OreUnitPrice)
                        TempOre.DroneYield = GetDroneYield(MiningType = MiningOreType.Ice, MiningType = MiningOreType.Gas, MinerMultiplier)
                        TempOre.RefineYield = 0
                        TempOre.RefineType = "Unrefined"
                        ' For each record, update the progress bar
                        Call IncrementToolStripProgressBar(pnlProgressBar)
                        OreList.Add(TempOre)
                    End If

                    readerOre.Close()

                End If
                Application.DoEvents()
            Next
        End While

        ' Now update the progress panel for the list
        pnlStatus.Text = "Updating Mining List..."
        pnlProgressBar.Value = 0
        pnlProgressBar.Maximum = OreList.Count
        Application.DoEvents()

        ' Sort the ore List by the iph
        OreList.Sort(New MiningOreIPHComparer)

        readerMine.Close()

        ' Update column widths based on type - Ice, don't show Crystal, Gas, don't show Refine or Crystal
        Select Case cmbMineOreType.Text
            Case "Ore"
                lstMineGrid.Columns(1).Width = MineOreNameColumnWidth
                lstMineGrid.Columns(4).Width = MineRefineYieldColumnWidth
                lstMineGrid.Columns(5).Width = MineCrystalColumnWidth
            Case "Ice"
                lstMineGrid.Columns(1).Width = MineOreNameColumnWidth + MineCrystalColumnWidth
                lstMineGrid.Columns(4).Width = MineRefineYieldColumnWidth
                lstMineGrid.Columns(5).Width = 0 ' Hide
            Case "Gas"
                lstMineGrid.Columns(1).Width = MineOreNameColumnWidth + MineCrystalColumnWidth + MineRefineYieldColumnWidth
                lstMineGrid.Columns(4).Width = 0
                lstMineGrid.Columns(5).Width = 0 ' Hide
        End Select

        For i = 0 To OreList.Count - 1
            ' Make sure we want to add Mercoxit
            If Not OreList(i).OreName.Contains("Mercoxit") Or (OreList(i).OreName.Contains("Mercoxit") And cmbMineMiningLaser.Text.Contains("Deep Core")) Then
                lstOreRow = New ListViewItem(CStr(OreList(i).OreID))
                'The remaining columns are subitems  
                MoonType = ""
                If OreList(i).Space = "Moon" Then
                    ' Add the type of moon this comes from
                    Select Case OreList(i).OreName
                        Case "Bitumens", "Coesite", "Sylvite", "Zeolites"
                            MoonType = " (R4)"
                        Case "Cobaltite", "Euxenite", "Scheelite", "Titanite"
                            MoonType = " (R8)"
                        Case "Chromite", "Otavite", "Sperrylite", "Vanadinite"
                            MoonType = " (R16)"
                        Case "Carnotite", "Cinnabar", "Pollucite", "Zircon"
                            MoonType = " (R32)"
                        Case "Loparite", "Monazite", "Xenotime", "Ytterbite"
                            MoonType = " (R64)"
                    End Select
                End If
                lstOreRow.SubItems.Add(OreList(i).OreName & MoonType)
                lstOreRow.SubItems.Add(OreList(i).RefineType)
                lstOreRow.SubItems.Add(FormatNumber(OreList(i).OreUnitPrice, 2))
                If OreList(i).RefineYield = 0 Then
                    lstOreRow.SubItems.Add("-")
                Else
                    lstOreRow.SubItems.Add(FormatPercent(OreList(i).RefineYield, 3))
                End If
                lstOreRow.SubItems.Add(OreList(i).CrystalType)
                ' Add residue values
                lstOreRow.SubItems.Add(FormatPercent(OreList(i).ResidueProbability / 100, 1))
                lstOreRow.SubItems.Add(FormatNumber(OreList(i).ResidueVolumeMuliplier, 0))
                ' Modify all three by mining multiplier
                'lstOreRow.SubItems.Add(FormatNumber(OreList(i).OreUnitsPerCycle * MinerMultiplier, 2))
                ' For drone yield, we only apply the miner multipler to drone yield from mining ships, not booster
                lstOreRow.SubItems.Add(FormatNumber(OreList(i).DroneYield, 1)) ' Multiplier for drone mining calculated above
                lstOreRow.SubItems.Add(FormatNumber(Math.Round(OreList(i).UnitsPerHour * MinerMultiplier), 0))
                lstOreRow.SubItems.Add(FormatNumber(OreList(i).IPH * MinerMultiplier, 2))
                lstOreRow.SubItems.Add(FormatNumber(OreList(i).CycleTime, 1) & " s")
                Call lstMineGrid.Items.Add(lstOreRow)
            End If
            Call IncrementToolStripProgressBar(pnlProgressBar)
            Application.DoEvents()
        Next

        ' Now sort this
        Dim TempType As SortOrder
        If MiningColumnSortType = SortOrder.Ascending Then
            TempType = SortOrder.Descending
        Else
            TempType = SortOrder.Ascending
        End If
        Call ListViewColumnSorter(MiningColumnClicked, CType(lstMineGrid, ListView), MiningColumnClicked, TempType)
        Me.Cursor = Cursors.Default

        lstMineGrid.EndUpdate()

        ' Update the mining range of the mining lasers selected
        lblMineRange.Text = FormatNumber(CalculateMiningRange(AttribLookup.GetAttribute(cmbMineMiningLaser.Text, ItemAttributes.maxRange), cmbMineOreType.Text, GangBurstBonusRange) / 1000, 2) & " km"
        lblMineCycleTime.Text = CycleTimeLabel

        i = 0
        Me.Cursor = Cursors.Default
        pnlStatus.Text = ""
        pnlProgressBar.Visible = False
        Application.DoEvents()

    End Sub

    Private Function GetDroneYield(IceMining As Boolean, GasMining As Boolean, NumMiners As Integer) As Double
        Dim Yield As Double = 0

        'Drone yield included in total ore so just for display
        If Not GasMining Then ' No mining drones for gas
            Yield = MiningDronem3Hr * NumMiners ' Add the multiple miner yield here
            If chkMineBoosterUseDrones.Checked And chkMineUseFleetBooster.Checked Then
                Yield += BoosterMiningDronem3Hr
            End If
            If IceMining Then
                ' Convert to blocks
                Yield = CInt(Math.Floor(Yield))
            End If
        End If

        Return Yield

    End Function

    ' Refreshes the variables and labels for ore/ice/moon refining rates for the selected facility based on options selected
    Public Sub RefreshMiningTabRefiningRates()
        With MineRefineFacility.GetSelectedFacility
            Select Case cmbMineOreType.Text
                Case "Ore"
                    lblMineFacilityOreRate.Text = "Ore Rate:"
                    lblMineFacilityOreRate.Text = FormatPercent(.OreFacilityRefineRate, 2)

                    ' Only enable if the moon ore checked
                    If chkMineMoonMining.Checked = True Then
                        lblMineFacilityMoonOreRate1.Enabled = True
                        lblMineFacilityMoonOreRate.Enabled = True
                        ' Update Moon rate
                        lblMineFacilityMoonOreRate.Text = FormatPercent(.MoonOreFacilityRefineRate, 2)
                    Else
                        ' Disable moon
                        lblMineFacilityMoonOreRate1.Enabled = False
                        lblMineFacilityMoonOreRate.Enabled = False
                        lblMineFacilityMoonOreRate.Text = "-"
                    End If
                Case "Ice"
                    lblMineFacilityOreRate.Text = "Ice Rate:"
                    lblMineFacilityOreRate.Text = FormatPercent(.IceFacilityRefineRate, 2)
                    ' Disable moon
                    lblMineFacilityMoonOreRate1.Enabled = False
                    lblMineFacilityMoonOreRate.Enabled = False
                    lblMineFacilityMoonOreRate.Text = "-"
                Case Else
                    lblMineFacilityOreRate.Text = "-"
                    lblMineFacilityMoonOreRate.Text = "-"
            End Select
        End With
    End Sub

    ' Loads the skills for all skill combos
    Public Sub LoadCharacterMiningSkills()

        ' Load the Mining Skills for this character
        cmbMineDeepCore.Text = CStr(SelectedCharacter.Skills.GetSkillLevel(DeepCoreMiningSkillTypeID))
        cmbMineAstrogeology.Text = CStr(SelectedCharacter.Skills.GetSkillLevel(AstrogeologySkillTypeID))
        cmbMineSkill.Text = CStr(SelectedCharacter.Skills.GetSkillLevel(MiningSkillTypeID))
        cmbMineRefineryEff.Text = CStr(SelectedCharacter.Skills.GetSkillLevel(ReprocessingEfficiencySkillTypeID))
        cmbMineRefining.Text = CStr(SelectedCharacter.Skills.GetSkillLevel(ReprocessingSkillTypeID))

        ' Drone skills
        If cmbMineOreType.Text = "Ice" Then
            ' Ship
            If UserMiningTabSettings.IceDroneOpSkill = AllSettings.DefaultDroneSkills Then
                cmbMineDroneOpSkill.Text = CStr(SelectedCharacter.Skills.GetSkillLevel(IceHarvestingDroneOperationSkillTypeID))
            Else
                cmbMineDroneOpSkill.Text = UserMiningTabSettings.IceDroneOpSkill
            End If
            If UserMiningTabSettings.IceDroneSpecSkill = AllSettings.DefaultDroneSkills Then
                cmbMineDroneSpecSkill.Text = CStr(SelectedCharacter.Skills.GetSkillLevel(IceHarvestingDroneSpecializationSkillTypeID))
            Else
                cmbMineDroneSpecSkill.Text = UserMiningTabSettings.IceDroneSpecSkill
            End If
            If UserMiningTabSettings.IceDroneInterfaceSkill = AllSettings.DefaultDroneSkills Then
                cmbMineDroneInterfacingSkill.Text = CStr(SelectedCharacter.Skills.GetSkillLevel(DroneInterfacingSkillTypeID))
            Else
                cmbMineDroneInterfacingSkill.Text = UserMiningTabSettings.IceDroneInterfaceSkill
            End If
            ' Booster
            If UserMiningTabSettings.BoosterIceDroneOpSkill = AllSettings.DefaultDroneSkills Then
                cmbMineBoosterDroneOpSkill.Text = CStr(SelectedCharacter.Skills.GetSkillLevel(IceHarvestingDroneOperationSkillTypeID))
            Else
                cmbMineBoosterDroneOpSkill.Text = UserMiningTabSettings.BoosterIceDroneOpSkill
            End If
            If UserMiningTabSettings.BoosterIceDroneSpecSkill = AllSettings.DefaultDroneSkills Then
                cmbMineBoosterDroneSpecSkill.Text = CStr(SelectedCharacter.Skills.GetSkillLevel(IceHarvestingDroneSpecializationSkillTypeID))
            Else
                cmbMineBoosterDroneSpecSkill.Text = UserMiningTabSettings.BoosterIceDroneSpecSkill
            End If
            If UserMiningTabSettings.BoosterIceDroneInterfaceSkill = AllSettings.DefaultDroneSkills Then
                cmbMineBoosterDroneInterfacingSkill.Text = CStr(SelectedCharacter.Skills.GetSkillLevel(DroneInterfacingSkillTypeID))
            Else
                cmbMineBoosterDroneInterfacingSkill.Text = UserMiningTabSettings.BoosterIceDroneInterfaceSkill
            End If
        Else 'If cmbMineOreType.Text = "Ore" Then
            ' Ship
            If UserMiningTabSettings.DroneOpSkill = AllSettings.DefaultDroneSkills Then
                cmbMineDroneOpSkill.Text = CStr(SelectedCharacter.Skills.GetSkillLevel(MiningDroneOperationSkillTypeID))
            Else
                cmbMineDroneOpSkill.Text = UserMiningTabSettings.DroneOpSkill
            End If
            If UserMiningTabSettings.DroneSpecSkill = AllSettings.DefaultDroneSkills Then
                cmbMineDroneSpecSkill.Text = CStr(SelectedCharacter.Skills.GetSkillLevel(MiningDroneSpecializationSkillTypeID))
            Else
                cmbMineDroneSpecSkill.Text = UserMiningTabSettings.DroneSpecSkill
            End If
            If UserMiningTabSettings.DroneInterfaceSkill = AllSettings.DefaultDroneSkills Then
                cmbMineDroneInterfacingSkill.Text = CStr(SelectedCharacter.Skills.GetSkillLevel(DroneInterfacingSkillTypeID))
            Else
                cmbMineDroneInterfacingSkill.Text = UserMiningTabSettings.DroneInterfaceSkill
            End If
            ' Booster
            If UserMiningTabSettings.BoosterDroneOpSkill = AllSettings.DefaultDroneSkills Then
                cmbMineBoosterDroneOpSkill.Text = CStr(SelectedCharacter.Skills.GetSkillLevel(MiningDroneOperationSkillTypeID))
            Else
                cmbMineBoosterDroneOpSkill.Text = UserMiningTabSettings.BoosterDroneOpSkill
            End If
            If UserMiningTabSettings.BoosterDroneSpecSkill = AllSettings.DefaultDroneSkills Then
                cmbMineBoosterDroneSpecSkill.Text = CStr(SelectedCharacter.Skills.GetSkillLevel(MiningDroneSpecializationSkillTypeID))
            Else
                cmbMineBoosterDroneSpecSkill.Text = UserMiningTabSettings.BoosterDroneSpecSkill
            End If
            If UserMiningTabSettings.BoosterDroneInterfaceSkill = AllSettings.DefaultDroneSkills Then
                cmbMineBoosterDroneInterfacingSkill.Text = CStr(SelectedCharacter.Skills.GetSkillLevel(DroneInterfacingSkillTypeID))
            Else
                cmbMineBoosterDroneInterfacingSkill.Text = UserMiningTabSettings.BoosterDroneInterfaceSkill
            End If
        End If

        ' If this is a dummy account, set these all to 1 - TODO Remove, or re-check so they work even if 0
        If cmbMineAstrogeology.Text = "" Then
            cmbMineAstrogeology.Text = "1"
        End If
        If cmbMineSkill.Text = "" Then
            cmbMineSkill.Text = "1"
        End If

        If cmbMineOreType.Text = "Gas" Then
            If SelectedCharacter.Skills.GetSkillLevel(GasCloudHarvestingSkillTypeID) = 0 Then
                ' Set it to base 1 - even though if they don't have this skill they can't fit a gas harvester
                cmbMineGasIceHarvesting.Text = "1"
            Else
                cmbMineGasIceHarvesting.Text = CStr(SelectedCharacter.Skills.GetSkillLevel(GasCloudHarvestingSkillTypeID))
            End If
        ElseIf cmbMineOreType.Text = "Ice" Then
            cmbMineGasIceHarvesting.Text = CStr(SelectedCharacter.Skills.GetSkillLevel(IceHarvestingSkillTypeID))
        Else
            cmbMineGasIceHarvesting.Text = "0"
        End If

        If cmbMineOreType.Text <> "Gas" Then
            cmbMineAdvShipSkill.Text = CStr(SelectedCharacter.Skills.GetSkillLevel(ExhumersSkillTypeID))
        Else
            ' Load the Expedition frigate skill for the prospect
            cmbMineAdvShipSkill.Text = CStr(SelectedCharacter.Skills.GetSkillLevel(ExpeditionFrigatesSkillTypeID))
        End If

        Dim MiningBarge As Integer = SelectedCharacter.Skills.GetSkillLevel(MiningBargeSkillTypeID)
        Dim MiningFrigate As Integer = SelectedCharacter.Skills.GetSkillLevel(MiningFrigateSkillTypeID)

        If MiningBarge = 0 Then
            ' Look up Mining Frigate skill
            If MiningFrigate = 0 Then
                ' Just set it to 1
                cmbMineBaseShipSkill.Text = "1"
            Else
                cmbMineBaseShipSkill.Text = CStr(MiningFrigate)
            End If
        Else
            cmbMineBaseShipSkill.Text = CStr(MiningBarge)
        End If

    End Sub

    ' Saves all the settings on the screen selected
    Private Sub btnMineSaveSettings_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnMineSaveAllSettings.Click
        Dim TempSettings As MiningTabSettings = UserMiningTabSettings
        Dim Settings As New ProgramSettings

        ' Check data first
        If Not CheckMiningEntryData() Then
            Exit Sub
        End If

        With TempSettings
            ' Ore types
            .OreType = cmbMineOreType.Text

            .CheckHighSecOres = chkMineIncludeHighSec.Checked
            .CheckLowSecOres = chkMineIncludeLowSec.Checked
            .CheckNullSecOres = chkMineIncludeNullSec.Checked
            .CheckHighYieldOres = chkMineIncludeHighYieldOre.Checked

            .RefinedOre = chkMineRefinedOre.Checked
            .UnrefinedOre = chkMineUnrefinedOre.Checked
            .CompressedOre = chkMineCompressedOre.Checked

            ' Upgrades and miner types - different for Ice, Ore, or Gas
            If .OreType = "Ore" Then
                .OreMiningShip = cmbMineShipName.Text
                .MiningDrone = cmbMineDroneName.Text
                .NumMiningDrones = cmbMineNumMiningDrones.Text
                .DroneOpSkill = cmbMineDroneOpSkill.Text
                .DroneSpecSkill = cmbMineDroneSpecSkill.Text
                .DroneInterfaceSkill = cmbMineDroneInterfacingSkill.Text
                If MiningShipSelected() Then
                    .OreStrip = cmbMineMiningLaser.Text
                    .OreUpgrade = cmbMineMiningUpgrade.Text
                    .NumOreMiners = CInt(cmbMineNumLasers.Text)
                    .NumOreUpgrades = CInt(cmbMineNumMiningUpgrades.Text)
                    .OreImplant = cmbMineHighwallImplant.Text
                    .T1Crystals = chkMineT1Crystals.Checked
                    .T2Crystals = chkMineT2Crystals.Checked
                    .CrystalTypeA = chkMineTypeA.Checked
                    .CrystalTypeB = chkMineTypeB.Checked
                    .CrystalTypeC = chkMineTypeC.Checked
                End If
                ' Ship
                .ShipDroneRig1 = cmbMineMiningRig1.Text
                .ShipDroneRig2 = cmbMineMiningRig2.Text
                .ShipDroneRig3 = cmbMineMiningRig3.Text
                ' Booster
                Call SetRigCheckSetting(.BoosterDroneRig1, chkMineBoosterDroneRig1)
                Call SetRigCheckSetting(.BoosterDroneRig2, chkMineBoosterDroneRig2)
                Call SetRigCheckSetting(.BoosterDroneRig3, chkMineBoosterDroneRig3)
                .BoosterMiningDrone = cmbMineBoosterDroneName.Text
                .BoosterNumMiningDrones = cmbMineBoosterNumMiningDrones.Text
                .BoosterDroneOpSkill = cmbMineBoosterDroneOpSkill.Text
                .BoosterDroneSpecSkill = cmbMineBoosterDroneSpecSkill.Text
                .BoosterDroneInterfaceSkill = cmbMineBoosterDroneInterfacingSkill.Text
            ElseIf .OreType = "Ice" Then
                .IceMiningShip = cmbMineShipName.Text
                .IceMiningDrone = cmbMineDroneName.Text
                .NumIceMiningDrones = cmbMineNumMiningDrones.Text
                .IceDroneOpSkill = cmbMineDroneOpSkill.Text
                .IceDroneSpecSkill = cmbMineDroneSpecSkill.Text
                .IceDroneInterfaceSkill = cmbMineDroneInterfacingSkill.Text
                If MiningShipSelected() Then
                    .IceStrip = cmbMineMiningLaser.Text
                    .IceUpgrade = cmbMineMiningUpgrade.Text
                    .NumIceMiners = CInt(cmbMineNumLasers.Text)
                    .NumIceUpgrades = CInt(cmbMineNumMiningUpgrades.Text)
                    .IceImplant = cmbMineHighwallImplant.Text
                End If
                ' Ship
                .ShipIceDroneRig1 = cmbMineMiningRig1.Text
                .ShipIceDroneRig2 = cmbMineMiningRig2.Text
                .ShipIceDroneRig3 = cmbMineMiningRig3.Text
                ' Booster
                Call SetRigCheckSetting(.BoosterIceDroneRig1, chkMineBoosterDroneRig1)
                Call SetRigCheckSetting(.BoosterIceDroneRig2, chkMineBoosterDroneRig2)
                Call SetRigCheckSetting(.BoosterIceDroneRig3, chkMineBoosterDroneRig3)
                .BoosterIceMiningDrone = cmbMineBoosterDroneName.Text
                .BoosterNumIceMiningDrones = cmbMineBoosterNumMiningDrones.Text
                .BoosterIceDroneOpSkill = cmbMineBoosterDroneOpSkill.Text
                .BoosterIceDroneSpecSkill = cmbMineBoosterDroneSpecSkill.Text
                .BoosterIceDroneInterfaceSkill = cmbMineBoosterDroneInterfacingSkill.Text
            ElseIf .OreType = "Gas" Then
                .GasMiningShip = cmbMineShipName.Text
                .GasHarvester = cmbMineMiningLaser.Text
                .GasUpgrade = None
                .NumGasHarvesters = CInt(cmbMineNumLasers.Text)
                .NumGasUpgrades = 0
                .GasImplant = cmbMineHighwallImplant.Text
            End If

            ' Fleet booster
            .CheckUseFleetBooster = chkMineUseFleetBooster.Checked
            .BoosterShip = cmbMineBoosterShipName.Text
            .MiningDirectorSkill = CInt(cmbMineMiningDirector.Text)
            .MiningFormanSkill = CInt(cmbMineMiningForeman.Text)
            .BoosterShipSkill = CInt(cmbMineBoosterShipSkill.Text)
            .CheckMiningForemanMindLink = chkMineForemanMindlink.Checked
            .IndustrialReconfig = CInt(cmbMineIndustReconfig.Text)
            .BoosterUseDrones = chkMineBoosterUseDrones.Checked
            If chkMineIndyCoreDeployedMode.CheckState = CheckState.Indeterminate Then
                .CheckRorqDeployed = 2
            ElseIf chkMineIndyCoreDeployedMode.Checked = True Then
                .CheckRorqDeployed = 1
            Else
                .CheckRorqDeployed = 0
            End If

            If chkMineForemanLaserOpBoost.CheckState = CheckState.Indeterminate Then
                .CheckMineForemanLaserOpBoost = 2
            ElseIf chkMineForemanLaserOpBoost.Checked = True Then
                .CheckMineForemanLaserOpBoost = 1
            Else
                .CheckMineForemanLaserOpBoost = 0
            End If

            If chkMineForemanLaserRangeBoost.CheckState = CheckState.Indeterminate Then
                .CheckMineForemanLaserRangeBoost = 2
            ElseIf chkMineForemanLaserRangeBoost.Checked = True Then
                .CheckMineForemanLaserRangeBoost = 1
            Else
                .CheckMineForemanLaserRangeBoost = 0
            End If

            ' Check all locations
            .CheckSovAmarr = chkMineAmarr.Checked
            .CheckSovCaldari = chkMineCaldari.Checked
            .CheckSovGallente = chkMineGallente.Checked
            .CheckSovMinmatar = chkMineMinmatar.Checked
            .CheckSovTriglavian = chkMineTriglavian.Checked
            .CheckEDENCOM = chkMineEDENCOM.Checked
            .CheckSovWormhole = chkMineWH.Checked
            .CheckSovMoon = chkMineMoonMining.Checked

            .CheckSovC1 = chkMineC1.Checked
            .CheckSovC2 = chkMineC2.Checked
            .CheckSovC3 = chkMineC3.Checked
            .CheckSovC4 = chkMineC4.Checked
            .CheckSovC5 = chkMineC5.Checked
            .CheckSovC6 = chkMineC6.Checked

            ' Save it in the Application settings
            Settings.SaveApplicationSettings(UserApplicationSettings)

            .ColumnSort = MiningColumnClicked
            If MiningColumnSortType = SortOrder.Ascending Then
                .ColumnSortType = "Ascending"
            Else
                .ColumnSortType = "Decending"
            End If

            .CheckUseHauler = chkMineUseHauler.Checked

            ' Hauler - only save values if not using hauler
            If chkMineUseHauler.Checked = False Then
                .RoundTripMin = CInt(txtMineRTMin.Text)
                .RoundTripSec = CInt(txtMineRTSec.Text)
                .Haulerm3 = CDbl(txtMineHaulerM3.Text)
            Else
                .RoundTripMin = Settings.DefaultMiningRoundTripMin
                .RoundTripSec = Settings.DefaultMiningRoundTripSec
                .Haulerm3 = Settings.DefaultMiningHaulerm3
            End If

            ' Taxes and Fees
            .CheckIncludeFees = chkMineIncludeBrokerFees.Checked
            .CheckIncludeTaxes = chkMineIncludeTaxes.Checked

            ' Michii
            .MichiiImplant = chkMineMichiImplant.Checked

            ' Number of miners
            .NumberofMiners = CInt(txtMineNumberMiners.Text)

        End With

        ' Save the data in the XML file
        Call Settings.SaveMiningSettings(TempSettings)

        ' Save the data to the local variable
        UserMiningTabSettings = TempSettings

        MsgBox("Settings Saved", vbInformation, Application.ProductName)

    End Sub

    Private Sub SetRigCheckSetting(ByRef SettingValue As Integer, ByRef RigCheckBox As CheckBox)
        If RigCheckBox.CheckState = CheckState.Indeterminate Then
            SettingValue = 2
        ElseIf RigCheckBox.Checked = True Then
            SettingValue = 1
        Else
            SettingValue = 0
        End If
    End Sub

    ' Loads the Fleet Boost Ship image
    Private Sub LoadFleetBoosterImage()
        If chkMineUseFleetBooster.Checked Then
            Dim ShipName As String

            If cmbMineBoosterShipName.Text = "Other" Then
                ShipName = Rokh
            ElseIf cmbMineBoosterShipName.Text = "Battlecruiser" Then
                ShipName = Gnosis
            Else
                ShipName = cmbMineBoosterShipName.Text
            End If

            Dim BPImage As String = GetMiningShipImage(ShipName)

            If File.Exists(BPImage) Then
                pictMineFleetBoostShip.Image = Image.FromFile(BPImage)
            Else
                pictMineFleetBoostShip.Image = Nothing
            End If

        Else
            pictMineFleetBoostShip.Image = Nothing
        End If

        pictMineFleetBoostShip.Update()

    End Sub

    ' Loads the Mining Ship Image
    Private Sub LoadMiningshipImage()
        Dim ShipName As String

        If cmbMineShipName.Text = "Other" Then
            ShipName = Rokh
        ElseIf cmbMineShipName.Text = "Battlecruiser" Then
            ShipName = Gnosis
        Else
            ShipName = cmbMineShipName.Text
        End If

        Dim BPImage As String = GetMiningShipImage(ShipName)

        If File.Exists(BPImage) Then
            pictMineSelectedShip.Image = Image.FromFile(BPImage)
        Else
            pictMineSelectedShip.Image = Nothing
        End If

        pictMineSelectedShip.Update()

    End Sub

    ' Loads the implants for the mining type
    Private Sub UpdateMiningImplants()
        Dim ReqSkill As Integer
        Dim AttribLookup As New EVEAttributes

        ' Clear implants
        cmbMineHighwallImplant.Items.Clear()

        ' Set Ore or Ice implants
        If cmbMineOreType.Text = "Ice" Then
            cmbMineHighwallImplant.Items.Add(None)
            'Inherent Implants 'Yeti' Ice Harvesting IH-1001
            cmbMineHighwallImplant.Items.Add("'Yeti' IH-1001")
            cmbMineHighwallImplant.Items.Add("'Yeti' IH-1003")
            cmbMineHighwallImplant.Items.Add("'Yeti' IH-1005")

            ' No Michi for ice
            chkMineMichiImplant.Enabled = False
            chkMineMichiImplant.ForeColor = Color.Black

            cmbMineHighwallImplant.Text = UserMiningTabSettings.IceImplant

        ElseIf cmbMineOreType.Text = "Ore" Then
            'Inherent Implants 'Highwall' Mining MX-1001
            cmbMineHighwallImplant.Items.Add(None)
            cmbMineHighwallImplant.Items.Add("'Highwall' MX-1001")
            cmbMineHighwallImplant.Items.Add("'Highwall' MX-1003")
            cmbMineHighwallImplant.Items.Add("'Highwall' MX-1005")

            If MiningShipSelected() Then
                chkMineMichiImplant.Enabled = True
            Else
                chkMineMichiImplant.Enabled = False
                chkMineMichiImplant.ForeColor = Color.Black
            End If

            ' Michi Implant
            ReqSkill = CInt(AttribLookup.GetAttribute("Michi's Excavation Augmentor", ItemAttributes.requiredSkill1Level))
            If ReqSkill <> SelectedCharacter.Skills.GetSkillLevel(3411) Then
                chkMineMichiImplant.ForeColor = Color.Red
                If UserApplicationSettings.ShowToolTips Then
                    ttBP.SetToolTip(chkMineMichiImplant, "Requires Cybernetics " & ReqSkill)
                End If
            Else
                chkMineMichiImplant.ForeColor = Color.Black
            End If

            cmbMineHighwallImplant.Text = UserMiningTabSettings.OreImplant

        ElseIf cmbMineOreType.Text = "Gas" Then
            cmbMineHighwallImplant.Items.Add(None)
            'Eifyr and Co. 'Alchemist' Gas Harvesting GH-801
            cmbMineHighwallImplant.Items.Add("'Alchemist' GH-801")
            cmbMineHighwallImplant.Items.Add("'Alchemist' GH-803")
            cmbMineHighwallImplant.Items.Add("'Alchemist' GH-805")

            ' No Michi for gas
            chkMineMichiImplant.Enabled = False
            chkMineMichiImplant.ForeColor = Color.Black

            cmbMineHighwallImplant.Text = UserMiningTabSettings.GasImplant
        End If

    End Sub

    ' Updates the skills and combos associated with the ship selected
    Private Sub UpdateMiningShipForm(UpdateEquipment As Boolean)

        ' Update the mining skills first, ships loaded depend on these
        Call UpdateMiningSkills()

        ' Load the ships into the ship combo
        Call UpdateMiningShipsCombo()

        If UpdateEquipment Or cmbMineShipName.Text = Orca Or cmbMineShipName.Text = Rorqual Or cmbMineShipName.Text = Porpoise Then
            ' Finally load all the ship equipment
            Call UpdateMiningShipEquipment()
            ' Refresh drone stats
            Call UpdateShipMiningDroneStats()
        End If

    End Sub

    ' Updates the mining drones for use
    Private Sub UpdateShipMiningDrones()
        If Not FirstLoad Then
            Call UpdateMiningDrones(cmbMineOreType.Text, cmbMineDroneName, UserMiningTabSettings.MiningDrone,
                                    UserMiningTabSettings.IceMiningDrone, cmbMineDroneOpSkill, cmbMineDroneSpecSkill,
                                    cmbMineShipName.Text, tabShipDrones, cmbMineNumMiningDrones)
        End If
    End Sub

    ' Updates the boosters mining drones for use
    Private Sub UpdateBoosterMiningDrones()
        If Not FirstLoad Then
            Call UpdateMiningDrones(cmbMineOreType.Text, cmbMineBoosterDroneName, UserMiningTabSettings.BoosterMiningDrone,
                                    UserMiningTabSettings.BoosterIceMiningDrone, cmbMineBoosterDroneOpSkill, cmbMineBoosterDroneSpecSkill,
                                    cmbMineBoosterShipName.Text, tabBoosterDrones, cmbMineBoosterNumMiningDrones)
            Call UpdateBoosterDroneRigChecks() ' May need to be reset based on fleet options
        End If
    End Sub

    ' Updates the mining drones for objects sent
    Private Sub UpdateMiningDrones(OreType As String, DroneNameCombo As ComboBox, DefaultDroneName As String, DefaultIceDroneName As String, DroneSkillCombo As ComboBox,
                                   DroneSpecSkillCombo As ComboBox, ShipName As String, DroneTab As TabPage, NumDroneCombo As ComboBox)

        Dim SavedDroneSelection As String = DroneNameCombo.Text

        ' Load up drones into the combo based on skills selected
        DroneNameCombo.BeginUpdate()
        DroneNameCombo.Items.Clear()
        DroneNameCombo.Items.Add(None) ' Always add none

        Select Case OreType
            Case "Ore"
                DroneTab.Enabled = True
                If CInt(DroneSkillCombo.Text) >= 1 Then
                    DroneNameCombo.Items.Add("Civilian Mining Drone")
                    DroneNameCombo.Items.Add("Mining Drone I")
                    DroneNameCombo.Items.Add("Harvester Mining Drone")
                End If
                If CInt(DroneSkillCombo.Text) >= 1 And DroneSpecSkillCombo.Enabled = True And CInt(DroneSpecSkillCombo.Text) >= 1 Then
                    DroneNameCombo.Items.Add("Mining Drone II")
                    DroneNameCombo.Items.Add("'Augmented' Mining Drone")
                    If ShipName = Rorqual Then
                        DroneNameCombo.Items.Add("'Excavator' Mining Drone")
                    End If
                End If

                If DroneNameCombo.Items.Contains(SavedDroneSelection) Then
                    DroneNameCombo.Text = SavedDroneSelection
                ElseIf DroneNameCombo.Items.Contains(DefaultDroneName) Then
                    DroneNameCombo.Text = DefaultDroneName
                Else
                    DroneNameCombo.Text = None
                End If

            Case "Ice"
                DroneTab.Enabled = True
                If CInt(DroneSkillCombo.Text) >= 1 Then
                    DroneNameCombo.Items.Add("Ice Harvesting Drone I")
                End If
                If CInt(DroneSpecSkillCombo.Text) >= 1 And DroneSpecSkillCombo.Enabled = True And CInt(DroneSpecSkillCombo.Text) >= 1 Then
                    DroneNameCombo.Items.Add("Ice Harvesting Drone II")
                    DroneNameCombo.Items.Add("'Augmented' Ice Harvesting Drone")
                    If ShipName = Rorqual Then
                        DroneNameCombo.Items.Add("'Excavator' Ice Harvesting Drone")
                    End If
                End If

                If DroneNameCombo.Items.Contains(SavedDroneSelection) Then
                    DroneNameCombo.Text = SavedDroneSelection
                ElseIf DroneNameCombo.Items.Contains(DefaultIceDroneName) Then
                    DroneNameCombo.Text = DefaultIceDroneName
                Else
                    DroneNameCombo.Text = None
                End If

            Case "Gas"
                DroneTab.Enabled = False ' No gas drones
        End Select

        Call UpdateNumberMiningDrones(DroneNameCombo.Text, ShipName, NumDroneCombo, False)

        DroneNameCombo.EndUpdate()

    End Sub

    Private Enum DroneRigType
        None = 0
        T1 = 1
        T2 = 2
        Ice = 3
        Mercoxit = 4
    End Enum

    Private Function GetDroneRigType(RigCheck As CheckBox) As DroneRigType
        If RigCheck.Enabled And RigCheck.Checked Then
            If RigCheck.CheckState = CheckState.Indeterminate Then
                Return DroneRigType.T2
            Else
                Return DroneRigType.T1
            End If
        End If

        Return DroneRigType.None

    End Function

    Private Function GetDroneRigType(ComboCheck As ComboBox) As DroneRigType
        If ComboCheck.Enabled And ComboCheck.Text <> None And ComboCheck.Text <> "" Then
            If ComboCheck.Text.Contains("T2") Then
                Return DroneRigType.T2
            ElseIf ComboCheck.Text.Contains("Ice Harvesting") Then
                Return DroneRigType.Ice
            ElseIf ComboCheck.Text.Contains("Mercoxit Opt") Then
                Return DroneRigType.Mercoxit
            Else
                Return DroneRigType.T1
            End If
        End If

        Return DroneRigType.None

    End Function

    Private Sub UpdateShipMiningDroneStats()
        If Not FirstLoad Then
            Call UpdateMiningDroneStats(MiningDronem3Hr, cmbMineShipName.Text, cmbMineBaseShipSkill.Text, cmbMineDroneName.Text, cmbMineNumMiningDrones.Text,
                            cmbMineDroneOpSkill.Text, cmbMineDroneSpecSkill.Text, cmbMineDroneInterfacingSkill.Text, lblMineDroneIdealRange,
                            lblMineMiningDroneYield, cmbMineOreType.Text, GetDroneRigType(cmbMineMiningRig1), GetDroneRigType(cmbMineMiningRig2), GetDroneRigType(cmbMineMiningRig3))
        End If
    End Sub

    Private Sub UpdateBoosterMiningDroneStats()
        If Not FirstLoad Then
            Call UpdateMiningDroneStats(BoosterMiningDronem3Hr, cmbMineBoosterShipName.Text, cmbMineBoosterShipSkill.Text, cmbMineBoosterDroneName.Text, cmbMineBoosterNumMiningDrones.Text,
                        cmbMineBoosterDroneOpSkill.Text, cmbMineBoosterDroneSpecSkill.Text, cmbMineBoosterDroneInterfacingSkill.Text, lblMineBoosterDroneIdealRange,
                        lblMineBoosterMiningDroneYield, cmbMineOreType.Text, GetDroneRigType(chkMineBoosterDroneRig1), GetDroneRigType(chkMineBoosterDroneRig2), GetDroneRigType(chkMineBoosterDroneRig3), True)
        End If
    End Sub

    ' Updates the stats on the drones group
    Private Sub UpdateMiningDroneStats(ByRef MiningAmtVariable As Double, ShipName As String, BaseShipSkill As String,
                                       DroneName As String, NumDrones As String, DroneSkill As String, DroneSpecSkill As String, DroneInterfaceSkill As String,
                                       ByRef RangeLabel As Label, ByRef YieldLabel As Label, OreType As String,
                                       ByRef Rig1 As DroneRigType, ByRef Rig2 As DroneRigType, ByRef Rig3 As DroneRigType, Optional BoosterDrones As Boolean = False)
        ' Initialize
        RangeLabel.Text = "Ideal Range: N/A"
        YieldLabel.Text = "-"
        MiningAmtVariable = 0

        ' Calculate the m3 and range based on ship selected
        If DroneName <> None And DroneSkill <> "0" And OreType <> "Gas" Then
            Dim AttribLookup As New EVEAttributes
            Dim DroneMiningAmountpCycle As Double = 0
            ' Update the optimal range for this drone first
            Dim NavigationBonus As Double = 1 + (SelectedCharacter.Skills.GetSkillLevel(12305) * (AttribLookup.GetAttribute(12305, ItemAttributes.maxVelocityBonus) / 100))
            RangeLabel.Text = "Ideal Range: " & FormatNumber(AttribLookup.GetAttribute(DroneName, ItemAttributes.maxRange) * NavigationBonus, 0) & " m"

            ' Start adding in the rest of the skill bonuses
            Dim MiningDroneOpLevel As Integer = If(DroneSkill <> "", CInt(DroneSkill), 0)
            Dim MiningDroneOpSpecLevel As Integer = If(DroneSkill <> "", CInt(DroneSpecSkill), 0)

            DroneMiningAmountpCycle = AttribLookup.GetAttribute(DroneName, ItemAttributes.miningAmount)

            If OreType = "Ore" Then
                DroneMiningAmountpCycle *= (1 + ((AttribLookup.GetAttribute(DroneInterfacingSkillTypeID, ItemAttributes.miningAmountBonus) * CInt(DroneInterfaceSkill)) / 100))
                DroneMiningAmountpCycle *= (1 + (AttribLookup.GetAttribute(MiningDroneOperationSkillTypeID, ItemAttributes.miningAmountBonus) * MiningDroneOpLevel) / 100)
                DroneMiningAmountpCycle *= (1 + (AttribLookup.GetAttribute(MiningDroneSpecializationSkillTypeID, ItemAttributes.miningAmountBonus) * MiningDroneOpSpecLevel) / 100)
                ' Ship role bonus
                DroneMiningAmountpCycle *= (1 + (AttribLookup.GetAttribute(ShipName, ItemAttributes.roleBonusDroneMiningYield) / 100))
                DroneMiningAmountpCycle *= (1 + GetMiningDroneRigBonus(Rig1, OreType, ShipName)) ' Rigs
                DroneMiningAmountpCycle *= (1 + GetMiningDroneRigBonus(Rig2, OreType, ShipName)) ' Rigs
                DroneMiningAmountpCycle *= (1 + GetMiningDroneRigBonus(Rig3, OreType, ShipName)) ' Rigs

                ' Only the mining industrials have bonuses to mining drones based on main ship skill
                Select Case ShipName
                    Case Porpoise, Orca
                        DroneMiningAmountpCycle *= (1 + (AttribLookup.GetAttribute(ShipName, ItemAttributes.industrialCommandBonusDroneOreMiningYield) * CInt(BaseShipSkill)) / 100)
                    Case Rorqual
                        DroneMiningAmountpCycle *= (1 + (AttribLookup.GetAttribute(ShipName, ItemAttributes.capitalIndustrialShipBonusDroneOreMiningYield) * CInt(BaseShipSkill)) / 100)
                End Select

                ' Add role bonus 
                DroneMiningAmountpCycle *= (1 + (AttribLookup.GetAttribute(ShipName, ItemAttributes.roleBonusDroneMiningYield) / 100))

                ' Adjust with the core bonus if boosted and using the drones
                If BoosterDrones Then
                    DroneMiningAmountpCycle *= (1 + GetIndustrialCorebonus(ShipName, CoreBonus.OreDroneMiningYield))
                End If

                ' Amount of cycles we can do in an hour times the amount per cycle
                If DroneName <> "" Then
                    MiningAmtVariable = (CInt(NumDrones) * 3600 / (AttribLookup.GetAttribute(DroneName, ItemAttributes.duration) / 1000)) * DroneMiningAmountpCycle
                End If

                ' Set the amount of m3 per hour for all the drones we have
                YieldLabel.Text = FormatNumber(MiningAmtVariable, 1)
            Else
                Dim IceHarvestDroneCycleTime As Double = AttribLookup.GetAttribute(DroneName, ItemAttributes.duration)
                IceHarvestDroneCycleTime *= (1 + (AttribLookup.GetAttribute(IceHarvestingDroneOperationSkillTypeID, ItemAttributes.rofBonus) * MiningDroneOpLevel) / 100)
                IceHarvestDroneCycleTime *= (1 + (AttribLookup.GetAttribute(IceHarvestingDroneSpecializationSkillTypeID, ItemAttributes.rofBonus) * MiningDroneOpSpecLevel) / 100)
                ' Ship role bonus
                IceHarvestDroneCycleTime *= (1 + (AttribLookup.GetAttribute(ShipName, ItemAttributes.roleBonusDroneIceHarvestingSpeed) / 100))
                IceHarvestDroneCycleTime *= (1 + GetMiningDroneRigBonus(Rig1, OreType, ShipName)) ' Rigs
                IceHarvestDroneCycleTime *= (1 + GetMiningDroneRigBonus(Rig2, OreType, ShipName)) ' Rigs
                IceHarvestDroneCycleTime *= (1 + GetMiningDroneRigBonus(Rig3, OreType, ShipName)) ' Rigs

                ' Only the mining industrials have bonuses to mining drones based on main ship skill
                Select Case ShipName
                    Case Porpoise, Orca
                        IceHarvestDroneCycleTime *= (1 + ((AttribLookup.GetAttribute(ShipName, ItemAttributes.industrialCommandBonusDroneIceHarvestingCycleTime) / 100) * CInt(BaseShipSkill)))
                    Case Rorqual
                        IceHarvestDroneCycleTime *= (1 + ((AttribLookup.GetAttribute(ShipName, ItemAttributes.capitalIndustrialShipBonusDroneIceCycleTime) / 100) * CInt(BaseShipSkill)))
                End Select

                ' Adjust with the core bonus if boosted
                If BoosterDrones Then
                    IceHarvestDroneCycleTime *= (1 + GetIndustrialCorebonus(ShipName, CoreBonus.IceDroneHarvestingSpeed))
                End If

                MiningAmtVariable = CInt(NumDrones) * (3600 / (IceHarvestDroneCycleTime / 1000) * DroneMiningAmountpCycle)

                YieldLabel.Text = FormatNumber(MiningAmtVariable, 1)

            End If
        End If
    End Sub

    ' Returns the rig bonus for drones rig check selected
    Private Function GetMiningDroneRigBonus(DroneRig As DroneRigType, DroneType As String, ShipName As String) As Double
        Dim AttribLookup As New EVEAttributes
        Dim RigName As String = ""
        Dim RigTech As String = ""
        Dim RigBonus As Double = 0

        If DroneRig = DroneRigType.T1 Or DroneRig = DroneRigType.T2 Then

            Select Case AttribLookup.GetAttribute(ShipName, ItemAttributes.rigSize)
                Case 1
                    RigName = "Small Drone Mining Augmentor "
                Case 2
                    RigName = "Medium Drone Mining Augmentor "
                Case 3
                    RigName = "Large Drone Mining Augmentor "
                Case 4
                    RigName = "Capital Drone Mining Augmentor "
            End Select

            If DroneRig <> DroneRigType.None Then
                If DroneRig = DroneRigType.T2 Then
                    RigTech = "II"
                Else
                    RigTech = "I"
                End If

                If DroneType = "Ore" Then
                    RigBonus = AttribLookup.GetAttribute(RigName & RigTech, ItemAttributes.miningAmountBonus) / 100
                Else ' Ice
                    RigBonus = AttribLookup.GetAttribute(RigName & RigTech, ItemAttributes.rofBonus) / 100
                End If
            End If
        End If

        Return RigBonus

    End Function

    ' Updates the max drones for the ship selected
    Private Sub UpdateNumberMiningDrones(DroneName As String, ShipName As String, NumDronesCombo As ComboBox, Booster As Boolean)

        If DroneName <> None Then
            Dim AttribLookup As New EVEAttributes
            ' Get the m3 of the drone bay and bandwidth for drone and ship
            Dim ShipDroneBandwith As Double = AttribLookup.GetAttribute(ShipName, ItemAttributes.droneBandwidth)
            Dim DroneBandwith As Double = AttribLookup.GetAttribute(DroneName, ItemAttributes.droneBandwidthUsed)

            ' Now calculate the max drones you can mine with based on bandwidth
            Dim MaxDrones = ShipDroneBandwith / DroneBandwith

            If MaxDrones > 5 Then
                MaxDrones = 5
            End If

            ' Reset the combo
            NumDronesCombo.BeginUpdate()
            NumDronesCombo.Items.Clear()

            For i = 0 To MaxDrones
                NumDronesCombo.Items.Add(CStr(i))
            Next

            ' Select the default if it's in the list, else 0
            Select Case cmbMineOreType.Text
                Case "Ore"
                    If NumDronesCombo.Items.Contains(UserMiningTabSettings.BoosterNumMiningDrones) And Booster Then
                        NumDronesCombo.Text = UserMiningTabSettings.BoosterNumMiningDrones
                    ElseIf NumDronesCombo.Items.Contains(UserMiningTabSettings.NumMiningDrones) Then
                        NumDronesCombo.Text = UserMiningTabSettings.NumMiningDrones
                    Else
                        NumDronesCombo.Text = "0"
                    End If
                Case "Ice"
                    If NumDronesCombo.Items.Contains(UserMiningTabSettings.BoosterNumIceMiningDrones) And Booster Then
                        NumDronesCombo.Text = UserMiningTabSettings.BoosterNumIceMiningDrones
                    ElseIf NumDronesCombo.Items.Contains(UserMiningTabSettings.NumIceMiningDrones) Then
                        NumDronesCombo.Text = UserMiningTabSettings.NumIceMiningDrones
                    Else
                        NumDronesCombo.Text = "0"
                    End If
                Case "Gas"
                    NumDronesCombo.Text = "0"
            End Select

            NumDronesCombo.EndUpdate()
        Else
            NumDronesCombo.Text = "0"
        End If

    End Sub

    ' Updates the mining skills for the ships and equipment
    Private Sub UpdateMiningSkills()
        ' Mining upgrades - need mining upgrades 1 or 4 for T2
        ' * mercoxit - T2's Deep core Mining 2
        ' Deep Core Strip Mining skill - Astrogeology 5 and Mining 5
        ' Ice miners - Need to change the mining combo name to Ice Harvesting
        ' * Need level 4 for T1 and level 5 for T2
        ' If they choose 'Other' for ship, hide strip miners and then show 'Miners' and number
        ' If they choose frigs or cruisers, show skill level of ship along with miners

        ' Mining Skill
        ' 3 for mining upgrades
        ' 4 for Astrology and ice harvesting
        ' 5 for Deep core mining

        If cmbMineSkill.Text = "" Then
            cmbMineSkill.Text = "1"
        End If

        ' Mining upgrades (ice and ore)
        If CInt(cmbMineSkill.Text) >= 3 And cmbMineOreType.Text <> "Gas" And cmbMineShipName.Text <> Orca And cmbMineShipName.Text <> Rorqual And cmbMineShipName.Text <> Porpoise Then
            cmbMineMiningUpgrade.Enabled = True
        Else
            cmbMineMiningUpgrade.Enabled = False
        End If

        ' Ice/Gas Harvesting skill
        If CInt(cmbMineSkill.Text) >= 4 Then
            If cmbMineOreType.Text = "Ice" Then
                lblMineGasIceHarvesting.Text = "Ice Harv:"
                lblMineGasIceHarvesting.Enabled = True
                cmbMineGasIceHarvesting.Enabled = True
                cmbMineAstrogeology.Enabled = True
            ElseIf cmbMineOreType.Text = "Gas" Then
                lblMineGasIceHarvesting.Text = "Gas Harv:"
                lblMineGasIceHarvesting.Enabled = True
                cmbMineGasIceHarvesting.Enabled = True
                cmbMineAstrogeology.Enabled = True
            ElseIf cmbMineOreType.Text = "Ore" Then
                lblMineGasIceHarvesting.Enabled = False
                cmbMineGasIceHarvesting.Enabled = False
                cmbMineAstrogeology.Enabled = True
            End If
        Else
            cmbMineAstrogeology.Enabled = False
            lblMineGasIceHarvesting.Enabled = False
            cmbMineGasIceHarvesting.Enabled = False
        End If

        If cmbMineAstrogeology.Text = "" Then
            cmbMineAstrogeology.Text = "1"
        End If

        If cmbMineDroneOpSkill.Text = "" Then
            cmbMineDroneOpSkill.Text = "1"
        End If

        ' Drone specialization skill needs drone op 5
        If CInt(cmbMineDroneOpSkill.Text) = 5 Then
            cmbMineDroneSpecSkill.Enabled = True
        Else
            cmbMineDroneSpecSkill.Enabled = False
        End If

        ' Deep core only for asteroid mining
        If CInt(cmbMineSkill.Text) = 5 And CInt(cmbMineAstrogeology.Text) = 5 And cmbMineOreType.Text = "Ore" Then
            cmbMineDeepCore.Enabled = True
            lblMineDeepCore.Enabled = True
        Else
            cmbMineDeepCore.Enabled = False
            lblMineDeepCore.Enabled = False
        End If

        If cmbMineBaseShipSkill.Text = "" Then
            cmbMineBaseShipSkill.Text = "1"
        End If

        ' Set exhumer skill combo for ice, but the prospect can mine ore so enable it for all
        If cmbMineOreType.Text = "Ice" Then
            If CInt(cmbMineAstrogeology.Text) = 5 And cmbMineAstrogeology.Enabled = True And CInt(cmbMineBaseShipSkill.Text) = 5 Then
                cmbMineAdvShipSkill.Enabled = True
                lblMineExhumers.Enabled = True
            Else
                cmbMineAdvShipSkill.Enabled = False
                lblMineExhumers.Enabled = False
            End If
        Else
            cmbMineAdvShipSkill.Enabled = True
            lblMineExhumers.Enabled = True
        End If

        ' Set true, can be set false when they choose "other"
        cmbMineBaseShipSkill.Enabled = True
        lblMineBaseShipSkill.Enabled = True

        ' Set the skill level of the ship they selected if not a mining barge/exhumer
        Select Case cmbMineShipName.Text
            Case "Other"
                cmbMineBaseShipSkill.Enabled = False
                lblMineBaseShipSkill.Enabled = False
                cmbMineAdvShipSkill.Enabled = False
                lblMineExhumers.Enabled = False
            Case Rorqual
                If CInt(cmbMineBaseShipSkill.Text) >= 3 Then
                    cmbMineAdvShipSkill.Enabled = True
                    lblMineExhumers.Enabled = True
                Else
                    cmbMineAdvShipSkill.Enabled = False
                    lblMineExhumers.Enabled = False
                End If
        End Select

    End Sub

    ' Updates the ships combo with ships based on the levels of skills set
    Private Sub UpdateMiningShipsCombo()
        Dim PreviousShip As String = cmbMineShipName.Text
        Dim MaxShipName As String = ""
        Dim ShipSkillLevel As Integer = 0

        UpdatingMiningShips = True
        cmbMineShipName.Items.Clear()

        If cmbMineBaseShipSkill.Text = "" Then
            cmbMineBaseShipSkill.Text = "1"
        End If

        If cmbMineAdvShipSkill.Text = "" Then
            cmbMineAdvShipSkill.Text = "1"
        End If

        ' For all mining, load the frigates based on skills

        ' Check for Mining Frigate skill to load the Venture
        If CInt(cmbMineBaseShipSkill.Text) >= 1 Then
            cmbMineShipName.Items.Add(Venture)
            MaxShipName = Venture
        End If

        ' Use exhumers skill for expedition frigate
        If CInt(cmbMineBaseShipSkill.Text) = 5 And CInt(cmbMineAdvShipSkill.Text) >= 1 Then
            ' Add the prospect and endurance
            cmbMineShipName.Items.Add(Endurance)
            cmbMineShipName.Items.Add(Prospect)
            MaxShipName = Endurance
        End If

        If cmbMineOreType.Text <> "Ice" Then
            ' Always add other for non ICE mining
            cmbMineShipName.Items.Add("Other")
        End If

        ' Exhumers and Mining Barges - Load for Ice, Ore, and Gas
        ' 3 for Mining barge, Procurer, 4 for Retriever, 5 for Covetor
        ' 5 for Exhumers and Deep core mining
        'Covetor, Retriever, Procurer. Hulk, Skiff, Mackinaw
        If CInt(cmbMineAstrogeology.Text) >= 3 And cmbMineAstrogeology.Enabled = True And CInt(cmbMineBaseShipSkill.Text) >= 1 Then
            cmbMineShipName.Items.Add(Procurer)
            MaxShipName = Procurer
            cmbMineShipName.Items.Add(Retriever)
            MaxShipName = Retriever
            cmbMineShipName.Items.Add(Covetor)
            MaxShipName = Covetor
        End If

        If CInt(cmbMineAstrogeology.Text) = 5 And cmbMineAstrogeology.Enabled = True And CInt(cmbMineBaseShipSkill.Text) = 5 And CInt(cmbMineAdvShipSkill.Text) >= 1 And cmbMineAdvShipSkill.Enabled Then
            cmbMineShipName.Items.Add(Skiff)
            MaxShipName = Skiff
            cmbMineShipName.Items.Add(Mackinaw)
            MaxShipName = Mackinaw
            cmbMineShipName.Items.Add(Hulk)
            MaxShipName = Hulk
        End If

        ' Add all three cap mining vessels - have ore and ice bonuses 
        If cmbMineOreType.Text <> "Gas" Then
            If CInt(cmbMineBaseShipSkill.Text) >= 1 Then
                cmbMineShipName.Items.Add(Porpoise)
                MaxShipName = Porpoise
                cmbMineShipName.Items.Add(Orca)
                MaxShipName = Orca
                ' Need industrial command ships 3 and capital industrial ships 1 to use rorq
                If CInt(cmbMineBaseShipSkill.Text) >= 3 And CInt(cmbMineAdvShipSkill.Text) >= 1 And cmbMineAdvShipSkill.Enabled Then
                    cmbMineShipName.Items.Add(Rorqual)
                    MaxShipName = Rorqual
                End If
            End If
        End If

        If MaxShipName = "" And cmbMineOreType.Text <> "Ice" Then
            MaxShipName = "Other"
        ElseIf MaxShipName = "" And cmbMineOreType.Text = "Ice" Then
            MaxShipName = None
            ' Always add None for this case
            cmbMineShipName.Items.Add(None)
        End If

        ' Use settings to load the ships, else load the maxshipname unless first load
        If cmbMineOreType.Text = "Ore" And UserMiningTabSettings.OreMiningShip <> "" Then
            cmbMineShipName.Text = UserMiningTabSettings.OreMiningShip
        ElseIf cmbMineOreType.Text = "Ice" And UserMiningTabSettings.IceMiningShip <> "" Then
            cmbMineShipName.Text = UserMiningTabSettings.IceMiningShip
        ElseIf cmbMineOreType.Text = "Gas" And UserMiningTabSettings.GasMiningShip <> "" Then
            cmbMineShipName.Text = UserMiningTabSettings.GasMiningShip
        Else
            If cmbMineShipName.Items.Contains(PreviousShip) Then
                cmbMineShipName.Text = PreviousShip
            Else
                cmbMineShipName.Text = MaxShipName
            End If
        End If

        ' If we have a max ship name, then set it if it didn't stick in the combo after checking settings
        If MaxShipName <> "" And cmbMineShipName.Text = "" Then
            cmbMineShipName.Text = MaxShipName
        End If

        UpdatingMiningShips = False
        Call LoadMiningshipImage()

    End Sub

    ' Updates the enable settings on the booster rig checks
    Private Sub UpdateBoosterDroneRigChecks()
        If cmbMineOreType.Text = "Gas" Or chkMineUseFleetBooster.Checked = False Then
            ' No rigs for gas mining
            chkMineBoosterUseDrones.Enabled = False
            chkMineBoosterDroneRig1.Enabled = False
            chkMineBoosterDroneRig2.Enabled = False
            chkMineBoosterDroneRig3.Enabled = False
            tabBoosterDrones.Enabled = False
        Else
            ' Enable checks
            chkMineBoosterUseDrones.Enabled = True
            If chkMineBoosterUseDrones.Checked Then
                chkMineBoosterDroneRig1.Enabled = True
                chkMineBoosterDroneRig2.Enabled = True
                chkMineBoosterDroneRig3.Enabled = True
                tabBoosterDrones.Enabled = True
            Else
                chkMineBoosterDroneRig1.Enabled = False
                chkMineBoosterDroneRig2.Enabled = False
                chkMineBoosterDroneRig3.Enabled = False
                tabBoosterDrones.Enabled = False
            End If
        End If
    End Sub

    ' Loads the laser/strip combos, implant, etc for the ship types
    Private Sub UpdateMiningShipEquipment()
        Dim LaserCount As Integer = 0
        Dim MLUCount As Integer = 0
        Dim i As Integer
        Dim MaxStrip As String = ""
        Dim T1Module As String = ""
        Dim ShipName As String
        Dim DeepCoreLoaded As Boolean = False
        Dim AttribLookup As New EVEAttributes

        Dim SQL As String
        Dim rsMiners As SQLiteDataReader

        Dim BargeSelected As Boolean = False

        ' Load up the main mining laser query - set groupID for search in processing
        SQL = "SELECT typeName, CASE WHEN metaGroupID IS NULL THEN 1 ELSE metaGroupID END AS TECH "
        SQL &= "FROM INVENTORY_TYPES WHERE published <> 0 "

        ' Clear miners
        cmbMineMiningLaser.Items.Clear()

        ShipName = cmbMineShipName.Text

        ' Set the first mining combo to only have base rigs
        cmbMineMiningRig1.Items.Remove("Ice Harvesting")
        cmbMineMiningRig1.Items.Remove("Mercoxit Opt")

        Select Case ShipName
            Case Hulk, Mackinaw, Skiff, Covetor, Retriever, Procurer
                BargeSelected = True
                Call SetEquipmentObjects(True)
                ' Get the numbers
                LaserCount = CInt(AttribLookup.GetAttribute(ShipName, ItemAttributes.hiSlots))
                MLUCount = CInt(AttribLookup.GetAttribute(ShipName, ItemAttributes.lowSlots))

                Select Case ShipName
                    Case Hulk, Mackinaw, Skiff
                        cmbMineMiningRig3.Enabled = False ' Exhumers only have 2 rig slots
                    Case Else
                        cmbMineMiningRig3.Enabled = True
                End Select

                ' Now load the strips
                If cmbMineOreType.Text = "Ore" Then
                    ' Mining Skill
                    ' Mining 4 for T1 Strips
                    ' Mining 5 for T2 Strips
                    SQL &= "AND INVENTORY_TYPES.groupID IN (464, 483) AND typeName NOT LIKE '%Ice%' "
                    If CInt(cmbMineSkill.Text) < 5 Then
                        SQL &= "AND TECH <> 2 AND typeName NOT LIKE '%Deep Core%' " ' Don't load the deep core or tech 2
                        chkMineT1Crystals.Enabled = False
                        chkMineT2Crystals.Enabled = False
                    ElseIf CInt(cmbMineSkill.Text) = 5 And cmbMineDeepCore.Enabled = False Then
                        SQL &= " AND typeName NOT LIKE '%Deep Core%' " ' Don't load the deep core
                        chkMineT1Crystals.Enabled = True
                        chkMineT2Crystals.Enabled = True
                    ElseIf CInt(cmbMineDeepCore.Text) >= 2 And cmbMineDeepCore.Enabled = True Then
                        ' Load them all
                        chkMineT1Crystals.Enabled = True
                        chkMineT2Crystals.Enabled = True
                    End If
                    SQL &= "ORDER BY typeName"

                    DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
                    rsMiners = DBCommand.ExecuteReader

                    While rsMiners.Read
                        cmbMineMiningLaser.Items.Add(rsMiners.GetString(0))
                        If rsMiners.GetInt32(1) = 1 Then
                            T1Module = rsMiners.GetString(0)
                        End If
                    End While

                    If cmbMineMiningLaser.Items.Contains(UserMiningTabSettings.OreStrip) Then
                        MaxStrip = UserMiningTabSettings.OreStrip
                    Else
                        MaxStrip = T1Module
                    End If

                    ' Update the first mining rig to include mercoxit
                    cmbMineMiningRig1.Items.Add("Mercoxit Opt")

                    rsMiners.Close()

                ElseIf cmbMineOreType.Text = "Ice" Then
                    ' Ice harvesting skill
                    ' 1 for T1 strip
                    ' 5 for T2 strips
                    SQL &= "AND INVENTORY_TYPES.groupID IN (464, 483) AND typeName LIKE '%Ice%' "
                    If CInt(cmbMineGasIceHarvesting.Text) < 5 Then
                        SQL &= "AND TECH <> 2 " ' Don't load tech 2
                    End If
                    SQL &= "ORDER BY typeName"

                    DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
                    rsMiners = DBCommand.ExecuteReader

                    While rsMiners.Read
                        cmbMineMiningLaser.Items.Add(rsMiners.GetString(0))
                        If rsMiners.GetInt32(1) = 1 Then
                            T1Module = rsMiners.GetString(0)
                        End If
                    End While

                    chkMineT1Crystals.Enabled = False
                    chkMineT2Crystals.Enabled = False

                    If cmbMineMiningLaser.Items.Contains(UserMiningTabSettings.OreStrip) Then
                        MaxStrip = UserMiningTabSettings.OreStrip
                    Else
                        MaxStrip = T1Module
                    End If

                    ' Update the first mining rig to include ice harvesting
                    cmbMineMiningRig1.Items.Add("Ice Harvesting")

                    rsMiners.Close()

                ElseIf cmbMineOreType.Text = "Gas" Then
                    ' Only venture and other ships
                    SQL &= "AND INVENTORY_TYPES.groupID = 4138 " ' Gas harvesters - Scoops require turret hardpoints
                    If CInt(cmbMineGasIceHarvesting.Text) < 5 Then
                        SQL &= "AND TECH <> 2 " ' Don't load the tech 2
                    End If
                    SQL &= "ORDER BY typeName"

                    DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
                    rsMiners = DBCommand.ExecuteReader

                    While rsMiners.Read
                        cmbMineMiningLaser.Items.Add(rsMiners.GetString(0))
                        If rsMiners.GetInt32(1) = 1 Then
                            T1Module = rsMiners.GetString(0)
                        End If
                    End While

                    If cmbMineMiningLaser.Items.Contains(UserMiningTabSettings.OreStrip) Then
                        MaxStrip = UserMiningTabSettings.OreStrip
                    Else
                        MaxStrip = T1Module
                    End If

                    rsMiners.Close()
                End If

                ' Turn on the num lasers
                lblMineLaserNumber.Enabled = True
                cmbMineNumLasers.Enabled = True

            Case Porpoise, Orca, Rorqual
                ' Just disable the equipment grid except the drone rigs
                Call SetEquipmentObjects(False)

                cmbMineMiningRig1.Enabled = True
                cmbMineMiningRig2.Enabled = True
                cmbMineMiningRig3.Enabled = True ' All three have 3 rig slots

            Case Else ' Other ships that are not mining barges
                Call SetEquipmentObjects(True)
                LaserCount = CInt(AttribLookup.GetAttribute(ShipName, ItemAttributes.turretSlotsLeft)) ' Use turret hardpoints for this
                MLUCount = CInt(AttribLookup.GetAttribute(ShipName, ItemAttributes.lowSlots))

                Select Case ShipName
                    Case Prospect, Endurance ' T2 ships
                        cmbMineMiningRig3.Enabled = False
                    Case Else
                        cmbMineMiningRig3.Enabled = True
                End Select

                ' For Other Ships
                lblMineLaserNumber.Visible = True
                cmbMineNumLasers.Visible = True

                If cmbMineOreType.Text = "Ore" Then
                    chkMineT1Crystals.Enabled = False
                    chkMineT2Crystals.Enabled = False

                    ' Add all the basic mining lasers
                    SQL &= "AND (INVENTORY_TYPES.groupID = 54 OR (INVENTORY_TYPES.groupID = 483 AND typeName NOT LIKE '%Strip%')) AND typeName NOT LIKE '%Ice%' "

                    If CInt(cmbMineSkill.Text) < 4 Then
                        SQL &= "AND TECH <> 2 AND typeName NOT LIKE '%Deep Core%' " ' Don't load T2 or any others
                    ElseIf CInt(cmbMineSkill.Text) < 5 Then
                        SQL &= "AND typeName NOT LIKE '%Deep Core%' " ' No deep core if not 5
                    ElseIf cmbMineDeepCore.Enabled = False Or CInt(cmbMineDeepCore.Text) = 0 Then
                        SQL &= " AND typeName NOT LIKE '%Deep Core%'" ' Don't load the deep core if not enabled
                    ElseIf CInt(cmbMineDeepCore.Text) >= 1 And CInt(cmbMineDeepCore.Text) <= 2 And cmbMineDeepCore.Enabled = True Then
                        SQL &= " AND typeName NOT LIKE '%Modulated Deep Core%'" ' Don't load the modulated deep core
                    ElseIf CInt(cmbMineDeepCore.Text) >= 2 And cmbMineDeepCore.Enabled = True Then
                        ' Deep core is fine
                        chkMineT1Crystals.Enabled = True
                        chkMineT2Crystals.Enabled = True
                    End If
                    SQL &= "ORDER BY typeName"

                    DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
                    rsMiners = DBCommand.ExecuteReader

                    While rsMiners.Read
                        cmbMineMiningLaser.Items.Add(rsMiners.GetString(0))
                        If rsMiners.GetInt32(1) = 1 Then
                            T1Module = rsMiners.GetString(0)
                        End If
                    End While

                    If cmbMineMiningLaser.Items.Contains(UserMiningTabSettings.OreStrip) Then
                        MaxStrip = UserMiningTabSettings.OreStrip
                    Else
                        MaxStrip = T1Module
                    End If

                    rsMiners.Close()

                ElseIf cmbMineOreType.Text = "Gas" Then
                    ' Only venture and other ships
                    SQL &= "AND INVENTORY_TYPES.groupID = 737 " ' Gas Cloud Scoops
                    If CInt(cmbMineGasIceHarvesting.Text) < 5 Then
                        SQL &= "AND TECH <> 2 " ' Don't load the tech 2
                    End If
                    SQL &= "ORDER BY typeName"

                    DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
                    rsMiners = DBCommand.ExecuteReader

                    While rsMiners.Read
                        cmbMineMiningLaser.Items.Add(rsMiners.GetString(0))
                        If rsMiners.GetInt32(1) = 1 Then
                            T1Module = rsMiners.GetString(0)
                        End If
                    End While

                    If cmbMineMiningLaser.Items.Contains(UserMiningTabSettings.OreStrip) Then
                        MaxStrip = UserMiningTabSettings.OreStrip
                    Else
                        MaxStrip = T1Module
                    End If

                    rsMiners.Close()

                ElseIf cmbMineOreType.Text = "Ice" And (ShipName = Endurance Or ShipName = Prospect Or ShipName = Venture) Then
                    SQL &= "AND INVENTORY_TYPES.groupID = 54 AND typeName LIKE '%Ice%' "
                    If CInt(cmbMineGasIceHarvesting.Text) < 5 Then
                        SQL &= "AND TECH <> 2 " ' Don't load tech 2
                    End If
                    SQL &= "ORDER BY typeName"

                    DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
                    rsMiners = DBCommand.ExecuteReader

                    While rsMiners.Read
                        cmbMineMiningLaser.Items.Add(rsMiners.GetString(0))
                        If rsMiners.GetInt32(1) = 1 Then
                            T1Module = rsMiners.GetString(0)
                        End If
                    End While

                    If cmbMineMiningLaser.Items.Contains(UserMiningTabSettings.OreStrip) Then
                        MaxStrip = UserMiningTabSettings.OreStrip
                    Else
                        MaxStrip = T1Module
                    End If

                    rsMiners.Close()

                End If

        End Select

        ' Set crystals
        chkMineT2Crystals.Checked = UserMiningTabSettings.T2Crystals

        ' Set Strip name
        cmbMineMiningLaser.Text = MaxStrip

        ' Set the MLU numbers
        cmbMineNumMiningUpgrades.Items.Clear()
        cmbMineNumMiningUpgrades.Enabled = True

        ' Allow 8 for MLU's if other ship (Rohk, Iteron, etc)
        If ShipName = "Other" And cmbMineOreType.Text <> "Gas" And cmbMineOreType.Text <> "Ice" Then
            MLUCount = 8
            LaserCount = 8
        ElseIf cmbMineOreType.Text = "Gas" And Not BargeSelected Then
            MLUCount = 0
            ' Update laser count based on skills - max of 5 but no more than turrets 
            If cmbMineShipName.Text = Venture Or cmbMineShipName.Text = Prospect Or cmbMineShipName.Text = Endurance Then
                ' Update the laser count if it's less than the turrets on the venture/prospect
                If CInt(cmbMineGasIceHarvesting.Text) < LaserCount Then
                    LaserCount = CInt(cmbMineGasIceHarvesting.Text)
                End If
            Else ' Other Ship
                ' Update the turrets based on the skill, max of 5
                LaserCount = CInt(cmbMineGasIceHarvesting.Text)
            End If
        End If

        For i = 1 To MLUCount
            cmbMineNumMiningUpgrades.Items.Add(CStr(i))
        Next

        ' Load the available upgrades
        Call LoadMiningUpgrades()

        ' Set the number of Strip miners available
        cmbMineNumLasers.Items.Clear()

        ' Set the max allowable lasers
        For i = 1 To LaserCount
            cmbMineNumLasers.Items.Add(CStr(i))
        Next

        ' Choose options for None ships first, these should be just clear settings
        cmbMineNumMiningUpgrades.Text = "0"
        cmbMineMiningUpgrade.Text = None
        cmbMineNumLasers.Text = "0"
        cmbMineMiningLaser.Text = None

        RemoveHandler cmbMineMiningRig1.SelectedIndexChanged, AddressOf ShipMiningDroneRigs_SelectedIndexChanged
        RemoveHandler cmbMineMiningRig2.SelectedIndexChanged, AddressOf ShipMiningDroneRigs_SelectedIndexChanged
        RemoveHandler cmbMineMiningRig3.SelectedIndexChanged, AddressOf ShipMiningDroneRigs_SelectedIndexChanged

        ' Normal ship or "other"
        ' Load settings, only change to user settings if the ship is the same as the one selected

        ' Set the names and numbers for upgrades and strips
        If cmbMineOreType.Text = "Ore" Then
            ' Set the number of MLUs
            If UserMiningTabSettings.NumOreUpgrades = 0 Or MLUCount < UserMiningTabSettings.NumOreUpgrades Or ShipName <> UserMiningTabSettings.OreMiningShip Then
                cmbMineNumMiningUpgrades.Text = CStr(MLUCount)
            Else
                cmbMineNumMiningUpgrades.Text = CStr(UserMiningTabSettings.NumOreUpgrades)
            End If

            ' Set the MLU Text - These are hardcoded so just use the default or user setting
            cmbMineMiningUpgrade.Text = UserMiningTabSettings.OreUpgrade

            ' Set number of strips
            If UserMiningTabSettings.NumOreMiners = 0 Or LaserCount < UserMiningTabSettings.NumOreMiners Or ShipName <> UserMiningTabSettings.OreMiningShip Then
                cmbMineNumLasers.Text = CStr(LaserCount)
            Else
                cmbMineNumLasers.Text = CStr(UserMiningTabSettings.NumOreMiners)
            End If

            ' Set Strip name
            If UserMiningTabSettings.OreStrip = "" Then
                cmbMineMiningLaser.Text = MaxStrip
            Else
                cmbMineMiningLaser.Text = UserMiningTabSettings.OreStrip
            End If

            cmbMineMiningRig1.Text = UserMiningTabSettings.ShipDroneRig1
            cmbMineMiningRig2.Text = UserMiningTabSettings.ShipDroneRig2
            cmbMineMiningRig3.Text = UserMiningTabSettings.ShipDroneRig3

        ElseIf cmbMineOreType.Text = "Ice" Then
            ' Set the number of MLUs
            If UserMiningTabSettings.NumIceUpgrades = 0 Or MLUCount < UserMiningTabSettings.NumIceUpgrades Or ShipName <> UserMiningTabSettings.IceMiningShip Then
                cmbMineNumMiningUpgrades.Text = CStr(MLUCount)
            Else
                cmbMineNumMiningUpgrades.Text = CStr(UserMiningTabSettings.NumIceUpgrades)
            End If

            ' Set the MLU Text - These are hardcoded so just use the default or user setting
            cmbMineMiningUpgrade.Text = UserMiningTabSettings.IceUpgrade

            ' Set number of strips
            If UserMiningTabSettings.NumIceMiners = 0 Or LaserCount < UserMiningTabSettings.NumIceMiners Or ShipName <> UserMiningTabSettings.IceMiningShip Then
                cmbMineNumLasers.Text = CStr(LaserCount)
            Else
                ' Update with the user settings they have, up to the max the ship can use
                cmbMineNumLasers.Text = CStr(UserMiningTabSettings.NumIceMiners)
            End If

            ' Set Strip name
            If UserMiningTabSettings.IceStrip = "" Then
                cmbMineMiningLaser.Text = MaxStrip
            Else
                cmbMineMiningLaser.Text = UserMiningTabSettings.IceStrip
            End If

            cmbMineMiningRig1.Text = UserMiningTabSettings.ShipIceDroneRig1
            cmbMineMiningRig2.Text = UserMiningTabSettings.ShipIceDroneRig2
            cmbMineMiningRig3.Text = UserMiningTabSettings.ShipIceDroneRig3

        ElseIf cmbMineOreType.Text = "Gas" Then
            ' No MLUs for gas
            cmbMineNumMiningUpgrades.Enabled = False
            cmbMineMiningUpgrade.Text = UserMiningTabSettings.GasUpgrade

            ' Set number of strips
            If UserMiningTabSettings.NumIceMiners = 0 Or MLUCount < UserMiningTabSettings.NumGasHarvesters Or ShipName <> UserMiningTabSettings.GasMiningShip Then
                cmbMineNumLasers.Text = CStr(LaserCount)
            Else
                cmbMineNumLasers.Text = CStr(UserMiningTabSettings.NumGasHarvesters)
            End If

            ' Set Strip name
            If UserMiningTabSettings.IceStrip = "" Then
                cmbMineMiningLaser.Text = MaxStrip
            Else
                cmbMineMiningLaser.Text = UserMiningTabSettings.GasHarvester
            End If
        End If

        Call RefreshHaulerM3()

        lblMineCycleTime.Text = ""
        lblMineRange.Text = ""

        AddHandler cmbMineMiningRig1.SelectedIndexChanged, AddressOf ShipMiningDroneRigs_SelectedIndexChanged
        AddHandler cmbMineMiningRig2.SelectedIndexChanged, AddressOf ShipMiningDroneRigs_SelectedIndexChanged
        AddHandler cmbMineMiningRig3.SelectedIndexChanged, AddressOf ShipMiningDroneRigs_SelectedIndexChanged

    End Sub

    ' Loads the mining upgrades for the type of ore selected
    Private Sub LoadMiningUpgrades()
        Dim SQL As String
        Dim rsEq As SQLiteDataReader

        cmbMineMiningUpgrade.BeginUpdate()
        cmbMineMiningUpgrade.Items.Clear()
        cmbMineMiningUpgrade.Items.Add(None) ' Always add none

        SQL = "SELECT typeName, value FROM INVENTORY_TYPES, TYPE_ATTRIBUTES WHERE groupID = 546 and published <> 0 and INVENTORY_TYPES.typeID = TYPE_ATTRIBUTES.typeID "

        Select Case cmbMineOreType.Text
            Case "Ore"
                SQL &= "AND attributeID = " & CStr(ItemAttributes.miningAmountBonus)
            Case "Ice"
                SQL &= "AND attributeID = " & CStr(ItemAttributes.iceHarvestCycleBonus)
            Case Else
                GoTo ProcExit
        End Select

        DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
        rsEq = DBCommand.ExecuteReader

        While rsEq.Read
            cmbMineMiningUpgrade.Items.Add(rsEq.GetString(0) & " (" & CStr(rsEq.GetValue(1)) & "%)")
        End While

        rsEq.Close()

ProcExit:
        cmbMineMiningUpgrade.EndUpdate()

    End Sub

    ' Sets the enable for all objects on ship mining equipment
    Public Sub SetEquipmentObjects(SentValue As Boolean)
        gbMineCrystals.Enabled = SentValue
        lblMineMinerTurret.Enabled = SentValue
        cmbMineMiningLaser.Enabled = SentValue
        cmbMineMiningUpgrade.Enabled = SentValue
        lblMineMiningUpgrade.Enabled = SentValue
        cmbMineNumMiningUpgrades.Enabled = SentValue
        lblMineNumMiningUpgrades.Enabled = SentValue
        cmbMineNumLasers.Enabled = SentValue
        lblMineLaserNumber.Enabled = SentValue
        lblMineImplants.Enabled = SentValue
        cmbMineHighwallImplant.Enabled = SentValue
        cmbMineMiningRig1.Enabled = SentValue
        cmbMineMiningRig2.Enabled = SentValue
        cmbMineMiningRig3.Enabled = SentValue
    End Sub

    ' Updates the processing skills (enable, disable) depending on the refining skills selected
    Private Sub UpdateProcessingSkills()

        If FirstLoad Then
            Exit Sub
        End If

        ' Set them all false first
        For i = 1 To MineProcessingCheckBoxes.Count - 1
            MineProcessingCheckBoxes(i).Enabled = False
        Next

        For i = 1 To MineProcessingCombos.Count - 1
            MineProcessingCombos(i).Enabled = False
        Next

        For i = 1 To MineProcessingLabels.Count - 1
            MineProcessingLabels(i).Enabled = False
        Next

        cmbMineRefineryEff.Enabled = False

        If cmbMineOreType.Text = "Ore" Then

            If cmbMineRefining.Text = "4" Or cmbMineRefining.Text = "5" Then
                ' Veld, Scordite, Pyroxeres, and Plag
                Call EnableOreProcessingGroup(1, True)

                ' Reprocessing 4 is needed for this instead of 5
                cmbMineRefineryEff.Enabled = True
            End If

            If cmbMineRefining.Text = "5" Then
                ' Hemo, Hed, Jaspet, Kernite, Omber, Refinery Effy
                Call EnableOreProcessingGroup(2, True)
            End If

            If cmbMineRefineryEff.Text = "4" Or cmbMineRefineryEff.Text = "5" Then
                ' Dark Ochre, Gneiss, Crokite
                Call EnableOreProcessingGroup(3, True)
            End If

            If cmbMineRefineryEff.Text = "5" Then
                ' Ark, Bisot, Spod,
                Call EnableOreProcessingGroup(4, True)
                Call EnableOreProcessingGroup(6, True) ' Mercoxit
                ' Moon mining
                If chkMineMoonMining.Checked Then
                    Call EnableOreProcessingGroup(7, True)
                    Call EnableOreProcessingGroup(8, True)
                    Call EnableOreProcessingGroup(9, True)
                    Call EnableOreProcessingGroup(10, True)
                    Call EnableOreProcessingGroup(11, True)
                End If
                ' Trig mining
                If chkMineTriglavian.Checked Then
                    Call EnableOreProcessingGroup(5, True)
                End If
            End If

        ElseIf cmbMineOreType.Text = "Ice" Then
            ' Enable the one ice processing skill
            If cmbMineRefining.Text = "5" Then
                cmbMineRefineryEff.Enabled = True
            End If

            If cmbMineRefineryEff.Enabled And cmbMineRefineryEff.Text = "5" Then
                Call EnableOreProcessingGroup(12, True)
            End If

        Else ' Gas
            ' We don't refine, so leave them all off
        End If

    End Sub

    ' Changes the ore processing skill group to enabled or disabled
    Private Sub EnableOreProcessingGroup(ByVal Index As Integer, ByVal EnableObject As Boolean)
        If MineProcessingCheckBoxes(Index).Checked And EnableObject Then
            ' Ok to enable
            MineProcessingCombos(Index).Enabled = True
            MineProcessingLabels(Index).Enabled = True
        Else
            ' Don't enable
            MineProcessingCombos(Index).Enabled = False
            MineProcessingLabels(Index).Enabled = False
        End If

        MineProcessingCheckBoxes(Index).Enabled = EnableObject
    End Sub

    ' Updates the skills and boxes associated with the booster
    Private Sub UpdateBoosterSkills()
        Dim CurrentShip As String

        ' Industrial command ships = Orca/Porpoise. Need Mining director 1
        ' Capital industrial = rorq, need nothing

        ' Mining director needs mining foreman 5
        ' Mindlink (implant) needs mining director 5 
        ' Mining Foreman Link 1 needs mining foreman 5
        ' Mining Foreman Link 2 needs mining director 1
        If chkMineUseFleetBooster.Checked Then
            cmbMineBoosterShipName.Enabled = True
            cmbMineMiningForeman.Enabled = True
            lblMineBoosterShipSkill.Enabled = True
            cmbMineBoosterShipSkill.Enabled = True

            If cmbMineMiningForeman.Text = "5" Then
                cmbMineMiningDirector.Enabled = True

                If cmbMineMiningDirector.Text >= "1" Then
                    chkMineForemanMindlink.Enabled = True ' Implant
                    chkMineForemanLaserOpBoost.ThreeState = True ' Allow for t2 mindlink
                    chkMineForemanLaserOpBoost.Enabled = True
                    chkMineForemanLaserRangeBoost.ThreeState = True ' Allow for t2 mindlink
                    chkMineForemanLaserRangeBoost.Enabled = True
                Else
                    chkMineForemanMindlink.Enabled = False
                    chkMineForemanLaserOpBoost.Enabled = True
                    chkMineForemanLaserOpBoost.ThreeState = False ' Only the T1 mindlink
                    chkMineForemanLaserRangeBoost.Enabled = True
                    chkMineForemanLaserRangeBoost.ThreeState = False ' Only the T1 mindlink
                End If
            Else
                chkMineForemanLaserOpBoost.Enabled = False
                chkMineForemanLaserRangeBoost.Enabled = False
                chkMineForemanMindlink.Enabled = False
                cmbMineMiningDirector.Enabled = False
            End If

            Call UpdateMiningBoosterObjects()

            UpdatingMiningShips = True

            CurrentShip = cmbMineBoosterShipName.Text
            cmbMineBoosterShipName.Items.Clear()

            cmbMineBoosterShipName.Items.Add(Rorqual)
            cmbMineBoosterShipName.Items.Add(Orca)
            cmbMineBoosterShipName.Items.Add(Porpoise)
            cmbMineBoosterShipName.Items.Add("Battlecruiser")
            cmbMineBoosterShipName.Items.Add("Other")

            If cmbMineBoosterShipName.Items.Contains(CurrentShip) Then
                cmbMineBoosterShipName.Text = CurrentShip
            Else
                cmbMineBoosterShipName.Text = "Other"
            End If

            UpdatingMiningShips = False

            If cmbMineBoosterShipName.Text = "Other" Then
                ' Disable mining foreman link
                chkMineForemanLaserOpBoost.Enabled = False
                chkMineForemanLaserRangeBoost.Enabled = False
            End If

            If cmbMineBoosterShipName.Text = Orca Or cmbMineBoosterShipName.Text = Rorqual Or cmbMineBoosterShipName.Text = Porpoise Then
                cmbMineBoosterShipSkill.Enabled = True
            Else
                cmbMineBoosterShipSkill.Enabled = False
            End If

            Select Case cmbMineBoosterShipName.Text
                Case Rorqual, Orca, Porpoise
                    chkMineIndyCoreDeployedMode.Enabled = True
                    cmbMineIndustReconfig.Enabled = True
                    lblMineIndustrialReconfig.Enabled = True
                Case Else
                    chkMineIndyCoreDeployedMode.Enabled = False
                    cmbMineIndustReconfig.Enabled = False
                    lblMineIndustrialReconfig.Enabled = False
            End Select

        Else
            cmbMineBoosterShipName.Enabled = False
            cmbMineMiningDirector.Enabled = False
            cmbMineMiningForeman.Enabled = False
            chkMineForemanMindlink.Enabled = False
            chkMineForemanLaserOpBoost.Enabled = False
            chkMineForemanLaserRangeBoost.Enabled = False
            lblMineBoosterShipSkill.Enabled = False
            cmbMineBoosterShipSkill.Enabled = False
            chkMineIndyCoreDeployedMode.Enabled = False
            cmbMineIndustReconfig.Enabled = False
            lblMineIndustrialReconfig.Enabled = False
        End If

        Call UpdateBoosterDroneRigChecks()

    End Sub

    ' Checks all the data entered
    Private Function CheckMiningEntryData() As Boolean

        ' Check the location
        If chkMineIncludeHighSec.Checked = False And chkMineIncludeLowSec.Checked = False And chkMineIncludeNullSec.Checked = False Then
            ' Can't query any ore
            MsgBox("You must select an Ore Location", vbExclamation, Application.ProductName)
            Return False
        End If

        ' Check the Space types
        If chkMineAmarr.Checked = False And chkMineCaldari.Checked = False And chkMineGallente.Checked = False And chkMineMinmatar.Checked = False And chkMineWH.Checked = False And chkMineTriglavian.Checked = False And chkMineMoonMining.Checked = False Then
            ' Can't query any ore
            MsgBox("You must select an Ore Space", vbExclamation, Application.ProductName)
            Return False
        End If

        If chkMineWH.Checked = True And chkMineWH.Enabled = True And (chkMineC1.Checked = False And chkMineC2.Checked = False And chkMineC3.Checked = False And chkMineC4.Checked = False And chkMineC5.Checked = False And chkMineC6.Checked = False) Then
            ' Can't query any ore
            MsgBox("You must select a Wormhole Class", vbExclamation, Application.ProductName)
            Return False
        End If

        ' Check the values in the hauler calculations. They can't be greater than 30 minutes
        If (CInt(txtMineRTMin.Text) * 60) + CInt(txtMineRTSec.Text) > 1800 Then
            ' Can't query any ore
            MsgBox("Please select a smaller Round Trip Time for returning to station", vbExclamation, Application.ProductName)
            txtMineRTMin.Focus()
            Return False
        End If

        ' Number of miners
        If Trim(txtMineNumberMiners.Text) = "" Or Trim(txtMineNumberMiners.Text) = "0" Then
            MsgBox("Invalid number of miners", vbExclamation, Application.ProductName)
            txtMineNumberMiners.Focus()
            Return False
        End If

        If Val(txtMineNumberMiners.Text) > 100 Then
            MsgBox("You can't select more than 100 miners", vbExclamation, Application.ProductName)
            txtMineNumberMiners.Focus()
            Return False
        End If

        If (chkMineT1Crystals.Checked Or chkMineT2Crystals.Checked) And (chkMineTypeA.Checked = False And chkMineTypeB.Checked = False And chkMineTypeC.Checked = False) Then
            MsgBox("You must select a Crystal Type when selecting T1 or T2 crystals", vbExclamation, Application.ProductName)
            txtMineNumberMiners.Focus()
            Return False
        End If

        ' Make sure a refine type is selected for ice and ore
        If (chkMineRefinedOre.Checked = False And chkMineCompressedOre.Checked = False And chkMineUnrefinedOre.Checked = False And cmbMineOreType.Text <> "Gas") _
            Or (chkMineCompressedOre.Checked = False And chkMineUnrefinedOre.Checked = False And cmbMineOreType.Text = "Gas") Then
            ' Can't calculate nothing
            MsgBox("You must select one ore Processing Type to calculate.", vbExclamation, Application.ProductName)
            chkMineRefinedOre.Focus()
            Return False
        End If

        ' Check that there is a mining laser chosen
        If CStr(cmbMineMiningLaser.Text) = "" And MiningShipSelected() Then
            MsgBox("No mining laser selected. Check ship type and skills selected.", vbExclamation, Application.ProductName)
            cmbMineMiningLaser.Focus()
            Return False
        End If

        Return True

    End Function

    ' Loads the cargo m3 for hauler if selected
    Private Sub RefreshHaulerM3()
        ' If the hauler is not checked and they don't have a m3 set, load the M3 of the ship selected
        If chkMineUseHauler.Checked Then
            Dim AttribLookup As New EVEAttributes
            ' Load the ore hold of the ship selected
            Select Case cmbMineShipName.Text
                Case Hulk, Skiff, Covetor, Procurer, Venture, Prospect, Endurance
                    txtMineHaulerM3.Text = FormatNumber(AttribLookup.GetAttribute(cmbMineShipName.Text, ItemAttributes.generalMiningHoldCapacity), 2)
                Case Mackinaw, Retriever
                    txtMineHaulerM3.Text = FormatNumber(AttribLookup.GetAttribute(cmbMineShipName.Text, ItemAttributes.generalMiningHoldCapacity) _
                                                        * (1 + (CInt(cmbMineBaseShipSkill.Text) * (AttribLookup.GetAttribute(cmbMineShipName.Text, ItemAttributes.miningBargeBonusGeneralMiningHoldCapacity) / 100))), 2)
                Case Orca, Rorqual, Porpoise
                    ' Use special ore hold, fleet hanger - like to use cargo too but that's not in attributes?
                    txtMineHaulerM3.Text = FormatNumber(AttribLookup.GetAttribute(cmbMineShipName.Text, ItemAttributes.generalMiningHoldCapacity) + AttribLookup.GetAttribute(cmbMineShipName.Text, ItemAttributes.fleetHangarCapacity), 2)
                Case Else
                    txtMineHaulerM3.Text = "0.00"
            End Select
        End If
    End Sub

    ' Calculates the total mining amount per cycle for the ship set up (not including crystals)
    Private Function CalculateMiningAmount() As Double
        Dim Mining As Double
        Dim Astrogeology As Double
        Dim BaseShipBonus As Double
        Dim AdvancedShipBonus As Double
        Dim MiningUpgrades As Double
        Dim HighwallImplant As Double
        Dim MichiImplant As Double
        Dim RoleBonus As Double
        Dim AttribLookup As New EVEAttributes

        Dim m3YieldperCycle As Double
        Dim MiningLasers As Integer = CInt(cmbMineNumLasers.Text)

        ' Get base yield and multiply by number of lasers
        m3YieldperCycle = AttribLookup.GetAttribute(cmbMineMiningLaser.Text, ItemAttributes.miningAmount) * MiningLasers

        If cmbMineOreType.Text = "Ore" Then

            ' Yield stacks
            If cmbMineSkill.Enabled = True Then
                Mining = CInt(cmbMineSkill.Text)
            Else
                Mining = 0
            End If

            If cmbMineAstrogeology.Enabled = True Then
                Astrogeology = CInt(cmbMineAstrogeology.Text)
            Else
                Astrogeology = 0
            End If

            ' Mining Upgrades - Look up the upgrade bonus from text selected
            If cmbMineMiningUpgrade.Enabled = True And cmbMineMiningUpgrade.Text <> None Then
                ' Replace the percent if it's in the string so we can take the 9 or 10% bonus easier
                Dim S As Integer = InStr(cmbMineMiningUpgrade.Text, "(")
                Dim E As Integer = InStr(cmbMineMiningUpgrade.Text, "%") - 1
                MiningUpgrades = CInt(cmbMineMiningUpgrade.Text.Substring(S, E - S))
            Else
                MiningUpgrades = 0
            End If

            ' Implant bonus
            If cmbMineHighwallImplant.Text <> None Then
                'Inherent Implants 'Highwall' Mining MX-1001
                HighwallImplant = AttribLookup.GetAttribute("Inherent Implants 'Highwall' Mining " & cmbMineHighwallImplant.Text.Substring(11), ItemAttributes.miningAmountBonus)
            Else
                HighwallImplant = 0
            End If

            ' Michii Implant bonus
            If chkMineMichiImplant.Enabled = True And chkMineMichiImplant.Checked = True Then
                MichiImplant = AttribLookup.GetAttribute(chkMineMichiImplant.Text, ItemAttributes.miningAmountBonus)
            Else
                MichiImplant = 0
            End If

            ' Base ship yield bonus
            If cmbMineShipName.Enabled = True Then
                ' Just look both up for any ship and it will find the bonus regardless
                BaseShipBonus = AttribLookup.GetAttribute(cmbMineShipName.Text, ItemAttributes.miningFrigatesBonusOreMiningYield)
                BaseShipBonus += AttribLookup.GetAttribute(cmbMineShipName.Text, ItemAttributes.miningBargeBonusOreMiningYield)
                BaseShipBonus *= CInt(cmbMineBaseShipSkill.Text)
            Else
                BaseShipBonus = 0
            End If

            ' Advanced ship bonus 
            If cmbMineAdvShipSkill.Enabled = True Then
                ' Just look both up for any ship and it will find the bonus regardless
                AdvancedShipBonus = AttribLookup.GetAttribute(cmbMineShipName.Text, ItemAttributes.expeditionFrigateBonusOreMiningYield)
                AdvancedShipBonus += AttribLookup.GetAttribute(cmbMineShipName.Text, ItemAttributes.exhumersBonusOreMiningYield)
                AdvancedShipBonus *= CInt(cmbMineAdvShipSkill.Text)
            Else
                AdvancedShipBonus = 0
            End If

            ' Role bonus
            RoleBonus = (AttribLookup.GetAttribute(cmbMineShipName.Text, ItemAttributes.shipRoleBonusOreMiningYield) / 100 + 1)

            ' Add skills
            m3YieldperCycle *= (1 + (AttribLookup.GetAttribute(MiningSkillTypeID, ItemAttributes.miningAmountBonus) * Mining) / 100)
            m3YieldperCycle *= (1 + (AttribLookup.GetAttribute(AstrogeologySkillTypeID, ItemAttributes.miningAmountBonus) * Astrogeology) / 100)
            m3YieldperCycle *= (1 + (MichiImplant / 100))
            m3YieldperCycle *= (1 + (HighwallImplant / 100))
            m3YieldperCycle *= ((1 + (MiningUpgrades / 100)) ^ CInt(cmbMineNumMiningUpgrades.Text)) ' Diminishing returns
            m3YieldperCycle *= (1 + (BaseShipBonus / 100))
            m3YieldperCycle *= (1 + (AdvancedShipBonus / 100))
            m3YieldperCycle *= RoleBonus

            If chkMineEDENCOM.Checked Then
                m3YieldperCycle *= 1.1
            End If

            Return m3YieldperCycle

        ElseIf cmbMineOreType.Text = "Ice" Then
            ' One block per cycle - no yield bonus currently
            Return (1 * MiningLasers)

        ElseIf cmbMineOreType.Text = "Gas" Then

            ' Look up any bonuses for role yield
            m3YieldperCycle *= (AttribLookup.GetAttribute(cmbMineShipName.Text, ItemAttributes.shipRoleBonusGasHarvestingYield) / 100 + 1)

            Return m3YieldperCycle

        End If

        Return 0

    End Function

    Private Enum BurstBonusType
        Range = 0
        Cycle = 1
    End Enum

    Private Const MiningLaserFieldEnhancementChargeID As Integer = 42829
    Private Const MiningLaserOptimizationChargeId As Integer = 42830
    Private Const MiningDirectorSkillID As Integer = 22552
    Private Const MiningForemanBurst1_ID As Integer = 42528
    Private Const MiningForemanBurst2_ID As Integer = 43551
    Private Const CapitalIndustrialCore1_ID As Integer = 28583
    Private Const CapitalIndustrialCore2_ID As Integer = 42890
    Private Const LargeIndustrialCore1_ID As Integer = 58945
    Private Const LargeIndustrialCore2_ID As Integer = 58950
    Private Const MediumIndustrialCore1_ID As Integer = 62590
    Private Const MediumIndustrialCore2_ID As Integer = 62591

    ' Calculates the total burst bonus from ships and charges
    Private Function CalculateBurstBonus(BurstType As BurstBonusType, BoostCheckRef As CheckBox) As Double
        Dim GangBurstBonus As Double
        Dim MindLinkBonus As Double
        Dim BaseChargeBonus As Double
        Dim AttribLookup As New EVEAttributes
        Dim MiningDirectorBonus As Double = (1 + (CInt(cmbMineMiningDirector.Text) * (AttribLookup.GetAttribute(MiningDirectorSkillID, ItemAttributes.commandStrengthBonus) / 100)))

        ' Get the burst bonus duration for the mindlink
        If chkMineForemanMindlink.Checked = True And chkMineForemanMindlink.Enabled = True Then
            MindLinkBonus = 1 + AttribLookup.GetAttribute(chkMineForemanMindlink.Text, ItemAttributes.mindlinkBonus) / 100
        Else
            MindLinkBonus = 1
        End If

        ' Get the bonus for the type of charge used
        If BurstType = BurstBonusType.Range Then
            BaseChargeBonus = AttribLookup.GetAttribute(MiningLaserFieldEnhancementChargeID, ItemAttributes.warfareBuff1Multiplier) / 100
        Else
            BaseChargeBonus = AttribLookup.GetAttribute(MiningLaserOptimizationChargeId, ItemAttributes.warfareBuff1Multiplier) / 100
        End If

        ' Mining Foreman Link bonus
        If cmbMineMiningDirector.Enabled = True And BoostCheckRef.Enabled Then
            If BoostCheckRef.Checked And BoostCheckRef.CheckState = CheckState.Indeterminate Then
                ' Checked T2 
                GangBurstBonus = BaseChargeBonus * MiningDirectorBonus * MindLinkBonus * AttribLookup.GetAttribute(MiningForemanBurst2_ID, ItemAttributes.warfareBuff1Value)
            ElseIf BoostCheckRef.Checked Then
                ' Checked T1
                GangBurstBonus = BaseChargeBonus * MiningDirectorBonus * MindLinkBonus * AttribLookup.GetAttribute(MiningForemanBurst1_ID, ItemAttributes.warfareBuff1Value)
            Else
                GangBurstBonus = 0
            End If
        Else
            GangBurstBonus = 0
        End If

        ' Add Industrial core bonus
        GangBurstBonus *= (1 + GetIndustrialCorebonus(cmbMineBoosterShipName.Text, CoreBonus.BurstStrength))

        Dim ShipSkillLevel As Integer = 1

        If cmbMineBoosterShipSkill.Text <> "" Then
            ShipSkillLevel = CInt(cmbMineBoosterShipSkill.Text)
        End If

        ' Ship boost to bursts
        Select Case cmbMineBoosterShipName.Text
            Case Porpoise, Orca
                GangBurstBonus *= (1 + (AttribLookup.GetAttribute(cmbMineBoosterShipName.Text, ItemAttributes.shipBonusICS2) / 100) * ShipSkillLevel)
            Case Rorqual
                GangBurstBonus *= (1 + (AttribLookup.GetAttribute(cmbMineBoosterShipName.Text, ItemAttributes.shipBonusORECapital2) / 100) * ShipSkillLevel)
        End Select

        Return GangBurstBonus

    End Function

    ' Calculates the range for the miner selected and boosts applied
    Private Function CalculateMiningRange(BaseRange As Double, OreType As String, BurstBonus As Double) As Double
        Dim CalculatedRange As Double
        Dim Attriblookup As New EVEAttributes
        Dim BaseShipLevel As Integer = CInt(cmbMineBaseShipSkill.Text)

        ' Calc range with bursts
        If chkMineUseFleetBooster.Checked Then
            CalculatedRange = BaseRange * (1 + BurstBonus)
        Else
            CalculatedRange = BaseRange
        End If

        If OreType = "Ore" Then
            CalculatedRange *= (BaseShipLevel * (Attriblookup.GetAttribute(cmbMineShipName.Text, ItemAttributes.miningBargeBonusOreMiningRange)) / 100 + 1)
        ElseIf OreType = "Ice" Then
            CalculatedRange *= (BaseShipLevel * (Attriblookup.GetAttribute(cmbMineShipName.Text, ItemAttributes.miningBargeBonusIceHarvestingRange)) / 100 + 1)
        End If

        Return CalculatedRange

    End Function

    Private Enum CoreBonus
        OreDroneMiningYield = 0
        IceDroneHarvestingSpeed = 1
        BurstStrength = 2
    End Enum

    ' Returns the bonus as a percentage for the industrial core for the type sent - only for orca and rorq
    Private Function GetIndustrialCorebonus(ShipName As String, BonusType As CoreBonus) As Double
        Dim ReturnBonus As Double = 0
        Dim AttribLookup As New EVEAttributes
        Dim CoreID As Integer

        ' Only return the bonus if it's on and we are using a booster
        If chkMineUseFleetBooster.Checked And chkMineIndyCoreDeployedMode.Checked <> False Then
            If ShipName = Rorqual Then
                If chkMineIndyCoreDeployedMode.CheckState = CheckState.Indeterminate Then
                    CoreID = CapitalIndustrialCore2_ID
                Else
                    CoreID = CapitalIndustrialCore1_ID
                End If
            ElseIf ShipName = Orca Then
                If chkMineIndyCoreDeployedMode.CheckState = CheckState.Indeterminate Then
                    CoreID = LargeIndustrialCore2_ID
                Else
                    CoreID = LargeIndustrialCore1_ID
                End If
            ElseIf ShipName = Porpoise Then
                If chkMineIndyCoreDeployedMode.CheckState = CheckState.Indeterminate Then
                    CoreID = MediumIndustrialCore2_ID
                Else
                    CoreID = MediumIndustrialCore1_ID
                End If
            Else
                Return ReturnBonus
            End If

            Select Case BonusType
                Case CoreBonus.BurstStrength
                    ReturnBonus = AttribLookup.GetAttribute(CoreID, ItemAttributes.industrialCoreBonusMiningBurstStrength) / 100
                Case CoreBonus.IceDroneHarvestingSpeed
                    ReturnBonus = AttribLookup.GetAttribute(CoreID, ItemAttributes.industrialCoreBonusDroneIceHarvesting) / 100
                Case CoreBonus.OreDroneMiningYield
                    ReturnBonus = AttribLookup.GetAttribute(CoreID, ItemAttributes.industrialCoreBonusDroneMining) / 100
            End Select
        End If

        Return ReturnBonus

    End Function

    ' Returns the cycle time of the mining laser cycle time sent
    Private Function CalculateMiningCycleTime(ByVal BaseCycleTime As Double, ByVal GangBurstBonus As Double) As Double
        Dim TempCycleTime As Double
        Dim AttribLookup As New EVEAttributes

        Dim BaseShipLevel As Integer = CInt(cmbMineBaseShipSkill.Text)
        Dim AdvShipLevel As Integer = CInt(cmbMineAdvShipSkill.Text)

        ' Get the adjusted time with bursts
        TempCycleTime = BaseCycleTime * (1 + GangBurstBonus)

        Select Case cmbMineOreType.Text
            Case "Ore"
                ' Frigate bonus
                TempCycleTime *= ((AttribLookup.GetAttribute(cmbMineShipName.Text, ItemAttributes.expeditionFrigateBonusMiningLaserDuration) / 100 * AdvShipLevel) + 1)
                ' Exhumer bonus
                TempCycleTime *= ((AttribLookup.GetAttribute(cmbMineShipName.Text, ItemAttributes.exhumersBonusOreMiningDuration) / 100 * AdvShipLevel) + 1)
                ' Role bonus
                TempCycleTime *= (AttribLookup.GetAttribute(cmbMineShipName.Text, ItemAttributes.shipRoleBonusOreMiningDuration) / 100 + 1)

            Case "Ice"
                ' Frigate bonus
                TempCycleTime *= ((AttribLookup.GetAttribute(cmbMineShipName.Text, ItemAttributes.miningFrigateBonusIceHarvestingDuration) / 100 * BaseShipLevel) + 1)
                TempCycleTime *= ((AttribLookup.GetAttribute(cmbMineShipName.Text, ItemAttributes.expeditionFrigateBonusIceHarvestingDuration) / 100 * AdvShipLevel) + 1)
                ' Mining Barge and Exhumer bonuses
                TempCycleTime *= ((AttribLookup.GetAttribute(cmbMineShipName.Text, ItemAttributes.miningBargeBonusIceHarvestingDuration) / 100 * BaseShipLevel) + 1)
                TempCycleTime *= ((AttribLookup.GetAttribute(cmbMineShipName.Text, ItemAttributes.exhumersBonusIceHarvestingDuration) / 100 * AdvShipLevel) + 1)
                ' Role bonus
                TempCycleTime *= (AttribLookup.GetAttribute(cmbMineShipName.Text, ItemAttributes.shipRoleBonusIceHarvestingDuration) / 100 + 1)

                ' For Ice, check for duration reduction bonus, implant, and upgrades
                If cmbMineGasIceHarvesting.Enabled Then
                    ' Apply the ice harvesting bonus
                    TempCycleTime *= (CDec(cmbMineGasIceHarvesting.Text) * AttribLookup.GetAttribute(16281, ItemAttributes.iceHarvestCycleBonus) / 100) + 1
                End If

                ' Apply the upgrades
                If cmbMineMiningUpgrade.Enabled = True And cmbMineMiningUpgrade.Text <> None Then
                    ' Replace the percent if it's in the string so we can take the 9 or 10% bonus easier
                    Dim TempUpgradeText As String = cmbMineMiningUpgrade.Text.Replace("%", "")
                    Dim TextStart As Integer = InStr(TempUpgradeText, "(")
                    Dim TextLength As Integer = InStr(TempUpgradeText, ")") - TextStart - 1
                    TempCycleTime *= ((1 + (CDbl(TempUpgradeText.Substring(TextStart, TextLength)) / 100)) ^ CInt(cmbMineNumMiningUpgrades.Text)) ' Diminishing returns
                End If

                ' Inherent Implants 'Yeti' Ice Harvesting IH-1001
                Select Case cmbMineHighwallImplant.Text
                    Case "'Yeti' IH-1001"
                        TempCycleTime *= (1 + AttribLookup.GetAttribute(27103, ItemAttributes.iceHarvestCycleBonus) / 100)
                    Case "'Yeti' IH-1003"
                        TempCycleTime *= (1 + AttribLookup.GetAttribute(22570, ItemAttributes.iceHarvestCycleBonus) / 100)
                    Case "'Yeti' IH-1005"
                        TempCycleTime *= (1 + AttribLookup.GetAttribute(22571, ItemAttributes.iceHarvestCycleBonus) / 100)
                End Select

                ' Apply the rig bonus if selected
                If cmbMineMiningRig1.Text = "Ice Harvesting" Then
                    ' 12% cycle reduction
                    TempCycleTime = TempCycleTime * ((1 + AttribLookup.GetAttribute(32819, ItemAttributes.iceHarvestCycleBonus) / 100))
                End If

            Case "Gas"
                ' Frigate bonuses
                Select Case cmbMineShipName.Text
                    Case Venture, Prospect, Endurance
                        TempCycleTime *= ((AttribLookup.GetAttribute(cmbMineShipName.Text, ItemAttributes.miningFrigateBonusGasCloudHarvestingDuration) / 100 * AdvShipLevel) + 1)
                        TempCycleTime *= ((AttribLookup.GetAttribute(cmbMineShipName.Text, ItemAttributes.expeditionFrigateBonusGasHarvestingDuration) / 100 * AdvShipLevel) + 1)
                    Case Prospect, Retriever, Covetor
                        TempCycleTime *= ((AttribLookup.GetAttribute(cmbMineShipName.Text, ItemAttributes.miningBargeBonusGasHarvestingDuration) / 100 * BaseShipLevel) + 1)
                    Case Skiff, Mackinaw, Hulk
                        TempCycleTime *= ((AttribLookup.GetAttribute(cmbMineShipName.Text, ItemAttributes.exhumersBonusGasHarvestingDuration) / 100 * AdvShipLevel) + 1)
                End Select

                ' Role bonus
                TempCycleTime *= (AttribLookup.GetAttribute(cmbMineShipName.Text, ItemAttributes.shipRoleBonusGasHarvesterDuration) / 100 + 1)

                ' Gas Harvesting Duration Implants Eifyr and Co. 'Alchemist' Gas Harvesting GH-801
                Select Case cmbMineHighwallImplant.Text
                    Case "'Alchemist' GH-801"
                        TempCycleTime *= (1 + AttribLookup.GetAttribute(27240, ItemAttributes.durationBonus) / 100)
                    Case "'Alchemist' GH-803"
                        TempCycleTime *= (1 + AttribLookup.GetAttribute(27238, ItemAttributes.durationBonus) / 100)
                    Case "'Alchemist' GH-805"
                        TempCycleTime *= (1 + AttribLookup.GetAttribute(27239, ItemAttributes.durationBonus) / 100)
                End Select

        End Select

        Return TempCycleTime

    End Function

    ' Updates the booster checks 
    Public Sub UpdateMiningBoosterObjects()

        ' Laser Op
        If chkMineForemanLaserOpBoost.Checked And chkMineForemanLaserOpBoost.CheckState = CheckState.Indeterminate Then ' Show T2
            chkMineForemanLaserOpBoost.Text = "Mining Foreman Link T2 - Laser Optimization Charge"
            chkMineForemanLaserOpBoost.ForeColor = Color.DarkOrange

            If File.Exists(Path.Combine(UserImagePath, "43551_32.png")) Then
                pictMineLaserOptmize.Image = Image.FromFile(Path.Combine(UserImagePath, "43551_32.png"))
            Else
                pictMineLaserOptmize.Image = Nothing
            End If

            pictMineLaserOptmize.Update()

        Else
            chkMineForemanLaserOpBoost.Text = "Mining Foreman Link - Laser Optimization Charge"
            chkMineForemanLaserOpBoost.ForeColor = Color.Black

            If File.Exists(Path.Combine(UserImagePath, "42528_32.png")) Then
                pictMineLaserOptmize.Image = Image.FromFile(Path.Combine(UserImagePath, "42528_32.png"))
            Else
                pictMineLaserOptmize.Image = Nothing
            End If

            pictMineLaserOptmize.Update()
        End If

        ' Range 
        If chkMineForemanLaserRangeBoost.Checked And chkMineForemanLaserRangeBoost.CheckState = CheckState.Indeterminate Then ' Show T2
            chkMineForemanLaserRangeBoost.Text = "Mining Foreman Link T2 - Mining Laser Field Enhancement Charge"
            chkMineForemanLaserRangeBoost.ForeColor = Color.DarkOrange

            If File.Exists(Path.Combine(UserImagePath, "43551_32.png")) Then
                pictMineRangeLink.Image = Image.FromFile(Path.Combine(UserImagePath, "43551_32.png"))
            Else
                pictMineRangeLink.Image = Nothing
            End If
        Else
            chkMineForemanLaserRangeBoost.Text = "Mining Foreman Link - Mining Laser Field Enhancement Charge"
            chkMineForemanLaserRangeBoost.ForeColor = Color.Black

            If File.Exists(Path.Combine(UserImagePath, "42528_32.png")) Then
                pictMineRangeLink.Image = Image.FromFile(Path.Combine(UserImagePath, "42528_32.png"))
            Else
                pictMineRangeLink.Image = Nothing
            End If

            pictMineRangeLink.Update()
        End If

    End Sub

    ' Processes the industrial core checks
    Private Sub UpdateIndustrialCoreCheck()

        If chkMineIndyCoreDeployedMode.Checked And chkMineIndyCoreDeployedMode.CheckState = CheckState.Indeterminate Then ' Show T2
            chkMineIndyCoreDeployedMode.Text = "Industrial Core II Active"
            chkMineIndyCoreDeployedMode.ForeColor = Color.DarkOrange
        ElseIf chkMineIndyCoreDeployedMode.Checked And chkMineIndyCoreDeployedMode.CheckState = CheckState.Checked Then ' Show T1 
            chkMineIndyCoreDeployedMode.Text = "Industrial Core I Active"
            chkMineIndyCoreDeployedMode.ForeColor = Color.Black
        Else
            ' Inactive
            chkMineIndyCoreDeployedMode.Text = "Industrial Core Inactive"
            chkMineIndyCoreDeployedMode.ForeColor = Color.Black
        End If

        If chkMineIndyCoreDeployedMode.Checked = True Then
            lblMineIndustrialReconfig.Enabled = True
            cmbMineIndustReconfig.Enabled = True
        Else
            lblMineIndustrialReconfig.Enabled = False
            cmbMineIndustReconfig.Enabled = False
        End If

    End Sub

    ' Calculates the cost for one hour of heavy water for boosting with a Rorqual
    Private Function CalculateIndyCoreDeployedCost(IndustrialReconfigSkill As Integer, ShipSkill As Integer) As Double
        Dim SQL As String
        Dim readerHW As SQLiteDataReader
        Dim HWUsage As Double = 0
        Dim AttribLookup As New EVEAttributes
        Dim CoreTypeID As Integer = 0

        ' Look up usage for the module selected by the ship
        If chkMineIndyCoreDeployedMode.Checked And chkMineIndyCoreDeployedMode.CheckState = CheckState.Indeterminate Then
            ' Checked T2
            Select Case cmbMineShipName.Text
                Case Porpoise
                    CoreTypeID = MediumIndustrialCore2_ID
                Case Orca
                    CoreTypeID = LargeIndustrialCore2_ID
                Case Rorqual
                    CoreTypeID = CapitalIndustrialCore2_ID
            End Select
        ElseIf chkMineIndyCoreDeployedMode.Checked Then
            ' Checked T1
            Select Case cmbMineShipName.Text
                Case Porpoise
                    CoreTypeID = MediumIndustrialCore1_ID
                Case Orca
                    CoreTypeID = LargeIndustrialCore1_ID
                Case Rorqual
                    CoreTypeID = CapitalIndustrialCore1_ID
            End Select
        End If

        If chkMineIndyCoreDeployedMode.Enabled = True Then
            HWUsage = CInt(AttribLookup.GetAttribute(CoreTypeID, ItemAttributes.consumptionQuantity))
        Else
            HWUsage = 0
        End If

        ' Users can set Industrial Reconfig to 0 - this is 0 cost or not calculating cost
        If IndustrialReconfigSkill = 0 Then
            Return 0
        End If

        ' Skill at the operation of industrial core modules.  
        ' 50-unit reduction in heavy water consumption amount for module activation per skill level.
        HWUsage = HWUsage - (IndustrialReconfigSkill * 50)

        ' Capital Industrial Ships skill bonuses:
        ' -5% reduction in fuel consumption for industrial cores per level
        HWUsage = HWUsage - (HWUsage * 0.05 * ShipSkill)

        ' Look up the cost for Heavy Water
        SQL = "SELECT PRICE FROM ITEM_PRICES WHERE ITEM_NAME = 'Heavy Water'"
        DBCommand = New SQLiteCommand(SQL, EVEDB.DBREf)
        readerHW = DBCommand.ExecuteReader

        Dim ReturnValue As Double = 0

        If readerHW.Read Then
            ' Return cost for one hour (cycle is 5 minutes)
            ReturnValue = HWUsage * readerHW.GetDouble(0) * 12
        End If
        readerHW.Close()

        Return ReturnValue

    End Function

    Private Function MiningShipSelected() As Boolean
        If cmbMineShipName.Text = Porpoise Or cmbMineShipName.Text = Orca Or cmbMineShipName.Text = Rorqual Then
            Return False
        Else
            Return True
        End If
    End Function

    ' The Ore structure to display in our grid for mining
    Public Structure MiningOre
        Dim OreID As Long
        Dim OreName As String
        Dim OreUnitPrice As Double
        Dim RefineYield As Double
        Dim CrystalType As String
        Dim OreVolume As Double
        Dim IPH As Double
        Dim UnitsPerHour As Double
        Dim OreUnitsPerCycle As Double
        Dim ResidueProbability As Double
        Dim ResidueVolumeMuliplier As Double
        Dim DroneYield As Double
        Dim UnitsToRefine As Integer
        Dim RefineType As String
        Dim Space As String ' Location
        Dim BeltType As String ' What type of ore it is - Moon, Ice, Ore
        Dim CycleTime As Double
    End Structure

    ' For sorting a list of Mining Ore
    Public Class MiningOreIPHComparer

        Implements System.Collections.Generic.IComparer(Of MiningOre)

        Public Function Compare(ByVal p1 As MiningOre, ByVal p2 As MiningOre) As Integer Implements IComparer(Of MiningOre).Compare
            ' swap p2 and p1 to do decending sort
            Return p2.IPH.CompareTo(p1.IPH)
        End Function

    End Class

    Private Sub cmbMineMiningUpgrade_SelectedIndexChanged(sender As Object, e As EventArgs) Handles cmbMineMiningUpgrade.SelectedIndexChanged
        If cmbMineMiningUpgrade.Text = None Then
            cmbMineNumMiningUpgrades.Enabled = False
        Else
            cmbMineNumMiningUpgrades.Enabled = True
        End If
    End Sub

    Private Sub lstMineGrid_SelectedIndexChanged(sender As Object, e As EventArgs) Handles lstMineGrid.SelectedIndexChanged
        If lstMineGrid.SelectedIndices.Count <> 0 Then
            ' Set the cycle time for the line selected
            lblMineCycleTime.Text = lstMineGrid.SelectedItems(0).SubItems(11).Text
        End If
    End Sub

    Private Sub chkMineRefinedOre_CheckedChanged(sender As Object, e As EventArgs) Handles chkMineRefinedOre.CheckedChanged
        If chkMineRefinedOre.Checked And chkMineRefinedOre.Enabled Then
            gbMineRefining.Enabled = True
        Else
            gbMineRefining.Enabled = False
        End If
        Call UpdateProcessingSkills()
    End Sub

#End Region

End Class